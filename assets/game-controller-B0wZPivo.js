import{c as lt,g as j,S as J}from"./sound-manager-BzIeyUss.js";import{g as It,h as ot,A as ce,d as yt,i as se,j as $e,k as qe,e as si,f as ri,m as fe,G as ft,n as Xt}from"./npc-model-DLxPrPEr.js";import{R as jt,E as ai,G as Q,i as pe,C as U,P as Fe,S as q,T as Mt,f as li,j as ci,k as Zt,l as hi}from"./index-VZJzuFTm.js";import{c as F,a as rt}from"./solid-lwVvZ318.js";import{c as Kt,b as wt,a as Ge}from"./modal-view-DbtHnRv3.js";const di=(n,t,e)=>{if(n<=0)return;const i=[...t];i.sort((s,d)=>{const a=s.position().distanceTo(e.position()),c=d.position().distanceTo(e.position());return a-c});const o=Math.min(4,Math.floor(i.length/n));for(let s=0;s<n;s++){const d=It("city-key"),a=Math.floor(Math.random()*100)<=33?0:Math.floor(Math.random()*100)<=66?1:2,c=Math.min(i.length-1,a+Math.floor((s+1)*o)),l=i[c];i.splice(a,1),l.inventory().addItem(d)}},ui=({map:n,rooms:t,pathEnemyChance:e=.2,paths:i})=>{const s=(l,h)=>l>0&&h>0&&l<n.length-1&&h<n[0].length-1,d=(l,h,r,f)=>Math.sqrt((l-r)**2+(h-f)**2),a=(l,h,r)=>r.every(f=>d(f.position().x,f.position().y,l,h)>=10),c=[];return t.forEach((l,h)=>{if(h===0)return;const r=Math.floor(Math.random()*2);for(let f=0;f<r;f++){const[p,u]=l[Math.floor(Math.random()*l.length)];if(s(p,u)&&a(p,u,c)){const g=n[p][u];g.hasEnemy()||(g.hasEnemy=()=>!0,c.push(g))}}}),i.forEach((l,h)=>{h!==0&&l.forEach(([r,f])=>{if(Math.random()<e&&s(r,f)&&a(r,f,c)){const p=n[r][f];p.hasEnemy()||(p.hasEnemy=()=>!0,c.push(p))}})}),c},fi=({map:n,rooms:t,pathEventChance:e=.1,paths:i})=>{const s=[],d=(c,l)=>c>0&&l>0&&c<n.length-1&&l<n[0].length-1,a=(c,l,h,r)=>Math.sqrt((c-h)**2+(l-r)**2);return t.forEach(c=>{const l=c.length/2,h=Math.floor(Math.random()*l)+2;for(let r=0;r<h;r++){const[f,p]=c[Math.floor(Math.random()*c.length)];if(d(f,p)&&s.every(u=>a(u.position().x,u.position().y,f,p)>=3)){const u=n[f][p];!u.hasEvent()&&u.traversable()&&u.type()!=="settlement"&&(u.hasEvent=()=>!0,s.push(u))}}}),i.forEach(c=>{c.forEach(([l,h])=>{if(Math.random()<e&&d(l,h)){const r=n[l][h];!r.hasEvent()&&r.type()!=="settlement"&&r.traversable()&&s.every(f=>a(f.position().x,f.position().y,l,h)>=3)&&(r.hasEvent=()=>!0,s.push(r))}})}),s},me=[ot({id:"ancient-bunker",name:"Ancient Bunker",startPosition:{x:0,y:0},startingItems:[],level:3}),ot({id:"bandit-camp",name:"Bandit Camp",startPosition:{x:0,y:0},startingItems:[],level:4}),ot({id:"beacon",name:"Beacon",startPosition:{x:0,y:0},startingItems:[],level:2}),ot({id:"bear-cage",name:"Bear Cage",startPosition:{x:0,y:0},startingItems:[],level:4}),ot({id:"bunker",name:"Bunker",startPosition:{x:0,y:0},startingItems:[],level:2}),ot({id:"campfire",name:"Campfire",startPosition:{x:0,y:0},startingItems:[],level:2}),ot({id:"cave",name:"Cave",startPosition:{x:0,y:0},startingItems:[],level:3}),ot({id:"chest",name:"Chest",startPosition:{x:0,y:0},startingItems:[],level:1}),ot({id:"church",name:"Church",startPosition:{x:0,y:0},startingItems:[],level:2}),ot({id:"crashed-plane",name:"Crashed Plane",startPosition:{x:0,y:0},startingItems:[],level:3}),ot({id:"fungi",name:"Fungi",startPosition:{x:0,y:0},startingItems:[],level:1}),ot({id:"tent",name:"Tent",startPosition:{x:0,y:0},startingItems:[],level:2}),ot({id:"lean-to",name:"Lean-To",startPosition:{x:0,y:0},startingItems:[],level:2}),ot({id:"ruin",name:"Ruin",startPosition:{x:0,y:0},startingItems:[],level:4}),ot({id:"scary-tree",name:"Scary Tree",startPosition:{x:0,y:0},startingItems:[],level:1}),ot({id:"silo",name:"Silo",startPosition:{x:0,y:0},startingItems:[],level:3}),ot({id:"sword-in-stone",name:"Monument",startPosition:{x:0,y:0},startingItems:[],level:5}),ot({id:"wagon",name:"Wagon",startPosition:{x:0,y:0},startingItems:[],level:1}),ot({id:"wreck",name:"Wreck",startPosition:{x:0,y:0},startingItems:[],level:1})],pi=()=>{const n=Math.floor(Math.random()*me.length);return me[n]},mi=n=>{const t=Math.floor(Math.random()*n)+1,e=[];for(let i=0;i<t;i++){if(Math.random()<.5)continue;const o=gi();e.push(o)}if(e.length===0){const i=It("coin");e.push(i)}return e},gi=()=>{let n=0;const t=[];return ce.map(i=>{const o=new Array(i.randomDropWeight()).fill(i);t.push(...o),n+=i.randomDropWeight()}),It(t[Math.floor(Math.random()*n)].code())},yi=n=>n.map(t=>{const e=pi();return ot({id:e.id(),name:e.name(),startPosition:{x:t.position().x,y:t.position().y},level:e.level(),startingItems:mi(e.level())})}),vi=(n,t)=>{const e=(c,l)=>{const h=[],r=Math.abs(l.position.x-c.position.x),f=Math.abs(l.position.y-c.position.y),p=c.position.x<l.position.x?1:-1,u=c.position.y<l.position.y?1:-1;let g=r-f,y=c.position.x,v=c.position.y;for(;y!==l.position.x||v!==l.position.y;){h.push([y,v]);const M=g*2;M>-f&&(g-=f,y+=p),M<r&&(g+=r,v+=u)}return h},i=(c,l,h,r)=>{const f=c[c.length-1],[p,u]=f;for(const g of r){if(h.has(g.id))continue;if(Math.hypot(g.position.x-p,g.position.y-u)>3){const v=e({position:{x:p,y:u}},g);l.push(v),h.add(g.id);break}}},o=(c,l)=>{let h=null,r=1/0;for(const f of n){if(l.has(f.id))continue;const p=Math.hypot(f.position.x-c.position.x,f.position.y-c.position.y);p<r&&p<t&&(h=f,r=p)}return h},s=[],d=new Set;let a=n[0];for(d.add(a.id);d.size<n.length;){let c=o(a,d);if(!c){const l=Array.from(d).map(h=>n.find(r=>r.id===h));for(;l.length>0;){const h=l.pop();if(c=o(h,d),c){a=h;break}}c||(c=n.find(h=>!d.has(h.id))||null)}if(c){const l=e(a,c);s.push(l),d.add(c.id),a=c,l.length>7&&i(l,s,d,n)}else break}return s},wi=(n,t,e,i={min:2,max:4})=>{const o=n.length,s=n[0].length,d=[],a=(h,r)=>h>=0&&r>=0&&h<o&&r<s,c=(h,r,f)=>f.every(([p,u])=>{const g=h+p,y=r+u;if(!a(g,y))return!1;for(let v=-1;v<=1;v++)for(let M=-1;M<=1;M++){const I=g+v,E=y+M;if(a(I,E)&&n[I][E].type()!=="void")return!1}return!0}),l=h=>{const r=[];switch(Math.floor(Math.random()*4)){case 0:for(let g=-h;g<=h;g++)for(let y=-h;y<=h;y++)g*g+y*y<=h*h&&r.push([g,y]);break;case 1:for(let g=-h;g<=h+2;g++)for(let y=-h;y<=h;y++)(g*g+y*y<=h*h||Math.abs(g)<h&&Math.abs(y)<h)&&r.push([g,y]);break;case 2:for(let g=-h;g<=h;g++)for(let y=-h;y<=h;y++)(g*g+y*y<=h*h&&Math.random()>.5||Math.abs(g)<h&&Math.abs(y)<h&&Math.random()>.5)&&r.push([g,y]);break;case 3:const p=h*2,u=Math.floor(h/2);for(let g=-p;g<=p;g++)for(let y=-u;y<=u;y++)r.push([g,y]);break}return r};return t.forEach(h=>{const r=Math.floor(Math.random()*(i.max-i.min+1)+i.min),f=l(r),p=[];c(h.position.x,h.position.y,f)&&f.forEach(([u,g])=>{const y=h.position.x+u,v=h.position.y+g;a(y,v)&&(n[y][v]=yt({terrain:"wasteland",position:{x:y,y:v}}),p.push([y,v]))}),p.length>0&&d.push(p)}),e.forEach(h=>{h.forEach(([r,f])=>{for(let p=-Math.floor(Math.random()*2);p<=Math.floor(Math.random()*2);p++)for(let u=-Math.floor(Math.random()*2);u<=Math.floor(Math.random()*2);u++){const g=r+p,y=f+u;a(g,y)&&n[g][y].type()!=="wasteland"&&(n[g][y]=yt({terrain:"grass",position:{x:g,y}}))}})}),{map:n,rooms:d}},bi=(n,t)=>Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2)),xi=n=>{const{horizontalTiles:t,verticalCells:e,nodeCount:i,minDistanceBetweenNodes:o,maxAttemptsToAssignNode:s}=n,d=[],a=Math.ceil(Math.sqrt(i)),c=Math.floor(t/a),l=Math.floor(e/a),h=(r,f)=>d.every(p=>Math.abs(bi(p.position,{x:r,y:f}))>=o);for(let r=0;r<i;r++){let f=0,p=!1;for(;f<s&&!p;){const u=Math.floor(r%a)*c,g=Math.floor(r/a)*l;let y=u+Math.floor(Math.random()*c),v=g+Math.floor(Math.random()*l);y=Math.max(3,Math.min(t-3,y)),v=Math.max(3,Math.min(e-3,v)),y<t&&v<e&&h(y,v)?(d.push({id:`node-${r}`,position:{x:y,y:v}}),p=!0):f++}p||d.pop()&&r--}return d},Ci=n=>{const{startPosition:t}=n,e=[...se("torch",30),...se("coin",3)],i=[],o=[...e,...i];return $e({name:"Hero",id:"player",startPosition:t,startingItems:o,team:"player"})},Ye=()=>{const n=xi({horizontalTiles:64,verticalCells:64,nodeCount:80,minDistanceBetweenNodes:7,maxAttemptsToAssignNode:100}),t=vi(n,15),e=I=>{const E=Math.floor(Math.random()*I)+1,_=[];for(let B=0;B<E;B++){if(Math.random()<.5)continue;const S=i(),T=_.find(m=>m.code()===S.code());if(T){T.code()==="coin"&&T.updateQuantity(T.quantity()+1);continue}_.push(S)}if(_.length===0){const B=It("coin");_.push(B)}return _},i=()=>{let I=0;const E=[];return ce.map(_=>{const B=new Array(_.randomDropWeight()).fill(_);E.push(...B),I+=_.randomDropWeight()}),E[Math.floor(Math.random()*I)]},{map:o,rooms:s}=wi(Array.from({length:64},(I,E)=>Array.from({length:64},(_,B)=>yt({terrain:"void",position:{x:E,y:B}}))),n,t,{min:2,max:4});(I=>{const E=I.flat().filter(T=>T.type()==="void"),_=Math.floor(30);let B=0,S=0;for(let T=0;T<_&&(T>0&&E.splice(S,1),!(B>1e4||(B++,E.length===0)));T++){S=Math.floor(Math.random()*E.length);const{x:m,y:x}=E[S].position(),w=new jt(m,x,Math.floor(Math.random()*3)+1,Math.floor(Math.random()*3)+1);let b=!0;for(let k=-w.width;k<=w.width;k++){for(let A=-w.height;A<=w.height;A++){const L=m+k,D=x+A;if(!(L<0||D<0||L>=I.length||D>=I[0].length)&&I[L][D].type()!=="void"){b=!1;break}}if(!b)break}if(b)for(let k=-w.width;k<=w.width;k++)for(let A=-w.height;A<=w.height;A++){const L=m+k,D=x+A;L<0||D<0||L>=I.length||D>=I[0].length||(I[L][D]=yt({terrain:"water",position:{x:L,y:D}}))}}})(o);const c=ui({map:o,rooms:s,paths:t,pathEnemyChance:.2}).map(I=>qe({id:"bandit",name:"Bandit",team:"hostile-to-all",startPosition:{x:I.position().x,y:I.position().y},startingItems:e(Math.floor(Math.random()*3)+1),startingHealth:2})),l=I=>{I[0].map(E=>yt({terrain:"mountain",position:E.position()})),I[I.length-1].map(E=>yt({terrain:"mountain",position:E.position()})),I.forEach(E=>{yt({terrain:"mountain",position:E[0].position()}),yt({terrain:"mountain",position:E[E.length-1].position()})})},h=["settlement","large-settlement","sanctuary","citadel"],r=(I,E)=>{const{x:_,y:B}=I,S=[{x:_,y:B},{x:_+1,y:B},{x:_,y:B+1},{x:_+1,y:B+1}];return S.forEach(T=>{E[T.x]&&E[T.x][T.y]&&(E[T.x][T.y]=yt({terrain:"settlement",position:T}))}),fe({id:h.shift()??"settlement",name:`Settlement at (${_}, ${B})`,level:1,positions:S})};function f(I,E){const _=[];return I.forEach((B,S)=>{const{x:T,y:m}=B.position,x=!0;if(S===0){_.push(r({x:T,y:m},E));return}T<E.length-1&&m<E[0].length-1&&x?_.push(r({x:T,y:m},E)):(E[T][m]=yt({terrain:"settlement",position:{x:T,y:m}}),_.push(fe({id:h.shift()??"settlement",name:`Settlement ${S+1}`,level:1,positions:[{x:T,y:m}]})))}),_}const u=((I,E,_)=>{const B=[],S=new Set,T=m=>{const x=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],w=x[Math.floor(Math.random()*x.length)];return{x:m.position.x+w.x,y:m.position.y+w.y}};for(B.push({id:I[0].id,position:T(I[0])});B.length<E&&B.length<I.length&&S.size<I.length;){const m=Math.floor(Math.random()*I.length),x=I[m],w=`${x.position.x},${x.position.y}`;if(S.has(w))continue;let b=!0;for(const k of B)if(Math.sqrt(Math.pow(x.position.x-k.position.x,2)+Math.pow(x.position.y-k.position.y,2))<_){b=!1;break}b&&(B.push(x),S.add(w))}return B})(n,3,5),g=f(u,o);l(o);const y=fi({map:o,rooms:s,paths:t,pathEventChance:.1}),v=yi(y),M=Ci({startPosition:n[0].position});return di(g.length,c,M),{playerModel:M,tileMapModel:ri(o),npcModels:c,eventModels:v,settlementModels:g,fogOfWarViewModel:si()}};/*!
 * PixiPlugin 3.13.0
 * https://gsap.com
 *
 * @license Copyright 2008-2025, GreenSock. All rights reserved.
 * Subject to the terms at https://gsap.com/standard-license
 * @author: Jack Doyle, jack@greensock.com
*/var Tt,Jt,ge,ut,Ut,Qe,re,ee,Xe=function(){return typeof window<"u"},je=function(){return Tt||Xe()&&(Tt=window.gsap)&&Tt.registerPlugin&&Tt},ae=function(t){return typeof t=="function"},Ze=function(t){return console.warn(t)},Ti=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],kt=.212671,xt=.71516,bt=.072169,Ke=function(t){return ae(ut[t])?ut[t]:ut.filters[t]},ie=function(t,e){var i=[],o=0,s=0,d,a;for(d=0;d<4;d++){for(a=0;a<5;a++)s=a===4?t[o+4]:0,i[o+a]=t[o]*e[a]+t[o+1]*e[a+5]+t[o+2]*e[a+10]+t[o+3]*e[a+15]+s;o+=5}return i},ye=function(t,e){var i=1-e,o=i*kt,s=i*xt,d=i*bt;return ie([o+e,s,d,0,0,o,s+e,d,0,0,o,s,d+e,0,0,0,0,0,1,0],t)},ve=function(t,e,i){var o=Jt(e),s=o[0]/255,d=o[1]/255,a=o[2]/255,c=1-i;return ie([c+i*s*kt,i*s*xt,i*s*bt,0,0,i*d*kt,c+i*d*xt,i*d*bt,0,0,i*a*kt,i*a*xt,c+i*a*bt,0,0,0,0,0,1,0],t)},we=function(t,e){e*=Math.PI/180;var i=Math.cos(e),o=Math.sin(e);return ie([kt+i*(1-kt)+o*-.212671,xt+i*-.71516+o*-.71516,bt+i*-.072169+o*(1-bt),0,0,kt+i*-.212671+o*.143,xt+i*(1-xt)+o*.14,bt+i*-.072169+o*-.283,0,0,kt+i*-.212671+o*-.787329,xt+i*-.71516+o*xt,bt+i*(1-bt)+o*bt,0,0,0,0,0,1,0,0,0,0,0,1],t)},be=function(t,e){return ie([e,0,0,0,.5*(1-e),0,e,0,0,.5*(1-e),0,0,e,0,.5*(1-e),0,0,0,1,0],t)},Je=function(t,e){var i=Ke(e),o=t.filters||[],s=o.length,d;for(i||Ze(e+" not found. PixiPlugin.registerPIXI(PIXI)");--s>-1;)if(o[s]instanceof i)return o[s];return d=new i,e==="BlurFilter"&&(ee?d.strength=0:d.blur=0),t.filters=[].concat(o,[d]),d},st=function(t,e,i,o){e.add(i,t,i[t],o[t]),e._props.push(t)},xe=function(t,e){var i=Ke("ColorMatrixFilter"),o=new i;return o.matrix=e,o.brightness(t,!0),o.matrix},ki=function(t){var e={},i;for(i in t)e[i]=t[i];return e},dt={contrast:1,saturation:1,colorizeAmount:0,colorize:"rgb(255,255,255)",hue:0,brightness:1},Ii=function(t,e,i){var o=Je(t,"ColorMatrixFilter"),s=t._gsColorMatrixFilter=t._gsColorMatrixFilter||ki(dt),d=e.combineCMF&&!("colorMatrixFilter"in e&&!e.colorMatrixFilter),a,c,l;for(l=o.matrix,e.resolution&&(o.resolution=e.resolution),e.matrix&&e.matrix.length===l.length?(c=e.matrix,s.contrast!==1&&st("contrast",i,s,dt),s.hue&&st("hue",i,s,dt),s.brightness!==1&&st("brightness",i,s,dt),s.colorizeAmount&&(st("colorize",i,s,dt),st("colorizeAmount",i,s,dt)),s.saturation!==1&&st("saturation",i,s,dt)):(c=Ti.slice(),e.contrast!=null?(c=be(c,+e.contrast),st("contrast",i,s,e)):s.contrast!==1&&(d?c=be(c,s.contrast):st("contrast",i,s,dt)),e.hue!=null?(c=we(c,+e.hue),st("hue",i,s,e)):s.hue&&(d?c=we(c,s.hue):st("hue",i,s,dt)),e.brightness!=null?(c=xe(+e.brightness,c),st("brightness",i,s,e)):s.brightness!==1&&(d?c=xe(s.brightness,c):st("brightness",i,s,dt)),e.colorize!=null?(e.colorizeAmount="colorizeAmount"in e?+e.colorizeAmount:1,c=ve(c,e.colorize,e.colorizeAmount),st("colorize",i,s,e),st("colorizeAmount",i,s,e)):s.colorizeAmount&&(d?c=ve(c,s.colorize,s.colorizeAmount):(st("colorize",i,s,dt),st("colorizeAmount",i,s,dt))),e.saturation!=null?(c=ye(c,+e.saturation),st("saturation",i,s,e)):s.saturation!==1&&(d?c=ye(c,s.saturation):st("saturation",i,s,dt))),a=c.length;--a>-1;)c[a]!==l[a]&&i.add(l,a,l[a],c[a],"colorMatrixFilter");i._props.push("colorMatrixFilter")},_i=function(t,e){var i=e.t,o=e.p,s=e.color,d=e.set;d(i,o,s[0]<<16|s[1]<<8|s[2])},Mi=function(t,e){var i=e.g;ee?(i.fill(),i.stroke()):i&&(i.dirty++,i.clearDirty++)},Ei=function(t,e){e.t.visible=!!e.t.alpha},Ce=function(t,e,i,o){var s=t[e],d=Jt(ae(s)?t[e.indexOf("set")||!ae(t["get"+e.substr(3)])?e:"get"+e.substr(3)]():s),a=Jt(i);o._pt=new Ut(o._pt,t,e,0,0,_i,{t,p:e,color:d,set:Qe(t,e)}),o.add(d,0,d[0],a[0]),o.add(d,1,d[1],a[1]),o.add(d,2,d[2],a[2])},Si={tint:1,lineColor:1,fillColor:1,strokeColor:1},Te="position,scale,skew,pivot,anchor,tilePosition,tileScale".split(","),le={x:"position",y:"position",tileX:"tilePosition",tileY:"tilePosition"},Ai={colorMatrixFilter:1,saturation:1,contrast:1,hue:1,colorize:1,colorizeAmount:1,brightness:1,combineCMF:1},te=Math.PI/180,ti=function(t){return typeof t=="string"},Pi=function(t){return ti(t)&&t.charAt(1)==="="?t.substr(0,2)+parseFloat(t.substr(2))*te:t*te},Ni=function(t,e){return e.set(e.t,e.p,t===1?e.e:Math.round((e.s+e.c*t)*1e5)/1e5,e)},Oi=function(t,e,i,o,s,d){var a=360*(d?te:1),c=ti(s),l=c&&s.charAt(1)==="="?+(s.charAt(0)+"1"):0,h=parseFloat(l?s.substr(2):s)*(d?te:1),r=l?h*l:h-o,f=o+r,p,u;return c&&(p=s.split("_")[1],p==="short"&&(r%=a,r!==r%(a/2)&&(r+=r<0?a:-a)),p==="cw"&&r<0?r=(r+a*1e10)%a-~~(r/a)*a:p==="ccw"&&r>0&&(r=(r-a*1e10)%a-~~(r/a)*a)),t._pt=u=new Ut(t._pt,e,i,o,r,Ni),u.e=f,u},ke=function(){if(!ge){Tt=je(),ut=ge=ut||Xe()&&window.PIXI;var t=ut&&ut.VERSION&&parseFloat(ut.VERSION.split(".")[0])||0;re=t===4,ee=t>=8,Jt=function(i){return Tt.utils.splitColor((i+"").substr(0,2)==="0x"?"#"+i.substr(2):i)}}},Yt,St;for(Yt=0;Yt<Te.length;Yt++)St=Te[Yt],le[St+"X"]=St,le[St+"Y"]=St;var he={version:"3.13.0",name:"pixi",register:function(t,e,i){Tt=t,Ut=i,Qe=e.getSetter,ke()},headless:!0,registerPIXI:function(t){ut=t},init:function(t,e,i,o,s){if(ut||ke(),!ut)return Ze("PIXI was not found. PixiPlugin.registerPIXI(PIXI);"),!1;var d,a,c,l,h,r,f,p,u,g;for(r in e){if(d=le[r],c=e[r],d)a=~r.charAt(r.length-1).toLowerCase().indexOf("x")?"x":"y",this.add(t[d],a,t[d][a],d==="skew"?Pi(c):c,0,0,0,0,0,1);else if(r==="scale"||r==="anchor"||r==="pivot"||r==="tileScale")this.add(t[r],"x",t[r].x,c),this.add(t[r],"y",t[r].y,c);else if(r==="rotation"||r==="angle")Oi(this,t,r,t[r],c,r==="rotation");else if(Ai[r])l||(Ii(t,e.colorMatrixFilter||e,this),l=!0);else if(r==="blur"||r==="blurX"||r==="blurY"||r==="blurPadding"){if(h=Je(t,"BlurFilter"),this.add(h,r,h[r],c),e.blurPadding!==0)for(f=e.blurPadding||Math.max(h[r],c)*2,p=t.filters.length;--p>-1;)t.filters[p].padding=Math.max(t.filters[p].padding,f)}else if(Si[r])if((r==="lineColor"||r==="fillColor"||r==="strokeColor")&&t instanceof ut.Graphics)for(u=("fillStyle"in t)?[t]:(t.geometry||t).graphicsData,g=r.substr(0,r.length-5),ee&&g==="line"&&(g="stroke"),this._pt=new Ut(this._pt,t,r,0,0,Mi,{g:t.geometry||t}),p=u.length;--p>-1;)Ce(re?u[p]:u[p][g+"Style"],re?r:"color",c,this);else Ce(t,r,c,this);else r==="autoAlpha"?(this._pt=new Ut(this._pt,t,"visible",0,0,Ei),this.add(t,"alpha",t.alpha,c),this._props.push("alpha","visible")):r!=="resolution"&&this.add(t,r,"get",c);this._props.push(r)}}};je()&&Tt.registerPlugin(he);const R=new ai,Ri=n=>{let t=!1;return R.on("ON_INFO_MODAL_OPEN",e=>{t&&n.handleInfoModalOpenRequest(e)}),R.on("ON_INFO_MODAL_CLOSE",()=>{n.handleInfoModalCloseRequest()}),R.on("ON_PAUSE_INPUT",()=>{t=!1}),R.on("ON_RESUME_INPUT",()=>{t=!0}),R.on("ON_LEVEL_COMPLETED",()=>{n.handleLevelCompleted()}),R.on("ON_TILE_INTERACTION",({tileViewModel:e})=>{t&&n.handleTileInteraction(e)}),R.on("ON_ITEM_INTERACTION",({itemViewModel:e,action:i})=>{t&&n.handleItemInteraction(e,i)}),R.on("ON_EVENT_INTERACTION",({eventViewModel:e})=>{t&&n.handleEventInteraction(e)}),R.on("ON_CHARACTER_INTERACTION",({characterViewModel:e})=>{t&&n.handleCharacterInteraction(e)}),R.on("ON_INVENTORY_REQUEST",({inventory:e,action:i})=>{t&&n.handleInventoryRequest(e,i)}),R.on("ON_CLOSE_INVENTORY_REQUESTED",()=>{t&&n.onCloseInventoryRequested()}),R.on("ON_TRADE_REQUEST",({action:e})=>{t&&n.handleTradeRequest(e)}),R.on("ON_CHARACTER_INTERACTION_REQUEST",e=>{t&&n.handleCharacterInteractionRequest(e)}),R.on("ON_SETTLEMENT_INTERACTION_REQUEST",e=>{t&&n.handleSettlementInteractionRequest(e)}),R.on("ON_SAVE_REQUEST",()=>{n.handleSaveRequest()}),R.on("ON_LOAD_REQUEST",()=>{n.handleLoadRequest()}),R.on("ON_IN_GAME_MENU_REQUEST",({action:e})=>{n.handleInGameMenuRequest(e)}),R.on("ON_DEBUG_ACTION_REQUESTED",({action:e})=>{t&&n.onDebugActionRequested(e)}),{destroy:()=>{R.removeAllListeners()}}},Vi=()=>{const[n,t]=F(0),[e,i]=F(480);return{getCurrentTurn:()=>n(),getGameTimeMin:()=>e(),nextTurn:()=>{t(a=>a+1),i(a=>{const c=a+10;return c>=1440?0:c})}}},zt=n=>{const{model:t}=n,[e,i]=F(t.armour()>0),[o,s]=F(t.armour()<t.maxArmour()),[d,a]=F(t.damage()>0),[c,l]=F(t.health()>0),h={code:()=>t.code(),name:()=>t.name(),description:()=>t.description(),quantity:()=>t.quantity(),value:()=>t.value(),updateQuantity:r=>{t.updateQuantity(r)},level:()=>t.level(),interact:()=>{R.emit("ON_ITEM_INTERACTION",{itemViewModel:h})},health:()=>t.health(),type:()=>t.type(),damage:()=>t.damage(),range:()=>t.range(),armour:()=>t.armour(),setArmour:r=>{t.setArmour(r)},maxArmour:()=>t.maxArmour(),id:()=>t.id(),isArmourIconVisible:()=>e(),isDamagedArmourIconVisible:()=>o(),isHealthIconVisible:()=>c(),setIsArmourIconVisible:r=>{i(r)},setIsDamagedArmourIconVisible:r=>{s(r)},setIsHealthIconVisible:r=>{l(r)},isDamageIconVisible:()=>d(),setIsDamageIconVisible:r=>{a(r)},uses:()=>t.uses(),setUses:r=>{t.setUses(r)},collected:()=>t.collected(),setCollected:r=>{t.setCollected(r)}};return h},_t=n=>{const{model:t,ownerName:e,owner:i}=n,[o,s]=F([]),[d,a]=F(!1),c=r=>zt({model:r}),l=(r,f)=>{const p=r.code()===f.code(),u=r.armour()===f.armour(),g=r.damage()===f.damage();return p&&u&&g},h={items:()=>t.items().map(r=>c(r)),stacks:()=>o(),setStacks:()=>{const r=[],f=[];h.items().forEach(p=>{if(i&&i.isEquipped(p)){f.push({item:p,quantity:1});return}const u=r.find(g=>l(g.item,p));u?u.quantity+=p.quantity():r.push({item:p,quantity:p.quantity()})}),r.sort((p,u)=>u.item.type()==="currency"&&p.item.type()!=="currency"?1:u.item.type()!=="currency"&&p.item.type()==="currency"?-1:u.item.type()==="light"&&p.item.type()!=="light"?1:u.item.type()!=="light"&&p.item.type()==="light"?-1:u.item.armour()>0&&p.item.armour()<=0?1:u.item.armour()<=0&&p.item.armour()>0?-1:u.item.damage()>0&&p.item.damage()<=0?1:u.item.damage()<=0&&p.item.damage()>0?-1:u.item.health()>0&&p.item.health()<=0?1:u.item.health()<=0&&p.item.health()>0?-1:u.item.type()==="loot"&&p.item.type()!=="loot"?1:u.item.type()!=="loot"&&p.item.type()==="loot"?-1:p.item.name().localeCompare(u.item.name())),s(f.concat(r))},ownerName:()=>e,getItem:r=>h.items().find(f=>l(f,r)),getItemByCode:r=>h.items().find(f=>f.code()===r),getItemByName:r=>h.items().find(f=>f.name()===r),addItem:r=>{t.addItem(It(r.code(),{id:()=>r.id()})),h.setStacks()},removeItem:r=>{t.removeItem(r),h.setStacks(),!r.collected()&&(!i||!i.isAlive())&&!["trade-npc","trade","settlement","hero"].includes(e.toLowerCase())&&["trade-npc","trade","settlement","hero"].filter(f=>e.toLowerCase().includes(f)).length===0&&(r.setCollected(!0),ft().log.collectedItemsValue+=r.value())},owner:i,isEmpty:()=>t.isEmpty(),isOnlyLoot:()=>t.isOnlyLoot(),isInfoButtonEnabled:()=>d(),setInfoButtonEnabled:r=>{a(r)}};return h.setStacks(),lt(()=>{rt(()=>{h.setStacks()})}),h},de=n=>{const{model:t}=n,[e,i]=F(_t({model:t.inventory(),ownerName:t.name()})),o=a=>{if(!a)throw new Error("Item cannot be undefined");const c=t.inventory().getItemById(a.id());if(!c)throw new Error(`Item with code ${a.id()} not found in inventory`);return c},s=a=>{if(!a)throw new Error("Item cannot be undefined");return zt({model:a})},d={id:()=>t.id(),name:()=>t.name(),setInventory:a=>{i(a)},size:()=>t.size(),position:()=>({...t.position(),distanceTo:a=>{const c=t.position().x-a.x,l=t.position().y-a.y;return Math.floor(Math.sqrt(c*c+l*l))}}),health:()=>t.health(),maxHealth:()=>t.maxHealth(),moveTo:(a,c)=>{d.isAlive()&&t.moveTo(a,c)},dialogue:()=>t.dialogue(),isHostile:a=>t.isHostile(a),move:(a,c)=>{const l=t.position(),h=l.x+a,r=l.y+c;t.moveTo(h,r)},team:()=>t.team(),updateTeam:a=>{t.updateTeam(a)},inventory:()=>e(),armour:()=>{var h,r,f;const a=((h=t.bodyArmour())==null?void 0:h.armour())??0,c=((r=t.headArmour())==null?void 0:r.armour())??0,l=((f=t.feetArmour())==null?void 0:f.armour())??0;return a+c+l},takeDamage:a=>{let c=a;new Array(a).fill(0).forEach(()=>{const h=[t.bodyArmour(),t.headArmour(),t.feetArmour()].filter(r=>r&&r.armour()>0);if(h.length!==0){const r=h[Math.floor(Math.random()*h.length)];r.setArmour(r.armour()-1),c--}}),t.id()==="player"&&(ft().log.totalDamageAbsorbed+=a-c,ft().log.totalDamageTaken+=c);const l=t.health()-c;t.setHealth(l)},setHealth:a=>{t.setHealth(a)},setMaxHealth:a=>{t.setMaxHealth(a)},isAlive:()=>t.health()>0,visible:()=>t.visible(),setVisible:a=>{t.setVisible(a)},bodyArmour:()=>s(t.bodyArmour()),setBodyArmour:a=>{a?t.setBodyArmour(o(a)):t.setBodyArmour(void 0)},headArmour:()=>s(t.headArmour()),setHeadArmour:a=>{a?t.setHeadArmour(o(a)):t.setHeadArmour(void 0)},feetArmour:()=>s(t.feetArmour()),setFeetArmour:a=>{a?t.setFeetArmour(o(a)):t.setFeetArmour(void 0)},weapon:()=>{const a=t.weapon();return zt({model:a})},setWeapon:a=>{a?t.setWeapon(o(a)):t.setWeapon(void 0)},isEquipped:a=>{var c,l,h,r;return((c=t.weapon())==null?void 0:c.id())===a.id()||((l=t.bodyArmour())==null?void 0:l.id())===a.id()||((h=t.headArmour())==null?void 0:h.id())===a.id()||((r=t.feetArmour())==null?void 0:r.id())===a.id()}};return i(_t({model:t.inventory(),ownerName:t.name(),owner:d})),d},Li=n=>{const{eventModel:t}=n;return{...t,inventory:()=>_t({model:t.inventory(),ownerName:t.name()})}},Bi=n=>n.tile,Di=n=>{const{model:t}=n,e=o=>Bi({tile:o});return{isValidMove:(o,s)=>t.isValidMove(o,s),entryPoints:()=>t.entryPoints().map(o=>e(o)),tiles:()=>t.tiles().map(o=>o.map(s=>e(s))),updateTile:(o,s,d)=>{t.tiles()[o][s]=d},getNeighbors:o=>{var l;const s=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],d=[],a=o.position().x,c=o.position().y;for(const{dx:h,dy:r}of s){const f=a+h,p=c+r,u=(l=t.tiles()[f])==null?void 0:l[p];u&&d.push(e(u))}return d}}},ei=n=>{const[t,e]=F([]),[i,o]=F(null),[s,d]=F([]),[a,c]=F(null),[l,h]=F(null),[r,f]=F(!1);return{...de({model:n}),setLastSpawned:u=>n.setLastTurnSpawned(u),lastSpawned:()=>n.lastTurnSpawned(),spawnLing:()=>n.spawnling(),getPatrolArea:()=>t(),setPatrolArea:u=>e(u),getTask:()=>i(),setTask:u=>o(u),getTaskList:()=>s(),setTaskList:u=>d(u),getBedLocation:()=>a(),setBedLocation:u=>c(u),getTarget:()=>l(),setTarget:u=>h(u),canTrade:()=>r(),setCanTrade:u=>f(u)}},Wi=n=>{const{model:t}=n,[e,i]=F(!0);return{id:()=>t.id(),name:()=>t.name(),level:()=>t.level(),positions:()=>t.positions(),isVisible:()=>e(),setIsVisible:o=>i(o),isUnlocked:()=>t.isUnlocked(),setIsUnlocked:o=>t.setIsUnlocked(o),inventory:()=>_t({model:t.inventory(),ownerName:t.name()}),getMiddleTopPosition:()=>{const o=t.positions();if(o.length===0)return{x:0,y:0};const s=Math.max(...o.map(a=>a.x)),d=Math.min(...o.map(a=>a.y));return{x:(s-o[0].x)/2+o[0].x,y:d}}}},Hi=n=>{const{playerModel:t,tileMapModel:e,npcModels:i,eventModels:o,settlementModels:s,fogOfWarViewModel:d}=n,a=de({model:t}),c=Di({model:e}),l=i.map(f=>ei(f)),h=o.map(f=>Li({eventModel:f})),r=s.map(f=>Wi({model:f}));return{playerVM:a,tileMapVM:c,npcVMs:l,eventVMs:h,settlementVMs:r,fogOfWarViewModel:d}},Ui=n=>{const{model:t}=n;return{getCurrentTurn:()=>t.getCurrentTurn(),nextTurn:()=>{t.nextTurn()},getCurrentClocktime:()=>{const e=t.getGameTimeMin(),i=Math.floor(e/60),o=e%60;return`${i.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},getCurrentTimeMin:()=>t.getGameTimeMin()}},vt=(n,t)=>Math.floor(Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))),zi=(n,t)=>{let e=[];for(const i of t){const o=i.position(),s=vt(n,o);e.length===0||s<e[0].distance?e=[{npc:i,distance:s}]:s===e[0].distance&&e.push({npc:i,distance:s})}return e},$i=(n,t)=>{let e=null,i=1/0;for(const o of t)o.positions().forEach(s=>{const d=vt(n,s);d<i&&(i=d,e=o)});return e},qi=(n,t)=>{let e=null,i=1/0;for(const o of t){const s=o.position(),d=vt(n,s);d<i&&(i=d,e=o)}return e},Fi=({playerVM:n,npcVMs:t,settlementVMs:e,eventViewModels:i})=>{const[o,s]=F(!0),[d,a]=F(null),[c,l]=F(null),[h,r]=F(null),[f,p]=F(null),[u,g]=F(null),[y,v]=F(null),[M,I]=F(null),[E,_]=F(null),[B,S]=F(null),[T,m]=F(null),x=1;let w=null,b=null,k=null,A=null,L=null,D,P=null,C=null,O=null,z=null;const W=(H,G)=>{if(G){const tt=G.position();if(vt(H,tt)<=x)return w=G,!0}return!1},X=(H,G)=>{if(!G)return I(null),!1;const tt=G.position();return vt(H,tt)<=x&&G.inventory().isEmpty()===!1?(k=G,!0):!1},it=H=>H.isUnlocked()||!n.inventory().items().some(G=>G.code()==="city-key")?!1:(C=H,!0),at=H=>H.isUnlocked()&&!H.inventory().isEmpty()?(O=H,!0):!1,pt=H=>H.isUnlocked()?(z=H,!0):!1,gt=H=>{const G=$i(H,e);return G&&G.positions().forEach(tt=>{if(vt(H,tt)<=x)return it(G),at(G),pt(G),O||(A=G),!0}),!1},nt=(H,G)=>{if(G){const tt=G.position(),et=vt(H,tt);if(et<=n.weapon().range()&&et<=2&&!N(H,G))return L=G,!0}return!1},N=(H,G)=>{if(G){const tt=G.position(),et=vt(H,tt);if(et<=n.weapon().range()&&n.weapon().range()>2&&et>1)return P=G,!0}return!1},V=H=>{const G=n.position();return vt(G,H.position)<=x&&H.inventory.isEmpty()===!1?(D=H.inventory,!0):!1},$=H=>{if(H){const G=n.position(),tt=H.position();if(vt(G,tt)<=x&&H.canTrade())return b=H,!0}return!1},Y=H=>{if(H.isHostile(n.team())){if(H.isAlive()){const G=nt(n.position(),H),tt=N(n.position(),H);return G||tt}else if(H.inventory().isEmpty()===!1)return V({position:H.position(),inventory:H.inventory()})}else return H.isAlive()?(W(n.position(),H),$(H)):V({position:H.position(),inventory:H.inventory()});return!1},K=()=>{w=null,b=null,k=null,A=null,L=null,D=null,P=null,C=null,O=null,z=null},mt=()=>{d()!==w&&a(w),c()!==b&&l(b),M()!==k&&I(k),h()!==A&&r(A),f()!==L&&p(L),y()!==D&&v(D),c()!==b&&l(b),u()!==P&&g(P),E()!==C&&_(C),B()!==O&&S(O),T()!==z&&m(z)},ht=()=>{const H=n.position(),G=zi(H,t),tt=qi(H,i);if(K(),G.length>0)for(let et=0;et<G.length;et++){const oi=G[et].npc;if(Y(oi))break}X(H,tt),gt(H),mt()};return ht(),lt(()=>{rt(()=>{ht()})}),{isVisible:o,setVisibility:H=>s(H),canUnlockSettlement:E,canInteractWithCharacter:d,canAttackCharacter:f,canTradeWithCharacter:c,canVisitSettlement:h,canSearch:M,canLoot:y,canRangedAttackCharacter:u,canTradeWithSettlement:B,canRestAtSettlement:T}},Gi=n=>{const{playerVM:t}=n,[e,i]=F(!1),[o,s]=F(!1),[d,a]=F(!1),[c,l]=F(0),h={torchLeft:()=>c(),health:()=>t.health(),maxHealth:()=>t.maxHealth(),armour:()=>h.bodyArmour().armour()+h.headArmour().armour()+h.feetArmour().armour(),maxArmour:()=>h.bodyArmour().maxArmour()+h.headArmour().maxArmour()+h.feetArmour().maxArmour(),inventoryValue:()=>Math.floor(t.inventory().items().reduce((r,f)=>r+f.value()*f.quantity(),0)),isInventoryValueVisible:r=>(r!==void 0&&i(r),e()),inventory:()=>t.inventory(),weapon:()=>t.weapon(),bodyArmour:()=>t.bodyArmour(),headArmour:()=>t.headArmour(),feetArmour:()=>t.feetArmour(),isInGameMenuVisible:()=>o(),showInGameMenu:r=>{a(!1),s(r)},isSaveCompleted:()=>d(),setIsSaveCompleted:r=>{setTimeout(()=>{a(!1)},2e3),a(r)}};return lt(()=>{rt(()=>{const r=t.inventory().stacks().find(f=>f.item.code()==="torch");l(r?r.quantity:0)})}),h},Yi=n=>{const{gameView:t,viewModel:e}=n,i=new Q,o=new Q;o.label="sensing-fog-of-war",o.alpha=.5,i.label="fog-of-war",i.zIndex=1e4,o.zIndex=10001;const s=()=>{i.destroy({children:!0}),o.destroy({children:!0})};t.addChild(i,o);const d=c=>{const r=c.x-innerWidth*.5,f=c.y-innerHeight*.5,p=innerWidth,u=innerHeight,g=Math.floor(r/64)-2,y=Math.floor(f/64)-2,v=Math.ceil((r+p)/64)+2,M=Math.ceil((f+u)/64)+2,I=[];for(let E=g;E<=v;E++)for(let _=y;_<=M;_++)I.push({x:E,y:_});return I};return{applyFogOfWarExceptAround:c=>{e.setFogOfWarPoints(d(c));const l=64;i.clear(),o.clear();const h=new pe;h.x=c.x,h.y=c.y,h.radius=e.lightRadius()*1.8;const r=new pe;r.x=c.x,r.y=c.y,r.radius=e.lightRadius();for(const f of e.fogOfWarPoints()){const p=new jt;if(p.x=Math.floor(f.x*l),p.y=Math.floor(f.y*l),p.width=l,p.height=l,r.contains(p.x,p.y)){e.addRevealedPoint({x:f.x,y:f.y});continue}if(h.contains(p.x,p.y)){o.rect(p.x,p.y,l,l),o.fill("black"),e.revealedPoints().some(u=>u.x===f.x&&u.y===f.y)||e.addRevealedPoint({x:f.x,y:f.y});continue}if(e.revealedPoints().some(u=>u.x===f.x&&u.y===f.y)){o.rect(p.x,p.y,l,l),o.fill("black");continue}i.rect(p.x,p.y,l,l),i.fill(0)}},destroy:s}},Qi=({gameViews:n,userInterfaceView:t,fogOfWarVM:e})=>{const i=new U,o=new U,s=new Q,d=.2,{gameView:a,nonSkewedView:c}=n;let l=!1,h=!1,r={x:0,y:0},f=null,p=Yi({gameView:a,viewModel:e}),u={x:0,y:0},g;i.label="camera-view",o.label="viewport",o.addChild(s,a,c),a.scale.set(.6),a.width=Math.floor(a.width),a.height=Math.floor(a.height);const y=()=>{f==null||f.kill(),document.removeEventListener("mousedown",M),document.removeEventListener("mouseup",I),document.removeEventListener("mousemove",E),document.removeEventListener("wheel",_),o.destroy({children:!0}),s.destroy(),p==null||p.destroy(),p=null,i.removeChildren(),i.destroy({children:!0})},v=(T,m)=>{s.clear(),s.rect(0,0,T,m),s.fill("black")};i.addChild(o,t);const M=T=>{T.button===0&&(l=!0)},I=T=>{T.button===0&&(l=!1,h=!1)},E=T=>{const m={x:T.clientX,y:T.clientY},x=m.x-r.x,w=m.y-r.y;if(h&&x!==0&&w!==0&&(l=!0),r={x:T.clientX,y:T.clientY},h){const{movementX:b,movementY:k}=T;a.position.x+=b,a.position.y+=k}},_=T=>{const{deltaY:m}=T;a.scale.x+m*.001>1||a.scale.x+m*.001<.5||(a.scale.x+=m*.001,a.scale.y+=m*.001)};document.addEventListener("mousedown",M),document.addEventListener("mouseup",I),document.addEventListener("mousemove",E),document.addEventListener("wheel",_);const B=(T,m)=>{const x=new Fe(T,m),w=a.toGlobal(x),b=innerWidth*.5,k=innerHeight*.5,A=a.position.x-(w.x-b),L=a.position.y-(w.y-k),D={x:Math.floor(A),y:Math.floor(L)},P={x:Math.floor(a.position.x),y:Math.floor(a.position.y)},O=Math.sqrt(Math.pow(D.x-P.x,2)+Math.pow(D.y-P.y,2))>98;f&&f.progress(1),f=j.fromTo(P,{x:P.x,y:P.y},{x:D.x,y:D.y,duration:O?0:1,onUpdate:()=>{a.position.set(P.x,P.y),c.position.set(0,0),!g&&(g=j.delayedCall(d,()=>{g=void 0}),p==null||p.applyFogOfWarExceptAround(x))},onComplete:()=>{p==null||p.applyFogOfWarExceptAround(x),u={x:T,y:m}}})};return{view:i,moveTo:B,resize:(T,m)=>{v(T,m),B(u.x,u.y)},destroy:y,isDragging:()=>l}},Xi=n=>{const{viewModel:t}=n,e=new U,i=t.isAlive()?q.from(`${t.id()}.png`):q.from("corpse.png");let o={x:0,y:0};e.label=`${t.id()}-view`,e.eventMode="static";const s=()=>{i.width=50,i.height=50,i.anchor.set(.5,.5),i.skew.set(.5,0),i.position.set(32,32),e.addChild(i),e.position.set(t.position().x*64,t.position().y*64)};return e.on("pointertap",()=>{R.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})}),s(),{view:e,update:()=>{e.visible=t.visible(),!t.isAlive()&&!i.label.includes("corpse")&&(J.play("audio/sfx/death.mp3",{category:"gameplay"}),i.label=`${t.id()}-corpse`,i.texture=q.from("corpse.png").texture);const a=t.position();if(o.x!==a.x||o.y!==a.y){const c=o.x>a.x,l=o.x!==a.x;if(o={x:a.x,y:a.y},J.play("audio/sfx/step.mp3",{category:"gameplay"}),!l)return;c?(e.scale.x=1,e.pivot.x=0,i.skew.set(-.5,0),i.position.set(32,16)):(e.scale.x=-1,i.position.set(-32,16),i.skew.set(.5,0))}}}},ji=n=>{const{viewModel:t}=n,e=new U;e.label=`${t.name()}-${t.id()}`;const i=q.from(`${t.id()}.png`);i.label=`${t.name()}-${t.id()}`,i.width=64,i.height=64;const o=q.from("cleared.png");o.width=64,o.height=64,o.label="discovered",o.visible=t.discovered(),o.position.set(-16,0);const s=q.from("loot-icon.png");return s.width=32,s.height=32,s.label="loot-available",s.tint="yellow",s.visible=t.discovered()&&!t.inventory().isEmpty(),s.position.set(i.width-s.width,i.height-s.height),e.addChild(i,o,s),e.skew.set(-.5,0),e.eventMode="static",e.on("pointertap",()=>{R.emit("ON_EVENT_INTERACTION",{eventViewModel:t})}),lt(()=>rt(()=>{e.visible=t.visible(),t.visible()&&t.discovered()&&(i.label.includes("visited")||(o.visible=!0,s.visible=!t.inventory().isEmpty()))}),e),{view:e}},Ie={"bed-time":"task-bed-time",patrol:"magnifying-glass-icon",follow:"walking-icon",work:"coins-icon",idle:"task-idle",attack:"attack-icon"},Zi=n=>{const{cellSize:t,npcVMs:e}=n,i=new U,o=new Map;i.label="npc-task-view";const s=h=>{var g;const r=new U,f=new Q,p=((g=h.getTask())==null?void 0:g.name())??"idle",u=q.from(`${Ie[p]||"task-idle"}.png`);r.label=`task-icon-container-${h.id()}`,r.addChild(f,u),u.label=`task-${p}.png`,u.width=t/2,u.height=t/2,o.set(h,{icon:u,container:r,background:f}),f.circle(u.width/2,u.height/2,u.width/1.3),f.fill("khaki"),f.alpha=.75,i.addChild(r)},d=h=>{o.has(h)||s(h)},a=()=>{i.visible=!0},c=()=>{i.visible=!1},l=()=>{o.forEach((h,r)=>{var u;if(h.container.visible=r.visible()&&r.isAlive(),!r.isAlive()){i.removeChild(h.container),h.icon.destroy(),h.background.destroy(),h.container.destroy(),o.delete(r);return}const f=((u=r.getTask())==null?void 0:u.name())??"idle",p=Ie[f]||"task-idle";h.icon.label!==`${p}.png`&&(h.icon.label=`${p}.png`,h.icon.texture=q.from(`${p}.png`).texture),h.container.position.set((r.position().x+.5)*n.cellSize-h.icon.width/2,r.position().y*n.cellSize-t*.6)})};return e.forEach(h=>{d(h)}),{view:i,show:a,hide:c,update:l,addNpc:d}},_e=new Array(5).fill(0),Me=n=>{const{viewModel:t,onStep:e}=n,i=new U;let o=t.id();if(o==="bandit"){const l=Math.floor(Math.random()*5),h=_e.reduce((r,f,p,u)=>f<u[r]?p:r,l);o=`bandit-${h}`,_e[h]++,o=`bandit-${h}`}const s=t.isAlive()?q.from(`${o}.png`):q.from("corpse.png");s.label=t.isAlive()?`${t.id()}-sprite`:`${t.id()}-corpse-sprite`,i.label=`${t.name()}-view`,i.eventMode="static";const d=()=>{const l=t.size()*50;s.width=l,s.height=l,s.anchor.set(.5,.5),s.skew.set(-.5,0),s.position.set(32,32),i.addChild(s),i.position.set(t.position().x,t.position().y)};i.on("pointertap",()=>{R.emit("ON_CHARACTER_INTERACTION_REQUEST",{action:"open",character:t})}),d();let a={x:t.position().x,y:t.position().y};const c=()=>{if(!t.isAlive()&&!s.label.includes("corpse")){J.play("audio/sfx/death.mp3",{category:"gameplay"}),s.label=`${t.id()}-corpse-sprite`,s.texture=q.from("corpse.png").texture;return}};return lt(()=>{rt(()=>{i.visible=t.visible();const l=t.position();if(a.x!==l.x||a.y!==l.y){const h=a.x>l.x,r=a.x!==l.x;if(a={x:l.x,y:l.y},e(),!r)return;h?(i.scale.x=1,i.pivot.x=0,s.skew.set(-.5,0),s.position.set(32,16)):(i.scale.x=-1,s.position.set(-32,16),s.skew.set(.5,0))}})}),{view:i,update:c}},Ki=({viewModel:n,onUnlocked:t})=>{const e=new U;e.label="settlement-view";const i=q.from(`${n.id()}.png`);let o=0,s=0;n.positions().forEach(a=>{a.x>=o&&(o=a.x),a.y>=s&&(s=a.y)}),i.width=Math.floor((o-n.positions()[0].x+1)*64),i.height=Math.floor((s-n.positions()[0].y+1)*64);const d=q.from("blocked.png");return d.width=i.width,d.height=i.height,d.visible=!n.isUnlocked(),e.addChild(i,d),e.eventMode="none",e.skew.set(-.46,0),lt(()=>{rt(()=>{e.visible=n.isVisible(),d.visible&&n.isUnlocked()&&t(),d.visible=!n.isUnlocked()})},e),{view:e}},Ji=(n,t,e)=>{n.alpha=0,j.to(n,{alpha:1,duration:t/1e3,onComplete:e})},tn=(n,t,e)=>{j.to(n,{alpha:0,duration:t/1e3,onComplete:()=>{e()}})},ii=n=>{const{tileSize:t,viewModel:e}=n,{isMiniMapTile:i=!1}=n,o=new U;let s=new q,d=new q;o.label="tile-view",o.eventMode="static";const a=e.type();let c=a;c==="wasteland"?c+=`-${Math.floor(Math.random()*2)}`:c==="forest"?c+=`-${Math.floor(Math.random()*2)}`:c==="settlement"&&(c="wasteland");const l=q.from(`${c}.png`);if(l.width=t,l.height=t,l.anchor.set(.5,.5),l.position.set(t/2,t/2),c==="settlement"&&(l.visible=!1),o.addChild(l),e.hasMud()){const h=q.from("mud.png");h.width=t*.6,h.height=t*.6,h.position.set(t*.2,t*.2),h.alpha=.6,o.addChild(h)}if(!e.traversable()&&a==="void"){const h=Math.floor(Math.random()*6),r=["dead-trees-0","dead-trees-1","dead-trees-2","dead-trees-3","dead-trees-4","dead-trees-1"][h];s=q.from(`${r}.png`),s.width=t*1.2,s.height=t*1.2,s.skew.set(-.5,0)}if(e.hasGrass()){const h=q.from("dead-grass.png");h.width=t*.6,h.height=t*.6,h.alpha=1,h.skew.set(-.4,0),h.position.set(20,0),o.addChild(h)}if(e.hasEyes()){d=q.from("eyes.png"),d.width=t*.8,d.height=t*.8,d.skew.set(-.5,0),d.zIndex=d.position.y+32,d.alpha=0;const h=async()=>{await new Promise(r=>{setTimeout(()=>r(),(d.alpha===1?Math.random()*2e3:Math.random()*5e3)+2e3)}),d.alpha===0?Ji(d,1e3,h):tn(d,1e3,h)};h()}return o.on("pointertap",()=>{R.emit("ON_TILE_INTERACTION",{tileViewModel:e})}),lt(()=>{rt(()=>{o.visible=i?e.discovered():e.visible(),d.visible=e.visible(),s.visible=e.visible()})},o),{view:o,trees:s,eyes:d}},en=n=>{const{viewModel:t,tileSize:e}=n,i=new U;i.label="tile-map-view",i.sortableChildren=!0;const o=t.tiles(),s=[],d=[];return o.forEach((a,c)=>{a.forEach((l,h)=>{const r=ii({tileSize:e,viewModel:l});r.view.label=`tile-${c}-${h}`,r.view.position.set(c*e,h*e),r.trees.position.set(r.view.position.x+20,r.view.position.y-20),r.eyes.position.set(r.view.x+32,r.view.y-20),s.push(r.trees),d.push(r.eyes),i.addChild(r.view)})}),{view:i,trees:s,eyes:d}},nn=n=>{const{viewModel:t}=n,e=new U,i=[],o=64,s=new Map,d=f=>{const p=f.health(),u=f.maxHealth(),g=p/u,y=o*g,{x:v,y:M}=f.position();let I=s.get(f);I?I.clear():I=new Q,I.clear(),I.rect(v*o,M*o-10,o,5),I.fill(0),I.rect(v*o,M*o-10,y,5),I.fill(65280),I.label=`${f.name()}-health-bar`,e.addChild(I),s.set(f,I),j.to(I,{alpha:0,duration:1,delay:1,onComplete:()=>{e.removeChild(I),I.destroy(),s.delete(f)}})},a=(f,p)=>({x:(f.x+p.x)/2,y:(f.y+p.y)/2}),c=f=>{if(e.destroyed)return;const p=f.position(),u=q.from("blood.png");u.width=o,u.height=o,u.position.set(p.x*o,p.y*o),e.addChild(u),f.armour()>0?(u.tint="blue",J.play("audio/sfx/collect.wav",{category:"gameplay"})):(J.play("audio/sfx/fists.mp3",{category:"gameplay"}),d(f)),j.to(u,{alpha:0,duration:.333,ease:"power2.inOut",onComplete:()=>{e.removeChild(u),u.destroy()}})},l=async({source:f,target:p})=>{const u=q.from("slash.png");u.scale.set(.15),u.anchor.set(.5),u.position.set(a(f.position(),p.position()).x*64+32,a(f.position(),p.position()).y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),u.alpha=0,await j.to(u,{alpha:1,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),c(p)},h=async({source:f,target:p})=>{const u=q.from("arrow.png");u.scale.set(.1),u.anchor.set(.5),u.position.set(f.position().x*64+32,f.position().y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),await j.to(u.position,{x:p.position().x*64+32,y:p.position().y*64+32,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),c(p)},r=async()=>{for(;i.length>0;){const f=i.shift();f&&await f()}};return lt(()=>{rt(()=>{const f=t.isAttacking();f&&(f.type==="ranged"?i.push(()=>h(f)):i.push(()=>l(f)))})}),{view:e,process:r}},on=n=>{const{attackVM:t,tileMapVM:e,playerVM:i,tileSize:o,npcVMs:s,eventVMs:d,settlementVMs:a}=n,c=new U,l=new U,h=new U,r=new U,f=nn({viewModel:t});l.label="game-view-container",h.label="tile-container",r.label="talk-overlay",l.sortableChildren=!0,h.zIndex=-1e3;const p=new Map,u=Zi({cellSize:o,npcVMs:s}),g=new Map;let y=null,v=null,M=[],I=[],E=[];const _=[];let B=!1;const S=P=>{const C=Me({viewModel:P,onStep:()=>{P.position().distanceTo(i.position())<6&&J.play("audio/sfx/step.mp3",{category:"gameplay"})}});s.push(P),l.addChild(C.view),M.push(C)},T=()=>{v=en({viewModel:e,tileSize:o}),v.view.label="tile-map-view",y=Xi({viewModel:i}),h.addChild(v.view),v.trees.forEach(P=>{l.addChild(P)}),v.eyes.forEach(P=>{l.addChild(P)}),d.map(P=>{const C=ji({viewModel:P});I.push(C),l.addChild(C.view)}),M=s.map(P=>{const C=Me({viewModel:P,onStep:()=>{P.position().distanceTo(i.position())<6&&J.play("audio/sfx/step.mp3",{category:"gameplay"})}});return l.addChild(C.view),C}),a.map(P=>{const C=Ki({viewModel:P,onUnlocked:()=>{L("city-key",P.getMiddleTopPosition())}});E.push(C),l.addChild(C.view),C.view.label=`settlement-${P.id()}`,C.view.position.set(P.positions()[0].x*o+52,P.positions()[0].y*o-30),C.view.zIndex=C.view.y+32}),l.addChild(h,y.view,r,f.view)},m=()=>{B=!0,_.forEach(P=>P.kill()),v==null||v.view.destroy({children:!0}),y==null||y.view.destroy({children:!0}),r.removeChildren(),v=null,y=null,M.forEach(P=>P.view.destroy({children:!0})),M=[],I.forEach(P=>P.view.destroy({children:!0})),I=[],E.forEach(P=>P.view.destroy({children:!0})),E=[],p.clear(),l.destroy({children:!0})},x=["snow","lightskyblue","lime","yellow","fuchsia","orange"],w=()=>{const P=["snow","lightskyblue","lime","yellow","fuchsia","orange"];return x.length===0&&x.push(...P),x.splice(Math.floor(Math.random()*x.length),1)[0]},b=P=>{const{x:O,y:z}=P.position(),W=new Mt;if(p.get(P.id()))return;W.style={fontFamily:"alagard",fontSize:32,fill:w(),align:"center",dropShadow:!0,stroke:"black",wordWrap:!0,wordWrapWidth:innerWidth*1.5},W.text=P.dialogue(),W.anchor.set(.5);let it=0;const at=O*o+o/2,pt=z*o-o;W.position.set(at,pt),p.forEach(nt=>{W.getBounds().containsPoint(nt.position.x,nt.position.y)&&(it+=nt.height),W.position.set(at,pt-it)}),W.label="text-box",W.zIndex=11e3;const gt=l.toGlobal(W.position);return W.position.set(gt.x,gt.y),W.scale.set(.6),c.addChild(W),setTimeout(()=>{const nt=p.get(P.id());nt&&(l.removeChild(nt),p.delete(P.id()),nt.destroy())},2e3),p.set(P.id(),W),W},k=(P,C)=>{const{x:O,y:z}=C,W=O*o,X=z*o;_.push(j.to(P.view.position,{x:W,y:X,duration:.2,ease:"power2.inOut",onUpdate:()=>{P.view.zIndex=P.view.position.y},onComplete:()=>{P.view.position.set(W,X)}}))},A=async()=>{if(B)return;const{x:P,y:C}=i.position();y&&(y.update(),y.view.zIndex=y.view.position.y,(y.view.position.x!==P*o||y.view.position.y!==C*o)&&k(y,{x:P,y:C})),await f.process();for(const O of M){const z=M.indexOf(O),{x:W,y:X}=s[z].position();O.update(),(O.view.position.x!==W*o||O.view.position.y!==X*o)&&k(O,{x:W,y:X})}I.forEach((O,z)=>{const{x:W,y:X}=d[z].position();O.view.position.set(W*o+20,X*o-50),O.view.scale.set(1.5,1.5),O.view.zIndex=O.view.y+32}),u.update()},L=async(P,C)=>{const O=new U;O.label="looted-icon-container";const z=q.from(`${P}.png`);z.width=o/2,z.height=o/2;const W=new Q;W.circle(o*.25,o*.25,o/2),W.fill("khaki"),O.addChild(W,z),O.zIndex=11e3,O.position.set((C.x+1)*o,C.y*o-o);const X=l.toGlobal(O.position);c.addChild(O),O.position.set(X.x,X.y),O.scale.set(.6);const it=g.get(`${{x:C.x,y:C.y}}`)??0;g.set(`${{x:C.x,y:C.y}}`,it+1),await j.delayedCall(.2*it,()=>{}),j.to(O.position,{y:O.position.y-o*4,duration:1,delay:it*.1,ease:"power2.inOut",onComplete:()=>{c.removeChild(O),O.destroy({children:!0});const at=g.get(`${{x:C.x,y:C.y}}`)??0;at>1?g.set(`${{x:C.x,y:C.y}}`,at-1):g.delete(`${{x:C.x,y:C.y}}`)}})};T(),A(),l.skew.set(Math.PI/6,0),f.view.zIndex=11e3;const D=new Q;return c.addChild(D),c.label="non-skewed-container",D.rect(0,0,innerWidth,innerHeight),D.fill("black"),D.alpha=0,{view:l,nonSkewedContainer:c,addNpc:S,animateIconFloat:L,handleEndOfTurnUpdates:A,createTextBox:b,destroy:m}};var ne={},At={},Ee;function Ft(){if(Ee)return At;Ee=1,Object.defineProperty(At,"__esModule",{value:!0}),At.Collector=void 0;let n=class{constructor(e){this.emit=(...i)=>{e.emitCollecting(this,i)}}};return At.Collector=n,At}var Pt={},Se;function sn(){if(Se)return Pt;Se=1,Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.CollectorArray=void 0;const n=Ft();let t=class extends n.Collector{constructor(){super(...arguments),this.result=[]}handleResult(i){return this.result.push(i),!0}getResult(){return this.result}reset(){this.result.length=0}};return Pt.CollectorArray=t,Pt}var Nt={},Ae;function rn(){if(Ae)return Nt;Ae=1,Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.CollectorLast=void 0;const n=Ft();let t=class extends n.Collector{handleResult(i){return this.result=i,!0}getResult(){return this.result}reset(){delete this.result}};return Nt.CollectorLast=t,Nt}var Ot={},Pe;function an(){if(Pe)return Ot;Pe=1,Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.CollectorUntil0=void 0;const n=Ft();let t=class extends n.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,this.result}getResult(){return this.result}reset(){this.result=!1}};return Ot.CollectorUntil0=t,Ot}var Rt={},Ne;function ln(){if(Ne)return Rt;Ne=1,Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.CollectorWhile0=void 0;const n=Ft();let t=class extends n.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,!this.result}getResult(){return this.result}reset(){this.result=!1}};return Rt.CollectorWhile0=t,Rt}var Vt={},Lt={},Oe;function cn(){if(Oe)return Lt;Oe=1,Object.defineProperty(Lt,"__esModule",{value:!0}),Lt.SignalConnectionImpl=void 0;class n{constructor(e,i){this.link=e,this.parentCleanup=i}disconnect(){return this.link!==null?(this.link.unlink(),this.link=null,this.parentCleanup(),this.parentCleanup=null,!0):!1}set enabled(e){this.link&&this.link.setEnabled(e)}get enabled(){return this.link!==null&&this.link.isEnabled()}}return Lt.SignalConnectionImpl=n,Lt}var Bt={},Re;function hn(){if(Re)return Bt;Re=1,Object.defineProperty(Bt,"__esModule",{value:!0}),Bt.SignalLink=void 0;let n=class ni{constructor(e=null,i=null,o=0){this.enabled=!0,this.newLink=!1,this.callback=null,this.prev=e??this,this.next=i??this,this.order=o}isEnabled(){return this.enabled&&!this.newLink}setEnabled(e){this.enabled=e}unlink(){this.callback=null,this.next.prev=this.prev,this.prev.next=this.next}insert(e,i){let o=this.prev;for(;o!==this&&!(o.order<=i);)o=o.prev;const s=new ni(o,o.next,i);return s.callback=e,o.next=s,s.next.prev=s,s}};return Bt.SignalLink=n,Bt}var Ve;function dn(){if(Ve)return Vt;Ve=1,Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.Signal=void 0;const n=cn(),t=hn();let e=class{constructor(){this.head=new t.SignalLink,this.hasNewLinks=!1,this.emitDepth=0,this.connectionsCount=0}getConnectionsCount(){return this.connectionsCount}hasConnections(){return this.connectionsCount>0}connect(o,s=0){this.connectionsCount++;const d=this.head.insert(o,s);return this.emitDepth>0&&(this.hasNewLinks=!0,d.newLink=!0),new n.SignalConnectionImpl(d,()=>this.decrementConnectionCount())}decrementConnectionCount(){this.connectionsCount--}disconnect(o){for(let s=this.head.next;s!==this.head;s=s.next)if(s.callback===o)return this.decrementConnectionCount(),s.unlink(),!0;return!1}disconnectAll(){for(;this.head.next!==this.head;)this.head.next.unlink();this.connectionsCount=0}emit(...o){this.emitDepth++;for(let s=this.head.next;s!==this.head;s=s.next)s.isEnabled()&&s.callback&&s.callback.apply(null,o);this.emitDepth--,this.unsetNewLink()}emitCollecting(o,s){this.emitDepth++;for(let d=this.head.next;d!==this.head;d=d.next)if(d.isEnabled()&&d.callback){const a=d.callback.apply(null,s);if(!o.handleResult(a))break}this.emitDepth--,this.unsetNewLink()}unsetNewLink(){if(this.hasNewLinks&&this.emitDepth===0){for(let o=this.head.next;o!==this.head;o=o.next)o.newLink=!1;this.hasNewLinks=!1}}};return Vt.Signal=e,Vt}var Dt={},Le;function un(){if(Le)return Dt;Le=1,Object.defineProperty(Dt,"__esModule",{value:!0}),Dt.SignalConnections=void 0;let n=class{constructor(){this.list=[]}add(e){this.list.push(e)}disconnectAll(){for(const e of this.list)e.disconnect();this.list=[]}getCount(){return this.list.length}isEmpty(){return this.list.length===0}};return Dt.SignalConnections=n,Dt}var Be;function fn(){return Be||(Be=1,function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.SignalConnections=n.Signal=n.CollectorWhile0=n.CollectorUntil0=n.CollectorLast=n.CollectorArray=n.Collector=void 0;var t=Ft();Object.defineProperty(n,"Collector",{enumerable:!0,get:function(){return t.Collector}});var e=sn();Object.defineProperty(n,"CollectorArray",{enumerable:!0,get:function(){return e.CollectorArray}});var i=rn();Object.defineProperty(n,"CollectorLast",{enumerable:!0,get:function(){return i.CollectorLast}});var o=an();Object.defineProperty(n,"CollectorUntil0",{enumerable:!0,get:function(){return o.CollectorUntil0}});var s=ln();Object.defineProperty(n,"CollectorWhile0",{enumerable:!0,get:function(){return s.CollectorWhile0}});var d=dn();Object.defineProperty(n,"Signal",{enumerable:!0,get:function(){return d.Signal}});var a=un();Object.defineProperty(n,"SignalConnections",{enumerable:!0,get:function(){return a.SignalConnections}})}(ne)),ne}var De=fn(),pn=Object.defineProperty,mn=(n,t,e)=>t in n?pn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Wt=(n,t,e)=>mn(n,typeof t!="symbol"?t+"":t,e);class gn extends U{constructor(t){var e;super(),Wt(this,"options"),Wt(this,"view"),Wt(this,"_type"),Wt(this,"_maxWidth"),Wt(this,"children",[]),t&&(t.maxWidth&&(this._maxWidth=t.maxWidth),this.init(t)),(e=t==null?void 0:t.items)==null||e.forEach(i=>this.addChild(i)),this.on("added",()=>this.arrangeChildren()),this.on("childAdded",()=>this.arrangeChildren())}init(t){this.options=t,t!=null&&t.type&&(this.type=t.type),t!=null&&t.children&&t.children.forEach(e=>this.addChild(e))}set type(t){this._type=t,this.arrangeChildren()}get type(){return this._type}set elementsMargin(t){if(!this.options)throw new Error("List has not been initiated!");this.options.elementsMargin=t,this.arrangeChildren()}get elementsMargin(){var t;return((t=this.options)==null?void 0:t.elementsMargin)??0}set padding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.padding=t,this.options.vertPadding=t,this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get padding(){var t;return((t=this.options)==null?void 0:t.padding)??0}set vertPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.vertPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get vertPadding(){var t;return((t=this.options)==null?void 0:t.vertPadding)??this.padding??0}set horPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.arrangeChildren()}get horPadding(){var t;return((t=this.options)==null?void 0:t.horPadding)??this.padding??0}set leftPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.leftPadding=t,this.arrangeChildren()}get leftPadding(){var t;return((t=this.options)==null?void 0:t.leftPadding)??this.horPadding}set rightPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.rightPadding=t,this.arrangeChildren()}get rightPadding(){var t;return((t=this.options)==null?void 0:t.rightPadding)??this.horPadding}set topPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.topPadding=t,this.arrangeChildren()}get topPadding(){var t;return((t=this.options)==null?void 0:t.topPadding)??this.vertPadding}set bottomPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.bottomPadding=t,this.arrangeChildren()}get bottomPadding(){var t;return((t=this.options)==null?void 0:t.bottomPadding)??this.vertPadding}arrangeChildren(){var d,a;let t=0,e=this.leftPadding,i=this.topPadding;const o=((d=this.options)==null?void 0:d.elementsMargin)??0;let s=this.maxWidth??((a=this.parent)==null?void 0:a.width);this.rightPadding&&(s-=this.rightPadding),this.children.forEach((c,l)=>{switch(this.type){case"vertical":c.y=i,c.x=e,i+=o+c.height;break;case"horizontal":c.x=e,c.y=i,e+=o+c.width;break;case"bidirectional":default:c.x=e,c.y=i,c.x+c.width>s&&l>0&&(i+=o+t,e=this.leftPadding,c.x=e,c.y=i,t=0),t=Math.max(t,c.height),e+=o+c.width;break}})}removeItem(t){const e=this.children[t];e&&(this.removeChild(e),this.arrangeChildren())}set maxWidth(t){this._maxWidth=t,this.arrangeChildren()}get maxWidth(){return this._maxWidth}}var yn=Object.defineProperty,vn=(n,t,e)=>t in n?yn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Ht=(n,t,e)=>vn(n,typeof t!="symbol"?t+"":t,e);class wn{constructor(t={}){Ht(this,"x"),Ht(this,"ax"),Ht(this,"dx"),Ht(this,"tx"),Ht(this,"_options"),this.x=0,this.ax=0,this.dx=0,this.tx=0,this._options=t,this._options.max=t.max||160,this._options.damp=t.damp||.8,this._options.springiness=t.springiness||.1}update(){this.ax=(this.tx-this.x)*this._options.springiness,this.dx+=this.ax,this.dx*=this._options.damp,this.dx<-this._options.max?this.dx=-this._options.max:this.dx>this._options.max&&(this.dx=this._options.max),this.x+=this.dx}reset(){this.x=0,this.ax=0,this.dx=0,this.tx=0}get max(){return this._options.max}set max(t){this._options.max=t}get damp(){return this._options.damp}set damp(t){this._options.damp=t}get springiness(){return this._options.springiness}set springiness(t){this._options.springiness=t}}var bn=Object.defineProperty,xn=(n,t,e)=>t in n?bn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Et=(n,t,e)=>xn(n,typeof t!="symbol"?t+"":t,e);class Cn{constructor(){Et(this,"done"),Et(this,"to"),Et(this,"_spring"),Et(this,"_pos"),Et(this,"_speed"),Et(this,"_correctSpeed"),this._spring=new wn,this._pos=0,this.to=0}start(t,e,i){this._speed=t,this._pos=e,this.to=i,this.done=!1,this._spring.x=this._pos,this._spring.tx=this.to;const o=this.to-this._pos,s=Math.abs(o)/o,d=Math.abs(this._speed)/this._speed;s!==d?this._correctSpeed=!0:this._correctSpeed=!1}update(){if(this._correctSpeed)this._speed*=.6,Math.abs(this._speed)<2&&(this._correctSpeed=!1),this._pos+=this._speed,this._spring.x=this._pos;else{const t=this.to-this._pos;Math.abs(t)<.05?(this._pos=this.to,this.done=!0):(this._spring.tx=this.to,this._spring.update(),this._pos=this._spring.x)}return this._pos}cancel(){}}var Tn=Object.defineProperty,kn=(n,t,e)=>t in n?Tn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,ct=(n,t,e)=>kn(n,typeof t!="symbol"?t+"":t,e);class We{constructor(t={}){ct(this,"position",0),ct(this,"constrain",!0),ct(this,"min",0),ct(this,"max",0),ct(this,"maxSpeed",400),ct(this,"_ease"),ct(this,"_offset",0),ct(this,"_prev",0),ct(this,"_speed",0),ct(this,"_hasStopped"),ct(this,"_targetSpeed",0),ct(this,"_speedChecker",0),ct(this,"_grab",0),ct(this,"_activeEase"),this.constrain=t.constrain??!0,this.maxSpeed=t.maxSpeed??400,this._ease=t.ease??new Cn}set value(t){this._speed=0,this.position=t}get value(){return this.position}grab(t){this._grab=t,this._offset=this.position-t,this._speedChecker=0,this._targetSpeed=this._speed=0,this._hasStopped=!1}hold(t){this._speedChecker++,this.position=t+this._offset,this._speedChecker>1&&(this._targetSpeed=this.position-this._prev),this._speed+=(this._targetSpeed-this._speed)/2,this._speed>this.maxSpeed?this._speed=this.maxSpeed:this._speed<-this.maxSpeed&&(this._speed=-this.maxSpeed),this._prev=this.position,this.constrain&&(this._activeEase=null,this.position>this.min?this.position-=(this.position-this.min)/1.5:this.position<this.max&&(this.position+=(this.max-this.position)/1.5))}slide(t=!1){this._hasStopped||(this.constrain?this._updateConstrain(t):this._updateDefault())}get moveAmount(){return-(this.position-this._offset-this._grab)}_updateDefault(){this._speed*=.9,this.position+=this._speed,(this._speed<0?this._speed*-1:this._speed)<.01&&(this._hasStopped=!0)}_updateConstrain(t=!1){const e=this.max;t?(this.value>0&&(this.value=0),this.value>0&&(this.value=0),this.value<this.max&&(this.value=this.max),this.value<this.max&&(this.value=this.max)):this.position>this.min||this.position<e||this._activeEase?(this._activeEase||(this._activeEase=this._ease,this.position>this.min?this._activeEase.start(this._speed,this.position,this.min):this._activeEase.start(this._speed,this.position,e)),this.position=this._activeEase.update(),this._activeEase.done&&(this.position=this._activeEase.to,this._speed=0,this._activeEase=null)):this._updateDefault()}}var In=Object.defineProperty,_n=(n,t,e)=>t in n?In(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Ct=(n,t,e)=>_n(n,typeof t!="symbol"?t+"":t,e);class Mn{constructor(t){Ct(this,"xAxis"),Ct(this,"yAxis"),Ct(this,"_isDown"),Ct(this,"_globalPosition"),Ct(this,"_frame"),Ct(this,"_bounds"),Ct(this,"_dirty"),Ct(this,"disableEasing",!1),this.xAxis=new We({ease:t.xEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.yAxis=new We({ease:t.yEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.disableEasing=t.disableEasing??!1,this._frame=new jt,this._bounds=new jt,this._globalPosition=new Fe}pointerDown(t){this._globalPosition=t,this.xAxis.grab(t.x),this.yAxis.grab(t.y),this._isDown=!0}pointerUp(){this._isDown=!1}pointerMove(t){this._globalPosition=t}update(){this._dirty&&(this._dirty=!1,this.xAxis.min=this._bounds.left,this.xAxis.min=this._bounds.right-this._frame.width,this.xAxis.min=this._bounds.top,this.xAxis.min=this._bounds.bottom-this._frame.height),this._isDown?(this.xAxis.hold(this._globalPosition.x),this.yAxis.hold(this._globalPosition.y)):(this.xAxis.slide(this.disableEasing),this.yAxis.slide(this.disableEasing))}resize(t,e){this._frame.x=0,this._frame.width=t,this._frame.y=0,this._frame.height=e,this._dirty=!0}setBounds(t,e,i,o){this._bounds.x=t,this._bounds.width=e-t,this._bounds.y=i,this._bounds.height=o-i,this._dirty=!0}get x(){return this.xAxis.value}get y(){return this.yAxis.value}}var En=Object.defineProperty,Sn=(n,t,e)=>t in n?En(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Z=(n,t,e)=>Sn(n,typeof t!="symbol"?t+"":t,e);class ue extends U{constructor(t){super(),Z(this,"background"),Z(this,"borderMask"),Z(this,"lastWidth"),Z(this,"lastHeight"),Z(this,"_width",0),Z(this,"_height",0),Z(this,"_dimensionChanged",!1),Z(this,"list"),Z(this,"_trackpad"),Z(this,"isDragging",0),Z(this,"interactiveStorage",[]),Z(this,"visibleItems",[]),Z(this,"pressedChild"),Z(this,"ticker",li.shared),Z(this,"options"),Z(this,"stopRenderHiddenItemsTimeout"),Z(this,"onMouseScrollBinding",this.onMouseScroll.bind(this)),Z(this,"dragStarTouchPoint"),Z(this,"isOver",!1),Z(this,"proximityRange"),Z(this,"proximityStatusCache",[]),Z(this,"lastScrollX"),Z(this,"lastScrollY"),Z(this,"proximityCheckFrameCounter",0),Z(this,"onProximityChange",new De.Signal),Z(this,"onScroll",new De.Signal),t&&this.init(t),this.ticker.add(this.update,this)}init(t){this.options=t,this.setBackground(t.background),this._width=t.width|this.background.width,this._height=t.height|this.background.height,this.proximityRange=t.proximityRange??0,this.list||(this.list=new gn,super.addChild(this.list)),this.list.init({type:t.type,elementsMargin:t.elementsMargin,padding:t.padding,vertPadding:t.vertPadding,horPadding:t.horPadding,topPadding:t.topPadding,bottomPadding:t.bottomPadding,leftPadding:t.leftPadding,rightPadding:t.rightPadding}),this.addItems(t.items),this.hasBounds&&(this.addMask(),this.makeScrollable()),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.options.globalScroll=t.globalScroll??!0,this.options.shiftScroll=t.shiftScroll??!1,this.resize()}get hasBounds(){return!!this._width||!!this._height}addItems(t){t!=null&&t.length&&t.forEach(e=>this.addItem(e))}removeItems(){this.proximityStatusCache.length=0,this.list.removeChildren()}addItem(...t){if(t.length>1)t.forEach(e=>this.addItem(e));else{const e=t[0];(!e.width||!e.height)&&console.error("ScrollBox item should have size"),e.eventMode="static",this.list.addChild(e),this.proximityStatusCache.push(!1),this.options.disableDynamicRendering||(e.renderable=this.isItemVisible(e))}return this.resize(),t[0]}removeItem(t){this.list.removeItem(t),this.proximityStatusCache.splice(t,1),this.resize()}isItemVisible(t,e=0){let i=!1;const o=this.list;if(this.isVertical||this.isBidirectional){const s=t.y+o.y;s+t.height>=-e&&s<=this.options.height+e&&(i=!0)}if(this.isHorizontal||this.isBidirectional){const s=t.x+o.x;s+t.width>=-e&&s<=this.options.width+e&&(i=!0)}return i}get items(){var t;return((t=this.list)==null?void 0:t.children)??[]}setBackground(t){this.background&&this.removeChild(this.background),this.options.background=t,this.background=new Q,this.addChildAt(this.background,0),this.resize()}addMask(){this.borderMask||(this.borderMask=new Q,super.addChild(this.borderMask),this.mask=this.borderMask),this.resize()}makeScrollable(){this._trackpad||(this._trackpad=new Mn({disableEasing:this.options.disableEasing})),this.on("pointerdown",t=>{this.renderAllItems(),this.isDragging=1,this.dragStarTouchPoint=this.worldTransform.applyInverse(t.global),this._trackpad.pointerDown(this.dragStarTouchPoint);const e=this.list.worldTransform.applyInverse(t.global);this.visibleItems.forEach(i=>{i.x<e.x&&i.x+i.width>e.x&&i.y<e.y&&i.y+i.height>e.y&&(this.pressedChild=i)})}),this.on("pointerup",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("pointerover",()=>{this.isOver=!0}),this.on("pointerout",()=>{this.isOver=!1}),this.on("pointerupoutside",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("globalpointermove",t=>{var i,o;if(!this.isDragging)return;const e=this.worldTransform.applyInverse(t.global);if(this.dragStarTouchPoint){const s=this.options.dragTrashHold??10;if(this.isHorizontal||this.isBidirectional){const d=e.x-this.dragStarTouchPoint.x;Math.abs(d)>s&&(this.isDragging=2)}if(this.isVertical||this.isBidirectional){const d=e.y-this.dragStarTouchPoint.y;Math.abs(d)>s&&(this.isDragging=2)}}this.dragStarTouchPoint&&this.isDragging!==2||(this._trackpad.pointerMove(e),this.pressedChild&&(this.revertClick(this.pressedChild),this.pressedChild=null),this.isBidirectional?(i=this.onScroll)==null||i.emit({x:this.scrollX,y:this.scrollY}):(o=this.onScroll)==null||o.emit(this.isVertical?this.scrollY:this.scrollX))}),document.addEventListener("wheel",this.onMouseScrollBinding,!0)}setInteractive(t){this.eventMode=t?"static":"auto"}get listHeight(){return this.list.height+this.list.topPadding+this.list.bottomPadding}get listWidth(){return this.list.width+this.list.leftPadding+this.list.rightPadding}resize(t=!1){if(this.hasBounds){if(this.renderAllItems(),this.borderMask&&(t||this._dimensionChanged||this.lastWidth!==this.listWidth||this.lastHeight!==this.listHeight)){this.options.width||(this._width+=this.listWidth),this.options.height||(this._height+=this.listHeight),this.borderMask.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill(16711935).stroke(0),this.borderMask.eventMode="none";const e=this.options.background;this.background.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill({color:e??0,alpha:e?1:1e-7}),this.isBidirectional?this.setInteractive(this.listWidth>this._width||this.listHeight>this._height):this.isHorizontal?this.setInteractive(this.listWidth>this._width):this.setInteractive(this.listHeight>this._height),this.lastWidth=this.listWidth,this.lastHeight=this.listHeight}if(this._trackpad){const e=this.borderMask.width-this.list.width-this.list.leftPadding-this.list.rightPadding,i=this.borderMask.height-this.list.height-this.list.topPadding-this.list.bottomPadding;this.isBidirectional?(this._trackpad.yAxis.max=-Math.abs(i),this._trackpad.xAxis.max=-Math.abs(e)):this.isVertical?this._trackpad.yAxis.max=-Math.abs(i):this.isHorizontal&&(this._trackpad.xAxis.max=-Math.abs(e))}this._dimensionChanged?(this.list.arrangeChildren(),this.stopRenderHiddenItems(),this._dimensionChanged=!1):(t&&this.list.arrangeChildren(),this.updateVisibleItems()),this.lastScrollX=null,this.lastScrollY=null}}onMouseScroll(t){var s,d,a;if(!this.isOver&&!this.options.globalScroll)return;this.renderAllItems();const e=!!this.options.shiftScroll,i=e?typeof t.deltaX<"u"||typeof t.deltaY<"u":typeof t.deltaX<"u",o=typeof t.deltaY<"u";if((this.isHorizontal||this.isBidirectional)&&i){const c=e||this.isBidirectional?t.deltaX:t.deltaY,l=this.list.x-c;if(this.listWidth<this._width)this._trackpad.xAxis.value=0;else{const h=this._width-this.listWidth,r=0;this._trackpad.xAxis.value=Math.min(r,Math.max(h,l))}}if((this.isVertical||this.isBidirectional)&&o){const c=this.list.y-t.deltaY;if(this.listHeight<this._height)this._trackpad.yAxis.value=0;else{const l=this._height-this.listHeight,h=0;this._trackpad.yAxis.value=Math.min(h,Math.max(l,c))}}this.isBidirectional&&(i||o)?(s=this.onScroll)==null||s.emit({x:this._trackpad.xAxis.value,y:this._trackpad.yAxis.value}):this.isHorizontal&&i?(d=this.onScroll)==null||d.emit(this._trackpad.xAxis.value):this.isVertical&&o&&((a=this.onScroll)==null||a.emit(this._trackpad.yAxis.value)),this.stopRenderHiddenItems()}scrollBottom(){this.interactive?this.scrollTo(this.list.children.length-1):this.scrollTop()}scrollTop(){this.renderAllItems(),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.stopRenderHiddenItems()}renderAllItems(){clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null,!this.options.disableDynamicRendering&&this.items.forEach(t=>{t.renderable=!0})}stopRenderHiddenItems(){this.options.disableDynamicRendering||(this.stopRenderHiddenItemsTimeout&&(clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null),this.stopRenderHiddenItemsTimeout=setTimeout(()=>this.updateVisibleItems(),2e3))}updateVisibleItems(){this.visibleItems.length=0,this.items.forEach(t=>{t.renderable=this.isItemVisible(t),this.visibleItems.push(t)})}scrollTo(t){if(!this.interactive)return;const e=this.list.children[t];e&&(this.renderAllItems(),this._trackpad.xAxis.value=this.isHorizontal||this.isBidirectional?this._width-e.x-e.width-this.list.rightPadding:0,this._trackpad.yAxis.value=this.isVertical||this.isBidirectional?this._height-e.y-e.height-this.list.bottomPadding:0,this.stopRenderHiddenItems())}scrollToPosition({x:t,y:e}){t===void 0&&e===void 0||(this.renderAllItems(),t!==void 0&&(this.scrollX=-t),e!==void 0&&(this.scrollY=-e),this.stopRenderHiddenItems())}get height(){return this._height}set height(t){this._height=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}get width(){return this._width}set width(t){this._width=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}setSize(t,e){typeof t=="object"?(e=t.height??t.width,t=t.width):e=e??t,this._width=t,this._height=e,this._dimensionChanged=!0,this.resize(),this.scrollTop()}getSize(t){return t=t||{width:0,height:0},t.width=this._width,t.height=this._height,t}get scrollX(){return this._trackpad.xAxis.value}set scrollX(t){this._trackpad.xAxis.value=t}get scrollY(){return this._trackpad.yAxis.value}set scrollY(t){this._trackpad.yAxis.value=t}update(){this.list&&(this._trackpad.update(),(this.isHorizontal||this.isBidirectional)&&this.list.x!==this._trackpad.x&&(this.list.x=this._trackpad.x),(this.isVertical||this.isBidirectional)&&this.list.y!==this._trackpad.y&&(this.list.y=this._trackpad.y),!this.options.disableProximityCheck&&(this._trackpad.x!==this.lastScrollX||this._trackpad.y!==this.lastScrollY)&&(this.proximityCheckFrameCounter++,this.proximityCheckFrameCounter>=(this.options.proximityDebounce??10)&&(this.items.forEach((t,e)=>{const i=this.isItemVisible(t,this.proximityRange),o=this.proximityStatusCache[e];i!==o&&(this.proximityStatusCache[e]=i,this.onProximityChange.emit({item:t,index:e,inRange:i}))}),this.lastScrollX=this._trackpad.x,this.lastScrollY=this._trackpad.y,this.proximityCheckFrameCounter=0)))}destroy(t){this.ticker.remove(this.update,this),document.removeEventListener("wheel",this.onMouseScrollBinding,!0),this.background.destroy(),this.list.destroy(),super.destroy(t)}restoreItemsInteractivity(){this.interactiveStorage.forEach(t=>{t.item.eventMode=t.eventMode}),this.interactiveStorage.length=0}revertClick(t){t.eventMode!=="auto"&&(ci.any?t.emit("pointerupoutside",null):t.emit("mouseupoutside",null),this.interactiveStorage.push({item:t,eventMode:t.eventMode}),t.eventMode="auto"),t instanceof U&&t.children&&t.children.forEach(e=>this.revertClick(e))}get scrollHeight(){return this.list.height}get scrollWidth(){return this.list.width}get isVertical(){return(this.options.type??"vertical")==="vertical"}get isHorizontal(){return this.options.type==="horizontal"}get isBidirectional(){return this.options.type==="bidirectional"}}const An=()=>{const n=document.createElement("canvas");n.width=256,n.height=1;const t=n.getContext("2d"),e=t.createLinearGradient(0,0,n.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,n.width,1),Zt.from(n)},He=(n,t)=>{const e=new U,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},o=new Mt,s=new Q;o.text=n,o.style=i;const d=()=>{s.clear(),s.roundRect(o.x-10,o.y,o.width+20,o.height,10),s.fill("black"),s.alpha=.5};e.addChild(s,o);const a=c=>{o.text=c,d()};return d(),{view:e,updateText:a}},Pn=n=>{const t=An(),e=new q(t);return e.label="gradient-background",e.position.set(n.x,n.y-2.5),e.width=n.width+16,e.height=n.height+5,n.addChildAt(e,0),e},$t=n=>{const{viewModel:t,includeItemValue:e,quantity:i}=n,o=n.itemValue,s=new U;let d=!1;s.label=`${t.name()}-view`,s.eventMode="static";const a=q.from(`${t.code()}.png`);a.width=50,a.height=50,s.addChild(a);const c=He(`${(i==null?void 0:i.toString())??t.quantity().toString()}`);c.view.position.set(a.width-c.view.width*.5,a.height);let l=null;e&&(l=He(`$ ${(o||t.value()).toString()}`,{fill:"gold"}),l.view.position.set(a.width-l.view.width*.5,0),s.addChild(l.view),a.position.set(0,l.view.height+5),c.view.position.set(a.width-c.view.width*.5,l.view.height+a.height));const h=a.y+a.height,r=(y,v)=>{const M=new U;return v()<=0||(d=!0,Array(v()).fill(0).forEach((I,E)=>{const _=q.from(`${y}-icon.png`);_.width=20,_.height=20,_.position.set(2.5+E*_.width*.5,0),M.addChildAt(_,0)}),Pn(M),M.position.set(0,h-M.height+14),s.addChild(M)),M};t.isArmourIconVisible()&&r("armour",t.armour);const f=new U;if(t.isHealthIconVisible()&&r("health",t.health),t.isDamageIconVisible()&&t.damage()>0&&t.range()>0){const y=r("damage",t.damage),v=r("range",t.range);v.position.set(y.x,y.y-v.height)}const p=q.from("armour-broken-icon.png");p.width=20,p.height=20,p.position.set(0,a.height-p.height),s.addChild(c.view,p,f),s.on("pointertap",()=>{u()}),d&&a.position.set(16,a.y);const u=()=>{t.interact(),J.play("audio/sfx/collect.wav",{category:"gameplay"})},g=lt(()=>{rt(()=>{c.updateText((i==null?void 0:i.toString())??t.quantity().toString()),p.visible=t.maxArmour()>0&&t.armour()<=0})});return s.on("destroy",()=>{g()}),{view:s,interact:u}},Nn=(n,t)=>{const i=new Q;return i.roundRect(-2.5,-2.5,n.view.width+2.5*2,n.view.height+2.5,10),i.fill(t??"gray"),i.alpha=.8,i.eventMode="static",i},qt=(n,t)=>{const e=new U;e.addChild(n.view),e.label=`${n.view.label}-container`,e.eventMode="static";const i=Nn(n,t);return e.addChild(i,n.view),{container:e,background:i}},oe=({content:n,onClick:t})=>{const e=new U,i=new Q,o=new Mt,s=3,d=10;return o.text=n,o.style={fontSize:30,fill:"black",align:"center",fontFamily:"alagard"},i.roundRect(-3,-3,o.width+s*2,o.height+s*2,d),i.fill("khaki"),e.addChild(i,o),e.eventMode="static",e.on("pointertap",t),e},On=n=>{const t=new U,e=10;t.label="global-inventory-view",t.eventMode="static";const i=Kt({text:n.ownerName(),fontSize:26,disableBackground:!0}),o=q.from("text-background.png"),s=q.from("text-background.png"),d=new Q;t.addChild(o,i,d);const a=()=>{o.width=l.width,o.height=i.height,s.width=l.width,s.height=g.height*2,s.position.set(0,l.height+g.height*2),d.clear(),d.label="title-background-stroke",d.rect(o.x,o.y,o.width,o.height),d.rect(s.x,s.y,s.width,s.height),d.stroke({color:"khaki",width:2})},c=innerWidth<innerHeight,l=new ue({width:c?innerWidth:innerWidth*.8,height:c?innerHeight*.6:innerHeight*.8,padding:e,radius:10,elementsMargin:e}),h=oe({content:"Inspect",onClick:()=>{n.setInfoButtonEnabled(!n.isInfoButtonEnabled()),h.tint=n.isInfoButtonEnabled()?"lightgreen":"white"}});l.label="global-inventory-scroll-box",l.position.set(0,i.height+e),t.addChild(l,s,h),t.visible=!1;const r=(v,M)=>M.weapon().id()===v.id()||M.bodyArmour().id()===v.id()||M.headArmour().id()===v.id()||M.feetArmour().id()===v.id(),f=v=>{v=v??!1,l.removeItems();const M=1.5;n.stacks().forEach(I=>{const E=$t({viewModel:I.item,includeItemValue:v,quantity:I.quantity}),_=new U,B=n.owner?r(I.item,n.owner):!1,S=qt(E,B?"lightgreen":"gray");_.on("pointertap",()=>{m()}),_.addChild(S.background,S.container),_.label=`${E.view.label}-container`,l.addItem(_);const T=Math.min(M,Math.min((l.width-e*2)/_.width,(l.height-e*2)/_.height));_.scale.set(T),E.view.off("pointertap");const m=()=>{if(n.isInfoButtonEnabled()){R.emit("ON_INFO_MODAL_OPEN",{title:I.item.name(),content:I.item.description(),type:I.item.type()});return}E.interact();const x=_.tint;_.tint="green",setTimeout(()=>{_.tint=x},200)}})},p=(v=!1)=>{f(v),n.setInfoButtonEnabled(!1),J.play("audio/sfx/inventory-open.wav",{category:"gameplay"}),t.visible=!0},u=()=>{n.setInfoButtonEnabled(!1),R.emit("ON_CLOSE_INVENTORY_REQUESTED")},g=oe({content:"Close",onClick:()=>{n.setInfoButtonEnabled(!1),R.emit("ON_CLOSE_INVENTORY_REQUESTED")}});if(i.position.set(t.width*.5,i.height*.5),g.position.set(l.width-g.width,l.height+g.height*2.5),h.position.set(g.position.x-h.width-5,g.position.y),t.addChild(g),n.ownerName()!=="Hero"){const v=oe({content:"Collect All",onClick:()=>{n.items().forEach(M=>{M.interact()}),J.play("audio/sfx/inventory-open.wav",{category:"gameplay"})}});v.position.set(v.width*.2,g.y),t.addChild(v)}const y=Math.max(.6,Math.min(innerWidth/t.width,innerHeight/t.height));return t.scale.set(Math.min(.6,y)),lt(()=>{rt(()=>{n.isEmpty()&&u(),n.isInfoButtonEnabled()||R.emit("ON_INFO_MODAL_CLOSE"),f(),i.position.set(l.width*.5,i.height*.5),g.position.set(l.width-g.width,l.height+g.height*2.5),h.position.set(g.position.x-h.width-5,g.position.y),a()})},t),{view:t,show:p,hide:u}},Rn=n=>{const{viewModel:t}=n,e=new U;e.label="new-trade-view",e.alpha=0;const i=new Q;i.label="new-trade-view-background",e.addChild(i);const o=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let s=!1;const d=({title:T,stacks:m,width:x,height:w,playerStacks:b,npcInv:k=!1,includeItemValue:A=!1,isTradeInv:L=!1})=>{const D=new U;D.label=`${T}-screen-view`;const P=q.from("text-background.png");P.label=`${T}-title-background`;const C=new Q;C.label=`${T}-title-background-outline`;const O=Kt({text:T,disableBackground:!0,onClick:()=>{}});O.label=`${T}-title-button`;const z=new ue({width:x,height:w,padding:4,elementsMargin:2});z.label=`${T}-inventory-view`;const W=new Q;W.label=`${T}-background`,D.addChild(W,P,O,z,C);const X=(it,at,pt)=>{const gt=innerHeight>innerWidth;it.forEach(nt=>{const N=$t({viewModel:nt.item,includeItemValue:A,itemValue:t.getItemPrice(nt.item,pt),quantity:nt.quantity}),$=qt(N,at==="buy"||at==="buy-return"?"pink":"lightblue"),Y=new U;N.view.off("pointertap"),Y.on("pointertap",()=>{mt(),R.emit("ON_ITEM_INTERACTION",{itemViewModel:nt.item,action:at}),s=!0}),Y.addChild($.container,N.view),Y.label=`${N.view.label}-container`,z.addItem(Y);const K=gt?.6:.7;Y.scale.set(Math.min(K,x/(N.view.width+10)),Math.min(K,w/(N.view.height+10)));const mt=()=>{Y.tint=65280,setTimeout(()=>{Y.tint=16777215},200)}})};return k?X(m,"buy",!0):L?(X(b||[],"sell-return",!1),X(m,"buy-return",!0)):X(m,"sell",!1),O.scale.set(.4),O.position.set(x*.5,O.height*.5),z.position.set(x*.5-z.width*.5,O.height+10),P.x=z.width*.025,P.width=z.width*.95,P.height=O.height,C.rect(P.x,0,P.width,P.height),C.stroke({color:"khaki",width:2}),W.rect(0,0,D.width,D.height),W.label=`${T}-background-rect`,W.fill("black"),W.stroke("black"),D};let a=null,c=null,l=null,h=null,r=null,f=null,p=null,u=null,g=null,y=null;const v=q.from("text-background.png");v.label="trade-buttons-container-background";const M=new Q;M.label="trade-buttons-container-background-outline";const I=()=>{a||c?_():J.play("audio/sfx/door.mp3");const{innerWidth:T,innerHeight:m}=window,x=m>T,w=x?T:T*.9*.3,b=x?m*.7*.3:m*.9;o(),r=wt({spriteName:"trade-icon",onClick:()=>{R.emit("ON_TRADE_REQUEST",{action:"autoTrade"}),s=!0},alpha:.8}),h=wt({spriteName:"exit-icon",onClick:()=>{R.emit("ON_CLOSE_INVENTORY_REQUESTED"),s=!0},alpha:.8});const k=()=>{y&&(e.removeChild(y),y.destroy(),y=null)},A=()=>{const P=Math.abs(t.value().quantity()),C=t.value().quantity()<0?{type:"Insufficient Funds",content:"You do not have enough funds to complete this trade."}:{type:"Trade Imbalance",content:`Trader has insufficient funds, you will lose ${P} ${P>1?"coins":"coin"}.`};y=Ge({title:"Confirm Trade",type:C.type,content:C.content,onConfirm:t.value().quantity()>0?()=>{R.emit("ON_TRADE_REQUEST",{action:"submit"}),s=!0,k()}:void 0,onCancel:()=>{R.emit("ON_TRADE_REQUEST",{action:"clear"}),k(),s=!0}}),e.addChild(y),y.position.set(e.width*.5-y.width*.25,e.height*.5-y.height*.5)};f=wt({spriteName:"confirm-icon",onClick:()=>{R.emit("ON_TRADE_REQUEST",{action:"submit"}),s=!0},alpha:.8}),p=wt({spriteName:"cancel-icon",onClick:()=>{if(t.npcTradeItems().isEmpty()&&t.playerTradeItems().isEmpty()){R.emit("ON_CLOSE_INVENTORY_REQUESTED"),s=!0;return}R.emit("ON_TRADE_REQUEST",{action:"clear"}),s=!0},alpha:.8});let L="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?L="green":t.value().quantity()>0?L="yellow":L="red");const D=$t({viewModel:t.value()});g=qt(D,L).container,u=new U,u.label="trade-buttons-container",u.addChild(h,f,p,r),e.addChild(v,u,M),a=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:w,height:b,includeItemValue:!0,isTradeInv:!1}),e.addChild(a),a.label="player-trade-screen",c=d({title:"Trader",stacks:t.npcInventory().stacks(),width:w,height:b,npcInv:!0,includeItemValue:!0,isTradeInv:!1}),e.addChild(c),c.label="npc-trade-screen",l=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:w,height:b,includeItemValue:!0,isTradeInv:!0}),e.addChild(l),e.alpha=1,l.label="trade-screen",t.isConfirmationModalVisible()&&A()},E=(T=!1)=>{!u||!h||(M.clear(),T?(v.angle=90,v.height=h.height*1.4,v.width=u.height,v.position.set(u.x+v.height,u.y-h.height*.2-5),M.rect(v.x-v.height,v.y,v.height,v.width)):(v.angle=0,v.width=u.width,v.height=h.height*1.4,v.position.set(u.x-17,u.y+5),M.rect(v.x,v.y,v.width,v.height)),M.stroke({color:"khaki",width:2}))},_=()=>{a&&(e.removeChild(a),a.destroy(),a=null),c&&(e.removeChild(c),c.destroy(),c=null),l&&(e.removeChild(l),l.destroy(),l=null),h&&(e.removeChild(h),h.destroy(),h=null),f&&(e.removeChild(f),f.destroy(),f=null),p&&(e.removeChild(p),p.destroy(),p=null),r&&(e.removeChild(r),r.destroy(),r=null),u&&(e.removeChild(u),u.destroy(),u=null),g&&(e.removeChild(g),g.destroy(),g=null),y&&(e.removeChild(y),y.destroy(),y=null),e.alpha=0},B=(T,m)=>{if(e.alpha===0||!a||!c||!l)return;if(m>T){if(a.position.set(0,0),l.position.set(0,a.y+a.height+2),c.position.set(0,l.position.y+l.height+2),u){const w=T-20,b=u.children,k=b.reduce((D,P)=>D+P.width,0)+((g==null?void 0:g.width)??0),A=Math.min(30,b.length>1?(w-k)/b.length:0);let L=0;b.forEach(D=>{D.position.set(L,D.height*.5),L+=D.width+A}),g&&(u.addChild(g),g.position.set(u.width,g.height*.2)),u.position.set(T*.5-u.width*.5+15,c.position.y+c.height),E()}}else if(a.position.set(0,0),l.position.set(2+a.position.x+a.width,0),c.position.set(2+l.position.x+l.width,0),u){const w=m-20,b=u.children,k=b.reduce((D,P)=>D+P.height,0)+((g==null?void 0:g.height)??0),A=Math.min(30,b.length>1?(w-k)/b.length:0);let L=0;b.forEach(D=>{D.position.set(D.width*.5,L),L+=D.height+A}),g&&(u.addChild(g),g.position.set(g.width*.35,u.height-10)),u.position.set(c.position.x+c.width,m*.5-u.height*.5+20),E(!0)}};return{view:e,show:I,hide:_,resize:B,update:()=>{!s&&!t.isAutoTrading()||(s=!1,e.alpha!==0&&(I(),B(innerWidth,innerHeight)))}}},Vn=n=>{const{viewModel:t}=n,e=new U,i=[],o=new U;e.addChild(o),o.label="icons-container",e.visible=t.isVisible();const s=new Q;s.rect(0,0,innerWidth,64),s.fill("black"),s.alpha=0,e.addChild(s);const d=[],a=()=>{o.removeChildren(),o.destroy({children:!0}),s.destroy(),e.removeChildren(),e.destroy({children:!0}),d.forEach(S=>S.kill())},c=S=>{const T=new U;T.label=`${S}-icon`,T.eventMode="static";const m=new Q;m.circle(0,0,32),m.stroke({color:"khaki",width:4}),m.fill("khaki"),m.alpha=.5,T.addChild(m);const x=q.from(`${S}-icon.png`);return x.anchor.set(.5),x.width=32,x.height=32,i.push(T),T.addChild(x),o.addChild(T),T},l=c("city-key");l.on("pointertap",()=>{const S=t.canUnlockSettlement();S&&(J.play("audio/sfx/sfx-unlock.wav"),R.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:S,action:"unlock"}))});const h=c("talk");h.on("pointertap",()=>{J.play("audio/sfx/click.wav"),R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:t.canInteractWithCharacter()??void 0,action:"talk"})}),h.visible=t.canInteractWithCharacter()!==null;const r=c("trade");r.on("pointertap",()=>{const S=t.canTradeWithCharacter();if(S){R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:S,action:"trade"});return}const T=t.canTradeWithSettlement();T&&(J.play("audio/sfx/click.wav"),R.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:T,action:"trade"}))}),r.visible=t.canTradeWithCharacter()!==null||t.canTradeWithSettlement()!==null;const f=c("settlement");f.on("pointertap",()=>{const S=t.canVisitSettlement();S&&(J.play("audio/sfx/click.wav"),R.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:S,action:"trade"}))});const p=c("attack");p.on("pointertap",()=>{const S=t.canAttackCharacter();S&&R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:S,action:"attack"})});const u=c("ranged-attack");u.on("pointertap",()=>{const S=t.canRangedAttackCharacter();S&&R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:S,action:"attack"})});const g=c("loot");g.on("pointertap",()=>{const S=t.canLoot();S&&R.emit("ON_INVENTORY_REQUEST",{inventory:S,action:"open"})});const y=c("search");y.on("pointertap",()=>{const S=t.canSearch();S&&R.emit("ON_EVENT_INTERACTION",{eventViewModel:S})});const v=c("rest");v.on("pointertap",()=>{t.canRestAtSettlement()&&(J.play("audio/sfx/click.wav"),R.emit("ON_LEVEL_COMPLETED"))});const M=()=>{let T=0;i.filter(m=>m.visible).forEach((m,x)=>{m.x=x*(m.width+16),m.y=(e.height-m.height)/2,T=x}),o.x=32+(innerWidth-(T+1)*(i[0].width+16))/2},I=async S=>{S.scale.set(0),S.alpha=0,S.visible=!0;const T=1,m=1.15,x=500,w=x*.7,b=x*.3;d.push(j.to(S,{alpha:1,duration:x/1e3,ease:"power1.inOut",onUpdate:()=>{M()}}));const k=j.to(S.scale,{x:m,y:m,duration:w/1e3,ease:"power1.inOut"});d.push(k),await k,d.push(j.to(S.scale,{x:T,y:T,duration:b/1e3,ease:"power1.inOut"}))},E=(S,T)=>{s.clear(),s.rect(0,0,S,64),s.fill("black"),s.alpha=0,M()},_=(S,T)=>{!S.visible&&T()?(S.visible=!0,I(S)):S.visible=T()!==null},B=()=>{e.visible=t.isVisible(),_(h,()=>t.canInteractWithCharacter()),_(r,()=>t.canTradeWithCharacter()||t.canTradeWithSettlement()),_(f,()=>t.canVisitSettlement()),_(p,()=>t.canAttackCharacter()),_(u,()=>t.canRangedAttackCharacter()),_(g,()=>t.canLoot()),_(y,()=>t.canSearch()),_(l,()=>t.canUnlockSettlement()),_(v,()=>t.canRestAtSettlement()),M()};return lt(()=>{rt(()=>{B()})},e),{view:e,resize:E,destroy:a}},Ln=n=>{let t=[];const e=new U;e.label="grid-container";const i=()=>{const a=innerWidth<innerHeight,c=30,l=a?(innerWidth-40)/2:innerWidth-15,h=12,r=c+10;t.forEach((f,p)=>{const u=Math.floor(p/(a?2:1)),g=p%(a?2:1);f.icon.position.set(g*l,u*(f.icon.height+h)),f.stats.position.set(f.icon.x+c*.5+r,f.icon.y+(f.icon.height-f.stats.height)/2),f.stats.scale.set(1);const y=l-r-10;f.stats.width>y&&(f.stats.width=y)}),d()},o=a=>{const{icon:c,stats:l}=a,h=Math.floor(t.length/(innerWidth<innerHeight?2:1)),r=t.length%(innerWidth<innerHeight?2:1);t.push({icon:c,stats:l,row:h,column:r}),i()},s=()=>{t=[],e.removeChildren()},d=()=>{e.removeChildren(),t.forEach(a=>{const c=new Q;c.roundRect(a.icon.x-5,a.icon.y-5,a.icon.width+10,a.icon.height+10,5),c.fill("khaki"),c.stroke(16777215),c.alpha=.5,c.label="icon-background",e.addChild(c,a.icon,a.stats)})};return i(),{gridContainer:e,addDataToGrid:o,resize:i,renderGrid:d,clearDataFromGrid:s}},Ue=(n,t)=>{const e=new U,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},o=new Mt,s=new Q;o.text=n,o.style=i;const d=()=>{s.clear(),s.roundRect(o.x-10,o.y,o.width+20,o.height,10),s.fill("black"),s.alpha=.5};e.addChild(s,o);const a=c=>{o.text=c,d()};return d(),{view:e,updateText:a}},Bn=()=>{const n=document.createElement("canvas");n.width=256,n.height=1;const t=n.getContext("2d"),e=t.createLinearGradient(0,0,n.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,n.width,1),Zt.from(n)},Dn=n=>{const{playerUiVM:t,miniMapVM:e}=n,i=40,o=10,s=new U;s.label="player-ui-view";const d=Ln(),a=(N,V,$,Y,K)=>{const mt=new U,ht=new Q,H=1;ht.rect(0,0,200,20),ht.fill(0),ht.stroke(16777215);const G=190/V,tt=new Q;for(let et=N>V?V-1:N-1;et>=0;et--)tt.rect(5+et*G,5,G-H,10),et>=N-4?tt.fill($):et>=N-7&&K?tt.fill(K):tt.fill(Y);return mt.addChild(ht,tt),mt},c=()=>{w&&(w.visible=!0),x&&(x.visible=!0),b&&(b.visible=!0),h.visible=!0,r.visible=!0,g.visible=!0,u.visible=t.armour()>0&&t.maxArmour()>0,v.visible=!0,y.visible=!0,s.visible=!0},l=()=>{s.visible=!1},h=q.from("health-icon.png");h.label="health-icon",h.anchor.set(.5),h.width=i,h.height=i;const r=q.from("torch-icon.png");r.label="torch-icon",r.anchor.set(.5),r.scale.set(.1);const f=Ue(`$ ${t.inventoryValue().toString()}`,{fill:"gold",fontSize:20}),p=q.from("coin.png");p.label="inventory-value-icon",p.anchor.set(.5),p.width=i,p.height=i,p.eventMode="static",f.view.eventMode="static",p.onpointertap=f.view.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Inventory Value",content:"The total value of all your inventory items.",type:`${t.inventoryValue()}`})};const u=q.from("armour-icon.png");u.label="armour-icon",u.anchor.set(.5),u.width=i,u.height=i;const g=wt({spriteName:"map-icon",onClick:()=>{e.setVisible(!e.isVisible())},onClickAudio:""}),y=wt({spriteName:"base-portrait",onClick:()=>{e.isVisible()&&e.setVisible(!1),g.visible=!g.visible,R.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})},onClickAudio:""}),v=wt({spriteName:"menu-icon",onClick:()=>{S(),R.emit("ON_IN_GAME_MENU_REQUEST",{action:"open"})}}),M=wt({spriteName:"min-icon",onClick:()=>{c(),R.emit("ON_IN_GAME_MENU_REQUEST",{action:"close"})},onClickAudio:"deselect"}),I=wt({spriteName:"save-icon",onClick:()=>{_.updateText("Saving..."),R.emit("ON_SAVE_REQUEST")}}),E=wt({spriteName:"load-icon",onClick:()=>{_.updateText("Loading..."),R.emit("ON_LOAD_REQUEST")}}),_=Ue("Game Paused"),B=()=>{v.visible=!1,_.view.visible=!0,M.visible=!0,I.visible=!0,E.visible=!0},S=()=>{v.visible=!1,g.visible=!1,y.visible=!1,h.visible=!1,r.visible=!1,u.visible=!1,x&&(x.visible=!1),b&&(b.visible=!1),w&&(w.visible=!1)},T=()=>{S(),g.visible=!0},m=()=>{v.visible=!0,_.updateText("Game Paused"),_.view.visible=!1,M.visible=!1,I.visible=!1,E.visible=!1};s.addChild(r,h,p,f.view,y,d.gridContainer,u,v,M,I,_.view,E,g);let x=null,w=null,b=null,k=null,A=null,L=null,D=null;const P=()=>{if(b&&s.removeChild(b),t.maxArmour()<=0||t.armour()<=0){b=null;return}b=a(t.armour(),t.maxArmour(),"blue","blue"),b.position.set(h.width+o,h.y-b.height*.5),b.label="armour-bar",s.addChild(b)},C=()=>{x&&s.removeChild(x),x=a(t.health(),t.maxHealth(),"red","red"),x.label="health-bar",x.position.set(h.width+o,h.y-x.height*.5),s.addChild(x),h.eventMode="static",x.eventMode="static",h.onpointertap=x.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Health",content:`You have ${t.health()} health points.`,type:`Max Health: ${t.maxHealth()}`})}},O=N=>{const V=new U,$=20;V.label="stat-container";let Y=0;if(Object.entries(N).forEach(([mt,ht],H)=>{H!==0&&(Y+=V.width),Array(ht()).fill(0).forEach((G,tt)=>{const et=q.from(mt+".png");et.width=$,et.height=$,et.position.set(Y+tt*$*.5,0),V.addChildAt(et,0)})}),V.width===0)return V;const K=new q(Bn());return K.x=V.x-5,K.y=V.y-5,K.width=V.width+64,K.height=V.height+10,K.label="row-gradient-background",V.addChildAt(K,0),V},z=()=>{const N=t.weapon();k?k.removeChildren():(k=new U,k.label="weapon-icon",s.addChild(k));const V=q.from(N.code()+".png");V.width=i,V.height=i;const $=O({"damage-icon":()=>N.damage(),"range-icon":()=>N.range()});return V.eventMode="static",$.eventMode="static",V.onpointertap=k.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Weapon",content:`${N.name()!=="Fists"?N.name():"Nothing"} equipped.`,type:`Damage: ${N.damage()}, Range: ${N.range()}`})},{icon:V,stats:$}},W=()=>{const N=t.bodyArmour();A?A.removeChildren():(A=new U,A.label="armour-icon",s.addChild(A));const V=q.from(N.code()+".png");V.width=i,V.height=i;const $=O({"armour-icon":()=>N.armour()});return V.eventMode="static",$.eventMode="static",V.onpointertap=u.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Body",content:`${N.armour()===0?"Not protected":`Wearing ${N.name()}`}`,type:`Armour: ${N.armour()}`})},{icon:V,stats:$}},X=()=>{const N=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Head",content:`${t.headArmour().armour()===0?"Not protected":`Wearing ${t.headArmour().name()}`}`,type:`Armour: ${t.headArmour().armour()}`})},V=t.headArmour();L?L.removeChildren():(L=new U,L.label="head-armour-icon",s.addChild(L));const $=V.code()==="head"?"base-portrait":V.code(),Y=q.from($+".png");Y.width=i,Y.height=i;const K=O({"armour-icon":()=>V.armour()});return Y.eventMode="static",K.eventMode="static",Y.onpointertap=u.onpointertap=()=>{N()},{icon:Y,stats:K}},it=()=>{const N=t.feetArmour();D?D.removeChildren():(D=new U,D.label="feet-armour-icon",s.addChild(D));const V=q.from(N.code()+".png");V.width=i,V.height=i;const $=O({"armour-icon":()=>N.armour()});return V.eventMode="static",$.eventMode="static",V.onpointertap=u.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Feet",content:`${N.armour()===0?"Not protected":`Wearing ${N.name()}`}`,type:`Armour: ${N.armour()}`})},{icon:V,stats:$}},at=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Torch",content:`You have ${t.torchLeft()} torches left.`,type:"Light"})},pt=()=>{w&&s.removeChild(w),w=a(t.torchLeft(),30,"red","brown","khaki"),w.label="torch-bar",x&&w.position.set(x.x,r.y-7),s.addChild(w),r.eventMode="static",w.eventMode="static",r.onpointertap=w.onpointertap=()=>{at()}},gt=()=>{S(),x&&(x.visible=!0),w&&(w.visible=!0),h.visible=!0,r.visible=!0,u.visible=t.armour()>0&&t.maxArmour()>0,b&&(b.visible=!0),y.visible=!0},nt=()=>{h.position.set(10,10),u.position.set(10,10),x&&(x.position.set(h.width+o,h.y-x.height*.5),f.view.position.set(x.x,p.y-f.view.height*.5),b&&b.position.set(x.x,x.y)),w&&x&&w.position.set(x.x,r.y-7),r.position.set(10,h.height+15),p.position.set(10,r.y+r.height),d.resize(),d.gridContainer.position.set(0,p.y+p.height*.5+10),y.position.set(innerWidth-(y.width+16),10),g.position.set(innerWidth-(g.width+16),y.y+y.height+10),v.position.set(innerWidth-(v.width+16),g.y+g.height+10),M.position.set(v.x,v.y),I.position.set(v.x,v.y+v.height+10),E.position.set(v.x,I.y+I.height+10),_.view.position.set(innerWidth/2-_.view.width/2,innerHeight/2-20),s.position.set(20,20)};return m(),nt(),lt(()=>{rt(()=>{h.visible&&C(),u.visible&&P(),t.torchLeft()>=0&&r.visible&&pt(),t.isSaveCompleted()?_.updateText("Save completed"):_.updateText("Game Paused"),u.visible=t.maxArmour()>0&&t.armour()>0,t.isInGameMenuVisible()?B():m(),t.isInventoryValueVisible()?(p.visible=!0,v.visible=!1,f.view.visible=!0,d.gridContainer.visible=!0,d.clearDataFromGrid(),d.addDataToGrid(X()),d.addDataToGrid(z()),d.addDataToGrid(W()),d.addDataToGrid(it())):(p.visible=!1,M.visible||(v.visible=!0),f.view.visible=!1,d.gridContainer.visible=!1),f.updateText(`$ ${t.inventoryValue().toString()}`),nt()})},s),{view:s,show:c,hide:l,resize:nt,showOnlyMapIcon:T,showOnlyInventoryIcon:gt}},Wn=n=>{const{viewModel:t}=n,e=new U;e.label="new-trade-view";const i=new Q;i.label="new-trade-view-background",e.addChild(i);const o=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let s=!1;const d=({title:y,stacks:v,width:M,height:I,playerStacks:E,npcInv:_=!1,includeItemValue:B=!1,isTradeInv:S=!1})=>{const T=new U;T.label=`${y}-screen-view`;const m=Kt({text:y,onClick:()=>{}});m.label=`${y}-title-button`;const x=new ue({width:M,height:I,padding:4,elementsMargin:2});x.label=`${y}-inventory-view`;const w=new Q;w.label=`${y}-background`,T.addChild(w,m,x);const b=(k,A,L)=>{k.forEach(D=>{const P=$t({viewModel:D.item,includeItemValue:B,itemValue:t.getItemPrice(D.item,L),quantity:D.quantity}),O=qt(P,A==="buy"||A==="buy-return"?"pink":"lightblue"),z=new U;P.view.off("pointertap"),z.on("pointertap",()=>{W(),R.emit("ON_ITEM_INTERACTION",{itemViewModel:D.item,action:A}),s=!0}),z.addChild(O.container,P.view),z.label=`${P.view.label}-container`,x.addItem(z);const W=()=>{z.tint=65280,setTimeout(()=>{z.tint=16777215},200)}})};return _?b(v,"buy",!0):S?(b(E||[],"sell-return",!1),b(v,"buy-return",!0)):b(v,"sell",!1),m.scale.set(.4),m.position.set(M*.5,m.height*.5),x.position.set(M*.5-x.width*.5,m.height+10),w.rect(0,0,T.width,T.height),w.fill("black"),w.stroke("black"),T};let a=null,c=null,l=null,h=null,r=null;const f=()=>{a?p():J.play("audio/sfx/door.mp3");const{innerWidth:y,innerHeight:v}=window,M=v>y,I=M?y:y*.35,E=M?v*.35:v;o(),l=Kt({text:"Continue",onClick:()=>{l.eventMode="none",R.emit("ON_TRADE_REQUEST",{action:"confirm-bulk-trade"}),j.delayedCall(.5,()=>{R.emit("ON_CLOSE_INVENTORY_REQUESTED")}),s=!0}}),l.alpha=0,l.label="continue-button";let _="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?_="green":t.value().quantity()>0?_="yellow":_="red");const B=$t({viewModel:t.value()});r=qt(B,_).container,h=new U,h.label="trade-buttons-container",h.addChild(l,r),l.scale.set(.4),e.addChild(h),a=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:I,height:E,includeItemValue:!0,isTradeInv:!1}),e.addChild(a),a.label="player-trade-screen",c=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:I,height:E,includeItemValue:!0,isTradeInv:!0}),e.addChild(c),c.label="trade-screen",l&&(l.alpha=t.isContinueButtonVisible()?1:0),e.visible=!0},p=()=>{a&&(e.removeChild(a),a.destroy(),a=null),c&&(e.removeChild(c),c.destroy(),c=null),l&&(e.removeChild(l),l.destroy(),l=null),h&&(e.removeChild(h),h.destroy(),h=null),r&&(e.removeChild(r),r.destroy(),r=null),e.visible=!1},u=(y,v)=>{if(!e.visible||!a||!c)return;v>y?(a.position.set(0,0),c.position.set(0,a.y+a.height+2),r&&l&&(r.position.set(-r.width*.5,-r.height*.5),l.position.set(r.x+r.width+l.width*.5,0)),h&&h.position.set(y*.5-h.width*.5,c.position.y+c.height+h.height*.5+10)):(a.position.set(0,0),c.position.set(2+a.position.x+a.width,0),r&&l&&(r.position.set(0,0),l.position.set(20,r.y+r.height+30)),h&&h.position.set(c.position.x+c.width+h.width*.5,v*.5-h.height*.5))};return{view:e,show:f,hide:p,resize:u,update:()=>{l&&(l&&(l.alpha=t.isContinueButtonVisible()?1:0),l.alpha===1&&!s)||!s&&!t.isAutoTrading()||(s=!1,e.visible&&(f(),u(innerWidth,innerHeight)))}}},Hn=n=>{const t=n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2");return t.charAt(0).toUpperCase()+t.slice(1)},Un=n=>{const t=ft().log;let e=[],i=!0;const o=new U;o.label="log-view",o.alpha=0;const s=new U;s.label="log-grid-layout",o.addChild(s);const d=new Q;s.addChild(d);const a=()=>{if(e.length>0){e.forEach(g=>g()),e=[];return}u()},c=async g=>{var S;const y=s.children.length,v=innerWidth/2-20,M=new Mt,I=g.name.toLowerCase().includes("value");M.style={fontFamily:"alagard",fontSize:20,fill:"black"},M.text=Hn(g.name),M.position.set(10,y*15);const E=new U;E.label="log-value-container",E.position.set(v+(innerWidth<innerHeight?100:0),M.y);const _=new Mt;_.style={fontFamily:"alagard",fontSize:18,fill:"black"},_.text=I?"$":"",_.text+=g.value??((S=g.to)==null?void 0:S.toString())??"",E.addChild(_),s.addChild(M),s.addChild(E),M.alpha=0,E.alpha=0,!await new Promise(T=>{j.delayedCall(g.index*.5,()=>{i||T(!0),e.shift(),T(!1)}),e.push(()=>T(!0))})&&i&&J.play("audio/sfx/sfx-thud.mp3"),M.alpha=1,E.alpha=1};Object.entries(t).sort((g,y)=>g.toLocaleString().localeCompare(y.toLocaleString())).forEach(([g,y],v)=>{c(typeof y=="string"?{name:g,value:y,index:v}:{name:g,to:y,index:v})});const l=5;d.roundRect(-5,-5,s.width+30+l*2,s.height+30+l*2,30),d.fill("khaki"),o.eventMode="static",o.on("pointertap",()=>{a()});const h=new Mt;h.text="Tap to continue",h.style={fontFamily:"alagard",fontSize:20,fill:"white"};const r=innerHeight>innerWidth;h.position.set(r?(o.width-h.width)*.5:o.width+40,r?o.height+20:o.height*.5),o.addChild(h);const f=()=>{i=!0,o.visible=!0,o.alpha=0,j.to(o,{alpha:1,duration:.5,ease:"power2.out"})},p=()=>{i=!1},u=()=>{i=!1,j.to(o,{alpha:0,duration:.5,ease:"power2.in",onComplete:()=>{o.visible=!1,n()}})};return{view:o,destroy:p,show:f,hide:u,handleAnyPress:a}},zn=n=>{const{miniMapVM:t}=n,e=new U,i=8;e.label="minimap-view",e.visible=t.isVisible();const o=new U;o.label="minimap-tile-map";const s=new U;s.label="minimap-tiles";const d=new Q,a=[],c=q.from(Zt.WHITE);c.width=i,c.height=i,c.tint="blue",setInterval(()=>{c.visible=!c.visible},500),setInterval(()=>{d.visible=!d.visible},222),c.position.set(t.playerPosition().x*i,t.playerPosition().y*i),t.tiles().forEach((f,p)=>{f.forEach((u,g)=>{const y=ii({viewModel:u,tileSize:i,isMiniMapTile:!0});if(u.type()==="settlement"){const v=q.from(Zt.WHITE);v.width=i,v.height=i,v.tint="green",v.position.set(p*i,g*i),a.push({tileVM:u,indicator:v}),s.addChild(v),v.visible=u.visible()}y.view.position.set(p*i,g*i),y.view.alpha=1,y.view.visible=u.discovered(),s.addChild(y.view)})});const l=new Q;l.rect(0,0,t.tiles().length*i,t.tiles()[0].length*i),l.fill("black"),l.alpha=0,s.addChild(...a.map(f=>f.indicator),d,c),o.addChild(s),e.addChild(l,o);const h=()=>{d.clear(),t.npcPositions().forEach(f=>{d.rect(f.x*i,f.y*i,i,i),d.fill("red")})},r=()=>{a.forEach(f=>{const p=f.tileVM;f.indicator.visible=p.discovered()&&t.isVisible(),p.visible()&&f.indicator.position.set(p.position().x*i,p.position().y*i)})};return lt(()=>{rt(()=>{c.position.set(t.playerPosition().x*i,t.playerPosition().y*i),r(),h()}),rt(()=>{e.visible=t.isVisible()})},e),{view:e}},$n=n=>{const t=new U,{playerMenuVM:e,miniMapVM:i}=n;let o=null,s=null,d=null,a=null,c=null,l=null,h=0,r;const f=zn({miniMapVM:i}),p=()=>{r&&(t.removeChild(r),r.destroy(),r=void 0,R.emit("ON_RESUME_INPUT"))},u=C=>{p(),R.emit("ON_PAUSE_INPUT"),r=Ge({title:C.title,content:C.content,type:C.type,contentStyle:C.contentStyle??g,onClose:()=>{C.onClose&&C.onClose(),p()},onConfirm:C.onConfirm}),t.addChild(r),r.position.set(t.width*.5-r.width*.25,t.height*.5-r.height*.5)},g={fontSize:20,fill:"white",fontFamily:"alagard",align:"center"},y=new Q;y.label="background",y.alpha=0,y.on("pointertap",()=>{l==null||l.handleAnyPress()}),t.addChild(y);const v=()=>{y.clear(),y.rect(0,0,innerWidth,innerHeight),y.fill("black")},M=()=>{p(),k(),w(),y.alpha=0},I=()=>{a&&(a.view.visible=!1),y.alpha=0},E=()=>{I(),T(),_(),y.alpha=1,l=Un(()=>{_(),R.emit("ON_LEVEL_COMPLETED")});const C=Math.min(1,Math.min(innerWidth/l.view.width,innerHeight/l.view.height));l.view.scale.set(C),l.view.position.set(innerWidth*.5-l.view.width*.5,innerHeight*.5-l.view.height*.5),t.addChild(l.view),l.show(),y.eventMode="static"},_=()=>{y.eventMode="none",l&&(l.destroy(),t.removeChild(l.view),l.view.destroy({children:!0}),l=null)},B=()=>{const C=n.playerUiVM();if(!C)return;if(a){a.view.position.set(30,30),a.view.visible=!0;return}a=Dn({playerUiVM:C,miniMapVM:i});const O=Math.min(1,Math.min(innerWidth/a.view.width,innerHeight/a.view.height));a.view.scale.set(O),a.view.position.set(30,30),h=t.children.length,t.addChild(a.view),a.view.visible=!0,a.view.label="player-ui-view"},S=()=>{const C=e();if(!C)return;s||(s=Vn({viewModel:C}),t.addChild(s.view));const O=Math.min(1,Math.min(innerWidth/s.view.width,innerHeight/s.view.height));s.view.scale.set(O),s.view.position.set(innerWidth*.5-s.view.width*.5,innerHeight*.9-s.view.height*.5),s.view.visible=!0},T=()=>{s&&(s.view.visible=!1),y.alpha=0},m=C=>{w(),T(),I(),y.alpha=1,d=Wn({viewModel:C}),t.addChild(d.view),d.show()},x=C=>{w(),T(),I(),y.alpha=1,d=Rn({viewModel:C}),t.addChild(d.view),d.show(),A(innerWidth,innerHeight)},w=()=>{S(),B(),d&&(t.removeChild(d.view),d.view.destroy(),d=null),y.alpha=0,A(innerWidth,innerHeight)},b=C=>{if(T(),(C==null?void 0:C.ownerName())!=="Hero"&&(a==null||a.showOnlyInventoryIcon()),y.alpha=1,c&&!C)C=c;else if(!C)throw new Error("No inventory provided to showInventory");c=C,setTimeout(()=>{o=On(C),o.show(),t.addChildAt(o.view,h),A(innerWidth,innerHeight)},10)},k=(C=!0)=>{S(),a==null||a.show(),o&&(t.removeChild(o.view),o.view.destroy(),o=null),C&&(c=null),y.alpha=0},A=(C,O,z=!1)=>{v();const W=O>C;if(D(),d){d.show(),d.resize(C,O);const X=W?Math.min(1,O/d.view.height):Math.min(1,C/d.view.width);d.view.scale.set(X);const it=W?(t.width-d.view.width)*.5:0,at=W?0:(t.height-d.view.height)*.5;d.view.position.set(it,at)}if(s&&(s.resize(C,O),s.view.position.set(C*.5-s.view.width*.5,O*.9-s.view.height*.5)),a&&a.resize(),l&&E(),o&&a){if(z){k(!1),b();return}const X=W?(C-o.view.width)*.5:a.view.width*.5,it=W?a.view.y+a.view.height+10:(O-o.view.height)*.5;o.view.position.set(X,it)}r&&r.position.set(t.width*.5-r.width*.25,t.height*.5-r.height*.5)},L=()=>{d==null||d.update()};t.label="user-interface-view";const D=()=>{const C=Math.min(.7,Math.min(t.width/f.view.width,t.height/f.view.height));f.view.scale.set(C),f.view.position.set((innerWidth-f.view.width)*.5,(innerHeight-f.view.height)*.5),t.addChild(f.view)};v();const P=()=>{t.removeChildren(),y.destroy(),o=null,s==null||s.destroy(),s=null,d=null,a=null};return lt(()=>{rt(()=>{i.isVisible()?(y.alpha=1,a&&a.showOnlyMapIcon(),s&&(s.view.visible=!1)):(y.alpha=0,a&&a.show(),s&&(s.view.visible=!0))})},t),{showInventory:b,hideInventory:k,showTrade:x,hideTrade:w,showBulkTrade:m,view:t,closeAll:M,showPlayerMenu:S,hidePlayerMenu:T,showPlayerUi:B,resize:A,destroy:P,update:L,showEndOfLevelLog:E,hideEndOfLevelLog:_,showInfoModal:u,hideInfoModal:p}},qn=()=>{const n=ce.map(e=>(e.code()==="torch"&&e.updateQuantity(11),It(e.code()))),t=Xt(n);return _t({model:t,ownerName:"Global Inventory"})},Fn=n=>{const{playerVM:t,tileMapVM:e}=n,i=(a,c)=>{const l=t.position().x+a,h=t.position().y+c;if(l<=0&&l>=e.tiles().length-1&&h<=0&&h>=e.tiles()[0].length-1)return;const r=e.tiles()[l][h];r&&R.emit("ON_TILE_INTERACTION",{tileViewModel:r})},o=a=>{switch(a){case"endLevel":R.emit("ON_LEVEL_COMPLETED");break;case"showInventory":R.emit("ON_INVENTORY_REQUEST",{inventory:qn(),action:"open"});break;case"showCharacterDetails":console.debug("Showing character details");break;case"moveLeft":i(-1,0);break;case"moveRight":i(1,0);break;case"moveUp":i(0,-1);break;case"moveDown":i(0,1);break;default:console.warn(`Unknown action: ${a}`)}},s=a=>{switch(a.key){case"r":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"endLevel"});break;case"i":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"showInventory"});break;case"w":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveUp"});break;case"s":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveDown"});break;case"a":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveLeft"});break;case"d":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveRight"});break;case"6":R.emit("ON_SAVE_REQUEST");break;case"8":R.emit("ON_LOAD_REQUEST");break}};return document.addEventListener("keypress",s),{handleDebugActionRequest:o,destroy:()=>{document.removeEventListener("keypress",s)}}};function Gn(n){const t=[];let e=n;for(;e;)t.unshift(e.tile),e=e.previous;return t}function Gt({start:n,end:t,map:e,maxDistance:i=7}){const o=e.tiles().flat().find(r=>r.position().x===n.x&&r.position().y===n.y),s=e.tiles().flat().find(r=>r.position().x===t.x&&r.position().y===t.y);if(!o||!s)return null;const d=Math.sqrt(Math.pow(s.position().x-o.position().x,2)+Math.pow(s.position().y-o.position().y,2)),a={previous:null,tile:o,g:0},c=r=>{let f=!1,p=r.previous;for(;p;){if(p.tile.position().x===r.tile.position().x&&p.tile.position().y===r.tile.position().y){f=!0;break}p=p.previous}return f},l=[],h=r=>{if(r.tile.position().x===s.position().x&&r.tile.position().y===s.position().y){l.push(r);return}if(r.g>i||r.g>d)return;const f=e.getNeighbors(r.tile),p=r.tile.position();for(const u of f){if(!u.traversable()&&s.traversable())continue;const g=u.position(),y=Math.abs(g.x-p.x),v=Math.abs(g.y-p.y),M=y===1&&v===1?2:1,I=r.g+M;if(I>i)continue;const E={previous:r,tile:u,g:I};c(E)||h(E)}};if(h(a),l.length>0){const r=l.reduce((p,u)=>p.g<u.g?p:u),f=Gn(r);if(f.length>0)return f.shift(),f}return[]}const Yn={"bed-time":["follow"],patrol:["bed-time","follow","work"],follow:["attack"],work:["bed-time","patrol","follow"],idle:["bed-time","patrol","follow","work"],attack:["bed-time","patrol","follow","work"],spawn:["bed-time","patrol","follow","work","attack"]},Qn=n=>{const{events:t,playerVM:e,tileMapVM:i,npcTaskController:o,npcs:s,turnVM:d}=n,a=5,c=[],l=(m,x)=>{var b;const w=[];for(let k=m.x-x;k<=m.x+x;k++)for(let A=m.y-x;A<=m.y+x;A++){const L=(b=i.tiles()[k])==null?void 0:b[A];!L||Math.floor(Math.sqrt(Math.pow(L.position().x-m.x,2)+Math.pow(L.position().y-m.y,2)))>x||L.traversable()&&w.push(L.position())}return w},h=(m,x)=>{let b=5,k=null;for(;k===null||k.length===0;)if(k=Gt({start:m,end:x,map:i,maxDistance:b}),b++,b>9)return null;return k},r=m=>{const x=m.position();let w=null;const b=[];for(const k of t){const A=k.position(),L=Math.floor(Math.sqrt(Math.pow(A.x-x.x,2)+Math.pow(A.y-x.y,2)));b.push({event:k,distance:L})}b.sort((k,A)=>k.distance-A.distance);for(let k=0;k<Math.min(3,b.length);k++){const A=b[k].event,L=h(x,A.position());if(L&&L.length>0){w=A;break}}return w||null},f=m=>{m.isAlive()&&(m.setTaskList([o.createSpawnTask(m)]),m.setCanTrade(!1),c.push(m),m.getPatrolArea().length===0&&(m.setPatrolArea(l(m.position(),a)),m.setTaskList([...m.getTaskList(),o.createPatrolTask(m)])))},p=m=>{m.isAlive()&&!m.isHostile(e.team())&&(m.setTaskList([o.createWorkTask(m)]),m.setCanTrade(!0),c.push(m))},u=m=>{if(!m.isAlive()){m.setTask(null);return}if(m.isHostile(e.team())&&m.getPatrolArea().length===0&&(m.setPatrolArea(l(m.position(),a)),m.setTaskList([...m.getTaskList(),o.createPatrolTask(m)])),m.getBedLocation()===null){const x=r(m);x&&m.setBedLocation(x.position())}c.push(m)},g=(m,x)=>{const w=m.getTask();if(!w)return!0;const b=w.name();return(Yn[b]||[]).includes(x)},y=m=>{if(!m.spawnLing())return!1;const x=4;if(m.lastSpawned()===0)return m.setLastSpawned(d.getCurrentTurn()),!1;const w=d.getCurrentTurn()-m.lastSpawned()>=x;if(!w)return!1;if(w){const b=o.createSpawnTask(m);if(b)return m.setTask(b),m.setLastSpawned(d.getCurrentTurn()),!0}return!1},v=m=>{if(!m.isHostile(e.team()))return!1;if(e.isAlive()&&e.position()){const b=Math.floor(Math.sqrt(Math.pow(e.position().x-m.position().x,2)+Math.pow(e.position().y-m.position().y,2)));if(b<=1)return!1;if(b<=4&&g(m,"follow")){const k=m.getTaskList().find(A=>A.name()==="follow")||o.createFollowPlayerTask(m);if(k)return m.setTarget(e),m.setTask(k),!0}}return!1},M=m=>{const x=m.getTask(),w=n.turnVM.getCurrentTimeMin();if(w>=1200||w<480){if(x&&x.name()==="bed-time")return!0;if(g(m,"bed-time")){const b=m.getTaskList().find(k=>k.name()==="bed-time")||o.createBedTimeTask(m);if(b)return m.setTask(b),!0}}return!1},I=m=>{const x=m.getTask();if(n.turnVM.getCurrentTimeMin()>=480){if(x&&x.name()==="patrol")return!0;if(g(m,"patrol")){const b=m.getTaskList().find(k=>k.name()==="patrol");if(b)return m.setTask(b),!0}}return!1},E=m=>{var k;const x=m.getTarget(),w=1;if(!x||!x.isAlive())return m.setTarget(null),!1;if(Math.floor(Math.sqrt(Math.pow(x.position().x-m.position().x,2)+Math.pow(x.position().y-m.position().y,2)))>w)return!1;if(((k=m.getTask())==null?void 0:k.name())==="attack")return!0;if(g(m,"attack")){const A=m.getTaskList().find(L=>L.name()==="attack")||o.createAttackTask(m);if(A)return m.setTask(A),!0}return!1},_=m=>{var x;if(((x=m.getTask())==null?void 0:x.name())==="work")return!0;if(g(m,"work")){const w=m.getTaskList().find(b=>b.name()==="work");if(w)return m.setTask(w),!0}return!1},B=m=>{if(!m.isAlive()){m.setTask(null);return}y(m)||E(m)||v(m)||M(m)||I(m)||_(m)},S=()=>{c.forEach(m=>{if(!m.isAlive())return;B(m);const x=m.getTask();x&&x.name(),x&&x.execute()})};return(()=>{s.forEach(m=>{u(m)})})(),{addNpc:u,addTrader:p,addNestmother:f,playNpcTurn:S}},Xn=({npc:n,attackVM:t})=>({execute:()=>{if(!n.isAlive())return!1;const e=n.getTarget();return!e||!e.isAlive()?(n.setTask(null),!0):Math.floor(Math.sqrt(Math.pow(n.position().x-e.position().x,2)+Math.pow(n.position().y-e.position().y,2)))<=1?(t.attack(n,e),!0):!1},name:()=>"attack"}),jn=({npc:n,tileMapVM:t,turnVM:e})=>{let i=n.getBedLocation(),o=null;return{execute:()=>{if(n.isAlive()===!1)return!1;if(e.getCurrentTimeMin()>=480&&e.getCurrentTimeMin()<1200)return n.setTask(null),!0;if(!i&&(i=n.getBedLocation(),!i))return!1;if(n.position().x===i.x&&n.position().y===i.y)return!0;if(!o){let d=5;for(;o===null||o.length===0;)if(o=Gt({start:n.position(),end:i,map:t,maxDistance:d}),d++,d>8)return!1}if(o&&o.length>0){const s=o.shift();return s&&(n.moveTo(s.position().x,s.position().y),s.position().x===i.x&&s.position().y===i.y),!0}return!1},name:()=>"bed-time"}},Zn=({npc:n,tileMapVM:t,playerVM:e})=>({execute:()=>{if(n.isAlive()===!1)return!1;const i=e.position(),o=Gt({start:n.position(),end:i,map:t});if(o&&o.length>0){const s=o.shift();if(s)return s.position().x===i.x&&s.position().y===i.y||n.moveTo(s.position().x,s.position().y),!0}return!1},name:()=>"follow"}),Kn=({npc:n,tileMapVM:t})=>{let e=n.getPatrolArea(),i=null;return{execute:()=>{if(n.isAlive()===!1||e.length===0||((!i||i.length===0)&&(i=Gt({start:n.position(),end:e[Math.floor(Math.random()*e.length)],map:t})),!i||i.length===0))return!1;const o=i.shift();return o&&n.moveTo(o.position().x,o.position().y),!0},name:()=>"patrol"}},Jn=({npc:n})=>({execute:()=>n.isAlive()===!1?!1:(n.setCanTrade(!0),!0),name:()=>"work"}),to=({npc:n,addNpc:t,spawnType:e="worm"})=>({execute:()=>{if(!n.isAlive())return!1;const i=n.position(),o=qe({id:e,team:"hostile-to-player",name:"Spawned "+e.charAt(0).toUpperCase()+e.slice(1),startingSize:1,startPosition:i,startingHealth:1,startingMaxHealth:1,startingItems:[]}),s=ei(o);return t(s),!0},name:()=>"spawn"}),eo=n=>{const{attackVM:t,tileMapVM:e,turnVM:i,playerVM:o}=n;return{createBedTimeTask:r=>jn({npc:r,tileMapVM:e,turnVM:i}),createPatrolTask:r=>Kn({npc:r,tileMapVM:e}),createFollowPlayerTask:r=>Zn({npc:r,tileMapVM:e,playerVM:o}),createAttackTask:r=>Xn({npc:r,attackVM:t}),createWorkTask:r=>Jn({npc:r}),createSpawnTask:r=>to({npc:r,spawnType:"worm",addNpc:n.addNpc})}},Qt=(n,t)=>n.id()===t.id(),io=()=>({use:(n,t)=>{if(n.health()!==0){if(t.health()>=t.maxHealth())return;if(t.id()==="player"){const e=Math.min(n.health(),t.maxHealth()-t.health());ft().log.totalHealing+=e}t.setHealth(t.health()+n.health()),t.inventory().removeItem(n),n.updateQuantity(0);return}n.type()==="weapon"&&(Qt(t.weapon(),n)?t.setWeapon(void 0):t.setWeapon(n)),n.type()==="armour"&&(Qt(t.bodyArmour(),n)?t.setBodyArmour(void 0):t.setBodyArmour(n)),n.type()==="helmet"&&(Qt(t.headArmour(),n)?t.setHeadArmour(void 0):t.setHeadArmour(n)),n.type()==="shoes"&&(Qt(t.feetArmour(),n)?t.setFeetArmour(void 0):t.setFeetArmour(n))}}),no=()=>{let n=null,t=null;const e=222,[i,o]=F(!1),[s,d]=F(!0),[a,c]=F(!1),[l,h]=F(!1),[r]=F(zt({model:It("coin")})),f=_t({model:Xt([]),ownerName:"trade"}),p=_t({model:Xt([]),ownerName:"trade-npc"}),u=(C,O)=>{n=C,t=O,v(T()),v(S())},g=C=>{w().addItem(C,1),f.removeItem(C,1)},y=C=>{b().addItem(C,1),p.removeItem(C,1)},v=C=>{let O;C===f?O=g:O=y,C.items().forEach(z=>{O(z,!0),C.removeItem(z,1)})},M=C=>{const O=w().getItem(C);O&&(f.addItem(O,1),w().removeItem(O,1))},I=C=>{const O=b().getItem(C);O&&(p.addItem(O,1),b().removeItem(O,1))},E=()=>{v(T()),v(S()),r().updateQuantity(0)},_=(C=!1)=>{if(!n||!t)throw new Error("Player or NPC inventory is not set");return!a()&&!l()&&m()!==0?(c(!0),!1):r().quantity()<0?!1:((a()&&!l()||l()&&!a()||m()===0)&&C&&B(),a()&&c(!1),!0)},B=()=>{if(i()){const C=Math.floor(r().quantity());Array(C).fill(0).forEach(()=>{const O=zt({model:It("coin")});S().addItem(O)}),C>0&&J.play("audio/sfx/sfx-sell.mp3")}f.items().forEach(C=>{b().addItem(C,C.quantity()),f.removeItem(C,C.quantity())}),p.items().forEach(C=>{ft().log.tradedItemsValue+=x(C,!0),w().addItem(C,C.quantity()),p.removeItem(C,C.quantity())}),v(T()),v(S()),i()&&o(!1)},S=()=>(r().updateQuantity(m()),p),T=()=>(r().updateQuantity(m()),f),m=()=>{const C=f.stacks().reduce((z,W)=>z+x(W.item,!1)*W.quantity,0),O=p.stacks().reduce((z,W)=>z+Math.max(1,x(W.item,!0)*W.quantity),0);return Math.floor(C)-Math.ceil(O)},x=(C,O)=>{const z=C.value()*C.quantity(),X=O&&!["coin","torch"].includes(C.code())?2:1;return z*X},w=()=>{if(n)return n;throw new Error("Player inventory is not set")},b=()=>{if(t)return t;throw new Error("NPC inventory is not set")},k=async()=>{await A(!1),await j.delayedCall(.2,()=>{}),o(!1)},A=async(C=!0)=>{if(!n||!t)throw new Error("Invalid inventories to auto trade");o(!0);const O=n.stacks().reduce((z,W)=>(W.quantity>0&&W.item.type()==="loot"&&z.push(W),z),[]);for(const z of O){await j.delayedCall(e/1e3,()=>{});for(let W=0;W<z.quantity;W++)C?J.play("audio/sfx/sfx-sell.mp3",{category:"gameplay"}):J.play("audio/sfx/collect.wav",{category:"gameplay"}),M(z.item)}};return{isConfirmationModalVisible:a,startTrade:u,cancelTrade:E,acceptTrade:_,playerTradeItems:T,acceptBulkTrade:()=>{l()&&(_(!0),h(!1))},value:r,npcTradeItems:S,playerInventory:w,npcInventory:b,selectItemToBuy:I,selectItemToSell:M,returnItemToPlayer:g,returnItemToNpc:y,clearTrade:()=>{if(a()){c(!1);return}v(T()),v(S()),c(!1),r().updateQuantity(0)},getItemPrice:x,bulkTrade:async()=>{h(!0),await j.delayedCall(.5,()=>{}),d(!1),await A(),await j.delayedCall(.5,()=>{}),d(!0)},autoTrade:k,isAutoTrading:i,isContinueButtonVisible:s}},oo=n=>{if(n.length===0)return{x:0,y:0};const t=n.reduce((s,d)=>s+d.x,0),e=n.reduce((s,d)=>s+d.y,0),i=t/n.length,o=e/n.length;return{x:i,y:o}},ze=(n,t)=>Math.abs(n.x-t.x)<=1&&Math.abs(n.y-t.y)<=1,so=n=>{let t="idle",e="idle";return{get:()=>t,set:d=>{t!==d&&(e=t,d==="end-turn"?(n(),t="idle"):t=d)},getPrevState:()=>e}},ro=n=>{const{tileMapViewModel:t,playerViewModel:e,userInterfaceView:i,gameView:o,playerUiVM:s,attackVM:d}=n;let a=null,c=null;const l=so(n.onPlayerTurnCompleted),h=io(),r=1,f=()=>e.isAlive()&&l.get()!=="busy",p=w=>{const{action:b,trader:k}=w;if(!(k&&!k.canTrade())&&f()){if(l.set("trading"),k&&!c)if(c=no(),c.startTrade(e.inventory(),k.inventory()),b==="autoTrade"){c.bulkTrade(),i.showBulkTrade(c);return}else{i.showTrade(c);return}if(c){if(b==="autoTrade"&&c.autoTrade(),b==="clear"){c.clearTrade();return}if(b==="confirm-bulk-trade"){c.acceptBulkTrade();return}b==="submit"&&c.acceptTrade(!0)}}},u=w=>{var b;if(a){a.ownerName()===e.name()&&B();return}if(!c&&f()){if(w.isEmpty()){l.set("idle"),a=null;return}if(w.isOnlyLoot()&&w.ownerName()!==e.name()){i.update(),v(w);return}l.set("inventory-handling"),a=w,i.showInventory(w),(b=s())==null||b.isInventoryValueVisible(!0)}},g=w=>{var b;l.set("busy"),(b=s())==null||b.showInGameMenu(w==="open"),w!=="open"&&l.set(l.getPrevState()||"idle")},y=(w,b)=>{f()&&(l.set("inventory-handling"),b==="open"?u(w):B())},v=w=>{w.items().forEach(b=>{var k;e.inventory().addItem(b),w.removeItem(b),(k=o())==null||k.animateIconFloat(b.code(),e.position())}),J.play("audio/sfx/inventory-open.wav",{category:"gameplay",volume:1}),a=null,l.set("end-turn")},M=w=>{var D,P;const{settlement:b,action:k}=w,A=b.positions(),L=oo(A);if(f()){if(k==="unlock"){const C=e.inventory().getItemByCode("city-key");if(!C)throw new Error("City key is required to unlock the settlement");b.setIsUnlocked(!0),e.inventory().removeItem(C),(D=o())==null||D.createTextBox({id:()=>"settlement",dialogue:()=>"Welcome!",position:()=>({x:L.x,y:L.y})});return}if(k==="trade"&&b.isUnlocked()){p({action:"trade",trader:{canTrade:()=>!b.inventory().isEmpty(),inventory:()=>b.inventory()}});return}(P=o())==null||P.createTextBox({id:()=>"settlement",dialogue:()=>"City key required",position:()=>({x:L.x,y:L.y})})}},I=()=>{c&&(c.cancelTrade(),i.closeAll(),c=null),l.set("idle")},E=w=>{const{action:b,character:k}=w;if(!f()||!k)return;if(b==="talk"){const P=o();if(!P)return;P.createTextBox(k),l.set("idle");return}const A=Math.floor(Math.sqrt(Math.pow(k.position().x-e.position().x,2)+Math.pow(k.position().y-e.position().y,2))),L=A<=r,D=A<=e.weapon().range();if(k.isHostile(e.team())&&D&&k.health()>0){d.attack(e,k),l.set("end-turn");return}if(!L){S(k.position());return}if(!k.inventory().isEmpty()){if(k.canTrade()){p({action:"change-to-buy",trader:k});return}u(k.inventory());return}if(k.inventory().isEmpty()){S(k.position());return}u(k.inventory())},_=(w,b)=>{if(l.get()==="idle"&&f()){if(ze(w.position(),e.position())&&(!w.discovered()||!w.inventory().isEmpty())){u(w.inventory()),w.interact(b);return}S(w.position())}},B=()=>{var w,b;if(a){if(a.ownerName()===e.name()){a=null,l.set("idle"),(w=s())==null||w.isInventoryValueVisible(!1),i.hideInventory();return}a=null,l.set("end-turn"),(b=s())==null||b.isInventoryValueVisible(!1),i.hideInventory();return}c&&I(),l.set("idle")},S=({x:w,y:b})=>{if(l.get()!=="idle"||!f())return;const k=e.position();if(ze({x:w,y:b},k)&&t.isValidMove(w,b)){T(w-k.x,b-k.y);return}const A=Gt({start:k,end:{x:w,y:b},map:t});if(A&&A.length>1){const L=A[0];T(L.position().x-k.x,L.position().y-k.y)}},T=(w,b)=>{if(l.set("moving"),!f())return;const k=e.position().x+w,A=e.position().y+b;t.isValidMove(k,A)&&e.moveTo(k,A),l.set("end-turn")};return{handlePlayerMoveRequest:S,handleTileInteraction:w=>{l.get()==="idle"&&f()&&S(w.position())},handleCharacterInteraction:E,handleEventInteraction:_,handleItemInteraction:(w,b)=>{var k;if(f()){if(l.get()==="trading"){if(b==="sell"){c==null||c.selectItemToSell(w);return}if(b==="buy-return"){c==null||c.returnItemToNpc(w);return}if(b==="sell-return"){c==null||c.returnItemToPlayer(w);return}if(b==="buy"){c==null||c.selectItemToBuy(w);return}}if(a&&a.ownerName()!==e.name()){e.inventory().addItem(w),a.removeItem(w),(k=o())==null||k.animateIconFloat(w.code(),e.position());return}h.use(w,e)}},handleCloseInventoryRequest:B,handleTradeRequest:p,handleTradeCancel:I,handleSettlementInteraction:M,handleInventoryRequest:y,handleInGameMenuRequest:g}},ao=n=>{const{turnVM:t,handleEndUpTurnUpdates:e,playerVM:i,enemyVMs:o,npcController:s}=n;let d=0;const a=()=>{var f;const r=ft().log;r.turns+=1,r.npcsKilled=o.filter(p=>!p.isAlive()).length,r.npcsAlive=o.filter(p=>p.isAlive()).length,r.mostUsedWeapon=((f=i.inventory().items().filter(p=>p.type()==="weapon").sort((p,u)=>u.uses()-p.uses())[0])==null?void 0:f.name())||"fists"},c=async()=>{h(),await e(),t.nextTurn(),l(),a()},l=async()=>{if(d+=1,d%10===0){const r=i.inventory().getItemByCode("torch");r&&i.inventory().removeItem(r)}},h=()=>{s.playNpcTurn()};return{handlePlayerTurnEnded:c,playNpcTurn:h}},lo=()=>{const[n,t]=F(void 0);return{attack:async(e,i)=>{const o=e.weapon().range()>2,s=e.weapon().range()<=2,a=e.position().distanceTo(i.position())>1,l=e.weapon().damage();s||a&&o?i.takeDamage(l):!a&&o&&i.takeDamage(Math.min(1,Math.floor(l/2))),t({source:e,target:i,type:o&&a?"ranged":"melee"});const h=ft().log;e.id()==="player"&&(h.totalDamageDealt+=l,e.weapon().setUses(e.weapon().uses()+1),s||a&&o?s?ft().log.meleeAttacks+=1:ft().log.rangedAttacks+=1:!a&&o&&(ft().log.meleeAttacks+=1))},isAttacking:()=>n(),clearAttack:()=>{t(void 0)}}},co=n=>{const{tileMapVM:t}=n,[e,i]=F(!1),[o,s]=F({x:0,y:0}),[d,a]=F([]);return{isVisible:e,setVisible:i,updateDiscoveredTiles:l=>{const h=t.tiles(),r=5,f=Math.max(0,l.x-r),p=Math.max(0,l.y-r),u=Math.min(h.length-1,l.x+r),g=Math.min(h[0].length-1,l.y+r);for(let y=f;y<=u;y++)for(let v=p;v<=g;v++){const M=h[y][v];M&&M.handleTileDiscovered()}},tiles:()=>t.tiles(),npcPositions:d,setNpcPositions:a,playerPosition:o,setPlayerPosition:s}};j.registerPlugin(he);he.registerPIXI(hi);const ho=n=>n<=3?1:n<=6?2:n<=10?3:n<=15?4:5,uo=({view:n,saveController:t,onGameLoadRequest:e,onLevelCompleted:i,onGameOver:o})=>{const[d,a]=F(de({model:$e({id:"dontUse",team:"player",name:"Player",startPosition:{x:0,y:0},startingHealth:10,startingMaxHealth:10,startingItems:[]})}));let c=null,l=null,h=null,r=null,f=null,p=null,u=null,g=null,y=null,v=null,M=null,I=[],E=[],_=null,B=[],S=1,T=null,m=null,x=null,w=!1,b=!1,k={x:0,y:0},A=null;const L=()=>{if(!T)throw new Error("Level models are not initialized");return T},D=N=>{T=N;const V=Hi(N);M=V.tileMapVM,a(V.playerVM),I=V.npcVMs,E=V.eventVMs,B=V.settlementVMs;const $=lo();f=Gi({playerVM:d()}),p=N.fogOfWarViewModel,c=Fi({playerVM:d(),npcVMs:I,settlementVMs:B,eventViewModels:E}),A=co({tileMapVM:M}),u=$n({playerMenuVM:()=>c,playerUiVM:()=>f,miniMapVM:A}),g=Ui({model:Vi()}),r=eo({tileMapVM:M,playerVM:d(),turnVM:g,attackVM:$,addNpc:K=>{m==null||m.addNpc(K),h==null||h.addNpc(K)}}),h=Qn({playerVM:d(),npcs:I,tileMapVM:M,events:E,npcTaskController:r,turnVM:g}),y=ao({turnVM:g,playerVM:d(),enemyVMs:I,npcController:h,handleEndUpTurnUpdates:async()=>{await(m==null?void 0:m.handleEndOfTurnUpdates()),A==null||A.setPlayerPosition(d().position()),A==null||A.updateDiscoveredTiles(d().position());const K=I.reduce((mt,ht)=>(ht.isAlive()&&ht.visible()&&mt.push(ht.position()),mt),[]);A==null||A.setNpcPositions(K),d().isAlive()&&((g==null?void 0:g.getCurrentTurn())??0)%5===0&&it(!0)}});const Y=()=>{d().inventory().getItemByCode("torch")?p==null||p.setToFullLight():p==null||p.setToLowLight()};l=ro({attackVM:$,tileMapViewModel:M,playerViewModel:d(),userInterfaceView:u,playerUiVM:()=>f,onPlayerTurnCompleted:()=>{y==null||y.handlePlayerTurnEnded(),Y()},gameView:()=>m}),m=on({tileSize:64,playerVM:d(),tileMapVM:M,npcVMs:I,eventVMs:E,settlementVMs:B,attackVM:$}),v=Qi({gameViews:{gameView:m.view,nonSkewedView:m.nonSkewedContainer},userInterfaceView:u.view,fogOfWarVM:p}),_=Fn({playerVM:d(),tileMapVM:M})},P=()=>{console.debug("Unloading level..."),x==null||x.destroy(),v==null||v.destroy(),c=null,l=null,h=null,r=null,f=null,p=null,n.detachAll(),u==null||u.destroy(),u=null,g=null,y=null,v=null,M=null,I=[],E=[],_==null||_.destroy(),_=null,B=[],T=null,m==null||m.destroy()},C=()=>{const N=I.filter(Y=>Y.isAlive()),V=I.length-N.length,$=d().position();$&&(S>=ho(V)||(S++,N.forEach(Y=>{Y.position().distanceTo($)<5||Y.setMaxHealth(Y.maxHealth()+2)})))},O=()=>{const N=d().position(),V=5;N&&(M==null||M.tiles().forEach($=>{$.forEach(Y=>{Y.setVisible(Math.abs(Y.position().x-N.x)<=V&&Math.abs(Y.position().y-N.y)<=V)})}),E.forEach($=>{$.setVisible(Math.abs($.position().x-N.x)<=V&&Math.abs($.position().y-N.y)<=V)}),I.forEach($=>{$.setVisible(Math.abs($.position().x-N.x)<=V&&Math.abs($.position().y-N.y)<=V)}),B.forEach($=>{$.setIsVisible(Math.abs($.positions()[0].x-N.x)<=V&&Math.abs($.positions()[0].y-N.y)<=V)}))},z=async()=>{if(!w&&!b){w=!0,l==null||l.handleTradeRequest({action:"autoTrade",trader:{canTrade:()=>!0,inventory:()=>_t({model:Xt([]),ownerName:"Bulk Trader"})}});return}if(w=!1,!b){b=!0,u==null||u.showEndOfLevelLog();return}i(T),await W()},W=async()=>{!v||!u||(J.disableCategory("gameplay"),u.view.visible=!1,await j.to(v.view,{duration:5,alpha:0}),v.view.visible=!1,it(),P())},X=()=>{x=Ri({handleInfoModalOpenRequest:N=>{u==null||u.showInfoModal(N)},handleInfoModalCloseRequest:()=>{u==null||u.hideInfoModal()},handleLevelCompleted:z,handleTileInteraction:N=>{l==null||l.handleTileInteraction(N)},handleItemInteraction:(N,V)=>{l==null||l.handleItemInteraction(N,V)},handleEventInteraction:N=>{l==null||l.handleEventInteraction(N,d())},handleCharacterInteraction:N=>{l==null||l.handleCharacterInteraction({character:N,action:"interact"})},onCloseInventoryRequested:()=>{l==null||l.handleCloseInventoryRequest(),w&&z()},handleInventoryRequest:(N,V)=>{l==null||l.handleInventoryRequest(N,V)},handleTradeRequest:N=>{l==null||l.handleTradeRequest({action:N})},handleCharacterInteractionRequest:({character:N,action:V})=>{l==null||l.handleCharacterInteraction({action:V,character:N})},handleSettlementInteractionRequest:({settlement:N,action:V})=>{l==null||l.handleSettlementInteraction({settlement:N,action:V})},handleInGameMenuRequest:N=>{l==null||l.handleInGameMenuRequest(N)},onDebugActionRequested:N=>{_==null||_.handleDebugActionRequest(N)},handleSaveRequest:it,handleLoadRequest:at})},it=(N=!1)=>{console.debug(N?"Autosaving...":"Saving game state...");const V=L(),$={...V,tileModels:V.tileMapModel.tiles().map(Y=>Y.map(K=>K))};t.save($,N),f==null||f.setIsSaveCompleted(!0)},at=()=>{console.debug("Loading game state..."),e();const N=t.load();if(!N){console.warn("No saved game state found.");return}R.emit("ON_PAUSE_INPUT"),P(),pt(N)},pt=N=>{console.debug("Loading level..."),D(N??Ye()),X(),u==null||u.showPlayerMenu(),u==null||u.showPlayerUi(),!(!v||!u)&&(v.view.visible=!1,u.view.visible=!1,n.attachCamera(v),n.attachUi(u),n.resize(innerWidth,innerHeight))},gt=()=>{if(!v||!u)return;J.enableCategory("gameplay"),J.stopMusic({fadeOut:!0}),O(),v.view.visible=!0,u.view.visible=!0,n.resize(innerWidth,innerHeight),v&&v.moveTo(d().position().x*64,d().position().y*64),A==null||A.setPlayerPosition(d().position()),A==null||A.updateDiscoveredTiles(d().position());const N=I.reduce((V,$)=>($.isAlive()&&$.visible()&&V.push($.position()),V),[]);A==null||A.setNpcPositions(N)},nt=N=>{u==null||u.update()};return lt(()=>{rt(()=>{(d().position().x!==k.x||d().position().y!==k.y)&&(O(),C(),k={x:d().position().x,y:d().position().y},v&&v.moveTo(d().position().x*64,d().position().y*64)),d().isAlive()||(console.debug("Player is dead, handling game over..."),j.delayedCall(1,()=>{o(),P()}))})}),{loadLevel:pt,showGameView:gt,update:nt,getState:L}},Io=n=>{const{mainMenuVM:t,view:e,loadingScreenVM:i,saveController:o}=n,s=()=>{i.showLevelLoadScreen(),i.setVisible(!0),setTimeout(()=>{i.setVisible(!1),u.showGameView(),R.emit("ON_RESUME_INPUT")},2e3)},d=()=>{console.debug("Resetting game progress..."),o.clear(),ft().reset()},a=g=>{console.debug("Preparing next level...");const y=Ye();g.playerModel.moveTo(y.playerModel.position().x,y.playerModel.position().y),y.playerModel=g.playerModel;const v=y.playerModel.inventory().items().filter(E=>E.code()==="torch").length,M=Math.max(0,30-v);se("torch",M).forEach(E=>y.playerModel.inventory().addItem(E));const I=Math.abs(Math.max(-5,y.playerModel.health()-y.playerModel.maxHealth()));return y.playerModel.setHealth(y.playerModel.health()+I),y},c=async g=>{i.showRestScreen(),i.setVisible(!0),await j.delayedCall(8,()=>{u.loadLevel(a(g))}),await j.delayedCall(2,()=>{i.setVisible(!1),u.showGameView()})},l=(g=!1,y=!1)=>{const v=o.load(y);g?i.showDebugScreen():v&&i.showLevelLoadScreen(),i.setVisible(!0),t.hide(),u.loadLevel(g?void 0:v);const M=lt(()=>{rt(()=>{i.isVisible()||(u.showGameView(),R.emit("ON_RESUME_INPUT"),M())})})},h=()=>{console.debug("Starting game..."),t.setIsContinueButtonVisible(o.saveExists()),t.setIsAutoSaveAvailable(o.autoSaveExists()),t.show()},r=()=>{console.debug("Exiting game...")},f=g=>{u.update(g)},u=uo({view:e,saveController:o,onGameLoadRequest:s,onLevelCompleted:c,onGameOver:()=>{console.debug("Game Over"),R.emit("ON_PAUSE_INPUT"),i.showGameOverScreen(),i.setVisible(!0);const g=lt(()=>{rt(()=>{i.isVisible()||(t.show(),g())})})}});return{loadLevel:l,initGame:h,exitGame:r,update:f,resetProgress:d}};export{Io as createGameController};
