import{c as at,g as j,S as tt}from"./sound-manager-Dsruj8Hw.js";import{g as kt,h as it,A as re,d as yt,i as ie,j as Ue,k as $e,e as ni,f as oi,m as de,G as gt,n as Yt}from"./npc-model-DgI3975p.js";import{R as Xt,E as si,G as K,i as ue,C as $,P as qe,S as q,T as Mt,f as ri,j as ai,k as ze,l as li}from"./index-B8UCbIaO.js";import{c as G,a as lt}from"./solid-lwVvZ318.js";import{c as jt,b as pt,a as Fe}from"./modal-view-BPeq2kky.js";const ci=(o,t,e)=>{if(o<=0)return;const i=[...t];i.sort((s,u)=>{const c=s.position().distanceTo(e.position()),l=u.position().distanceTo(e.position());return c-l});const n=Math.min(4,Math.floor(i.length/o));for(let s=0;s<o;s++){const u=kt("city-key"),c=Math.floor(Math.random()*100)<=33?0:Math.floor(Math.random()*100)<=66?1:2,l=Math.min(i.length-1,c+Math.floor((s+1)*n)),a=i[l];i.splice(c,1),a.inventory().addItem(u)}},hi=({map:o,rooms:t,pathEnemyChance:e=.2,paths:i})=>{const s=(a,h)=>a>0&&h>0&&a<o.length-1&&h<o[0].length-1,u=(a,h,r,f)=>Math.sqrt((a-r)**2+(h-f)**2),c=(a,h,r)=>r.every(f=>u(f.position().x,f.position().y,a,h)>=10),l=[];return t.forEach((a,h)=>{if(h===0)return;const r=Math.floor(Math.random()*2);for(let f=0;f<r;f++){const[p,d]=a[Math.floor(Math.random()*a.length)];if(s(p,d)&&c(p,d,l)){const g=o[p][d];g.hasEnemy()||(g.hasEnemy=()=>!0,l.push(g))}}}),i.forEach((a,h)=>{h!==0&&a.forEach(([r,f])=>{if(Math.random()<e&&s(r,f)&&c(r,f,l)){const p=o[r][f];p.hasEnemy()||(p.hasEnemy=()=>!0,l.push(p))}})}),l},di=({map:o,rooms:t,pathEventChance:e=.1,paths:i})=>{const s=[],u=(l,a)=>l>0&&a>0&&l<o.length-1&&a<o[0].length-1,c=(l,a,h,r)=>Math.sqrt((l-h)**2+(a-r)**2);return t.forEach(l=>{const a=l.length/2,h=Math.floor(Math.random()*a)+2;for(let r=0;r<h;r++){const[f,p]=l[Math.floor(Math.random()*l.length)];if(u(f,p)&&s.every(d=>c(d.position().x,d.position().y,f,p)>=3)){const d=o[f][p];!d.hasEvent()&&d.traversable()&&d.type()!=="settlement"&&(d.hasEvent=()=>!0,s.push(d))}}}),i.forEach(l=>{l.forEach(([a,h])=>{if(Math.random()<e&&u(a,h)){const r=o[a][h];!r.hasEvent()&&r.type()!=="settlement"&&r.traversable()&&s.every(f=>c(f.position().x,f.position().y,a,h)>=3)&&(r.hasEvent=()=>!0,s.push(r))}})}),s},fe=[it({id:"ancient-bunker",name:"Ancient Bunker",startPosition:{x:0,y:0},startingItems:[],level:3}),it({id:"bandit-camp",name:"Bandit Camp",startPosition:{x:0,y:0},startingItems:[],level:4}),it({id:"beacon",name:"Beacon",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"bear-cage",name:"Bear Cage",startPosition:{x:0,y:0},startingItems:[],level:4}),it({id:"bunker",name:"Bunker",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"campfire",name:"Campfire",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"cave",name:"Cave",startPosition:{x:0,y:0},startingItems:[],level:3}),it({id:"chest",name:"Chest",startPosition:{x:0,y:0},startingItems:[],level:1}),it({id:"church",name:"Church",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"crashed-plane",name:"Crashed Plane",startPosition:{x:0,y:0},startingItems:[],level:3}),it({id:"fungi",name:"Fungi",startPosition:{x:0,y:0},startingItems:[],level:1}),it({id:"tent",name:"Tent",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"lean-to",name:"Lean-To",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"ruin",name:"Ruin",startPosition:{x:0,y:0},startingItems:[],level:4}),it({id:"scary-tree",name:"Scary Tree",startPosition:{x:0,y:0},startingItems:[],level:1}),it({id:"silo",name:"Silo",startPosition:{x:0,y:0},startingItems:[],level:3}),it({id:"sword-in-stone",name:"Monument",startPosition:{x:0,y:0},startingItems:[],level:5}),it({id:"wagon",name:"Wagon",startPosition:{x:0,y:0},startingItems:[],level:1}),it({id:"wreck",name:"Wreck",startPosition:{x:0,y:0},startingItems:[],level:1})],ui=()=>{const o=Math.floor(Math.random()*fe.length);return fe[o]},fi=o=>{const t=Math.floor(Math.random()*o)+1,e=[];for(let i=0;i<t;i++){if(Math.random()<.5)continue;const n=pi();e.push(n)}if(e.length===0){const i=kt("coin");e.push(i)}return e},pi=()=>{let o=0;const t=[];return re.map(i=>{const n=new Array(i.randomDropWeight()).fill(i);t.push(...n),o+=i.randomDropWeight()}),kt(t[Math.floor(Math.random()*o)].code())},mi=o=>o.map(t=>{const e=ui();return it({id:e.id(),name:e.name(),startPosition:{x:t.position().x,y:t.position().y},level:e.level(),startingItems:fi(e.level())})}),gi=(o,t)=>{const e=(l,a)=>{const h=[],r=Math.abs(a.position.x-l.position.x),f=Math.abs(a.position.y-l.position.y),p=l.position.x<a.position.x?1:-1,d=l.position.y<a.position.y?1:-1;let g=r-f,y=l.position.x,v=l.position.y;for(;y!==a.position.x||v!==a.position.y;){h.push([y,v]);const E=g*2;E>-f&&(g-=f,y+=p),E<r&&(g+=r,v+=d)}return h},i=(l,a,h,r)=>{const f=l[l.length-1],[p,d]=f;for(const g of r){if(h.has(g.id))continue;if(Math.hypot(g.position.x-p,g.position.y-d)>3){const v=e({position:{x:p,y:d}},g);a.push(v),h.add(g.id);break}}},n=(l,a)=>{let h=null,r=1/0;for(const f of o){if(a.has(f.id))continue;const p=Math.hypot(f.position.x-l.position.x,f.position.y-l.position.y);p<r&&p<t&&(h=f,r=p)}return h},s=[],u=new Set;let c=o[0];for(u.add(c.id);u.size<o.length;){let l=n(c,u);if(!l){const a=Array.from(u).map(h=>o.find(r=>r.id===h));for(;a.length>0;){const h=a.pop();if(l=n(h,u),l){c=h;break}}l||(l=o.find(h=>!u.has(h.id))||null)}if(l){const a=e(c,l);s.push(a),u.add(l.id),c=l,a.length>7&&i(a,s,u,o)}else break}return s},yi=(o,t,e,i={min:2,max:4})=>{const n=o.length,s=o[0].length,u=[],c=(h,r)=>h>=0&&r>=0&&h<n&&r<s,l=(h,r,f)=>f.every(([p,d])=>{const g=h+p,y=r+d;if(!c(g,y))return!1;for(let v=-1;v<=1;v++)for(let E=-1;E<=1;E++){const C=g+v,A=y+E;if(c(C,A)&&o[C][A].type()!=="void")return!1}return!0}),a=h=>{const r=[];switch(Math.floor(Math.random()*4)){case 0:for(let g=-h;g<=h;g++)for(let y=-h;y<=h;y++)g*g+y*y<=h*h&&r.push([g,y]);break;case 1:for(let g=-h;g<=h+2;g++)for(let y=-h;y<=h;y++)(g*g+y*y<=h*h||Math.abs(g)<h&&Math.abs(y)<h)&&r.push([g,y]);break;case 2:for(let g=-h;g<=h;g++)for(let y=-h;y<=h;y++)(g*g+y*y<=h*h&&Math.random()>.5||Math.abs(g)<h&&Math.abs(y)<h&&Math.random()>.5)&&r.push([g,y]);break;case 3:const p=h*2,d=Math.floor(h/2);for(let g=-p;g<=p;g++)for(let y=-d;y<=d;y++)r.push([g,y]);break}return r};return t.forEach(h=>{const r=Math.floor(Math.random()*(i.max-i.min+1)+i.min),f=a(r),p=[];l(h.position.x,h.position.y,f)&&f.forEach(([d,g])=>{const y=h.position.x+d,v=h.position.y+g;c(y,v)&&(o[y][v]=yt({terrain:"wasteland",position:{x:y,y:v}}),p.push([y,v]))}),p.length>0&&u.push(p)}),e.forEach(h=>{h.forEach(([r,f])=>{for(let p=-Math.floor(Math.random()*2);p<=Math.floor(Math.random()*2);p++)for(let d=-Math.floor(Math.random()*2);d<=Math.floor(Math.random()*2);d++){const g=r+p,y=f+d;c(g,y)&&o[g][y].type()!=="wasteland"&&(o[g][y]=yt({terrain:"grass",position:{x:g,y}}))}})}),{map:o,rooms:u}},vi=(o,t)=>Math.sqrt(Math.pow(o.x-t.x,2)+Math.pow(o.y-t.y,2)),wi=o=>{const{horizontalTiles:t,verticalCells:e,nodeCount:i,minDistanceBetweenNodes:n,maxAttemptsToAssignNode:s}=o,u=[],c=Math.ceil(Math.sqrt(i)),l=Math.floor(t/c),a=Math.floor(e/c),h=(r,f)=>u.every(p=>Math.abs(vi(p.position,{x:r,y:f}))>=n);for(let r=0;r<i;r++){let f=0,p=!1;for(;f<s&&!p;){const d=Math.floor(r%c)*l,g=Math.floor(r/c)*a;let y=d+Math.floor(Math.random()*l),v=g+Math.floor(Math.random()*a);y=Math.max(3,Math.min(t-3,y)),v=Math.max(3,Math.min(e-3,v)),y<t&&v<e&&h(y,v)?(u.push({id:`node-${r}`,position:{x:y,y:v}}),p=!0):f++}p||u.pop()&&r--}return u},xi=o=>{const{startPosition:t}=o,e=[...ie("torch",30),...ie("coin",3)],i=[],n=[...e,...i];return Ue({name:"Hero",id:"player",startPosition:t,startingItems:n,team:"player"})},Ge=()=>{const o=wi({horizontalTiles:64,verticalCells:64,nodeCount:80,minDistanceBetweenNodes:7,maxAttemptsToAssignNode:100}),t=gi(o,15),e=C=>{const A=Math.floor(Math.random()*C)+1,M=[];for(let N=0;N<A;N++){if(Math.random()<.5)continue;const _=i(),b=M.find(m=>m.code()===_.code());if(b){b.code()==="coin"&&b.updateQuantity(b.quantity()+1);continue}M.push(_)}if(M.length===0){const N=kt("coin");M.push(N)}return M},i=()=>{let C=0;const A=[];return re.map(M=>{const N=new Array(M.randomDropWeight()).fill(M);A.push(...N),C+=M.randomDropWeight()}),A[Math.floor(Math.random()*C)]},{map:n,rooms:s}=yi(Array.from({length:64},(C,A)=>Array.from({length:64},(M,N)=>yt({terrain:"void",position:{x:A,y:N}}))),o,t,{min:2,max:4});(C=>{const A=C.flat().filter(b=>b.type()==="void"),M=Math.floor(30);let N=0,_=0;for(let b=0;b<M&&(b>0&&A.splice(_,1),!(N>1e4||(N++,A.length===0)));b++){_=Math.floor(Math.random()*A.length);const{x:m,y:T}=A[_].position(),w=new Xt(m,T,Math.floor(Math.random()*3)+1,Math.floor(Math.random()*3)+1);let x=!0;for(let k=-w.width;k<=w.width;k++){for(let B=-w.height;B<=w.height;B++){const S=m+k,L=T+B;if(!(S<0||L<0||S>=C.length||L>=C[0].length)&&C[S][L].type()!=="void"){x=!1;break}}if(!x)break}if(x)for(let k=-w.width;k<=w.width;k++)for(let B=-w.height;B<=w.height;B++){const S=m+k,L=T+B;S<0||L<0||S>=C.length||L>=C[0].length||(C[S][L]=yt({terrain:"water",position:{x:S,y:L}}))}}})(n);const l=hi({map:n,rooms:s,paths:t,pathEnemyChance:.2}).map(C=>$e({id:"bandit",name:"Bandit",team:"hostile-to-all",startPosition:{x:C.position().x,y:C.position().y},startingItems:e(Math.floor(Math.random()*3)+1),startingHealth:2})),a=C=>{C[0].map(A=>yt({terrain:"mountain",position:A.position()})),C[C.length-1].map(A=>yt({terrain:"mountain",position:A.position()})),C.forEach(A=>{yt({terrain:"mountain",position:A[0].position()}),yt({terrain:"mountain",position:A[A.length-1].position()})})},h=["settlement","large-settlement","sanctuary","citadel"],r=(C,A)=>{const{x:M,y:N}=C,_=[{x:M,y:N},{x:M+1,y:N},{x:M,y:N+1},{x:M+1,y:N+1}];return _.forEach(b=>{A[b.x]&&A[b.x][b.y]&&(A[b.x][b.y]=yt({terrain:"settlement",position:b}))}),de({id:h.shift()??"settlement",name:`Settlement at (${M}, ${N})`,level:1,positions:_})};function f(C,A){const M=[];return C.forEach((N,_)=>{const{x:b,y:m}=N.position,T=!0;if(_===0){M.push(r({x:b,y:m},A));return}b<A.length-1&&m<A[0].length-1&&T?M.push(r({x:b,y:m},A)):(A[b][m]=yt({terrain:"settlement",position:{x:b,y:m}}),M.push(de({id:h.shift()??"settlement",name:`Settlement ${_+1}`,level:1,positions:[{x:b,y:m}]})))}),M}const d=((C,A,M)=>{const N=[],_=new Set,b=m=>{const T=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],w=T[Math.floor(Math.random()*T.length)];return{x:m.position.x+w.x,y:m.position.y+w.y}};for(N.push({id:C[0].id,position:b(C[0])});N.length<A&&N.length<C.length&&_.size<C.length;){const m=Math.floor(Math.random()*C.length),T=C[m],w=`${T.position.x},${T.position.y}`;if(_.has(w))continue;let x=!0;for(const k of N)if(Math.sqrt(Math.pow(T.position.x-k.position.x,2)+Math.pow(T.position.y-k.position.y,2))<M){x=!1;break}x&&(N.push(T),_.add(w))}return N})(o,3,5),g=f(d,n);a(n);const y=di({map:n,rooms:s,paths:t,pathEventChance:.1}),v=mi(y),E=xi({startPosition:o[0].position});return ci(g.length,l,E),{playerModel:E,tileMapModel:oi(n),npcModels:l,eventModels:v,settlementModels:g,fogOfWarViewModel:ni()}};/*!
 * PixiPlugin 3.13.0
 * https://gsap.com
 *
 * @license Copyright 2008-2025, GreenSock. All rights reserved.
 * Subject to the terms at https://gsap.com/standard-license
 * @author: Jack Doyle, jack@greensock.com
*/var Ct,Zt,pe,mt,Ht,Qe,ne,Jt,Ye=function(){return typeof window<"u"},Xe=function(){return Ct||Ye()&&(Ct=window.gsap)&&Ct.registerPlugin&&Ct},oe=function(t){return typeof t=="function"},je=function(t){return console.warn(t)},bi=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],Tt=.212671,xt=.71516,wt=.072169,Ze=function(t){return oe(mt[t])?mt[t]:mt.filters[t]},te=function(t,e){var i=[],n=0,s=0,u,c;for(u=0;u<4;u++){for(c=0;c<5;c++)s=c===4?t[n+4]:0,i[n+c]=t[n]*e[c]+t[n+1]*e[c+5]+t[n+2]*e[c+10]+t[n+3]*e[c+15]+s;n+=5}return i},me=function(t,e){var i=1-e,n=i*Tt,s=i*xt,u=i*wt;return te([n+e,s,u,0,0,n,s+e,u,0,0,n,s,u+e,0,0,0,0,0,1,0],t)},ge=function(t,e,i){var n=Zt(e),s=n[0]/255,u=n[1]/255,c=n[2]/255,l=1-i;return te([l+i*s*Tt,i*s*xt,i*s*wt,0,0,i*u*Tt,l+i*u*xt,i*u*wt,0,0,i*c*Tt,i*c*xt,l+i*c*wt,0,0,0,0,0,1,0],t)},ye=function(t,e){e*=Math.PI/180;var i=Math.cos(e),n=Math.sin(e);return te([Tt+i*(1-Tt)+n*-.212671,xt+i*-.71516+n*-.71516,wt+i*-.072169+n*(1-wt),0,0,Tt+i*-.212671+n*.143,xt+i*(1-xt)+n*.14,wt+i*-.072169+n*-.283,0,0,Tt+i*-.212671+n*-.787329,xt+i*-.71516+n*xt,wt+i*(1-wt)+n*wt,0,0,0,0,0,1,0,0,0,0,0,1],t)},ve=function(t,e){return te([e,0,0,0,.5*(1-e),0,e,0,0,.5*(1-e),0,0,e,0,.5*(1-e),0,0,0,1,0],t)},Ke=function(t,e){var i=Ze(e),n=t.filters||[],s=n.length,u;for(i||je(e+" not found. PixiPlugin.registerPIXI(PIXI)");--s>-1;)if(n[s]instanceof i)return n[s];return u=new i,e==="BlurFilter"&&(Jt?u.strength=0:u.blur=0),t.filters=[].concat(n,[u]),u},ot=function(t,e,i,n){e.add(i,t,i[t],n[t]),e._props.push(t)},we=function(t,e){var i=Ze("ColorMatrixFilter"),n=new i;return n.matrix=e,n.brightness(t,!0),n.matrix},Ci=function(t){var e={},i;for(i in t)e[i]=t[i];return e},ut={contrast:1,saturation:1,colorizeAmount:0,colorize:"rgb(255,255,255)",hue:0,brightness:1},Ti=function(t,e,i){var n=Ke(t,"ColorMatrixFilter"),s=t._gsColorMatrixFilter=t._gsColorMatrixFilter||Ci(ut),u=e.combineCMF&&!("colorMatrixFilter"in e&&!e.colorMatrixFilter),c,l,a;for(a=n.matrix,e.resolution&&(n.resolution=e.resolution),e.matrix&&e.matrix.length===a.length?(l=e.matrix,s.contrast!==1&&ot("contrast",i,s,ut),s.hue&&ot("hue",i,s,ut),s.brightness!==1&&ot("brightness",i,s,ut),s.colorizeAmount&&(ot("colorize",i,s,ut),ot("colorizeAmount",i,s,ut)),s.saturation!==1&&ot("saturation",i,s,ut)):(l=bi.slice(),e.contrast!=null?(l=ve(l,+e.contrast),ot("contrast",i,s,e)):s.contrast!==1&&(u?l=ve(l,s.contrast):ot("contrast",i,s,ut)),e.hue!=null?(l=ye(l,+e.hue),ot("hue",i,s,e)):s.hue&&(u?l=ye(l,s.hue):ot("hue",i,s,ut)),e.brightness!=null?(l=we(+e.brightness,l),ot("brightness",i,s,e)):s.brightness!==1&&(u?l=we(s.brightness,l):ot("brightness",i,s,ut)),e.colorize!=null?(e.colorizeAmount="colorizeAmount"in e?+e.colorizeAmount:1,l=ge(l,e.colorize,e.colorizeAmount),ot("colorize",i,s,e),ot("colorizeAmount",i,s,e)):s.colorizeAmount&&(u?l=ge(l,s.colorize,s.colorizeAmount):(ot("colorize",i,s,ut),ot("colorizeAmount",i,s,ut))),e.saturation!=null?(l=me(l,+e.saturation),ot("saturation",i,s,e)):s.saturation!==1&&(u?l=me(l,s.saturation):ot("saturation",i,s,ut))),c=l.length;--c>-1;)l[c]!==a[c]&&i.add(a,c,a[c],l[c],"colorMatrixFilter");i._props.push("colorMatrixFilter")},ki=function(t,e){var i=e.t,n=e.p,s=e.color,u=e.set;u(i,n,s[0]<<16|s[1]<<8|s[2])},_i=function(t,e){var i=e.g;Jt?(i.fill(),i.stroke()):i&&(i.dirty++,i.clearDirty++)},Ii=function(t,e){e.t.visible=!!e.t.alpha},xe=function(t,e,i,n){var s=t[e],u=Zt(oe(s)?t[e.indexOf("set")||!oe(t["get"+e.substr(3)])?e:"get"+e.substr(3)]():s),c=Zt(i);n._pt=new Ht(n._pt,t,e,0,0,ki,{t,p:e,color:u,set:Qe(t,e)}),n.add(u,0,u[0],c[0]),n.add(u,1,u[1],c[1]),n.add(u,2,u[2],c[2])},Mi={tint:1,lineColor:1,fillColor:1,strokeColor:1},be="position,scale,skew,pivot,anchor,tilePosition,tileScale".split(","),se={x:"position",y:"position",tileX:"tilePosition",tileY:"tilePosition"},Ei={colorMatrixFilter:1,saturation:1,contrast:1,hue:1,colorize:1,colorizeAmount:1,brightness:1,combineCMF:1},Kt=Math.PI/180,Je=function(t){return typeof t=="string"},Si=function(t){return Je(t)&&t.charAt(1)==="="?t.substr(0,2)+parseFloat(t.substr(2))*Kt:t*Kt},Ai=function(t,e){return e.set(e.t,e.p,t===1?e.e:Math.round((e.s+e.c*t)*1e5)/1e5,e)},Pi=function(t,e,i,n,s,u){var c=360*(u?Kt:1),l=Je(s),a=l&&s.charAt(1)==="="?+(s.charAt(0)+"1"):0,h=parseFloat(a?s.substr(2):s)*(u?Kt:1),r=a?h*a:h-n,f=n+r,p,d;return l&&(p=s.split("_")[1],p==="short"&&(r%=c,r!==r%(c/2)&&(r+=r<0?c:-c)),p==="cw"&&r<0?r=(r+c*1e10)%c-~~(r/c)*c:p==="ccw"&&r>0&&(r=(r-c*1e10)%c-~~(r/c)*c)),t._pt=d=new Ht(t._pt,e,i,n,r,Ai),d.e=f,d},Ce=function(){if(!pe){Ct=Xe(),mt=pe=mt||Ye()&&window.PIXI;var t=mt&&mt.VERSION&&parseFloat(mt.VERSION.split(".")[0])||0;ne=t===4,Jt=t>=8,Zt=function(i){return Ct.utils.splitColor((i+"").substr(0,2)==="0x"?"#"+i.substr(2):i)}}},Gt,Et;for(Gt=0;Gt<be.length;Gt++)Et=be[Gt],se[Et+"X"]=Et,se[Et+"Y"]=Et;var ae={version:"3.13.0",name:"pixi",register:function(t,e,i){Ct=t,Ht=i,Qe=e.getSetter,Ce()},headless:!0,registerPIXI:function(t){mt=t},init:function(t,e,i,n,s){if(mt||Ce(),!mt)return je("PIXI was not found. PixiPlugin.registerPIXI(PIXI);"),!1;var u,c,l,a,h,r,f,p,d,g;for(r in e){if(u=se[r],l=e[r],u)c=~r.charAt(r.length-1).toLowerCase().indexOf("x")?"x":"y",this.add(t[u],c,t[u][c],u==="skew"?Si(l):l,0,0,0,0,0,1);else if(r==="scale"||r==="anchor"||r==="pivot"||r==="tileScale")this.add(t[r],"x",t[r].x,l),this.add(t[r],"y",t[r].y,l);else if(r==="rotation"||r==="angle")Pi(this,t,r,t[r],l,r==="rotation");else if(Ei[r])a||(Ti(t,e.colorMatrixFilter||e,this),a=!0);else if(r==="blur"||r==="blurX"||r==="blurY"||r==="blurPadding"){if(h=Ke(t,"BlurFilter"),this.add(h,r,h[r],l),e.blurPadding!==0)for(f=e.blurPadding||Math.max(h[r],l)*2,p=t.filters.length;--p>-1;)t.filters[p].padding=Math.max(t.filters[p].padding,f)}else if(Mi[r])if((r==="lineColor"||r==="fillColor"||r==="strokeColor")&&t instanceof mt.Graphics)for(d=("fillStyle"in t)?[t]:(t.geometry||t).graphicsData,g=r.substr(0,r.length-5),Jt&&g==="line"&&(g="stroke"),this._pt=new Ht(this._pt,t,r,0,0,_i,{g:t.geometry||t}),p=d.length;--p>-1;)xe(ne?d[p]:d[p][g+"Style"],ne?r:"color",l,this);else xe(t,r,l,this);else r==="autoAlpha"?(this._pt=new Ht(this._pt,t,"visible",0,0,Ii),this.add(t,"alpha",t.alpha,l),this._props.push("alpha","visible")):r!=="resolution"&&this.add(t,r,"get",l);this._props.push(r)}}};Xe()&&Ct.registerPlugin(ae);const O=new si,Ni=o=>{let t=!1;return O.on("ON_INFO_MODAL_OPEN",e=>{t&&o.handleInfoModalOpenRequest(e)}),O.on("ON_INFO_MODAL_CLOSE",()=>{o.handleInfoModalCloseRequest()}),O.on("ON_PAUSE_INPUT",()=>{t=!1}),O.on("ON_RESUME_INPUT",()=>{t=!0}),O.on("ON_LEVEL_COMPLETED",()=>{o.handleLevelCompleted()}),O.on("ON_TILE_INTERACTION",({tileViewModel:e})=>{t&&o.handleTileInteraction(e)}),O.on("ON_ITEM_INTERACTION",({itemViewModel:e,action:i})=>{t&&o.handleItemInteraction(e,i)}),O.on("ON_EVENT_INTERACTION",({eventViewModel:e})=>{t&&o.handleEventInteraction(e)}),O.on("ON_CHARACTER_INTERACTION",({characterViewModel:e})=>{t&&o.handleCharacterInteraction(e)}),O.on("ON_INVENTORY_REQUEST",({inventory:e,action:i})=>{t&&o.handleInventoryRequest(e,i)}),O.on("ON_CLOSE_INVENTORY_REQUESTED",()=>{t&&o.onCloseInventoryRequested()}),O.on("ON_TRADE_REQUEST",({action:e})=>{t&&o.handleTradeRequest(e)}),O.on("ON_CHARACTER_INTERACTION_REQUEST",e=>{t&&o.handleCharacterInteractionRequest(e)}),O.on("ON_SETTLEMENT_INTERACTION_REQUEST",e=>{t&&o.handleSettlementInteractionRequest(e)}),O.on("ON_SAVE_REQUEST",()=>{o.handleSaveRequest()}),O.on("ON_LOAD_REQUEST",()=>{o.handleLoadRequest()}),O.on("ON_IN_GAME_MENU_REQUEST",({action:e})=>{o.handleInGameMenuRequest(e)}),O.on("ON_DEBUG_ACTION_REQUESTED",({action:e})=>{t&&o.onDebugActionRequested(e)}),{destroy:()=>{O.removeAllListeners()}}},Oi=()=>{const[o,t]=G(0),[e,i]=G(480);return{getCurrentTurn:()=>o(),getGameTimeMin:()=>e(),nextTurn:()=>{t(c=>c+1),i(c=>{const l=c+10;return l>=1440?0:l})}}},Ut=o=>{const{model:t}=o,[e,i]=G(t.armour()>0),[n,s]=G(t.armour()<t.maxArmour()),[u,c]=G(t.damage()>0),[l,a]=G(t.health()>0),h={code:()=>t.code(),name:()=>t.name(),description:()=>t.description(),quantity:()=>t.quantity(),value:()=>t.value(),updateQuantity:r=>{t.updateQuantity(r)},level:()=>t.level(),interact:()=>{O.emit("ON_ITEM_INTERACTION",{itemViewModel:h})},health:()=>t.health(),type:()=>t.type(),damage:()=>t.damage(),range:()=>t.range(),armour:()=>t.armour(),setArmour:r=>{t.setArmour(r)},maxArmour:()=>t.maxArmour(),id:()=>t.id(),isArmourIconVisible:()=>e(),isDamagedArmourIconVisible:()=>n(),isHealthIconVisible:()=>l(),setIsArmourIconVisible:r=>{i(r)},setIsDamagedArmourIconVisible:r=>{s(r)},setIsHealthIconVisible:r=>{a(r)},isDamageIconVisible:()=>u(),setIsDamageIconVisible:r=>{c(r)},uses:()=>t.uses(),setUses:r=>{t.setUses(r)},collected:()=>t.collected(),setCollected:r=>{t.setCollected(r)}};return h},_t=o=>{const{model:t,ownerName:e,owner:i}=o,[n,s]=G([]),[u,c]=G(!1),l=r=>Ut({model:r}),a=(r,f)=>{const p=r.code()===f.code(),d=r.armour()===f.armour(),g=r.damage()===f.damage();return p&&d&&g},h={items:()=>t.items().map(r=>l(r)),stacks:()=>n(),setStacks:()=>{const r=[],f=[];h.items().forEach(p=>{if(i&&i.isEquipped(p)){f.push({item:p,quantity:1});return}const d=r.find(g=>a(g.item,p));d?d.quantity+=p.quantity():r.push({item:p,quantity:p.quantity()})}),r.sort((p,d)=>d.item.type()==="currency"&&p.item.type()!=="currency"?1:d.item.type()!=="currency"&&p.item.type()==="currency"?-1:d.item.type()==="light"&&p.item.type()!=="light"?1:d.item.type()!=="light"&&p.item.type()==="light"?-1:d.item.armour()>0&&p.item.armour()<=0?1:d.item.armour()<=0&&p.item.armour()>0?-1:d.item.damage()>0&&p.item.damage()<=0?1:d.item.damage()<=0&&p.item.damage()>0?-1:d.item.health()>0&&p.item.health()<=0?1:d.item.health()<=0&&p.item.health()>0?-1:d.item.type()==="loot"&&p.item.type()!=="loot"?1:d.item.type()!=="loot"&&p.item.type()==="loot"?-1:p.item.name().localeCompare(d.item.name())),s(f.concat(r))},ownerName:()=>e,getItem:r=>h.items().find(f=>a(f,r)),getItemByCode:r=>h.items().find(f=>f.code()===r),getItemByName:r=>h.items().find(f=>f.name()===r),addItem:r=>{t.addItem(kt(r.code(),{id:()=>r.id()})),h.setStacks()},removeItem:r=>{t.removeItem(r),h.setStacks(),!r.collected()&&(!i||!i.isAlive())&&!["trade-npc","trade","settlement","hero"].includes(e.toLowerCase())&&["trade-npc","trade","settlement","hero"].filter(f=>e.toLowerCase().includes(f)).length===0&&(r.setCollected(!0),gt().log.collectedItemsValue+=r.value())},owner:i,isEmpty:()=>t.isEmpty(),isOnlyLoot:()=>t.isOnlyLoot(),isInfoButtonEnabled:()=>u(),setInfoButtonEnabled:r=>{c(r)}};return h.setStacks(),at(()=>{lt(()=>{h.setStacks()})}),h},le=o=>{const{model:t}=o,[e,i]=G(_t({model:t.inventory(),ownerName:t.name()})),n=c=>{if(!c)throw new Error("Item cannot be undefined");const l=t.inventory().getItemById(c.id());if(!l)throw new Error(`Item with code ${c.id()} not found in inventory`);return l},s=c=>{if(!c)throw new Error("Item cannot be undefined");return Ut({model:c})},u={id:()=>t.id(),name:()=>t.name(),setInventory:c=>{i(c)},size:()=>t.size(),position:()=>({...t.position(),distanceTo:c=>{const l=t.position().x-c.x,a=t.position().y-c.y;return Math.floor(Math.sqrt(l*l+a*a))}}),health:()=>t.health(),maxHealth:()=>t.maxHealth(),moveTo:(c,l)=>{u.isAlive()&&t.moveTo(c,l)},dialogue:()=>t.dialogue(),isHostile:c=>t.isHostile(c),move:(c,l)=>{const a=t.position(),h=a.x+c,r=a.y+l;t.moveTo(h,r)},team:()=>t.team(),updateTeam:c=>{t.updateTeam(c)},inventory:()=>e(),armour:()=>{var h,r,f;const c=((h=t.bodyArmour())==null?void 0:h.armour())??0,l=((r=t.headArmour())==null?void 0:r.armour())??0,a=((f=t.feetArmour())==null?void 0:f.armour())??0;return c+l+a},takeDamage:c=>{let l=c;new Array(c).fill(0).forEach(()=>{const h=[t.bodyArmour(),t.headArmour(),t.feetArmour()].filter(r=>r&&r.armour()>0);if(h.length!==0){const r=h[Math.floor(Math.random()*h.length)];r.setArmour(r.armour()-1),l--}}),t.id()==="player"&&(gt().log.totalDamageAbsorbed+=c-l,gt().log.totalDamageTaken+=l);const a=t.health()-l;t.setHealth(a)},setHealth:c=>{t.setHealth(c)},setMaxHealth:c=>{t.setMaxHealth(c)},isAlive:()=>t.health()>0,visible:()=>t.visible(),setVisible:c=>{t.setVisible(c)},bodyArmour:()=>s(t.bodyArmour()),setBodyArmour:c=>{c?t.setBodyArmour(n(c)):t.setBodyArmour(void 0)},headArmour:()=>s(t.headArmour()),setHeadArmour:c=>{c?t.setHeadArmour(n(c)):t.setHeadArmour(void 0)},feetArmour:()=>s(t.feetArmour()),setFeetArmour:c=>{c?t.setFeetArmour(n(c)):t.setFeetArmour(void 0)},weapon:()=>{const c=t.weapon();return Ut({model:c})},setWeapon:c=>{c?t.setWeapon(n(c)):t.setWeapon(void 0)},isEquipped:c=>{var l,a,h,r;return((l=t.weapon())==null?void 0:l.id())===c.id()||((a=t.bodyArmour())==null?void 0:a.id())===c.id()||((h=t.headArmour())==null?void 0:h.id())===c.id()||((r=t.feetArmour())==null?void 0:r.id())===c.id()}};return i(_t({model:t.inventory(),ownerName:t.name(),owner:u})),u},Ri=o=>{const{eventModel:t}=o;return{...t,inventory:()=>_t({model:t.inventory(),ownerName:t.name()})}},Vi=o=>o.tile,Li=o=>{const{model:t}=o,e=n=>Vi({tile:n});return{isValidMove:(n,s)=>t.isValidMove(n,s),entryPoints:()=>t.entryPoints().map(n=>e(n)),tiles:()=>t.tiles().map(n=>n.map(s=>e(s))),updateTile:(n,s,u)=>{t.tiles()[n][s]=u},getNeighbors:n=>{var a;const s=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],u=[],c=n.position().x,l=n.position().y;for(const{dx:h,dy:r}of s){const f=c+h,p=l+r,d=(a=t.tiles()[f])==null?void 0:a[p];d&&u.push(e(d))}return u}}},ti=o=>{const[t,e]=G([]),[i,n]=G(null),[s,u]=G([]),[c,l]=G(null),[a,h]=G(null),[r,f]=G(!1);return{...le({model:o}),setLastSpawned:d=>o.setLastTurnSpawned(d),lastSpawned:()=>o.lastTurnSpawned(),spawnLing:()=>o.spawnling(),getPatrolArea:()=>t(),setPatrolArea:d=>e(d),getTask:()=>i(),setTask:d=>n(d),getTaskList:()=>s(),setTaskList:d=>u(d),getBedLocation:()=>c(),setBedLocation:d=>l(d),getTarget:()=>a(),setTarget:d=>h(d),canTrade:()=>r(),setCanTrade:d=>f(d)}},Bi=o=>{const{model:t}=o,[e,i]=G(!0);return{id:()=>t.id(),name:()=>t.name(),level:()=>t.level(),positions:()=>t.positions(),isVisible:()=>e(),setIsVisible:n=>i(n),isUnlocked:()=>t.isUnlocked(),setIsUnlocked:n=>t.setIsUnlocked(n),inventory:()=>_t({model:t.inventory(),ownerName:t.name()}),getMiddleTopPosition:()=>{const n=t.positions();if(n.length===0)return{x:0,y:0};const s=Math.max(...n.map(c=>c.x)),u=Math.min(...n.map(c=>c.y));return{x:(s-n[0].x)/2+n[0].x,y:u}}}},Wi=o=>{const{playerModel:t,tileMapModel:e,npcModels:i,eventModels:n,settlementModels:s,fogOfWarViewModel:u}=o,c=le({model:t}),l=Li({model:e}),a=i.map(f=>ti(f)),h=n.map(f=>Ri({eventModel:f})),r=s.map(f=>Bi({model:f}));return{playerVM:c,tileMapVM:l,npcVMs:a,eventVMs:h,settlementVMs:r,fogOfWarViewModel:u}},Di=o=>{const{model:t}=o;return{getCurrentTurn:()=>t.getCurrentTurn(),nextTurn:()=>{t.nextTurn()},getCurrentClocktime:()=>{const e=t.getGameTimeMin(),i=Math.floor(e/60),n=e%60;return`${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},getCurrentTimeMin:()=>t.getGameTimeMin()}},vt=(o,t)=>Math.floor(Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2))),Hi=(o,t)=>{let e=[];for(const i of t){const n=i.position(),s=vt(o,n);e.length===0||s<e[0].distance?e=[{npc:i,distance:s}]:s===e[0].distance&&e.push({npc:i,distance:s})}return e},Ui=(o,t)=>{let e=null,i=1/0;for(const n of t)n.positions().forEach(s=>{const u=vt(o,s);u<i&&(i=u,e=n)});return e},$i=(o,t)=>{let e=null,i=1/0;for(const n of t){const s=n.position(),u=vt(o,s);u<i&&(i=u,e=n)}return e},qi=({playerVM:o,npcVMs:t,settlementVMs:e,eventViewModels:i})=>{const[n,s]=G(!0),[u,c]=G(null),[l,a]=G(null),[h,r]=G(null),[f,p]=G(null),[d,g]=G(null),[y,v]=G(null),[E,C]=G(null),[A,M]=G(null),[N,_]=G(null),[b,m]=G(null),T=1;let w=null,x=null,k=null,B=null,S=null,L,P=null,I=null,R=null,D=null;const W=(U,Q)=>{if(Q){const rt=Q.position();if(vt(U,rt)<=T)return w=Q,!0}return!1},X=(U,Q)=>{if(!Q)return C(null),!1;const rt=Q.position();return vt(U,rt)<=T&&Q.inventory().isEmpty()===!1?(k=Q,!0):!1},z=U=>U.isUnlocked()||!o.inventory().items().some(Q=>Q.code()==="city-key")?!1:(I=U,!0),H=U=>U.isUnlocked()&&!U.inventory().isEmpty()?(R=U,!0):!1,J=U=>U.isUnlocked()?(D=U,!0):!1,nt=U=>{const Q=Ui(U,e);return Q&&Q.positions().forEach(rt=>{if(vt(U,rt)<=T)return z(Q),H(Q),J(Q),R||(B=Q),!0}),!1},V=(U,Q)=>{if(Q){const rt=Q.position(),dt=vt(U,rt);if(dt<=o.weapon().range()&&dt<=2&&!F(U,Q))return S=Q,!0}return!1},F=(U,Q)=>{if(Q){const rt=Q.position(),dt=vt(U,rt);if(dt<=o.weapon().range()&&o.weapon().range()>2&&dt>1)return P=Q,!0}return!1},Y=U=>{const Q=o.position();return vt(Q,U.position)<=T&&U.inventory.isEmpty()===!1?(L=U.inventory,!0):!1},et=U=>{if(U){const Q=o.position(),rt=U.position();if(vt(Q,rt)<=T&&U.canTrade())return x=U,!0}return!1},st=U=>{if(U.isHostile(o.team())){if(U.isAlive()){const Q=V(o.position(),U),rt=F(o.position(),U);return Q||rt}else if(U.inventory().isEmpty()===!1)return Y({position:U.position(),inventory:U.inventory()})}else return U.isAlive()?(W(o.position(),U),et(U)):Y({position:U.position(),inventory:U.inventory()});return!1},ft=()=>{w=null,x=null,k=null,B=null,S=null,L=null,P=null,I=null,R=null,D=null},ct=()=>{u()!==w&&c(w),l()!==x&&a(x),E()!==k&&C(k),h()!==B&&r(B),f()!==S&&p(S),y()!==L&&v(L),l()!==x&&a(x),d()!==P&&g(P),A()!==I&&M(I),N()!==R&&_(R),b()!==D&&m(D)},he=()=>{const U=o.position(),Q=Hi(U,t),rt=$i(U,i);if(ft(),Q.length>0)for(let dt=0;dt<Q.length;dt++){const ii=Q[dt].npc;if(st(ii))break}X(U,rt),nt(U),ct()};return he(),at(()=>{lt(()=>{he()})}),{isVisible:n,setVisibility:U=>s(U),canUnlockSettlement:A,canInteractWithCharacter:u,canAttackCharacter:f,canTradeWithCharacter:l,canVisitSettlement:h,canSearch:E,canLoot:y,canRangedAttackCharacter:d,canTradeWithSettlement:N,canRestAtSettlement:b}},zi=o=>{const{playerVM:t}=o,[e,i]=G(!1),[n,s]=G(!1),[u,c]=G(!1),[l,a]=G(0),h={torchLeft:()=>l(),health:()=>t.health(),maxHealth:()=>t.maxHealth(),armour:()=>h.bodyArmour().armour()+h.headArmour().armour()+h.feetArmour().armour(),maxArmour:()=>h.bodyArmour().maxArmour()+h.headArmour().maxArmour()+h.feetArmour().maxArmour(),inventoryValue:()=>Math.floor(t.inventory().items().reduce((r,f)=>r+f.value()*f.quantity(),0)),isInventoryValueVisible:r=>(r!==void 0&&i(r),e()),inventory:()=>t.inventory(),weapon:()=>t.weapon(),bodyArmour:()=>t.bodyArmour(),headArmour:()=>t.headArmour(),feetArmour:()=>t.feetArmour(),isInGameMenuVisible:()=>n(),showInGameMenu:r=>{c(!1),s(r)},isSaveCompleted:()=>u(),setIsSaveCompleted:r=>{setTimeout(()=>{c(!1)},2e3),c(r)}};return at(()=>{lt(()=>{const r=t.inventory().stacks().find(f=>f.item.code()==="torch");a(r?r.quantity:0)})}),h},Fi=o=>{const{gameView:t,viewModel:e}=o,i=new K,n=new K;n.label="sensing-fog-of-war",n.alpha=.5,i.label="fog-of-war",i.zIndex=1e4,n.zIndex=10001;const s=()=>{i.destroy({children:!0}),n.destroy({children:!0})};t.addChild(i,n);const u=l=>{const r=l.x-innerWidth*.5,f=l.y-innerHeight*.5,p=innerWidth,d=innerHeight,g=Math.floor(r/64)-2,y=Math.floor(f/64)-2,v=Math.ceil((r+p)/64)+2,E=Math.ceil((f+d)/64)+2,C=[];for(let A=g;A<=v;A++)for(let M=y;M<=E;M++)C.push({x:A,y:M});return C};return{applyFogOfWarExceptAround:l=>{e.setFogOfWarPoints(u(l));const a=64;i.clear(),n.clear();const h=new ue;h.x=l.x,h.y=l.y,h.radius=e.lightRadius()*1.8;const r=new ue;r.x=l.x,r.y=l.y,r.radius=e.lightRadius();for(const f of e.fogOfWarPoints()){const p=new Xt;if(p.x=Math.floor(f.x*a),p.y=Math.floor(f.y*a),p.width=a,p.height=a,r.contains(p.x,p.y)){e.addRevealedPoint({x:f.x,y:f.y});continue}if(h.contains(p.x,p.y)){n.rect(p.x,p.y,a,a),n.fill("black"),e.revealedPoints().some(d=>d.x===f.x&&d.y===f.y)||e.addRevealedPoint({x:f.x,y:f.y});continue}if(e.revealedPoints().some(d=>d.x===f.x&&d.y===f.y)){n.rect(p.x,p.y,a,a),n.fill("black");continue}i.rect(p.x,p.y,a,a),i.fill(0)}},destroy:s}},Gi=({gameViews:o,userInterfaceView:t,fogOfWarVM:e})=>{const i=new $,n=new $,s=new K,u=.2,{gameView:c,nonSkewedView:l}=o;let a=!1,h=!1,r={x:0,y:0},f=null,p=Fi({gameView:c,viewModel:e}),d={x:0,y:0},g;i.label="camera-view",n.label="viewport",n.addChild(s,c,l),c.scale.set(.6),c.width=Math.floor(c.width),c.height=Math.floor(c.height);const y=()=>{f==null||f.kill(),document.removeEventListener("mousedown",E),document.removeEventListener("mouseup",C),document.removeEventListener("mousemove",A),document.removeEventListener("wheel",M),n.destroy({children:!0}),s.destroy(),p==null||p.destroy(),p=null,i.removeChildren(),i.destroy({children:!0})},v=(b,m)=>{s.clear(),s.rect(0,0,b,m),s.fill("black")};i.addChild(n,t);const E=b=>{b.button===0&&(a=!0)},C=b=>{b.button===0&&(a=!1,h=!1)},A=b=>{const m={x:b.clientX,y:b.clientY},T=m.x-r.x,w=m.y-r.y;if(h&&T!==0&&w!==0&&(a=!0),r={x:b.clientX,y:b.clientY},h){const{movementX:x,movementY:k}=b;c.position.x+=x,c.position.y+=k}},M=b=>{const{deltaY:m}=b;c.scale.x+m*.001>1||c.scale.x+m*.001<.5||(c.scale.x+=m*.001,c.scale.y+=m*.001)};document.addEventListener("mousedown",E),document.addEventListener("mouseup",C),document.addEventListener("mousemove",A),document.addEventListener("wheel",M);const N=(b,m)=>{const T=new qe(b,m),w=c.toGlobal(T),x=innerWidth*.5,k=innerHeight*.5,B=c.position.x-(w.x-x),S=c.position.y-(w.y-k),L={x:Math.floor(B),y:Math.floor(S)},P={x:Math.floor(c.position.x),y:Math.floor(c.position.y)},R=Math.sqrt(Math.pow(L.x-P.x,2)+Math.pow(L.y-P.y,2))>98;f&&f.progress(1),f=j.fromTo(P,{x:P.x,y:P.y},{x:L.x,y:L.y,duration:R?0:1,onUpdate:()=>{c.position.set(P.x,P.y),l.position.set(0,0),!g&&(g=j.delayedCall(u,()=>{g=void 0}),p==null||p.applyFogOfWarExceptAround(T))},onComplete:()=>{p==null||p.applyFogOfWarExceptAround(T),d={x:b,y:m}}})};return{view:i,moveTo:N,resize:(b,m)=>{v(b,m),N(d.x,d.y)},destroy:y,isDragging:()=>a}},Qi=o=>{const{viewModel:t}=o,e=new $,i=t.isAlive()?q.from(`${t.id()}.png`):q.from("corpse.png");let n={x:0,y:0};e.label=`${t.id()}-view`,e.eventMode="static";const s=()=>{i.width=50,i.height=50,i.anchor.set(.5,.5),i.skew.set(.5,0),i.position.set(32,32),e.addChild(i),e.position.set(t.position().x*64,t.position().y*64)};return e.on("pointertap",()=>{O.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})}),s(),{view:e,update:()=>{e.visible=t.visible(),!t.isAlive()&&!i.label.includes("corpse")&&(tt.play("audio/sfx/death.mp3",{category:"gameplay"}),i.label=`${t.id()}-corpse`,i.texture=q.from("corpse.png").texture);const c=t.position();if(n.x!==c.x||n.y!==c.y){const l=n.x>c.x,a=n.x!==c.x;if(n={x:c.x,y:c.y},tt.play("audio/sfx/step.mp3",{category:"gameplay"}),!a)return;l?(e.scale.x=1,e.pivot.x=0,i.skew.set(-.5,0),i.position.set(32,16)):(e.scale.x=-1,i.position.set(-32,16),i.skew.set(.5,0))}}}},Yi=o=>{const{viewModel:t}=o,e=new $;e.label=`${t.name()}-${t.id()}`;const i=q.from(`${t.id()}.png`);i.label=`${t.name()}-${t.id()}`,i.width=64,i.height=64;const n=q.from("cleared.png");n.width=64,n.height=64,n.label="discovered",n.visible=t.discovered(),n.position.set(-16,0);const s=q.from("loot-icon.png");return s.width=32,s.height=32,s.label="loot-available",s.tint="yellow",s.visible=t.discovered()&&!t.inventory().isEmpty(),s.position.set(i.width-s.width,i.height-s.height),e.addChild(i,n,s),e.skew.set(-.5,0),e.eventMode="static",e.on("pointertap",()=>{O.emit("ON_EVENT_INTERACTION",{eventViewModel:t})}),at(()=>lt(()=>{e.visible=t.visible(),t.visible()&&t.discovered()&&(i.label.includes("visited")||(n.visible=!0,s.visible=!t.inventory().isEmpty()))}),e),{view:e}},Te={"bed-time":"task-bed-time",patrol:"magnifying-glass-icon",follow:"walking-icon",work:"coins-icon",idle:"task-idle",attack:"attack-icon"},Xi=o=>{const{cellSize:t,npcVMs:e}=o,i=new $,n=new Map;i.label="npc-task-view";const s=h=>{var g;const r=new $,f=new K,p=((g=h.getTask())==null?void 0:g.name())??"idle",d=q.from(`${Te[p]||"task-idle"}.png`);r.label=`task-icon-container-${h.id()}`,r.addChild(f,d),d.label=`task-${p}.png`,d.width=t/2,d.height=t/2,n.set(h,{icon:d,container:r,background:f}),f.circle(d.width/2,d.height/2,d.width/1.3),f.fill("khaki"),f.alpha=.75,i.addChild(r)},u=h=>{n.has(h)||s(h)},c=()=>{i.visible=!0},l=()=>{i.visible=!1},a=()=>{n.forEach((h,r)=>{var d;if(h.container.visible=r.visible()&&r.isAlive(),!r.isAlive()){i.removeChild(h.container),h.icon.destroy(),h.background.destroy(),h.container.destroy(),n.delete(r);return}const f=((d=r.getTask())==null?void 0:d.name())??"idle",p=Te[f]||"task-idle";h.icon.label!==`${p}.png`&&(h.icon.label=`${p}.png`,h.icon.texture=q.from(`${p}.png`).texture),h.container.position.set((r.position().x+.5)*o.cellSize-h.icon.width/2,r.position().y*o.cellSize-t*.6)})};return e.forEach(h=>{u(h)}),{view:i,show:c,hide:l,update:a,addNpc:u}},ke=new Array(5).fill(0),_e=o=>{const{viewModel:t,onStep:e}=o,i=new $;let n=t.id();if(n==="bandit"){const a=Math.floor(Math.random()*5),h=ke.reduce((r,f,p,d)=>f<d[r]?p:r,a);n=`bandit-${h}`,ke[h]++,n=`bandit-${h}`}const s=t.isAlive()?q.from(`${n}.png`):q.from("corpse.png");s.label=t.isAlive()?`${t.id()}-sprite`:`${t.id()}-corpse-sprite`,i.label=`${t.name()}-view`,i.eventMode="static";const u=()=>{const a=t.size()*50;s.width=a,s.height=a,s.anchor.set(.5,.5),s.skew.set(-.5,0),s.position.set(32,32),i.addChild(s),i.position.set(t.position().x,t.position().y)};i.on("pointertap",()=>{O.emit("ON_CHARACTER_INTERACTION_REQUEST",{action:"open",character:t})}),u();let c={x:t.position().x,y:t.position().y};const l=()=>{if(!t.isAlive()&&!s.label.includes("corpse")){tt.play("audio/sfx/death.mp3",{category:"gameplay"}),s.label=`${t.id()}-corpse-sprite`,s.texture=q.from("corpse.png").texture;return}};return at(()=>{lt(()=>{i.visible=t.visible();const a=t.position();if(c.x!==a.x||c.y!==a.y){const h=c.x>a.x,r=c.x!==a.x;if(c={x:a.x,y:a.y},e(),!r)return;h?(i.scale.x=1,i.pivot.x=0,s.skew.set(-.5,0),s.position.set(32,16)):(i.scale.x=-1,s.position.set(-32,16),s.skew.set(.5,0))}})}),{view:i,update:l}},ji=({viewModel:o,onUnlocked:t})=>{const e=new $;e.label="settlement-view";const i=q.from(`${o.id()}.png`);let n=0,s=0;o.positions().forEach(c=>{c.x>=n&&(n=c.x),c.y>=s&&(s=c.y)}),i.width=Math.floor((n-o.positions()[0].x+1)*64),i.height=Math.floor((s-o.positions()[0].y+1)*64);const u=q.from("blocked.png");return u.width=i.width,u.height=i.height,u.visible=!o.isUnlocked(),e.addChild(i,u),e.eventMode="none",e.skew.set(-.46,0),at(()=>{lt(()=>{e.visible=o.isVisible(),u.visible&&o.isUnlocked()&&t(),u.visible=!o.isUnlocked()})},e),{view:e}},Zi=(o,t,e)=>{o.alpha=0,j.to(o,{alpha:1,duration:t/1e3,onComplete:e})},Ki=(o,t,e)=>{j.to(o,{alpha:0,duration:t/1e3,onComplete:()=>{e()}})},Ji=o=>{const{tileSize:t,viewModel:e}=o,i=new $;let n=new q,s=new q;i.label="tile-view",i.eventMode="static";const u=e.type();let c=u;c==="wasteland"?c+=`-${Math.floor(Math.random()*2)}`:c==="forest"?c+=`-${Math.floor(Math.random()*2)}`:c==="settlement"&&(c="wasteland");const l=q.from(`${c}.png`);if(l.width=t,l.height=t,l.anchor.set(.5,.5),l.position.set(t/2,t/2),c==="settlement"&&(l.visible=!1),i.addChild(l),e.hasMud()){const a=q.from("mud.png");a.width=t*.6,a.height=t*.6,a.position.set(t*.2,t*.2),a.alpha=.6,i.addChild(a)}if(!e.traversable()&&u==="void"){const a=Math.floor(Math.random()*6),h=["dead-trees-0","dead-trees-1","dead-trees-2","dead-trees-3","dead-trees-4","dead-trees-1"][a];n=q.from(`${h}.png`),n.width=t*1.2,n.height=t*1.2,n.skew.set(-.5,0)}if(e.hasGrass()){const a=q.from("dead-grass.png");a.width=t*.6,a.height=t*.6,a.alpha=1,a.skew.set(-.4,0),a.position.set(20,0),i.addChild(a)}if(e.hasEyes()){s=q.from("eyes.png"),s.width=t*.8,s.height=t*.8,s.skew.set(-.5,0),s.zIndex=s.position.y+32,s.alpha=0;const a=async()=>{await new Promise(h=>{setTimeout(()=>h(),(s.alpha===1?Math.random()*2e3:Math.random()*5e3)+2e3)}),s.alpha===0?Zi(s,1e3,a):Ki(s,1e3,a)};a()}return i.on("pointertap",()=>{O.emit("ON_TILE_INTERACTION",{tileViewModel:e})}),at(()=>{lt(()=>{i.visible=e.visible(),s.visible=e.visible(),n.visible=e.visible()})},i),{view:i,trees:n,eyes:s}},tn=o=>{const{viewModel:t,tileSize:e}=o,i=new $;i.label="tile-map-view",i.sortableChildren=!0;const n=t.tiles(),s=[],u=[];return n.forEach((c,l)=>{c.forEach((a,h)=>{const r=Ji({tileSize:e,viewModel:a});r.view.label=`tile-${l}-${h}`,r.view.position.set(l*e,h*e),r.trees.position.set(r.view.position.x+20,r.view.position.y-20),r.eyes.position.set(r.view.x+32,r.view.y-20),s.push(r.trees),u.push(r.eyes),i.addChild(r.view)})}),{view:i,trees:s,eyes:u}},en=o=>{const{viewModel:t}=o,e=new $,i=[],n=64,s=new Map,u=f=>{const p=f.health(),d=f.maxHealth(),g=p/d,y=n*g,{x:v,y:E}=f.position();let C=s.get(f);C?C.clear():C=new K,C.clear(),C.rect(v*n,E*n-10,n,5),C.fill(0),C.rect(v*n,E*n-10,y,5),C.fill(65280),C.label=`${f.name()}-health-bar`,e.addChild(C),s.set(f,C),j.to(C,{alpha:0,duration:1,delay:1,onComplete:()=>{e.removeChild(C),C.destroy(),s.delete(f)}})},c=(f,p)=>({x:(f.x+p.x)/2,y:(f.y+p.y)/2}),l=f=>{if(e.destroyed)return;const p=f.position(),d=q.from("blood.png");d.width=n,d.height=n,d.position.set(p.x*n,p.y*n),e.addChild(d),f.armour()>0?(d.tint="blue",tt.play("audio/sfx/collect.wav",{category:"gameplay"})):(tt.play("audio/sfx/fists.mp3",{category:"gameplay"}),u(f)),j.to(d,{alpha:0,duration:.333,ease:"power2.inOut",onComplete:()=>{e.removeChild(d),d.destroy()}})},a=async({source:f,target:p})=>{const d=q.from("slash.png");d.scale.set(.15),d.anchor.set(.5),d.position.set(c(f.position(),p.position()).x*64+32,c(f.position(),p.position()).y*64+32),d.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(d),d.alpha=0,await j.to(d,{alpha:1,duration:.5,onComplete:()=>{e.removeChild(d),t.clearAttack()}}),l(p)},h=async({source:f,target:p})=>{const d=q.from("arrow.png");d.scale.set(.1),d.anchor.set(.5),d.position.set(f.position().x*64+32,f.position().y*64+32),d.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(d),await j.to(d.position,{x:p.position().x*64+32,y:p.position().y*64+32,duration:.5,onComplete:()=>{e.removeChild(d),t.clearAttack()}}),l(p)},r=async()=>{for(;i.length>0;){const f=i.shift();f&&await f()}};return at(()=>{lt(()=>{const f=t.isAttacking();f&&(f.type==="ranged"?i.push(()=>h(f)):i.push(()=>a(f)))})}),{view:e,process:r}},nn=o=>{const{attackVM:t,tileMapVM:e,playerVM:i,tileSize:n,npcVMs:s,eventVMs:u,settlementVMs:c}=o,l=new $,a=new $,h=new $,r=new $,f=en({viewModel:t});a.label="game-view-container",h.label="tile-container",r.label="talk-overlay",a.sortableChildren=!0,h.zIndex=-1e3;const p=new Map,d=Xi({cellSize:n,npcVMs:s}),g=new Map;let y=null,v=null,E=[],C=[],A=[];const M=[];let N=!1;const _=P=>{const I=_e({viewModel:P,onStep:()=>{P.position().distanceTo(i.position())<6&&tt.play("audio/sfx/step.mp3",{category:"gameplay"})}});s.push(P),a.addChild(I.view),E.push(I)},b=()=>{v=tn({viewModel:e,tileSize:n}),v.view.label="tile-map-view",y=Qi({viewModel:i}),h.addChild(v.view),v.trees.forEach(P=>{a.addChild(P)}),v.eyes.forEach(P=>{a.addChild(P)}),u.map(P=>{const I=Yi({viewModel:P});C.push(I),a.addChild(I.view)}),E=s.map(P=>{const I=_e({viewModel:P,onStep:()=>{P.position().distanceTo(i.position())<6&&tt.play("audio/sfx/step.mp3",{category:"gameplay"})}});return a.addChild(I.view),I}),c.map(P=>{const I=ji({viewModel:P,onUnlocked:()=>{S("city-key",P.getMiddleTopPosition())}});A.push(I),a.addChild(I.view),I.view.label=`settlement-${P.id()}`,I.view.position.set(P.positions()[0].x*n+52,P.positions()[0].y*n-30),I.view.zIndex=I.view.y+32}),a.addChild(h,y.view,r,f.view)},m=()=>{N=!0,M.forEach(P=>P.kill()),v==null||v.view.destroy({children:!0}),y==null||y.view.destroy({children:!0}),r.removeChildren(),v=null,y=null,E.forEach(P=>P.view.destroy({children:!0})),E=[],C.forEach(P=>P.view.destroy({children:!0})),C=[],A.forEach(P=>P.view.destroy({children:!0})),A=[],p.clear(),a.destroy({children:!0})},T=["snow","lightskyblue","lime","yellow","fuchsia","orange"],w=()=>{const P=["snow","lightskyblue","lime","yellow","fuchsia","orange"];return T.length===0&&T.push(...P),T.splice(Math.floor(Math.random()*T.length),1)[0]},x=P=>{const{x:R,y:D}=P.position(),W=new Mt;if(p.get(P.id()))return;W.style={fontFamily:"alagard",fontSize:32,fill:w(),align:"center",dropShadow:!0,stroke:"black",wordWrap:!0,wordWrapWidth:innerWidth*1.5},W.text=P.dialogue(),W.anchor.set(.5);let z=0;const H=R*n+n/2,J=D*n-n;W.position.set(H,J),p.forEach(V=>{W.getBounds().containsPoint(V.position.x,V.position.y)&&(z+=V.height),W.position.set(H,J-z)}),W.label="text-box",W.zIndex=11e3;const nt=a.toGlobal(W.position);return W.position.set(nt.x,nt.y),W.scale.set(.6),l.addChild(W),setTimeout(()=>{const V=p.get(P.id());V&&(a.removeChild(V),p.delete(P.id()),V.destroy())},2e3),p.set(P.id(),W),W},k=(P,I)=>{const{x:R,y:D}=I,W=R*n,X=D*n;M.push(j.to(P.view.position,{x:W,y:X,duration:.2,ease:"power2.inOut",onUpdate:()=>{P.view.zIndex=P.view.position.y},onComplete:()=>{P.view.position.set(W,X)}}))},B=async()=>{if(N)return;const{x:P,y:I}=i.position();y&&(y.update(),y.view.zIndex=y.view.position.y,(y.view.position.x!==P*n||y.view.position.y!==I*n)&&k(y,{x:P,y:I})),await f.process();for(const R of E){const D=E.indexOf(R),{x:W,y:X}=s[D].position();R.update(),(R.view.position.x!==W*n||R.view.position.y!==X*n)&&k(R,{x:W,y:X})}C.forEach((R,D)=>{const{x:W,y:X}=u[D].position();R.view.position.set(W*n+20,X*n-50),R.view.scale.set(1.5,1.5),R.view.zIndex=R.view.y+32}),d.update()},S=async(P,I)=>{const R=new $;R.label="looted-icon-container";const D=q.from(`${P}.png`);D.width=n/2,D.height=n/2;const W=new K;W.circle(n*.25,n*.25,n/2),W.fill("khaki"),R.addChild(W,D),R.zIndex=11e3,R.position.set((I.x+1)*n,I.y*n-n);const X=a.toGlobal(R.position);l.addChild(R),R.position.set(X.x,X.y),R.scale.set(.6);const z=g.get(`${{x:I.x,y:I.y}}`)??0;g.set(`${{x:I.x,y:I.y}}`,z+1),await j.delayedCall(.2*z,()=>{}),j.to(R.position,{y:R.position.y-n*4,duration:1,delay:z*.1,ease:"power2.inOut",onComplete:()=>{l.removeChild(R),R.destroy({children:!0});const H=g.get(`${{x:I.x,y:I.y}}`)??0;H>1?g.set(`${{x:I.x,y:I.y}}`,H-1):g.delete(`${{x:I.x,y:I.y}}`)}})};b(),B(),a.skew.set(Math.PI/6,0),f.view.zIndex=11e3;const L=new K;return l.addChild(L),l.label="non-skewed-container",L.rect(0,0,innerWidth,innerHeight),L.fill("black"),L.alpha=0,{view:a,nonSkewedContainer:l,addNpc:_,animateIconFloat:S,handleEndOfTurnUpdates:B,createTextBox:x,destroy:m}};var ee={},St={},Ie;function zt(){if(Ie)return St;Ie=1,Object.defineProperty(St,"__esModule",{value:!0}),St.Collector=void 0;let o=class{constructor(e){this.emit=(...i)=>{e.emitCollecting(this,i)}}};return St.Collector=o,St}var At={},Me;function on(){if(Me)return At;Me=1,Object.defineProperty(At,"__esModule",{value:!0}),At.CollectorArray=void 0;const o=zt();let t=class extends o.Collector{constructor(){super(...arguments),this.result=[]}handleResult(i){return this.result.push(i),!0}getResult(){return this.result}reset(){this.result.length=0}};return At.CollectorArray=t,At}var Pt={},Ee;function sn(){if(Ee)return Pt;Ee=1,Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.CollectorLast=void 0;const o=zt();let t=class extends o.Collector{handleResult(i){return this.result=i,!0}getResult(){return this.result}reset(){delete this.result}};return Pt.CollectorLast=t,Pt}var Nt={},Se;function rn(){if(Se)return Nt;Se=1,Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.CollectorUntil0=void 0;const o=zt();let t=class extends o.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,this.result}getResult(){return this.result}reset(){this.result=!1}};return Nt.CollectorUntil0=t,Nt}var Ot={},Ae;function an(){if(Ae)return Ot;Ae=1,Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.CollectorWhile0=void 0;const o=zt();let t=class extends o.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,!this.result}getResult(){return this.result}reset(){this.result=!1}};return Ot.CollectorWhile0=t,Ot}var Rt={},Vt={},Pe;function ln(){if(Pe)return Vt;Pe=1,Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.SignalConnectionImpl=void 0;class o{constructor(e,i){this.link=e,this.parentCleanup=i}disconnect(){return this.link!==null?(this.link.unlink(),this.link=null,this.parentCleanup(),this.parentCleanup=null,!0):!1}set enabled(e){this.link&&this.link.setEnabled(e)}get enabled(){return this.link!==null&&this.link.isEnabled()}}return Vt.SignalConnectionImpl=o,Vt}var Lt={},Ne;function cn(){if(Ne)return Lt;Ne=1,Object.defineProperty(Lt,"__esModule",{value:!0}),Lt.SignalLink=void 0;let o=class ei{constructor(e=null,i=null,n=0){this.enabled=!0,this.newLink=!1,this.callback=null,this.prev=e??this,this.next=i??this,this.order=n}isEnabled(){return this.enabled&&!this.newLink}setEnabled(e){this.enabled=e}unlink(){this.callback=null,this.next.prev=this.prev,this.prev.next=this.next}insert(e,i){let n=this.prev;for(;n!==this&&!(n.order<=i);)n=n.prev;const s=new ei(n,n.next,i);return s.callback=e,n.next=s,s.next.prev=s,s}};return Lt.SignalLink=o,Lt}var Oe;function hn(){if(Oe)return Rt;Oe=1,Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.Signal=void 0;const o=ln(),t=cn();let e=class{constructor(){this.head=new t.SignalLink,this.hasNewLinks=!1,this.emitDepth=0,this.connectionsCount=0}getConnectionsCount(){return this.connectionsCount}hasConnections(){return this.connectionsCount>0}connect(n,s=0){this.connectionsCount++;const u=this.head.insert(n,s);return this.emitDepth>0&&(this.hasNewLinks=!0,u.newLink=!0),new o.SignalConnectionImpl(u,()=>this.decrementConnectionCount())}decrementConnectionCount(){this.connectionsCount--}disconnect(n){for(let s=this.head.next;s!==this.head;s=s.next)if(s.callback===n)return this.decrementConnectionCount(),s.unlink(),!0;return!1}disconnectAll(){for(;this.head.next!==this.head;)this.head.next.unlink();this.connectionsCount=0}emit(...n){this.emitDepth++;for(let s=this.head.next;s!==this.head;s=s.next)s.isEnabled()&&s.callback&&s.callback.apply(null,n);this.emitDepth--,this.unsetNewLink()}emitCollecting(n,s){this.emitDepth++;for(let u=this.head.next;u!==this.head;u=u.next)if(u.isEnabled()&&u.callback){const c=u.callback.apply(null,s);if(!n.handleResult(c))break}this.emitDepth--,this.unsetNewLink()}unsetNewLink(){if(this.hasNewLinks&&this.emitDepth===0){for(let n=this.head.next;n!==this.head;n=n.next)n.newLink=!1;this.hasNewLinks=!1}}};return Rt.Signal=e,Rt}var Bt={},Re;function dn(){if(Re)return Bt;Re=1,Object.defineProperty(Bt,"__esModule",{value:!0}),Bt.SignalConnections=void 0;let o=class{constructor(){this.list=[]}add(e){this.list.push(e)}disconnectAll(){for(const e of this.list)e.disconnect();this.list=[]}getCount(){return this.list.length}isEmpty(){return this.list.length===0}};return Bt.SignalConnections=o,Bt}var Ve;function un(){return Ve||(Ve=1,function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.SignalConnections=o.Signal=o.CollectorWhile0=o.CollectorUntil0=o.CollectorLast=o.CollectorArray=o.Collector=void 0;var t=zt();Object.defineProperty(o,"Collector",{enumerable:!0,get:function(){return t.Collector}});var e=on();Object.defineProperty(o,"CollectorArray",{enumerable:!0,get:function(){return e.CollectorArray}});var i=sn();Object.defineProperty(o,"CollectorLast",{enumerable:!0,get:function(){return i.CollectorLast}});var n=rn();Object.defineProperty(o,"CollectorUntil0",{enumerable:!0,get:function(){return n.CollectorUntil0}});var s=an();Object.defineProperty(o,"CollectorWhile0",{enumerable:!0,get:function(){return s.CollectorWhile0}});var u=hn();Object.defineProperty(o,"Signal",{enumerable:!0,get:function(){return u.Signal}});var c=dn();Object.defineProperty(o,"SignalConnections",{enumerable:!0,get:function(){return c.SignalConnections}})}(ee)),ee}var Le=un(),fn=Object.defineProperty,pn=(o,t,e)=>t in o?fn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,Wt=(o,t,e)=>pn(o,typeof t!="symbol"?t+"":t,e);class mn extends ${constructor(t){var e;super(),Wt(this,"options"),Wt(this,"view"),Wt(this,"_type"),Wt(this,"_maxWidth"),Wt(this,"children",[]),t&&(t.maxWidth&&(this._maxWidth=t.maxWidth),this.init(t)),(e=t==null?void 0:t.items)==null||e.forEach(i=>this.addChild(i)),this.on("added",()=>this.arrangeChildren()),this.on("childAdded",()=>this.arrangeChildren())}init(t){this.options=t,t!=null&&t.type&&(this.type=t.type),t!=null&&t.children&&t.children.forEach(e=>this.addChild(e))}set type(t){this._type=t,this.arrangeChildren()}get type(){return this._type}set elementsMargin(t){if(!this.options)throw new Error("List has not been initiated!");this.options.elementsMargin=t,this.arrangeChildren()}get elementsMargin(){var t;return((t=this.options)==null?void 0:t.elementsMargin)??0}set padding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.padding=t,this.options.vertPadding=t,this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get padding(){var t;return((t=this.options)==null?void 0:t.padding)??0}set vertPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.vertPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get vertPadding(){var t;return((t=this.options)==null?void 0:t.vertPadding)??this.padding??0}set horPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.arrangeChildren()}get horPadding(){var t;return((t=this.options)==null?void 0:t.horPadding)??this.padding??0}set leftPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.leftPadding=t,this.arrangeChildren()}get leftPadding(){var t;return((t=this.options)==null?void 0:t.leftPadding)??this.horPadding}set rightPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.rightPadding=t,this.arrangeChildren()}get rightPadding(){var t;return((t=this.options)==null?void 0:t.rightPadding)??this.horPadding}set topPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.topPadding=t,this.arrangeChildren()}get topPadding(){var t;return((t=this.options)==null?void 0:t.topPadding)??this.vertPadding}set bottomPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.bottomPadding=t,this.arrangeChildren()}get bottomPadding(){var t;return((t=this.options)==null?void 0:t.bottomPadding)??this.vertPadding}arrangeChildren(){var u,c;let t=0,e=this.leftPadding,i=this.topPadding;const n=((u=this.options)==null?void 0:u.elementsMargin)??0;let s=this.maxWidth??((c=this.parent)==null?void 0:c.width);this.rightPadding&&(s-=this.rightPadding),this.children.forEach((l,a)=>{switch(this.type){case"vertical":l.y=i,l.x=e,i+=n+l.height;break;case"horizontal":l.x=e,l.y=i,e+=n+l.width;break;case"bidirectional":default:l.x=e,l.y=i,l.x+l.width>s&&a>0&&(i+=n+t,e=this.leftPadding,l.x=e,l.y=i,t=0),t=Math.max(t,l.height),e+=n+l.width;break}})}removeItem(t){const e=this.children[t];e&&(this.removeChild(e),this.arrangeChildren())}set maxWidth(t){this._maxWidth=t,this.arrangeChildren()}get maxWidth(){return this._maxWidth}}var gn=Object.defineProperty,yn=(o,t,e)=>t in o?gn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,Dt=(o,t,e)=>yn(o,typeof t!="symbol"?t+"":t,e);class vn{constructor(t={}){Dt(this,"x"),Dt(this,"ax"),Dt(this,"dx"),Dt(this,"tx"),Dt(this,"_options"),this.x=0,this.ax=0,this.dx=0,this.tx=0,this._options=t,this._options.max=t.max||160,this._options.damp=t.damp||.8,this._options.springiness=t.springiness||.1}update(){this.ax=(this.tx-this.x)*this._options.springiness,this.dx+=this.ax,this.dx*=this._options.damp,this.dx<-this._options.max?this.dx=-this._options.max:this.dx>this._options.max&&(this.dx=this._options.max),this.x+=this.dx}reset(){this.x=0,this.ax=0,this.dx=0,this.tx=0}get max(){return this._options.max}set max(t){this._options.max=t}get damp(){return this._options.damp}set damp(t){this._options.damp=t}get springiness(){return this._options.springiness}set springiness(t){this._options.springiness=t}}var wn=Object.defineProperty,xn=(o,t,e)=>t in o?wn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,It=(o,t,e)=>xn(o,typeof t!="symbol"?t+"":t,e);class bn{constructor(){It(this,"done"),It(this,"to"),It(this,"_spring"),It(this,"_pos"),It(this,"_speed"),It(this,"_correctSpeed"),this._spring=new vn,this._pos=0,this.to=0}start(t,e,i){this._speed=t,this._pos=e,this.to=i,this.done=!1,this._spring.x=this._pos,this._spring.tx=this.to;const n=this.to-this._pos,s=Math.abs(n)/n,u=Math.abs(this._speed)/this._speed;s!==u?this._correctSpeed=!0:this._correctSpeed=!1}update(){if(this._correctSpeed)this._speed*=.6,Math.abs(this._speed)<2&&(this._correctSpeed=!1),this._pos+=this._speed,this._spring.x=this._pos;else{const t=this.to-this._pos;Math.abs(t)<.05?(this._pos=this.to,this.done=!0):(this._spring.tx=this.to,this._spring.update(),this._pos=this._spring.x)}return this._pos}cancel(){}}var Cn=Object.defineProperty,Tn=(o,t,e)=>t in o?Cn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,ht=(o,t,e)=>Tn(o,typeof t!="symbol"?t+"":t,e);class Be{constructor(t={}){ht(this,"position",0),ht(this,"constrain",!0),ht(this,"min",0),ht(this,"max",0),ht(this,"maxSpeed",400),ht(this,"_ease"),ht(this,"_offset",0),ht(this,"_prev",0),ht(this,"_speed",0),ht(this,"_hasStopped"),ht(this,"_targetSpeed",0),ht(this,"_speedChecker",0),ht(this,"_grab",0),ht(this,"_activeEase"),this.constrain=t.constrain??!0,this.maxSpeed=t.maxSpeed??400,this._ease=t.ease??new bn}set value(t){this._speed=0,this.position=t}get value(){return this.position}grab(t){this._grab=t,this._offset=this.position-t,this._speedChecker=0,this._targetSpeed=this._speed=0,this._hasStopped=!1}hold(t){this._speedChecker++,this.position=t+this._offset,this._speedChecker>1&&(this._targetSpeed=this.position-this._prev),this._speed+=(this._targetSpeed-this._speed)/2,this._speed>this.maxSpeed?this._speed=this.maxSpeed:this._speed<-this.maxSpeed&&(this._speed=-this.maxSpeed),this._prev=this.position,this.constrain&&(this._activeEase=null,this.position>this.min?this.position-=(this.position-this.min)/1.5:this.position<this.max&&(this.position+=(this.max-this.position)/1.5))}slide(t=!1){this._hasStopped||(this.constrain?this._updateConstrain(t):this._updateDefault())}get moveAmount(){return-(this.position-this._offset-this._grab)}_updateDefault(){this._speed*=.9,this.position+=this._speed,(this._speed<0?this._speed*-1:this._speed)<.01&&(this._hasStopped=!0)}_updateConstrain(t=!1){const e=this.max;t?(this.value>0&&(this.value=0),this.value>0&&(this.value=0),this.value<this.max&&(this.value=this.max),this.value<this.max&&(this.value=this.max)):this.position>this.min||this.position<e||this._activeEase?(this._activeEase||(this._activeEase=this._ease,this.position>this.min?this._activeEase.start(this._speed,this.position,this.min):this._activeEase.start(this._speed,this.position,e)),this.position=this._activeEase.update(),this._activeEase.done&&(this.position=this._activeEase.to,this._speed=0,this._activeEase=null)):this._updateDefault()}}var kn=Object.defineProperty,_n=(o,t,e)=>t in o?kn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,bt=(o,t,e)=>_n(o,typeof t!="symbol"?t+"":t,e);class In{constructor(t){bt(this,"xAxis"),bt(this,"yAxis"),bt(this,"_isDown"),bt(this,"_globalPosition"),bt(this,"_frame"),bt(this,"_bounds"),bt(this,"_dirty"),bt(this,"disableEasing",!1),this.xAxis=new Be({ease:t.xEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.yAxis=new Be({ease:t.yEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.disableEasing=t.disableEasing??!1,this._frame=new Xt,this._bounds=new Xt,this._globalPosition=new qe}pointerDown(t){this._globalPosition=t,this.xAxis.grab(t.x),this.yAxis.grab(t.y),this._isDown=!0}pointerUp(){this._isDown=!1}pointerMove(t){this._globalPosition=t}update(){this._dirty&&(this._dirty=!1,this.xAxis.min=this._bounds.left,this.xAxis.min=this._bounds.right-this._frame.width,this.xAxis.min=this._bounds.top,this.xAxis.min=this._bounds.bottom-this._frame.height),this._isDown?(this.xAxis.hold(this._globalPosition.x),this.yAxis.hold(this._globalPosition.y)):(this.xAxis.slide(this.disableEasing),this.yAxis.slide(this.disableEasing))}resize(t,e){this._frame.x=0,this._frame.width=t,this._frame.y=0,this._frame.height=e,this._dirty=!0}setBounds(t,e,i,n){this._bounds.x=t,this._bounds.width=e-t,this._bounds.y=i,this._bounds.height=n-i,this._dirty=!0}get x(){return this.xAxis.value}get y(){return this.yAxis.value}}var Mn=Object.defineProperty,En=(o,t,e)=>t in o?Mn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,Z=(o,t,e)=>En(o,typeof t!="symbol"?t+"":t,e);class ce extends ${constructor(t){super(),Z(this,"background"),Z(this,"borderMask"),Z(this,"lastWidth"),Z(this,"lastHeight"),Z(this,"_width",0),Z(this,"_height",0),Z(this,"_dimensionChanged",!1),Z(this,"list"),Z(this,"_trackpad"),Z(this,"isDragging",0),Z(this,"interactiveStorage",[]),Z(this,"visibleItems",[]),Z(this,"pressedChild"),Z(this,"ticker",ri.shared),Z(this,"options"),Z(this,"stopRenderHiddenItemsTimeout"),Z(this,"onMouseScrollBinding",this.onMouseScroll.bind(this)),Z(this,"dragStarTouchPoint"),Z(this,"isOver",!1),Z(this,"proximityRange"),Z(this,"proximityStatusCache",[]),Z(this,"lastScrollX"),Z(this,"lastScrollY"),Z(this,"proximityCheckFrameCounter",0),Z(this,"onProximityChange",new Le.Signal),Z(this,"onScroll",new Le.Signal),t&&this.init(t),this.ticker.add(this.update,this)}init(t){this.options=t,this.setBackground(t.background),this._width=t.width|this.background.width,this._height=t.height|this.background.height,this.proximityRange=t.proximityRange??0,this.list||(this.list=new mn,super.addChild(this.list)),this.list.init({type:t.type,elementsMargin:t.elementsMargin,padding:t.padding,vertPadding:t.vertPadding,horPadding:t.horPadding,topPadding:t.topPadding,bottomPadding:t.bottomPadding,leftPadding:t.leftPadding,rightPadding:t.rightPadding}),this.addItems(t.items),this.hasBounds&&(this.addMask(),this.makeScrollable()),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.options.globalScroll=t.globalScroll??!0,this.options.shiftScroll=t.shiftScroll??!1,this.resize()}get hasBounds(){return!!this._width||!!this._height}addItems(t){t!=null&&t.length&&t.forEach(e=>this.addItem(e))}removeItems(){this.proximityStatusCache.length=0,this.list.removeChildren()}addItem(...t){if(t.length>1)t.forEach(e=>this.addItem(e));else{const e=t[0];(!e.width||!e.height)&&console.error("ScrollBox item should have size"),e.eventMode="static",this.list.addChild(e),this.proximityStatusCache.push(!1),this.options.disableDynamicRendering||(e.renderable=this.isItemVisible(e))}return this.resize(),t[0]}removeItem(t){this.list.removeItem(t),this.proximityStatusCache.splice(t,1),this.resize()}isItemVisible(t,e=0){let i=!1;const n=this.list;if(this.isVertical||this.isBidirectional){const s=t.y+n.y;s+t.height>=-e&&s<=this.options.height+e&&(i=!0)}if(this.isHorizontal||this.isBidirectional){const s=t.x+n.x;s+t.width>=-e&&s<=this.options.width+e&&(i=!0)}return i}get items(){var t;return((t=this.list)==null?void 0:t.children)??[]}setBackground(t){this.background&&this.removeChild(this.background),this.options.background=t,this.background=new K,this.addChildAt(this.background,0),this.resize()}addMask(){this.borderMask||(this.borderMask=new K,super.addChild(this.borderMask),this.mask=this.borderMask),this.resize()}makeScrollable(){this._trackpad||(this._trackpad=new In({disableEasing:this.options.disableEasing})),this.on("pointerdown",t=>{this.renderAllItems(),this.isDragging=1,this.dragStarTouchPoint=this.worldTransform.applyInverse(t.global),this._trackpad.pointerDown(this.dragStarTouchPoint);const e=this.list.worldTransform.applyInverse(t.global);this.visibleItems.forEach(i=>{i.x<e.x&&i.x+i.width>e.x&&i.y<e.y&&i.y+i.height>e.y&&(this.pressedChild=i)})}),this.on("pointerup",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("pointerover",()=>{this.isOver=!0}),this.on("pointerout",()=>{this.isOver=!1}),this.on("pointerupoutside",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("globalpointermove",t=>{var i,n;if(!this.isDragging)return;const e=this.worldTransform.applyInverse(t.global);if(this.dragStarTouchPoint){const s=this.options.dragTrashHold??10;if(this.isHorizontal||this.isBidirectional){const u=e.x-this.dragStarTouchPoint.x;Math.abs(u)>s&&(this.isDragging=2)}if(this.isVertical||this.isBidirectional){const u=e.y-this.dragStarTouchPoint.y;Math.abs(u)>s&&(this.isDragging=2)}}this.dragStarTouchPoint&&this.isDragging!==2||(this._trackpad.pointerMove(e),this.pressedChild&&(this.revertClick(this.pressedChild),this.pressedChild=null),this.isBidirectional?(i=this.onScroll)==null||i.emit({x:this.scrollX,y:this.scrollY}):(n=this.onScroll)==null||n.emit(this.isVertical?this.scrollY:this.scrollX))}),document.addEventListener("wheel",this.onMouseScrollBinding,!0)}setInteractive(t){this.eventMode=t?"static":"auto"}get listHeight(){return this.list.height+this.list.topPadding+this.list.bottomPadding}get listWidth(){return this.list.width+this.list.leftPadding+this.list.rightPadding}resize(t=!1){if(this.hasBounds){if(this.renderAllItems(),this.borderMask&&(t||this._dimensionChanged||this.lastWidth!==this.listWidth||this.lastHeight!==this.listHeight)){this.options.width||(this._width+=this.listWidth),this.options.height||(this._height+=this.listHeight),this.borderMask.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill(16711935).stroke(0),this.borderMask.eventMode="none";const e=this.options.background;this.background.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill({color:e??0,alpha:e?1:1e-7}),this.isBidirectional?this.setInteractive(this.listWidth>this._width||this.listHeight>this._height):this.isHorizontal?this.setInteractive(this.listWidth>this._width):this.setInteractive(this.listHeight>this._height),this.lastWidth=this.listWidth,this.lastHeight=this.listHeight}if(this._trackpad){const e=this.borderMask.width-this.list.width-this.list.leftPadding-this.list.rightPadding,i=this.borderMask.height-this.list.height-this.list.topPadding-this.list.bottomPadding;this.isBidirectional?(this._trackpad.yAxis.max=-Math.abs(i),this._trackpad.xAxis.max=-Math.abs(e)):this.isVertical?this._trackpad.yAxis.max=-Math.abs(i):this.isHorizontal&&(this._trackpad.xAxis.max=-Math.abs(e))}this._dimensionChanged?(this.list.arrangeChildren(),this.stopRenderHiddenItems(),this._dimensionChanged=!1):(t&&this.list.arrangeChildren(),this.updateVisibleItems()),this.lastScrollX=null,this.lastScrollY=null}}onMouseScroll(t){var s,u,c;if(!this.isOver&&!this.options.globalScroll)return;this.renderAllItems();const e=!!this.options.shiftScroll,i=e?typeof t.deltaX<"u"||typeof t.deltaY<"u":typeof t.deltaX<"u",n=typeof t.deltaY<"u";if((this.isHorizontal||this.isBidirectional)&&i){const l=e||this.isBidirectional?t.deltaX:t.deltaY,a=this.list.x-l;if(this.listWidth<this._width)this._trackpad.xAxis.value=0;else{const h=this._width-this.listWidth,r=0;this._trackpad.xAxis.value=Math.min(r,Math.max(h,a))}}if((this.isVertical||this.isBidirectional)&&n){const l=this.list.y-t.deltaY;if(this.listHeight<this._height)this._trackpad.yAxis.value=0;else{const a=this._height-this.listHeight,h=0;this._trackpad.yAxis.value=Math.min(h,Math.max(a,l))}}this.isBidirectional&&(i||n)?(s=this.onScroll)==null||s.emit({x:this._trackpad.xAxis.value,y:this._trackpad.yAxis.value}):this.isHorizontal&&i?(u=this.onScroll)==null||u.emit(this._trackpad.xAxis.value):this.isVertical&&n&&((c=this.onScroll)==null||c.emit(this._trackpad.yAxis.value)),this.stopRenderHiddenItems()}scrollBottom(){this.interactive?this.scrollTo(this.list.children.length-1):this.scrollTop()}scrollTop(){this.renderAllItems(),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.stopRenderHiddenItems()}renderAllItems(){clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null,!this.options.disableDynamicRendering&&this.items.forEach(t=>{t.renderable=!0})}stopRenderHiddenItems(){this.options.disableDynamicRendering||(this.stopRenderHiddenItemsTimeout&&(clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null),this.stopRenderHiddenItemsTimeout=setTimeout(()=>this.updateVisibleItems(),2e3))}updateVisibleItems(){this.visibleItems.length=0,this.items.forEach(t=>{t.renderable=this.isItemVisible(t),this.visibleItems.push(t)})}scrollTo(t){if(!this.interactive)return;const e=this.list.children[t];e&&(this.renderAllItems(),this._trackpad.xAxis.value=this.isHorizontal||this.isBidirectional?this._width-e.x-e.width-this.list.rightPadding:0,this._trackpad.yAxis.value=this.isVertical||this.isBidirectional?this._height-e.y-e.height-this.list.bottomPadding:0,this.stopRenderHiddenItems())}scrollToPosition({x:t,y:e}){t===void 0&&e===void 0||(this.renderAllItems(),t!==void 0&&(this.scrollX=-t),e!==void 0&&(this.scrollY=-e),this.stopRenderHiddenItems())}get height(){return this._height}set height(t){this._height=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}get width(){return this._width}set width(t){this._width=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}setSize(t,e){typeof t=="object"?(e=t.height??t.width,t=t.width):e=e??t,this._width=t,this._height=e,this._dimensionChanged=!0,this.resize(),this.scrollTop()}getSize(t){return t=t||{width:0,height:0},t.width=this._width,t.height=this._height,t}get scrollX(){return this._trackpad.xAxis.value}set scrollX(t){this._trackpad.xAxis.value=t}get scrollY(){return this._trackpad.yAxis.value}set scrollY(t){this._trackpad.yAxis.value=t}update(){this.list&&(this._trackpad.update(),(this.isHorizontal||this.isBidirectional)&&this.list.x!==this._trackpad.x&&(this.list.x=this._trackpad.x),(this.isVertical||this.isBidirectional)&&this.list.y!==this._trackpad.y&&(this.list.y=this._trackpad.y),!this.options.disableProximityCheck&&(this._trackpad.x!==this.lastScrollX||this._trackpad.y!==this.lastScrollY)&&(this.proximityCheckFrameCounter++,this.proximityCheckFrameCounter>=(this.options.proximityDebounce??10)&&(this.items.forEach((t,e)=>{const i=this.isItemVisible(t,this.proximityRange),n=this.proximityStatusCache[e];i!==n&&(this.proximityStatusCache[e]=i,this.onProximityChange.emit({item:t,index:e,inRange:i}))}),this.lastScrollX=this._trackpad.x,this.lastScrollY=this._trackpad.y,this.proximityCheckFrameCounter=0)))}destroy(t){this.ticker.remove(this.update,this),document.removeEventListener("wheel",this.onMouseScrollBinding,!0),this.background.destroy(),this.list.destroy(),super.destroy(t)}restoreItemsInteractivity(){this.interactiveStorage.forEach(t=>{t.item.eventMode=t.eventMode}),this.interactiveStorage.length=0}revertClick(t){t.eventMode!=="auto"&&(ai.any?t.emit("pointerupoutside",null):t.emit("mouseupoutside",null),this.interactiveStorage.push({item:t,eventMode:t.eventMode}),t.eventMode="auto"),t instanceof $&&t.children&&t.children.forEach(e=>this.revertClick(e))}get scrollHeight(){return this.list.height}get scrollWidth(){return this.list.width}get isVertical(){return(this.options.type??"vertical")==="vertical"}get isHorizontal(){return this.options.type==="horizontal"}get isBidirectional(){return this.options.type==="bidirectional"}}const Sn=()=>{const o=document.createElement("canvas");o.width=256,o.height=1;const t=o.getContext("2d"),e=t.createLinearGradient(0,0,o.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,o.width,1),ze.from(o)},We=(o,t)=>{const e=new $,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},n=new Mt,s=new K;n.text=o,n.style=i;const u=()=>{s.clear(),s.roundRect(n.x-10,n.y,n.width+20,n.height,10),s.fill("black"),s.alpha=.5};e.addChild(s,n);const c=l=>{n.text=l,u()};return u(),{view:e,updateText:c}},An=o=>{const t=Sn(),e=new q(t);return e.label="gradient-background",e.position.set(o.x,o.y-2.5),e.width=o.width+16,e.height=o.height+5,o.addChildAt(e,0),e},$t=o=>{const{viewModel:t,includeItemValue:e,quantity:i}=o,n=o.itemValue,s=new $;let u=!1;s.label=`${t.name()}-view`,s.eventMode="static";const c=q.from(`${t.code()}.png`);c.width=50,c.height=50,s.addChild(c);const l=We(`${(i==null?void 0:i.toString())??t.quantity().toString()}`);l.view.position.set(c.width-l.view.width*.5,c.height);let a=null;e&&(a=We(`$ ${(n||t.value()).toString()}`,{fill:"gold"}),a.view.position.set(c.width-a.view.width*.5,0),s.addChild(a.view),c.position.set(0,a.view.height+5),l.view.position.set(c.width-l.view.width*.5,a.view.height+c.height));const h=c.y+c.height,r=(y,v)=>{const E=new $;return v()<=0||(u=!0,Array(v()).fill(0).forEach((C,A)=>{const M=q.from(`${y}-icon.png`);M.width=20,M.height=20,M.position.set(2.5+A*M.width*.5,0),E.addChildAt(M,0)}),An(E),E.position.set(0,h-E.height+14),s.addChild(E)),E};t.isArmourIconVisible()&&r("armour",t.armour);const f=new $;if(t.isHealthIconVisible()&&r("health",t.health),t.isDamageIconVisible()&&t.damage()>0&&t.range()>0){const y=r("damage",t.damage),v=r("range",t.range);v.position.set(y.x,y.y-v.height)}const p=q.from("armour-broken-icon.png");p.width=20,p.height=20,p.position.set(0,c.height-p.height),s.addChild(l.view,p,f),s.on("pointertap",()=>{d()}),u&&c.position.set(16,c.y);const d=()=>{t.interact(),tt.play("audio/sfx/collect.wav",{category:"gameplay"})},g=at(()=>{lt(()=>{l.updateText((i==null?void 0:i.toString())??t.quantity().toString()),p.visible=t.maxArmour()>0&&t.armour()<=0})});return s.on("destroy",()=>{g()}),{view:s,interact:d}},Pn=(o,t)=>{const i=new K;return i.roundRect(-2.5,-2.5,o.view.width+2.5*2,o.view.height+2.5,10),i.fill(t??"gray"),i.alpha=.8,i.eventMode="static",i},qt=(o,t)=>{const e=new $;e.addChild(o.view),e.label=`${o.view.label}-container`,e.eventMode="static";const i=Pn(o,t);return e.addChild(i,o.view),{container:e,background:i}},Nn=o=>{const t=new $,e=10;t.label="global-inventory-view",t.eventMode="static";const i=jt({text:o.ownerName(),fontSize:26,disableBackground:!0}),n=q.from("text-background.png"),s=q.from("text-background.png"),u=new K;t.addChild(n,s,i,u);const c=()=>{n.width=a.width,n.height=i.height,s.width=a.width,s.height=g.height*1.3,s.position.set(0,a.height+g.height*1.6),u.clear(),u.label="title-background-stroke",u.rect(n.x,n.y,n.width,n.height),u.rect(s.x,s.y,s.width,s.height),u.stroke({color:"khaki",width:2})},l=innerWidth<innerHeight,a=new ce({width:l?innerWidth:innerWidth*.8,height:l?innerHeight*.6:innerHeight*.8,padding:e,radius:10,elementsMargin:e}),h=pt({spriteName:"eye-icon",onClick:()=>{o.setInfoButtonEnabled(!o.isInfoButtonEnabled()),h.tint=o.isInfoButtonEnabled()?"lightgreen":"white"},disableFlicker:!0});t.addChild(h),a.label="global-inventory-scroll-box",a.position.set(0,i.height+e),t.addChild(a),t.visible=!1;const r=(v,E)=>E.weapon().id()===v.id()||E.bodyArmour().id()===v.id()||E.headArmour().id()===v.id()||E.feetArmour().id()===v.id(),f=v=>{v=v??!1,a.removeItems();const E=1.5;o.stacks().forEach(C=>{const A=$t({viewModel:C.item,includeItemValue:v,quantity:C.quantity}),M=new $,N=o.owner?r(C.item,o.owner):!1,_=qt(A,N?"lightgreen":"gray");M.on("pointertap",()=>{m()}),M.addChild(_.background,_.container),M.label=`${A.view.label}-container`,a.addItem(M);const b=Math.min(E,Math.min((a.width-e*2)/M.width,(a.height-e*2)/M.height));M.scale.set(b),A.view.off("pointertap");const m=()=>{if(o.isInfoButtonEnabled()){O.emit("ON_INFO_MODAL_OPEN",{title:C.item.name(),content:C.item.description(),type:C.item.type()});return}A.interact();const T=M.tint;M.tint="green",setTimeout(()=>{M.tint=T},200)}})},p=(v=!1)=>{f(v),o.setInfoButtonEnabled(!1),tt.play("audio/sfx/inventory-open.wav",{category:"gameplay"}),t.visible=!0},d=()=>{o.setInfoButtonEnabled(!1),O.emit("ON_CLOSE_INVENTORY_REQUESTED")},g=pt({spriteName:"exit-icon",onClick:()=>{o.setInfoButtonEnabled(!1),O.emit("ON_CLOSE_INVENTORY_REQUESTED")}});if(i.position.set(t.width*.5,i.height*.5),g.position.set(a.width-g.width,a.height+g.height*2),h.position.set(g.position.x-h.width-5,g.position.y),t.addChild(g),o.ownerName()!=="Hero"){const v=pt({spriteName:"take-all-icon",onClick:()=>{o.items().forEach(E=>{E.interact()}),tt.play("audio/sfx/inventory-open.wav",{category:"gameplay"})},onClickAudio:""});v.position.set(v.width*.4,g.y),t.addChild(v)}const y=Math.max(.6,Math.min(innerWidth/t.width,innerHeight/t.height));return t.scale.set(Math.min(.6,y)),at(()=>{lt(()=>{o.isEmpty()&&d(),o.isInfoButtonEnabled()||O.emit("ON_INFO_MODAL_CLOSE"),f(),i.position.set(a.width*.5,i.height*.5),g.position.set(a.width-g.width,a.height+g.height*2),h.position.set(g.position.x-h.width-5,g.position.y),c()})},t),{view:t,show:p,hide:d}},On=o=>{const{viewModel:t}=o,e=new $;e.label="new-trade-view",e.alpha=0;const i=new K;i.label="new-trade-view-background",e.addChild(i);const n=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let s=!1;const u=({title:b,stacks:m,width:T,height:w,playerStacks:x,npcInv:k=!1,includeItemValue:B=!1,isTradeInv:S=!1})=>{const L=new $;L.label=`${b}-screen-view`;const P=q.from("text-background.png");P.label=`${b}-title-background`;const I=new K;I.label=`${b}-title-background-outline`;const R=jt({text:b,disableBackground:!0,onClick:()=>{}});R.label=`${b}-title-button`;const D=new ce({width:T,height:w,padding:4,elementsMargin:2});D.label=`${b}-inventory-view`;const W=new K;W.label=`${b}-background`,L.addChild(W,P,R,D,I);const X=(z,H,J)=>{const nt=innerHeight>innerWidth;z.forEach(V=>{const F=$t({viewModel:V.item,includeItemValue:B,itemValue:t.getItemPrice(V.item,J),quantity:V.quantity}),et=qt(F,H==="buy"||H==="buy-return"?"pink":"lightblue"),st=new $;F.view.off("pointertap"),st.on("pointertap",()=>{ct(),O.emit("ON_ITEM_INTERACTION",{itemViewModel:V.item,action:H}),s=!0}),st.addChild(et.container,F.view),st.label=`${F.view.label}-container`,D.addItem(st);const ft=nt?.6:.7;st.scale.set(Math.min(ft,T/(F.view.width+10)),Math.min(ft,w/(F.view.height+10)));const ct=()=>{st.tint=65280,setTimeout(()=>{st.tint=16777215},200)}})};return k?X(m,"buy",!0):S?(X(x||[],"sell-return",!1),X(m,"buy-return",!0)):X(m,"sell",!1),R.scale.set(.4),R.position.set(T*.5,R.height*.5),D.position.set(T*.5-D.width*.5,R.height+10),P.x=D.width*.025,P.width=D.width*.95,P.height=R.height,I.rect(P.x,0,P.width,P.height),I.stroke({color:"khaki",width:2}),W.rect(0,0,L.width,L.height),W.label=`${b}-background-rect`,W.fill("black"),W.stroke("black"),L};let c=null,l=null,a=null,h=null,r=null,f=null,p=null,d=null,g=null,y=null;const v=q.from("text-background.png");v.label="trade-buttons-container-background";const E=new K;E.label="trade-buttons-container-background-outline";const C=()=>{c||l?M():tt.play("audio/sfx/door.mp3");const{innerWidth:b,innerHeight:m}=window,T=m>b,w=T?b:b*.9*.3,x=T?m*.7*.3:m*.9;n(),r=pt({spriteName:"trade-icon",onClick:()=>{O.emit("ON_TRADE_REQUEST",{action:"autoTrade"}),s=!0},alpha:.8}),h=pt({spriteName:"exit-icon",onClick:()=>{O.emit("ON_CLOSE_INVENTORY_REQUESTED"),s=!0},alpha:.8});const k=()=>{y&&(e.removeChild(y),y.destroy(),y=null)},B=()=>{const P=Math.abs(t.value().quantity()),I=t.value().quantity()<0?{type:"Insufficient Funds",content:"You do not have enough funds to complete this trade."}:{type:"Trade Imbalance",content:`Trader has insufficient funds, you will lose ${P} ${P>1?"coins":"coin"}.`};y=Fe({title:"Confirm Trade",type:I.type,content:I.content,onConfirm:t.value().quantity()>0?()=>{O.emit("ON_TRADE_REQUEST",{action:"submit"}),s=!0,k()}:void 0,onCancel:()=>{O.emit("ON_TRADE_REQUEST",{action:"clear"}),k(),s=!0}}),e.addChild(y),y.position.set(e.width*.5-y.width*.25,e.height*.5-y.height*.5)};f=pt({spriteName:"confirm-icon",onClick:()=>{O.emit("ON_TRADE_REQUEST",{action:"submit"}),s=!0},alpha:.8}),p=pt({spriteName:"cancel-icon",onClick:()=>{if(t.npcTradeItems().isEmpty()&&t.playerTradeItems().isEmpty()){O.emit("ON_CLOSE_INVENTORY_REQUESTED"),s=!0;return}O.emit("ON_TRADE_REQUEST",{action:"clear"}),s=!0},alpha:.8});let S="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?S="green":t.value().quantity()>0?S="yellow":S="red");const L=$t({viewModel:t.value()});g=qt(L,S).container,d=new $,d.label="trade-buttons-container",d.addChild(h,f,p,r),e.addChild(v,d,E),c=u({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:w,height:x,includeItemValue:!0,isTradeInv:!1}),e.addChild(c),c.label="player-trade-screen",l=u({title:"Trader",stacks:t.npcInventory().stacks(),width:w,height:x,npcInv:!0,includeItemValue:!0,isTradeInv:!1}),e.addChild(l),l.label="npc-trade-screen",a=u({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:w,height:x,includeItemValue:!0,isTradeInv:!0}),e.addChild(a),e.alpha=1,a.label="trade-screen",t.isConfirmationModalVisible()&&B()},A=(b=!1)=>{!d||!h||(E.clear(),b?(v.angle=90,v.height=h.height*1.4,v.width=d.height,v.position.set(d.x+v.height,d.y-h.height*.2-5),E.rect(v.x-v.height,v.y,v.height,v.width)):(v.angle=0,v.width=d.width,v.height=h.height*1.4,v.position.set(d.x-17,d.y+5),E.rect(v.x,v.y,v.width,v.height)),E.stroke({color:"khaki",width:2}))},M=()=>{c&&(e.removeChild(c),c.destroy(),c=null),l&&(e.removeChild(l),l.destroy(),l=null),a&&(e.removeChild(a),a.destroy(),a=null),h&&(e.removeChild(h),h.destroy(),h=null),f&&(e.removeChild(f),f.destroy(),f=null),p&&(e.removeChild(p),p.destroy(),p=null),r&&(e.removeChild(r),r.destroy(),r=null),d&&(e.removeChild(d),d.destroy(),d=null),g&&(e.removeChild(g),g.destroy(),g=null),y&&(e.removeChild(y),y.destroy(),y=null),e.alpha=0},N=(b,m)=>{if(e.alpha===0||!c||!l||!a)return;if(m>b){if(c.position.set(0,0),a.position.set(0,c.y+c.height+2),l.position.set(0,a.position.y+a.height+2),d){const w=b-20,x=d.children,k=x.reduce((L,P)=>L+P.width,0)+((g==null?void 0:g.width)??0),B=Math.min(30,x.length>1?(w-k)/x.length:0);let S=0;x.forEach(L=>{L.position.set(S,L.height*.5),S+=L.width+B}),g&&(d.addChild(g),g.position.set(d.width,g.height*.2)),d.position.set(b*.5-d.width*.5+15,l.position.y+l.height),A()}}else if(c.position.set(0,0),a.position.set(2+c.position.x+c.width,0),l.position.set(2+a.position.x+a.width,0),d){const w=m-20,x=d.children,k=x.reduce((L,P)=>L+P.height,0)+((g==null?void 0:g.height)??0),B=Math.min(30,x.length>1?(w-k)/x.length:0);let S=0;x.forEach(L=>{L.position.set(L.width*.5,S),S+=L.height+B}),g&&(d.addChild(g),g.position.set(g.width*.35,d.height-10)),d.position.set(l.position.x+l.width,m*.5-d.height*.5+20),A(!0)}};return{view:e,show:C,hide:M,resize:N,update:()=>{!s&&!t.isAutoTrading()||(s=!1,e.alpha!==0&&(C(),N(innerWidth,innerHeight)))}}},Rn=o=>{const{viewModel:t}=o,e=new $,i=[],n=new $;e.addChild(n),n.label="icons-container",e.visible=t.isVisible();const s=new K;s.rect(0,0,innerWidth,64),s.fill("black"),s.alpha=0,e.addChild(s);const u=[],c=()=>{n.removeChildren(),n.destroy({children:!0}),s.destroy(),e.removeChildren(),e.destroy({children:!0}),u.forEach(_=>_.kill())},l=_=>{const b=new $;b.label=`${_}-icon`,b.eventMode="static";const m=new K;m.circle(0,0,32),m.stroke({color:"khaki",width:4}),m.fill("khaki"),m.alpha=.5,b.addChild(m);const T=q.from(`${_}-icon.png`);return T.anchor.set(.5),T.width=32,T.height=32,i.push(b),b.addChild(T),n.addChild(b),b},a=l("city-key");a.on("pointertap",()=>{const _=t.canUnlockSettlement();_&&(tt.play("audio/sfx/sfx-unlock.wav"),O.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:_,action:"unlock"}))});const h=l("talk");h.on("pointertap",()=>{tt.play("audio/sfx/click.wav"),O.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:t.canInteractWithCharacter()??void 0,action:"talk"})}),h.visible=t.canInteractWithCharacter()!==null;const r=l("trade");r.on("pointertap",()=>{const _=t.canTradeWithCharacter();if(_){O.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:_,action:"trade"});return}const b=t.canTradeWithSettlement();b&&(tt.play("audio/sfx/click.wav"),O.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:b,action:"trade"}))}),r.visible=t.canTradeWithCharacter()!==null||t.canTradeWithSettlement()!==null;const f=l("settlement");f.on("pointertap",()=>{const _=t.canVisitSettlement();_&&(tt.play("audio/sfx/click.wav"),O.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:_,action:"trade"}))});const p=l("attack");p.on("pointertap",()=>{const _=t.canAttackCharacter();_&&O.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:_,action:"attack"})});const d=l("ranged-attack");d.on("pointertap",()=>{const _=t.canRangedAttackCharacter();_&&O.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:_,action:"attack"})});const g=l("loot");g.on("pointertap",()=>{const _=t.canLoot();_&&O.emit("ON_INVENTORY_REQUEST",{inventory:_,action:"open"})});const y=l("search");y.on("pointertap",()=>{const _=t.canSearch();_&&O.emit("ON_EVENT_INTERACTION",{eventViewModel:_})});const v=l("rest");v.on("pointertap",()=>{t.canRestAtSettlement()&&(tt.play("audio/sfx/click.wav"),O.emit("ON_LEVEL_COMPLETED"))});const E=()=>{let b=0;i.filter(m=>m.visible).forEach((m,T)=>{m.x=T*(m.width+16),m.y=(e.height-m.height)/2,b=T}),n.x=32+(innerWidth-(b+1)*(i[0].width+16))/2},C=async _=>{_.scale.set(0),_.alpha=0,_.visible=!0;const b=1,m=1.15,T=500,w=T*.7,x=T*.3;u.push(j.to(_,{alpha:1,duration:T/1e3,ease:"power1.inOut",onUpdate:()=>{E()}}));const k=j.to(_.scale,{x:m,y:m,duration:w/1e3,ease:"power1.inOut"});u.push(k),await k,u.push(j.to(_.scale,{x:b,y:b,duration:x/1e3,ease:"power1.inOut"}))},A=(_,b)=>{s.clear(),s.rect(0,0,_,64),s.fill("black"),s.alpha=0,E()},M=(_,b)=>{!_.visible&&b()?(_.visible=!0,C(_)):_.visible=b()!==null},N=()=>{e.visible=t.isVisible(),M(h,()=>t.canInteractWithCharacter()),M(r,()=>t.canTradeWithCharacter()||t.canTradeWithSettlement()),M(f,()=>t.canVisitSettlement()),M(p,()=>t.canAttackCharacter()),M(d,()=>t.canRangedAttackCharacter()),M(g,()=>t.canLoot()),M(y,()=>t.canSearch()),M(a,()=>t.canUnlockSettlement()),M(v,()=>t.canRestAtSettlement()),E()};return at(()=>{lt(()=>{N()})},e),{view:e,resize:A,destroy:c}},Vn=o=>{let t=[];const e=new $;e.label="grid-container";const i=()=>{const c=innerWidth<innerHeight,l=30,a=c?(innerWidth-40)/2:innerWidth-15,h=12,r=l+10;t.forEach((f,p)=>{const d=Math.floor(p/(c?2:1)),g=p%(c?2:1);f.icon.position.set(g*a,d*(f.icon.height+h)),f.stats.position.set(f.icon.x+l*.5+r,f.icon.y+(f.icon.height-f.stats.height)/2),f.stats.scale.set(1);const y=a-r-10;f.stats.width>y&&(f.stats.width=y)}),u()},n=c=>{const{icon:l,stats:a}=c,h=Math.floor(t.length/(innerWidth<innerHeight?2:1)),r=t.length%(innerWidth<innerHeight?2:1);t.push({icon:l,stats:a,row:h,column:r}),i()},s=()=>{t=[],e.removeChildren()},u=()=>{e.removeChildren(),t.forEach(c=>{const l=new K;l.roundRect(c.icon.x-5,c.icon.y-5,c.icon.width+10,c.icon.height+10,5),l.fill("khaki"),l.stroke(16777215),l.alpha=.5,l.label="icon-background",e.addChild(l,c.icon,c.stats)})};return i(),{gridContainer:e,addDataToGrid:n,resize:i,renderGrid:u,clearDataFromGrid:s}},De=(o,t)=>{const e=new $,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},n=new Mt,s=new K;n.text=o,n.style=i;const u=()=>{s.clear(),s.roundRect(n.x-10,n.y,n.width+20,n.height,10),s.fill("black"),s.alpha=.5};e.addChild(s,n);const c=l=>{n.text=l,u()};return u(),{view:e,updateText:c}},Ln=()=>{const o=document.createElement("canvas");o.width=256,o.height=1;const t=o.getContext("2d"),e=t.createLinearGradient(0,0,o.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,o.width,1),ze.from(o)},Bn=o=>{const{playerUiVM:t}=o,e=40,i=10,n=new $;n.label="player-ui-view";const s=Vn(),u=(z,H,J,nt,V)=>{const F=new $,Y=new K,et=1;Y.rect(0,0,200,20),Y.fill(0),Y.stroke(16777215);const st=190/H,ft=new K;for(let ct=z>H?H-1:z-1;ct>=0;ct--)ft.rect(5+ct*st,5,st-et,10),ct>=z-4?ft.fill(J):ct>=z-7&&V?ft.fill(V):ft.fill(nt);return F.addChild(Y,ft),F},c=()=>{n.visible=!0},l=()=>{n.visible=!1},a=q.from("health-icon.png");a.label="health-icon",a.anchor.set(.5),a.width=e,a.height=e;const h=q.from("torch-icon.png");h.label="torch-icon",h.anchor.set(.5),h.scale.set(.1);const r=De(`$ ${t.inventoryValue().toString()}`,{fill:"gold",fontSize:20}),f=q.from("coin.png");f.label="inventory-value-icon",f.anchor.set(.5),f.width=e,f.height=e,f.eventMode="static",r.view.eventMode="static",f.onpointertap=r.view.onpointertap=()=>{O.emit("ON_INFO_MODAL_OPEN",{title:"Inventory Value",content:"The total value of all your inventory items.",type:`${t.inventoryValue()}`})};const p=q.from("armour-icon.png");p.label="armour-icon",p.anchor.set(.5),p.width=e,p.height=e;const d=pt({spriteName:"base-portrait",onClick:()=>{O.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})},onClickAudio:""}),g=pt({spriteName:"menu-icon",onClick:()=>{O.emit("ON_IN_GAME_MENU_REQUEST",{action:"open"})}}),y=pt({spriteName:"min-icon",onClick:()=>{O.emit("ON_IN_GAME_MENU_REQUEST",{action:"close"})},onClickAudio:"deselect"}),v=pt({spriteName:"save-icon",onClick:()=>{C.updateText("Saving..."),O.emit("ON_SAVE_REQUEST")}}),E=pt({spriteName:"load-icon",onClick:()=>{C.updateText("Loading..."),O.emit("ON_LOAD_REQUEST")}}),C=De("Game Paused"),A=()=>{g.visible=!1,C.view.visible=!0,y.visible=!0,v.visible=!0,E.visible=!0},M=()=>{g.visible=!0,C.updateText("Game Paused"),C.view.visible=!1,y.visible=!1,v.visible=!1,E.visible=!1};n.addChild(h,a,f,r.view,d,s.gridContainer,p,g,y,v,C.view,E);let N=null,_=null,b=null,m=null,T=null,w=null,x=null;const k=()=>{if(b&&n.removeChild(b),t.maxArmour()<=0||t.armour()<=0){b=null;return}b=u(t.armour(),t.maxArmour(),"blue","blue"),b.position.set(a.width+i,a.y-b.height*.5),b.label="armour-bar",n.addChild(b)},B=()=>{N&&n.removeChild(N),N=u(t.health(),t.maxHealth(),"red","red"),N.label="health-bar",N.position.set(a.width+i,a.y-N.height*.5),n.addChild(N),a.eventMode="static",N.eventMode="static",a.onpointertap=N.onpointertap=()=>{O.emit("ON_INFO_MODAL_OPEN",{title:"Health",content:`You have ${t.health()} health points.`,type:`Max Health: ${t.maxHealth()}`})}},S=z=>{const H=new $,J=20;H.label="stat-container";let nt=0;if(Object.entries(z).forEach(([F,Y],et)=>{et!==0&&(nt+=H.width),Array(Y()).fill(0).forEach((st,ft)=>{const ct=q.from(F+".png");ct.width=J,ct.height=J,ct.position.set(nt+ft*J*.5,0),H.addChildAt(ct,0)})}),H.width===0)return H;const V=new q(Ln());return V.x=H.x-5,V.y=H.y-5,V.width=H.width+64,V.height=H.height+10,V.label="row-gradient-background",H.addChildAt(V,0),H},L=()=>{const z=t.weapon();m?m.removeChildren():(m=new $,m.label="weapon-icon",n.addChild(m));const H=q.from(z.code()+".png");H.width=e,H.height=e;const J=S({"damage-icon":()=>z.damage(),"range-icon":()=>z.range()});return H.eventMode="static",J.eventMode="static",H.onpointertap=m.onpointertap=()=>{O.emit("ON_INFO_MODAL_OPEN",{title:"Weapon",content:`${z.name()!=="Fists"?z.name():"Nothing"} equipped.`,type:`Damage: ${z.damage()}, Range: ${z.range()}`})},{icon:H,stats:J}},P=()=>{const z=t.bodyArmour();T?T.removeChildren():(T=new $,T.label="armour-icon",n.addChild(T));const H=q.from(z.code()+".png");H.width=e,H.height=e;const J=S({"armour-icon":()=>z.armour()});return H.eventMode="static",J.eventMode="static",H.onpointertap=p.onpointertap=()=>{O.emit("ON_INFO_MODAL_OPEN",{title:"Body",content:`${z.armour()===0?"Not protected":`Wearing ${z.name()}`}`,type:`Armour: ${z.armour()}`})},{icon:H,stats:J}},I=()=>{const z=()=>{O.emit("ON_INFO_MODAL_OPEN",{title:"Head",content:`${t.headArmour().armour()===0?"Not protected":`Wearing ${t.headArmour().name()}`}`,type:`Armour: ${t.headArmour().armour()}`})},H=t.headArmour();w?w.removeChildren():(w=new $,w.label="head-armour-icon",n.addChild(w));const J=H.code()==="head"?"base-portrait":H.code(),nt=q.from(J+".png");nt.width=e,nt.height=e;const V=S({"armour-icon":()=>H.armour()});return nt.eventMode="static",V.eventMode="static",nt.onpointertap=p.onpointertap=()=>{z()},{icon:nt,stats:V}},R=()=>{const z=t.feetArmour();x?x.removeChildren():(x=new $,x.label="feet-armour-icon",n.addChild(x));const H=q.from(z.code()+".png");H.width=e,H.height=e;const J=S({"armour-icon":()=>z.armour()});return H.eventMode="static",J.eventMode="static",H.onpointertap=p.onpointertap=()=>{O.emit("ON_INFO_MODAL_OPEN",{title:"Feet",content:`${z.armour()===0?"Not protected":`Wearing ${z.name()}`}`,type:`Armour: ${z.armour()}`})},{icon:H,stats:J}},D=()=>{O.emit("ON_INFO_MODAL_OPEN",{title:"Torch",content:`You have ${t.torchLeft()} torches left.`,type:"Light"})},W=()=>{_&&n.removeChild(_),_=u(t.torchLeft(),30,"red","brown","khaki"),_.label="torch-bar",N&&_.position.set(N.x,h.y-7),n.addChild(_),h.eventMode="static",_.eventMode="static",h.onpointertap=_.onpointertap=()=>{D()}},X=()=>{a.position.set(10,10),p.position.set(10,10),N&&(N.position.set(a.width+i,a.y-N.height*.5),r.view.position.set(N.x,f.y-r.view.height*.5),b&&b.position.set(N.x,N.y)),_&&N&&_.position.set(N.x,h.y-7),h.position.set(10,a.height+15),f.position.set(10,h.y+h.height),s.resize(),s.gridContainer.position.set(0,f.y+f.height*.5+10),d.position.set(innerWidth-(d.width+32),20),g.position.set(innerWidth-(g.width+32),d.y+d.height+10),y.position.set(g.x,g.y),v.position.set(g.x,g.y+g.height+10),E.position.set(g.x,v.y+v.height+10),C.view.position.set(innerWidth/2-C.view.width/2,innerHeight/2-20),n.position.set(20,20)};return M(),X(),at(()=>{lt(()=>{B(),k(),t.torchLeft()>=0&&W(),t.isSaveCompleted()?C.updateText("Save completed"):C.updateText("Game Paused"),p.visible=t.maxArmour()>0&&t.armour()>0,t.isInGameMenuVisible()?A():M(),t.isInventoryValueVisible()?(f.visible=!0,g.visible=!1,r.view.visible=!0,s.gridContainer.visible=!0,s.clearDataFromGrid(),s.addDataToGrid(I()),s.addDataToGrid(L()),s.addDataToGrid(P()),s.addDataToGrid(R())):(f.visible=!1,y.visible||(g.visible=!0),r.view.visible=!1,s.gridContainer.visible=!1),r.updateText(`$ ${t.inventoryValue().toString()}`),X()})},n),{view:n,show:c,hide:l,resize:X}},Wn=o=>{const{viewModel:t}=o,e=new $;e.label="new-trade-view";const i=new K;i.label="new-trade-view-background",e.addChild(i);const n=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let s=!1;const u=({title:y,stacks:v,width:E,height:C,playerStacks:A,npcInv:M=!1,includeItemValue:N=!1,isTradeInv:_=!1})=>{const b=new $;b.label=`${y}-screen-view`;const m=jt({text:y,onClick:()=>{}});m.label=`${y}-title-button`;const T=new ce({width:E,height:C,padding:4,elementsMargin:2});T.label=`${y}-inventory-view`;const w=new K;w.label=`${y}-background`,b.addChild(w,m,T);const x=(k,B,S)=>{k.forEach(L=>{const P=$t({viewModel:L.item,includeItemValue:N,itemValue:t.getItemPrice(L.item,S),quantity:L.quantity}),R=qt(P,B==="buy"||B==="buy-return"?"pink":"lightblue"),D=new $;P.view.off("pointertap"),D.on("pointertap",()=>{W(),O.emit("ON_ITEM_INTERACTION",{itemViewModel:L.item,action:B}),s=!0}),D.addChild(R.container,P.view),D.label=`${P.view.label}-container`,T.addItem(D);const W=()=>{D.tint=65280,setTimeout(()=>{D.tint=16777215},200)}})};return M?x(v,"buy",!0):_?(x(A||[],"sell-return",!1),x(v,"buy-return",!0)):x(v,"sell",!1),m.scale.set(.4),m.position.set(E*.5,m.height*.5),T.position.set(E*.5-T.width*.5,m.height+10),w.rect(0,0,b.width,b.height),w.fill("black"),w.stroke("black"),b};let c=null,l=null,a=null,h=null,r=null;const f=()=>{c?p():tt.play("audio/sfx/door.mp3");const{innerWidth:y,innerHeight:v}=window,E=v>y,C=E?y:y*.35,A=E?v*.35:v;n(),a=jt({text:"Continue",onClick:()=>{a.eventMode="none",O.emit("ON_TRADE_REQUEST",{action:"confirm-bulk-trade"}),j.delayedCall(.5,()=>{O.emit("ON_CLOSE_INVENTORY_REQUESTED")}),s=!0}}),a.alpha=0,a.label="continue-button";let M="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?M="green":t.value().quantity()>0?M="yellow":M="red");const N=$t({viewModel:t.value()});r=qt(N,M).container,h=new $,h.label="trade-buttons-container",h.addChild(a,r),a.scale.set(.4),e.addChild(h),c=u({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:C,height:A,includeItemValue:!0,isTradeInv:!1}),e.addChild(c),c.label="player-trade-screen",l=u({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:C,height:A,includeItemValue:!0,isTradeInv:!0}),e.addChild(l),l.label="trade-screen",a&&(a.alpha=t.isContinueButtonVisible()?1:0),e.visible=!0},p=()=>{c&&(e.removeChild(c),c.destroy(),c=null),l&&(e.removeChild(l),l.destroy(),l=null),a&&(e.removeChild(a),a.destroy(),a=null),h&&(e.removeChild(h),h.destroy(),h=null),r&&(e.removeChild(r),r.destroy(),r=null),e.visible=!1},d=(y,v)=>{if(!e.visible||!c||!l)return;v>y?(c.position.set(0,0),l.position.set(0,c.y+c.height+2),r&&a&&(r.position.set(-r.width*.5,-r.height*.5),a.position.set(r.x+r.width+a.width*.5,0)),h&&h.position.set(y*.5-h.width*.5,l.position.y+l.height+h.height*.5+10)):(c.position.set(0,0),l.position.set(2+c.position.x+c.width,0),r&&a&&(r.position.set(0,0),a.position.set(20,r.y+r.height+30)),h&&h.position.set(l.position.x+l.width+h.width*.5,v*.5-h.height*.5))};return{view:e,show:f,hide:p,resize:d,update:()=>{a&&(a&&(a.alpha=t.isContinueButtonVisible()?1:0),a.alpha===1&&!s)||!s&&!t.isAutoTrading()||(s=!1,e.visible&&(f(),d(innerWidth,innerHeight)))}}},Dn=o=>{const t=o.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2");return t.charAt(0).toUpperCase()+t.slice(1)},Hn=o=>{const t=gt().log;let e=[],i=!0;const n=new $;n.label="log-view",n.alpha=0;const s=new $;s.label="log-grid-layout",n.addChild(s);const u=new K;s.addChild(u);const c=()=>{if(e.length>0){e.forEach(g=>g()),e=[];return}d()},l=async g=>{var _;const y=s.children.length,v=innerWidth/2-20,E=new Mt,C=g.name.toLowerCase().includes("value");E.style={fontFamily:"alagard",fontSize:20,fill:"black"},E.text=Dn(g.name),E.position.set(10,y*15);const A=new $;A.label="log-value-container",A.position.set(v+(innerWidth<innerHeight?100:0),E.y);const M=new Mt;M.style={fontFamily:"alagard",fontSize:18,fill:"black"},M.text=C?"$":"",M.text+=g.value??((_=g.to)==null?void 0:_.toString())??"",A.addChild(M),s.addChild(E),s.addChild(A),E.alpha=0,A.alpha=0,!await new Promise(b=>{j.delayedCall(g.index*.5,()=>{i||b(!0),e.shift(),b(!1)}),e.push(()=>b(!0))})&&i&&tt.play("audio/sfx/sfx-thud.mp3"),E.alpha=1,A.alpha=1};Object.entries(t).sort((g,y)=>g.toLocaleString().localeCompare(y.toLocaleString())).forEach(([g,y],v)=>{l(typeof y=="string"?{name:g,value:y,index:v}:{name:g,to:y,index:v})});const a=5;u.roundRect(-5,-5,s.width+30+a*2,s.height+30+a*2,30),u.fill("khaki"),n.eventMode="static",n.on("pointertap",()=>{c()});const h=new Mt;h.text="Tap to continue",h.style={fontFamily:"alagard",fontSize:20,fill:"white"};const r=innerHeight>innerWidth;h.position.set(r?(n.width-h.width)*.5:n.width+40,r?n.height+20:n.height*.5),n.addChild(h);const f=()=>{i=!0,n.visible=!0,n.alpha=0,j.to(n,{alpha:1,duration:.5,ease:"power2.out"})},p=()=>{i=!1},d=()=>{i=!1,j.to(n,{alpha:0,duration:.5,ease:"power2.in",onComplete:()=>{n.visible=!1,o()}})};return{view:n,destroy:p,show:f,hide:d,handleAnyPress:c}},Un=o=>{const t=new $,{playerMenuVM:e}=o;let i=null,n=null,s=null,u=null,c=null,l=null,a=0,h;const r=()=>{h&&(t.removeChild(h),h.destroy(),h=void 0,O.emit("ON_RESUME_INPUT"))},f=S=>{r(),O.emit("ON_PAUSE_INPUT"),h=Fe({title:S.title,content:S.content,type:S.type,contentStyle:S.contentStyle??p,onClose:()=>{S.onClose&&S.onClose(),r()},onConfirm:S.onConfirm}),t.addChild(h),h.position.set(t.width*.5-h.width*.25,t.height*.5-h.height*.5)},p={fontSize:20,fill:"white",fontFamily:"alagard",align:"center"},d=new K;d.label="background",d.alpha=0,d.on("pointertap",()=>{l==null||l.handleAnyPress()}),t.addChild(d);const g=()=>{d.clear(),d.rect(0,0,innerWidth,innerHeight),d.fill("black")},y=()=>{r(),w(),m(),d.alpha=0},v=()=>{u&&(u.view.visible=!1),d.alpha=0},E=()=>{v(),N(),C(),d.alpha=1,l=Hn(()=>{C(),O.emit("ON_LEVEL_COMPLETED")});const S=Math.min(1,Math.min(innerWidth/l.view.width,innerHeight/l.view.height));l.view.scale.set(S),l.view.position.set(innerWidth*.5-l.view.width*.5,innerHeight*.5-l.view.height*.5),t.addChild(l.view),l.show(),d.eventMode="static"},C=()=>{d.eventMode="none",l&&(l.destroy(),t.removeChild(l.view),l.view.destroy({children:!0}),l=null)},A=()=>{const S=o.playerUiVM();if(!S)return;if(u){u.view.position.set(30,30),u.view.visible=!0;return}u=Bn({playerUiVM:S});const L=Math.min(1,Math.min(innerWidth/u.view.width,innerHeight/u.view.height));u.view.scale.set(L),u.view.position.set(30,30),a=t.children.length,t.addChild(u.view),u.view.visible=!0,u.view.label="player-ui-view"},M=()=>{const S=e();if(!S)return;n||(n=Rn({viewModel:S}),t.addChild(n.view));const L=Math.min(1,Math.min(innerWidth/n.view.width,innerHeight/n.view.height));n.view.scale.set(L),n.view.position.set(innerWidth*.5-n.view.width*.5,innerHeight*.9-n.view.height*.5),n.view.visible=!0},N=()=>{n&&(n.view.visible=!1),d.alpha=0},_=S=>{m(),N(),v(),d.alpha=1,s=Wn({viewModel:S}),t.addChild(s.view),s.show()},b=S=>{m(),N(),v(),d.alpha=1,s=On({viewModel:S}),t.addChild(s.view),s.show(),x(innerWidth,innerHeight)},m=()=>{M(),A(),s&&(t.removeChild(s.view),s.view.destroy(),s=null),d.alpha=0,x(innerWidth,innerHeight)},T=S=>{if(N(),d.alpha=1,c&&!S)S=c;else if(!S)throw new Error("No inventory provided to showInventory");c=S,setTimeout(()=>{i=Nn(S),i.show(),t.addChildAt(i.view,a),x(innerWidth,innerHeight)},10)},w=(S=!0)=>{M(),i&&(t.removeChild(i.view),i.view.destroy(),i=null),S&&(c=null),d.alpha=0},x=(S,L,P=!1)=>{g();const I=L>S;if(s){s.show(),s.resize(S,L);const R=I?Math.min(1,L/s.view.height):Math.min(1,S/s.view.width);s.view.scale.set(R);const D=I?(t.width-s.view.width)*.5:0,W=I?0:(t.height-s.view.height)*.5;s.view.position.set(D,W)}if(n&&(n.resize(S,L),n.view.position.set(S*.5-n.view.width*.5,L*.9-n.view.height*.5)),u&&u.resize(),l&&E(),i&&u){if(P){w(!1),T();return}const R=I?(S-i.view.width)*.5:u.view.width*.5,D=I?u.view.y+u.view.height+10:(L-i.view.height)*.5;i.view.position.set(R,D)}h&&h.position.set(t.width*.5-h.width*.25,t.height*.5-h.height*.5)},k=()=>{s==null||s.update()};return t.label="user-interface-view",g(),{showInventory:T,hideInventory:w,showTrade:b,hideTrade:m,showBulkTrade:_,view:t,closeAll:y,showPlayerMenu:M,hidePlayerMenu:N,showPlayerUi:A,resize:x,destroy:()=>{t.removeChildren(),d.destroy(),i=null,n==null||n.destroy(),n=null,s=null,u=null},update:k,showEndOfLevelLog:E,hideEndOfLevelLog:C,showInfoModal:f,hideInfoModal:r}},$n=()=>{const o=re.map(e=>(e.code()==="torch"&&e.updateQuantity(11),kt(e.code()))),t=Yt(o);return _t({model:t,ownerName:"Global Inventory"})},qn=o=>{const{playerVM:t,tileMapVM:e}=o,i=(c,l)=>{const a=t.position().x+c,h=t.position().y+l;if(a<=0&&a>=e.tiles().length-1&&h<=0&&h>=e.tiles()[0].length-1)return;const r=e.tiles()[a][h];r&&O.emit("ON_TILE_INTERACTION",{tileViewModel:r})},n=c=>{switch(c){case"endLevel":O.emit("ON_LEVEL_COMPLETED");break;case"showInventory":O.emit("ON_INVENTORY_REQUEST",{inventory:$n(),action:"open"});break;case"showCharacterDetails":console.debug("Showing character details");break;case"moveLeft":i(-1,0);break;case"moveRight":i(1,0);break;case"moveUp":i(0,-1);break;case"moveDown":i(0,1);break;default:console.warn(`Unknown action: ${c}`)}},s=c=>{switch(c.key){case"r":O.emit("ON_DEBUG_ACTION_REQUESTED",{action:"endLevel"});break;case"i":O.emit("ON_DEBUG_ACTION_REQUESTED",{action:"showInventory"});break;case"w":O.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveUp"});break;case"s":O.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveDown"});break;case"a":O.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveLeft"});break;case"d":O.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveRight"});break;case"6":O.emit("ON_SAVE_REQUEST");break;case"8":O.emit("ON_LOAD_REQUEST");break}};return document.addEventListener("keypress",s),{handleDebugActionRequest:n,destroy:()=>{document.removeEventListener("keypress",s)}}};function zn(o){const t=[];let e=o;for(;e;)t.unshift(e.tile),e=e.previous;return t}function Ft({start:o,end:t,map:e,maxDistance:i=7}){const n=e.tiles().flat().find(r=>r.position().x===o.x&&r.position().y===o.y),s=e.tiles().flat().find(r=>r.position().x===t.x&&r.position().y===t.y);if(!n||!s)return null;const u=Math.sqrt(Math.pow(s.position().x-n.position().x,2)+Math.pow(s.position().y-n.position().y,2)),c={previous:null,tile:n,g:0},l=r=>{let f=!1,p=r.previous;for(;p;){if(p.tile.position().x===r.tile.position().x&&p.tile.position().y===r.tile.position().y){f=!0;break}p=p.previous}return f},a=[],h=r=>{if(r.tile.position().x===s.position().x&&r.tile.position().y===s.position().y){a.push(r);return}if(r.g>i||r.g>u)return;const f=e.getNeighbors(r.tile),p=r.tile.position();for(const d of f){if(!d.traversable()&&s.traversable())continue;const g=d.position(),y=Math.abs(g.x-p.x),v=Math.abs(g.y-p.y),E=y===1&&v===1?2:1,C=r.g+E;if(C>i)continue;const A={previous:r,tile:d,g:C};l(A)||h(A)}};if(h(c),a.length>0){const r=a.reduce((p,d)=>p.g<d.g?p:d),f=zn(r);if(f.length>0)return f.shift(),f}return[]}const Fn={"bed-time":["follow"],patrol:["bed-time","follow","work"],follow:["attack"],work:["bed-time","patrol","follow"],idle:["bed-time","patrol","follow","work"],attack:["bed-time","patrol","follow","work"],spawn:["bed-time","patrol","follow","work","attack"]},Gn=o=>{const{events:t,playerVM:e,tileMapVM:i,npcTaskController:n,npcs:s,turnVM:u}=o,c=5,l=[],a=(m,T)=>{var x;const w=[];for(let k=m.x-T;k<=m.x+T;k++)for(let B=m.y-T;B<=m.y+T;B++){const S=(x=i.tiles()[k])==null?void 0:x[B];!S||Math.floor(Math.sqrt(Math.pow(S.position().x-m.x,2)+Math.pow(S.position().y-m.y,2)))>T||S.traversable()&&w.push(S.position())}return w},h=(m,T)=>{let x=5,k=null;for(;k===null||k.length===0;)if(k=Ft({start:m,end:T,map:i,maxDistance:x}),x++,x>9)return null;return k},r=m=>{const T=m.position();let w=null;const x=[];for(const k of t){const B=k.position(),S=Math.floor(Math.sqrt(Math.pow(B.x-T.x,2)+Math.pow(B.y-T.y,2)));x.push({event:k,distance:S})}x.sort((k,B)=>k.distance-B.distance);for(let k=0;k<Math.min(3,x.length);k++){const B=x[k].event,S=h(T,B.position());if(S&&S.length>0){w=B;break}}return w||null},f=m=>{m.isAlive()&&(m.setTaskList([n.createSpawnTask(m)]),m.setCanTrade(!1),l.push(m),m.getPatrolArea().length===0&&(m.setPatrolArea(a(m.position(),c)),m.setTaskList([...m.getTaskList(),n.createPatrolTask(m)])))},p=m=>{m.isAlive()&&!m.isHostile(e.team())&&(m.setTaskList([n.createWorkTask(m)]),m.setCanTrade(!0),l.push(m))},d=m=>{if(!m.isAlive()){m.setTask(null);return}if(m.isHostile(e.team())&&m.getPatrolArea().length===0&&(m.setPatrolArea(a(m.position(),c)),m.setTaskList([...m.getTaskList(),n.createPatrolTask(m)])),m.getBedLocation()===null){const T=r(m);T&&m.setBedLocation(T.position())}l.push(m)},g=(m,T)=>{const w=m.getTask();if(!w)return!0;const x=w.name();return(Fn[x]||[]).includes(T)},y=m=>{if(!m.spawnLing())return!1;const T=4;if(m.lastSpawned()===0)return m.setLastSpawned(u.getCurrentTurn()),!1;const w=u.getCurrentTurn()-m.lastSpawned()>=T;if(!w)return!1;if(w){const x=n.createSpawnTask(m);if(x)return m.setTask(x),m.setLastSpawned(u.getCurrentTurn()),!0}return!1},v=m=>{if(!m.isHostile(e.team()))return!1;if(e.isAlive()&&e.position()){const x=Math.floor(Math.sqrt(Math.pow(e.position().x-m.position().x,2)+Math.pow(e.position().y-m.position().y,2)));if(x<=1)return!1;if(x<=4&&g(m,"follow")){const k=m.getTaskList().find(B=>B.name()==="follow")||n.createFollowPlayerTask(m);if(k)return m.setTarget(e),m.setTask(k),!0}}return!1},E=m=>{const T=m.getTask(),w=o.turnVM.getCurrentTimeMin();if(w>=1200||w<480){if(T&&T.name()==="bed-time")return!0;if(g(m,"bed-time")){const x=m.getTaskList().find(k=>k.name()==="bed-time")||n.createBedTimeTask(m);if(x)return m.setTask(x),!0}}return!1},C=m=>{const T=m.getTask();if(o.turnVM.getCurrentTimeMin()>=480){if(T&&T.name()==="patrol")return!0;if(g(m,"patrol")){const x=m.getTaskList().find(k=>k.name()==="patrol");if(x)return m.setTask(x),!0}}return!1},A=m=>{var k;const T=m.getTarget(),w=1;if(!T||!T.isAlive())return m.setTarget(null),!1;if(Math.floor(Math.sqrt(Math.pow(T.position().x-m.position().x,2)+Math.pow(T.position().y-m.position().y,2)))>w)return!1;if(((k=m.getTask())==null?void 0:k.name())==="attack")return!0;if(g(m,"attack")){const B=m.getTaskList().find(S=>S.name()==="attack")||n.createAttackTask(m);if(B)return m.setTask(B),!0}return!1},M=m=>{var T;if(((T=m.getTask())==null?void 0:T.name())==="work")return!0;if(g(m,"work")){const w=m.getTaskList().find(x=>x.name()==="work");if(w)return m.setTask(w),!0}return!1},N=m=>{if(!m.isAlive()){m.setTask(null);return}y(m)||A(m)||v(m)||E(m)||C(m)||M(m)},_=()=>{l.forEach(m=>{if(!m.isAlive())return;N(m);const T=m.getTask();T&&T.name(),T&&T.execute()})};return(()=>{s.forEach(m=>{d(m)})})(),{addNpc:d,addTrader:p,addNestmother:f,playNpcTurn:_}},Qn=({npc:o,attackVM:t})=>({execute:()=>{if(!o.isAlive())return!1;const e=o.getTarget();return!e||!e.isAlive()?(o.setTask(null),!0):Math.floor(Math.sqrt(Math.pow(o.position().x-e.position().x,2)+Math.pow(o.position().y-e.position().y,2)))<=1?(t.attack(o,e),!0):!1},name:()=>"attack"}),Yn=({npc:o,tileMapVM:t,turnVM:e})=>{let i=o.getBedLocation(),n=null;return{execute:()=>{if(o.isAlive()===!1)return!1;if(e.getCurrentTimeMin()>=480&&e.getCurrentTimeMin()<1200)return o.setTask(null),!0;if(!i&&(i=o.getBedLocation(),!i))return!1;if(o.position().x===i.x&&o.position().y===i.y)return!0;if(!n){let u=5;for(;n===null||n.length===0;)if(n=Ft({start:o.position(),end:i,map:t,maxDistance:u}),u++,u>8)return!1}if(n&&n.length>0){const s=n.shift();return s&&(o.moveTo(s.position().x,s.position().y),s.position().x===i.x&&s.position().y===i.y),!0}return!1},name:()=>"bed-time"}},Xn=({npc:o,tileMapVM:t,playerVM:e})=>({execute:()=>{if(o.isAlive()===!1)return!1;const i=e.position(),n=Ft({start:o.position(),end:i,map:t});if(n&&n.length>0){const s=n.shift();if(s)return s.position().x===i.x&&s.position().y===i.y||o.moveTo(s.position().x,s.position().y),!0}return!1},name:()=>"follow"}),jn=({npc:o,tileMapVM:t})=>{let e=o.getPatrolArea(),i=null;return{execute:()=>{if(o.isAlive()===!1||e.length===0||((!i||i.length===0)&&(i=Ft({start:o.position(),end:e[Math.floor(Math.random()*e.length)],map:t})),!i||i.length===0))return!1;const n=i.shift();return n&&o.moveTo(n.position().x,n.position().y),!0},name:()=>"patrol"}},Zn=({npc:o})=>({execute:()=>o.isAlive()===!1?!1:(o.setCanTrade(!0),!0),name:()=>"work"}),Kn=({npc:o,addNpc:t,spawnType:e="worm"})=>({execute:()=>{if(!o.isAlive())return!1;const i=o.position(),n=$e({id:e,team:"hostile-to-player",name:"Spawned "+e.charAt(0).toUpperCase()+e.slice(1),startingSize:1,startPosition:i,startingHealth:1,startingMaxHealth:1,startingItems:[]}),s=ti(n);return t(s),!0},name:()=>"spawn"}),Jn=o=>{const{attackVM:t,tileMapVM:e,turnVM:i,playerVM:n}=o;return{createBedTimeTask:r=>Yn({npc:r,tileMapVM:e,turnVM:i}),createPatrolTask:r=>jn({npc:r,tileMapVM:e}),createFollowPlayerTask:r=>Xn({npc:r,tileMapVM:e,playerVM:n}),createAttackTask:r=>Qn({npc:r,attackVM:t}),createWorkTask:r=>Zn({npc:r}),createSpawnTask:r=>Kn({npc:r,spawnType:"worm",addNpc:o.addNpc})}},Qt=(o,t)=>o.id()===t.id(),to=()=>({use:(o,t)=>{if(o.health()!==0){if(t.health()>=t.maxHealth())return;if(t.id()==="player"){const e=Math.min(o.health(),t.maxHealth()-t.health());gt().log.totalHealing+=e}t.setHealth(t.health()+o.health()),t.inventory().removeItem(o),o.updateQuantity(0);return}o.type()==="weapon"&&(Qt(t.weapon(),o)?t.setWeapon(void 0):t.setWeapon(o)),o.type()==="armour"&&(Qt(t.bodyArmour(),o)?t.setBodyArmour(void 0):t.setBodyArmour(o)),o.type()==="helmet"&&(Qt(t.headArmour(),o)?t.setHeadArmour(void 0):t.setHeadArmour(o)),o.type()==="shoes"&&(Qt(t.feetArmour(),o)?t.setFeetArmour(void 0):t.setFeetArmour(o))}}),eo=()=>{let o=null,t=null;const e=222,[i,n]=G(!1),[s,u]=G(!0),[c,l]=G(!1),[a,h]=G(!1),[r]=G(Ut({model:kt("coin")})),f=_t({model:Yt([]),ownerName:"trade"}),p=_t({model:Yt([]),ownerName:"trade-npc"}),d=(I,R)=>{o=I,t=R,v(b()),v(_())},g=I=>{w().addItem(I,1),f.removeItem(I,1)},y=I=>{x().addItem(I,1),p.removeItem(I,1)},v=I=>{let R;I===f?R=g:R=y,I.items().forEach(D=>{R(D,!0),I.removeItem(D,1)})},E=I=>{const R=w().getItem(I);R&&(f.addItem(R,1),w().removeItem(R,1))},C=I=>{const R=x().getItem(I);R&&(p.addItem(R,1),x().removeItem(R,1))},A=()=>{v(b()),v(_()),r().updateQuantity(0)},M=(I=!1)=>{if(!o||!t)throw new Error("Player or NPC inventory is not set");return!c()&&!a()&&m()!==0?(l(!0),!1):r().quantity()<0?!1:((c()&&!a()||a()&&!c()||m()===0)&&I&&N(),c()&&l(!1),!0)},N=()=>{if(i()){const I=Math.floor(r().quantity());Array(I).fill(0).forEach(()=>{const R=Ut({model:kt("coin")});_().addItem(R)}),I>0&&tt.play("audio/sfx/sfx-sell.mp3")}f.items().forEach(I=>{x().addItem(I,I.quantity()),f.removeItem(I,I.quantity())}),p.items().forEach(I=>{gt().log.tradedItemsValue+=T(I,!0),w().addItem(I,I.quantity()),p.removeItem(I,I.quantity())}),v(b()),v(_()),i()&&n(!1)},_=()=>(r().updateQuantity(m()),p),b=()=>(r().updateQuantity(m()),f),m=()=>{const I=f.stacks().reduce((D,W)=>D+T(W.item,!1)*W.quantity,0),R=p.stacks().reduce((D,W)=>D+Math.max(1,T(W.item,!0)*W.quantity),0);return Math.floor(I)-Math.ceil(R)},T=(I,R)=>{const D=I.value()*I.quantity(),X=R&&!["coin","torch"].includes(I.code())?2:1;return D*X},w=()=>{if(o)return o;throw new Error("Player inventory is not set")},x=()=>{if(t)return t;throw new Error("NPC inventory is not set")},k=async()=>{await B(!1),await j.delayedCall(.2,()=>{}),n(!1)},B=async(I=!0)=>{if(!o||!t)throw new Error("Invalid inventories to auto trade");n(!0);const R=o.stacks().reduce((D,W)=>(W.quantity>0&&W.item.type()==="loot"&&D.push(W),D),[]);for(const D of R){await j.delayedCall(e/1e3,()=>{});for(let W=0;W<D.quantity;W++)I?tt.play("audio/sfx/sfx-sell.mp3",{category:"gameplay"}):tt.play("audio/sfx/collect.wav",{category:"gameplay"}),E(D.item)}};return{isConfirmationModalVisible:c,startTrade:d,cancelTrade:A,acceptTrade:M,playerTradeItems:b,acceptBulkTrade:()=>{a()&&(M(!0),h(!1))},value:r,npcTradeItems:_,playerInventory:w,npcInventory:x,selectItemToBuy:C,selectItemToSell:E,returnItemToPlayer:g,returnItemToNpc:y,clearTrade:()=>{if(c()){l(!1);return}v(b()),v(_()),l(!1),r().updateQuantity(0)},getItemPrice:T,bulkTrade:async()=>{h(!0),await j.delayedCall(.5,()=>{}),u(!1),await B(),await j.delayedCall(.5,()=>{}),u(!0)},autoTrade:k,isAutoTrading:i,isContinueButtonVisible:s}},io=o=>{if(o.length===0)return{x:0,y:0};const t=o.reduce((s,u)=>s+u.x,0),e=o.reduce((s,u)=>s+u.y,0),i=t/o.length,n=e/o.length;return{x:i,y:n}},He=(o,t)=>Math.abs(o.x-t.x)<=1&&Math.abs(o.y-t.y)<=1,no=o=>{let t="idle",e="idle";return{get:()=>t,set:u=>{t!==u&&(e=t,u==="end-turn"?(o(),t="idle"):t=u)},getPrevState:()=>e}},oo=o=>{const{tileMapViewModel:t,playerViewModel:e,userInterfaceView:i,gameView:n,playerUiVM:s,attackVM:u}=o;let c=null,l=null;const a=no(o.onPlayerTurnCompleted),h=to(),r=1,f=()=>e.isAlive()&&a.get()!=="busy",p=w=>{const{action:x,trader:k}=w;if(!(k&&!k.canTrade())&&f()){if(a.set("trading"),k&&!l)if(l=eo(),l.startTrade(e.inventory(),k.inventory()),x==="autoTrade"){l.bulkTrade(),i.showBulkTrade(l);return}else{i.showTrade(l);return}if(l){if(x==="autoTrade"&&l.autoTrade(),x==="clear"){l.clearTrade();return}if(x==="confirm-bulk-trade"){l.acceptBulkTrade();return}x==="submit"&&l.acceptTrade(!0)}}},d=w=>{var x;if(c){c.ownerName()===e.name()&&N();return}if(!l&&f()){if(w.isEmpty()){a.set("idle"),c=null;return}if(w.isOnlyLoot()&&w.ownerName()!==e.name()){i.update(),v(w);return}a.set("inventory-handling"),c=w,i.showInventory(w),(x=s())==null||x.isInventoryValueVisible(!0)}},g=w=>{var x;a.set("busy"),(x=s())==null||x.showInGameMenu(w==="open"),w!=="open"&&a.set(a.getPrevState()||"idle")},y=(w,x)=>{f()&&(a.set("inventory-handling"),x==="open"?d(w):N())},v=w=>{w.items().forEach(x=>{var k;e.inventory().addItem(x),w.removeItem(x),(k=n())==null||k.animateIconFloat(x.code(),e.position())}),tt.play("audio/sfx/inventory-open.wav",{category:"gameplay",volume:1}),c=null,a.set("end-turn")},E=w=>{var L,P;const{settlement:x,action:k}=w,B=x.positions(),S=io(B);if(f()){if(k==="unlock"){const I=e.inventory().getItemByCode("city-key");if(!I)throw new Error("City key is required to unlock the settlement");x.setIsUnlocked(!0),e.inventory().removeItem(I),(L=n())==null||L.createTextBox({id:()=>"settlement",dialogue:()=>"Welcome!",position:()=>({x:S.x,y:S.y})});return}if(k==="trade"&&x.isUnlocked()){p({action:"trade",trader:{canTrade:()=>!x.inventory().isEmpty(),inventory:()=>x.inventory()}});return}(P=n())==null||P.createTextBox({id:()=>"settlement",dialogue:()=>"City key required",position:()=>({x:S.x,y:S.y})})}},C=()=>{l&&(l.cancelTrade(),i.closeAll(),l=null),a.set("idle")},A=w=>{const{action:x,character:k}=w;if(!f()||!k)return;if(x==="talk"){const P=n();if(!P)return;P.createTextBox(k),a.set("idle");return}const B=Math.floor(Math.sqrt(Math.pow(k.position().x-e.position().x,2)+Math.pow(k.position().y-e.position().y,2))),S=B<=r,L=B<=e.weapon().range();if(k.isHostile(e.team())&&L&&k.health()>0){u.attack(e,k),a.set("end-turn");return}if(!S){_(k.position());return}if(!k.inventory().isEmpty()){if(k.canTrade()){p({action:"change-to-buy",trader:k});return}d(k.inventory());return}if(k.inventory().isEmpty()){_(k.position());return}d(k.inventory())},M=(w,x)=>{if(a.get()==="idle"&&f()){if(He(w.position(),e.position())&&(!w.discovered()||!w.inventory().isEmpty())){d(w.inventory()),w.interact(x);return}_(w.position())}},N=()=>{var w,x;if(c){if(c.ownerName()===e.name()){c=null,a.set("idle"),(w=s())==null||w.isInventoryValueVisible(!1),i.hideInventory();return}c=null,a.set("end-turn"),(x=s())==null||x.isInventoryValueVisible(!1),i.hideInventory();return}l&&C(),a.set("idle")},_=({x:w,y:x})=>{if(a.get()!=="idle"||!f())return;const k=e.position();if(He({x:w,y:x},k)&&t.isValidMove(w,x)){b(w-k.x,x-k.y);return}const B=Ft({start:k,end:{x:w,y:x},map:t});if(B&&B.length>1){const S=B[0];b(S.position().x-k.x,S.position().y-k.y)}},b=(w,x)=>{if(a.set("moving"),!f())return;const k=e.position().x+w,B=e.position().y+x;t.isValidMove(k,B)&&e.moveTo(k,B),a.set("end-turn")};return{handlePlayerMoveRequest:_,handleTileInteraction:w=>{a.get()==="idle"&&f()&&_(w.position())},handleCharacterInteraction:A,handleEventInteraction:M,handleItemInteraction:(w,x)=>{var k;if(f()){if(a.get()==="trading"){if(x==="sell"){l==null||l.selectItemToSell(w);return}if(x==="buy-return"){l==null||l.returnItemToNpc(w);return}if(x==="sell-return"){l==null||l.returnItemToPlayer(w);return}if(x==="buy"){l==null||l.selectItemToBuy(w);return}}if(c&&c.ownerName()!==e.name()){e.inventory().addItem(w),c.removeItem(w),(k=n())==null||k.animateIconFloat(w.code(),e.position());return}h.use(w,e)}},handleCloseInventoryRequest:N,handleTradeRequest:p,handleTradeCancel:C,handleSettlementInteraction:E,handleInventoryRequest:y,handleInGameMenuRequest:g}},so=o=>{const{turnVM:t,handleEndUpTurnUpdates:e,playerVM:i,enemyVMs:n,npcController:s}=o;let u=0;const c=()=>{var f;const r=gt().log;r.turns+=1,r.npcsKilled=n.filter(p=>!p.isAlive()).length,r.npcsAlive=n.filter(p=>p.isAlive()).length,r.mostUsedWeapon=((f=i.inventory().items().filter(p=>p.type()==="weapon").sort((p,d)=>d.uses()-p.uses())[0])==null?void 0:f.name())||"fists"},l=async()=>{h(),await e(),t.nextTurn(),a(),c()},a=async()=>{if(u+=1,u%10===0){const r=i.inventory().getItemByCode("torch");r&&i.inventory().removeItem(r)}},h=()=>{s.playNpcTurn()};return{handlePlayerTurnEnded:l,playNpcTurn:h}},ro=()=>{const[o,t]=G(void 0);return{attack:async(e,i)=>{const n=e.weapon().range()>2,s=e.weapon().range()<=2,c=e.position().distanceTo(i.position())>1,a=e.weapon().damage();s||c&&n?i.takeDamage(a):!c&&n&&i.takeDamage(Math.min(1,Math.floor(a/2))),t({source:e,target:i,type:n&&c?"ranged":"melee"});const h=gt().log;e.id()==="player"&&(h.totalDamageDealt+=a,e.weapon().setUses(e.weapon().uses()+1),s||c&&n?s?gt().log.meleeAttacks+=1:gt().log.rangedAttacks+=1:!c&&n&&(gt().log.meleeAttacks+=1))},isAttacking:()=>o(),clearAttack:()=>{t(void 0)}}};j.registerPlugin(ae);ae.registerPIXI(li);const ao=o=>o<=3?1:o<=6?2:o<=10?3:o<=15?4:5,lo=({view:o,saveController:t,onGameLoadRequest:e,onLevelCompleted:i,onGameOver:n})=>{const[u,c]=G(le({model:Ue({id:"dontUse",team:"player",name:"Player",startPosition:{x:0,y:0},startingHealth:10,startingMaxHealth:10,startingItems:[]})}));let l=null,a=null,h=null,r=null,f=null,p=null,d=null,g=null,y=null,v=null,E=null,C=[],A=[],M=null,N=[],_=1,b=null,m=null,T=null,w=!1,x=!1,k={x:0,y:0};const B=()=>{if(!b)throw new Error("Level models are not initialized");return b},S=V=>{b=V;const F=Wi(V);E=F.tileMapVM,c(F.playerVM),C=F.npcVMs,A=F.eventVMs,N=F.settlementVMs;const Y=ro();f=zi({playerVM:u()}),p=V.fogOfWarViewModel,l=qi({playerVM:u(),npcVMs:C,settlementVMs:N,eventViewModels:A}),d=Un({playerMenuVM:()=>l,playerUiVM:()=>f}),g=Di({model:Oi()}),r=Jn({tileMapVM:E,playerVM:u(),turnVM:g,attackVM:Y,addNpc:st=>{m==null||m.addNpc(st),h==null||h.addNpc(st)}}),h=Gn({playerVM:u(),npcs:C,tileMapVM:E,events:A,npcTaskController:r,turnVM:g}),y=so({turnVM:g,playerVM:u(),enemyVMs:C,npcController:h,handleEndUpTurnUpdates:async()=>{await(m==null?void 0:m.handleEndOfTurnUpdates())}});const et=()=>{u().inventory().getItemByCode("torch")?p==null||p.setToFullLight():p==null||p.setToLowLight()};a=oo({attackVM:Y,tileMapViewModel:E,playerViewModel:u(),userInterfaceView:d,playerUiVM:()=>f,onPlayerTurnCompleted:()=>{y==null||y.handlePlayerTurnEnded(),et()},gameView:()=>m}),m=nn({tileSize:64,playerVM:u(),tileMapVM:E,npcVMs:C,eventVMs:A,settlementVMs:N,attackVM:Y}),v=Gi({gameViews:{gameView:m.view,nonSkewedView:m.nonSkewedContainer},userInterfaceView:d.view,fogOfWarVM:p}),M=qn({playerVM:u(),tileMapVM:E})},L=()=>{console.debug("Unloading level..."),T==null||T.destroy(),v==null||v.destroy(),l=null,a=null,h=null,r=null,f=null,p=null,o.detachAll(),d==null||d.destroy(),d=null,g=null,y=null,v=null,E=null,C=[],A=[],M==null||M.destroy(),M=null,N=[],b=null,m==null||m.destroy()},P=()=>{const V=C.filter(et=>et.isAlive()),F=C.length-V.length,Y=u().position();Y&&(_>=ao(F)||(_++,V.forEach(et=>{et.position().distanceTo(Y)<5||et.setMaxHealth(et.maxHealth()+2)})))},I=()=>{const V=u().position(),F=5;V&&(E==null||E.tiles().forEach(Y=>{Y.forEach(et=>{et.setVisible(Math.abs(et.position().x-V.x)<=F&&Math.abs(et.position().y-V.y)<=F)})}),A.forEach(Y=>{Y.setVisible(Math.abs(Y.position().x-V.x)<=F&&Math.abs(Y.position().y-V.y)<=F)}),C.forEach(Y=>{Y.setVisible(Math.abs(Y.position().x-V.x)<=F&&Math.abs(Y.position().y-V.y)<=F)}),N.forEach(Y=>{Y.setIsVisible(Math.abs(Y.positions()[0].x-V.x)<=F&&Math.abs(Y.positions()[0].y-V.y)<=F)}))},R=async()=>{if(!w&&!x){w=!0,a==null||a.handleTradeRequest({action:"autoTrade",trader:{canTrade:()=>!0,inventory:()=>_t({model:Yt([]),ownerName:"Bulk Trader"})}});return}if(w=!1,!x){x=!0,d==null||d.showEndOfLevelLog();return}i(b),await D()},D=async()=>{!v||!d||(tt.disableCategory("gameplay"),d.view.visible=!1,await j.to(v.view,{duration:5,alpha:0}),v.view.visible=!1,X(),L())},W=()=>{T=Ni({handleInfoModalOpenRequest:V=>{d==null||d.showInfoModal(V)},handleInfoModalCloseRequest:()=>{d==null||d.hideInfoModal()},handleLevelCompleted:R,handleTileInteraction:V=>{a==null||a.handleTileInteraction(V)},handleItemInteraction:(V,F)=>{a==null||a.handleItemInteraction(V,F)},handleEventInteraction:V=>{a==null||a.handleEventInteraction(V,u())},handleCharacterInteraction:V=>{a==null||a.handleCharacterInteraction({character:V,action:"interact"})},onCloseInventoryRequested:()=>{a==null||a.handleCloseInventoryRequest(),w&&R()},handleInventoryRequest:(V,F)=>{a==null||a.handleInventoryRequest(V,F)},handleTradeRequest:V=>{a==null||a.handleTradeRequest({action:V})},handleCharacterInteractionRequest:({character:V,action:F})=>{a==null||a.handleCharacterInteraction({action:F,character:V})},handleSettlementInteractionRequest:({settlement:V,action:F})=>{a==null||a.handleSettlementInteraction({settlement:V,action:F})},handleInGameMenuRequest:V=>{a==null||a.handleInGameMenuRequest(V)},onDebugActionRequested:V=>{M==null||M.handleDebugActionRequest(V)},handleSaveRequest:X,handleLoadRequest:z})},X=()=>{console.debug("Saving game state...");const V=B(),F={...V,tileModels:V.tileMapModel.tiles().map(Y=>Y.map(et=>et))};t.save(F),f==null||f.setIsSaveCompleted(!0)},z=()=>{console.debug("Loading game state..."),e();const V=t.load();if(!V){console.warn("No saved game state found.");return}O.emit("ON_PAUSE_INPUT"),L(),H(V)},H=V=>{console.debug("Loading level..."),S(V??Ge()),W(),d==null||d.showPlayerMenu(),d==null||d.showPlayerUi(),!(!v||!d)&&(v.view.visible=!1,d.view.visible=!1,o.attachCamera(v),o.attachUi(d),o.resize(innerWidth,innerHeight))},J=()=>{!v||!d||(tt.enableCategory("gameplay"),tt.stopMusic({fadeOut:!0}),I(),v.view.visible=!0,d.view.visible=!0,o.resize(innerWidth,innerHeight),v&&v.moveTo(u().position().x*64,u().position().y*64))},nt=V=>{d==null||d.update()};return at(()=>{lt(()=>{(u().position().x!==k.x||u().position().y!==k.y)&&(I(),P(),k={x:u().position().x,y:u().position().y},v&&v.moveTo(u().position().x*64,u().position().y*64)),u().isAlive()||(console.debug("Player is dead, handling game over..."),j.delayedCall(1,()=>{n(),L()}))})}),{loadLevel:H,showGameView:J,update:nt,getState:B}},Co=o=>{const{mainMenuVM:t,view:e,loadingScreenVM:i,saveController:n}=o,s=()=>{i.showLevelLoadScreen(),i.setVisible(!0),setTimeout(()=>{i.setVisible(!1),d.showGameView(),O.emit("ON_RESUME_INPUT")},2e3)},u=()=>{console.debug("Resetting game progress..."),n.clear(),gt().reset()},c=g=>{console.debug("Preparing next level...");const y=Ge();g.playerModel.moveTo(y.playerModel.position().x,y.playerModel.position().y),y.playerModel=g.playerModel;const v=y.playerModel.inventory().items().filter(A=>A.code()==="torch").length,E=Math.max(0,30-v);ie("torch",E).forEach(A=>y.playerModel.inventory().addItem(A));const C=Math.abs(Math.max(-5,y.playerModel.health()-y.playerModel.maxHealth()));return y.playerModel.setHealth(y.playerModel.health()+C),y},l=async g=>{i.showRestScreen(),i.setVisible(!0),await j.delayedCall(8,()=>{d.loadLevel(c(g))}),await j.delayedCall(2,()=>{i.setVisible(!1),d.showGameView()})},a=(g=!1)=>{const y=n.load();g?i.showDebugScreen():y&&i.showLevelLoadScreen(),i.setVisible(!0),t.hide(),d.loadLevel(g?void 0:y);const v=at(()=>{lt(()=>{i.isVisible()||(d.showGameView(),O.emit("ON_RESUME_INPUT"),v())})})},h=()=>{console.debug("Starting game..."),t.setIsContinueButtonVisible(n.saveExists()),t.show()},r=()=>{console.debug("Exiting game...")},f=g=>{d.update(g)},d=lo({view:e,saveController:n,onGameLoadRequest:s,onLevelCompleted:l,onGameOver:()=>{console.debug("Game Over"),O.emit("ON_PAUSE_INPUT"),i.showGameOverScreen(),i.setVisible(!0);const g=at(()=>{lt(()=>{i.isVisible()||(t.show(),g())})})}});return{loadLevel:a,initGame:h,exitGame:r,update:f,resetProgress:u}};export{Co as createGameController};
