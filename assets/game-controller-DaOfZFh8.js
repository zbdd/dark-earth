import{c as ct,g as Z,S as et}from"./sound-manager-DkwQu1C7.js";import{g as kt,h as st,A as ce,d as yt,i as se,j as $e,k as qe,e as si,f as ri,m as fe,G as mt,n as jt}from"./npc-model-DyQXkGpR.js";import{R as Zt,E as ai,G as K,i as pe,C as q,P as Fe,S as F,T as _t,f as li,j as ci,k as Ut,l as hi}from"./index-az1GvKIv.js";import{c as G,a as rt}from"./solid-lwVvZ318.js";import{c as Kt,b as wt,a as Ge}from"./modal-view-DaFilMXO.js";const di=(n,t,e)=>{if(n<=0)return;const i=[...t];i.sort((r,d)=>{const a=r.position().distanceTo(e.position()),h=d.position().distanceTo(e.position());return a-h});const o=Math.min(4,Math.floor(i.length/n));for(let r=0;r<n;r++){const d=kt("city-key"),a=Math.floor(Math.random()*100)<=33?0:Math.floor(Math.random()*100)<=66?1:2,h=Math.min(i.length-1,a+Math.floor((r+1)*o)),l=i[h];i.splice(a,1),l.inventory().addItem(d)}},ui=({map:n,rooms:t,pathEnemyChance:e=.2,paths:i})=>{const r=(l,c)=>l>0&&c>0&&l<n.length-1&&c<n[0].length-1,d=(l,c,s,p)=>Math.sqrt((l-s)**2+(c-p)**2),a=(l,c,s)=>s.every(p=>d(p.position().x,p.position().y,l,c)>=10),h=[];return t.forEach((l,c)=>{if(c===0)return;const s=Math.floor(Math.random()*2);for(let p=0;p<s;p++){const[f,u]=l[Math.floor(Math.random()*l.length)];if(r(f,u)&&a(f,u,h)){const g=n[f][u];g.hasEnemy()||(g.hasEnemy=()=>!0,h.push(g))}}}),i.forEach((l,c)=>{c!==0&&l.forEach(([s,p])=>{if(Math.random()<e&&r(s,p)&&a(s,p,h)){const f=n[s][p];f.hasEnemy()||(f.hasEnemy=()=>!0,h.push(f))}})}),h},fi=({map:n,rooms:t,pathEventChance:e=.1,paths:i})=>{const r=[],d=(h,l)=>h>0&&l>0&&h<n.length-1&&l<n[0].length-1,a=(h,l,c,s)=>Math.sqrt((h-c)**2+(l-s)**2);return t.forEach(h=>{const l=h.length/2,c=Math.floor(Math.random()*l)+2;for(let s=0;s<c;s++){const[p,f]=h[Math.floor(Math.random()*h.length)];if(d(p,f)&&r.every(u=>a(u.position().x,u.position().y,p,f)>=3)){const u=n[p][f];!u.hasEvent()&&u.traversable()&&u.type()!=="settlement"&&(u.hasEvent=()=>!0,r.push(u))}}}),i.forEach(h=>{h.forEach(([l,c])=>{if(Math.random()<e&&d(l,c)){const s=n[l][c];!s.hasEvent()&&s.type()!=="settlement"&&s.traversable()&&r.every(p=>a(p.position().x,p.position().y,l,c)>=3)&&(s.hasEvent=()=>!0,r.push(s))}})}),r},me=[st({id:"ancient-bunker",name:"Ancient Bunker",startPosition:{x:0,y:0},startingItems:[],level:3}),st({id:"bandit-camp",name:"Bandit Camp",startPosition:{x:0,y:0},startingItems:[],level:4}),st({id:"beacon",name:"Beacon",startPosition:{x:0,y:0},startingItems:[],level:2}),st({id:"bear-cage",name:"Bear Cage",startPosition:{x:0,y:0},startingItems:[],level:4}),st({id:"bunker",name:"Bunker",startPosition:{x:0,y:0},startingItems:[],level:2}),st({id:"campfire",name:"Campfire",startPosition:{x:0,y:0},startingItems:[],level:2}),st({id:"cave",name:"Cave",startPosition:{x:0,y:0},startingItems:[],level:3}),st({id:"chest",name:"Chest",startPosition:{x:0,y:0},startingItems:[],level:1}),st({id:"church",name:"Church",startPosition:{x:0,y:0},startingItems:[],level:2}),st({id:"crashed-plane",name:"Crashed Plane",startPosition:{x:0,y:0},startingItems:[],level:3}),st({id:"fungi",name:"Fungi",startPosition:{x:0,y:0},startingItems:[],level:1}),st({id:"tent",name:"Tent",startPosition:{x:0,y:0},startingItems:[],level:2}),st({id:"lean-to",name:"Lean-To",startPosition:{x:0,y:0},startingItems:[],level:2}),st({id:"ruin",name:"Ruin",startPosition:{x:0,y:0},startingItems:[],level:4}),st({id:"scary-tree",name:"Scary Tree",startPosition:{x:0,y:0},startingItems:[],level:1}),st({id:"silo",name:"Silo",startPosition:{x:0,y:0},startingItems:[],level:3}),st({id:"sword-in-stone",name:"Monument",startPosition:{x:0,y:0},startingItems:[],level:5}),st({id:"wagon",name:"Wagon",startPosition:{x:0,y:0},startingItems:[],level:1}),st({id:"wreck",name:"Wreck",startPosition:{x:0,y:0},startingItems:[],level:1})],pi=()=>{const n=Math.floor(Math.random()*me.length);return me[n]},mi=n=>{const t=Math.floor(Math.random()*n)+1,e=[];for(let i=0;i<t;i++){if(Math.random()<.5)continue;const o=gi();e.push(o)}if(e.length===0){const i=kt("coin");e.push(i)}return e},gi=()=>{let n=0;const t=[];return ce.map(i=>{const o=new Array(i.randomDropWeight()).fill(i);t.push(...o),n+=i.randomDropWeight()}),kt(t[Math.floor(Math.random()*n)].code())},yi=n=>n.map(t=>{const e=pi();return st({id:e.id(),name:e.name(),startPosition:{x:t.position().x,y:t.position().y},level:e.level(),startingItems:mi(e.level())})}),vi=(n,t)=>{const e=(h,l)=>{const c=[],s=Math.abs(l.position.x-h.position.x),p=Math.abs(l.position.y-h.position.y),f=h.position.x<l.position.x?1:-1,u=h.position.y<l.position.y?1:-1;let g=s-p,y=h.position.x,v=h.position.y;for(;y!==l.position.x||v!==l.position.y;){c.push([y,v]);const C=g*2;C>-p&&(g-=p,y+=f),C<s&&(g+=s,v+=u)}return c},i=(h,l,c,s)=>{const p=h[h.length-1],[f,u]=p;for(const g of s){if(c.has(g.id))continue;if(Math.hypot(g.position.x-f,g.position.y-u)>3){const v=e({position:{x:f,y:u}},g);l.push(v),c.add(g.id);break}}},o=(h,l)=>{let c=null,s=1/0;for(const p of n){if(l.has(p.id))continue;const f=Math.hypot(p.position.x-h.position.x,p.position.y-h.position.y);f<s&&f<t&&(c=p,s=f)}return c},r=[],d=new Set;let a=n[0];for(d.add(a.id);d.size<n.length;){let h=o(a,d);if(!h){const l=Array.from(d).map(c=>n.find(s=>s.id===c));for(;l.length>0;){const c=l.pop();if(h=o(c,d),h){a=c;break}}h||(h=n.find(c=>!d.has(c.id))||null)}if(h){const l=e(a,h);r.push(l),d.add(h.id),a=h,l.length>7&&i(l,r,d,n)}else break}return r},wi=(n,t,e,i={min:2,max:4})=>{const o=n.length,r=n[0].length,d=[],a=(c,s)=>c>=0&&s>=0&&c<o&&s<r,h=(c,s,p)=>p.every(([f,u])=>{const g=c+f,y=s+u;if(!a(g,y))return!1;for(let v=-1;v<=1;v++)for(let C=-1;C<=1;C++){const T=g+v,E=y+C;if(a(T,E)&&n[T][E].type()!=="void")return!1}return!0}),l=c=>{const s=[];switch(Math.floor(Math.random()*4)){case 0:for(let g=-c;g<=c;g++)for(let y=-c;y<=c;y++)g*g+y*y<=c*c&&s.push([g,y]);break;case 1:for(let g=-c;g<=c+2;g++)for(let y=-c;y<=c;y++)(g*g+y*y<=c*c||Math.abs(g)<c&&Math.abs(y)<c)&&s.push([g,y]);break;case 2:for(let g=-c;g<=c;g++)for(let y=-c;y<=c;y++)(g*g+y*y<=c*c&&Math.random()>.5||Math.abs(g)<c&&Math.abs(y)<c&&Math.random()>.5)&&s.push([g,y]);break;case 3:const f=c*2,u=Math.floor(c/2);for(let g=-f;g<=f;g++)for(let y=-u;y<=u;y++)s.push([g,y]);break}return s};return t.forEach(c=>{const s=Math.floor(Math.random()*(i.max-i.min+1)+i.min),p=l(s),f=[];h(c.position.x,c.position.y,p)&&p.forEach(([u,g])=>{const y=c.position.x+u,v=c.position.y+g;a(y,v)&&(n[y][v]=yt({terrain:"wasteland",position:{x:y,y:v}}),f.push([y,v]))}),f.length>0&&d.push(f)}),e.forEach(c=>{c.forEach(([s,p])=>{for(let f=-Math.floor(Math.random()*2);f<=Math.floor(Math.random()*2);f++)for(let u=-Math.floor(Math.random()*2);u<=Math.floor(Math.random()*2);u++){const g=s+f,y=p+u;a(g,y)&&n[g][y].type()!=="wasteland"&&(n[g][y]=yt({terrain:"grass",position:{x:g,y}}))}})}),{map:n,rooms:d}},bi=(n,t)=>Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2)),xi=n=>{const{horizontalTiles:t,verticalCells:e,nodeCount:i,minDistanceBetweenNodes:o,maxAttemptsToAssignNode:r}=n,d=[],a=Math.ceil(Math.sqrt(i)),h=Math.floor(t/a),l=Math.floor(e/a),c=(s,p)=>d.every(f=>Math.abs(bi(f.position,{x:s,y:p}))>=o);for(let s=0;s<i;s++){let p=0,f=!1;for(;p<r&&!f;){const u=Math.floor(s%a)*h,g=Math.floor(s/a)*l;let y=u+Math.floor(Math.random()*h),v=g+Math.floor(Math.random()*l);y=Math.max(3,Math.min(t-3,y)),v=Math.max(3,Math.min(e-3,v)),y<t&&v<e&&c(y,v)?(d.push({id:`node-${s}`,position:{x:y,y:v}}),f=!0):p++}f||d.pop()&&s--}return d},Ci=n=>{const{startPosition:t}=n,e=[...se("torch",30),...se("coin",3)],i=[],o=[...e,...i];return $e({name:"Hero",id:"player",startPosition:t,startingItems:o,team:"player"})},Ye=()=>{const n=xi({horizontalTiles:64,verticalCells:64,nodeCount:80,minDistanceBetweenNodes:7,maxAttemptsToAssignNode:100}),t=vi(n,15),e=T=>{const E=Math.floor(Math.random()*T)+1,k=[];for(let W=0;W<E;W++){if(Math.random()<.5)continue;const A=i(),x=k.find(m=>m.code()===A.code());if(x){x.code()==="coin"&&x.updateQuantity(x.quantity()+1);continue}k.push(A)}if(k.length===0){const W=kt("coin");k.push(W)}return k},i=()=>{let T=0;const E=[];return ce.map(k=>{const W=new Array(k.randomDropWeight()).fill(k);E.push(...W),T+=k.randomDropWeight()}),E[Math.floor(Math.random()*T)]},{map:o,rooms:r}=wi(Array.from({length:64},(T,E)=>Array.from({length:64},(k,W)=>yt({terrain:"void",position:{x:E,y:W}}))),n,t,{min:2,max:4});(T=>{const E=T.flat().filter(x=>x.type()==="void"),k=Math.floor(30);let W=0,A=0;for(let x=0;x<k&&(x>0&&E.splice(A,1),!(W>1e4||(W++,E.length===0)));x++){A=Math.floor(Math.random()*E.length);const{x:m,y:b}=E[A].position(),M=new Zt(m,b,Math.floor(Math.random()*3)+1,Math.floor(Math.random()*3)+1);let _=!0;for(let O=-M.width;O<=M.width;O++){for(let R=-M.height;R<=M.height;R++){const U=m+O,I=b+R;if(!(U<0||I<0||U>=T.length||I>=T[0].length)&&T[U][I].type()!=="void"){_=!1;break}}if(!_)break}if(_)for(let O=-M.width;O<=M.width;O++)for(let R=-M.height;R<=M.height;R++){const U=m+O,I=b+R;U<0||I<0||U>=T.length||I>=T[0].length||(T[U][I]=yt({terrain:"water",position:{x:U,y:I}}))}}})(o);const h=ui({map:o,rooms:r,paths:t,pathEnemyChance:.2}).map(T=>qe({id:"bandit",name:"Bandit",team:"hostile-to-all",startPosition:{x:T.position().x,y:T.position().y},startingItems:e(Math.floor(Math.random()*3)+1),startingHealth:2})),l=T=>{T[0].map(E=>yt({terrain:"mountain",position:E.position()})),T[T.length-1].map(E=>yt({terrain:"mountain",position:E.position()})),T.forEach(E=>{yt({terrain:"mountain",position:E[0].position()}),yt({terrain:"mountain",position:E[E.length-1].position()})})},c=["settlement","large-settlement","sanctuary","citadel"],s=(T,E)=>{const{x:k,y:W}=T,A=[{x:k,y:W},{x:k+1,y:W},{x:k,y:W+1},{x:k+1,y:W+1}];return A.forEach(x=>{E[x.x]&&E[x.x][x.y]&&(E[x.x][x.y]=yt({terrain:"settlement",position:x}))}),fe({id:c.shift()??"settlement",name:`Settlement at (${k}, ${W})`,level:1,positions:A})};function p(T,E){const k=[];return T.forEach((W,A)=>{const{x,y:m}=W.position,b=!0;if(A===0){k.push(s({x,y:m},E));return}x<E.length-1&&m<E[0].length-1&&b?k.push(s({x,y:m},E)):(E[x][m]=yt({terrain:"settlement",position:{x,y:m}}),k.push(fe({id:c.shift()??"settlement",name:`Settlement ${A+1}`,level:1,positions:[{x,y:m}]})))}),k}const u=((T,E,k)=>{const W=[],A=new Set,x=m=>{const b=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],M=b[Math.floor(Math.random()*b.length)];return{x:m.position.x+M.x,y:m.position.y+M.y}};for(W.push({id:T[0].id,position:x(T[0])});W.length<E&&W.length<T.length&&A.size<T.length;){const m=Math.floor(Math.random()*T.length),b=T[m],M=`${b.position.x},${b.position.y}`;if(A.has(M))continue;let _=!0;for(const O of W)if(Math.sqrt(Math.pow(b.position.x-O.position.x,2)+Math.pow(b.position.y-O.position.y,2))<k){_=!1;break}_&&(W.push(b),A.add(M))}return W})(n,3,5),g=p(u,o);l(o);const y=fi({map:o,rooms:r,paths:t,pathEventChance:.1}),v=yi(y),C=Ci({startPosition:n[0].position});return di(g.length,h,C),{playerModel:C,tileMapModel:ri(o),npcModels:h,eventModels:v,settlementModels:g,fogOfWarViewModel:si()}};/*!
 * PixiPlugin 3.13.0
 * https://gsap.com
 *
 * @license Copyright 2008-2025, GreenSock. All rights reserved.
 * Subject to the terms at https://gsap.com/standard-license
 * @author: Jack Doyle, jack@greensock.com
*/var Tt,Jt,ge,pt,zt,Qe,re,ee,Xe=function(){return typeof window<"u"},je=function(){return Tt||Xe()&&(Tt=window.gsap)&&Tt.registerPlugin&&Tt},ae=function(t){return typeof t=="function"},Ze=function(t){return console.warn(t)},Ti=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],It=.212671,xt=.71516,bt=.072169,Ke=function(t){return ae(pt[t])?pt[t]:pt.filters[t]},ie=function(t,e){var i=[],o=0,r=0,d,a;for(d=0;d<4;d++){for(a=0;a<5;a++)r=a===4?t[o+4]:0,i[o+a]=t[o]*e[a]+t[o+1]*e[a+5]+t[o+2]*e[a+10]+t[o+3]*e[a+15]+r;o+=5}return i},ye=function(t,e){var i=1-e,o=i*It,r=i*xt,d=i*bt;return ie([o+e,r,d,0,0,o,r+e,d,0,0,o,r,d+e,0,0,0,0,0,1,0],t)},ve=function(t,e,i){var o=Jt(e),r=o[0]/255,d=o[1]/255,a=o[2]/255,h=1-i;return ie([h+i*r*It,i*r*xt,i*r*bt,0,0,i*d*It,h+i*d*xt,i*d*bt,0,0,i*a*It,i*a*xt,h+i*a*bt,0,0,0,0,0,1,0],t)},we=function(t,e){e*=Math.PI/180;var i=Math.cos(e),o=Math.sin(e);return ie([It+i*(1-It)+o*-.212671,xt+i*-.71516+o*-.71516,bt+i*-.072169+o*(1-bt),0,0,It+i*-.212671+o*.143,xt+i*(1-xt)+o*.14,bt+i*-.072169+o*-.283,0,0,It+i*-.212671+o*-.787329,xt+i*-.71516+o*xt,bt+i*(1-bt)+o*bt,0,0,0,0,0,1,0,0,0,0,0,1],t)},be=function(t,e){return ie([e,0,0,0,.5*(1-e),0,e,0,0,.5*(1-e),0,0,e,0,.5*(1-e),0,0,0,1,0],t)},Je=function(t,e){var i=Ke(e),o=t.filters||[],r=o.length,d;for(i||Ze(e+" not found. PixiPlugin.registerPIXI(PIXI)");--r>-1;)if(o[r]instanceof i)return o[r];return d=new i,e==="BlurFilter"&&(ee?d.strength=0:d.blur=0),t.filters=[].concat(o,[d]),d},lt=function(t,e,i,o){e.add(i,t,i[t],o[t]),e._props.push(t)},xe=function(t,e){var i=Ke("ColorMatrixFilter"),o=new i;return o.matrix=e,o.brightness(t,!0),o.matrix},Ii=function(t){var e={},i;for(i in t)e[i]=t[i];return e},ft={contrast:1,saturation:1,colorizeAmount:0,colorize:"rgb(255,255,255)",hue:0,brightness:1},ki=function(t,e,i){var o=Je(t,"ColorMatrixFilter"),r=t._gsColorMatrixFilter=t._gsColorMatrixFilter||Ii(ft),d=e.combineCMF&&!("colorMatrixFilter"in e&&!e.colorMatrixFilter),a,h,l;for(l=o.matrix,e.resolution&&(o.resolution=e.resolution),e.matrix&&e.matrix.length===l.length?(h=e.matrix,r.contrast!==1&&lt("contrast",i,r,ft),r.hue&&lt("hue",i,r,ft),r.brightness!==1&&lt("brightness",i,r,ft),r.colorizeAmount&&(lt("colorize",i,r,ft),lt("colorizeAmount",i,r,ft)),r.saturation!==1&&lt("saturation",i,r,ft)):(h=Ti.slice(),e.contrast!=null?(h=be(h,+e.contrast),lt("contrast",i,r,e)):r.contrast!==1&&(d?h=be(h,r.contrast):lt("contrast",i,r,ft)),e.hue!=null?(h=we(h,+e.hue),lt("hue",i,r,e)):r.hue&&(d?h=we(h,r.hue):lt("hue",i,r,ft)),e.brightness!=null?(h=xe(+e.brightness,h),lt("brightness",i,r,e)):r.brightness!==1&&(d?h=xe(r.brightness,h):lt("brightness",i,r,ft)),e.colorize!=null?(e.colorizeAmount="colorizeAmount"in e?+e.colorizeAmount:1,h=ve(h,e.colorize,e.colorizeAmount),lt("colorize",i,r,e),lt("colorizeAmount",i,r,e)):r.colorizeAmount&&(d?h=ve(h,r.colorize,r.colorizeAmount):(lt("colorize",i,r,ft),lt("colorizeAmount",i,r,ft))),e.saturation!=null?(h=ye(h,+e.saturation),lt("saturation",i,r,e)):r.saturation!==1&&(d?h=ye(h,r.saturation):lt("saturation",i,r,ft))),a=h.length;--a>-1;)h[a]!==l[a]&&i.add(l,a,l[a],h[a],"colorMatrixFilter");i._props.push("colorMatrixFilter")},Mi=function(t,e){var i=e.t,o=e.p,r=e.color,d=e.set;d(i,o,r[0]<<16|r[1]<<8|r[2])},_i=function(t,e){var i=e.g;ee?(i.fill(),i.stroke()):i&&(i.dirty++,i.clearDirty++)},Ei=function(t,e){e.t.visible=!!e.t.alpha},Ce=function(t,e,i,o){var r=t[e],d=Jt(ae(r)?t[e.indexOf("set")||!ae(t["get"+e.substr(3)])?e:"get"+e.substr(3)]():r),a=Jt(i);o._pt=new zt(o._pt,t,e,0,0,Mi,{t,p:e,color:d,set:Qe(t,e)}),o.add(d,0,d[0],a[0]),o.add(d,1,d[1],a[1]),o.add(d,2,d[2],a[2])},Si={tint:1,lineColor:1,fillColor:1,strokeColor:1},Te="position,scale,skew,pivot,anchor,tilePosition,tileScale".split(","),le={x:"position",y:"position",tileX:"tilePosition",tileY:"tilePosition"},Ai={colorMatrixFilter:1,saturation:1,contrast:1,hue:1,colorize:1,colorizeAmount:1,brightness:1,combineCMF:1},te=Math.PI/180,ti=function(t){return typeof t=="string"},Pi=function(t){return ti(t)&&t.charAt(1)==="="?t.substr(0,2)+parseFloat(t.substr(2))*te:t*te},Ni=function(t,e){return e.set(e.t,e.p,t===1?e.e:Math.round((e.s+e.c*t)*1e5)/1e5,e)},Oi=function(t,e,i,o,r,d){var a=360*(d?te:1),h=ti(r),l=h&&r.charAt(1)==="="?+(r.charAt(0)+"1"):0,c=parseFloat(l?r.substr(2):r)*(d?te:1),s=l?c*l:c-o,p=o+s,f,u;return h&&(f=r.split("_")[1],f==="short"&&(s%=a,s!==s%(a/2)&&(s+=s<0?a:-a)),f==="cw"&&s<0?s=(s+a*1e10)%a-~~(s/a)*a:f==="ccw"&&s>0&&(s=(s-a*1e10)%a-~~(s/a)*a)),t._pt=u=new zt(t._pt,e,i,o,s,Ni),u.e=p,u},Ie=function(){if(!ge){Tt=je(),pt=ge=pt||Xe()&&window.PIXI;var t=pt&&pt.VERSION&&parseFloat(pt.VERSION.split(".")[0])||0;re=t===4,ee=t>=8,Jt=function(i){return Tt.utils.splitColor((i+"").substr(0,2)==="0x"?"#"+i.substr(2):i)}}},Qt,St;for(Qt=0;Qt<Te.length;Qt++)St=Te[Qt],le[St+"X"]=St,le[St+"Y"]=St;var he={version:"3.13.0",name:"pixi",register:function(t,e,i){Tt=t,zt=i,Qe=e.getSetter,Ie()},headless:!0,registerPIXI:function(t){pt=t},init:function(t,e,i,o,r){if(pt||Ie(),!pt)return Ze("PIXI was not found. PixiPlugin.registerPIXI(PIXI);"),!1;var d,a,h,l,c,s,p,f,u,g;for(s in e){if(d=le[s],h=e[s],d)a=~s.charAt(s.length-1).toLowerCase().indexOf("x")?"x":"y",this.add(t[d],a,t[d][a],d==="skew"?Pi(h):h,0,0,0,0,0,1);else if(s==="scale"||s==="anchor"||s==="pivot"||s==="tileScale")this.add(t[s],"x",t[s].x,h),this.add(t[s],"y",t[s].y,h);else if(s==="rotation"||s==="angle")Oi(this,t,s,t[s],h,s==="rotation");else if(Ai[s])l||(ki(t,e.colorMatrixFilter||e,this),l=!0);else if(s==="blur"||s==="blurX"||s==="blurY"||s==="blurPadding"){if(c=Je(t,"BlurFilter"),this.add(c,s,c[s],h),e.blurPadding!==0)for(p=e.blurPadding||Math.max(c[s],h)*2,f=t.filters.length;--f>-1;)t.filters[f].padding=Math.max(t.filters[f].padding,p)}else if(Si[s])if((s==="lineColor"||s==="fillColor"||s==="strokeColor")&&t instanceof pt.Graphics)for(u=("fillStyle"in t)?[t]:(t.geometry||t).graphicsData,g=s.substr(0,s.length-5),ee&&g==="line"&&(g="stroke"),this._pt=new zt(this._pt,t,s,0,0,_i,{g:t.geometry||t}),f=u.length;--f>-1;)Ce(re?u[f]:u[f][g+"Style"],re?s:"color",h,this);else Ce(t,s,h,this);else s==="autoAlpha"?(this._pt=new zt(this._pt,t,"visible",0,0,Ei),this.add(t,"alpha",t.alpha,h),this._props.push("alpha","visible")):s!=="resolution"&&this.add(t,s,"get",h);this._props.push(s)}}};je()&&Tt.registerPlugin(he);const V=new ai,Ri=n=>{let t=!1;return V.on("ON_INFO_MODAL_OPEN",e=>{t&&(n.handleAnyEvent(),n.handleInfoModalOpenRequest(e))}),V.on("ON_INFO_MODAL_CLOSE",()=>{n.handleInfoModalCloseRequest()}),V.on("ON_PAUSE_INPUT",()=>{t=!1,n.handleAnyEvent()}),V.on("ON_RESUME_INPUT",()=>{t=!0}),V.on("ON_LEVEL_COMPLETED",()=>{n.handleAnyEvent(),n.handleLevelCompleted()}),V.on("ON_TILE_INTERACTION",({tileViewModel:e})=>{t&&(n.handleAnyEvent(),n.handleTileInteraction(e))}),V.on("ON_ITEM_INTERACTION",({itemViewModel:e,action:i})=>{t&&(n.handleAnyEvent(),n.handleItemInteraction(e,i))}),V.on("ON_EVENT_INTERACTION",({eventViewModel:e})=>{t&&(n.handleAnyEvent(),n.handleEventInteraction(e))}),V.on("ON_CHARACTER_INTERACTION",({characterViewModel:e})=>{t&&(n.handleAnyEvent(),n.handleCharacterInteraction(e))}),V.on("ON_INVENTORY_REQUEST",({inventory:e,action:i})=>{t&&(n.handleAnyEvent(),n.handleInventoryRequest(e,i))}),V.on("ON_CLOSE_INVENTORY_REQUESTED",()=>{t&&(n.handleAnyEvent(),n.onCloseInventoryRequested())}),V.on("ON_TRADE_REQUEST",({action:e})=>{t&&(n.handleAnyEvent(),n.handleTradeRequest(e))}),V.on("ON_CHARACTER_INTERACTION_REQUEST",e=>{t&&(n.handleAnyEvent(),n.handleCharacterInteractionRequest(e))}),V.on("ON_SETTLEMENT_INTERACTION_REQUEST",e=>{t&&(n.handleAnyEvent(),n.handleSettlementInteractionRequest(e))}),V.on("ON_SAVE_REQUEST",()=>{n.handleSaveRequest()}),V.on("ON_LOAD_REQUEST",()=>{n.handleLoadRequest()}),V.on("ON_IN_GAME_MENU_REQUEST",({action:e})=>{n.handleAnyEvent(),n.handleInGameMenuRequest(e)}),V.on("ON_DEBUG_ACTION_REQUESTED",({action:e})=>{t&&n.onDebugActionRequested(e)}),{destroy:()=>{V.removeAllListeners()}}},Vi=()=>{const[n,t]=G(0),[e,i]=G(480);return{getCurrentTurn:()=>n(),getGameTimeMin:()=>e(),nextTurn:()=>{t(a=>a+1),i(a=>{const h=a+10;return h>=1440?0:h})}}},$t=n=>{const{model:t}=n,[e,i]=G(t.armour()>0),[o,r]=G(t.armour()<t.maxArmour()),[d,a]=G(t.damage()>0),[h,l]=G(t.health()>0),c={code:()=>t.code(),name:()=>t.name(),description:()=>t.description(),quantity:()=>t.quantity(),value:()=>t.value(),updateQuantity:s=>{t.updateQuantity(s)},level:()=>t.level(),interact:()=>{V.emit("ON_ITEM_INTERACTION",{itemViewModel:c})},health:()=>t.health(),type:()=>t.type(),damage:()=>t.damage(),range:()=>t.range(),armour:()=>t.armour(),setArmour:s=>{t.setArmour(s)},maxArmour:()=>t.maxArmour(),id:()=>t.id(),isArmourIconVisible:()=>e(),isDamagedArmourIconVisible:()=>o(),isHealthIconVisible:()=>h(),setIsArmourIconVisible:s=>{i(s)},setIsDamagedArmourIconVisible:s=>{r(s)},setIsHealthIconVisible:s=>{l(s)},isDamageIconVisible:()=>d(),setIsDamageIconVisible:s=>{a(s)},uses:()=>t.uses(),setUses:s=>{t.setUses(s)},collected:()=>t.collected(),setCollected:s=>{t.setCollected(s)}};return c},Mt=n=>{const{model:t,ownerName:e,owner:i}=n,[o,r]=G([]),[d,a]=G(!1),h=s=>$t({model:s}),l=(s,p)=>{const f=s.code()===p.code(),u=s.armour()===p.armour(),g=s.damage()===p.damage();return f&&u&&g},c={items:()=>t.items().map(s=>h(s)),stacks:()=>o(),setStacks:()=>{const s=[],p=[];c.items().forEach(f=>{if(i&&i.isEquipped(f)){p.push({item:f,quantity:1});return}const u=s.find(g=>l(g.item,f));u?u.quantity+=f.quantity():s.push({item:f,quantity:f.quantity()})}),s.sort((f,u)=>u.item.type()==="currency"&&f.item.type()!=="currency"?1:u.item.type()!=="currency"&&f.item.type()==="currency"?-1:u.item.type()==="light"&&f.item.type()!=="light"?1:u.item.type()!=="light"&&f.item.type()==="light"?-1:u.item.armour()>0&&f.item.armour()<=0?1:u.item.armour()<=0&&f.item.armour()>0?-1:u.item.damage()>0&&f.item.damage()<=0?1:u.item.damage()<=0&&f.item.damage()>0?-1:u.item.health()>0&&f.item.health()<=0?1:u.item.health()<=0&&f.item.health()>0?-1:u.item.type()==="loot"&&f.item.type()!=="loot"?1:u.item.type()!=="loot"&&f.item.type()==="loot"?-1:f.item.name().localeCompare(u.item.name())),r(p.concat(s))},ownerName:()=>e,getItem:s=>c.items().find(p=>l(p,s)),getItemByCode:s=>c.items().find(p=>p.code()===s),getItemByName:s=>c.items().find(p=>p.name()===s),addItem:s=>{t.addItem(kt(s.code(),{id:()=>s.id()})),c.setStacks()},removeItem:s=>{t.removeItem(s),c.setStacks(),!s.collected()&&(!i||!i.isAlive())&&!["trade-npc","trade","settlement","hero"].includes(e.toLowerCase())&&["trade-npc","trade","settlement","hero"].filter(p=>e.toLowerCase().includes(p)).length===0&&(s.setCollected(!0),mt().log.collectedItemsValue+=s.value())},owner:i,isEmpty:()=>t.isEmpty(),isOnlyLoot:()=>t.isOnlyLoot(),isInfoButtonEnabled:()=>d(),setInfoButtonEnabled:s=>{a(s)}};return c.setStacks(),ct(()=>{rt(()=>{c.setStacks()})}),c},de=n=>{const{model:t}=n,[e,i]=G(Mt({model:t.inventory(),ownerName:t.name()})),o=a=>{if(!a)throw new Error("Item cannot be undefined");const h=t.inventory().getItemById(a.id());if(!h)throw new Error(`Item with code ${a.id()} not found in inventory`);return h},r=a=>{if(!a)throw new Error("Item cannot be undefined");return $t({model:a})},d={id:()=>t.id(),name:()=>t.name(),setInventory:a=>{i(a)},size:()=>t.size(),position:()=>({...t.position(),distanceTo:a=>{const h=t.position().x-a.x,l=t.position().y-a.y;return Math.floor(Math.sqrt(h*h+l*l))}}),health:()=>t.health(),maxHealth:()=>t.maxHealth(),moveTo:(a,h)=>{d.isAlive()&&t.moveTo(a,h)},dialogue:()=>t.dialogue(),isHostile:a=>t.isHostile(a),move:(a,h)=>{const l=t.position(),c=l.x+a,s=l.y+h;t.moveTo(c,s)},team:()=>t.team(),updateTeam:a=>{t.updateTeam(a)},inventory:()=>e(),armour:()=>{var c,s,p;const a=((c=t.bodyArmour())==null?void 0:c.armour())??0,h=((s=t.headArmour())==null?void 0:s.armour())??0,l=((p=t.feetArmour())==null?void 0:p.armour())??0;return a+h+l},takeDamage:a=>{let h=a;new Array(a).fill(0).forEach(()=>{const c=[t.bodyArmour(),t.headArmour(),t.feetArmour()].filter(s=>s&&s.armour()>0);if(c.length!==0){const s=c[Math.floor(Math.random()*c.length)];s.setArmour(s.armour()-1),h--}}),t.id()==="player"&&(mt().log.totalDamageAbsorbed+=a-h,mt().log.totalDamageTaken+=h);const l=t.health()-h;t.setHealth(l)},setHealth:a=>{t.setHealth(a)},setMaxHealth:a=>{t.setMaxHealth(a)},isAlive:()=>t.health()>0,visible:()=>t.visible(),setVisible:a=>{t.setVisible(a)},bodyArmour:()=>r(t.bodyArmour()),setBodyArmour:a=>{a?t.setBodyArmour(o(a)):t.setBodyArmour(void 0)},headArmour:()=>r(t.headArmour()),setHeadArmour:a=>{a?t.setHeadArmour(o(a)):t.setHeadArmour(void 0)},feetArmour:()=>r(t.feetArmour()),setFeetArmour:a=>{a?t.setFeetArmour(o(a)):t.setFeetArmour(void 0)},weapon:()=>{const a=t.weapon();return $t({model:a})},setWeapon:a=>{a?t.setWeapon(o(a)):t.setWeapon(void 0)},isEquipped:a=>{var h,l,c,s;return((h=t.weapon())==null?void 0:h.id())===a.id()||((l=t.bodyArmour())==null?void 0:l.id())===a.id()||((c=t.headArmour())==null?void 0:c.id())===a.id()||((s=t.feetArmour())==null?void 0:s.id())===a.id()}};return i(Mt({model:t.inventory(),ownerName:t.name(),owner:d})),d},Li=n=>{const{eventModel:t}=n;return{...t,inventory:()=>Mt({model:t.inventory(),ownerName:t.name()})}},Bi=n=>n.tile,Di=n=>{const{model:t}=n,e=o=>Bi({tile:o});return{isValidMove:(o,r)=>t.isValidMove(o,r),entryPoints:()=>t.entryPoints().map(o=>e(o)),tiles:()=>t.tiles().map(o=>o.map(r=>e(r))),updateTile:(o,r,d)=>{t.tiles()[o][r]=d},getNeighbors:o=>{var l;const r=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],d=[],a=o.position().x,h=o.position().y;for(const{dx:c,dy:s}of r){const p=a+c,f=h+s,u=(l=t.tiles()[p])==null?void 0:l[f];u&&d.push(e(u))}return d}}},ei=n=>{const[t,e]=G([]),[i,o]=G(null),[r,d]=G([]),[a,h]=G(null),[l,c]=G(null),[s,p]=G(!1);return{...de({model:n}),setLastSpawned:u=>n.setLastTurnSpawned(u),lastSpawned:()=>n.lastTurnSpawned(),spawnLing:()=>n.spawnling(),getPatrolArea:()=>t(),setPatrolArea:u=>e(u),getTask:()=>i(),setTask:u=>o(u),getTaskList:()=>r(),setTaskList:u=>d(u),getBedLocation:()=>a(),setBedLocation:u=>h(u),getTarget:()=>l(),setTarget:u=>c(u),canTrade:()=>s(),setCanTrade:u=>p(u)}},Wi=n=>{const{model:t}=n,[e,i]=G(!0);return{id:()=>t.id(),name:()=>t.name(),level:()=>t.level(),positions:()=>t.positions(),isVisible:()=>e(),setIsVisible:o=>i(o),isUnlocked:()=>t.isUnlocked(),setIsUnlocked:o=>t.setIsUnlocked(o),inventory:()=>Mt({model:t.inventory(),ownerName:t.name()}),getMiddleTopPosition:()=>{const o=t.positions();if(o.length===0)return{x:0,y:0};const r=Math.max(...o.map(a=>a.x)),d=Math.min(...o.map(a=>a.y));return{x:(r-o[0].x)/2+o[0].x,y:d}}}},Hi=n=>{const{playerModel:t,tileMapModel:e,npcModels:i,eventModels:o,settlementModels:r,fogOfWarViewModel:d}=n,a=de({model:t}),h=Di({model:e}),l=i.map(p=>ei(p)),c=o.map(p=>Li({eventModel:p})),s=r.map(p=>Wi({model:p}));return{playerVM:a,tileMapVM:h,npcVMs:l,eventVMs:c,settlementVMs:s,fogOfWarViewModel:d}},Ui=n=>{const{model:t}=n;return{getCurrentTurn:()=>t.getCurrentTurn(),nextTurn:()=>{t.nextTurn()},getCurrentClocktime:()=>{const e=t.getGameTimeMin(),i=Math.floor(e/60),o=e%60;return`${i.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},getCurrentTimeMin:()=>t.getGameTimeMin()}},vt=(n,t)=>Math.floor(Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))),zi=(n,t)=>{let e=[];for(const i of t){const o=i.position(),r=vt(n,o);e.length===0||r<e[0].distance?e=[{npc:i,distance:r}]:r===e[0].distance&&e.push({npc:i,distance:r})}return e},$i=(n,t)=>{let e=null,i=1/0;for(const o of t)o.positions().forEach(r=>{const d=vt(n,r);d<i&&(i=d,e=o)});return e},qi=(n,t)=>{let e=null,i=1/0;for(const o of t){const r=o.position(),d=vt(n,r);d<i&&(i=d,e=o)}return e},Fi=({playerVM:n,npcVMs:t,settlementVMs:e,eventViewModels:i})=>{const[o,r]=G(!0),[d,a]=G(null),[h,l]=G(null),[c,s]=G(null),[p,f]=G(null),[u,g]=G(null),[y,v]=G(null),[C,T]=G(null),[E,k]=G(null),[W,A]=G(null),[x,m]=G(null),b=1;let M=null,_=null,O=null,R=null,U=null,I,P=null,w=null,L=null,S=null;const B=($,Y)=>{if(Y){const it=Y.position();if(vt($,it)<=b)return M=Y,!0}return!1},H=($,Y)=>{if(!Y)return T(null),!1;const it=Y.position();return vt($,it)<=b&&Y.inventory().isEmpty()===!1?(O=Y,!0):!1},j=$=>$.isUnlocked()||!n.inventory().items().some(Y=>Y.code()==="city-key")?!1:(w=$,!0),Q=$=>$.isUnlocked()&&!$.inventory().isEmpty()?(L=$,!0):!1,ot=$=>$.isUnlocked()?(S=$,!0):!1,ht=$=>{const Y=$i($,e);return Y&&Y.positions().forEach(it=>{if(vt($,it)<=b)return j(Y),Q(Y),ot(Y),L||(R=Y),!0}),!1},at=($,Y)=>{if(Y){const it=Y.position(),nt=vt($,it);if(nt<=n.weapon().range()&&nt<=2&&!N($,Y))return U=Y,!0}return!1},N=($,Y)=>{if(Y){const it=Y.position(),nt=vt($,it);if(nt<=n.weapon().range()&&n.weapon().range()>2&&nt>1)return P=Y,!0}return!1},D=$=>{const Y=n.position();return vt(Y,$.position)<=b&&$.inventory.isEmpty()===!1?(I=$.inventory,!0):!1},z=$=>{if($){const Y=n.position(),it=$.position();if(vt(Y,it)<=b&&$.canTrade())return _=$,!0}return!1},X=$=>{if($.isHostile(n.team())){if($.isAlive()){const Y=at(n.position(),$),it=N(n.position(),$);return Y||it}else if($.inventory().isEmpty()===!1)return D({position:$.position(),inventory:$.inventory()})}else return $.isAlive()?(B(n.position(),$),z($)):D({position:$.position(),inventory:$.inventory()});return!1},J=()=>{M=null,_=null,O=null,R=null,U=null,I=null,P=null,w=null,L=null,S=null},gt=()=>{d()!==M&&a(M),h()!==_&&l(_),C()!==O&&T(O),c()!==R&&s(R),p()!==U&&f(U),y()!==I&&v(I),h()!==_&&l(_),u()!==P&&g(P),E()!==w&&k(w),W()!==L&&A(L),x()!==S&&m(S)},ut=()=>{const $=n.position(),Y=zi($,t),it=qi($,i);if(J(),Y.length>0)for(let nt=0;nt<Y.length;nt++){const oi=Y[nt].npc;if(X(oi))break}H($,it),ht($),gt()};return ut(),ct(()=>{rt(()=>{ut()})}),{isVisible:o,setVisibility:$=>r($),canUnlockSettlement:E,canInteractWithCharacter:d,canAttackCharacter:p,canTradeWithCharacter:h,canVisitSettlement:c,canSearch:C,canLoot:y,canRangedAttackCharacter:u,canTradeWithSettlement:W,canRestAtSettlement:x}},Gi=n=>{const{playerVM:t}=n,[e,i]=G(!1),[o,r]=G(!1),[d,a]=G(!1),[h,l]=G(0),c={torchLeft:()=>h(),health:()=>t.health(),maxHealth:()=>t.maxHealth(),armour:()=>c.bodyArmour().armour()+c.headArmour().armour()+c.feetArmour().armour(),maxArmour:()=>c.bodyArmour().maxArmour()+c.headArmour().maxArmour()+c.feetArmour().maxArmour(),inventoryValue:()=>Math.floor(t.inventory().items().reduce((s,p)=>s+p.value()*p.quantity(),0)),isInventoryValueVisible:s=>(s!==void 0&&i(s),e()),inventory:()=>t.inventory(),weapon:()=>t.weapon(),bodyArmour:()=>t.bodyArmour(),headArmour:()=>t.headArmour(),feetArmour:()=>t.feetArmour(),isInGameMenuVisible:()=>o(),showInGameMenu:s=>{a(!1),r(s)},isSaveCompleted:()=>d(),setIsSaveCompleted:s=>{setTimeout(()=>{a(!1)},2e3),a(s)}};return ct(()=>{rt(()=>{const s=t.inventory().stacks().find(p=>p.item.code()==="torch");l(s?s.quantity:0)})}),c},Yi=n=>{const{gameView:t,viewModel:e}=n,i=new K,o=new K;o.label="sensing-fog-of-war",o.alpha=.5,i.label="fog-of-war",i.zIndex=1e4,o.zIndex=10001;const r=()=>{i.destroy({children:!0}),o.destroy({children:!0})};t.addChild(i,o);const d=h=>{const s=h.x-innerWidth*.5,p=h.y-innerHeight*.5,f=innerWidth,u=innerHeight,g=Math.floor(s/64)-2,y=Math.floor(p/64)-2,v=Math.ceil((s+f)/64)+2,C=Math.ceil((p+u)/64)+2,T=[];for(let E=g;E<=v;E++)for(let k=y;k<=C;k++)T.push({x:E,y:k});return T};return{applyFogOfWarExceptAround:h=>{e.setFogOfWarPoints(d(h));const l=64;i.clear(),o.clear();const c=new pe;c.x=h.x,c.y=h.y,c.radius=e.lightRadius()*1.8;const s=new pe;s.x=h.x,s.y=h.y,s.radius=e.lightRadius();for(const p of e.fogOfWarPoints()){const f=new Zt;if(f.x=Math.floor(p.x*l),f.y=Math.floor(p.y*l),f.width=l,f.height=l,s.contains(f.x,f.y)){e.addRevealedPoint({x:p.x,y:p.y});continue}if(c.contains(f.x,f.y)){o.rect(f.x,f.y,l,l),o.fill("black"),e.revealedPoints().some(u=>u.x===p.x&&u.y===p.y)||e.addRevealedPoint({x:p.x,y:p.y});continue}if(e.revealedPoints().some(u=>u.x===p.x&&u.y===p.y)){o.rect(f.x,f.y,l,l),o.fill("black");continue}i.rect(f.x,f.y,l,l),i.fill(0)}},destroy:r}},Qi=({gameViews:n,userInterfaceView:t,fogOfWarVM:e})=>{const i=new q,o=new q,r=new K,d=.2,{gameView:a,nonSkewedView:h}=n;let l=!1,c=!1,s={x:0,y:0},p=null,f=Yi({gameView:a,viewModel:e}),u={x:0,y:0},g;i.label="camera-view",o.label="viewport",o.addChild(r,a,h),a.scale.set(.6),a.width=Math.floor(a.width),a.height=Math.floor(a.height);const y=()=>{p==null||p.kill(),document.removeEventListener("mousedown",C),document.removeEventListener("mouseup",T),document.removeEventListener("mousemove",E),document.removeEventListener("wheel",k),o.destroy({children:!0}),r.destroy(),f==null||f.destroy(),f=null,i.removeChildren(),i.destroy({children:!0})},v=(x,m)=>{r.clear(),r.rect(0,0,x,m),r.fill("black")};i.addChild(o,t);const C=x=>{x.button===0&&(l=!0)},T=x=>{x.button===0&&(l=!1,c=!1)},E=x=>{const m={x:x.clientX,y:x.clientY},b=m.x-s.x,M=m.y-s.y;if(c&&b!==0&&M!==0&&(l=!0),s={x:x.clientX,y:x.clientY},c){const{movementX:_,movementY:O}=x;a.position.x+=_,a.position.y+=O}},k=x=>{const{deltaY:m}=x;a.scale.x+m*.001>1||a.scale.x+m*.001<.5||(a.scale.x+=m*.001,a.scale.y+=m*.001)};document.addEventListener("mousedown",C),document.addEventListener("mouseup",T),document.addEventListener("mousemove",E),document.addEventListener("wheel",k);const W=(x,m)=>{const b=new Fe(x,m),M=a.toGlobal(b),_=innerWidth*.5,O=innerHeight*.5,R=a.position.x-(M.x-_),U=a.position.y-(M.y-O),I={x:Math.floor(R),y:Math.floor(U)},P={x:Math.floor(a.position.x),y:Math.floor(a.position.y)},L=Math.sqrt(Math.pow(I.x-P.x,2)+Math.pow(I.y-P.y,2))>98;p&&p.progress(1),p=Z.fromTo(P,{x:P.x,y:P.y},{x:I.x,y:I.y,duration:L?0:1,onUpdate:()=>{a.position.set(P.x,P.y),h.position.set(0,0),!g&&(g=Z.delayedCall(d,()=>{g=void 0}),f==null||f.applyFogOfWarExceptAround(b))},onComplete:()=>{f==null||f.applyFogOfWarExceptAround(b),u={x,y:m}}})};return{view:i,moveTo:W,resize:(x,m)=>{v(x,m),W(u.x,u.y)},destroy:y,isDragging:()=>l}},Xi=n=>{const{viewModel:t}=n,e=new q,i=t.isAlive()?F.from(`${t.id()}.png`):F.from("corpse.png");let o={x:0,y:0};e.label=`${t.id()}-view`,e.eventMode="static";const r=()=>{i.width=50,i.height=50,i.anchor.set(.5,.5),i.skew.set(.5,0),i.position.set(32,32),e.addChild(i),e.position.set(t.position().x*64,t.position().y*64)};return e.on("pointertap",()=>{V.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})}),r(),{view:e,update:()=>{e.visible=t.visible(),!t.isAlive()&&!i.label.includes("corpse")&&(et.play("audio/sfx/death.mp3",{category:"gameplay"}),i.label=`${t.id()}-corpse`,i.texture=F.from("corpse.png").texture);const a=t.position();if(o.x!==a.x||o.y!==a.y){const h=o.x>a.x,l=o.x!==a.x;if(o={x:a.x,y:a.y},et.play("audio/sfx/step.mp3",{category:"gameplay"}),!l)return;h?(e.scale.x=1,e.pivot.x=0,i.skew.set(-.5,0),i.position.set(32,16)):(e.scale.x=-1,i.position.set(-32,16),i.skew.set(.5,0))}}}},ji=n=>{const{viewModel:t}=n,e=new q;e.label=`${t.name()}-${t.id()}`;const i=F.from(`${t.id()}.png`);i.label=`${t.name()}-${t.id()}`,i.width=64,i.height=64;const o=F.from("cleared.png");o.width=64,o.height=64,o.label="discovered",o.visible=t.discovered(),o.position.set(-16,0);const r=F.from("loot-icon.png");return r.width=32,r.height=32,r.label="loot-available",r.tint="yellow",r.visible=t.discovered()&&!t.inventory().isEmpty(),r.position.set(i.width-r.width,i.height-r.height),e.addChild(i,o,r),e.skew.set(-.5,0),e.eventMode="static",e.on("pointertap",()=>{V.emit("ON_EVENT_INTERACTION",{eventViewModel:t})}),ct(()=>rt(()=>{e.visible=t.visible(),t.visible()&&t.discovered()&&(i.label.includes("visited")||(o.visible=!0,r.visible=!t.inventory().isEmpty()))}),e),{view:e}},ke={"bed-time":"task-bed-time",patrol:"magnifying-glass-icon",follow:"walking-icon",work:"coins-icon",idle:"task-idle",attack:"attack-icon"},Zi=n=>{const{cellSize:t,npcVMs:e}=n,i=new q,o=new Map;i.label="npc-task-view";const r=c=>{var g;const s=new q,p=new K,f=((g=c.getTask())==null?void 0:g.name())??"idle",u=F.from(`${ke[f]||"task-idle"}.png`);s.label=`task-icon-container-${c.id()}`,s.addChild(p,u),u.label=`task-${f}.png`,u.width=t/2,u.height=t/2,o.set(c,{icon:u,container:s,background:p}),p.circle(u.width/2,u.height/2,u.width/1.3),p.fill("khaki"),p.alpha=.75,i.addChild(s)},d=c=>{o.has(c)||r(c)},a=()=>{i.visible=!0},h=()=>{i.visible=!1},l=()=>{o.forEach((c,s)=>{var u;if(c.container.visible=s.visible()&&s.isAlive(),!s.isAlive()){i.removeChild(c.container),c.icon.destroy(),c.background.destroy(),c.container.destroy(),o.delete(s);return}const p=((u=s.getTask())==null?void 0:u.name())??"idle",f=ke[p]||"task-idle";c.icon.label!==`${f}.png`&&(c.icon.label=`${f}.png`,c.icon.texture=F.from(`${f}.png`).texture),c.container.position.set((s.position().x+.5)*n.cellSize-c.icon.width/2,s.position().y*n.cellSize-t*.6)})};return e.forEach(c=>{d(c)}),{view:i,show:a,hide:h,update:l,addNpc:d}},Me=new Array(5).fill(0),_e=n=>{const{viewModel:t,onStep:e}=n,i=new q;let o=t.id();if(o==="bandit"){const l=Math.floor(Math.random()*5),c=Me.reduce((s,p,f,u)=>p<u[s]?f:s,l);o=`bandit-${c}`,Me[c]++,o=`bandit-${c}`}const r=t.isAlive()?F.from(`${o}.png`):F.from("corpse.png");r.label=t.isAlive()?`${t.id()}-sprite`:`${t.id()}-corpse-sprite`,i.label=`${t.name()}-view`,i.eventMode="static";const d=()=>{const l=t.size()*50;r.width=l,r.height=l,r.anchor.set(.5,.5),r.skew.set(-.5,0),r.position.set(32,32),i.addChild(r),i.position.set(t.position().x,t.position().y)};i.on("pointertap",()=>{V.emit("ON_CHARACTER_INTERACTION_REQUEST",{action:"open",character:t})}),d();let a={x:t.position().x,y:t.position().y};const h=()=>{if(!t.isAlive()&&!r.label.includes("corpse")){et.play("audio/sfx/death.mp3",{category:"gameplay"}),r.label=`${t.id()}-corpse-sprite`,r.texture=F.from("corpse.png").texture;return}};return ct(()=>{rt(()=>{i.visible=t.visible();const l=t.position();if(a.x!==l.x||a.y!==l.y){const c=a.x>l.x,s=a.x!==l.x;if(a={x:l.x,y:l.y},e(),!s)return;c?(i.scale.x=1,i.pivot.x=0,r.skew.set(-.5,0),r.position.set(32,16)):(i.scale.x=-1,r.position.set(-32,16),r.skew.set(.5,0))}})}),{view:i,update:h}},Ki=({viewModel:n,onUnlocked:t})=>{const e=new q;e.label="settlement-view";const i=F.from(`${n.id()}.png`);let o=0,r=0;n.positions().forEach(a=>{a.x>=o&&(o=a.x),a.y>=r&&(r=a.y)}),i.width=Math.floor((o-n.positions()[0].x+1)*64),i.height=Math.floor((r-n.positions()[0].y+1)*64);const d=F.from("blocked.png");return d.width=i.width,d.height=i.height,d.visible=!n.isUnlocked(),e.addChild(i,d),e.eventMode="none",e.skew.set(-.46,0),ct(()=>{rt(()=>{e.visible=n.isVisible(),d.visible&&n.isUnlocked()&&t(),d.visible=!n.isUnlocked()})},e),{view:e}},Ji=(n,t,e)=>{n.alpha=0,Z.to(n,{alpha:1,duration:t/1e3,onComplete:e})},tn=(n,t,e)=>{Z.to(n,{alpha:0,duration:t/1e3,onComplete:()=>{e()}})},ii=n=>{const{tileSize:t,viewModel:e}=n,{isMiniMapTile:i=!1}=n,o=new q;let r=new F,d=new F;o.label="tile-view",o.eventMode="static";const a=e.type();let h=a;h==="wasteland"?h+=`-${Math.floor(Math.random()*2)}`:h==="forest"?h+=`-${Math.floor(Math.random()*2)}`:h==="settlement"&&(h="wasteland");const l=F.from(`${h}.png`);if(l.width=t,l.height=t,l.anchor.set(.5,.5),l.position.set(t/2,t/2),h==="settlement"&&(l.visible=!1),o.addChild(l),e.hasMud()){const c=F.from("mud.png");c.width=t*.6,c.height=t*.6,c.position.set(t*.2,t*.2),c.alpha=.6,o.addChild(c)}if(!e.traversable()&&a==="void"){const c=Math.floor(Math.random()*6),s=["dead-trees-0","dead-trees-1","dead-trees-2","dead-trees-3","dead-trees-4","dead-trees-1"][c];r=F.from(`${s}.png`),r.width=t*1.2,r.height=t*1.2,r.skew.set(-.5,0)}if(e.hasGrass()){const c=F.from("dead-grass.png");c.width=t*.6,c.height=t*.6,c.alpha=1,c.skew.set(-.4,0),c.position.set(20,0),o.addChild(c)}if(e.hasEyes()){d=F.from("eyes.png"),d.width=t*.8,d.height=t*.8,d.skew.set(-.5,0),d.zIndex=d.position.y+32,d.alpha=0;const c=async()=>{await new Promise(s=>{setTimeout(()=>s(),(d.alpha===1?Math.random()*2e3:Math.random()*5e3)+2e3)}),d.alpha===0?Ji(d,1e3,c):tn(d,1e3,c)};c()}return o.on("pointertap",()=>{V.emit("ON_TILE_INTERACTION",{tileViewModel:e})}),ct(()=>{rt(()=>{o.visible=i?e.discovered():e.visible(),d.visible=e.visible(),r.visible=e.visible()}),rt(()=>{o.tint=e.isSelected()?65280:16777215})},o),{view:o,trees:r,eyes:d}},en=n=>{const{viewModel:t,tileSize:e}=n,i=new q;i.label="tile-map-view",i.sortableChildren=!0;const o=t.tiles(),r=[],d=[];return o.forEach((a,h)=>{a.forEach((l,c)=>{const s=ii({tileSize:e,viewModel:l});s.view.label=`tile-${h}-${c}`,s.view.position.set(h*e,c*e),s.trees.position.set(s.view.position.x+20,s.view.position.y-20),s.eyes.position.set(s.view.x+32,s.view.y-20),r.push(s.trees),d.push(s.eyes),i.addChild(s.view)})}),{view:i,trees:r,eyes:d}},nn=n=>{const{viewModel:t}=n,e=new q,i=[],o=64,r=new Map,d=p=>{const f=p.health(),u=p.maxHealth(),g=f/u,y=o*g,{x:v,y:C}=p.position();let T=r.get(p);T?T.clear():T=new K,T.clear(),T.rect(v*o,C*o-10,o,5),T.fill(0),T.rect(v*o,C*o-10,y,5),T.fill(65280),T.label=`${p.name()}-health-bar`,e.addChild(T),r.set(p,T),Z.to(T,{alpha:0,duration:1,delay:1,onComplete:()=>{e.removeChild(T),T.destroy(),r.delete(p)}})},a=(p,f)=>({x:(p.x+f.x)/2,y:(p.y+f.y)/2}),h=p=>{if(e.destroyed)return;const f=p.position(),u=F.from("blood.png");u.width=o,u.height=o,u.position.set(f.x*o,f.y*o),e.addChild(u),p.armour()>0?(u.tint="blue",et.play("audio/sfx/collect.wav",{category:"gameplay"})):(et.play("audio/sfx/fists.mp3",{category:"gameplay"}),d(p)),Z.to(u,{alpha:0,duration:.333,ease:"power2.inOut",onComplete:()=>{e.removeChild(u),u.destroy()}})},l=async({source:p,target:f})=>{const u=F.from("slash.png");u.scale.set(.15),u.anchor.set(.5),u.position.set(a(p.position(),f.position()).x*64+32,a(p.position(),f.position()).y*64+32),u.rotation=Math.atan2(f.position().y-p.position().y,f.position().x-p.position().x),e.addChild(u),u.alpha=0,await Z.to(u,{alpha:1,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),h(f)},c=async({source:p,target:f})=>{const u=F.from("arrow.png");u.scale.set(.1),u.anchor.set(.5),u.position.set(p.position().x*64+32,p.position().y*64+32),u.rotation=Math.atan2(f.position().y-p.position().y,f.position().x-p.position().x),e.addChild(u),await Z.to(u.position,{x:f.position().x*64+32,y:f.position().y*64+32,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),h(f)},s=async()=>{for(;i.length>0;){const p=i.shift();p&&await p()}};return ct(()=>{rt(()=>{const p=t.isAttacking();p&&(p.type==="ranged"?i.push(()=>c(p)):i.push(()=>l(p)))})}),{view:e,process:s}},on=n=>{const{attackVM:t,tileMapVM:e,playerVM:i,tileSize:o,npcVMs:r,eventVMs:d,settlementVMs:a}=n,h=new q,l=new q,c=new q,s=new q,p=nn({viewModel:t});let f=null;l.label="game-view-container",c.label="tile-container",s.label="talk-overlay",l.sortableChildren=!0,c.zIndex=-1e3;const u=new Map,g=Zi({cellSize:o,npcVMs:r}),y=new Map;let v=null,C=null,T=[],E=[],k=[];const W=[];let A=!1;const x=S=>{const B=_e({viewModel:S,onStep:()=>{S.position().distanceTo(i.position())<6&&et.play("audio/sfx/step.mp3",{category:"gameplay"})}});r.push(S),l.addChild(B.view),T.push(B)},m=()=>{C=en({viewModel:e,tileSize:o}),C.view.label="tile-map-view",v=Xi({viewModel:i}),c.addChild(C.view),C.trees.forEach(S=>{l.addChild(S)}),C.eyes.forEach(S=>{l.addChild(S)}),d.map(S=>{const B=ji({viewModel:S});E.push(B),l.addChild(B.view)}),T=r.map(S=>{const B=_e({viewModel:S,onStep:()=>{S.position().distanceTo(i.position())<6&&et.play("audio/sfx/step.mp3",{category:"gameplay"})}});return l.addChild(B.view),B}),a.map(S=>{const B=Ki({viewModel:S,onUnlocked:()=>{w("city-key",S.getMiddleTopPosition())}});k.push(B),l.addChild(B.view),B.view.label=`settlement-${S.id()}`,B.view.position.set(S.positions()[0].x*o+52,S.positions()[0].y*o-30),B.view.zIndex=B.view.y+32}),l.addChild(c,v.view,s,p.view)},b=S=>{M(),f=F.from("walking-icon.png"),f.tint="green",f.width=o*.5,f.height=o*.5,f.skew.x=-.5,f.position.set(S.x*o+o*.5,S.y*o),f.zIndex=11e3,l.addChild(f)},M=()=>{f&&(l.removeChild(f),f.destroy(),f=null)},_=()=>{A=!0,W.forEach(S=>S.kill()),C==null||C.view.destroy({children:!0}),v==null||v.view.destroy({children:!0}),s.removeChildren(),C=null,v=null,T.forEach(S=>S.view.destroy({children:!0})),T=[],E.forEach(S=>S.view.destroy({children:!0})),E=[],k.forEach(S=>S.view.destroy({children:!0})),k=[],u.clear(),l.destroy({children:!0})},O=["snow","lightskyblue","lime","yellow","fuchsia","orange"],R=()=>{const S=["snow","lightskyblue","lime","yellow","fuchsia","orange"];return O.length===0&&O.push(...S),O.splice(Math.floor(Math.random()*O.length),1)[0]},U=S=>{const{x:H,y:j}=S.position(),Q=new _t;if(u.get(S.id()))return;Q.style={fontFamily:"alagard",fontSize:32,fill:R(),align:"center",dropShadow:!0,stroke:"black",wordWrap:!0,wordWrapWidth:innerWidth*1.5},Q.text=S.dialogue(),Q.anchor.set(.5);let ht=0;const at=H*o+o/2,N=j*o-o;Q.position.set(at,N),u.forEach(z=>{Q.getBounds().containsPoint(z.position.x,z.position.y)&&(ht+=z.height),Q.position.set(at,N-ht)}),Q.label="text-box",Q.zIndex=11e3;const D=l.toGlobal(Q.position);return Q.position.set(D.x,D.y),Q.scale.set(.6),h.addChild(Q),setTimeout(()=>{const z=u.get(S.id());z&&(l.removeChild(z),u.delete(S.id()),z.destroy())},2e3),u.set(S.id(),Q),Q},I=(S,B)=>{const{x:H,y:j}=B,Q=H*o,ot=j*o;W.push(Z.to(S.view.position,{x:Q,y:ot,duration:.2,ease:"power2.inOut",onUpdate:()=>{S.view.zIndex=S.view.position.y},onComplete:()=>{S.view.position.set(Q,ot)}}))},P=async()=>{if(A)return;const{x:S,y:B}=i.position();v&&(v.update(),v.view.zIndex=v.view.position.y,(v.view.position.x!==S*o||v.view.position.y!==B*o)&&I(v,{x:S,y:B})),await p.process();for(const H of T){const j=T.indexOf(H),{x:Q,y:ot}=r[j].position();H.update(),(H.view.position.x!==Q*o||H.view.position.y!==ot*o)&&I(H,{x:Q,y:ot})}E.forEach((H,j)=>{const{x:Q,y:ot}=d[j].position();H.view.position.set(Q*o+20,ot*o-50),H.view.scale.set(1.5,1.5),H.view.zIndex=H.view.y+32}),g.update()},w=async(S,B)=>{const H=new q;H.label="looted-icon-container";const j=F.from(`${S}.png`);j.width=o/2,j.height=o/2;const Q=new K;Q.circle(o*.25,o*.25,o/2),Q.fill("khaki"),H.addChild(Q,j),H.zIndex=11e3,H.position.set((B.x+1)*o,B.y*o-o);const ot=l.toGlobal(H.position);h.addChild(H),H.position.set(ot.x,ot.y),H.scale.set(.6);const ht=y.get(`${{x:B.x,y:B.y}}`)??0;y.set(`${{x:B.x,y:B.y}}`,ht+1),await Z.delayedCall(.2*ht,()=>{}),Z.to(H.position,{y:H.position.y-o*4,duration:1,delay:ht*.1,ease:"power2.inOut",onComplete:()=>{h.removeChild(H),H.destroy({children:!0});const at=y.get(`${{x:B.x,y:B.y}}`)??0;at>1?y.set(`${{x:B.x,y:B.y}}`,at-1):y.delete(`${{x:B.x,y:B.y}}`)}})};m(),P(),l.skew.set(Math.PI/6,0),p.view.zIndex=11e3;const L=new K;return h.addChild(L),h.label="non-skewed-container",L.rect(0,0,innerWidth,innerHeight),L.fill("black"),L.alpha=0,{view:l,nonSkewedContainer:h,addNpc:x,animateIconFloat:w,handleEndOfTurnUpdates:P,createTextBox:U,destroy:_,showPathTrigger:b,hidePathTrigger:M}};var ne={},At={},Ee;function Gt(){if(Ee)return At;Ee=1,Object.defineProperty(At,"__esModule",{value:!0}),At.Collector=void 0;let n=class{constructor(e){this.emit=(...i)=>{e.emitCollecting(this,i)}}};return At.Collector=n,At}var Pt={},Se;function sn(){if(Se)return Pt;Se=1,Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.CollectorArray=void 0;const n=Gt();let t=class extends n.Collector{constructor(){super(...arguments),this.result=[]}handleResult(i){return this.result.push(i),!0}getResult(){return this.result}reset(){this.result.length=0}};return Pt.CollectorArray=t,Pt}var Nt={},Ae;function rn(){if(Ae)return Nt;Ae=1,Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.CollectorLast=void 0;const n=Gt();let t=class extends n.Collector{handleResult(i){return this.result=i,!0}getResult(){return this.result}reset(){delete this.result}};return Nt.CollectorLast=t,Nt}var Ot={},Pe;function an(){if(Pe)return Ot;Pe=1,Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.CollectorUntil0=void 0;const n=Gt();let t=class extends n.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,this.result}getResult(){return this.result}reset(){this.result=!1}};return Ot.CollectorUntil0=t,Ot}var Rt={},Ne;function ln(){if(Ne)return Rt;Ne=1,Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.CollectorWhile0=void 0;const n=Gt();let t=class extends n.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,!this.result}getResult(){return this.result}reset(){this.result=!1}};return Rt.CollectorWhile0=t,Rt}var Vt={},Lt={},Oe;function cn(){if(Oe)return Lt;Oe=1,Object.defineProperty(Lt,"__esModule",{value:!0}),Lt.SignalConnectionImpl=void 0;class n{constructor(e,i){this.link=e,this.parentCleanup=i}disconnect(){return this.link!==null?(this.link.unlink(),this.link=null,this.parentCleanup(),this.parentCleanup=null,!0):!1}set enabled(e){this.link&&this.link.setEnabled(e)}get enabled(){return this.link!==null&&this.link.isEnabled()}}return Lt.SignalConnectionImpl=n,Lt}var Bt={},Re;function hn(){if(Re)return Bt;Re=1,Object.defineProperty(Bt,"__esModule",{value:!0}),Bt.SignalLink=void 0;let n=class ni{constructor(e=null,i=null,o=0){this.enabled=!0,this.newLink=!1,this.callback=null,this.prev=e??this,this.next=i??this,this.order=o}isEnabled(){return this.enabled&&!this.newLink}setEnabled(e){this.enabled=e}unlink(){this.callback=null,this.next.prev=this.prev,this.prev.next=this.next}insert(e,i){let o=this.prev;for(;o!==this&&!(o.order<=i);)o=o.prev;const r=new ni(o,o.next,i);return r.callback=e,o.next=r,r.next.prev=r,r}};return Bt.SignalLink=n,Bt}var Ve;function dn(){if(Ve)return Vt;Ve=1,Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.Signal=void 0;const n=cn(),t=hn();let e=class{constructor(){this.head=new t.SignalLink,this.hasNewLinks=!1,this.emitDepth=0,this.connectionsCount=0}getConnectionsCount(){return this.connectionsCount}hasConnections(){return this.connectionsCount>0}connect(o,r=0){this.connectionsCount++;const d=this.head.insert(o,r);return this.emitDepth>0&&(this.hasNewLinks=!0,d.newLink=!0),new n.SignalConnectionImpl(d,()=>this.decrementConnectionCount())}decrementConnectionCount(){this.connectionsCount--}disconnect(o){for(let r=this.head.next;r!==this.head;r=r.next)if(r.callback===o)return this.decrementConnectionCount(),r.unlink(),!0;return!1}disconnectAll(){for(;this.head.next!==this.head;)this.head.next.unlink();this.connectionsCount=0}emit(...o){this.emitDepth++;for(let r=this.head.next;r!==this.head;r=r.next)r.isEnabled()&&r.callback&&r.callback.apply(null,o);this.emitDepth--,this.unsetNewLink()}emitCollecting(o,r){this.emitDepth++;for(let d=this.head.next;d!==this.head;d=d.next)if(d.isEnabled()&&d.callback){const a=d.callback.apply(null,r);if(!o.handleResult(a))break}this.emitDepth--,this.unsetNewLink()}unsetNewLink(){if(this.hasNewLinks&&this.emitDepth===0){for(let o=this.head.next;o!==this.head;o=o.next)o.newLink=!1;this.hasNewLinks=!1}}};return Vt.Signal=e,Vt}var Dt={},Le;function un(){if(Le)return Dt;Le=1,Object.defineProperty(Dt,"__esModule",{value:!0}),Dt.SignalConnections=void 0;let n=class{constructor(){this.list=[]}add(e){this.list.push(e)}disconnectAll(){for(const e of this.list)e.disconnect();this.list=[]}getCount(){return this.list.length}isEmpty(){return this.list.length===0}};return Dt.SignalConnections=n,Dt}var Be;function fn(){return Be||(Be=1,function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.SignalConnections=n.Signal=n.CollectorWhile0=n.CollectorUntil0=n.CollectorLast=n.CollectorArray=n.Collector=void 0;var t=Gt();Object.defineProperty(n,"Collector",{enumerable:!0,get:function(){return t.Collector}});var e=sn();Object.defineProperty(n,"CollectorArray",{enumerable:!0,get:function(){return e.CollectorArray}});var i=rn();Object.defineProperty(n,"CollectorLast",{enumerable:!0,get:function(){return i.CollectorLast}});var o=an();Object.defineProperty(n,"CollectorUntil0",{enumerable:!0,get:function(){return o.CollectorUntil0}});var r=ln();Object.defineProperty(n,"CollectorWhile0",{enumerable:!0,get:function(){return r.CollectorWhile0}});var d=dn();Object.defineProperty(n,"Signal",{enumerable:!0,get:function(){return d.Signal}});var a=un();Object.defineProperty(n,"SignalConnections",{enumerable:!0,get:function(){return a.SignalConnections}})}(ne)),ne}var De=fn(),pn=Object.defineProperty,mn=(n,t,e)=>t in n?pn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Wt=(n,t,e)=>mn(n,typeof t!="symbol"?t+"":t,e);class gn extends q{constructor(t){var e;super(),Wt(this,"options"),Wt(this,"view"),Wt(this,"_type"),Wt(this,"_maxWidth"),Wt(this,"children",[]),t&&(t.maxWidth&&(this._maxWidth=t.maxWidth),this.init(t)),(e=t==null?void 0:t.items)==null||e.forEach(i=>this.addChild(i)),this.on("added",()=>this.arrangeChildren()),this.on("childAdded",()=>this.arrangeChildren())}init(t){this.options=t,t!=null&&t.type&&(this.type=t.type),t!=null&&t.children&&t.children.forEach(e=>this.addChild(e))}set type(t){this._type=t,this.arrangeChildren()}get type(){return this._type}set elementsMargin(t){if(!this.options)throw new Error("List has not been initiated!");this.options.elementsMargin=t,this.arrangeChildren()}get elementsMargin(){var t;return((t=this.options)==null?void 0:t.elementsMargin)??0}set padding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.padding=t,this.options.vertPadding=t,this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get padding(){var t;return((t=this.options)==null?void 0:t.padding)??0}set vertPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.vertPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get vertPadding(){var t;return((t=this.options)==null?void 0:t.vertPadding)??this.padding??0}set horPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.arrangeChildren()}get horPadding(){var t;return((t=this.options)==null?void 0:t.horPadding)??this.padding??0}set leftPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.leftPadding=t,this.arrangeChildren()}get leftPadding(){var t;return((t=this.options)==null?void 0:t.leftPadding)??this.horPadding}set rightPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.rightPadding=t,this.arrangeChildren()}get rightPadding(){var t;return((t=this.options)==null?void 0:t.rightPadding)??this.horPadding}set topPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.topPadding=t,this.arrangeChildren()}get topPadding(){var t;return((t=this.options)==null?void 0:t.topPadding)??this.vertPadding}set bottomPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.bottomPadding=t,this.arrangeChildren()}get bottomPadding(){var t;return((t=this.options)==null?void 0:t.bottomPadding)??this.vertPadding}arrangeChildren(){var d,a;let t=0,e=this.leftPadding,i=this.topPadding;const o=((d=this.options)==null?void 0:d.elementsMargin)??0;let r=this.maxWidth??((a=this.parent)==null?void 0:a.width);this.rightPadding&&(r-=this.rightPadding),this.children.forEach((h,l)=>{switch(this.type){case"vertical":h.y=i,h.x=e,i+=o+h.height;break;case"horizontal":h.x=e,h.y=i,e+=o+h.width;break;case"bidirectional":default:h.x=e,h.y=i,h.x+h.width>r&&l>0&&(i+=o+t,e=this.leftPadding,h.x=e,h.y=i,t=0),t=Math.max(t,h.height),e+=o+h.width;break}})}removeItem(t){const e=this.children[t];e&&(this.removeChild(e),this.arrangeChildren())}set maxWidth(t){this._maxWidth=t,this.arrangeChildren()}get maxWidth(){return this._maxWidth}}var yn=Object.defineProperty,vn=(n,t,e)=>t in n?yn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Ht=(n,t,e)=>vn(n,typeof t!="symbol"?t+"":t,e);class wn{constructor(t={}){Ht(this,"x"),Ht(this,"ax"),Ht(this,"dx"),Ht(this,"tx"),Ht(this,"_options"),this.x=0,this.ax=0,this.dx=0,this.tx=0,this._options=t,this._options.max=t.max||160,this._options.damp=t.damp||.8,this._options.springiness=t.springiness||.1}update(){this.ax=(this.tx-this.x)*this._options.springiness,this.dx+=this.ax,this.dx*=this._options.damp,this.dx<-this._options.max?this.dx=-this._options.max:this.dx>this._options.max&&(this.dx=this._options.max),this.x+=this.dx}reset(){this.x=0,this.ax=0,this.dx=0,this.tx=0}get max(){return this._options.max}set max(t){this._options.max=t}get damp(){return this._options.damp}set damp(t){this._options.damp=t}get springiness(){return this._options.springiness}set springiness(t){this._options.springiness=t}}var bn=Object.defineProperty,xn=(n,t,e)=>t in n?bn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Et=(n,t,e)=>xn(n,typeof t!="symbol"?t+"":t,e);class Cn{constructor(){Et(this,"done"),Et(this,"to"),Et(this,"_spring"),Et(this,"_pos"),Et(this,"_speed"),Et(this,"_correctSpeed"),this._spring=new wn,this._pos=0,this.to=0}start(t,e,i){this._speed=t,this._pos=e,this.to=i,this.done=!1,this._spring.x=this._pos,this._spring.tx=this.to;const o=this.to-this._pos,r=Math.abs(o)/o,d=Math.abs(this._speed)/this._speed;r!==d?this._correctSpeed=!0:this._correctSpeed=!1}update(){if(this._correctSpeed)this._speed*=.6,Math.abs(this._speed)<2&&(this._correctSpeed=!1),this._pos+=this._speed,this._spring.x=this._pos;else{const t=this.to-this._pos;Math.abs(t)<.05?(this._pos=this.to,this.done=!0):(this._spring.tx=this.to,this._spring.update(),this._pos=this._spring.x)}return this._pos}cancel(){}}var Tn=Object.defineProperty,In=(n,t,e)=>t in n?Tn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,dt=(n,t,e)=>In(n,typeof t!="symbol"?t+"":t,e);class We{constructor(t={}){dt(this,"position",0),dt(this,"constrain",!0),dt(this,"min",0),dt(this,"max",0),dt(this,"maxSpeed",400),dt(this,"_ease"),dt(this,"_offset",0),dt(this,"_prev",0),dt(this,"_speed",0),dt(this,"_hasStopped"),dt(this,"_targetSpeed",0),dt(this,"_speedChecker",0),dt(this,"_grab",0),dt(this,"_activeEase"),this.constrain=t.constrain??!0,this.maxSpeed=t.maxSpeed??400,this._ease=t.ease??new Cn}set value(t){this._speed=0,this.position=t}get value(){return this.position}grab(t){this._grab=t,this._offset=this.position-t,this._speedChecker=0,this._targetSpeed=this._speed=0,this._hasStopped=!1}hold(t){this._speedChecker++,this.position=t+this._offset,this._speedChecker>1&&(this._targetSpeed=this.position-this._prev),this._speed+=(this._targetSpeed-this._speed)/2,this._speed>this.maxSpeed?this._speed=this.maxSpeed:this._speed<-this.maxSpeed&&(this._speed=-this.maxSpeed),this._prev=this.position,this.constrain&&(this._activeEase=null,this.position>this.min?this.position-=(this.position-this.min)/1.5:this.position<this.max&&(this.position+=(this.max-this.position)/1.5))}slide(t=!1){this._hasStopped||(this.constrain?this._updateConstrain(t):this._updateDefault())}get moveAmount(){return-(this.position-this._offset-this._grab)}_updateDefault(){this._speed*=.9,this.position+=this._speed,(this._speed<0?this._speed*-1:this._speed)<.01&&(this._hasStopped=!0)}_updateConstrain(t=!1){const e=this.max;t?(this.value>0&&(this.value=0),this.value>0&&(this.value=0),this.value<this.max&&(this.value=this.max),this.value<this.max&&(this.value=this.max)):this.position>this.min||this.position<e||this._activeEase?(this._activeEase||(this._activeEase=this._ease,this.position>this.min?this._activeEase.start(this._speed,this.position,this.min):this._activeEase.start(this._speed,this.position,e)),this.position=this._activeEase.update(),this._activeEase.done&&(this.position=this._activeEase.to,this._speed=0,this._activeEase=null)):this._updateDefault()}}var kn=Object.defineProperty,Mn=(n,t,e)=>t in n?kn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Ct=(n,t,e)=>Mn(n,typeof t!="symbol"?t+"":t,e);class _n{constructor(t){Ct(this,"xAxis"),Ct(this,"yAxis"),Ct(this,"_isDown"),Ct(this,"_globalPosition"),Ct(this,"_frame"),Ct(this,"_bounds"),Ct(this,"_dirty"),Ct(this,"disableEasing",!1),this.xAxis=new We({ease:t.xEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.yAxis=new We({ease:t.yEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.disableEasing=t.disableEasing??!1,this._frame=new Zt,this._bounds=new Zt,this._globalPosition=new Fe}pointerDown(t){this._globalPosition=t,this.xAxis.grab(t.x),this.yAxis.grab(t.y),this._isDown=!0}pointerUp(){this._isDown=!1}pointerMove(t){this._globalPosition=t}update(){this._dirty&&(this._dirty=!1,this.xAxis.min=this._bounds.left,this.xAxis.min=this._bounds.right-this._frame.width,this.xAxis.min=this._bounds.top,this.xAxis.min=this._bounds.bottom-this._frame.height),this._isDown?(this.xAxis.hold(this._globalPosition.x),this.yAxis.hold(this._globalPosition.y)):(this.xAxis.slide(this.disableEasing),this.yAxis.slide(this.disableEasing))}resize(t,e){this._frame.x=0,this._frame.width=t,this._frame.y=0,this._frame.height=e,this._dirty=!0}setBounds(t,e,i,o){this._bounds.x=t,this._bounds.width=e-t,this._bounds.y=i,this._bounds.height=o-i,this._dirty=!0}get x(){return this.xAxis.value}get y(){return this.yAxis.value}}var En=Object.defineProperty,Sn=(n,t,e)=>t in n?En(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,tt=(n,t,e)=>Sn(n,typeof t!="symbol"?t+"":t,e);class ue extends q{constructor(t){super(),tt(this,"background"),tt(this,"borderMask"),tt(this,"lastWidth"),tt(this,"lastHeight"),tt(this,"_width",0),tt(this,"_height",0),tt(this,"_dimensionChanged",!1),tt(this,"list"),tt(this,"_trackpad"),tt(this,"isDragging",0),tt(this,"interactiveStorage",[]),tt(this,"visibleItems",[]),tt(this,"pressedChild"),tt(this,"ticker",li.shared),tt(this,"options"),tt(this,"stopRenderHiddenItemsTimeout"),tt(this,"onMouseScrollBinding",this.onMouseScroll.bind(this)),tt(this,"dragStarTouchPoint"),tt(this,"isOver",!1),tt(this,"proximityRange"),tt(this,"proximityStatusCache",[]),tt(this,"lastScrollX"),tt(this,"lastScrollY"),tt(this,"proximityCheckFrameCounter",0),tt(this,"onProximityChange",new De.Signal),tt(this,"onScroll",new De.Signal),t&&this.init(t),this.ticker.add(this.update,this)}init(t){this.options=t,this.setBackground(t.background),this._width=t.width|this.background.width,this._height=t.height|this.background.height,this.proximityRange=t.proximityRange??0,this.list||(this.list=new gn,super.addChild(this.list)),this.list.init({type:t.type,elementsMargin:t.elementsMargin,padding:t.padding,vertPadding:t.vertPadding,horPadding:t.horPadding,topPadding:t.topPadding,bottomPadding:t.bottomPadding,leftPadding:t.leftPadding,rightPadding:t.rightPadding}),this.addItems(t.items),this.hasBounds&&(this.addMask(),this.makeScrollable()),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.options.globalScroll=t.globalScroll??!0,this.options.shiftScroll=t.shiftScroll??!1,this.resize()}get hasBounds(){return!!this._width||!!this._height}addItems(t){t!=null&&t.length&&t.forEach(e=>this.addItem(e))}removeItems(){this.proximityStatusCache.length=0,this.list.removeChildren()}addItem(...t){if(t.length>1)t.forEach(e=>this.addItem(e));else{const e=t[0];(!e.width||!e.height)&&console.error("ScrollBox item should have size"),e.eventMode="static",this.list.addChild(e),this.proximityStatusCache.push(!1),this.options.disableDynamicRendering||(e.renderable=this.isItemVisible(e))}return this.resize(),t[0]}removeItem(t){this.list.removeItem(t),this.proximityStatusCache.splice(t,1),this.resize()}isItemVisible(t,e=0){let i=!1;const o=this.list;if(this.isVertical||this.isBidirectional){const r=t.y+o.y;r+t.height>=-e&&r<=this.options.height+e&&(i=!0)}if(this.isHorizontal||this.isBidirectional){const r=t.x+o.x;r+t.width>=-e&&r<=this.options.width+e&&(i=!0)}return i}get items(){var t;return((t=this.list)==null?void 0:t.children)??[]}setBackground(t){this.background&&this.removeChild(this.background),this.options.background=t,this.background=new K,this.addChildAt(this.background,0),this.resize()}addMask(){this.borderMask||(this.borderMask=new K,super.addChild(this.borderMask),this.mask=this.borderMask),this.resize()}makeScrollable(){this._trackpad||(this._trackpad=new _n({disableEasing:this.options.disableEasing})),this.on("pointerdown",t=>{this.renderAllItems(),this.isDragging=1,this.dragStarTouchPoint=this.worldTransform.applyInverse(t.global),this._trackpad.pointerDown(this.dragStarTouchPoint);const e=this.list.worldTransform.applyInverse(t.global);this.visibleItems.forEach(i=>{i.x<e.x&&i.x+i.width>e.x&&i.y<e.y&&i.y+i.height>e.y&&(this.pressedChild=i)})}),this.on("pointerup",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("pointerover",()=>{this.isOver=!0}),this.on("pointerout",()=>{this.isOver=!1}),this.on("pointerupoutside",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("globalpointermove",t=>{var i,o;if(!this.isDragging)return;const e=this.worldTransform.applyInverse(t.global);if(this.dragStarTouchPoint){const r=this.options.dragTrashHold??10;if(this.isHorizontal||this.isBidirectional){const d=e.x-this.dragStarTouchPoint.x;Math.abs(d)>r&&(this.isDragging=2)}if(this.isVertical||this.isBidirectional){const d=e.y-this.dragStarTouchPoint.y;Math.abs(d)>r&&(this.isDragging=2)}}this.dragStarTouchPoint&&this.isDragging!==2||(this._trackpad.pointerMove(e),this.pressedChild&&(this.revertClick(this.pressedChild),this.pressedChild=null),this.isBidirectional?(i=this.onScroll)==null||i.emit({x:this.scrollX,y:this.scrollY}):(o=this.onScroll)==null||o.emit(this.isVertical?this.scrollY:this.scrollX))}),document.addEventListener("wheel",this.onMouseScrollBinding,!0)}setInteractive(t){this.eventMode=t?"static":"auto"}get listHeight(){return this.list.height+this.list.topPadding+this.list.bottomPadding}get listWidth(){return this.list.width+this.list.leftPadding+this.list.rightPadding}resize(t=!1){if(this.hasBounds){if(this.renderAllItems(),this.borderMask&&(t||this._dimensionChanged||this.lastWidth!==this.listWidth||this.lastHeight!==this.listHeight)){this.options.width||(this._width+=this.listWidth),this.options.height||(this._height+=this.listHeight),this.borderMask.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill(16711935).stroke(0),this.borderMask.eventMode="none";const e=this.options.background;this.background.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill({color:e??0,alpha:e?1:1e-7}),this.isBidirectional?this.setInteractive(this.listWidth>this._width||this.listHeight>this._height):this.isHorizontal?this.setInteractive(this.listWidth>this._width):this.setInteractive(this.listHeight>this._height),this.lastWidth=this.listWidth,this.lastHeight=this.listHeight}if(this._trackpad){const e=this.borderMask.width-this.list.width-this.list.leftPadding-this.list.rightPadding,i=this.borderMask.height-this.list.height-this.list.topPadding-this.list.bottomPadding;this.isBidirectional?(this._trackpad.yAxis.max=-Math.abs(i),this._trackpad.xAxis.max=-Math.abs(e)):this.isVertical?this._trackpad.yAxis.max=-Math.abs(i):this.isHorizontal&&(this._trackpad.xAxis.max=-Math.abs(e))}this._dimensionChanged?(this.list.arrangeChildren(),this.stopRenderHiddenItems(),this._dimensionChanged=!1):(t&&this.list.arrangeChildren(),this.updateVisibleItems()),this.lastScrollX=null,this.lastScrollY=null}}onMouseScroll(t){var r,d,a;if(!this.isOver&&!this.options.globalScroll)return;this.renderAllItems();const e=!!this.options.shiftScroll,i=e?typeof t.deltaX<"u"||typeof t.deltaY<"u":typeof t.deltaX<"u",o=typeof t.deltaY<"u";if((this.isHorizontal||this.isBidirectional)&&i){const h=e||this.isBidirectional?t.deltaX:t.deltaY,l=this.list.x-h;if(this.listWidth<this._width)this._trackpad.xAxis.value=0;else{const c=this._width-this.listWidth,s=0;this._trackpad.xAxis.value=Math.min(s,Math.max(c,l))}}if((this.isVertical||this.isBidirectional)&&o){const h=this.list.y-t.deltaY;if(this.listHeight<this._height)this._trackpad.yAxis.value=0;else{const l=this._height-this.listHeight,c=0;this._trackpad.yAxis.value=Math.min(c,Math.max(l,h))}}this.isBidirectional&&(i||o)?(r=this.onScroll)==null||r.emit({x:this._trackpad.xAxis.value,y:this._trackpad.yAxis.value}):this.isHorizontal&&i?(d=this.onScroll)==null||d.emit(this._trackpad.xAxis.value):this.isVertical&&o&&((a=this.onScroll)==null||a.emit(this._trackpad.yAxis.value)),this.stopRenderHiddenItems()}scrollBottom(){this.interactive?this.scrollTo(this.list.children.length-1):this.scrollTop()}scrollTop(){this.renderAllItems(),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.stopRenderHiddenItems()}renderAllItems(){clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null,!this.options.disableDynamicRendering&&this.items.forEach(t=>{t.renderable=!0})}stopRenderHiddenItems(){this.options.disableDynamicRendering||(this.stopRenderHiddenItemsTimeout&&(clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null),this.stopRenderHiddenItemsTimeout=setTimeout(()=>this.updateVisibleItems(),2e3))}updateVisibleItems(){this.visibleItems.length=0,this.items.forEach(t=>{t.renderable=this.isItemVisible(t),this.visibleItems.push(t)})}scrollTo(t){if(!this.interactive)return;const e=this.list.children[t];e&&(this.renderAllItems(),this._trackpad.xAxis.value=this.isHorizontal||this.isBidirectional?this._width-e.x-e.width-this.list.rightPadding:0,this._trackpad.yAxis.value=this.isVertical||this.isBidirectional?this._height-e.y-e.height-this.list.bottomPadding:0,this.stopRenderHiddenItems())}scrollToPosition({x:t,y:e}){t===void 0&&e===void 0||(this.renderAllItems(),t!==void 0&&(this.scrollX=-t),e!==void 0&&(this.scrollY=-e),this.stopRenderHiddenItems())}get height(){return this._height}set height(t){this._height=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}get width(){return this._width}set width(t){this._width=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}setSize(t,e){typeof t=="object"?(e=t.height??t.width,t=t.width):e=e??t,this._width=t,this._height=e,this._dimensionChanged=!0,this.resize(),this.scrollTop()}getSize(t){return t=t||{width:0,height:0},t.width=this._width,t.height=this._height,t}get scrollX(){return this._trackpad.xAxis.value}set scrollX(t){this._trackpad.xAxis.value=t}get scrollY(){return this._trackpad.yAxis.value}set scrollY(t){this._trackpad.yAxis.value=t}update(){this.list&&(this._trackpad.update(),(this.isHorizontal||this.isBidirectional)&&this.list.x!==this._trackpad.x&&(this.list.x=this._trackpad.x),(this.isVertical||this.isBidirectional)&&this.list.y!==this._trackpad.y&&(this.list.y=this._trackpad.y),!this.options.disableProximityCheck&&(this._trackpad.x!==this.lastScrollX||this._trackpad.y!==this.lastScrollY)&&(this.proximityCheckFrameCounter++,this.proximityCheckFrameCounter>=(this.options.proximityDebounce??10)&&(this.items.forEach((t,e)=>{const i=this.isItemVisible(t,this.proximityRange),o=this.proximityStatusCache[e];i!==o&&(this.proximityStatusCache[e]=i,this.onProximityChange.emit({item:t,index:e,inRange:i}))}),this.lastScrollX=this._trackpad.x,this.lastScrollY=this._trackpad.y,this.proximityCheckFrameCounter=0)))}destroy(t){this.ticker.remove(this.update,this),document.removeEventListener("wheel",this.onMouseScrollBinding,!0),this.background.destroy(),this.list.destroy(),super.destroy(t)}restoreItemsInteractivity(){this.interactiveStorage.forEach(t=>{t.item.eventMode=t.eventMode}),this.interactiveStorage.length=0}revertClick(t){t.eventMode!=="auto"&&(ci.any?t.emit("pointerupoutside",null):t.emit("mouseupoutside",null),this.interactiveStorage.push({item:t,eventMode:t.eventMode}),t.eventMode="auto"),t instanceof q&&t.children&&t.children.forEach(e=>this.revertClick(e))}get scrollHeight(){return this.list.height}get scrollWidth(){return this.list.width}get isVertical(){return(this.options.type??"vertical")==="vertical"}get isHorizontal(){return this.options.type==="horizontal"}get isBidirectional(){return this.options.type==="bidirectional"}}const An=()=>{const n=document.createElement("canvas");n.width=256,n.height=1;const t=n.getContext("2d"),e=t.createLinearGradient(0,0,n.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,n.width,1),Ut.from(n)},He=(n,t)=>{const e=new q,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},o=new _t,r=new K;o.text=n,o.style=i;const d=()=>{r.clear(),r.roundRect(o.x-10,o.y,o.width+20,o.height,10),r.fill("black"),r.alpha=.5};e.addChild(r,o);const a=h=>{o.text=h,d()};return d(),{view:e,updateText:a}},Pn=n=>{const t=An(),e=new F(t);return e.label="gradient-background",e.position.set(n.x,n.y-2.5),e.width=n.width+16,e.height=n.height+5,n.addChildAt(e,0),e},qt=n=>{const{viewModel:t,includeItemValue:e,quantity:i}=n,o=n.itemValue,r=new q;let d=!1;r.label=`${t.name()}-view`,r.eventMode="static";const a=F.from(`${t.code()}.png`);a.width=50,a.height=50,r.addChild(a);const h=He(`${(i==null?void 0:i.toString())??t.quantity().toString()}`);h.view.position.set(a.width-h.view.width*.5,a.height);let l=null;e&&(l=He(`$ ${(o||t.value()).toString()}`,{fill:"gold"}),l.view.position.set(a.width-l.view.width*.5,0),r.addChild(l.view),a.position.set(0,l.view.height+5),h.view.position.set(a.width-h.view.width*.5,l.view.height+a.height));const c=a.y+a.height,s=(y,v)=>{const C=new q;return v()<=0||(d=!0,Array(v()).fill(0).forEach((T,E)=>{const k=F.from(`${y}-icon.png`);k.width=20,k.height=20,k.position.set(2.5+E*k.width*.5,0),C.addChildAt(k,0)}),Pn(C),C.position.set(0,c-C.height+14),r.addChild(C)),C};t.isArmourIconVisible()&&s("armour",t.armour);const p=new q;if(t.isHealthIconVisible()&&s("health",t.health),t.isDamageIconVisible()&&t.damage()>0&&t.range()>0){const y=s("damage",t.damage),v=s("range",t.range);v.position.set(y.x,y.y-v.height)}const f=F.from("armour-broken-icon.png");f.width=20,f.height=20,f.position.set(0,a.height-f.height),r.addChild(h.view,f,p),r.on("pointertap",()=>{u()}),d&&a.position.set(16,a.y);const u=()=>{t.interact(),et.play("audio/sfx/collect.wav",{category:"gameplay"})},g=ct(()=>{rt(()=>{h.updateText((i==null?void 0:i.toString())??t.quantity().toString()),f.visible=t.maxArmour()>0&&t.armour()<=0})});return r.on("destroy",()=>{g()}),{view:r,interact:u}},Nn=(n,t)=>{const i=new K;return i.roundRect(-2.5,-2.5,n.view.width+2.5*2,n.view.height+2.5,10),i.fill(t??"gray"),i.alpha=.8,i.eventMode="static",i},Ft=(n,t)=>{const e=new q;e.addChild(n.view),e.label=`${n.view.label}-container`,e.eventMode="static";const i=Nn(n,t);return e.addChild(i,n.view),{container:e,background:i}},oe=({content:n,onClick:t})=>{const e=new q,i=new K,o=new _t,r=3,d=10;return o.text=n,o.style={fontSize:30,fill:"black",align:"center",fontFamily:"alagard"},i.roundRect(-3,-3,o.width+r*2,o.height+r*2,d),i.fill("khaki"),e.addChild(i,o),e.eventMode="static",e.on("pointertap",t),e},On=n=>{const t=new q,e=10;t.label="global-inventory-view",t.eventMode="static";const i=Kt({text:n.ownerName(),fontSize:26,disableBackground:!0}),o=F.from("text-background.png"),r=F.from("text-background.png"),d=new K;t.addChild(o,i,d);const a=()=>{o.width=l.width,o.height=i.height,r.width=l.width,r.height=g.height*2,r.position.set(0,l.height+g.height*2),d.clear(),d.label="title-background-stroke",d.rect(o.x,o.y,o.width,o.height),d.rect(r.x,r.y,r.width,r.height),d.stroke({color:"khaki",width:2})},h=innerWidth<innerHeight,l=new ue({width:h?innerWidth:innerWidth*.8,height:h?innerHeight*.6:innerHeight*.8,padding:e,radius:10,elementsMargin:e}),c=oe({content:"Inspect",onClick:()=>{n.setInfoButtonEnabled(!n.isInfoButtonEnabled()),c.tint=n.isInfoButtonEnabled()?"lightgreen":"white"}});l.label="global-inventory-scroll-box",l.position.set(0,i.height+e),t.addChild(l,r,c),t.visible=!1;const s=(v,C)=>C.weapon().id()===v.id()||C.bodyArmour().id()===v.id()||C.headArmour().id()===v.id()||C.feetArmour().id()===v.id(),p=v=>{v=v??!1,l.removeItems();const C=1.5;n.stacks().forEach(T=>{const E=qt({viewModel:T.item,includeItemValue:v,quantity:T.quantity}),k=new q,W=n.owner?s(T.item,n.owner):!1,A=Ft(E,W?"lightgreen":"gray");k.on("pointertap",()=>{m()}),k.addChild(A.background,A.container),k.label=`${E.view.label}-container`,l.addItem(k);const x=Math.min(C,Math.min((l.width-e*2)/k.width,(l.height-e*2)/k.height));k.scale.set(x),E.view.off("pointertap");const m=()=>{if(n.isInfoButtonEnabled()){V.emit("ON_INFO_MODAL_OPEN",{title:T.item.name(),content:T.item.description(),type:T.item.type()});return}E.interact();const b=k.tint;k.tint="green",setTimeout(()=>{k.tint=b},200)}})},f=(v=!1)=>{p(v),n.setInfoButtonEnabled(!1),et.play("audio/sfx/inventory-open.wav",{category:"gameplay"}),t.visible=!0},u=()=>{n.setInfoButtonEnabled(!1),V.emit("ON_CLOSE_INVENTORY_REQUESTED")},g=oe({content:"Close",onClick:()=>{n.setInfoButtonEnabled(!1),V.emit("ON_CLOSE_INVENTORY_REQUESTED")}});if(i.position.set(t.width*.5,i.height*.5),g.position.set(l.width-g.width,l.height+g.height*2.5),c.position.set(g.position.x-c.width-5,g.position.y),t.addChild(g),n.ownerName()!=="Hero"){const v=oe({content:"Collect All",onClick:()=>{n.items().forEach(C=>{C.interact()}),et.play("audio/sfx/inventory-open.wav",{category:"gameplay"})}});v.position.set(v.width*.2,g.y),t.addChild(v)}const y=Math.max(.6,Math.min(innerWidth/t.width,innerHeight/t.height));return t.scale.set(Math.min(.6,y)),ct(()=>{rt(()=>{n.isEmpty()&&u(),n.isInfoButtonEnabled()||V.emit("ON_INFO_MODAL_CLOSE"),p(),i.position.set(l.width*.5,i.height*.5),g.position.set(l.width-g.width,l.height+g.height*2.5),c.position.set(g.position.x-c.width-5,g.position.y),a()})},t),{view:t,show:f,hide:u}},Rn=n=>{const{viewModel:t}=n,e=new q;e.label="new-trade-view",e.alpha=0;const i=new K;i.label="new-trade-view-background",e.addChild(i);const o=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let r=!1;const d=({title:x,stacks:m,width:b,height:M,playerStacks:_,npcInv:O=!1,includeItemValue:R=!1,isTradeInv:U=!1})=>{const I=new q;I.label=`${x}-screen-view`;const P=F.from("text-background.png");P.label=`${x}-title-background`;const w=new K;w.label=`${x}-title-background-outline`;const L=Kt({text:x,disableBackground:!0,onClick:()=>{}});L.label=`${x}-title-button`;const S=new ue({width:b,height:M,padding:4,elementsMargin:2});S.label=`${x}-inventory-view`;const B=new K;B.label=`${x}-background`,I.addChild(B,P,L,S,w);const H=(j,Q,ot)=>{const ht=innerHeight>innerWidth;j.forEach(at=>{const N=qt({viewModel:at.item,includeItemValue:R,itemValue:t.getItemPrice(at.item,ot),quantity:at.quantity}),z=Ft(N,Q==="buy"||Q==="buy-return"?"pink":"lightblue"),X=new q;N.view.off("pointertap"),X.on("pointertap",()=>{gt(),V.emit("ON_ITEM_INTERACTION",{itemViewModel:at.item,action:Q}),r=!0}),X.addChild(z.container,N.view),X.label=`${N.view.label}-container`,S.addItem(X);const J=ht?.6:.7;X.scale.set(Math.min(J,b/(N.view.width+10)),Math.min(J,M/(N.view.height+10)));const gt=()=>{X.tint=65280,setTimeout(()=>{X.tint=16777215},200)}})};return O?H(m,"buy",!0):U?(H(_||[],"sell-return",!1),H(m,"buy-return",!0)):H(m,"sell",!1),L.scale.set(.4),L.position.set(b*.5,L.height*.5),S.position.set(b*.5-S.width*.5,L.height+10),P.x=S.width*.025,P.width=S.width*.95,P.height=L.height,w.rect(P.x,0,P.width,P.height),w.stroke({color:"khaki",width:2}),B.rect(0,0,I.width,I.height),B.label=`${x}-background-rect`,B.fill("black"),B.stroke("black"),I};let a=null,h=null,l=null,c=null,s=null,p=null,f=null,u=null,g=null,y=null;const v=F.from("text-background.png");v.label="trade-buttons-container-background";const C=new K;C.label="trade-buttons-container-background-outline";const T=()=>{a||h?k():et.play("audio/sfx/door.mp3");const{innerWidth:x,innerHeight:m}=window,b=m>x,M=b?x:x*.9*.3,_=b?m*.7*.3:m*.9;o(),s=wt({spriteName:"trade-icon",onClick:()=>{V.emit("ON_TRADE_REQUEST",{action:"autoTrade"}),r=!0},alpha:.8}),c=wt({spriteName:"exit-icon",onClick:()=>{V.emit("ON_CLOSE_INVENTORY_REQUESTED"),r=!0},alpha:.8});const O=()=>{y&&(e.removeChild(y),y.destroy(),y=null)},R=()=>{const P=Math.abs(t.value().quantity()),w=t.value().quantity()<0?{type:"Insufficient Funds",content:"You do not have enough funds to complete this trade."}:{type:"Trade Imbalance",content:`Trader has insufficient funds, you will lose ${P} ${P>1?"coins":"coin"}.`};y=Ge({title:"Confirm Trade",type:w.type,content:w.content,onConfirm:t.value().quantity()>0?()=>{V.emit("ON_TRADE_REQUEST",{action:"submit"}),r=!0,O()}:void 0,onCancel:()=>{V.emit("ON_TRADE_REQUEST",{action:"clear"}),O(),r=!0}}),e.addChild(y),y.position.set(e.width*.5-y.width*.25,e.height*.5-y.height*.5)};p=wt({spriteName:"confirm-icon",onClick:()=>{V.emit("ON_TRADE_REQUEST",{action:"submit"}),r=!0},alpha:.8}),f=wt({spriteName:"cancel-icon",onClick:()=>{if(t.npcTradeItems().isEmpty()&&t.playerTradeItems().isEmpty()){V.emit("ON_CLOSE_INVENTORY_REQUESTED"),r=!0;return}V.emit("ON_TRADE_REQUEST",{action:"clear"}),r=!0},alpha:.8});let U="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?U="green":t.value().quantity()>0?U="yellow":U="red");const I=qt({viewModel:t.value()});g=Ft(I,U).container,u=new q,u.label="trade-buttons-container",u.addChild(c,p,f,s),e.addChild(v,u,C),a=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:M,height:_,includeItemValue:!0,isTradeInv:!1}),e.addChild(a),a.label="player-trade-screen",h=d({title:"Trader",stacks:t.npcInventory().stacks(),width:M,height:_,npcInv:!0,includeItemValue:!0,isTradeInv:!1}),e.addChild(h),h.label="npc-trade-screen",l=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:M,height:_,includeItemValue:!0,isTradeInv:!0}),e.addChild(l),e.alpha=1,l.label="trade-screen",t.isConfirmationModalVisible()&&R()},E=(x=!1)=>{!u||!c||(C.clear(),x?(v.angle=90,v.height=c.height*1.4,v.width=u.height,v.position.set(u.x+v.height,u.y-c.height*.2-5),C.rect(v.x-v.height,v.y,v.height,v.width)):(v.angle=0,v.width=u.width,v.height=c.height*1.4,v.position.set(u.x-17,u.y+5),C.rect(v.x,v.y,v.width,v.height)),C.stroke({color:"khaki",width:2}))},k=()=>{a&&(e.removeChild(a),a.destroy(),a=null),h&&(e.removeChild(h),h.destroy(),h=null),l&&(e.removeChild(l),l.destroy(),l=null),c&&(e.removeChild(c),c.destroy(),c=null),p&&(e.removeChild(p),p.destroy(),p=null),f&&(e.removeChild(f),f.destroy(),f=null),s&&(e.removeChild(s),s.destroy(),s=null),u&&(e.removeChild(u),u.destroy(),u=null),g&&(e.removeChild(g),g.destroy(),g=null),y&&(e.removeChild(y),y.destroy(),y=null),e.alpha=0},W=(x,m)=>{if(e.alpha===0||!a||!h||!l)return;if(m>x){if(a.position.set(0,0),l.position.set(0,a.y+a.height+2),h.position.set(0,l.position.y+l.height+2),u){const M=x-20,_=u.children,O=_.reduce((I,P)=>I+P.width,0)+((g==null?void 0:g.width)??0),R=Math.min(30,_.length>1?(M-O)/_.length:0);let U=0;_.forEach(I=>{I.position.set(U,I.height*.5),U+=I.width+R}),g&&(u.addChild(g),g.position.set(u.width,g.height*.2)),u.position.set(x*.5-u.width*.5+15,h.position.y+h.height),E()}}else if(a.position.set(0,0),l.position.set(2+a.position.x+a.width,0),h.position.set(2+l.position.x+l.width,0),u){const M=m-20,_=u.children,O=_.reduce((I,P)=>I+P.height,0)+((g==null?void 0:g.height)??0),R=Math.min(30,_.length>1?(M-O)/_.length:0);let U=0;_.forEach(I=>{I.position.set(I.width*.5,U),U+=I.height+R}),g&&(u.addChild(g),g.position.set(g.width*.35,u.height-10)),u.position.set(h.position.x+h.width,m*.5-u.height*.5+20),E(!0)}};return{view:e,show:T,hide:k,resize:W,update:()=>{!r&&!t.isAutoTrading()||(r=!1,e.alpha!==0&&(T(),W(innerWidth,innerHeight)))}}},Vn=n=>{const{viewModel:t}=n,e=new q,i=[],o=new q;e.addChild(o),o.label="icons-container",e.visible=t.isVisible();const r=new K;r.rect(0,0,innerWidth,64),r.fill("black"),r.alpha=0,e.addChild(r);const d=[],a=()=>{o.removeChildren(),o.destroy({children:!0}),r.destroy(),e.removeChildren(),e.destroy({children:!0}),d.forEach(A=>A.kill())},h=A=>{const x=new q;x.label=`${A}-icon`,x.eventMode="static";const m=new K;m.circle(0,0,32),m.stroke({color:"khaki",width:4}),m.fill("khaki"),m.alpha=.5,x.addChild(m);const b=F.from(`${A}-icon.png`);return b.anchor.set(.5),b.width=32,b.height=32,i.push(x),x.addChild(b),o.addChild(x),x},l=h("city-key");l.on("pointertap",()=>{const A=t.canUnlockSettlement();A&&(et.play("audio/sfx/sfx-unlock.wav"),V.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:A,action:"unlock"}))});const c=h("talk");c.on("pointertap",()=>{et.play("audio/sfx/click.wav"),V.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:t.canInteractWithCharacter()??void 0,action:"talk"})}),c.visible=t.canInteractWithCharacter()!==null;const s=h("trade");s.on("pointertap",()=>{const A=t.canTradeWithCharacter();if(A){V.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:A,action:"trade"});return}const x=t.canTradeWithSettlement();x&&(et.play("audio/sfx/click.wav"),V.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:x,action:"trade"}))}),s.visible=t.canTradeWithCharacter()!==null||t.canTradeWithSettlement()!==null;const p=h("settlement");p.on("pointertap",()=>{const A=t.canVisitSettlement();A&&(et.play("audio/sfx/click.wav"),V.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:A,action:"trade"}))});const f=h("attack");f.on("pointertap",()=>{const A=t.canAttackCharacter();A&&V.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:A,action:"attack"})});const u=h("ranged-attack");u.on("pointertap",()=>{const A=t.canRangedAttackCharacter();A&&V.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:A,action:"attack"})});const g=h("loot");g.on("pointertap",()=>{const A=t.canLoot();A&&V.emit("ON_INVENTORY_REQUEST",{inventory:A,action:"open"})});const y=h("search");y.on("pointertap",()=>{const A=t.canSearch();A&&V.emit("ON_EVENT_INTERACTION",{eventViewModel:A})});const v=h("rest");v.on("pointertap",()=>{t.canRestAtSettlement()&&(et.play("audio/sfx/click.wav"),V.emit("ON_LEVEL_COMPLETED"))});const C=()=>{let x=0;i.filter(m=>m.visible).forEach((m,b)=>{m.x=b*(m.width+16),m.y=(e.height-m.height)/2,x=b}),o.x=32+(innerWidth-(x+1)*(i[0].width+16))/2},T=async A=>{A.scale.set(0),A.alpha=0,A.visible=!0;const x=1,m=1.15,b=500,M=b*.7,_=b*.3;d.push(Z.to(A,{alpha:1,duration:b/1e3,ease:"power1.inOut",onUpdate:()=>{C()}}));const O=Z.to(A.scale,{x:m,y:m,duration:M/1e3,ease:"power1.inOut"});d.push(O),await O,d.push(Z.to(A.scale,{x,y:x,duration:_/1e3,ease:"power1.inOut"}))},E=(A,x)=>{r.clear(),r.rect(0,0,A,64),r.fill("black"),r.alpha=0,C()},k=(A,x)=>{!A.visible&&x()?(A.visible=!0,T(A)):A.visible=x()!==null},W=()=>{e.visible=t.isVisible(),k(c,()=>t.canInteractWithCharacter()),k(s,()=>t.canTradeWithCharacter()||t.canTradeWithSettlement()),k(p,()=>t.canVisitSettlement()),k(f,()=>t.canAttackCharacter()),k(u,()=>t.canRangedAttackCharacter()),k(g,()=>t.canLoot()),k(y,()=>t.canSearch()),k(l,()=>t.canUnlockSettlement()),k(v,()=>t.canRestAtSettlement()),C()};return ct(()=>{rt(()=>{W()})},e),{view:e,resize:E,destroy:a}},Ln=n=>{let t=[];const e=new q;e.label="grid-container";const i=()=>{const a=innerWidth<innerHeight,h=30,l=a?(innerWidth-40)/2:innerWidth-15,c=12,s=h+10;t.forEach((p,f)=>{const u=Math.floor(f/(a?2:1)),g=f%(a?2:1);p.icon.position.set(g*l,u*(p.icon.height+c)),p.stats.position.set(p.icon.x+h*.5+s,p.icon.y+(p.icon.height-p.stats.height)/2),p.stats.scale.set(1);const y=l-s-10;p.stats.width>y&&(p.stats.width=y)}),d()},o=a=>{const{icon:h,stats:l}=a,c=Math.floor(t.length/(innerWidth<innerHeight?2:1)),s=t.length%(innerWidth<innerHeight?2:1);t.push({icon:h,stats:l,row:c,column:s}),i()},r=()=>{t=[],e.removeChildren()},d=()=>{e.removeChildren(),t.forEach(a=>{const h=new K;h.roundRect(a.icon.x-5,a.icon.y-5,a.icon.width+10,a.icon.height+10,5),h.fill("khaki"),h.stroke(16777215),h.alpha=.5,h.label="icon-background",e.addChild(h,a.icon,a.stats)})};return i(),{gridContainer:e,addDataToGrid:o,resize:i,renderGrid:d,clearDataFromGrid:r}},Ue=(n,t)=>{const e=new q,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},o=new _t,r=new K;o.text=n,o.style=i;const d=()=>{r.clear(),r.roundRect(o.x-10,o.y,o.width+20,o.height,10),r.fill("black"),r.alpha=.5};e.addChild(r,o);const a=h=>{o.text=h,d()};return d(),{view:e,updateText:a}},Bn=()=>{const n=document.createElement("canvas");n.width=256,n.height=1;const t=n.getContext("2d"),e=t.createLinearGradient(0,0,n.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,n.width,1),Ut.from(n)},Dn=n=>{const{playerUiVM:t,miniMapVM:e}=n,i=40,o=10,r=new q;r.label="player-ui-view";const d=Ln(),a=(N,D,z,X,J)=>{const gt=new q,ut=new K,$=1;ut.rect(0,0,200,20),ut.fill(0),ut.stroke(16777215);const Y=190/D,it=new K;for(let nt=N>D?D-1:N-1;nt>=0;nt--)it.rect(5+nt*Y,5,Y-$,10),nt>=N-4?it.fill(z):nt>=N-7&&J?it.fill(J):it.fill(X);return gt.addChild(ut,it),gt},h=()=>{e.isVisible()||(M&&(M.visible=!0),b&&(b.visible=!0),_&&(_.visible=!0),c.visible=!0,s.visible=!0,g.visible=!0,u.visible=t.armour()>0&&t.maxArmour()>0,v.visible=!0,y.visible=!0,r.visible=!0)},l=()=>{r.visible=!1},c=F.from("health-icon.png");c.label="health-icon",c.anchor.set(.5),c.width=i,c.height=i;const s=F.from("torch-icon.png");s.label="torch-icon",s.anchor.set(.5),s.scale.set(.1);const p=Ue(`$ ${t.inventoryValue().toString()}`,{fill:"gold",fontSize:20}),f=F.from("coin.png");f.label="inventory-value-icon",f.anchor.set(.5),f.width=i,f.height=i,f.eventMode="static",p.view.eventMode="static",f.onpointertap=p.view.onpointertap=()=>{V.emit("ON_INFO_MODAL_OPEN",{title:"Inventory Value",content:"The total value of all your inventory items.",type:`${t.inventoryValue()}`})};const u=F.from("armour-icon.png");u.label="armour-icon",u.anchor.set(.5),u.width=i,u.height=i;const g=wt({spriteName:"map-icon",onClick:()=>{e.setVisible(!e.isVisible())},onClickAudio:""}),y=wt({spriteName:"base-portrait",onClick:()=>{V.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})},onClickAudio:""}),v=wt({spriteName:"menu-icon",onClick:()=>{A(),V.emit("ON_IN_GAME_MENU_REQUEST",{action:"open"})}}),C=wt({spriteName:"min-icon",onClick:()=>{h(),V.emit("ON_IN_GAME_MENU_REQUEST",{action:"close"})},onClickAudio:"deselect"}),T=wt({spriteName:"save-icon",onClick:()=>{k.updateText("Saving..."),V.emit("ON_SAVE_REQUEST")}}),E=wt({spriteName:"load-icon",onClick:()=>{k.updateText("Loading..."),V.emit("ON_LOAD_REQUEST")}}),k=Ue("Game Paused"),W=()=>{v.visible=!1,k.view.visible=!0,C.visible=!0,T.visible=!0,E.visible=!0},A=()=>{v.visible=!1,g.visible=!1,y.visible=!1,c.visible=!1,s.visible=!1,u.visible=!1,b&&(b.visible=!1),_&&(_.visible=!1),M&&(M.visible=!1)},x=()=>{A(),g.visible=!0},m=()=>{e.isVisible()||(v.visible=!0,k.updateText("Game Paused"),k.view.visible=!1,C.visible=!1,T.visible=!1,E.visible=!1)};r.addChild(s,c,f,p.view,y,d.gridContainer,u,v,C,T,k.view,E,g);let b=null,M=null,_=null,O=null,R=null,U=null,I=null;const P=()=>{if(_&&r.removeChild(_),t.maxArmour()<=0||t.armour()<=0){_=null;return}_=a(t.armour(),t.maxArmour(),"blue","blue"),_.position.set(c.width+o,c.y-_.height*.5),_.label="armour-bar",r.addChild(_)},w=()=>{b&&r.removeChild(b),b=a(t.health(),t.maxHealth(),"red","red"),b.label="health-bar",b.position.set(c.width+o,c.y-b.height*.5),r.addChild(b),c.eventMode="static",b.eventMode="static",c.onpointertap=b.onpointertap=()=>{V.emit("ON_INFO_MODAL_OPEN",{title:"Health",content:`You have ${t.health()} health points.`,type:`Max Health: ${t.maxHealth()}`})}},L=N=>{const D=new q,z=20;D.label="stat-container";let X=0;if(Object.entries(N).forEach(([gt,ut],$)=>{$!==0&&(X+=D.width),Array(ut()).fill(0).forEach((Y,it)=>{const nt=F.from(gt+".png");nt.width=z,nt.height=z,nt.position.set(X+it*z*.5,0),D.addChildAt(nt,0)})}),D.width===0)return D;const J=new F(Bn());return J.x=D.x-5,J.y=D.y-5,J.width=D.width+64,J.height=D.height+10,J.label="row-gradient-background",D.addChildAt(J,0),D},S=()=>{const N=t.weapon();O?O.removeChildren():(O=new q,O.label="weapon-icon",r.addChild(O));const D=F.from(N.code()+".png");D.width=i,D.height=i;const z=L({"damage-icon":()=>N.damage(),"range-icon":()=>N.range()});return D.eventMode="static",z.eventMode="static",D.onpointertap=O.onpointertap=()=>{V.emit("ON_INFO_MODAL_OPEN",{title:"Weapon",content:`${N.name()!=="Fists"?N.name():"Nothing"} equipped.`,type:`Damage: ${N.damage()}, Range: ${N.range()}`})},{icon:D,stats:z}},B=()=>{const N=t.bodyArmour();R?R.removeChildren():(R=new q,R.label="armour-icon",r.addChild(R));const D=F.from(N.code()+".png");D.width=i,D.height=i;const z=L({"armour-icon":()=>N.armour()});return D.eventMode="static",z.eventMode="static",D.onpointertap=u.onpointertap=()=>{V.emit("ON_INFO_MODAL_OPEN",{title:"Body",content:`${N.armour()===0?"Not protected":`Wearing ${N.name()}`}`,type:`Armour: ${N.armour()}`})},{icon:D,stats:z}},H=()=>{const N=()=>{V.emit("ON_INFO_MODAL_OPEN",{title:"Head",content:`${t.headArmour().armour()===0?"Not protected":`Wearing ${t.headArmour().name()}`}`,type:`Armour: ${t.headArmour().armour()}`})},D=t.headArmour();U?U.removeChildren():(U=new q,U.label="head-armour-icon",r.addChild(U));const z=D.code()==="head"?"base-portrait":D.code(),X=F.from(z+".png");X.width=i,X.height=i;const J=L({"armour-icon":()=>D.armour()});return X.eventMode="static",J.eventMode="static",X.onpointertap=u.onpointertap=()=>{N()},{icon:X,stats:J}},j=()=>{const N=t.feetArmour();I?I.removeChildren():(I=new q,I.label="feet-armour-icon",r.addChild(I));const D=F.from(N.code()+".png");D.width=i,D.height=i;const z=L({"armour-icon":()=>N.armour()});return D.eventMode="static",z.eventMode="static",D.onpointertap=u.onpointertap=()=>{V.emit("ON_INFO_MODAL_OPEN",{title:"Feet",content:`${N.armour()===0?"Not protected":`Wearing ${N.name()}`}`,type:`Armour: ${N.armour()}`})},{icon:D,stats:z}},Q=()=>{V.emit("ON_INFO_MODAL_OPEN",{title:"Torch",content:`You have ${t.torchLeft()} torches left.`,type:"Light"})},ot=()=>{M&&r.removeChild(M),M=a(t.torchLeft(),30,"red","brown","khaki"),M.label="torch-bar",b&&M.position.set(b.x,s.y-7),r.addChild(M),s.eventMode="static",M.eventMode="static",s.onpointertap=M.onpointertap=()=>{Q()}},ht=()=>{A(),b&&(b.visible=!0),M&&(M.visible=!0),c.visible=!0,s.visible=!0,u.visible=t.armour()>0&&t.maxArmour()>0,_&&(_.visible=!0),y.visible=!0},at=()=>{c.position.set(10,10),u.position.set(10,10),b&&(b.position.set(c.width+o,c.y-b.height*.5),p.view.position.set(b.x,f.y-p.view.height*.5),_&&_.position.set(b.x,b.y)),M&&b&&M.position.set(b.x,s.y-7),s.position.set(10,c.height+15),f.position.set(10,s.y+s.height),d.resize(),d.gridContainer.position.set(0,f.y+f.height*.5+10),y.position.set(innerWidth-(y.width+16),10),g.position.set(innerWidth-(g.width+16),y.y+y.height+10),v.position.set(innerWidth-(v.width+16),g.y+g.height+10),C.position.set(v.x,v.y),T.position.set(v.x,v.y+v.height+10),E.position.set(v.x,T.y+T.height+10),k.view.position.set(innerWidth/2-k.view.width/2,innerHeight/2-20),r.position.set(20,20)};return m(),at(),ct(()=>{rt(()=>{c.visible&&w(),u.visible&&P(),t.torchLeft()>=0&&s.visible&&ot(),t.isSaveCompleted()?k.updateText("Save completed"):k.updateText("Game Paused"),u.visible=!e.isVisible()&&t.maxArmour()>0&&t.armour()>0,t.isInGameMenuVisible()?W():m(),t.isInventoryValueVisible()?(f.visible=!0,v.visible=!1,p.view.visible=!0,d.gridContainer.visible=!0,d.clearDataFromGrid(),d.addDataToGrid(H()),d.addDataToGrid(S()),d.addDataToGrid(B()),d.addDataToGrid(j())):(f.visible=!1,e.isVisible()||(v.visible=!0),p.view.visible=!1,d.gridContainer.visible=!1),p.updateText(`$ ${t.inventoryValue().toString()}`),at()})},r),{view:r,show:h,hide:l,resize:at,showOnlyMapIcon:x,showOnlyInventoryIcon:ht}},Wn=n=>{const{viewModel:t}=n,e=new q;e.label="new-trade-view";const i=new K;i.label="new-trade-view-background",e.addChild(i);const o=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let r=!1;const d=({title:y,stacks:v,width:C,height:T,playerStacks:E,npcInv:k=!1,includeItemValue:W=!1,isTradeInv:A=!1})=>{const x=new q;x.label=`${y}-screen-view`;const m=Kt({text:y,onClick:()=>{}});m.label=`${y}-title-button`;const b=new ue({width:C,height:T,padding:4,elementsMargin:2});b.label=`${y}-inventory-view`;const M=new K;M.label=`${y}-background`,x.addChild(M,m,b);const _=(O,R,U)=>{O.forEach(I=>{const P=qt({viewModel:I.item,includeItemValue:W,itemValue:t.getItemPrice(I.item,U),quantity:I.quantity}),L=Ft(P,R==="buy"||R==="buy-return"?"pink":"lightblue"),S=new q;P.view.off("pointertap"),S.on("pointertap",()=>{B(),V.emit("ON_ITEM_INTERACTION",{itemViewModel:I.item,action:R}),r=!0}),S.addChild(L.container,P.view),S.label=`${P.view.label}-container`,b.addItem(S);const B=()=>{S.tint=65280,setTimeout(()=>{S.tint=16777215},200)}})};return k?_(v,"buy",!0):A?(_(E||[],"sell-return",!1),_(v,"buy-return",!0)):_(v,"sell",!1),m.scale.set(.4),m.position.set(C*.5,m.height*.5),b.position.set(C*.5-b.width*.5,m.height+10),M.rect(0,0,x.width,x.height),M.fill("black"),M.stroke("black"),x};let a=null,h=null,l=null,c=null,s=null;const p=()=>{a?f():et.play("audio/sfx/door.mp3");const{innerWidth:y,innerHeight:v}=window,C=v>y,T=C?y:y*.35,E=C?v*.35:v;o(),l=Kt({text:"Continue",onClick:()=>{l.eventMode="none",V.emit("ON_TRADE_REQUEST",{action:"confirm-bulk-trade"}),Z.delayedCall(.5,()=>{V.emit("ON_CLOSE_INVENTORY_REQUESTED")}),r=!0}}),l.alpha=0,l.label="continue-button";let k="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?k="green":t.value().quantity()>0?k="yellow":k="red");const W=qt({viewModel:t.value()});s=Ft(W,k).container,c=new q,c.label="trade-buttons-container",c.addChild(l,s),l.scale.set(.4),e.addChild(c),a=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:T,height:E,includeItemValue:!0,isTradeInv:!1}),e.addChild(a),a.label="player-trade-screen",h=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:T,height:E,includeItemValue:!0,isTradeInv:!0}),e.addChild(h),h.label="trade-screen",l&&(l.alpha=t.isContinueButtonVisible()?1:0),e.visible=!0},f=()=>{a&&(e.removeChild(a),a.destroy(),a=null),h&&(e.removeChild(h),h.destroy(),h=null),l&&(e.removeChild(l),l.destroy(),l=null),c&&(e.removeChild(c),c.destroy(),c=null),s&&(e.removeChild(s),s.destroy(),s=null),e.visible=!1},u=(y,v)=>{if(!e.visible||!a||!h)return;v>y?(a.position.set(0,0),h.position.set(0,a.y+a.height+2),s&&l&&(s.position.set(-s.width*.5,-s.height*.5),l.position.set(s.x+s.width+l.width*.5,0)),c&&c.position.set(y*.5-c.width*.5,h.position.y+h.height+c.height*.5+10)):(a.position.set(0,0),h.position.set(2+a.position.x+a.width,0),s&&l&&(s.position.set(0,0),l.position.set(20,s.y+s.height+30)),c&&c.position.set(h.position.x+h.width+c.width*.5,v*.5-c.height*.5))};return{view:e,show:p,hide:f,resize:u,update:()=>{l&&(l&&(l.alpha=t.isContinueButtonVisible()?1:0),l.alpha===1&&!r)||!r&&!t.isAutoTrading()||(r=!1,e.visible&&(p(),u(innerWidth,innerHeight)))}}},Hn=n=>{const t=n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2");return t.charAt(0).toUpperCase()+t.slice(1)},Un=n=>{const t=mt().log;let e=[],i=!0;const o=new q;o.label="log-view",o.alpha=0;const r=new q;r.label="log-grid-layout",o.addChild(r);const d=new K;r.addChild(d);const a=()=>{if(e.length>0){e.forEach(g=>g()),e=[];return}u()},h=async g=>{var A;const y=r.children.length,v=innerWidth/2-20,C=new _t,T=g.name.toLowerCase().includes("value");C.style={fontFamily:"alagard",fontSize:20,fill:"black"},C.text=Hn(g.name),C.position.set(10,y*15);const E=new q;E.label="log-value-container",E.position.set(v+(innerWidth<innerHeight?100:0),C.y);const k=new _t;k.style={fontFamily:"alagard",fontSize:18,fill:"black"},k.text=T?"$":"",k.text+=g.value??((A=g.to)==null?void 0:A.toString())??"",E.addChild(k),r.addChild(C),r.addChild(E),C.alpha=0,E.alpha=0,!await new Promise(x=>{Z.delayedCall(g.index*.5,()=>{i||x(!0),e.shift(),x(!1)}),e.push(()=>x(!0))})&&i&&et.play("audio/sfx/sfx-thud.mp3"),C.alpha=1,E.alpha=1};Object.entries(t).sort((g,y)=>g.toLocaleString().localeCompare(y.toLocaleString())).forEach(([g,y],v)=>{h(typeof y=="string"?{name:g,value:y,index:v}:{name:g,to:y,index:v})});const l=5;d.roundRect(-5,-5,r.width+30+l*2,r.height+30+l*2,30),d.fill("khaki"),o.eventMode="static",o.on("pointertap",()=>{a()});const c=new _t;c.text="Tap to continue",c.style={fontFamily:"alagard",fontSize:20,fill:"white"};const s=innerHeight>innerWidth;c.position.set(s?(o.width-c.width)*.5:o.width+40,s?o.height+20:o.height*.5),o.addChild(c);const p=()=>{i=!0,o.visible=!0,o.alpha=0,Z.to(o,{alpha:1,duration:.5,ease:"power2.out"})},f=()=>{i=!1},u=()=>{i=!1,Z.to(o,{alpha:0,duration:.5,ease:"power2.in",onComplete:()=>{o.visible=!1,n()}})};return{view:o,destroy:f,show:p,hide:u,handleAnyPress:a}},zn=n=>{const{miniMapVM:t}=n,e=new q,i=8;e.label="minimap-view",e.visible=t.isVisible();const o=new q;o.label="minimap-tile-map";const r=new q;r.label="minimap-tiles";let d=[];const a=[],h=F.from(Ut.WHITE);h.width=i,h.height=i,h.tint="blue",h.eventMode="static",h.on("pointertap",()=>{V.emit("ON_INFO_MODAL_OPEN",{title:"The Hero",type:"It's you!",content:"This is your character."})}),setInterval(()=>{h.visible=!h.visible},500),setInterval(()=>{d.forEach(f=>{f.visible=!f.visible})},222),h.position.set(t.playerPosition().x*i,t.playerPosition().y*i),t.tiles().forEach((f,u)=>{f.forEach((g,y)=>{const v=ii({viewModel:g,tileSize:i,isMiniMapTile:!0});if(g.type()==="settlement"){const C=F.from(Ut.WHITE);C.width=i,C.height=i,C.tint="green",C.position.set(u*i,y*i),a.push({tileVM:g,indicator:C}),C.eventMode="static",C.on("pointertap",()=>{V.emit("ON_INFO_MODAL_OPEN",{title:"Settlement",type:"A place of refuge",content:"This is a settlement where you can rest and trade."})}),r.addChild(C),C.visible=g.visible()}v.view.position.set(u*i,y*i),v.view.alpha=1,v.view.visible=g.discovered(),r.addChild(v.view)})});const l=new K;l.rect(0,0,t.tiles().length*i,t.tiles()[0].length*i),l.fill("black"),l.alpha=0,r.addChild(...a.map(f=>f.indicator),...d,h),o.addChild(r),e.addChild(l,o);const c={title:"Warning!",type:"Hostiles",content:"Hostiles detected in the area. Proceed with caution."},s=()=>{d.forEach(f=>{e.removeChild(f),f.destroy()}),d=[],t.npcPositions().forEach(f=>{const u=F.from(Ut.WHITE);u.width=i,u.height=i,u.tint="red",u.position.set(f.x*i,f.y*i),u.eventMode="static",u.on("pointertap",()=>{V.emit("ON_INFO_MODAL_OPEN",{...c})}),d.push(u),r.addChild(u)})},p=()=>{a.forEach(f=>{const u=f.tileVM;f.indicator.visible=u.discovered()&&t.isVisible(),u.visible()&&f.indicator.position.set(u.position().x*i,u.position().y*i)})};return ct(()=>{rt(()=>{h.position.set(t.playerPosition().x*i,t.playerPosition().y*i),p(),s()}),rt(()=>{e.visible=t.isVisible()})},e),{view:e}},$n=n=>{const t=new q,{playerMenuVM:e,miniMapVM:i}=n;let o=null,r=null,d=null,a=null,h=null,l=null,c=0,s;const p=zn({miniMapVM:i}),f=()=>{s&&(t.removeChild(s),s.destroy(),s=void 0,V.emit("ON_RESUME_INPUT"))},u=w=>{f(),V.emit("ON_PAUSE_INPUT"),s=Ge({title:w.title,content:w.content,type:w.type,contentStyle:w.contentStyle??g,onClose:()=>{w.onClose&&w.onClose(),f()},onConfirm:w.onConfirm}),t.addChild(s),s.position.set(t.width*.5-s.width*.25,t.height*.5-s.height*.5)},g={fontSize:20,fill:"white",fontFamily:"alagard",align:"center"},y=new K;y.label="background",y.alpha=0,y.on("pointertap",()=>{l==null||l.handleAnyPress()}),t.addChild(y);const v=()=>{y.clear(),y.rect(0,0,innerWidth,innerHeight),y.fill("black")},C=()=>{f(),O(),M(),y.alpha=0},T=()=>{a&&(a.view.visible=!1),y.alpha=0},E=()=>{T(),x(),k(),y.alpha=1,l=Un(()=>{k(),V.emit("ON_LEVEL_COMPLETED")});const w=Math.min(1,Math.min(innerWidth/l.view.width,innerHeight/l.view.height));l.view.scale.set(w),l.view.position.set(innerWidth*.5-l.view.width*.5,innerHeight*.5-l.view.height*.5),t.addChild(l.view),l.show(),y.eventMode="static"},k=()=>{y.eventMode="none",l&&(l.destroy(),t.removeChild(l.view),l.view.destroy({children:!0}),l=null)},W=()=>{const w=n.playerUiVM();if(!w)return;if(a){a.view.position.set(30,30),a.view.visible=!0;return}a=Dn({playerUiVM:w,miniMapVM:i});const L=Math.min(1,Math.min(innerWidth/a.view.width,innerHeight/a.view.height));a.view.scale.set(L),a.view.position.set(30,30),c=t.children.length,t.addChild(a.view),a.view.visible=!0,a.view.label="player-ui-view"},A=()=>{const w=e();if(!w)return;w.setVisibility(!i.isVisible()),r||(r=Vn({viewModel:w}),t.addChild(r.view));const L=Math.min(1,Math.min(innerWidth/r.view.width,innerHeight/r.view.height));r.view.scale.set(L),r.view.position.set(innerWidth*.5-r.view.width*.5,innerHeight*.9-r.view.height*.5),r.view.visible=!0},x=()=>{r&&(r.view.visible=!1),y.alpha=0},m=w=>{M(),x(),T(),y.alpha=1,d=Wn({viewModel:w}),t.addChild(d.view),d.show()},b=w=>{M(),x(),T(),y.alpha=1,d=Rn({viewModel:w}),t.addChild(d.view),d.show(),R(innerWidth,innerHeight)},M=()=>{A(),W(),d&&(t.removeChild(d.view),d.view.destroy(),d=null),y.alpha=0,R(innerWidth,innerHeight)},_=w=>{if(x(),a==null||a.showOnlyInventoryIcon(),(w==null?void 0:w.ownerName())!=="Hero"&&(a==null||a.showOnlyInventoryIcon()),y.alpha=1,h&&!w)w=h;else if(!w)throw new Error("No inventory provided to showInventory");h=w,setTimeout(()=>{o=On(w),o.show(),t.addChildAt(o.view,c),R(innerWidth,innerHeight)},10)},O=(w=!0)=>{A(),a==null||a.show(),o&&(t.removeChild(o.view),o.view.destroy(),o=null),w&&(h=null),y.alpha=0},R=(w,L,S=!1)=>{v();const B=L>w;if(I(),d){d.show(),d.resize(w,L);const H=B?Math.min(1,L/d.view.height):Math.min(1,w/d.view.width);d.view.scale.set(H);const j=B?(t.width-d.view.width)*.5:0,Q=B?0:(t.height-d.view.height)*.5;d.view.position.set(j,Q)}if(r&&(r.resize(w,L),r.view.position.set(w*.5-r.view.width*.5,L*.9-r.view.height*.5)),a&&a.resize(),l&&E(),o&&a){if(S){O(!1),_();return}const H=B?(w-o.view.width)*.5:a.view.width*.5,j=B?a.view.y+a.view.height+10:(L-o.view.height)*.5;o.view.position.set(H,j)}s&&s.position.set(t.width*.5-s.width*.25,t.height*.5-s.height*.5)},U=()=>{d==null||d.update()};t.label="user-interface-view";const I=()=>{const w=Math.min(.7,Math.min(t.width/p.view.width,t.height/p.view.height));p.view.scale.set(w),p.view.position.set((innerWidth-p.view.width)*.5,(innerHeight-p.view.height)*.5),t.addChild(p.view)};v();const P=()=>{t.removeChildren(),y.destroy(),o=null,r==null||r.destroy(),r=null,d=null,a=null};return ct(()=>{rt(()=>{i.isVisible()?(y.alpha=1,a&&a.showOnlyMapIcon(),r&&(r.view.visible=!1)):(y.alpha=0,a&&a.show(),r&&(r.view.visible=!0))})},t),{showInventory:_,hideInventory:O,showTrade:b,hideTrade:M,showBulkTrade:m,view:t,closeAll:C,showPlayerMenu:A,hidePlayerMenu:x,showPlayerUi:W,resize:R,destroy:P,update:U,showEndOfLevelLog:E,hideEndOfLevelLog:k,showInfoModal:u,hideInfoModal:f}},qn=()=>{const n=ce.map(e=>(e.code()==="torch"&&e.updateQuantity(11),kt(e.code()))),t=jt(n);return Mt({model:t,ownerName:"Global Inventory"})},Fn=n=>{const{playerVM:t,tileMapVM:e}=n,i=(a,h)=>{const l=t.position().x+a,c=t.position().y+h;if(l<=0&&l>=e.tiles().length-1&&c<=0&&c>=e.tiles()[0].length-1)return;const s=e.tiles()[l][c];s&&V.emit("ON_TILE_INTERACTION",{tileViewModel:s})},o=a=>{switch(a){case"endLevel":V.emit("ON_LEVEL_COMPLETED");break;case"showInventory":V.emit("ON_INVENTORY_REQUEST",{inventory:qn(),action:"open"});break;case"showCharacterDetails":console.debug("Showing character details");break;case"moveLeft":i(-1,0);break;case"moveRight":i(1,0);break;case"moveUp":i(0,-1);break;case"moveDown":i(0,1);break;default:console.warn(`Unknown action: ${a}`)}},r=a=>{switch(a.key){case"r":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"endLevel"});break;case"i":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"showInventory"});break;case"w":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveUp"});break;case"s":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveDown"});break;case"a":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveLeft"});break;case"d":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveRight"});break;case"6":V.emit("ON_SAVE_REQUEST");break;case"8":V.emit("ON_LOAD_REQUEST");break}};return document.addEventListener("keypress",r),{handleDebugActionRequest:o,destroy:()=>{document.removeEventListener("keypress",r)}}};function Gn(n){const t=[];let e=n;for(;e;)t.unshift(e.tile),e=e.previous;return t}function Yt({start:n,end:t,map:e,maxDistance:i=7}){const o=e.tiles().flat().find(s=>s.position().x===n.x&&s.position().y===n.y),r=e.tiles().flat().find(s=>s.position().x===t.x&&s.position().y===t.y);if(!o||!r)return null;const d=Math.sqrt(Math.pow(r.position().x-o.position().x,2)+Math.pow(r.position().y-o.position().y,2)),a={previous:null,tile:o,g:0},h=s=>{let p=!1,f=s.previous;for(;f;){if(f.tile.position().x===s.tile.position().x&&f.tile.position().y===s.tile.position().y){p=!0;break}f=f.previous}return p},l=[],c=s=>{if(s.tile.position().x===r.position().x&&s.tile.position().y===r.position().y){l.push(s);return}if(s.g>i||s.g>d)return;const p=e.getNeighbors(s.tile),f=s.tile.position();for(const u of p){if(!u.traversable()&&r.traversable())continue;const g=u.position(),y=Math.abs(g.x-f.x),v=Math.abs(g.y-f.y),C=y===1&&v===1?2:1,T=s.g+C;if(T>i)continue;const E={previous:s,tile:u,g:T};h(E)||c(E)}};if(c(a),l.length>0){const s=l.reduce((f,u)=>f.g<u.g?f:u),p=Gn(s);if(p.length>0)return p.shift(),p}return[]}const Yn={"bed-time":["follow"],patrol:["bed-time","follow","work"],follow:["attack"],work:["bed-time","patrol","follow"],idle:["bed-time","patrol","follow","work"],attack:["bed-time","patrol","follow","work"],spawn:["bed-time","patrol","follow","work","attack"]},Qn=n=>{const{events:t,playerVM:e,tileMapVM:i,npcTaskController:o,npcs:r,turnVM:d}=n,a=5,h=[],l=(m,b)=>{var _;const M=[];for(let O=m.x-b;O<=m.x+b;O++)for(let R=m.y-b;R<=m.y+b;R++){const U=(_=i.tiles()[O])==null?void 0:_[R];!U||Math.floor(Math.sqrt(Math.pow(U.position().x-m.x,2)+Math.pow(U.position().y-m.y,2)))>b||U.traversable()&&M.push(U.position())}return M},c=(m,b)=>{let _=5,O=null;for(;O===null||O.length===0;)if(O=Yt({start:m,end:b,map:i,maxDistance:_}),_++,_>9)return null;return O},s=m=>{const b=m.position();let M=null;const _=[];for(const O of t){const R=O.position(),U=Math.floor(Math.sqrt(Math.pow(R.x-b.x,2)+Math.pow(R.y-b.y,2)));_.push({event:O,distance:U})}_.sort((O,R)=>O.distance-R.distance);for(let O=0;O<Math.min(3,_.length);O++){const R=_[O].event,U=c(b,R.position());if(U&&U.length>0){M=R;break}}return M||null},p=m=>{m.isAlive()&&(m.setTaskList([o.createSpawnTask(m)]),m.setCanTrade(!1),h.push(m),m.getPatrolArea().length===0&&(m.setPatrolArea(l(m.position(),a)),m.setTaskList([...m.getTaskList(),o.createPatrolTask(m)])))},f=m=>{m.isAlive()&&!m.isHostile(e.team())&&(m.setTaskList([o.createWorkTask(m)]),m.setCanTrade(!0),h.push(m))},u=m=>{if(!m.isAlive()){m.setTask(null);return}if(m.isHostile(e.team())&&m.getPatrolArea().length===0&&(m.setPatrolArea(l(m.position(),a)),m.setTaskList([...m.getTaskList(),o.createPatrolTask(m)])),m.getBedLocation()===null){const b=s(m);b&&m.setBedLocation(b.position())}h.push(m)},g=(m,b)=>{const M=m.getTask();if(!M)return!0;const _=M.name();return(Yn[_]||[]).includes(b)},y=m=>{if(!m.spawnLing())return!1;const b=4;if(m.lastSpawned()===0)return m.setLastSpawned(d.getCurrentTurn()),!1;const M=d.getCurrentTurn()-m.lastSpawned()>=b;if(!M)return!1;if(M){const _=o.createSpawnTask(m);if(_)return m.setTask(_),m.setLastSpawned(d.getCurrentTurn()),!0}return!1},v=m=>{if(!m.isHostile(e.team()))return!1;if(e.isAlive()&&e.position()){const _=Math.floor(Math.sqrt(Math.pow(e.position().x-m.position().x,2)+Math.pow(e.position().y-m.position().y,2)));if(_<=1)return!1;if(_<=4&&g(m,"follow")){const O=m.getTaskList().find(R=>R.name()==="follow")||o.createFollowPlayerTask(m);if(O)return m.setTarget(e),m.setTask(O),!0}}return!1},C=m=>{const b=m.getTask(),M=n.turnVM.getCurrentTimeMin();if(M>=1200||M<480){if(b&&b.name()==="bed-time")return!0;if(g(m,"bed-time")){const _=m.getTaskList().find(O=>O.name()==="bed-time")||o.createBedTimeTask(m);if(_)return m.setTask(_),!0}}return!1},T=m=>{const b=m.getTask();if(n.turnVM.getCurrentTimeMin()>=480){if(b&&b.name()==="patrol")return!0;if(g(m,"patrol")){const _=m.getTaskList().find(O=>O.name()==="patrol");if(_)return m.setTask(_),!0}}return!1},E=m=>{var O;const b=m.getTarget(),M=1;if(!b||!b.isAlive())return m.setTarget(null),!1;if(Math.floor(Math.sqrt(Math.pow(b.position().x-m.position().x,2)+Math.pow(b.position().y-m.position().y,2)))>M)return!1;if(((O=m.getTask())==null?void 0:O.name())==="attack")return!0;if(g(m,"attack")){const R=m.getTaskList().find(U=>U.name()==="attack")||o.createAttackTask(m);if(R)return m.setTask(R),!0}return!1},k=m=>{var b;if(((b=m.getTask())==null?void 0:b.name())==="work")return!0;if(g(m,"work")){const M=m.getTaskList().find(_=>_.name()==="work");if(M)return m.setTask(M),!0}return!1},W=m=>{if(!m.isAlive()){m.setTask(null);return}y(m)||E(m)||v(m)||C(m)||T(m)||k(m)},A=()=>{h.forEach(m=>{if(!m.isAlive())return;W(m);const b=m.getTask();b&&b.name(),b&&b.execute()})};return(()=>{r.forEach(m=>{u(m)})})(),{addNpc:u,addTrader:f,addNestmother:p,playNpcTurn:A}},Xn=({npc:n,attackVM:t})=>({execute:()=>{if(!n.isAlive())return!1;const e=n.getTarget();return!e||!e.isAlive()?(n.setTask(null),!0):Math.floor(Math.sqrt(Math.pow(n.position().x-e.position().x,2)+Math.pow(n.position().y-e.position().y,2)))<=1?(t.attack(n,e),!0):!1},name:()=>"attack"}),jn=({npc:n,tileMapVM:t,turnVM:e})=>{let i=n.getBedLocation(),o=null;return{execute:()=>{if(n.isAlive()===!1)return!1;if(e.getCurrentTimeMin()>=480&&e.getCurrentTimeMin()<1200)return n.setTask(null),!0;if(!i&&(i=n.getBedLocation(),!i))return!1;if(n.position().x===i.x&&n.position().y===i.y)return!0;if(!o){let d=5;for(;o===null||o.length===0;)if(o=Yt({start:n.position(),end:i,map:t,maxDistance:d}),d++,d>8)return!1}if(o&&o.length>0){const r=o.shift();return r&&(n.moveTo(r.position().x,r.position().y),r.position().x===i.x&&r.position().y===i.y),!0}return!1},name:()=>"bed-time"}},Zn=({npc:n,tileMapVM:t,playerVM:e})=>({execute:()=>{if(n.isAlive()===!1)return!1;const i=e.position(),o=Yt({start:n.position(),end:i,map:t});if(o&&o.length>0){const r=o.shift();if(r)return r.position().x===i.x&&r.position().y===i.y||n.moveTo(r.position().x,r.position().y),!0}return!1},name:()=>"follow"}),Kn=({npc:n,tileMapVM:t})=>{let e=n.getPatrolArea(),i=null;return{execute:()=>{if(n.isAlive()===!1||e.length===0||((!i||i.length===0)&&(i=Yt({start:n.position(),end:e[Math.floor(Math.random()*e.length)],map:t})),!i||i.length===0))return!1;const o=i.shift();return o&&n.moveTo(o.position().x,o.position().y),!0},name:()=>"patrol"}},Jn=({npc:n})=>({execute:()=>n.isAlive()===!1?!1:(n.setCanTrade(!0),!0),name:()=>"work"}),to=({npc:n,addNpc:t,spawnType:e="worm"})=>({execute:()=>{if(!n.isAlive())return!1;const i=n.position(),o=qe({id:e,team:"hostile-to-player",name:"Spawned "+e.charAt(0).toUpperCase()+e.slice(1),startingSize:1,startPosition:i,startingHealth:1,startingMaxHealth:1,startingItems:[]}),r=ei(o);return t(r),!0},name:()=>"spawn"}),eo=n=>{const{attackVM:t,tileMapVM:e,turnVM:i,playerVM:o}=n;return{createBedTimeTask:s=>jn({npc:s,tileMapVM:e,turnVM:i}),createPatrolTask:s=>Kn({npc:s,tileMapVM:e}),createFollowPlayerTask:s=>Zn({npc:s,tileMapVM:e,playerVM:o}),createAttackTask:s=>Xn({npc:s,attackVM:t}),createWorkTask:s=>Jn({npc:s}),createSpawnTask:s=>to({npc:s,spawnType:"worm",addNpc:n.addNpc})}},Xt=(n,t)=>n.id()===t.id(),io=()=>({use:(n,t)=>{if(n.health()!==0){if(t.health()>=t.maxHealth())return;if(t.id()==="player"){const e=Math.min(n.health(),t.maxHealth()-t.health());mt().log.totalHealing+=e}t.setHealth(t.health()+n.health()),t.inventory().removeItem(n),n.updateQuantity(0);return}n.type()==="weapon"&&(Xt(t.weapon(),n)?t.setWeapon(void 0):t.setWeapon(n)),n.type()==="armour"&&(Xt(t.bodyArmour(),n)?t.setBodyArmour(void 0):t.setBodyArmour(n)),n.type()==="helmet"&&(Xt(t.headArmour(),n)?t.setHeadArmour(void 0):t.setHeadArmour(n)),n.type()==="shoes"&&(Xt(t.feetArmour(),n)?t.setFeetArmour(void 0):t.setFeetArmour(n))}}),no=()=>{let n=null,t=null;const e=222,[i,o]=G(!1),[r,d]=G(!0),[a,h]=G(!1),[l,c]=G(!1),[s]=G($t({model:kt("coin")})),p=Mt({model:jt([]),ownerName:"trade"}),f=Mt({model:jt([]),ownerName:"trade-npc"}),u=(w,L)=>{n=w,t=L,v(x()),v(A())},g=w=>{M().addItem(w,1),p.removeItem(w,1)},y=w=>{_().addItem(w,1),f.removeItem(w,1)},v=w=>{let L;w===p?L=g:L=y,w.items().forEach(S=>{L(S,!0),w.removeItem(S,1)})},C=w=>{const L=M().getItem(w);L&&(p.addItem(L,1),M().removeItem(L,1))},T=w=>{const L=_().getItem(w);L&&(f.addItem(L,1),_().removeItem(L,1))},E=()=>{v(x()),v(A()),s().updateQuantity(0)},k=(w=!1)=>{if(!n||!t)throw new Error("Player or NPC inventory is not set");return!a()&&!l()&&m()!==0?(h(!0),!1):s().quantity()<0?!1:((a()&&!l()||l()&&!a()||m()===0)&&w&&W(),a()&&h(!1),!0)},W=()=>{if(i()){const w=Math.floor(s().quantity());Array(w).fill(0).forEach(()=>{const L=$t({model:kt("coin")});A().addItem(L)}),w>0&&et.play("audio/sfx/sfx-sell.mp3")}p.items().forEach(w=>{_().addItem(w,w.quantity()),p.removeItem(w,w.quantity())}),f.items().forEach(w=>{mt().log.tradedItemsValue+=b(w,!0),M().addItem(w,w.quantity()),f.removeItem(w,w.quantity())}),v(x()),v(A()),i()&&o(!1)},A=()=>(s().updateQuantity(m()),f),x=()=>(s().updateQuantity(m()),p),m=()=>{const w=p.stacks().reduce((S,B)=>S+b(B.item,!1)*B.quantity,0),L=f.stacks().reduce((S,B)=>S+Math.max(1,b(B.item,!0)*B.quantity),0);return Math.floor(w)-Math.ceil(L)},b=(w,L)=>{const S=w.value()*w.quantity(),H=L&&!["coin","torch"].includes(w.code())?2:1;return S*H},M=()=>{if(n)return n;throw new Error("Player inventory is not set")},_=()=>{if(t)return t;throw new Error("NPC inventory is not set")},O=async()=>{await R(!1),await Z.delayedCall(.2,()=>{}),o(!1)},R=async(w=!0)=>{if(!n||!t)throw new Error("Invalid inventories to auto trade");o(!0);const L=n.stacks().reduce((S,B)=>(B.quantity>0&&B.item.type()==="loot"&&S.push(B),S),[]);for(const S of L){await Z.delayedCall(e/1e3,()=>{});for(let B=0;B<S.quantity;B++)w?et.play("audio/sfx/sfx-sell.mp3",{category:"gameplay"}):et.play("audio/sfx/collect.wav",{category:"gameplay"}),C(S.item)}};return{isConfirmationModalVisible:a,startTrade:u,cancelTrade:E,acceptTrade:k,playerTradeItems:x,acceptBulkTrade:()=>{l()&&(k(!0),c(!1))},value:s,npcTradeItems:A,playerInventory:M,npcInventory:_,selectItemToBuy:T,selectItemToSell:C,returnItemToPlayer:g,returnItemToNpc:y,clearTrade:()=>{if(a()){h(!1);return}v(x()),v(A()),h(!1),s().updateQuantity(0)},getItemPrice:b,bulkTrade:async()=>{c(!0),await Z.delayedCall(.5,()=>{}),d(!1),await R(),await Z.delayedCall(.5,()=>{}),d(!0)},autoTrade:O,isAutoTrading:i,isContinueButtonVisible:r}},oo=n=>{if(n.length===0)return{x:0,y:0};const t=n.reduce((r,d)=>r+d.x,0),e=n.reduce((r,d)=>r+d.y,0),i=t/n.length,o=e/n.length;return{x:i,y:o}},ze=(n,t)=>Math.abs(n.x-t.x)<=1&&Math.abs(n.y-t.y)<=1,so=n=>{let t="idle",e="idle";return{get:()=>t,set:d=>{t!==d&&(e=t,d==="end-turn"?(n(),t="idle"):t=d)},getPrevState:()=>e}},ro=n=>{const{tileMapViewModel:t,playerViewModel:e,userInterfaceView:i,gameView:o,playerUiVM:r,attackVM:d}=n,a=so(n.onPlayerTurnCompleted),h=io(),l=1;let c=null,s=null,p=null,f=!1;const u=()=>e.isAlive()&&a.get()!=="busy",g=I=>{const{action:P,trader:w}=I;if(!(w&&!w.canTrade())&&u()){if(a.set("trading"),w&&!s)if(s=no(),s.startTrade(e.inventory(),w.inventory()),P==="autoTrade"){s.bulkTrade(),i.showBulkTrade(s);return}else{i.showTrade(s);return}if(s){if(P==="autoTrade"&&s.autoTrade(),P==="clear"){s.clearTrade();return}if(P==="confirm-bulk-trade"){s.acceptBulkTrade();return}P==="submit"&&s.acceptTrade(!0)}}},y=I=>{var P;if(c){c.ownerName()===e.name()&&M();return}if(!s&&u()){if(I.isEmpty()){a.set("idle"),c=null;return}if(I.isOnlyLoot()&&I.ownerName()!==e.name()){i.update(),W(I);return}a.set("inventory-handling"),c=I,i.showInventory(I),(P=r())==null||P.isInventoryValueVisible(!0)}},v=()=>{if(f){T();return}},C=()=>{var w;if(!p||!f)return;const I=p.shift(),P=e.position();if(t.tiles()[P.x][P.y].setIsSelected(!1),!I){f=!1,(w=o())==null||w.hidePathTrigger();return}_({x:I.position().x,y:I.position().y})},T=()=>{var I;f=!1,(I=o())==null||I.hidePathTrigger(),p&&(p.forEach(P=>P.setIsSelected(!1)),p=null),t.tiles()[e.position().x][e.position().y].setIsSelected(!1)},E=I=>{var P;a.set("busy"),(P=r())==null||P.showInGameMenu(I==="open"),I!=="open"&&a.set(a.getPrevState()||"idle")},k=(I,P)=>{u()&&(a.set("inventory-handling"),P==="open"?y(I):M())},W=I=>{I.items().forEach(P=>{var w;e.inventory().addItem(P),I.removeItem(P),(w=o())==null||w.animateIconFloat(P.code(),e.position())}),et.play("audio/sfx/inventory-open.wav",{category:"gameplay",volume:1}),c=null,a.set("end-turn")},A=I=>{var B,H;const{settlement:P,action:w}=I,L=P.positions(),S=oo(L);if(u()){if(w==="unlock"){const j=e.inventory().getItemByCode("city-key");if(!j)throw new Error("City key is required to unlock the settlement");P.setIsUnlocked(!0),e.inventory().removeItem(j),(B=o())==null||B.createTextBox({id:()=>"settlement",dialogue:()=>"Welcome!",position:()=>({x:S.x,y:S.y})});return}if(w==="trade"&&P.isUnlocked()){g({action:"trade",trader:{canTrade:()=>!P.inventory().isEmpty(),inventory:()=>P.inventory()}});return}(H=o())==null||H.createTextBox({id:()=>"settlement",dialogue:()=>"City key required",position:()=>({x:S.x,y:S.y})})}},x=()=>{s&&(s.cancelTrade(),i.closeAll(),s=null),a.set("idle")},m=I=>{const{action:P,character:w}=I;if(!u()||!w)return;if(P==="talk"){const H=o();if(!H)return;H.createTextBox(w),a.set("idle");return}const L=Math.floor(Math.sqrt(Math.pow(w.position().x-e.position().x,2)+Math.pow(w.position().y-e.position().y,2))),S=L<=l,B=L<=e.weapon().range();if(w.isHostile(e.team())&&B&&w.health()>0){d.attack(e,w),a.set("end-turn");return}if(!S){_(w.position());return}if(!w.inventory().isEmpty()){if(w.canTrade()){g({action:"change-to-buy",trader:w});return}y(w.inventory());return}if(w.inventory().isEmpty()){_(w.position());return}y(w.inventory())},b=(I,P)=>{if(a.get()==="idle"&&u()){if(ze(I.position(),e.position())&&(!I.discovered()||!I.inventory().isEmpty())){y(I.inventory()),I.interact(P);return}_(I.position())}},M=()=>{var I,P;if(c){if(c.ownerName()===e.name()){c=null,a.set("idle"),(I=r())==null||I.isInventoryValueVisible(!1),i.hideInventory();return}c=null,a.set("end-turn"),(P=r())==null||P.isInventoryValueVisible(!1),i.hideInventory();return}s&&x(),a.set("idle")},_=({x:I,y:P})=>{var S,B;if(a.get()!=="idle"||!u())return;const w=e.position();if(ze({x:I,y:P},w)&&t.isValidMove(I,P)){if(p&&!f)t.tiles()[w.x][w.y].setIsSelected(!1),p.forEach(H=>H.setIsSelected(!1)),p=null;else if(f){let H=500;I-w.x===0&&P-w.y===0&&(H=10),Z.delayedCall(H/1e3,()=>C())}O(I-w.x,P-w.y);return}p&&p.length>1&&p[p.length-1].position().x===I&&p[p.length-1].position().y===P&&(t.tiles()[w.x][w.y].setIsSelected(!1),f=!0,C()),p&&((S=o())==null||S.hidePathTrigger(),t.tiles()[w.x][w.y].setIsSelected(!1),p.forEach(H=>H.setIsSelected(!1)),p=null);const L=p=Yt({start:w,end:{x:I,y:P},map:t,maxDistance:22});if(L&&L.length>1){L.unshift(t.tiles()[w.x][w.y]),L.forEach(j=>j.setIsSelected(!0));const H=L[L.length-1];(B=o())==null||B.showPathTrigger(H.position())}},O=(I,P)=>{if(a.set("moving"),!u())return;const w=e.position().x+I,L=e.position().y+P;t.isValidMove(w,L)&&e.moveTo(w,L),a.set("end-turn")};return{handlePlayerMoveRequest:_,handleTileInteraction:I=>{a.get()==="idle"&&u()&&_(I.position())},handleCharacterInteraction:m,handleEventInteraction:b,handleItemInteraction:(I,P)=>{var w;if(u()){if(a.get()==="trading"){if(P==="sell"){s==null||s.selectItemToSell(I);return}if(P==="buy-return"){s==null||s.returnItemToNpc(I);return}if(P==="sell-return"){s==null||s.returnItemToPlayer(I);return}if(P==="buy"){s==null||s.selectItemToBuy(I);return}}if(c&&c.ownerName()!==e.name()){e.inventory().addItem(I),c.removeItem(I),(w=o())==null||w.animateIconFloat(I.code(),e.position());return}h.use(I,e)}},handleCloseInventoryRequest:M,handleTradeRequest:g,handleTradeCancel:x,handleSettlementInteraction:A,handleInventoryRequest:k,handleInGameMenuRequest:E,autoMove:C,stopAutoMove:T,handleAnyAction:v}},ao=n=>{const{turnVM:t,handleEndUpTurnUpdates:e,playerVM:i,enemyVMs:o,npcController:r}=n;let d=0;const a=()=>{var p;const s=mt().log;s.turns+=1,s.npcsKilled=o.filter(f=>!f.isAlive()).length,s.npcsAlive=o.filter(f=>f.isAlive()).length,s.mostUsedWeapon=((p=i.inventory().items().filter(f=>f.type()==="weapon").sort((f,u)=>u.uses()-f.uses())[0])==null?void 0:p.name())||"fists"},h=async()=>{c(),await e(),t.nextTurn(),l(),a()},l=async()=>{if(d+=1,d%10===0){const s=i.inventory().getItemByCode("torch");s&&i.inventory().removeItem(s)}},c=()=>{r.playNpcTurn()};return{handlePlayerTurnEnded:h,playNpcTurn:c}},lo=()=>{const[n,t]=G(void 0);return{attack:async(e,i)=>{const o=e.weapon().range()>2,r=e.weapon().range()<=2,a=e.position().distanceTo(i.position())>1,l=e.weapon().damage();r||a&&o?i.takeDamage(l):!a&&o&&i.takeDamage(Math.min(1,Math.floor(l/2))),t({source:e,target:i,type:o&&a?"ranged":"melee"});const c=mt().log;e.id()==="player"&&(c.totalDamageDealt+=l,e.weapon().setUses(e.weapon().uses()+1),r||a&&o?r?mt().log.meleeAttacks+=1:mt().log.rangedAttacks+=1:!a&&o&&(mt().log.meleeAttacks+=1))},isAttacking:()=>n(),clearAttack:()=>{t(void 0)}}},co=n=>{const{tileMapVM:t}=n,[e,i]=G(!1),[o,r]=G({x:0,y:0}),[d,a]=G([]);return{isVisible:e,setVisible:i,updateDiscoveredTiles:l=>{const c=t.tiles(),s=5,p=Math.max(0,l.x-s),f=Math.max(0,l.y-s),u=Math.min(c.length-1,l.x+s),g=Math.min(c[0].length-1,l.y+s);for(let y=p;y<=u;y++)for(let v=f;v<=g;v++){const C=c[y][v];C&&C.handleTileDiscovered()}},tiles:()=>t.tiles(),npcPositions:d,setNpcPositions:a,playerPosition:o,setPlayerPosition:r}};Z.registerPlugin(he);he.registerPIXI(hi);const ho=n=>n<=3?1:n<=6?2:n<=10?3:n<=15?4:5,uo=({view:n,saveController:t,onGameLoadRequest:e,onLevelCompleted:i,onGameOver:o})=>{const[d,a]=G(de({model:$e({id:"dontUse",team:"player",name:"Player",startPosition:{x:0,y:0},startingHealth:10,startingMaxHealth:10,startingItems:[]})}));let h=null,l=null,c=null,s=null,p=null,f=null,u=null,g=null,y=null,v=null,C=null,T=[],E=[],k=null,W=[],A=1,x=null,m=null,b=null,M=!1,_=!1,O={x:0,y:0},R=null;const U=()=>{if(!x)throw new Error("Level models are not initialized");return x},I=N=>{x=N;const D=Hi(N);C=D.tileMapVM,a(D.playerVM),T=D.npcVMs,E=D.eventVMs,W=D.settlementVMs;const z=lo();p=Gi({playerVM:d()}),f=N.fogOfWarViewModel,h=Fi({playerVM:d(),npcVMs:T,settlementVMs:W,eventViewModels:E}),R=co({tileMapVM:C}),u=$n({playerMenuVM:()=>h,playerUiVM:()=>p,miniMapVM:R}),g=Ui({model:Vi()}),s=eo({tileMapVM:C,playerVM:d(),turnVM:g,attackVM:z,addNpc:J=>{m==null||m.addNpc(J),c==null||c.addNpc(J)}}),c=Qn({playerVM:d(),npcs:T,tileMapVM:C,events:E,npcTaskController:s,turnVM:g}),y=ao({turnVM:g,playerVM:d(),enemyVMs:T,npcController:c,handleEndUpTurnUpdates:async()=>{await(m==null?void 0:m.handleEndOfTurnUpdates()),R==null||R.setPlayerPosition(d().position()),R==null||R.updateDiscoveredTiles(d().position());const J=T.reduce((gt,ut)=>(ut.isAlive()&&ut.visible()&&gt.push(ut.position()),gt),[]);J.length>0&&(l==null||l.stopAutoMove()),R==null||R.setNpcPositions(J),d().isAlive()&&((g==null?void 0:g.getCurrentTurn())??0)%30===0&&j(!0)}});const X=()=>{d().inventory().getItemByCode("torch")?f==null||f.setToFullLight():f==null||f.setToLowLight()};l=ro({attackVM:z,tileMapViewModel:C,playerViewModel:d(),userInterfaceView:u,playerUiVM:()=>p,onPlayerTurnCompleted:()=>{y==null||y.handlePlayerTurnEnded(),X()},gameView:()=>m}),m=on({tileSize:64,playerVM:d(),tileMapVM:C,npcVMs:T,eventVMs:E,settlementVMs:W,attackVM:z}),v=Qi({gameViews:{gameView:m.view,nonSkewedView:m.nonSkewedContainer},userInterfaceView:u.view,fogOfWarVM:f}),k=Fn({playerVM:d(),tileMapVM:C})},P=()=>{console.debug("Unloading level..."),b==null||b.destroy(),v==null||v.destroy(),h=null,l=null,c=null,s=null,p=null,f=null,n.detachAll(),u==null||u.destroy(),u=null,g=null,y=null,v=null,C=null,T=[],E=[],k==null||k.destroy(),k=null,W=[],x=null,m==null||m.destroy()},w=()=>{const N=T.filter(X=>X.isAlive()),D=T.length-N.length,z=d().position();z&&(A>=ho(D)||(A++,N.forEach(X=>{X.position().distanceTo(z)<5||X.setMaxHealth(X.maxHealth()+2)})))},L=()=>{const N=d().position(),D=5;N&&(C==null||C.tiles().forEach(z=>{z.forEach(X=>{X.setVisible(Math.abs(X.position().x-N.x)<=D&&Math.abs(X.position().y-N.y)<=D)})}),E.forEach(z=>{z.setVisible(Math.abs(z.position().x-N.x)<=D&&Math.abs(z.position().y-N.y)<=D)}),T.forEach(z=>{z.setVisible(Math.abs(z.position().x-N.x)<=D&&Math.abs(z.position().y-N.y)<=D)}),W.forEach(z=>{z.setIsVisible(Math.abs(z.positions()[0].x-N.x)<=D&&Math.abs(z.positions()[0].y-N.y)<=D)}))},S=async()=>{if(!M&&!_){M=!0,l==null||l.handleTradeRequest({action:"autoTrade",trader:{canTrade:()=>!0,inventory:()=>Mt({model:jt([]),ownerName:"Bulk Trader"})}});return}if(M=!1,!_){_=!0,u==null||u.showEndOfLevelLog();return}i(x),await B()},B=async()=>{!v||!u||(et.disableCategory("gameplay"),u.view.visible=!1,await Z.to(v.view,{duration:5,alpha:0}),v.view.visible=!1,j(),P())},H=()=>{b=Ri({handleAnyEvent:()=>{l==null||l.handleAnyAction()},handleInfoModalOpenRequest:N=>{u==null||u.showInfoModal(N)},handleInfoModalCloseRequest:()=>{u==null||u.hideInfoModal()},handleLevelCompleted:S,handleTileInteraction:N=>{l==null||l.handleTileInteraction(N)},handleItemInteraction:(N,D)=>{l==null||l.handleItemInteraction(N,D)},handleEventInteraction:N=>{l==null||l.handleEventInteraction(N,d())},handleCharacterInteraction:N=>{l==null||l.handleCharacterInteraction({character:N,action:"interact"})},onCloseInventoryRequested:()=>{l==null||l.handleCloseInventoryRequest(),M&&S()},handleInventoryRequest:(N,D)=>{l==null||l.handleInventoryRequest(N,D)},handleTradeRequest:N=>{l==null||l.handleTradeRequest({action:N})},handleCharacterInteractionRequest:({character:N,action:D})=>{l==null||l.handleCharacterInteraction({action:D,character:N})},handleSettlementInteractionRequest:({settlement:N,action:D})=>{l==null||l.handleSettlementInteraction({settlement:N,action:D})},handleInGameMenuRequest:N=>{l==null||l.handleInGameMenuRequest(N)},onDebugActionRequested:N=>{k==null||k.handleDebugActionRequest(N)},handleSaveRequest:j,handleLoadRequest:Q})},j=(N=!1)=>{console.debug(N?"Autosaving...":"Saving game state...");const D=U(),z={...D,tileModels:D.tileMapModel.tiles().map(X=>X.map(J=>J))};t.save(z,N),p==null||p.setIsSaveCompleted(!0)},Q=()=>{console.debug("Loading game state..."),e();const N=t.load();if(!N){console.warn("No saved game state found.");return}V.emit("ON_PAUSE_INPUT"),P(),ot(N)},ot=N=>{console.debug("Loading level..."),I(N??Ye()),H(),u==null||u.showPlayerMenu(),u==null||u.showPlayerUi(),!(!v||!u)&&(v.view.visible=!1,u.view.visible=!1,n.attachCamera(v),n.attachUi(u),n.resize(innerWidth,innerHeight))},ht=()=>{if(!v||!u)return;et.enableCategory("gameplay"),et.stopMusic({fadeOut:!0}),L(),v.view.visible=!0,u.view.visible=!0,n.resize(innerWidth,innerHeight),v&&v.moveTo(d().position().x*64,d().position().y*64),R==null||R.setPlayerPosition(d().position()),R==null||R.updateDiscoveredTiles(d().position());const N=T.reduce((D,z)=>(z.isAlive()&&z.visible()&&D.push(z.position()),D),[]);R==null||R.setNpcPositions(N)},at=N=>{u==null||u.update()};return ct(()=>{rt(()=>{(d().position().x!==O.x||d().position().y!==O.y)&&(L(),w(),O={x:d().position().x,y:d().position().y},v&&v.moveTo(d().position().x*64,d().position().y*64)),d().isAlive()||(console.debug("Player is dead, handling game over..."),Z.delayedCall(1,()=>{o(),P()}))})}),{loadLevel:ot,showGameView:ht,update:at,getState:U}},ko=n=>{const{mainMenuVM:t,view:e,loadingScreenVM:i,saveController:o}=n,r=()=>{i.showLevelLoadScreen(),i.setVisible(!0),setTimeout(()=>{i.setVisible(!1),u.showGameView(),V.emit("ON_RESUME_INPUT")},2e3)},d=()=>{console.debug("Resetting game progress..."),o.clear(),mt().reset()},a=g=>{console.debug("Preparing next level...");const y=Ye();g.playerModel.moveTo(y.playerModel.position().x,y.playerModel.position().y),y.playerModel=g.playerModel;const v=y.playerModel.inventory().items().filter(E=>E.code()==="torch").length,C=Math.max(0,30-v);se("torch",C).forEach(E=>y.playerModel.inventory().addItem(E));const T=Math.abs(Math.max(-5,y.playerModel.health()-y.playerModel.maxHealth()));return y.playerModel.setHealth(y.playerModel.health()+T),y},h=async g=>{i.showRestScreen(),i.setVisible(!0),await Z.delayedCall(8,()=>{u.loadLevel(a(g))}),await Z.delayedCall(2,()=>{i.setVisible(!1),u.showGameView()})},l=(g=!1,y=!1)=>{const v=o.load(y);g?i.showDebugScreen():v&&i.showLevelLoadScreen(),i.setVisible(!0),t.hide(),u.loadLevel(g?void 0:v);const C=ct(()=>{rt(()=>{i.isVisible()||(u.showGameView(),V.emit("ON_RESUME_INPUT"),C())})})},c=()=>{console.debug("Starting game..."),t.setIsContinueButtonVisible(o.saveExists()),t.setIsAutoSaveAvailable(o.autoSaveExists()),t.show()},s=()=>{console.debug("Exiting game...")},p=g=>{u.update(g)},u=uo({view:e,saveController:o,onGameLoadRequest:r,onLevelCompleted:h,onGameOver:()=>{console.debug("Game Over"),V.emit("ON_PAUSE_INPUT"),i.showGameOverScreen(),i.setVisible(!0);const g=ct(()=>{rt(()=>{i.isVisible()||(t.show(),g())})})}});return{loadLevel:l,initGame:c,exitGame:s,update:p,resetProgress:d}};export{ko as createGameController};
