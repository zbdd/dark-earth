import{c as lt,g as j,S as J}from"./sound-manager-C7eblkXa.js";import{g as Tt,h as it,A as re,d as vt,i as ee,j as Ue,k as ze,e as ni,f as si,m as de,G as mt,n as Qt}from"./npc-model-C3G4rdQZ.js";import{E as oi,G as K,i as ue,R as ie,C as U,P as qe,S as G,T as _t,f as ri,j as ai,k as $e,l as li}from"./index-BUhH2gUn.js";import{c as F,a as ct}from"./solid-lwVvZ318.js";import{c as Yt,b as ft,a as Ge}from"./modal-view-Bzr93SJD.js";const ci=(s,t,e)=>{if(s<=0)return;const i=[...t];i.sort((o,d)=>{const l=o.position().distanceTo(e.position()),c=d.position().distanceTo(e.position());return l-c});const n=Math.min(4,Math.floor(i.length/s));for(let o=0;o<s;o++){const d=Tt("city-key"),l=Math.floor(Math.random()*100)<=33?0:Math.floor(Math.random()*100)<=66?1:2,c=Math.min(i.length-1,l+Math.floor((o+1)*n)),a=i[c];i.splice(l,1),a.inventory().addItem(d)}},hi=({map:s,rooms:t,pathEnemyChance:e=.2,paths:i})=>{const o=(a,h)=>a>0&&h>0&&a<s.length-1&&h<s[0].length-1,d=(a,h,r,f)=>Math.sqrt((a-r)**2+(h-f)**2),l=(a,h,r)=>r.every(f=>d(f.position().x,f.position().y,a,h)>=10),c=[];return t.forEach((a,h)=>{if(h===0)return;const r=Math.floor(Math.random()*2);for(let f=0;f<r;f++){const[p,u]=a[Math.floor(Math.random()*a.length)];if(o(p,u)&&l(p,u,c)){const g=s[p][u];g.hasEnemy()||(g.hasEnemy=()=>!0,c.push(g))}}}),i.forEach((a,h)=>{h!==0&&a.forEach(([r,f])=>{if(Math.random()<e&&o(r,f)&&l(r,f,c)){const p=s[r][f];p.hasEnemy()||(p.hasEnemy=()=>!0,c.push(p))}})}),c},di=({map:s,rooms:t,pathEventChance:e=.1,paths:i})=>{const o=[],d=(c,a)=>c>0&&a>0&&c<s.length-1&&a<s[0].length-1,l=(c,a,h,r)=>Math.sqrt((c-h)**2+(a-r)**2);return t.forEach(c=>{const a=c.length/2,h=Math.floor(Math.random()*a)+2;for(let r=0;r<h;r++){const[f,p]=c[Math.floor(Math.random()*c.length)];if(d(f,p)&&o.every(u=>l(u.position().x,u.position().y,f,p)>=3)){const u=s[f][p];!u.hasEvent()&&u.traversable()&&u.type()!=="settlement"&&(u.hasEvent=()=>!0,o.push(u))}}}),i.forEach(c=>{c.forEach(([a,h])=>{if(Math.random()<e&&d(a,h)){const r=s[a][h];!r.hasEvent()&&r.type()!=="settlement"&&r.traversable()&&o.every(f=>l(f.position().x,f.position().y,a,h)>=3)&&(r.hasEvent=()=>!0,o.push(r))}})}),o},fe=[it({id:"ancient-bunker",name:"Ancient Bunker",startPosition:{x:0,y:0},startingItems:[],level:3}),it({id:"bandit-camp",name:"Bandit Camp",startPosition:{x:0,y:0},startingItems:[],level:4}),it({id:"beacon",name:"Beacon",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"bear-cage",name:"Bear Cage",startPosition:{x:0,y:0},startingItems:[],level:4}),it({id:"bunker",name:"Bunker",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"campfire",name:"Campfire",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"cave",name:"Cave",startPosition:{x:0,y:0},startingItems:[],level:3}),it({id:"chest",name:"Chest",startPosition:{x:0,y:0},startingItems:[],level:1}),it({id:"church",name:"Church",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"crashed-plane",name:"Crashed Plane",startPosition:{x:0,y:0},startingItems:[],level:3}),it({id:"fungi",name:"Fungi",startPosition:{x:0,y:0},startingItems:[],level:1}),it({id:"tent",name:"Tent",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"lean-to",name:"Lean-To",startPosition:{x:0,y:0},startingItems:[],level:2}),it({id:"ruin",name:"Ruin",startPosition:{x:0,y:0},startingItems:[],level:4}),it({id:"scary-tree",name:"Scary Tree",startPosition:{x:0,y:0},startingItems:[],level:1}),it({id:"silo",name:"Silo",startPosition:{x:0,y:0},startingItems:[],level:3}),it({id:"sword-in-stone",name:"Monument",startPosition:{x:0,y:0},startingItems:[],level:5}),it({id:"wagon",name:"Wagon",startPosition:{x:0,y:0},startingItems:[],level:1}),it({id:"wreck",name:"Wreck",startPosition:{x:0,y:0},startingItems:[],level:1})],ui=()=>{const s=Math.floor(Math.random()*fe.length);return fe[s]},fi=s=>{const t=Math.floor(Math.random()*s)+1,e=[];for(let i=0;i<t;i++){if(Math.random()<.5)continue;const n=pi();e.push(n)}if(e.length===0){const i=Tt("coin");e.push(i)}return e},pi=()=>{let s=0;const t=[];return re.map(i=>{const n=new Array(i.randomDropWeight()).fill(i);t.push(...n),s+=i.randomDropWeight()}),Tt(t[Math.floor(Math.random()*s)].code())},mi=s=>s.map(t=>{const e=ui();return it({id:e.id(),name:e.name(),startPosition:{x:t.position().x,y:t.position().y},level:e.level(),startingItems:fi(e.level())})}),gi=(s,t)=>{const e=(c,a)=>{const h=[],r=Math.abs(a.position.x-c.position.x),f=Math.abs(a.position.y-c.position.y),p=c.position.x<a.position.x?1:-1,u=c.position.y<a.position.y?1:-1;let g=r-f,y=c.position.x,v=c.position.y;for(;y!==a.position.x||v!==a.position.y;){h.push([y,v]);const b=g*2;b>-f&&(g-=f,y+=p),b<r&&(g+=r,v+=u)}return h},i=(c,a,h,r)=>{const f=c[c.length-1],[p,u]=f;for(const g of r){if(h.has(g.id))continue;if(Math.hypot(g.position.x-p,g.position.y-u)>3){const v=e({position:{x:p,y:u}},g);a.push(v),h.add(g.id);break}}},n=(c,a)=>{let h=null,r=1/0;for(const f of s){if(a.has(f.id))continue;const p=Math.hypot(f.position.x-c.position.x,f.position.y-c.position.y);p<r&&p<t&&(h=f,r=p)}return h},o=[],d=new Set;let l=s[0];for(d.add(l.id);d.size<s.length;){let c=n(l,d);if(!c){const a=Array.from(d).map(h=>s.find(r=>r.id===h));for(;a.length>0;){const h=a.pop();if(c=n(h,d),c){l=h;break}}c||(c=s.find(h=>!d.has(h.id))||null)}if(c){const a=e(l,c);o.push(a),d.add(c.id),l=c,a.length>7&&i(a,o,d,s)}else break}return o},yi=(s,t,e,i={min:2,max:4})=>{const n=s.length,o=s[0].length,d=[],l=(h,r)=>h>=0&&r>=0&&h<n&&r<o,c=(h,r,f)=>f.every(([p,u])=>{const g=h+p,y=r+u;if(!l(g,y))return!1;for(let v=-1;v<=1;v++)for(let b=-1;b<=1;b++){const k=g+v,E=y+b;if(l(k,E)&&s[k][E].type()!=="void")return!1}return!0}),a=h=>{const r=[];switch(Math.floor(Math.random()*4)){case 0:for(let g=-h;g<=h;g++)for(let y=-h;y<=h;y++)g*g+y*y<=h*h&&r.push([g,y]);break;case 1:for(let g=-h;g<=h+2;g++)for(let y=-h;y<=h;y++)(g*g+y*y<=h*h||Math.abs(g)<h&&Math.abs(y)<h)&&r.push([g,y]);break;case 2:for(let g=-h;g<=h;g++)for(let y=-h;y<=h;y++)(g*g+y*y<=h*h&&Math.random()>.5||Math.abs(g)<h&&Math.abs(y)<h&&Math.random()>.5)&&r.push([g,y]);break;case 3:const p=h*2,u=Math.floor(h/2);for(let g=-p;g<=p;g++)for(let y=-u;y<=u;y++)r.push([g,y]);break}return r};return t.forEach(h=>{const r=Math.floor(Math.random()*(i.max-i.min+1)+i.min),f=a(r),p=[];c(h.position.x,h.position.y,f)&&f.forEach(([u,g])=>{const y=h.position.x+u,v=h.position.y+g;l(y,v)&&(s[y][v]=vt({terrain:"wasteland",position:{x:y,y:v}}),p.push([y,v]))}),p.length>0&&d.push(p)}),e.forEach(h=>{h.forEach(([r,f])=>{for(let p=-Math.floor(Math.random()*2);p<=Math.floor(Math.random()*2);p++)for(let u=-Math.floor(Math.random()*2);u<=Math.floor(Math.random()*2);u++){const g=r+p,y=f+u;l(g,y)&&s[g][y].type()!=="wasteland"&&(s[g][y]=vt({terrain:"grass",position:{x:g,y}}))}})}),{map:s,rooms:d}},vi=(s,t)=>Math.sqrt(Math.pow(s.x-t.x,2)+Math.pow(s.y-t.y,2)),wi=s=>{const{horizontalTiles:t,verticalCells:e,nodeCount:i,minDistanceBetweenNodes:n,maxAttemptsToAssignNode:o}=s,d=[],l=Math.ceil(Math.sqrt(i)),c=Math.floor(t/l),a=Math.floor(e/l),h=(r,f)=>d.every(p=>Math.abs(vi(p.position,{x:r,y:f}))>=n);for(let r=0;r<i;r++){let f=0,p=!1;for(;f<o&&!p;){const u=Math.floor(r%l)*c,g=Math.floor(r/l)*a;let y=u+Math.floor(Math.random()*c),v=g+Math.floor(Math.random()*a);y=Math.max(3,Math.min(t-3,y)),v=Math.max(3,Math.min(e-3,v)),y<t&&v<e&&h(y,v)?(d.push({id:`node-${r}`,position:{x:y,y:v}}),p=!0):f++}p||d.pop()&&r--}return d},xi=s=>{const{startPosition:t}=s,e=[...ee("torch",30),...ee("coin",3)],i=[],n=[...e,...i];return Ue({name:"Hero",id:"player",startPosition:t,startingItems:n,team:"player"})},Fe=()=>{const s=wi({horizontalTiles:64,verticalCells:64,nodeCount:80,minDistanceBetweenNodes:7,maxAttemptsToAssignNode:100}),t=gi(s,15),e=b=>{const k=Math.floor(Math.random()*b)+1,E=[];for(let S=0;S<k;S++){if(Math.random()<.5)continue;const P=i(),_=E.find(T=>T.code()===P.code());if(_){_.code()==="coin"&&_.updateQuantity(_.quantity()+1);continue}E.push(P)}if(E.length===0){const S=Tt("coin");E.push(S)}return E},i=()=>{let b=0;const k=[];return re.map(E=>{const S=new Array(E.randomDropWeight()).fill(E);k.push(...S),b+=E.randomDropWeight()}),k[Math.floor(Math.random()*b)]},{map:n,rooms:o}=yi(Array.from({length:64},(b,k)=>Array.from({length:64},(E,S)=>vt({terrain:"void",position:{x:k,y:S}}))),s,t,{min:2,max:4}),l=hi({map:n,rooms:o,paths:t,pathEnemyChance:.2}).map(b=>ze({id:"bandit",name:"Bandit",team:"hostile-to-all",startPosition:{x:b.position().x,y:b.position().y},startingItems:e(Math.floor(Math.random()*3)+1),startingHealth:2})),c=b=>{b[0].map(k=>vt({terrain:"mountain",position:k.position()})),b[b.length-1].map(k=>vt({terrain:"mountain",position:k.position()})),b.forEach(k=>{vt({terrain:"mountain",position:k[0].position()}),vt({terrain:"mountain",position:k[k.length-1].position()})})},a=["settlement","large-settlement","sanctuary","citadel"],h=(b,k)=>{const{x:E,y:S}=b,P=[{x:E,y:S},{x:E+1,y:S},{x:E,y:S+1},{x:E+1,y:S+1}];return P.forEach(_=>{k[_.x]&&k[_.x][_.y]&&(k[_.x][_.y]=vt({terrain:"settlement",position:_}))}),de({id:a.shift()??"settlement",name:`Settlement at (${E}, ${S})`,level:1,positions:P})};function r(b,k){const E=[];return b.forEach((S,P)=>{const{x:_,y:T}=S.position,m=!0;if(P===0){E.push(h({x:_,y:T},k));return}_<k.length-1&&T<k[0].length-1&&m?E.push(h({x:_,y:T},k)):(k[_][T]=vt({terrain:"settlement",position:{x:_,y:T}}),E.push(de({id:a.shift()??"settlement",name:`Settlement ${P+1}`,level:1,positions:[{x:_,y:T}]})))}),E}const p=((b,k,E)=>{const S=[],P=new Set,_=T=>{const m=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],x=m[Math.floor(Math.random()*m.length)];return{x:T.position.x+x.x,y:T.position.y+x.y}};for(S.push({id:b[0].id,position:_(b[0])});S.length<k&&S.length<b.length&&P.size<b.length;){const T=Math.floor(Math.random()*b.length),m=b[T],x=`${m.position.x},${m.position.y}`;if(P.has(x))continue;let w=!0;for(const C of S)if(Math.sqrt(Math.pow(m.position.x-C.position.x,2)+Math.pow(m.position.y-C.position.y,2))<E){w=!1;break}w&&(S.push(m),P.add(x))}return S})(s,3,5),u=r(p,n);c(n);const g=di({map:n,rooms:o,paths:t,pathEventChance:.1}),y=mi(g),v=xi({startPosition:s[0].position});return ci(u.length,l,v),{playerModel:v,tileMapModel:si(n),npcModels:l,eventModels:y,settlementModels:u,fogOfWarViewModel:ni()}};/*!
 * PixiPlugin 3.13.0
 * https://gsap.com
 *
 * @license Copyright 2008-2025, GreenSock. All rights reserved.
 * Subject to the terms at https://gsap.com/standard-license
 * @author: Jack Doyle, jack@greensock.com
*/var bt,Xt,pe,pt,Dt,Qe,ne,Zt,Ye=function(){return typeof window<"u"},Xe=function(){return bt||Ye()&&(bt=window.gsap)&&bt.registerPlugin&&bt},se=function(t){return typeof t=="function"},je=function(t){return console.warn(t)},bi=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],Ct=.212671,wt=.71516,yt=.072169,Ze=function(t){return se(pt[t])?pt[t]:pt.filters[t]},Kt=function(t,e){var i=[],n=0,o=0,d,l;for(d=0;d<4;d++){for(l=0;l<5;l++)o=l===4?t[n+4]:0,i[n+l]=t[n]*e[l]+t[n+1]*e[l+5]+t[n+2]*e[l+10]+t[n+3]*e[l+15]+o;n+=5}return i},me=function(t,e){var i=1-e,n=i*Ct,o=i*wt,d=i*yt;return Kt([n+e,o,d,0,0,n,o+e,d,0,0,n,o,d+e,0,0,0,0,0,1,0],t)},ge=function(t,e,i){var n=Xt(e),o=n[0]/255,d=n[1]/255,l=n[2]/255,c=1-i;return Kt([c+i*o*Ct,i*o*wt,i*o*yt,0,0,i*d*Ct,c+i*d*wt,i*d*yt,0,0,i*l*Ct,i*l*wt,c+i*l*yt,0,0,0,0,0,1,0],t)},ye=function(t,e){e*=Math.PI/180;var i=Math.cos(e),n=Math.sin(e);return Kt([Ct+i*(1-Ct)+n*-.212671,wt+i*-.71516+n*-.71516,yt+i*-.072169+n*(1-yt),0,0,Ct+i*-.212671+n*.143,wt+i*(1-wt)+n*.14,yt+i*-.072169+n*-.283,0,0,Ct+i*-.212671+n*-.787329,wt+i*-.71516+n*wt,yt+i*(1-yt)+n*yt,0,0,0,0,0,1,0,0,0,0,0,1],t)},ve=function(t,e){return Kt([e,0,0,0,.5*(1-e),0,e,0,0,.5*(1-e),0,0,e,0,.5*(1-e),0,0,0,1,0],t)},Ke=function(t,e){var i=Ze(e),n=t.filters||[],o=n.length,d;for(i||je(e+" not found. PixiPlugin.registerPIXI(PIXI)");--o>-1;)if(n[o]instanceof i)return n[o];return d=new i,e==="BlurFilter"&&(Zt?d.strength=0:d.blur=0),t.filters=[].concat(n,[d]),d},st=function(t,e,i,n){e.add(i,t,i[t],n[t]),e._props.push(t)},we=function(t,e){var i=Ze("ColorMatrixFilter"),n=new i;return n.matrix=e,n.brightness(t,!0),n.matrix},Ci=function(t){var e={},i;for(i in t)e[i]=t[i];return e},ut={contrast:1,saturation:1,colorizeAmount:0,colorize:"rgb(255,255,255)",hue:0,brightness:1},Ti=function(t,e,i){var n=Ke(t,"ColorMatrixFilter"),o=t._gsColorMatrixFilter=t._gsColorMatrixFilter||Ci(ut),d=e.combineCMF&&!("colorMatrixFilter"in e&&!e.colorMatrixFilter),l,c,a;for(a=n.matrix,e.resolution&&(n.resolution=e.resolution),e.matrix&&e.matrix.length===a.length?(c=e.matrix,o.contrast!==1&&st("contrast",i,o,ut),o.hue&&st("hue",i,o,ut),o.brightness!==1&&st("brightness",i,o,ut),o.colorizeAmount&&(st("colorize",i,o,ut),st("colorizeAmount",i,o,ut)),o.saturation!==1&&st("saturation",i,o,ut)):(c=bi.slice(),e.contrast!=null?(c=ve(c,+e.contrast),st("contrast",i,o,e)):o.contrast!==1&&(d?c=ve(c,o.contrast):st("contrast",i,o,ut)),e.hue!=null?(c=ye(c,+e.hue),st("hue",i,o,e)):o.hue&&(d?c=ye(c,o.hue):st("hue",i,o,ut)),e.brightness!=null?(c=we(+e.brightness,c),st("brightness",i,o,e)):o.brightness!==1&&(d?c=we(o.brightness,c):st("brightness",i,o,ut)),e.colorize!=null?(e.colorizeAmount="colorizeAmount"in e?+e.colorizeAmount:1,c=ge(c,e.colorize,e.colorizeAmount),st("colorize",i,o,e),st("colorizeAmount",i,o,e)):o.colorizeAmount&&(d?c=ge(c,o.colorize,o.colorizeAmount):(st("colorize",i,o,ut),st("colorizeAmount",i,o,ut))),e.saturation!=null?(c=me(c,+e.saturation),st("saturation",i,o,e)):o.saturation!==1&&(d?c=me(c,o.saturation):st("saturation",i,o,ut))),l=c.length;--l>-1;)c[l]!==a[l]&&i.add(a,l,a[l],c[l],"colorMatrixFilter");i._props.push("colorMatrixFilter")},ki=function(t,e){var i=e.t,n=e.p,o=e.color,d=e.set;d(i,n,o[0]<<16|o[1]<<8|o[2])},Ii=function(t,e){var i=e.g;Zt?(i.fill(),i.stroke()):i&&(i.dirty++,i.clearDirty++)},_i=function(t,e){e.t.visible=!!e.t.alpha},xe=function(t,e,i,n){var o=t[e],d=Xt(se(o)?t[e.indexOf("set")||!se(t["get"+e.substr(3)])?e:"get"+e.substr(3)]():o),l=Xt(i);n._pt=new Dt(n._pt,t,e,0,0,ki,{t,p:e,color:d,set:Qe(t,e)}),n.add(d,0,d[0],l[0]),n.add(d,1,d[1],l[1]),n.add(d,2,d[2],l[2])},Mi={tint:1,lineColor:1,fillColor:1,strokeColor:1},be="position,scale,skew,pivot,anchor,tilePosition,tileScale".split(","),oe={x:"position",y:"position",tileX:"tilePosition",tileY:"tilePosition"},Ei={colorMatrixFilter:1,saturation:1,contrast:1,hue:1,colorize:1,colorizeAmount:1,brightness:1,combineCMF:1},jt=Math.PI/180,Je=function(t){return typeof t=="string"},Si=function(t){return Je(t)&&t.charAt(1)==="="?t.substr(0,2)+parseFloat(t.substr(2))*jt:t*jt},Ai=function(t,e){return e.set(e.t,e.p,t===1?e.e:Math.round((e.s+e.c*t)*1e5)/1e5,e)},Pi=function(t,e,i,n,o,d){var l=360*(d?jt:1),c=Je(o),a=c&&o.charAt(1)==="="?+(o.charAt(0)+"1"):0,h=parseFloat(a?o.substr(2):o)*(d?jt:1),r=a?h*a:h-n,f=n+r,p,u;return c&&(p=o.split("_")[1],p==="short"&&(r%=l,r!==r%(l/2)&&(r+=r<0?l:-l)),p==="cw"&&r<0?r=(r+l*1e10)%l-~~(r/l)*l:p==="ccw"&&r>0&&(r=(r-l*1e10)%l-~~(r/l)*l)),t._pt=u=new Dt(t._pt,e,i,n,r,Ai),u.e=f,u},Ce=function(){if(!pe){bt=Xe(),pt=pe=pt||Ye()&&window.PIXI;var t=pt&&pt.VERSION&&parseFloat(pt.VERSION.split(".")[0])||0;ne=t===4,Zt=t>=8,Xt=function(i){return bt.utils.splitColor((i+"").substr(0,2)==="0x"?"#"+i.substr(2):i)}}},Gt,Mt;for(Gt=0;Gt<be.length;Gt++)Mt=be[Gt],oe[Mt+"X"]=Mt,oe[Mt+"Y"]=Mt;var ae={version:"3.13.0",name:"pixi",register:function(t,e,i){bt=t,Dt=i,Qe=e.getSetter,Ce()},headless:!0,registerPIXI:function(t){pt=t},init:function(t,e,i,n,o){if(pt||Ce(),!pt)return je("PIXI was not found. PixiPlugin.registerPIXI(PIXI);"),!1;var d,l,c,a,h,r,f,p,u,g;for(r in e){if(d=oe[r],c=e[r],d)l=~r.charAt(r.length-1).toLowerCase().indexOf("x")?"x":"y",this.add(t[d],l,t[d][l],d==="skew"?Si(c):c,0,0,0,0,0,1);else if(r==="scale"||r==="anchor"||r==="pivot"||r==="tileScale")this.add(t[r],"x",t[r].x,c),this.add(t[r],"y",t[r].y,c);else if(r==="rotation"||r==="angle")Pi(this,t,r,t[r],c,r==="rotation");else if(Ei[r])a||(Ti(t,e.colorMatrixFilter||e,this),a=!0);else if(r==="blur"||r==="blurX"||r==="blurY"||r==="blurPadding"){if(h=Ke(t,"BlurFilter"),this.add(h,r,h[r],c),e.blurPadding!==0)for(f=e.blurPadding||Math.max(h[r],c)*2,p=t.filters.length;--p>-1;)t.filters[p].padding=Math.max(t.filters[p].padding,f)}else if(Mi[r])if((r==="lineColor"||r==="fillColor"||r==="strokeColor")&&t instanceof pt.Graphics)for(u=("fillStyle"in t)?[t]:(t.geometry||t).graphicsData,g=r.substr(0,r.length-5),Zt&&g==="line"&&(g="stroke"),this._pt=new Dt(this._pt,t,r,0,0,Ii,{g:t.geometry||t}),p=u.length;--p>-1;)xe(ne?u[p]:u[p][g+"Style"],ne?r:"color",c,this);else xe(t,r,c,this);else r==="autoAlpha"?(this._pt=new Dt(this._pt,t,"visible",0,0,_i),this.add(t,"alpha",t.alpha,c),this._props.push("alpha","visible")):r!=="resolution"&&this.add(t,r,"get",c);this._props.push(r)}}};Xe()&&bt.registerPlugin(ae);const R=new oi,Ni=s=>{let t=!1;return R.on("ON_PAUSE_INPUT",()=>{t=!1}),R.on("ON_RESUME_INPUT",()=>{t=!0}),R.on("ON_LEVEL_COMPLETED",()=>{s.handleLevelCompleted()}),R.on("ON_TILE_INTERACTION",({tileViewModel:e})=>{t&&s.handleTileInteraction(e)}),R.on("ON_ITEM_INTERACTION",({itemViewModel:e,action:i})=>{t&&s.handleItemInteraction(e,i)}),R.on("ON_EVENT_INTERACTION",({eventViewModel:e})=>{t&&s.handleEventInteraction(e)}),R.on("ON_CHARACTER_INTERACTION",({characterViewModel:e})=>{t&&s.handleCharacterInteraction(e)}),R.on("ON_INVENTORY_REQUEST",({inventory:e,action:i})=>{t&&s.handleInventoryRequest(e,i)}),R.on("ON_CLOSE_INVENTORY_REQUESTED",()=>{t&&s.onCloseInventoryRequested()}),R.on("ON_TRADE_REQUEST",({action:e})=>{t&&s.handleTradeRequest(e)}),R.on("ON_CHARACTER_INTERACTION_REQUEST",e=>{t&&s.handleCharacterInteractionRequest(e)}),R.on("ON_SETTLEMENT_INTERACTION_REQUEST",e=>{t&&s.handleSettlementInteractionRequest(e)}),R.on("ON_SAVE_REQUEST",()=>{s.handleSaveRequest()}),R.on("ON_LOAD_REQUEST",()=>{s.handleLoadRequest()}),R.on("ON_IN_GAME_MENU_REQUEST",({action:e})=>{s.handleInGameMenuRequest(e)}),R.on("ON_DEBUG_ACTION_REQUESTED",({action:e})=>{t&&s.onDebugActionRequested(e)}),{destroy:()=>{R.removeAllListeners()}}},Ri=()=>{const[s,t]=F(0),[e,i]=F(480);return{getCurrentTurn:()=>s(),getGameTimeMin:()=>e(),nextTurn:()=>{t(l=>l+1),i(l=>{const c=l+10;return c>=1440?0:c})}}},Ht=s=>{const{model:t}=s,[e,i]=F(t.armour()>0),[n,o]=F(t.armour()<t.maxArmour()),[d,l]=F(t.damage()>0),[c,a]=F(t.health()>0),h={code:()=>t.code(),name:()=>t.name(),description:()=>t.description(),quantity:()=>t.quantity(),value:()=>t.value(),updateQuantity:r=>{t.updateQuantity(r)},level:()=>t.level(),interact:()=>{R.emit("ON_ITEM_INTERACTION",{itemViewModel:h})},health:()=>t.health(),type:()=>t.type(),damage:()=>t.damage(),range:()=>t.range(),armour:()=>t.armour(),setArmour:r=>{t.setArmour(r)},maxArmour:()=>t.maxArmour(),id:()=>t.id(),isArmourIconVisible:()=>e(),isDamagedArmourIconVisible:()=>n(),isHealthIconVisible:()=>c(),setIsArmourIconVisible:r=>{i(r)},setIsDamagedArmourIconVisible:r=>{o(r)},setIsHealthIconVisible:r=>{a(r)},isDamageIconVisible:()=>d(),setIsDamageIconVisible:r=>{l(r)},uses:()=>t.uses(),setUses:r=>{t.setUses(r)},collected:()=>t.collected(),setCollected:r=>{t.setCollected(r)}};return h},kt=s=>{const{model:t,ownerName:e,owner:i}=s,[n,o]=F([]),[d,l]=F(!1),c=r=>Ht({model:r}),a=(r,f)=>{const p=r.code()===f.code(),u=r.armour()===f.armour(),g=r.damage()===f.damage();return p&&u&&g},h={items:()=>t.items().map(r=>c(r)),stacks:()=>n(),setStacks:()=>{const r=[],f=[];h.items().forEach(p=>{if(i&&i.isEquipped(p)){f.push({item:p,quantity:1});return}const u=r.find(g=>a(g.item,p));u?u.quantity+=p.quantity():r.push({item:p,quantity:p.quantity()})}),r.sort((p,u)=>u.item.type()==="currency"&&p.item.type()!=="currency"?1:u.item.type()!=="currency"&&p.item.type()==="currency"?-1:u.item.type()==="light"&&p.item.type()!=="light"?1:u.item.type()!=="light"&&p.item.type()==="light"?-1:u.item.armour()>0&&p.item.armour()<=0?1:u.item.armour()<=0&&p.item.armour()>0?-1:u.item.damage()>0&&p.item.damage()<=0?1:u.item.damage()<=0&&p.item.damage()>0?-1:u.item.health()>0&&p.item.health()<=0?1:u.item.health()<=0&&p.item.health()>0?-1:u.item.type()==="loot"&&p.item.type()!=="loot"?1:u.item.type()!=="loot"&&p.item.type()==="loot"?-1:p.item.name().localeCompare(u.item.name())),o(f.concat(r))},ownerName:()=>e,getItem:r=>h.items().find(f=>a(f,r)),getItemByCode:r=>h.items().find(f=>f.code()===r),getItemByName:r=>h.items().find(f=>f.name()===r),addItem:r=>{t.addItem(Tt(r.code(),{id:()=>r.id()})),h.setStacks()},removeItem:r=>{t.removeItem(r),h.setStacks(),!r.collected()&&(!i||!i.isAlive())&&!["trade-npc","trade","settlement","hero"].includes(e.toLowerCase())&&["trade-npc","trade","settlement","hero"].filter(f=>e.toLowerCase().includes(f)).length===0&&(r.setCollected(!0),mt().log.collectedItemsValue+=r.value())},owner:i,isEmpty:()=>t.isEmpty(),isOnlyLoot:()=>t.isOnlyLoot(),isInfoButtonEnabled:()=>d(),setInfoButtonEnabled:r=>{l(r)}};return h.setStacks(),lt(()=>{ct(()=>{h.setStacks()})}),h},le=s=>{const{model:t}=s,[e,i]=F(kt({model:t.inventory(),ownerName:t.name()})),n=l=>{if(!l)throw new Error("Item cannot be undefined");const c=t.inventory().getItemById(l.id());if(!c)throw new Error(`Item with code ${l.id()} not found in inventory`);return c},o=l=>{if(!l)throw new Error("Item cannot be undefined");return Ht({model:l})},d={id:()=>t.id(),name:()=>t.name(),setInventory:l=>{i(l)},size:()=>t.size(),position:()=>({...t.position(),distanceTo:l=>{const c=t.position().x-l.x,a=t.position().y-l.y;return Math.floor(Math.sqrt(c*c+a*a))}}),health:()=>t.health(),maxHealth:()=>t.maxHealth(),moveTo:(l,c)=>{d.isAlive()&&t.moveTo(l,c)},dialogue:()=>t.dialogue(),isHostile:l=>t.isHostile(l),move:(l,c)=>{const a=t.position(),h=a.x+l,r=a.y+c;t.moveTo(h,r)},team:()=>t.team(),updateTeam:l=>{t.updateTeam(l)},inventory:()=>e(),armour:()=>{var h,r,f;const l=((h=t.bodyArmour())==null?void 0:h.armour())??0,c=((r=t.headArmour())==null?void 0:r.armour())??0,a=((f=t.feetArmour())==null?void 0:f.armour())??0;return l+c+a},takeDamage:l=>{let c=l;new Array(l).fill(0).forEach(()=>{const h=[t.bodyArmour(),t.headArmour(),t.feetArmour()].filter(r=>r&&r.armour()>0);if(h.length!==0){const r=h[Math.floor(Math.random()*h.length)];r.setArmour(r.armour()-1),c--}}),t.id()==="player"&&(mt().log.totalDamageAbsorbed+=l-c,mt().log.totalDamageTaken+=c);const a=t.health()-c;t.setHealth(a)},setHealth:l=>{t.setHealth(l)},setMaxHealth:l=>{t.setMaxHealth(l)},isAlive:()=>t.health()>0,visible:()=>t.visible(),setVisible:l=>{t.setVisible(l)},bodyArmour:()=>o(t.bodyArmour()),setBodyArmour:l=>{l?t.setBodyArmour(n(l)):t.setBodyArmour(void 0)},headArmour:()=>o(t.headArmour()),setHeadArmour:l=>{l?t.setHeadArmour(n(l)):t.setHeadArmour(void 0)},feetArmour:()=>o(t.feetArmour()),setFeetArmour:l=>{l?t.setFeetArmour(n(l)):t.setFeetArmour(void 0)},weapon:()=>{const l=t.weapon();return Ht({model:l})},setWeapon:l=>{l?t.setWeapon(n(l)):t.setWeapon(void 0)},isEquipped:l=>{var c,a,h,r;return((c=t.weapon())==null?void 0:c.id())===l.id()||((a=t.bodyArmour())==null?void 0:a.id())===l.id()||((h=t.headArmour())==null?void 0:h.id())===l.id()||((r=t.feetArmour())==null?void 0:r.id())===l.id()}};return i(kt({model:t.inventory(),ownerName:t.name(),owner:d})),d},Vi=s=>{const{eventModel:t}=s;return{...t,inventory:()=>kt({model:t.inventory(),ownerName:t.name()})}},Bi=s=>s.tile,Li=s=>{const{model:t}=s,e=n=>Bi({tile:n});return{isValidMove:(n,o)=>t.isValidMove(n,o),entryPoints:()=>t.entryPoints().map(n=>e(n)),tiles:()=>t.tiles().map(n=>n.map(o=>e(o))),updateTile:(n,o,d)=>{t.tiles()[n][o]=d},getNeighbors:n=>{var a;const o=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],d=[],l=n.position().x,c=n.position().y;for(const{dx:h,dy:r}of o){const f=l+h,p=c+r,u=(a=t.tiles()[f])==null?void 0:a[p];u&&d.push(e(u))}return d}}},ti=s=>{const[t,e]=F([]),[i,n]=F(null),[o,d]=F([]),[l,c]=F(null),[a,h]=F(null),[r,f]=F(!1);return{...le({model:s}),setLastSpawned:u=>s.setLastTurnSpawned(u),lastSpawned:()=>s.lastTurnSpawned(),spawnLing:()=>s.spawnling(),getPatrolArea:()=>t(),setPatrolArea:u=>e(u),getTask:()=>i(),setTask:u=>n(u),getTaskList:()=>o(),setTaskList:u=>d(u),getBedLocation:()=>l(),setBedLocation:u=>c(u),getTarget:()=>a(),setTarget:u=>h(u),canTrade:()=>r(),setCanTrade:u=>f(u)}},Oi=s=>{const{model:t}=s,[e,i]=F(!0);return{id:()=>t.id(),name:()=>t.name(),level:()=>t.level(),positions:()=>t.positions(),isVisible:()=>e(),setIsVisible:n=>i(n),isUnlocked:()=>t.isUnlocked(),setIsUnlocked:n=>t.setIsUnlocked(n),inventory:()=>kt({model:t.inventory(),ownerName:t.name()}),getMiddleTopPosition:()=>{const n=t.positions();if(n.length===0)return{x:0,y:0};const o=Math.max(...n.map(l=>l.x)),d=Math.min(...n.map(l=>l.y));return{x:(o-n[0].x)/2+n[0].x,y:d}}}},Wi=s=>{const{playerModel:t,tileMapModel:e,npcModels:i,eventModels:n,settlementModels:o,fogOfWarViewModel:d}=s,l=le({model:t}),c=Li({model:e}),a=i.map(f=>ti(f)),h=n.map(f=>Vi({eventModel:f})),r=o.map(f=>Oi({model:f}));return{playerVM:l,tileMapVM:c,npcVMs:a,eventVMs:h,settlementVMs:r,fogOfWarViewModel:d}},Di=s=>{const{model:t}=s;return{getCurrentTurn:()=>t.getCurrentTurn(),nextTurn:()=>{t.nextTurn()},getCurrentClocktime:()=>{const e=t.getGameTimeMin(),i=Math.floor(e/60),n=e%60;return`${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},getCurrentTimeMin:()=>t.getGameTimeMin()}},gt=(s,t)=>Math.floor(Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.y-s.y,2))),Hi=(s,t)=>{let e=[];for(const i of t){const n=i.position(),o=gt(s,n);e.length===0||o<e[0].distance?e=[{npc:i,distance:o}]:o===e[0].distance&&e.push({npc:i,distance:o})}return e},Ui=(s,t)=>{let e=null,i=1/0;for(const n of t)n.positions().forEach(o=>{const d=gt(s,o);d<i&&(i=d,e=n)});return e},zi=(s,t)=>{let e=null,i=1/0;for(const n of t){const o=n.position(),d=gt(s,o);d<i&&(i=d,e=n)}return e},qi=({playerVM:s,npcVMs:t,settlementVMs:e,eventViewModels:i})=>{const[n,o]=F(!0),[d,l]=F(null),[c,a]=F(null),[h,r]=F(null),[f,p]=F(null),[u,g]=F(null),[y,v]=F(null),[b,k]=F(null),[E,S]=F(null),[P,_]=F(null),[T,m]=F(null),x=1;let w=null,C=null,I=null,B=null,L=null,W,A=null,M=null,N=null,D=null;const O=(H,Q)=>{if(Q){const ot=Q.position();if(gt(H,ot)<=x)return w=Q,!0}return!1},z=(H,Q)=>{if(!Q)return k(null),!1;const ot=Q.position();return gt(H,ot)<=x&&Q.inventory().isEmpty()===!1?(I=Q,!0):!1},q=H=>H.isUnlocked()||!s.inventory().items().some(Q=>Q.code()==="city-key")?!1:(M=H,!0),Y=H=>H.isUnlocked()&&!H.inventory().isEmpty()?(N=H,!0):!1,rt=H=>H.isUnlocked()?(D=H,!0):!1,nt=H=>{const Q=Ui(H,e);return Q&&Q.positions().forEach(ot=>{if(gt(H,ot)<=x)return q(Q),Y(Q),rt(Q),N||(B=Q),!0}),!1},V=(H,Q)=>{if(Q){const ot=Q.position(),dt=gt(H,ot);if(dt<=s.weapon().range()&&dt<=2&&!$(H,Q))return L=Q,!0}return!1},$=(H,Q)=>{if(Q){const ot=Q.position(),dt=gt(H,ot);if(dt<=s.weapon().range()&&s.weapon().range()>2&&dt>1)return A=Q,!0}return!1},X=H=>{const Q=s.position();return gt(Q,H.position)<=x&&H.inventory.isEmpty()===!1?(W=H.inventory,!0):!1},tt=H=>{if(H){const Q=s.position(),ot=H.position();if(gt(Q,ot)<=x&&H.canTrade())return C=H,!0}return!1},et=H=>{if(H.isHostile(s.team())){if(H.isAlive()){const Q=V(s.position(),H),ot=$(s.position(),H);return Q||ot}else if(H.inventory().isEmpty()===!1)return X({position:H.position(),inventory:H.inventory()})}else return H.isAlive()?(O(s.position(),H),tt(H)):X({position:H.position(),inventory:H.inventory()});return!1},at=()=>{w=null,C=null,I=null,B=null,L=null,W=null,A=null,M=null,N=null,D=null},Jt=()=>{d()!==w&&l(w),c()!==C&&a(C),b()!==I&&k(I),h()!==B&&r(B),f()!==L&&p(L),y()!==W&&v(W),c()!==C&&a(C),u()!==A&&g(A),E()!==M&&S(M),P()!==N&&_(N),T()!==D&&m(D)},he=()=>{const H=s.position(),Q=Hi(H,t),ot=zi(H,i);if(at(),Q.length>0)for(let dt=0;dt<Q.length;dt++){const ii=Q[dt].npc;if(et(ii))break}z(H,ot),nt(H),Jt()};return he(),lt(()=>{ct(()=>{he()})}),{isVisible:n,setVisibility:H=>o(H),canUnlockSettlement:E,canInteractWithCharacter:d,canAttackCharacter:f,canTradeWithCharacter:c,canVisitSettlement:h,canSearch:b,canLoot:y,canRangedAttackCharacter:u,canTradeWithSettlement:P,canRestAtSettlement:T}},$i=s=>{const{playerVM:t}=s,[e,i]=F(!1),[n,o]=F(!1),[d,l]=F(!1),[c,a]=F(0),h={torchLeft:()=>c(),health:()=>t.health(),maxHealth:()=>t.maxHealth(),armour:()=>h.bodyArmour().armour()+h.headArmour().armour()+h.feetArmour().armour(),maxArmour:()=>h.bodyArmour().maxArmour()+h.headArmour().maxArmour()+h.feetArmour().maxArmour(),inventoryValue:()=>Math.floor(t.inventory().items().reduce((r,f)=>r+f.value()*f.quantity(),0)),isInventoryValueVisible:r=>(r!==void 0&&i(r),e()),inventory:()=>t.inventory(),weapon:()=>t.weapon(),bodyArmour:()=>t.bodyArmour(),headArmour:()=>t.headArmour(),feetArmour:()=>t.feetArmour(),isInGameMenuVisible:()=>n(),showInGameMenu:r=>{l(!1),o(r)},isSaveCompleted:()=>d(),setIsSaveCompleted:r=>{setTimeout(()=>{l(!1)},2e3),l(r)}};return lt(()=>{ct(()=>{const r=t.inventory().stacks().find(f=>f.item.code()==="torch");a(r?r.quantity:0)})}),h},Gi=s=>{const{gameView:t,viewModel:e}=s,i=new K,n=new K;n.label="sensing-fog-of-war",n.alpha=.5,i.label="fog-of-war",i.zIndex=1e4,n.zIndex=10001;const o=()=>{i.destroy({children:!0}),n.destroy({children:!0})};t.addChild(i,n);const d=c=>{const r=c.x-innerWidth*.5,f=c.y-innerHeight*.5,p=innerWidth,u=innerHeight,g=Math.floor(r/64)-2,y=Math.floor(f/64)-2,v=Math.ceil((r+p)/64)+2,b=Math.ceil((f+u)/64)+2,k=[];for(let E=g;E<=v;E++)for(let S=y;S<=b;S++)k.push({x:E,y:S});return k};return{applyFogOfWarExceptAround:c=>{e.setFogOfWarPoints(d(c));const a=64;i.clear(),n.clear();const h=new ue;h.x=c.x,h.y=c.y,h.radius=e.lightRadius()*1.8;const r=new ue;r.x=c.x,r.y=c.y,r.radius=e.lightRadius();for(const f of e.fogOfWarPoints()){const p=new ie;if(p.x=Math.floor(f.x*a),p.y=Math.floor(f.y*a),p.width=a,p.height=a,r.contains(p.x,p.y)){e.addRevealedPoint({x:f.x,y:f.y});continue}if(h.contains(p.x,p.y)){n.rect(p.x,p.y,a,a),n.fill("black"),e.revealedPoints().some(u=>u.x===f.x&&u.y===f.y)||e.addRevealedPoint({x:f.x,y:f.y});continue}if(e.revealedPoints().some(u=>u.x===f.x&&u.y===f.y)){n.rect(p.x,p.y,a,a),n.fill("black");continue}i.rect(p.x,p.y,a,a),i.fill(0)}},destroy:o}},Fi=({gameViews:s,userInterfaceView:t,fogOfWarVM:e})=>{const i=new U,n=new U,o=new K,d=.2,{gameView:l,nonSkewedView:c}=s;let a=!1,h=!1,r={x:0,y:0},f=null,p=Gi({gameView:l,viewModel:e}),u={x:0,y:0},g;i.label="camera-view",n.label="viewport",n.addChild(o,l,c),l.scale.set(.6);const y=()=>{f==null||f.kill(),document.removeEventListener("mousedown",b),document.removeEventListener("mouseup",k),document.removeEventListener("mousemove",E),document.removeEventListener("wheel",S),n.destroy({children:!0}),o.destroy(),p==null||p.destroy(),p=null,i.removeChildren(),i.destroy({children:!0})},v=(T,m)=>{o.clear(),o.rect(0,0,T,m),o.fill("black")};i.addChild(n,t);const b=T=>{T.button===0&&(a=!0)},k=T=>{T.button===0&&(a=!1,h=!1)},E=T=>{const m={x:T.clientX,y:T.clientY},x=m.x-r.x,w=m.y-r.y;if(h&&x!==0&&w!==0&&(a=!0),r={x:T.clientX,y:T.clientY},h){const{movementX:C,movementY:I}=T;l.position.x+=C,l.position.y+=I}},S=T=>{const{deltaY:m}=T;l.scale.x+m*.001>1||l.scale.x+m*.001<.5||(l.scale.x+=m*.001,l.scale.y+=m*.001)};document.addEventListener("mousedown",b),document.addEventListener("mouseup",k),document.addEventListener("mousemove",E),document.addEventListener("wheel",S);const P=(T,m)=>{const x=new qe(T,m),w=l.toGlobal(x),C=innerWidth*.5,I=innerHeight*.5,B=l.position.x-(w.x-C),L=l.position.y-(w.y-I),W={x:Math.floor(B),y:Math.floor(L)},A={x:Math.floor(l.position.x),y:Math.floor(l.position.y)},N=Math.sqrt(Math.pow(W.x-A.x,2)+Math.pow(W.y-A.y,2))>98;f&&f.progress(1),f=j.fromTo(A,{x:A.x,y:A.y},{x:W.x,y:W.y,duration:N?0:1,onUpdate:()=>{l.position.set(A.x,A.y),c.position.set(0,0),!g&&(g=j.delayedCall(d,()=>{g=void 0}),p==null||p.applyFogOfWarExceptAround(x))},onComplete:()=>{p==null||p.applyFogOfWarExceptAround(x),u={x:T,y:m}}})};return{view:i,moveTo:P,resize:(T,m)=>{v(T,m),P(u.x,u.y)},destroy:y,isDragging:()=>a}},Qi=s=>{const{viewModel:t}=s,e=new U,i=t.isAlive()?G.from(`${t.id()}.png`):G.from("corpse.png");let n={x:0,y:0};e.label=`${t.id()}-view`,e.eventMode="static";const o=()=>{i.width=50,i.height=50,i.anchor.set(.5,.5),i.skew.set(.5,0),i.position.set(32,32),e.addChild(i),e.position.set(t.position().x*64,t.position().y*64)};return e.on("pointertap",()=>{R.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})}),o(),{view:e,update:()=>{e.visible=t.visible(),!t.isAlive()&&!i.label.includes("corpse")&&(J.play("audio/sfx/death.mp3",{category:"gameplay"}),i.label=`${t.id()}-corpse`,i.texture=G.from("corpse.png").texture);const l=t.position();if(n.x!==l.x||n.y!==l.y){const c=n.x>l.x,a=n.x!==l.x;if(n={x:l.x,y:l.y},J.play("audio/sfx/step.mp3",{category:"gameplay"}),!a)return;c?(e.scale.x=1,e.pivot.x=0,i.skew.set(-.5,0),i.position.set(32,16)):(e.scale.x=-1,i.position.set(-32,16),i.skew.set(.5,0))}}}},Yi=s=>{const{viewModel:t}=s,e=new U;e.label=`${t.name()}-${t.id()}`;const i=G.from(`${t.id()}.png`);i.label=`${t.name()}-${t.id()}`,i.width=64,i.height=64;const n=G.from("cleared.png");n.width=64,n.height=64,n.label="discovered",n.visible=t.discovered(),n.position.set(-16,0);const o=G.from("loot-icon.png");return o.width=32,o.height=32,o.label="loot-available",o.tint="yellow",o.visible=t.discovered()&&!t.inventory().isEmpty(),o.position.set(i.width-o.width,i.height-o.height),e.addChild(i,n,o),e.skew.set(-.5,0),e.eventMode="static",e.on("pointertap",()=>{R.emit("ON_EVENT_INTERACTION",{eventViewModel:t})}),lt(()=>ct(()=>{e.visible=t.visible(),t.visible()&&t.discovered()&&(i.label.includes("visited")||(n.visible=!0,o.visible=!t.inventory().isEmpty()))}),e),{view:e}},Te={"bed-time":"task-bed-time",patrol:"magnifying-glass-icon",follow:"walking-icon",work:"coins-icon",idle:"task-idle",attack:"attack-icon"},Xi=s=>{const{cellSize:t,npcVMs:e}=s,i=new U,n=new Map;i.label="npc-task-view";const o=h=>{var g;const r=new U,f=new K,p=((g=h.getTask())==null?void 0:g.name())??"idle",u=G.from(`${Te[p]||"task-idle"}.png`);r.label=`task-icon-container-${h.id()}`,r.addChild(f,u),u.label=`task-${p}.png`,u.width=t/2,u.height=t/2,n.set(h,{icon:u,container:r,background:f}),f.circle(u.width/2,u.height/2,u.width/1.3),f.fill("khaki"),f.alpha=.75,i.addChild(r)},d=h=>{n.has(h)||o(h)},l=()=>{i.visible=!0},c=()=>{i.visible=!1},a=()=>{n.forEach((h,r)=>{var u;if(h.container.visible=r.visible()&&r.isAlive(),!r.isAlive()){i.removeChild(h.container),h.icon.destroy(),h.background.destroy(),h.container.destroy(),n.delete(r);return}const f=((u=r.getTask())==null?void 0:u.name())??"idle",p=Te[f]||"task-idle";h.icon.label!==`${p}.png`&&(h.icon.label=`${p}.png`,h.icon.texture=G.from(`${p}.png`).texture),h.container.position.set((r.position().x+.5)*s.cellSize-h.icon.width/2,r.position().y*s.cellSize-t*.6)})};return e.forEach(h=>{d(h)}),{view:i,show:l,hide:c,update:a,addNpc:d}},ke=new Array(5).fill(0),Ie=s=>{const{viewModel:t,onStep:e}=s,i=new U;let n=t.id();if(n==="bandit"){const a=Math.floor(Math.random()*5),h=ke.reduce((r,f,p,u)=>f<u[r]?p:r,a);n=`bandit-${h}`,ke[h]++,n=`bandit-${h}`}const o=t.isAlive()?G.from(`${n}.png`):G.from("corpse.png");o.label=t.isAlive()?`${t.id()}-sprite`:`${t.id()}-corpse-sprite`,i.label=`${t.name()}-view`,i.eventMode="static";const d=()=>{const a=t.size()*50;o.width=a,o.height=a,o.anchor.set(.5,.5),o.skew.set(-.5,0),o.position.set(32,32),i.addChild(o),i.position.set(t.position().x,t.position().y)};i.on("pointertap",()=>{R.emit("ON_CHARACTER_INTERACTION_REQUEST",{action:"open",character:t})}),d();let l={x:t.position().x,y:t.position().y};const c=()=>{if(!t.isAlive()&&!o.label.includes("corpse")){J.play("audio/sfx/death.mp3",{category:"gameplay"}),o.label=`${t.id()}-corpse-sprite`,o.texture=G.from("corpse.png").texture;return}};return lt(()=>{ct(()=>{i.visible=t.visible();const a=t.position();if(l.x!==a.x||l.y!==a.y){const h=l.x>a.x,r=l.x!==a.x;if(l={x:a.x,y:a.y},e(),!r)return;h?(i.scale.x=1,i.pivot.x=0,o.skew.set(-.5,0),o.position.set(32,16)):(i.scale.x=-1,o.position.set(-32,16),o.skew.set(.5,0))}})}),{view:i,update:c}},ji=({viewModel:s,onUnlocked:t})=>{const e=new U;e.label="settlement-view";const i=G.from(`${s.id()}.png`);let n=0,o=0;s.positions().forEach(l=>{l.x>=n&&(n=l.x),l.y>=o&&(o=l.y)}),i.width=(n-s.positions()[0].x+1)*64,i.height=(o-s.positions()[0].y+1)*64;const d=G.from("blocked.png");return d.width=i.width,d.height=i.height,d.visible=!s.isUnlocked(),e.addChild(i,d),e.eventMode="none",e.skew.set(-.5,0),lt(()=>{ct(()=>{e.visible=s.isVisible(),d.visible&&s.isUnlocked()&&t(),d.visible=!s.isUnlocked()})},e),{view:e}},Zi=(s,t,e)=>{s.alpha=0,j.to(s,{alpha:1,duration:t/1e3,onComplete:e})},Ki=(s,t,e)=>{j.to(s,{alpha:0,duration:t/1e3,onComplete:()=>{e()}})},Ji=s=>{const{tileSize:t,viewModel:e}=s,i=new U;let n=new G,o=new G;i.label="tile-view",i.eventMode="static";const d=e.type();let l=d;l==="wasteland"?l+=`-${Math.floor(Math.random()*2)}`:l==="forest"?l+=`-${Math.floor(Math.random()*2)}`:l==="settlement"&&(l="wasteland");const c=G.from(`${l}.png`);if(c.width=t,c.height=t,c.anchor.set(.5,.5),c.position.set(t/2,t/2),l==="settlement"&&(c.visible=!1),i.addChild(c),e.hasMud()){const a=G.from("mud.png");a.width=t*.6,a.height=t*.6,a.position.set(t*.2,t*.2),a.alpha=.6,i.addChild(a)}if(!e.traversable()&&d!=="mountain"){const a=Math.floor(Math.random()*6),h=["dead-trees-0","dead-trees-1","dead-trees-2","dead-trees-3","dead-trees-4","dead-trees-1"][a];n=G.from(`${h}.png`),n.width=t*1.2,n.height=t*1.2,n.skew.set(-.5,0)}if(e.hasGrass()){const a=G.from("dead-grass.png");a.width=t*.6,a.height=t*.6,a.alpha=1,a.skew.set(-.4,0),a.position.set(20,0),i.addChild(a)}if(e.hasEyes()){o=G.from("eyes.png"),o.width=t*.8,o.height=t*.8,o.skew.set(-.5,0),o.zIndex=o.position.y+32,o.alpha=0;const a=async()=>{await new Promise(h=>{setTimeout(()=>h(),(o.alpha===1?Math.random()*2e3:Math.random()*5e3)+2e3)}),o.alpha===0?Zi(o,1e3,a):Ki(o,1e3,a)};a()}return i.on("pointertap",()=>{R.emit("ON_TILE_INTERACTION",{tileViewModel:e})}),lt(()=>{ct(()=>{i.visible=e.visible(),o.visible=e.visible(),n.visible=e.visible()})},i),{view:i,trees:n,eyes:o}},tn=s=>{const{viewModel:t,tileSize:e}=s,i=new U;i.label="tile-map-view",i.sortableChildren=!0;const n=t.tiles(),o=[],d=[];return n.forEach((l,c)=>{l.forEach((a,h)=>{const r=Ji({tileSize:e,viewModel:a});r.view.label=`tile-${c}-${h}`,r.view.position.set(c*e,h*e),r.trees.position.set(r.view.position.x+20,r.view.position.y-20),r.eyes.position.set(r.view.x+32,r.view.y-20),o.push(r.trees),d.push(r.eyes),i.addChild(r.view)})}),{view:i,trees:o,eyes:d}},en=s=>{const{viewModel:t}=s,e=new U,i=[],n=64,o=new Map,d=f=>{const p=f.health(),u=f.maxHealth(),g=p/u,y=n*g,{x:v,y:b}=f.position();let k=o.get(f);k?k.clear():k=new K,k.clear(),k.rect(v*n,b*n-10,n,5),k.fill(0),k.rect(v*n,b*n-10,y,5),k.fill(65280),k.label=`${f.name()}-health-bar`,e.addChild(k),o.set(f,k),j.to(k,{alpha:0,duration:1,delay:1,onComplete:()=>{e.removeChild(k),k.destroy(),o.delete(f)}})},l=(f,p)=>({x:(f.x+p.x)/2,y:(f.y+p.y)/2}),c=f=>{if(e.destroyed)return;const p=f.position(),u=G.from("blood.png");u.width=n,u.height=n,u.position.set(p.x*n,p.y*n),e.addChild(u),f.armour()>0?(u.tint="blue",J.play("audio/sfx/collect.wav",{category:"gameplay"})):(J.play("audio/sfx/fists.mp3",{category:"gameplay"}),d(f)),j.to(u,{alpha:0,duration:.333,ease:"power2.inOut",onComplete:()=>{e.removeChild(u),u.destroy()}})},a=async({source:f,target:p})=>{const u=G.from("slash.png");u.scale.set(.15),u.anchor.set(.5),u.position.set(l(f.position(),p.position()).x*64+32,l(f.position(),p.position()).y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),u.alpha=0,await j.to(u,{alpha:1,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),c(p)},h=async({source:f,target:p})=>{const u=G.from("arrow.png");u.scale.set(.1),u.anchor.set(.5),u.position.set(f.position().x*64+32,f.position().y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),await j.to(u.position,{x:p.position().x*64+32,y:p.position().y*64+32,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),c(p)},r=async()=>{for(;i.length>0;){const f=i.shift();f&&await f()}};return lt(()=>{ct(()=>{const f=t.isAttacking();f&&(f.type==="ranged"?i.push(()=>h(f)):i.push(()=>a(f)))})}),{view:e,process:r}},nn=s=>{const{attackVM:t,tileMapVM:e,playerVM:i,tileSize:n,npcVMs:o,eventVMs:d,settlementVMs:l}=s,c=new U,a=new U,h=new U,r=new U,f=en({viewModel:t});a.label="game-view-container",h.label="tile-container",r.label="talk-overlay",a.sortableChildren=!0,h.zIndex=-1e3;const p=new Map,u=Xi({cellSize:n,npcVMs:o}),g=new Map;let y=null,v=null,b=[],k=[],E=[];const S=[];let P=!1;const _=A=>{const M=Ie({viewModel:A,onStep:()=>{A.position().distanceTo(i.position())<6&&J.play("audio/sfx/step.mp3",{category:"gameplay"})}});o.push(A),a.addChild(M.view),b.push(M)},T=()=>{v=tn({viewModel:e,tileSize:n}),v.view.label="tile-map-view",y=Qi({viewModel:i}),h.addChild(v.view),v.trees.forEach(A=>{a.addChild(A)}),v.eyes.forEach(A=>{a.addChild(A)}),d.map(A=>{const M=Yi({viewModel:A});k.push(M),a.addChild(M.view)}),b=o.map(A=>{const M=Ie({viewModel:A,onStep:()=>{A.position().distanceTo(i.position())<6&&J.play("audio/sfx/step.mp3",{category:"gameplay"})}});return a.addChild(M.view),M}),l.map(A=>{const M=ji({viewModel:A,onUnlocked:()=>{L("city-key",A.getMiddleTopPosition())}});E.push(M),a.addChild(M.view),M.view.label=`settlement-${A.id()}`,M.view.position.set(A.positions()[0].x*n+52,A.positions()[0].y*n-30),M.view.zIndex=M.view.y+32}),a.addChild(h,y.view,r,f.view)},m=()=>{P=!0,S.forEach(A=>A.kill()),v==null||v.view.destroy({children:!0}),y==null||y.view.destroy({children:!0}),r.removeChildren(),v=null,y=null,b.forEach(A=>A.view.destroy({children:!0})),b=[],k.forEach(A=>A.view.destroy({children:!0})),k=[],E.forEach(A=>A.view.destroy({children:!0})),E=[],p.clear(),a.destroy({children:!0})},x=["snow","lightskyblue","lime","yellow","fuchsia","orange"],w=()=>{const A=["snow","lightskyblue","lime","yellow","fuchsia","orange"];return x.length===0&&x.push(...A),x.splice(Math.floor(Math.random()*x.length),1)[0]},C=A=>{const{x:N,y:D}=A.position(),O=new _t;if(p.get(A.id()))return;O.style={fontFamily:"alagard",fontSize:32,fill:w(),align:"center",dropShadow:!0,stroke:"black",wordWrap:!0,wordWrapWidth:innerWidth*1.5},O.text=A.dialogue(),O.anchor.set(.5);let q=0;const Y=N*n+n/2,rt=D*n-n;O.position.set(Y,rt),p.forEach(V=>{O.getBounds().containsPoint(V.position.x,V.position.y)&&(q+=V.height),O.position.set(Y,rt-q)}),O.label="text-box",O.zIndex=11e3;const nt=a.toGlobal(O.position);return O.position.set(nt.x,nt.y),O.scale.set(.6),c.addChild(O),setTimeout(()=>{const V=p.get(A.id());V&&(a.removeChild(V),p.delete(A.id()),V.destroy())},2e3),p.set(A.id(),O),O},I=(A,M)=>{const{x:N,y:D}=M,O=N*n,z=D*n;S.push(j.to(A.view.position,{x:O,y:z,duration:.2,ease:"power2.inOut",onUpdate:()=>{A.view.zIndex=A.view.position.y},onComplete:()=>{A.view.position.set(O,z)}}))},B=async()=>{if(P)return;const{x:A,y:M}=i.position();y&&(y.update(),y.view.zIndex=y.view.position.y,(y.view.position.x!==A*n||y.view.position.y!==M*n)&&I(y,{x:A,y:M})),await f.process();for(const N of b){const D=b.indexOf(N),{x:O,y:z}=o[D].position();N.update(),(N.view.position.x!==O*n||N.view.position.y!==z*n)&&I(N,{x:O,y:z})}k.forEach((N,D)=>{const{x:O,y:z}=d[D].position();N.view.position.set(O*n+20,z*n-50),N.view.scale.set(1.5,1.5),N.view.zIndex=N.view.y+32}),u.update()},L=async(A,M)=>{const N=new U;N.label="looted-icon-container";const D=G.from(`${A}.png`);D.width=n/2,D.height=n/2;const O=new K;O.circle(n*.25,n*.25,n/2),O.fill("khaki"),N.addChild(O,D),N.zIndex=11e3,N.position.set((M.x+1)*n,M.y*n-n);const z=a.toGlobal(N.position);c.addChild(N),N.position.set(z.x,z.y),N.scale.set(.6);const q=g.get(`${{x:M.x,y:M.y}}`)??0;g.set(`${{x:M.x,y:M.y}}`,q+1),await j.delayedCall(.2*q,()=>{}),j.to(N.position,{y:N.position.y-n*4,duration:1,delay:q*.1,ease:"power2.inOut",onComplete:()=>{c.removeChild(N),N.destroy({children:!0});const Y=g.get(`${{x:M.x,y:M.y}}`)??0;Y>1?g.set(`${{x:M.x,y:M.y}}`,Y-1):g.delete(`${{x:M.x,y:M.y}}`)}})};T(),B(),a.skew.set(Math.PI/6,0),f.view.zIndex=11e3;const W=new K;return c.addChild(W),c.label="non-skewed-container",W.rect(0,0,innerWidth,innerHeight),W.fill("black"),W.alpha=0,{view:a,nonSkewedContainer:c,addNpc:_,animateIconFloat:L,handleEndOfTurnUpdates:B,createTextBox:C,destroy:m}};var te={},Et={},_e;function qt(){if(_e)return Et;_e=1,Object.defineProperty(Et,"__esModule",{value:!0}),Et.Collector=void 0;let s=class{constructor(e){this.emit=(...i)=>{e.emitCollecting(this,i)}}};return Et.Collector=s,Et}var St={},Me;function sn(){if(Me)return St;Me=1,Object.defineProperty(St,"__esModule",{value:!0}),St.CollectorArray=void 0;const s=qt();let t=class extends s.Collector{constructor(){super(...arguments),this.result=[]}handleResult(i){return this.result.push(i),!0}getResult(){return this.result}reset(){this.result.length=0}};return St.CollectorArray=t,St}var At={},Ee;function on(){if(Ee)return At;Ee=1,Object.defineProperty(At,"__esModule",{value:!0}),At.CollectorLast=void 0;const s=qt();let t=class extends s.Collector{handleResult(i){return this.result=i,!0}getResult(){return this.result}reset(){delete this.result}};return At.CollectorLast=t,At}var Pt={},Se;function rn(){if(Se)return Pt;Se=1,Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.CollectorUntil0=void 0;const s=qt();let t=class extends s.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,this.result}getResult(){return this.result}reset(){this.result=!1}};return Pt.CollectorUntil0=t,Pt}var Nt={},Ae;function an(){if(Ae)return Nt;Ae=1,Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.CollectorWhile0=void 0;const s=qt();let t=class extends s.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,!this.result}getResult(){return this.result}reset(){this.result=!1}};return Nt.CollectorWhile0=t,Nt}var Rt={},Vt={},Pe;function ln(){if(Pe)return Vt;Pe=1,Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.SignalConnectionImpl=void 0;class s{constructor(e,i){this.link=e,this.parentCleanup=i}disconnect(){return this.link!==null?(this.link.unlink(),this.link=null,this.parentCleanup(),this.parentCleanup=null,!0):!1}set enabled(e){this.link&&this.link.setEnabled(e)}get enabled(){return this.link!==null&&this.link.isEnabled()}}return Vt.SignalConnectionImpl=s,Vt}var Bt={},Ne;function cn(){if(Ne)return Bt;Ne=1,Object.defineProperty(Bt,"__esModule",{value:!0}),Bt.SignalLink=void 0;let s=class ei{constructor(e=null,i=null,n=0){this.enabled=!0,this.newLink=!1,this.callback=null,this.prev=e??this,this.next=i??this,this.order=n}isEnabled(){return this.enabled&&!this.newLink}setEnabled(e){this.enabled=e}unlink(){this.callback=null,this.next.prev=this.prev,this.prev.next=this.next}insert(e,i){let n=this.prev;for(;n!==this&&!(n.order<=i);)n=n.prev;const o=new ei(n,n.next,i);return o.callback=e,n.next=o,o.next.prev=o,o}};return Bt.SignalLink=s,Bt}var Re;function hn(){if(Re)return Rt;Re=1,Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.Signal=void 0;const s=ln(),t=cn();let e=class{constructor(){this.head=new t.SignalLink,this.hasNewLinks=!1,this.emitDepth=0,this.connectionsCount=0}getConnectionsCount(){return this.connectionsCount}hasConnections(){return this.connectionsCount>0}connect(n,o=0){this.connectionsCount++;const d=this.head.insert(n,o);return this.emitDepth>0&&(this.hasNewLinks=!0,d.newLink=!0),new s.SignalConnectionImpl(d,()=>this.decrementConnectionCount())}decrementConnectionCount(){this.connectionsCount--}disconnect(n){for(let o=this.head.next;o!==this.head;o=o.next)if(o.callback===n)return this.decrementConnectionCount(),o.unlink(),!0;return!1}disconnectAll(){for(;this.head.next!==this.head;)this.head.next.unlink();this.connectionsCount=0}emit(...n){this.emitDepth++;for(let o=this.head.next;o!==this.head;o=o.next)o.isEnabled()&&o.callback&&o.callback.apply(null,n);this.emitDepth--,this.unsetNewLink()}emitCollecting(n,o){this.emitDepth++;for(let d=this.head.next;d!==this.head;d=d.next)if(d.isEnabled()&&d.callback){const l=d.callback.apply(null,o);if(!n.handleResult(l))break}this.emitDepth--,this.unsetNewLink()}unsetNewLink(){if(this.hasNewLinks&&this.emitDepth===0){for(let n=this.head.next;n!==this.head;n=n.next)n.newLink=!1;this.hasNewLinks=!1}}};return Rt.Signal=e,Rt}var Lt={},Ve;function dn(){if(Ve)return Lt;Ve=1,Object.defineProperty(Lt,"__esModule",{value:!0}),Lt.SignalConnections=void 0;let s=class{constructor(){this.list=[]}add(e){this.list.push(e)}disconnectAll(){for(const e of this.list)e.disconnect();this.list=[]}getCount(){return this.list.length}isEmpty(){return this.list.length===0}};return Lt.SignalConnections=s,Lt}var Be;function un(){return Be||(Be=1,function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.SignalConnections=s.Signal=s.CollectorWhile0=s.CollectorUntil0=s.CollectorLast=s.CollectorArray=s.Collector=void 0;var t=qt();Object.defineProperty(s,"Collector",{enumerable:!0,get:function(){return t.Collector}});var e=sn();Object.defineProperty(s,"CollectorArray",{enumerable:!0,get:function(){return e.CollectorArray}});var i=on();Object.defineProperty(s,"CollectorLast",{enumerable:!0,get:function(){return i.CollectorLast}});var n=rn();Object.defineProperty(s,"CollectorUntil0",{enumerable:!0,get:function(){return n.CollectorUntil0}});var o=an();Object.defineProperty(s,"CollectorWhile0",{enumerable:!0,get:function(){return o.CollectorWhile0}});var d=hn();Object.defineProperty(s,"Signal",{enumerable:!0,get:function(){return d.Signal}});var l=dn();Object.defineProperty(s,"SignalConnections",{enumerable:!0,get:function(){return l.SignalConnections}})}(te)),te}var Le=un(),fn=Object.defineProperty,pn=(s,t,e)=>t in s?fn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ot=(s,t,e)=>pn(s,typeof t!="symbol"?t+"":t,e);class mn extends U{constructor(t){var e;super(),Ot(this,"options"),Ot(this,"view"),Ot(this,"_type"),Ot(this,"_maxWidth"),Ot(this,"children",[]),t&&(t.maxWidth&&(this._maxWidth=t.maxWidth),this.init(t)),(e=t==null?void 0:t.items)==null||e.forEach(i=>this.addChild(i)),this.on("added",()=>this.arrangeChildren()),this.on("childAdded",()=>this.arrangeChildren())}init(t){this.options=t,t!=null&&t.type&&(this.type=t.type),t!=null&&t.children&&t.children.forEach(e=>this.addChild(e))}set type(t){this._type=t,this.arrangeChildren()}get type(){return this._type}set elementsMargin(t){if(!this.options)throw new Error("List has not been initiated!");this.options.elementsMargin=t,this.arrangeChildren()}get elementsMargin(){var t;return((t=this.options)==null?void 0:t.elementsMargin)??0}set padding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.padding=t,this.options.vertPadding=t,this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get padding(){var t;return((t=this.options)==null?void 0:t.padding)??0}set vertPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.vertPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get vertPadding(){var t;return((t=this.options)==null?void 0:t.vertPadding)??this.padding??0}set horPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.arrangeChildren()}get horPadding(){var t;return((t=this.options)==null?void 0:t.horPadding)??this.padding??0}set leftPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.leftPadding=t,this.arrangeChildren()}get leftPadding(){var t;return((t=this.options)==null?void 0:t.leftPadding)??this.horPadding}set rightPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.rightPadding=t,this.arrangeChildren()}get rightPadding(){var t;return((t=this.options)==null?void 0:t.rightPadding)??this.horPadding}set topPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.topPadding=t,this.arrangeChildren()}get topPadding(){var t;return((t=this.options)==null?void 0:t.topPadding)??this.vertPadding}set bottomPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.bottomPadding=t,this.arrangeChildren()}get bottomPadding(){var t;return((t=this.options)==null?void 0:t.bottomPadding)??this.vertPadding}arrangeChildren(){var d,l;let t=0,e=this.leftPadding,i=this.topPadding;const n=((d=this.options)==null?void 0:d.elementsMargin)??0;let o=this.maxWidth??((l=this.parent)==null?void 0:l.width);this.rightPadding&&(o-=this.rightPadding),this.children.forEach((c,a)=>{switch(this.type){case"vertical":c.y=i,c.x=e,i+=n+c.height;break;case"horizontal":c.x=e,c.y=i,e+=n+c.width;break;case"bidirectional":default:c.x=e,c.y=i,c.x+c.width>o&&a>0&&(i+=n+t,e=this.leftPadding,c.x=e,c.y=i,t=0),t=Math.max(t,c.height),e+=n+c.width;break}})}removeItem(t){const e=this.children[t];e&&(this.removeChild(e),this.arrangeChildren())}set maxWidth(t){this._maxWidth=t,this.arrangeChildren()}get maxWidth(){return this._maxWidth}}var gn=Object.defineProperty,yn=(s,t,e)=>t in s?gn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Wt=(s,t,e)=>yn(s,typeof t!="symbol"?t+"":t,e);class vn{constructor(t={}){Wt(this,"x"),Wt(this,"ax"),Wt(this,"dx"),Wt(this,"tx"),Wt(this,"_options"),this.x=0,this.ax=0,this.dx=0,this.tx=0,this._options=t,this._options.max=t.max||160,this._options.damp=t.damp||.8,this._options.springiness=t.springiness||.1}update(){this.ax=(this.tx-this.x)*this._options.springiness,this.dx+=this.ax,this.dx*=this._options.damp,this.dx<-this._options.max?this.dx=-this._options.max:this.dx>this._options.max&&(this.dx=this._options.max),this.x+=this.dx}reset(){this.x=0,this.ax=0,this.dx=0,this.tx=0}get max(){return this._options.max}set max(t){this._options.max=t}get damp(){return this._options.damp}set damp(t){this._options.damp=t}get springiness(){return this._options.springiness}set springiness(t){this._options.springiness=t}}var wn=Object.defineProperty,xn=(s,t,e)=>t in s?wn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,It=(s,t,e)=>xn(s,typeof t!="symbol"?t+"":t,e);class bn{constructor(){It(this,"done"),It(this,"to"),It(this,"_spring"),It(this,"_pos"),It(this,"_speed"),It(this,"_correctSpeed"),this._spring=new vn,this._pos=0,this.to=0}start(t,e,i){this._speed=t,this._pos=e,this.to=i,this.done=!1,this._spring.x=this._pos,this._spring.tx=this.to;const n=this.to-this._pos,o=Math.abs(n)/n,d=Math.abs(this._speed)/this._speed;o!==d?this._correctSpeed=!0:this._correctSpeed=!1}update(){if(this._correctSpeed)this._speed*=.6,Math.abs(this._speed)<2&&(this._correctSpeed=!1),this._pos+=this._speed,this._spring.x=this._pos;else{const t=this.to-this._pos;Math.abs(t)<.05?(this._pos=this.to,this.done=!0):(this._spring.tx=this.to,this._spring.update(),this._pos=this._spring.x)}return this._pos}cancel(){}}var Cn=Object.defineProperty,Tn=(s,t,e)=>t in s?Cn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ht=(s,t,e)=>Tn(s,typeof t!="symbol"?t+"":t,e);class Oe{constructor(t={}){ht(this,"position",0),ht(this,"constrain",!0),ht(this,"min",0),ht(this,"max",0),ht(this,"maxSpeed",400),ht(this,"_ease"),ht(this,"_offset",0),ht(this,"_prev",0),ht(this,"_speed",0),ht(this,"_hasStopped"),ht(this,"_targetSpeed",0),ht(this,"_speedChecker",0),ht(this,"_grab",0),ht(this,"_activeEase"),this.constrain=t.constrain??!0,this.maxSpeed=t.maxSpeed??400,this._ease=t.ease??new bn}set value(t){this._speed=0,this.position=t}get value(){return this.position}grab(t){this._grab=t,this._offset=this.position-t,this._speedChecker=0,this._targetSpeed=this._speed=0,this._hasStopped=!1}hold(t){this._speedChecker++,this.position=t+this._offset,this._speedChecker>1&&(this._targetSpeed=this.position-this._prev),this._speed+=(this._targetSpeed-this._speed)/2,this._speed>this.maxSpeed?this._speed=this.maxSpeed:this._speed<-this.maxSpeed&&(this._speed=-this.maxSpeed),this._prev=this.position,this.constrain&&(this._activeEase=null,this.position>this.min?this.position-=(this.position-this.min)/1.5:this.position<this.max&&(this.position+=(this.max-this.position)/1.5))}slide(t=!1){this._hasStopped||(this.constrain?this._updateConstrain(t):this._updateDefault())}get moveAmount(){return-(this.position-this._offset-this._grab)}_updateDefault(){this._speed*=.9,this.position+=this._speed,(this._speed<0?this._speed*-1:this._speed)<.01&&(this._hasStopped=!0)}_updateConstrain(t=!1){const e=this.max;t?(this.value>0&&(this.value=0),this.value>0&&(this.value=0),this.value<this.max&&(this.value=this.max),this.value<this.max&&(this.value=this.max)):this.position>this.min||this.position<e||this._activeEase?(this._activeEase||(this._activeEase=this._ease,this.position>this.min?this._activeEase.start(this._speed,this.position,this.min):this._activeEase.start(this._speed,this.position,e)),this.position=this._activeEase.update(),this._activeEase.done&&(this.position=this._activeEase.to,this._speed=0,this._activeEase=null)):this._updateDefault()}}var kn=Object.defineProperty,In=(s,t,e)=>t in s?kn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,xt=(s,t,e)=>In(s,typeof t!="symbol"?t+"":t,e);class _n{constructor(t){xt(this,"xAxis"),xt(this,"yAxis"),xt(this,"_isDown"),xt(this,"_globalPosition"),xt(this,"_frame"),xt(this,"_bounds"),xt(this,"_dirty"),xt(this,"disableEasing",!1),this.xAxis=new Oe({ease:t.xEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.yAxis=new Oe({ease:t.yEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.disableEasing=t.disableEasing??!1,this._frame=new ie,this._bounds=new ie,this._globalPosition=new qe}pointerDown(t){this._globalPosition=t,this.xAxis.grab(t.x),this.yAxis.grab(t.y),this._isDown=!0}pointerUp(){this._isDown=!1}pointerMove(t){this._globalPosition=t}update(){this._dirty&&(this._dirty=!1,this.xAxis.min=this._bounds.left,this.xAxis.min=this._bounds.right-this._frame.width,this.xAxis.min=this._bounds.top,this.xAxis.min=this._bounds.bottom-this._frame.height),this._isDown?(this.xAxis.hold(this._globalPosition.x),this.yAxis.hold(this._globalPosition.y)):(this.xAxis.slide(this.disableEasing),this.yAxis.slide(this.disableEasing))}resize(t,e){this._frame.x=0,this._frame.width=t,this._frame.y=0,this._frame.height=e,this._dirty=!0}setBounds(t,e,i,n){this._bounds.x=t,this._bounds.width=e-t,this._bounds.y=i,this._bounds.height=n-i,this._dirty=!0}get x(){return this.xAxis.value}get y(){return this.yAxis.value}}var Mn=Object.defineProperty,En=(s,t,e)=>t in s?Mn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Z=(s,t,e)=>En(s,typeof t!="symbol"?t+"":t,e);class ce extends U{constructor(t){super(),Z(this,"background"),Z(this,"borderMask"),Z(this,"lastWidth"),Z(this,"lastHeight"),Z(this,"_width",0),Z(this,"_height",0),Z(this,"_dimensionChanged",!1),Z(this,"list"),Z(this,"_trackpad"),Z(this,"isDragging",0),Z(this,"interactiveStorage",[]),Z(this,"visibleItems",[]),Z(this,"pressedChild"),Z(this,"ticker",ri.shared),Z(this,"options"),Z(this,"stopRenderHiddenItemsTimeout"),Z(this,"onMouseScrollBinding",this.onMouseScroll.bind(this)),Z(this,"dragStarTouchPoint"),Z(this,"isOver",!1),Z(this,"proximityRange"),Z(this,"proximityStatusCache",[]),Z(this,"lastScrollX"),Z(this,"lastScrollY"),Z(this,"proximityCheckFrameCounter",0),Z(this,"onProximityChange",new Le.Signal),Z(this,"onScroll",new Le.Signal),t&&this.init(t),this.ticker.add(this.update,this)}init(t){this.options=t,this.setBackground(t.background),this._width=t.width|this.background.width,this._height=t.height|this.background.height,this.proximityRange=t.proximityRange??0,this.list||(this.list=new mn,super.addChild(this.list)),this.list.init({type:t.type,elementsMargin:t.elementsMargin,padding:t.padding,vertPadding:t.vertPadding,horPadding:t.horPadding,topPadding:t.topPadding,bottomPadding:t.bottomPadding,leftPadding:t.leftPadding,rightPadding:t.rightPadding}),this.addItems(t.items),this.hasBounds&&(this.addMask(),this.makeScrollable()),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.options.globalScroll=t.globalScroll??!0,this.options.shiftScroll=t.shiftScroll??!1,this.resize()}get hasBounds(){return!!this._width||!!this._height}addItems(t){t!=null&&t.length&&t.forEach(e=>this.addItem(e))}removeItems(){this.proximityStatusCache.length=0,this.list.removeChildren()}addItem(...t){if(t.length>1)t.forEach(e=>this.addItem(e));else{const e=t[0];(!e.width||!e.height)&&console.error("ScrollBox item should have size"),e.eventMode="static",this.list.addChild(e),this.proximityStatusCache.push(!1),this.options.disableDynamicRendering||(e.renderable=this.isItemVisible(e))}return this.resize(),t[0]}removeItem(t){this.list.removeItem(t),this.proximityStatusCache.splice(t,1),this.resize()}isItemVisible(t,e=0){let i=!1;const n=this.list;if(this.isVertical||this.isBidirectional){const o=t.y+n.y;o+t.height>=-e&&o<=this.options.height+e&&(i=!0)}if(this.isHorizontal||this.isBidirectional){const o=t.x+n.x;o+t.width>=-e&&o<=this.options.width+e&&(i=!0)}return i}get items(){var t;return((t=this.list)==null?void 0:t.children)??[]}setBackground(t){this.background&&this.removeChild(this.background),this.options.background=t,this.background=new K,this.addChildAt(this.background,0),this.resize()}addMask(){this.borderMask||(this.borderMask=new K,super.addChild(this.borderMask),this.mask=this.borderMask),this.resize()}makeScrollable(){this._trackpad||(this._trackpad=new _n({disableEasing:this.options.disableEasing})),this.on("pointerdown",t=>{this.renderAllItems(),this.isDragging=1,this.dragStarTouchPoint=this.worldTransform.applyInverse(t.global),this._trackpad.pointerDown(this.dragStarTouchPoint);const e=this.list.worldTransform.applyInverse(t.global);this.visibleItems.forEach(i=>{i.x<e.x&&i.x+i.width>e.x&&i.y<e.y&&i.y+i.height>e.y&&(this.pressedChild=i)})}),this.on("pointerup",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("pointerover",()=>{this.isOver=!0}),this.on("pointerout",()=>{this.isOver=!1}),this.on("pointerupoutside",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("globalpointermove",t=>{var i,n;if(!this.isDragging)return;const e=this.worldTransform.applyInverse(t.global);if(this.dragStarTouchPoint){const o=this.options.dragTrashHold??10;if(this.isHorizontal||this.isBidirectional){const d=e.x-this.dragStarTouchPoint.x;Math.abs(d)>o&&(this.isDragging=2)}if(this.isVertical||this.isBidirectional){const d=e.y-this.dragStarTouchPoint.y;Math.abs(d)>o&&(this.isDragging=2)}}this.dragStarTouchPoint&&this.isDragging!==2||(this._trackpad.pointerMove(e),this.pressedChild&&(this.revertClick(this.pressedChild),this.pressedChild=null),this.isBidirectional?(i=this.onScroll)==null||i.emit({x:this.scrollX,y:this.scrollY}):(n=this.onScroll)==null||n.emit(this.isVertical?this.scrollY:this.scrollX))}),document.addEventListener("wheel",this.onMouseScrollBinding,!0)}setInteractive(t){this.eventMode=t?"static":"auto"}get listHeight(){return this.list.height+this.list.topPadding+this.list.bottomPadding}get listWidth(){return this.list.width+this.list.leftPadding+this.list.rightPadding}resize(t=!1){if(this.hasBounds){if(this.renderAllItems(),this.borderMask&&(t||this._dimensionChanged||this.lastWidth!==this.listWidth||this.lastHeight!==this.listHeight)){this.options.width||(this._width+=this.listWidth),this.options.height||(this._height+=this.listHeight),this.borderMask.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill(16711935).stroke(0),this.borderMask.eventMode="none";const e=this.options.background;this.background.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill({color:e??0,alpha:e?1:1e-7}),this.isBidirectional?this.setInteractive(this.listWidth>this._width||this.listHeight>this._height):this.isHorizontal?this.setInteractive(this.listWidth>this._width):this.setInteractive(this.listHeight>this._height),this.lastWidth=this.listWidth,this.lastHeight=this.listHeight}if(this._trackpad){const e=this.borderMask.width-this.list.width-this.list.leftPadding-this.list.rightPadding,i=this.borderMask.height-this.list.height-this.list.topPadding-this.list.bottomPadding;this.isBidirectional?(this._trackpad.yAxis.max=-Math.abs(i),this._trackpad.xAxis.max=-Math.abs(e)):this.isVertical?this._trackpad.yAxis.max=-Math.abs(i):this.isHorizontal&&(this._trackpad.xAxis.max=-Math.abs(e))}this._dimensionChanged?(this.list.arrangeChildren(),this.stopRenderHiddenItems(),this._dimensionChanged=!1):(t&&this.list.arrangeChildren(),this.updateVisibleItems()),this.lastScrollX=null,this.lastScrollY=null}}onMouseScroll(t){var o,d,l;if(!this.isOver&&!this.options.globalScroll)return;this.renderAllItems();const e=!!this.options.shiftScroll,i=e?typeof t.deltaX<"u"||typeof t.deltaY<"u":typeof t.deltaX<"u",n=typeof t.deltaY<"u";if((this.isHorizontal||this.isBidirectional)&&i){const c=e||this.isBidirectional?t.deltaX:t.deltaY,a=this.list.x-c;if(this.listWidth<this._width)this._trackpad.xAxis.value=0;else{const h=this._width-this.listWidth,r=0;this._trackpad.xAxis.value=Math.min(r,Math.max(h,a))}}if((this.isVertical||this.isBidirectional)&&n){const c=this.list.y-t.deltaY;if(this.listHeight<this._height)this._trackpad.yAxis.value=0;else{const a=this._height-this.listHeight,h=0;this._trackpad.yAxis.value=Math.min(h,Math.max(a,c))}}this.isBidirectional&&(i||n)?(o=this.onScroll)==null||o.emit({x:this._trackpad.xAxis.value,y:this._trackpad.yAxis.value}):this.isHorizontal&&i?(d=this.onScroll)==null||d.emit(this._trackpad.xAxis.value):this.isVertical&&n&&((l=this.onScroll)==null||l.emit(this._trackpad.yAxis.value)),this.stopRenderHiddenItems()}scrollBottom(){this.interactive?this.scrollTo(this.list.children.length-1):this.scrollTop()}scrollTop(){this.renderAllItems(),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.stopRenderHiddenItems()}renderAllItems(){clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null,!this.options.disableDynamicRendering&&this.items.forEach(t=>{t.renderable=!0})}stopRenderHiddenItems(){this.options.disableDynamicRendering||(this.stopRenderHiddenItemsTimeout&&(clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null),this.stopRenderHiddenItemsTimeout=setTimeout(()=>this.updateVisibleItems(),2e3))}updateVisibleItems(){this.visibleItems.length=0,this.items.forEach(t=>{t.renderable=this.isItemVisible(t),this.visibleItems.push(t)})}scrollTo(t){if(!this.interactive)return;const e=this.list.children[t];e&&(this.renderAllItems(),this._trackpad.xAxis.value=this.isHorizontal||this.isBidirectional?this._width-e.x-e.width-this.list.rightPadding:0,this._trackpad.yAxis.value=this.isVertical||this.isBidirectional?this._height-e.y-e.height-this.list.bottomPadding:0,this.stopRenderHiddenItems())}scrollToPosition({x:t,y:e}){t===void 0&&e===void 0||(this.renderAllItems(),t!==void 0&&(this.scrollX=-t),e!==void 0&&(this.scrollY=-e),this.stopRenderHiddenItems())}get height(){return this._height}set height(t){this._height=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}get width(){return this._width}set width(t){this._width=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}setSize(t,e){typeof t=="object"?(e=t.height??t.width,t=t.width):e=e??t,this._width=t,this._height=e,this._dimensionChanged=!0,this.resize(),this.scrollTop()}getSize(t){return t=t||{width:0,height:0},t.width=this._width,t.height=this._height,t}get scrollX(){return this._trackpad.xAxis.value}set scrollX(t){this._trackpad.xAxis.value=t}get scrollY(){return this._trackpad.yAxis.value}set scrollY(t){this._trackpad.yAxis.value=t}update(){this.list&&(this._trackpad.update(),(this.isHorizontal||this.isBidirectional)&&this.list.x!==this._trackpad.x&&(this.list.x=this._trackpad.x),(this.isVertical||this.isBidirectional)&&this.list.y!==this._trackpad.y&&(this.list.y=this._trackpad.y),!this.options.disableProximityCheck&&(this._trackpad.x!==this.lastScrollX||this._trackpad.y!==this.lastScrollY)&&(this.proximityCheckFrameCounter++,this.proximityCheckFrameCounter>=(this.options.proximityDebounce??10)&&(this.items.forEach((t,e)=>{const i=this.isItemVisible(t,this.proximityRange),n=this.proximityStatusCache[e];i!==n&&(this.proximityStatusCache[e]=i,this.onProximityChange.emit({item:t,index:e,inRange:i}))}),this.lastScrollX=this._trackpad.x,this.lastScrollY=this._trackpad.y,this.proximityCheckFrameCounter=0)))}destroy(t){this.ticker.remove(this.update,this),document.removeEventListener("wheel",this.onMouseScrollBinding,!0),this.background.destroy(),this.list.destroy(),super.destroy(t)}restoreItemsInteractivity(){this.interactiveStorage.forEach(t=>{t.item.eventMode=t.eventMode}),this.interactiveStorage.length=0}revertClick(t){t.eventMode!=="auto"&&(ai.any?t.emit("pointerupoutside",null):t.emit("mouseupoutside",null),this.interactiveStorage.push({item:t,eventMode:t.eventMode}),t.eventMode="auto"),t instanceof U&&t.children&&t.children.forEach(e=>this.revertClick(e))}get scrollHeight(){return this.list.height}get scrollWidth(){return this.list.width}get isVertical(){return(this.options.type??"vertical")==="vertical"}get isHorizontal(){return this.options.type==="horizontal"}get isBidirectional(){return this.options.type==="bidirectional"}}const Sn=()=>{const s=document.createElement("canvas");s.width=256,s.height=1;const t=s.getContext("2d"),e=t.createLinearGradient(0,0,s.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,s.width,1),$e.from(s)},We=(s,t)=>{const e=new U,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},n=new _t,o=new K;n.text=s,n.style=i;const d=()=>{o.clear(),o.roundRect(n.x-10,n.y,n.width+20,n.height,10),o.fill("black"),o.alpha=.5};e.addChild(o,n);const l=c=>{n.text=c,d()};return d(),{view:e,updateText:l}},An=s=>{const t=Sn(),e=new G(t);return e.label="gradient-background",e.position.set(s.x,s.y-2.5),e.width=s.width+16,e.height=s.height+5,s.addChildAt(e,0),e},Ut=s=>{const{viewModel:t,includeItemValue:e,quantity:i}=s,n=s.itemValue,o=new U;let d=!1;o.label=`${t.name()}-view`,o.eventMode="static";const l=G.from(`${t.code()}.png`);l.width=50,l.height=50,o.addChild(l);const c=We(`${(i==null?void 0:i.toString())??t.quantity().toString()}`);c.view.position.set(l.width-c.view.width*.5,l.height);let a=null;e&&(a=We(`$ ${(n||t.value()).toString()}`,{fill:"gold"}),a.view.position.set(l.width-a.view.width*.5,0),o.addChild(a.view),l.position.set(0,a.view.height+5),c.view.position.set(l.width-c.view.width*.5,a.view.height+l.height));const h=l.y+l.height,r=(y,v)=>{const b=new U;return v()<=0||(d=!0,Array(v()).fill(0).forEach((k,E)=>{const S=G.from(`${y}-icon.png`);S.width=20,S.height=20,S.position.set(2.5+E*S.width*.5,0),b.addChildAt(S,0)}),An(b),b.position.set(0,h-b.height+14),o.addChild(b)),b};t.isArmourIconVisible()&&r("armour",t.armour);const f=new U;if(t.isHealthIconVisible()&&r("health",t.health),t.isDamageIconVisible()&&t.damage()>0&&t.range()>0){const y=r("damage",t.damage),v=r("range",t.range);v.position.set(y.x,y.y-v.height)}const p=G.from("armour-broken-icon.png");p.width=20,p.height=20,p.position.set(0,l.height-p.height),o.addChild(c.view,p,f),o.on("pointertap",()=>{u()}),d&&l.position.set(16,l.y);const u=()=>{t.interact(),J.play("audio/sfx/collect.wav",{category:"gameplay"})},g=lt(()=>{ct(()=>{c.updateText((i==null?void 0:i.toString())??t.quantity().toString()),p.visible=t.maxArmour()>0&&t.armour()<=0})});return o.on("destroy",()=>{g()}),{view:o,interact:u}},Pn=(s,t)=>{const i=new K;return i.roundRect(-2.5,-2.5,s.view.width+2.5*2,s.view.height+2.5,10),i.fill(t??"gray"),i.alpha=.8,i.eventMode="static",i},zt=(s,t)=>{const e=new U;e.addChild(s.view),e.label=`${s.view.label}-container`,e.eventMode="static";const i=Pn(s,t);return e.addChild(i,s.view),{container:e,background:i}},Nn=s=>{const t=new U,e=10;let i;t.label="global-inventory-view",t.eventMode="static";const n=Yt({text:s.ownerName(),fontSize:26,disableBackground:!0}),o=G.from("text-background.png"),d=G.from("text-background.png"),l=new K;t.addChild(o,d,n,l);const c=()=>{o.width=h.width,o.height=n.height,d.width=h.width,d.height=y.height*1.3,d.position.set(0,h.height+y.height*1.6),l.clear(),l.label="title-background-stroke",l.rect(o.x,o.y,o.width,o.height),l.rect(d.x,d.y,d.width,d.height),l.stroke({color:"khaki",width:2})},a=innerWidth<innerHeight,h=new ce({width:a?innerWidth:innerWidth*.8,height:a?innerHeight*.6:innerHeight*.8,padding:e,radius:10,elementsMargin:e}),r=ft({spriteName:"eye-icon",onClick:()=>{s.setInfoButtonEnabled(!s.isInfoButtonEnabled()),r.tint=s.isInfoButtonEnabled()?"lightgreen":"white"},disableFlicker:!0});t.addChild(r),h.label="global-inventory-scroll-box",h.position.set(0,n.height+e),t.addChild(h),t.visible=!1;const f=(b,k)=>k.weapon().id()===b.id()||k.bodyArmour().id()===b.id()||k.headArmour().id()===b.id()||k.feetArmour().id()===b.id(),p=b=>{b=b??!1,h.removeItems();const k=1.5;s.stacks().forEach(E=>{const S=Ut({viewModel:E.item,includeItemValue:b,quantity:E.quantity}),P=new U,_=s.owner?f(E.item,s.owner):!1,T=zt(S,_?"lightgreen":"gray");P.on("pointertap",()=>{x()}),P.addChild(T.background,T.container),P.label=`${S.view.label}-container`,h.addItem(P);const m=Math.min(k,Math.min((h.width-e*2)/P.width,(h.height-e*2)/P.height));P.scale.set(m),S.view.off("pointertap");const x=()=>{if(s.isInfoButtonEnabled()){i&&(t.removeChild(i),i=void 0),i=Ge({title:E.item.name(),content:E.item.description(),type:E.item.type(),onClose:()=>{t.removeChild(i),i=void 0}}),i.position.set(t.width*.5,t.height*.5),t.addChild(i);return}S.interact();const w=P.tint;P.tint="green",setTimeout(()=>{P.tint=w},200)}})},u=(b=!1)=>{p(b),s.setInfoButtonEnabled(!1),J.play("audio/sfx/inventory-open.wav",{category:"gameplay"}),t.visible=!0},g=()=>{s.setInfoButtonEnabled(!1),R.emit("ON_CLOSE_INVENTORY_REQUESTED")},y=ft({spriteName:"exit-icon",onClick:()=>{s.setInfoButtonEnabled(!1),R.emit("ON_CLOSE_INVENTORY_REQUESTED")}});if(n.position.set(t.width*.5,n.height*.5),y.position.set(h.width-y.width,h.height+y.height*2),r.position.set(y.position.x-r.width-5,y.position.y),t.addChild(y),s.ownerName()!=="Hero"){const b=ft({spriteName:"take-all-icon",onClick:()=>{s.items().forEach(k=>{k.interact()}),J.play("audio/sfx/inventory-open.wav",{category:"gameplay"})},onClickAudio:""});b.position.set(b.width*.4,y.y),t.addChild(b)}const v=Math.max(.6,Math.min(innerWidth/t.width,innerHeight/t.height));return t.scale.set(Math.min(.6,v)),lt(()=>{ct(()=>{s.isEmpty()&&g(),s.isInfoButtonEnabled()||i&&(t.removeChild(i),i=void 0),p(),n.position.set(h.width*.5,n.height*.5),y.position.set(h.width-y.width,h.height+y.height*2),r.position.set(y.position.x-r.width-5,y.position.y),c()})},t),{view:t,show:u,hide:g}},Rn=s=>{const{viewModel:t}=s,e=new U;e.label="new-trade-view",e.alpha=0;const i=new K;i.label="new-trade-view-background",e.addChild(i);const n=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let o=!1;const d=({title:T,stacks:m,width:x,height:w,playerStacks:C,npcInv:I=!1,includeItemValue:B=!1,isTradeInv:L=!1})=>{const W=new U;W.label=`${T}-screen-view`;const A=G.from("text-background.png");A.label=`${T}-title-background`;const M=new K;M.label=`${T}-title-background-outline`;const N=Yt({text:T,disableBackground:!0,onClick:()=>{}});N.label=`${T}-title-button`;const D=new ce({width:x,height:w,padding:4,elementsMargin:2});D.label=`${T}-inventory-view`;const O=new K;O.label=`${T}-background`,W.addChild(O,A,N,D,M);const z=(q,Y,rt)=>{const nt=innerHeight>innerWidth;q.forEach(V=>{const $=Ut({viewModel:V.item,includeItemValue:B,itemValue:t.getItemPrice(V.item,rt),quantity:V.quantity}),tt=zt($,Y==="buy"||Y==="buy-return"?"pink":"lightblue"),et=new U;$.view.off("pointertap"),et.on("pointertap",()=>{Jt(),R.emit("ON_ITEM_INTERACTION",{itemViewModel:V.item,action:Y}),o=!0}),et.addChild(tt.container,$.view),et.label=`${$.view.label}-container`,D.addItem(et);const at=nt?.6:.7;et.scale.set(Math.min(at,x/($.view.width+10)),Math.min(at,w/($.view.height+10)));const Jt=()=>{et.tint=65280,setTimeout(()=>{et.tint=16777215},200)}})};return I?z(m,"buy",!0):L?(z(C||[],"sell-return",!1),z(m,"buy-return",!0)):z(m,"sell",!1),N.scale.set(.4),N.position.set(x*.5,N.height*.5),D.position.set(x*.5-D.width*.5,N.height+10),A.x=D.width*.025,A.width=D.width*.95,A.height=N.height,M.rect(A.x,0,A.width,A.height),M.stroke({color:"khaki",width:2}),O.rect(0,0,W.width,W.height),O.label=`${T}-background-rect`,O.fill("black"),O.stroke("black"),W};let l=null,c=null,a=null,h=null,r=null,f=null,p=null,u=null,g=null,y=null;const v=G.from("text-background.png");v.label="trade-buttons-container-background";const b=new K;b.label="trade-buttons-container-background-outline";const k=()=>{l||c?S():J.play("audio/sfx/door.mp3");const{innerWidth:T,innerHeight:m}=window,x=m>T,w=x?T:T*.9*.3,C=x?m*.7*.3:m*.9;n(),r=ft({spriteName:"trade-icon",onClick:()=>{R.emit("ON_TRADE_REQUEST",{action:"autoTrade"}),o=!0},alpha:.8}),h=ft({spriteName:"exit-icon",onClick:()=>{R.emit("ON_CLOSE_INVENTORY_REQUESTED"),o=!0},alpha:.8});const I=()=>{y&&(e.removeChild(y),y.destroy(),y=null)},B=()=>{const A=Math.abs(t.value().quantity()),M=t.value().quantity()<0?{type:"Insufficient Funds",content:"You do not have enough funds to complete this trade."}:{type:"Trade Imbalance",content:`Trader has insufficient funds, you will lose ${A} ${A>1?"coins":"coin"}.`};y=Ge({title:"Confirm Trade",type:M.type,content:M.content,onConfirm:t.value().quantity()>0?()=>{R.emit("ON_TRADE_REQUEST",{action:"submit"}),o=!0,I()}:void 0,onCancel:()=>{R.emit("ON_TRADE_REQUEST",{action:"clear"}),I(),o=!0}}),e.addChild(y),y.position.set(e.width*.5-y.width*.25,e.height*.5-y.height*.5)};f=ft({spriteName:"confirm-icon",onClick:()=>{R.emit("ON_TRADE_REQUEST",{action:"submit"}),o=!0},alpha:.8}),p=ft({spriteName:"cancel-icon",onClick:()=>{if(t.npcTradeItems().isEmpty()&&t.playerTradeItems().isEmpty()){R.emit("ON_CLOSE_INVENTORY_REQUESTED"),o=!0;return}R.emit("ON_TRADE_REQUEST",{action:"clear"}),o=!0},alpha:.8});let L="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?L="green":t.value().quantity()>0?L="yellow":L="red");const W=Ut({viewModel:t.value()});g=zt(W,L).container,u=new U,u.label="trade-buttons-container",u.addChild(h,f,p,r),e.addChild(v,u,b),l=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:w,height:C,includeItemValue:!0,isTradeInv:!1}),e.addChild(l),l.label="player-trade-screen",c=d({title:"Trader",stacks:t.npcInventory().stacks(),width:w,height:C,npcInv:!0,includeItemValue:!0,isTradeInv:!1}),e.addChild(c),c.label="npc-trade-screen",a=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:w,height:C,includeItemValue:!0,isTradeInv:!0}),e.addChild(a),e.alpha=1,a.label="trade-screen",t.isConfirmationModalVisible()&&B()},E=(T=!1)=>{!u||!h||(b.clear(),T?(v.angle=90,v.height=h.height*1.4,v.width=u.height,v.position.set(u.x+v.height,u.y-h.height*.2-5),b.rect(v.x-v.height,v.y,v.height,v.width)):(v.angle=0,v.width=u.width,v.height=h.height*1.4,v.position.set(u.x-17,u.y+5),b.rect(v.x,v.y,v.width,v.height)),b.stroke({color:"khaki",width:2}))},S=()=>{l&&(e.removeChild(l),l.destroy(),l=null),c&&(e.removeChild(c),c.destroy(),c=null),a&&(e.removeChild(a),a.destroy(),a=null),h&&(e.removeChild(h),h.destroy(),h=null),f&&(e.removeChild(f),f.destroy(),f=null),p&&(e.removeChild(p),p.destroy(),p=null),r&&(e.removeChild(r),r.destroy(),r=null),u&&(e.removeChild(u),u.destroy(),u=null),g&&(e.removeChild(g),g.destroy(),g=null),y&&(e.removeChild(y),y.destroy(),y=null),e.alpha=0},P=(T,m)=>{if(e.alpha===0||!l||!c||!a)return;if(m>T){if(l.position.set(0,0),a.position.set(0,l.y+l.height+2),c.position.set(0,a.position.y+a.height+2),u){const w=T-20,C=u.children,I=C.reduce((W,A)=>W+A.width,0)+((g==null?void 0:g.width)??0),B=Math.min(30,C.length>1?(w-I)/C.length:0);let L=0;C.forEach(W=>{W.position.set(L,W.height*.5),L+=W.width+B}),g&&(u.addChild(g),g.position.set(u.width,g.height*.2)),u.position.set(T*.5-u.width*.5+15,c.position.y+c.height),E()}}else if(l.position.set(0,0),a.position.set(2+l.position.x+l.width,0),c.position.set(2+a.position.x+a.width,0),u){const w=m-20,C=u.children,I=C.reduce((W,A)=>W+A.height,0)+((g==null?void 0:g.height)??0),B=Math.min(30,C.length>1?(w-I)/C.length:0);let L=0;C.forEach(W=>{W.position.set(W.width*.5,L),L+=W.height+B}),g&&(u.addChild(g),g.position.set(g.width*.35,u.height-10)),u.position.set(c.position.x+c.width,m*.5-u.height*.5+20),E(!0)}};return{view:e,show:k,hide:S,resize:P,update:()=>{!o&&!t.isAutoTrading()||(o=!1,e.alpha!==0&&(k(),P(innerWidth,innerHeight)))}}},Vn=s=>{const{viewModel:t}=s,e=new U,i=[],n=new U;e.addChild(n),n.label="icons-container",e.visible=t.isVisible();const o=new K;o.rect(0,0,innerWidth,64),o.fill("black"),o.alpha=0,e.addChild(o);const d=[],l=()=>{n.removeChildren(),n.destroy({children:!0}),o.destroy(),e.removeChildren(),e.destroy({children:!0}),d.forEach(_=>_.kill())},c=_=>{const T=new U;T.label=`${_}-icon`,T.eventMode="static";const m=new K;m.circle(0,0,32),m.stroke({color:"khaki",width:4}),m.fill("khaki"),m.alpha=.5,T.addChild(m);const x=G.from(`${_}-icon.png`);return x.anchor.set(.5),x.width=32,x.height=32,i.push(T),T.addChild(x),n.addChild(T),T},a=c("city-key");a.on("pointertap",()=>{const _=t.canUnlockSettlement();_&&(J.play("audio/sfx/sfx-unlock.wav"),R.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:_,action:"unlock"}))});const h=c("talk");h.on("pointertap",()=>{J.play("audio/sfx/click.wav"),R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:t.canInteractWithCharacter()??void 0,action:"talk"})}),h.visible=t.canInteractWithCharacter()!==null;const r=c("trade");r.on("pointertap",()=>{const _=t.canTradeWithCharacter();if(_){R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:_,action:"trade"});return}const T=t.canTradeWithSettlement();T&&(J.play("audio/sfx/click.wav"),R.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:T,action:"trade"}))}),r.visible=t.canTradeWithCharacter()!==null||t.canTradeWithSettlement()!==null;const f=c("settlement");f.on("pointertap",()=>{const _=t.canVisitSettlement();_&&(J.play("audio/sfx/click.wav"),R.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:_,action:"trade"}))});const p=c("attack");p.on("pointertap",()=>{const _=t.canAttackCharacter();_&&R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:_,action:"attack"})});const u=c("ranged-attack");u.on("pointertap",()=>{const _=t.canRangedAttackCharacter();_&&R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:_,action:"attack"})});const g=c("loot");g.on("pointertap",()=>{const _=t.canLoot();_&&R.emit("ON_INVENTORY_REQUEST",{inventory:_,action:"open"})});const y=c("search");y.on("pointertap",()=>{const _=t.canSearch();_&&R.emit("ON_EVENT_INTERACTION",{eventViewModel:_})});const v=c("rest");v.on("pointertap",()=>{t.canRestAtSettlement()&&(J.play("audio/sfx/click.wav"),R.emit("ON_LEVEL_COMPLETED"))});const b=()=>{let T=0;i.filter(m=>m.visible).forEach((m,x)=>{m.x=x*(m.width+16),m.y=(e.height-m.height)/2,T=x}),n.x=32+(innerWidth-(T+1)*(i[0].width+16))/2},k=async _=>{_.scale.set(0),_.alpha=0,_.visible=!0;const T=1,m=1.15,x=500,w=x*.7,C=x*.3;d.push(j.to(_,{alpha:1,duration:x/1e3,ease:"power1.inOut",onUpdate:()=>{b()}}));const I=j.to(_.scale,{x:m,y:m,duration:w/1e3,ease:"power1.inOut"});d.push(I),await I,d.push(j.to(_.scale,{x:T,y:T,duration:C/1e3,ease:"power1.inOut"}))},E=(_,T)=>{o.clear(),o.rect(0,0,_,64),o.fill("black"),o.alpha=0,b()},S=(_,T)=>{!_.visible&&T()?(_.visible=!0,k(_)):_.visible=T()!==null},P=()=>{e.visible=t.isVisible(),S(h,()=>t.canInteractWithCharacter()),S(r,()=>t.canTradeWithCharacter()||t.canTradeWithSettlement()),S(f,()=>t.canVisitSettlement()),S(p,()=>t.canAttackCharacter()),S(u,()=>t.canRangedAttackCharacter()),S(g,()=>t.canLoot()),S(y,()=>t.canSearch()),S(a,()=>t.canUnlockSettlement()),S(v,()=>t.canRestAtSettlement()),b()};return lt(()=>{ct(()=>{P()})},e),{view:e,resize:E,destroy:l}},Bn=s=>{let t=[];const e=new U;e.label="grid-container";const i=()=>{const l=innerWidth<innerHeight,c=30,a=l?(innerWidth-40)/2:innerWidth-15,h=12,r=c+10;t.forEach((f,p)=>{const u=Math.floor(p/(l?2:1)),g=p%(l?2:1);f.icon.position.set(g*a,u*(f.icon.height+h)),f.stats.position.set(f.icon.x+c*.5+r,f.icon.y+(f.icon.height-f.stats.height)/2),f.stats.scale.set(1);const y=a-r-10;f.stats.width>y&&(f.stats.width=y)}),d()},n=l=>{const{icon:c,stats:a}=l,h=Math.floor(t.length/(innerWidth<innerHeight?2:1)),r=t.length%(innerWidth<innerHeight?2:1);t.push({icon:c,stats:a,row:h,column:r}),i()},o=()=>{t=[],e.removeChildren()},d=()=>{e.removeChildren(),t.forEach(l=>{const c=new K;c.roundRect(l.icon.x-5,l.icon.y-5,l.icon.width+10,l.icon.height+10,5),c.fill("khaki"),c.stroke(16777215),c.alpha=.5,c.label="icon-background",e.addChild(c,l.icon,l.stats)})};return i(),{gridContainer:e,addDataToGrid:n,resize:i,renderGrid:d,clearDataFromGrid:o}},De=(s,t)=>{const e=new U,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},n=new _t,o=new K;n.text=s,n.style=i;const d=()=>{o.clear(),o.roundRect(n.x-10,n.y,n.width+20,n.height,10),o.fill("black"),o.alpha=.5};e.addChild(o,n);const l=c=>{n.text=c,d()};return d(),{view:e,updateText:l}},Ln=()=>{const s=document.createElement("canvas");s.width=256,s.height=1;const t=s.getContext("2d"),e=t.createLinearGradient(0,0,s.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,s.width,1),$e.from(s)},On=s=>{const{playerUiVM:t}=s,e=40,i=10,n=new U;n.label="player-ui-view";const o=Bn(),d=(z,q,Y,rt,nt)=>{const V=new U,$=new K,X=1;$.rect(0,0,200,20),$.fill(0),$.stroke(16777215);const tt=190/q,et=new K;for(let at=z>q?q-1:z-1;at>=0;at--)et.rect(5+at*tt,5,tt-X,10),at>=z-4?et.fill(Y):at>=z-7&&nt?et.fill(nt):et.fill(rt);return V.addChild($,et),V},l=()=>{n.visible=!0},c=()=>{n.visible=!1},a=G.from("health-icon.png");a.label="health-icon",a.anchor.set(.5),a.width=e,a.height=e;const h=G.from("torch-icon.png");h.label="torch-icon",h.anchor.set(.5),h.scale.set(.1);const r=G.from("coin.png");r.label="inventory-value-icon",r.anchor.set(.5),r.width=e,r.height=e;const f=G.from("armour-icon.png");f.label="armour-icon",f.anchor.set(.5),f.width=e,f.height=e;const p=De(`$ ${t.inventoryValue().toString()}`,{fill:"gold",fontSize:20}),u=ft({spriteName:"base-portrait",onClick:()=>{R.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})},onClickAudio:""}),g=ft({spriteName:"menu-icon",onClick:()=>{R.emit("ON_IN_GAME_MENU_REQUEST",{action:"open"})}}),y=ft({spriteName:"min-icon",onClick:()=>{R.emit("ON_IN_GAME_MENU_REQUEST",{action:"close"})},onClickAudio:"deselect"}),v=ft({spriteName:"save-icon",onClick:()=>{k.updateText("Saving..."),R.emit("ON_SAVE_REQUEST")}}),b=ft({spriteName:"load-icon",onClick:()=>{k.updateText("Loading..."),R.emit("ON_LOAD_REQUEST")}}),k=De("Game Paused"),E=()=>{g.visible=!1,k.view.visible=!0,y.visible=!0,v.visible=!0,b.visible=!0},S=()=>{g.visible=!0,k.updateText("Game Paused"),k.view.visible=!1,y.visible=!1,v.visible=!1,b.visible=!1};n.addChild(h,a,r,p.view,u,o.gridContainer,f,g,y,v,k.view,b);let P=null,_=null,T=null,m=null,x=null,w=null,C=null;const I=()=>{if(T&&n.removeChild(T),t.maxArmour()<=0||t.armour()<=0){T=null;return}T=d(t.armour(),t.maxArmour(),"blue","blue"),T.position.set(a.width+i,a.y-T.height*.5),T.label="armour-bar",n.addChild(T)},B=()=>{P&&n.removeChild(P),P=d(t.health(),t.maxHealth(),"red","red"),P.label="health-bar",P.position.set(a.width+i,a.y-P.height*.5),n.addChild(P)},L=z=>{const q=new U,Y=20;q.label="stat-container";let rt=0;if(Object.entries(z).forEach(([V,$],X)=>{X!==0&&(rt+=q.width),Array($()).fill(0).forEach((tt,et)=>{const at=G.from(V+".png");at.width=Y,at.height=Y,at.position.set(rt+et*Y*.5,0),q.addChildAt(at,0)})}),q.width===0)return q;const nt=new G(Ln());return nt.x=q.x-5,nt.y=q.y-5,nt.width=q.width+64,nt.height=q.height+10,nt.label="row-gradient-background",q.addChildAt(nt,0),q},W=()=>{const z=t.weapon();m?m.removeChildren():(m=new U,m.label="weapon-icon",n.addChild(m));const q=G.from(z.code()+".png");q.width=e,q.height=e;const Y=L({"damage-icon":()=>z.damage(),"range-icon":()=>z.range()});return{icon:q,stats:Y}},A=()=>{const z=t.bodyArmour();x?x.removeChildren():(x=new U,x.label="armour-icon",n.addChild(x));const q=G.from(z.code()+".png");q.width=e,q.height=e;const Y=L({"armour-icon":()=>z.armour()});return{icon:q,stats:Y}},M=()=>{const z=t.headArmour();w?w.removeChildren():(w=new U,w.label="head-armour-icon",n.addChild(w));const q=z.code()==="head"?"base-portrait":z.code(),Y=G.from(q+".png");Y.width=e,Y.height=e;const rt=L({"armour-icon":()=>z.armour()});return{icon:Y,stats:rt}},N=()=>{const z=t.feetArmour();C?C.removeChildren():(C=new U,C.label="feet-armour-icon",n.addChild(C));const q=G.from(z.code()+".png");q.width=e,q.height=e;const Y=L({"armour-icon":()=>z.armour()});return{icon:q,stats:Y}},D=()=>{_&&n.removeChild(_),_=d(t.torchLeft(),30,"red","brown","khaki"),_.label="torch-bar",P&&_.position.set(P.x,h.y-7),n.addChild(_)},O=()=>{a.position.set(10,10),f.position.set(10,10),P&&(P.position.set(a.width+i,a.y-P.height*.5),p.view.position.set(P.x,r.y-p.view.height*.5),T&&T.position.set(P.x,P.y)),_&&P&&_.position.set(P.x,h.y-7),h.position.set(10,a.height+15),r.position.set(10,h.y+h.height),o.resize(),o.gridContainer.position.set(0,r.y+r.height*.5+10),u.position.set(innerWidth-(u.width+32),20),g.position.set(innerWidth-(g.width+32),u.y+u.height+10),y.position.set(g.x,g.y),v.position.set(g.x,g.y+g.height+10),b.position.set(g.x,v.y+v.height+10),k.view.position.set(innerWidth/2-k.view.width/2,innerHeight/2-20),n.position.set(20,20)};return S(),O(),lt(()=>{ct(()=>{B(),I(),t.torchLeft()>=0&&D(),t.isSaveCompleted()?k.updateText("Save completed"):k.updateText("Game Paused"),f.visible=t.maxArmour()>0&&t.armour()>0,t.isInGameMenuVisible()?E():S(),t.isInventoryValueVisible()?(r.visible=!0,g.visible=!1,p.view.visible=!0,o.gridContainer.visible=!0,o.clearDataFromGrid(),o.addDataToGrid(M()),o.addDataToGrid(W()),o.addDataToGrid(A()),o.addDataToGrid(N())):(r.visible=!1,y.visible||(g.visible=!0),p.view.visible=!1,o.gridContainer.visible=!1),p.updateText(`$ ${t.inventoryValue().toString()}`),O()})},n),{view:n,show:l,hide:c,resize:O}},Wn=s=>{const{viewModel:t}=s,e=new U;e.label="new-trade-view";const i=new K;i.label="new-trade-view-background",e.addChild(i);const n=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let o=!1;const d=({title:y,stacks:v,width:b,height:k,playerStacks:E,npcInv:S=!1,includeItemValue:P=!1,isTradeInv:_=!1})=>{const T=new U;T.label=`${y}-screen-view`;const m=Yt({text:y,onClick:()=>{}});m.label=`${y}-title-button`;const x=new ce({width:b,height:k,padding:4,elementsMargin:2});x.label=`${y}-inventory-view`;const w=new K;w.label=`${y}-background`,T.addChild(w,m,x);const C=(I,B,L)=>{I.forEach(W=>{const A=Ut({viewModel:W.item,includeItemValue:P,itemValue:t.getItemPrice(W.item,L),quantity:W.quantity}),N=zt(A,B==="buy"||B==="buy-return"?"pink":"lightblue"),D=new U;A.view.off("pointertap"),D.on("pointertap",()=>{O(),R.emit("ON_ITEM_INTERACTION",{itemViewModel:W.item,action:B}),o=!0}),D.addChild(N.container,A.view),D.label=`${A.view.label}-container`,x.addItem(D);const O=()=>{D.tint=65280,setTimeout(()=>{D.tint=16777215},200)}})};return S?C(v,"buy",!0):_?(C(E||[],"sell-return",!1),C(v,"buy-return",!0)):C(v,"sell",!1),m.scale.set(.4),m.position.set(b*.5,m.height*.5),x.position.set(b*.5-x.width*.5,m.height+10),w.rect(0,0,T.width,T.height),w.fill("black"),w.stroke("black"),T};let l=null,c=null,a=null,h=null,r=null;const f=()=>{l?p():J.play("audio/sfx/door.mp3");const{innerWidth:y,innerHeight:v}=window,b=v>y,k=b?y:y*.35,E=b?v*.35:v;n(),a=Yt({text:"Continue",onClick:()=>{a.eventMode="none",R.emit("ON_TRADE_REQUEST",{action:"confirm-bulk-trade"}),j.delayedCall(.5,()=>{R.emit("ON_CLOSE_INVENTORY_REQUESTED")}),o=!0}}),a.alpha=0,a.label="continue-button";let S="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?S="green":t.value().quantity()>0?S="yellow":S="red");const P=Ut({viewModel:t.value()});r=zt(P,S).container,h=new U,h.label="trade-buttons-container",h.addChild(a,r),a.scale.set(.4),e.addChild(h),l=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:k,height:E,includeItemValue:!0,isTradeInv:!1}),e.addChild(l),l.label="player-trade-screen",c=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:k,height:E,includeItemValue:!0,isTradeInv:!0}),e.addChild(c),c.label="trade-screen",a&&(a.alpha=t.isContinueButtonVisible()?1:0),e.visible=!0},p=()=>{l&&(e.removeChild(l),l.destroy(),l=null),c&&(e.removeChild(c),c.destroy(),c=null),a&&(e.removeChild(a),a.destroy(),a=null),h&&(e.removeChild(h),h.destroy(),h=null),r&&(e.removeChild(r),r.destroy(),r=null),e.visible=!1},u=(y,v)=>{if(!e.visible||!l||!c)return;v>y?(l.position.set(0,0),c.position.set(0,l.y+l.height+2),r&&a&&(r.position.set(-r.width*.5,-r.height*.5),a.position.set(r.x+r.width+a.width*.5,0)),h&&h.position.set(y*.5-h.width*.5,c.position.y+c.height+h.height*.5+10)):(l.position.set(0,0),c.position.set(2+l.position.x+l.width,0),r&&a&&(r.position.set(0,0),a.position.set(20,r.y+r.height+30)),h&&h.position.set(c.position.x+c.width+h.width*.5,v*.5-h.height*.5))};return{view:e,show:f,hide:p,resize:u,update:()=>{a&&(a&&(a.alpha=t.isContinueButtonVisible()?1:0),a.alpha===1&&!o)||!o&&!t.isAutoTrading()||(o=!1,e.visible&&(f(),u(innerWidth,innerHeight)))}}},Dn=s=>{const t=s.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2");return t.charAt(0).toUpperCase()+t.slice(1)},Hn=s=>{const t=mt().log;let e=[],i=!0;const n=new U;n.label="log-view",n.alpha=0;const o=new U;o.label="log-grid-layout",n.addChild(o);const d=new K;o.addChild(d);const l=()=>{if(e.length>0){e.forEach(g=>g()),e=[];return}u()},c=async g=>{var _;const y=o.children.length,v=innerWidth/2-20,b=new _t,k=g.name.toLowerCase().includes("value");b.style={fontFamily:"alagard",fontSize:20,fill:"black"},b.text=Dn(g.name),b.position.set(10,y*15);const E=new U;E.label="log-value-container",E.position.set(v+(innerWidth<innerHeight?100:0),b.y);const S=new _t;S.style={fontFamily:"alagard",fontSize:18,fill:"black"},S.text=k?"$":"",S.text+=g.value??((_=g.to)==null?void 0:_.toString())??"",E.addChild(S),o.addChild(b),o.addChild(E),b.alpha=0,E.alpha=0,!await new Promise(T=>{j.delayedCall(g.index*.5,()=>{i||T(!0),e.shift(),T(!1)}),e.push(()=>T(!0))})&&i&&J.play("audio/sfx/sfx-thud.mp3"),b.alpha=1,E.alpha=1};Object.entries(t).sort((g,y)=>g.toLocaleString().localeCompare(y.toLocaleString())).forEach(([g,y],v)=>{c(typeof y=="string"?{name:g,value:y,index:v}:{name:g,to:y,index:v})});const a=5;d.roundRect(-5,-5,o.width+30+a*2,o.height+30+a*2,30),d.fill("khaki"),n.eventMode="static",n.on("pointertap",()=>{l()});const h=new _t;h.text="Tap to continue",h.style={fontFamily:"alagard",fontSize:20,fill:"white"};const r=innerHeight>innerWidth;h.position.set(r?(n.width-h.width)*.5:n.width+40,r?n.height+20:n.height*.5),n.addChild(h);const f=()=>{i=!0,n.visible=!0,n.alpha=0,j.to(n,{alpha:1,duration:.5,ease:"power2.out"})},p=()=>{i=!1},u=()=>{i=!1,j.to(n,{alpha:0,duration:.5,ease:"power2.in",onComplete:()=>{n.visible=!1,s()}})};return{view:n,destroy:p,show:f,hide:u,handleAnyPress:l}},Un=s=>{const t=new U,{playerMenuVM:e}=s;let i=null,n=null,o=null,d=null,l=null,c=null;const a=new K;a.label="background",a.alpha=0,a.on("pointertap",()=>{c==null||c.handleAnyPress()}),t.addChild(a);const h=()=>{a.clear(),a.rect(0,0,innerWidth,innerHeight),a.fill("black")},r=()=>{P(),E(),a.alpha=0},f=()=>{d&&(d.view.visible=!1),a.alpha=0},p=()=>{f(),v(),u(),a.alpha=1,c=Hn(()=>{u(),R.emit("ON_LEVEL_COMPLETED")});const x=Math.min(1,Math.min(innerWidth/c.view.width,innerHeight/c.view.height));c.view.scale.set(x),c.view.position.set(innerWidth*.5-c.view.width*.5,innerHeight*.5-c.view.height*.5),t.addChild(c.view),c.show(),a.eventMode="static"},u=()=>{a.eventMode="none",c&&(c.destroy(),t.removeChild(c.view),c.view.destroy({children:!0}),c=null)},g=()=>{const x=s.playerUiVM();if(!x)return;if(d){d.view.position.set(30,30),d.view.visible=!0;return}d=On({playerUiVM:x});const w=Math.min(1,Math.min(innerWidth/d.view.width,innerHeight/d.view.height));d.view.scale.set(w),d.view.position.set(30,30),t.addChild(d.view),d.view.visible=!0,d.view.label="player-ui-view"},y=()=>{const x=e();if(!x)return;n||(n=Vn({viewModel:x}),t.addChild(n.view));const w=Math.min(1,Math.min(innerWidth/n.view.width,innerHeight/n.view.height));n.view.scale.set(w),n.view.position.set(innerWidth*.5-n.view.width*.5,innerHeight*.9-n.view.height*.5),n.view.visible=!0},v=()=>{n&&(n.view.visible=!1),a.alpha=0},b=x=>{E(),v(),f(),a.alpha=1,o=Wn({viewModel:x}),t.addChild(o.view),o.show()},k=x=>{E(),v(),f(),a.alpha=1,o=Rn({viewModel:x}),t.addChild(o.view),o.show(),_(innerWidth,innerHeight)},E=()=>{y(),g(),o&&(t.removeChild(o.view),o.view.destroy(),o=null),a.alpha=0,_(innerWidth,innerHeight)},S=x=>{if(v(),a.alpha=1,l&&!x)x=l;else if(!x)throw new Error("No inventory provided to showInventory");l=x,setTimeout(()=>{i=Nn(x),i.show(),t.addChild(i.view),_(innerWidth,innerHeight)},10)},P=(x=!0)=>{y(),i&&(t.removeChild(i.view),i.view.destroy(),i=null),x&&(l=null),a.alpha=0},_=(x,w,C=!1)=>{h();const I=w>x;if(o){o.show(),o.resize(x,w);const B=I?Math.min(1,w/o.view.height):Math.min(1,x/o.view.width);o.view.scale.set(B);const L=I?(t.width-o.view.width)*.5:0,W=I?0:(t.height-o.view.height)*.5;o.view.position.set(L,W)}if(n&&(n.resize(x,w),n.view.position.set(x*.5-n.view.width*.5,w*.9-n.view.height*.5)),d&&d.resize(),c&&p(),i&&d){if(C){P(!1),S();return}const B=I?(x-i.view.width)*.5:d.view.width*.4,L=I?d.view.y+d.view.height+10:(w-i.view.height)*.5;i.view.position.set(B,L)}},T=()=>{o==null||o.update()};return t.label="user-interface-view",h(),{showInventory:S,hideInventory:P,showTrade:k,hideTrade:E,showBulkTrade:b,view:t,closeAll:r,showPlayerMenu:y,hidePlayerMenu:v,showPlayerUi:g,resize:_,destroy:()=>{t.removeChildren(),a.destroy(),i=null,n==null||n.destroy(),n=null,o=null,d=null},update:T,showEndOfLevelLog:p,hideEndOfLevelLog:u}},zn=()=>{const s=re.map(e=>(e.code()==="torch"&&e.updateQuantity(11),Tt(e.code()))),t=Qt(s);return kt({model:t,ownerName:"Global Inventory"})},qn=s=>{const{playerVM:t,tileMapVM:e}=s,i=(l,c)=>{const a=t.position().x+l,h=t.position().y+c;if(a<=0&&a>=e.tiles().length-1&&h<=0&&h>=e.tiles()[0].length-1)return;const r=e.tiles()[a][h];r&&R.emit("ON_TILE_INTERACTION",{tileViewModel:r})},n=l=>{switch(l){case"endLevel":R.emit("ON_LEVEL_COMPLETED");break;case"showInventory":R.emit("ON_INVENTORY_REQUEST",{inventory:zn(),action:"open"});break;case"showCharacterDetails":console.debug("Showing character details");break;case"moveLeft":i(-1,0);break;case"moveRight":i(1,0);break;case"moveUp":i(0,-1);break;case"moveDown":i(0,1);break;default:console.warn(`Unknown action: ${l}`)}},o=l=>{switch(l.key){case"r":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"endLevel"});break;case"i":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"showInventory"});break;case"w":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveUp"});break;case"s":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveDown"});break;case"a":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveLeft"});break;case"d":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveRight"});break;case"6":R.emit("ON_SAVE_REQUEST");break;case"8":R.emit("ON_LOAD_REQUEST");break}};return document.addEventListener("keypress",o),{handleDebugActionRequest:n,destroy:()=>{document.removeEventListener("keypress",o)}}};function $n(s){const t=[];let e=s;for(;e;)t.unshift(e.tile),e=e.previous;return t}function $t({start:s,end:t,map:e,maxDistance:i=7}){const n=e.tiles().flat().find(r=>r.position().x===s.x&&r.position().y===s.y),o=e.tiles().flat().find(r=>r.position().x===t.x&&r.position().y===t.y);if(!n||!o)return null;const d=Math.sqrt(Math.pow(o.position().x-n.position().x,2)+Math.pow(o.position().y-n.position().y,2)),l={previous:null,tile:n,g:0},c=r=>{let f=!1,p=r.previous;for(;p;){if(p.tile.position().x===r.tile.position().x&&p.tile.position().y===r.tile.position().y){f=!0;break}p=p.previous}return f},a=[],h=r=>{if(r.tile.position().x===o.position().x&&r.tile.position().y===o.position().y){a.push(r);return}if(r.g>i||r.g>d)return;const f=e.getNeighbors(r.tile),p=r.tile.position();for(const u of f){if(!u.traversable()&&o.traversable())continue;const g=u.position(),y=Math.abs(g.x-p.x),v=Math.abs(g.y-p.y),b=y===1&&v===1?2:1,k=r.g+b;if(k>i)continue;const E={previous:r,tile:u,g:k};c(E)||h(E)}};if(h(l),a.length>0){const r=a.reduce((p,u)=>p.g<u.g?p:u),f=$n(r);if(f.length>0)return f.shift(),f}return[]}const Gn={"bed-time":["follow"],patrol:["bed-time","follow","work"],follow:["attack"],work:["bed-time","patrol","follow"],idle:["bed-time","patrol","follow","work"],attack:["bed-time","patrol","follow","work"],spawn:["bed-time","patrol","follow","work","attack"]},Fn=s=>{const{events:t,playerVM:e,tileMapVM:i,npcTaskController:n,npcs:o,turnVM:d}=s,l=5,c=[],a=(m,x)=>{var C;const w=[];for(let I=m.x-x;I<=m.x+x;I++)for(let B=m.y-x;B<=m.y+x;B++){const L=(C=i.tiles()[I])==null?void 0:C[B];!L||Math.floor(Math.sqrt(Math.pow(L.position().x-m.x,2)+Math.pow(L.position().y-m.y,2)))>x||L.traversable()&&w.push(L.position())}return w},h=(m,x)=>{let C=5,I=null;for(;I===null||I.length===0;)if(I=$t({start:m,end:x,map:i,maxDistance:C}),C++,C>9)return null;return I},r=m=>{const x=m.position();let w=null;const C=[];for(const I of t){const B=I.position(),L=Math.floor(Math.sqrt(Math.pow(B.x-x.x,2)+Math.pow(B.y-x.y,2)));C.push({event:I,distance:L})}C.sort((I,B)=>I.distance-B.distance);for(let I=0;I<Math.min(3,C.length);I++){const B=C[I].event,L=h(x,B.position());if(L&&L.length>0){w=B;break}}return w||null},f=m=>{m.isAlive()&&(m.setTaskList([n.createSpawnTask(m)]),m.setCanTrade(!1),c.push(m),m.getPatrolArea().length===0&&(m.setPatrolArea(a(m.position(),l)),m.setTaskList([...m.getTaskList(),n.createPatrolTask(m)])))},p=m=>{m.isAlive()&&!m.isHostile(e.team())&&(m.setTaskList([n.createWorkTask(m)]),m.setCanTrade(!0),c.push(m))},u=m=>{if(!m.isAlive()){m.setTask(null);return}if(m.isHostile(e.team())&&m.getPatrolArea().length===0&&(m.setPatrolArea(a(m.position(),l)),m.setTaskList([...m.getTaskList(),n.createPatrolTask(m)])),m.getBedLocation()===null){const x=r(m);x&&m.setBedLocation(x.position())}c.push(m)},g=(m,x)=>{const w=m.getTask();if(!w)return!0;const C=w.name();return(Gn[C]||[]).includes(x)},y=m=>{if(!m.spawnLing())return!1;const x=4;if(m.lastSpawned()===0)return m.setLastSpawned(d.getCurrentTurn()),!1;const w=d.getCurrentTurn()-m.lastSpawned()>=x;if(!w)return!1;if(w){const C=n.createSpawnTask(m);if(C)return m.setTask(C),m.setLastSpawned(d.getCurrentTurn()),!0}return!1},v=m=>{if(!m.isHostile(e.team()))return!1;if(e.isAlive()&&e.position()){const C=Math.floor(Math.sqrt(Math.pow(e.position().x-m.position().x,2)+Math.pow(e.position().y-m.position().y,2)));if(C<=1)return!1;if(C<=4&&g(m,"follow")){const I=m.getTaskList().find(B=>B.name()==="follow")||n.createFollowPlayerTask(m);if(I)return m.setTarget(e),m.setTask(I),!0}}return!1},b=m=>{const x=m.getTask(),w=s.turnVM.getCurrentTimeMin();if(w>=1200||w<480){if(x&&x.name()==="bed-time")return!0;if(g(m,"bed-time")){const C=m.getTaskList().find(I=>I.name()==="bed-time")||n.createBedTimeTask(m);if(C)return m.setTask(C),!0}}return!1},k=m=>{const x=m.getTask();if(s.turnVM.getCurrentTimeMin()>=480){if(x&&x.name()==="patrol")return!0;if(g(m,"patrol")){const C=m.getTaskList().find(I=>I.name()==="patrol");if(C)return m.setTask(C),!0}}return!1},E=m=>{var I;const x=m.getTarget(),w=1;if(!x||!x.isAlive())return m.setTarget(null),!1;if(Math.floor(Math.sqrt(Math.pow(x.position().x-m.position().x,2)+Math.pow(x.position().y-m.position().y,2)))>w)return!1;if(((I=m.getTask())==null?void 0:I.name())==="attack")return!0;if(g(m,"attack")){const B=m.getTaskList().find(L=>L.name()==="attack")||n.createAttackTask(m);if(B)return m.setTask(B),!0}return!1},S=m=>{var x;if(((x=m.getTask())==null?void 0:x.name())==="work")return!0;if(g(m,"work")){const w=m.getTaskList().find(C=>C.name()==="work");if(w)return m.setTask(w),!0}return!1},P=m=>{if(!m.isAlive()){m.setTask(null);return}y(m)||E(m)||v(m)||b(m)||k(m)||S(m)},_=()=>{c.forEach(m=>{if(!m.isAlive())return;P(m);const x=m.getTask();x&&x.name(),x&&x.execute()})};return(()=>{o.forEach(m=>{u(m)})})(),{addNpc:u,addTrader:p,addNestmother:f,playNpcTurn:_}},Qn=({npc:s,attackVM:t})=>({execute:()=>{if(!s.isAlive())return!1;const e=s.getTarget();return!e||!e.isAlive()?(s.setTask(null),!0):Math.floor(Math.sqrt(Math.pow(s.position().x-e.position().x,2)+Math.pow(s.position().y-e.position().y,2)))<=1?(t.attack(s,e),!0):!1},name:()=>"attack"}),Yn=({npc:s,tileMapVM:t,turnVM:e})=>{let i=s.getBedLocation(),n=null;return{execute:()=>{if(s.isAlive()===!1)return!1;if(e.getCurrentTimeMin()>=480&&e.getCurrentTimeMin()<1200)return s.setTask(null),!0;if(!i&&(i=s.getBedLocation(),!i))return!1;if(s.position().x===i.x&&s.position().y===i.y)return!0;if(!n){let d=5;for(;n===null||n.length===0;)if(n=$t({start:s.position(),end:i,map:t,maxDistance:d}),d++,d>8)return!1}if(n&&n.length>0){const o=n.shift();return o&&(s.moveTo(o.position().x,o.position().y),o.position().x===i.x&&o.position().y===i.y),!0}return!1},name:()=>"bed-time"}},Xn=({npc:s,tileMapVM:t,playerVM:e})=>({execute:()=>{if(s.isAlive()===!1)return!1;const i=e.position(),n=$t({start:s.position(),end:i,map:t});if(n&&n.length>0){const o=n.shift();if(o)return o.position().x===i.x&&o.position().y===i.y||s.moveTo(o.position().x,o.position().y),!0}return!1},name:()=>"follow"}),jn=({npc:s,tileMapVM:t})=>{let e=s.getPatrolArea(),i=null;return{execute:()=>{if(s.isAlive()===!1||e.length===0||((!i||i.length===0)&&(i=$t({start:s.position(),end:e[Math.floor(Math.random()*e.length)],map:t})),!i||i.length===0))return!1;const n=i.shift();return n&&s.moveTo(n.position().x,n.position().y),!0},name:()=>"patrol"}},Zn=({npc:s})=>({execute:()=>s.isAlive()===!1?!1:(s.setCanTrade(!0),!0),name:()=>"work"}),Kn=({npc:s,addNpc:t,spawnType:e="worm"})=>({execute:()=>{if(!s.isAlive())return!1;const i=s.position(),n=ze({id:e,team:"hostile-to-player",name:"Spawned "+e.charAt(0).toUpperCase()+e.slice(1),startingSize:1,startPosition:i,startingHealth:1,startingMaxHealth:1,startingItems:[]}),o=ti(n);return t(o),!0},name:()=>"spawn"}),Jn=s=>{const{attackVM:t,tileMapVM:e,turnVM:i,playerVM:n}=s;return{createBedTimeTask:r=>Yn({npc:r,tileMapVM:e,turnVM:i}),createPatrolTask:r=>jn({npc:r,tileMapVM:e}),createFollowPlayerTask:r=>Xn({npc:r,tileMapVM:e,playerVM:n}),createAttackTask:r=>Qn({npc:r,attackVM:t}),createWorkTask:r=>Zn({npc:r}),createSpawnTask:r=>Kn({npc:r,spawnType:"worm",addNpc:s.addNpc})}},Ft=(s,t)=>s.id()===t.id(),ts=()=>({use:(s,t)=>{if(s.health()!==0){if(t.health()>=t.maxHealth())return;if(t.id()==="player"){const e=Math.min(s.health(),t.maxHealth()-t.health());mt().log.totalHealing+=e}t.setHealth(t.health()+s.health()),t.inventory().removeItem(s),s.updateQuantity(0);return}s.type()==="weapon"&&(Ft(t.weapon(),s)?t.setWeapon(void 0):t.setWeapon(s)),s.type()==="armour"&&(Ft(t.bodyArmour(),s)?t.setBodyArmour(void 0):t.setBodyArmour(s)),s.type()==="helmet"&&(Ft(t.headArmour(),s)?t.setHeadArmour(void 0):t.setHeadArmour(s)),s.type()==="shoes"&&(Ft(t.feetArmour(),s)?t.setFeetArmour(void 0):t.setFeetArmour(s))}}),es=()=>{let s=null,t=null;const e=222,[i,n]=F(!1),[o,d]=F(!0),[l,c]=F(!1),[a,h]=F(!1),[r]=F(Ht({model:Tt("coin")})),f=kt({model:Qt([]),ownerName:"trade"}),p=kt({model:Qt([]),ownerName:"trade-npc"}),u=(M,N)=>{s=M,t=N,v(T()),v(_())},g=M=>{w().addItem(M,1),f.removeItem(M,1)},y=M=>{C().addItem(M,1),p.removeItem(M,1)},v=M=>{let N;M===f?N=g:N=y,M.items().forEach(D=>{N(D,!0),M.removeItem(D,1)})},b=M=>{const N=w().getItem(M);N&&(f.addItem(N,1),w().removeItem(N,1))},k=M=>{const N=C().getItem(M);N&&(p.addItem(N,1),C().removeItem(N,1))},E=()=>{v(T()),v(_()),r().updateQuantity(0)},S=(M=!1)=>{if(!s||!t)throw new Error("Player or NPC inventory is not set");return!l()&&!a()&&m()!==0?(c(!0),!1):r().quantity()<0?!1:((l()&&!a()||a()&&!l()||m()===0)&&M&&P(),l()&&c(!1),!0)},P=()=>{if(i()){const M=Math.floor(r().quantity());Array(M).fill(0).forEach(()=>{const N=Ht({model:Tt("coin")});_().addItem(N)}),M>0&&J.play("audio/sfx/sfx-sell.mp3")}f.items().forEach(M=>{C().addItem(M,M.quantity()),f.removeItem(M,M.quantity())}),p.items().forEach(M=>{mt().log.tradedItemsValue+=x(M,!0),w().addItem(M,M.quantity()),p.removeItem(M,M.quantity())}),v(T()),v(_()),i()&&n(!1)},_=()=>(r().updateQuantity(m()),p),T=()=>(r().updateQuantity(m()),f),m=()=>{const M=f.stacks().reduce((D,O)=>D+x(O.item,!1)*O.quantity,0),N=p.stacks().reduce((D,O)=>D+Math.max(1,x(O.item,!0)*O.quantity),0);return Math.floor(M)-Math.ceil(N)},x=(M,N)=>{const D=M.value()*M.quantity(),z=N&&!["coin","torch"].includes(M.code())?2:1;return D*z},w=()=>{if(s)return s;throw new Error("Player inventory is not set")},C=()=>{if(t)return t;throw new Error("NPC inventory is not set")},I=async()=>{await B(!1),await j.delayedCall(.2,()=>{}),n(!1)},B=async(M=!0)=>{if(!s||!t)throw new Error("Invalid inventories to auto trade");n(!0);const N=s.stacks().reduce((D,O)=>(O.quantity>0&&O.item.type()==="loot"&&D.push(O),D),[]);for(const D of N){await j.delayedCall(e/1e3,()=>{});for(let O=0;O<D.quantity;O++)M?J.play("audio/sfx/sfx-sell.mp3",{category:"gameplay"}):J.play("audio/sfx/collect.wav",{category:"gameplay"}),b(D.item)}};return{isConfirmationModalVisible:l,startTrade:u,cancelTrade:E,acceptTrade:S,playerTradeItems:T,acceptBulkTrade:()=>{a()&&(S(!0),h(!1))},value:r,npcTradeItems:_,playerInventory:w,npcInventory:C,selectItemToBuy:k,selectItemToSell:b,returnItemToPlayer:g,returnItemToNpc:y,clearTrade:()=>{if(l()){c(!1);return}v(T()),v(_()),c(!1),r().updateQuantity(0)},getItemPrice:x,bulkTrade:async()=>{h(!0),await j.delayedCall(.5,()=>{}),d(!1),await B(),await j.delayedCall(.5,()=>{}),d(!0)},autoTrade:I,isAutoTrading:i,isContinueButtonVisible:o}},is=s=>{if(s.length===0)return{x:0,y:0};const t=s.reduce((o,d)=>o+d.x,0),e=s.reduce((o,d)=>o+d.y,0),i=t/s.length,n=e/s.length;return{x:i,y:n}},He=(s,t)=>Math.abs(s.x-t.x)<=1&&Math.abs(s.y-t.y)<=1,ns=s=>{let t="idle",e="idle";return{get:()=>t,set:d=>{t!==d&&(e=t,d==="end-turn"?(s(),t="idle"):t=d)},getPrevState:()=>e}},ss=s=>{const{tileMapViewModel:t,playerViewModel:e,userInterfaceView:i,gameView:n,playerUiVM:o,attackVM:d}=s;let l=null,c=null;const a=ns(s.onPlayerTurnCompleted),h=ts(),r=1,f=()=>e.isAlive()&&a.get()!=="busy",p=w=>{const{action:C,trader:I}=w;if(!(I&&!I.canTrade())&&f()){if(a.set("trading"),I&&!c)if(c=es(),c.startTrade(e.inventory(),I.inventory()),C==="autoTrade"){c.bulkTrade(),i.showBulkTrade(c);return}else{i.showTrade(c);return}if(c){if(C==="autoTrade"&&c.autoTrade(),C==="clear"){c.clearTrade();return}if(C==="confirm-bulk-trade"){c.acceptBulkTrade();return}C==="submit"&&c.acceptTrade(!0)}}},u=w=>{var C;if(l){l.ownerName()===e.name()&&P();return}if(!c&&f()){if(w.isEmpty()){a.set("idle"),l=null;return}if(w.isOnlyLoot()&&w.ownerName()!==e.name()){i.update(),v(w);return}a.set("inventory-handling"),l=w,i.showInventory(w),(C=o())==null||C.isInventoryValueVisible(!0)}},g=w=>{var C;a.set("busy"),(C=o())==null||C.showInGameMenu(w==="open"),w!=="open"&&a.set(a.getPrevState()||"idle")},y=(w,C)=>{f()&&(a.set("inventory-handling"),C==="open"?u(w):P())},v=w=>{w.items().forEach(C=>{var I;e.inventory().addItem(C),w.removeItem(C),(I=n())==null||I.animateIconFloat(C.code(),e.position())}),J.play("audio/sfx/inventory-open.wav",{category:"gameplay",volume:1}),l=null,a.set("end-turn")},b=w=>{var W,A;const{settlement:C,action:I}=w,B=C.positions(),L=is(B);if(f()){if(I==="unlock"){const M=e.inventory().getItemByCode("city-key");if(!M)throw new Error("City key is required to unlock the settlement");C.setIsUnlocked(!0),e.inventory().removeItem(M),(W=n())==null||W.createTextBox({id:()=>"settlement",dialogue:()=>"Welcome!",position:()=>({x:L.x,y:L.y})});return}if(I==="trade"&&C.isUnlocked()){p({action:"trade",trader:{canTrade:()=>!C.inventory().isEmpty(),inventory:()=>C.inventory()}});return}(A=n())==null||A.createTextBox({id:()=>"settlement",dialogue:()=>"City key required",position:()=>({x:L.x,y:L.y})})}},k=()=>{c&&(c.cancelTrade(),i.closeAll(),c=null),a.set("idle")},E=w=>{const{action:C,character:I}=w;if(!f()||!I)return;if(C==="talk"){const A=n();if(!A)return;A.createTextBox(I),a.set("idle");return}const B=Math.floor(Math.sqrt(Math.pow(I.position().x-e.position().x,2)+Math.pow(I.position().y-e.position().y,2))),L=B<=r,W=B<=e.weapon().range();if(I.isHostile(e.team())&&W&&I.health()>0){d.attack(e,I),a.set("end-turn");return}if(!L){_(I.position());return}if(!I.inventory().isEmpty()){if(I.canTrade()){p({action:"change-to-buy",trader:I});return}u(I.inventory());return}if(I.inventory().isEmpty()){_(I.position());return}u(I.inventory())},S=(w,C)=>{if(a.get()==="idle"&&f()){if(He(w.position(),e.position())&&(!w.discovered()||!w.inventory().isEmpty())){u(w.inventory()),w.interact(C);return}_(w.position())}},P=()=>{var w,C;if(l){if(l.ownerName()===e.name()){l=null,a.set("idle"),(w=o())==null||w.isInventoryValueVisible(!1),i.hideInventory();return}l=null,a.set("end-turn"),(C=o())==null||C.isInventoryValueVisible(!1),i.hideInventory();return}c&&k(),a.set("idle")},_=({x:w,y:C})=>{if(a.get()!=="idle"||!f())return;const I=e.position();if(He({x:w,y:C},I)&&t.isValidMove(w,C)){T(w-I.x,C-I.y);return}const B=$t({start:I,end:{x:w,y:C},map:t});if(B&&B.length>1){const L=B[0];T(L.position().x-I.x,L.position().y-I.y)}},T=(w,C)=>{if(a.set("moving"),!f())return;const I=e.position().x+w,B=e.position().y+C;t.isValidMove(I,B)&&e.moveTo(I,B),a.set("end-turn")};return{handlePlayerMoveRequest:_,handleTileInteraction:w=>{a.get()==="idle"&&f()&&_(w.position())},handleCharacterInteraction:E,handleEventInteraction:S,handleItemInteraction:(w,C)=>{var I;if(f()){if(a.get()==="trading"){if(C==="sell"){c==null||c.selectItemToSell(w);return}if(C==="buy-return"){c==null||c.returnItemToNpc(w);return}if(C==="sell-return"){c==null||c.returnItemToPlayer(w);return}if(C==="buy"){c==null||c.selectItemToBuy(w);return}}if(l&&l.ownerName()!==e.name()){e.inventory().addItem(w),l.removeItem(w),(I=n())==null||I.animateIconFloat(w.code(),e.position());return}h.use(w,e)}},handleCloseInventoryRequest:P,handleTradeRequest:p,handleTradeCancel:k,handleSettlementInteraction:b,handleInventoryRequest:y,handleInGameMenuRequest:g}},os=s=>{const{turnVM:t,handleEndUpTurnUpdates:e,playerVM:i,enemyVMs:n,npcController:o}=s;let d=0;const l=()=>{var f;const r=mt().log;r.turns+=1,r.npcsKilled=n.filter(p=>!p.isAlive()).length,r.npcsAlive=n.filter(p=>p.isAlive()).length,r.mostUsedWeapon=((f=i.inventory().items().filter(p=>p.type()==="weapon").sort((p,u)=>u.uses()-p.uses())[0])==null?void 0:f.name())||"fists"},c=async()=>{h(),await e(),t.nextTurn(),a(),l()},a=async()=>{if(d+=1,d%10===0){const r=i.inventory().getItemByCode("torch");r&&i.inventory().removeItem(r)}},h=()=>{o.playNpcTurn()};return{handlePlayerTurnEnded:c,playNpcTurn:h}},rs=()=>{const[s,t]=F(void 0);return{attack:async(e,i)=>{const n=e.weapon().range()>2,o=e.weapon().range()<=2,l=e.position().distanceTo(i.position())>1,a=e.weapon().damage();o||l&&n?i.takeDamage(a):!l&&n&&i.takeDamage(Math.min(1,Math.floor(a/2))),t({source:e,target:i,type:n&&l?"ranged":"melee"});const h=mt().log;e.id()==="player"&&(h.totalDamageDealt+=a,e.weapon().setUses(e.weapon().uses()+1),o||l&&n?o?mt().log.meleeAttacks+=1:mt().log.rangedAttacks+=1:!l&&n&&(mt().log.meleeAttacks+=1))},isAttacking:()=>s(),clearAttack:()=>{t(void 0)}}};j.registerPlugin(ae);ae.registerPIXI(li);const as=s=>s<=3?1:s<=6?2:s<=10?3:s<=15?4:5,ls=({view:s,saveController:t,onGameLoadRequest:e,onLevelCompleted:i,onGameOver:n})=>{const[d,l]=F(le({model:Ue({id:"dontUse",team:"player",name:"Player",startPosition:{x:0,y:0},startingHealth:10,startingMaxHealth:10,startingItems:[]})}));let c=null,a=null,h=null,r=null,f=null,p=null,u=null,g=null,y=null,v=null,b=null,k=[],E=[],S=null,P=[],_=1,T=null,m=null,x=null,w=!1,C=!1,I={x:0,y:0};const B=()=>{if(!T)throw new Error("Level models are not initialized");return T},L=V=>{T=V;const $=Wi(V);b=$.tileMapVM,l($.playerVM),k=$.npcVMs,E=$.eventVMs,P=$.settlementVMs;const X=rs();f=$i({playerVM:d()}),p=V.fogOfWarViewModel,c=qi({playerVM:d(),npcVMs:k,settlementVMs:P,eventViewModels:E}),u=Un({playerMenuVM:()=>c,playerUiVM:()=>f}),g=Di({model:Ri()}),r=Jn({tileMapVM:b,playerVM:d(),turnVM:g,attackVM:X,addNpc:et=>{m==null||m.addNpc(et),h==null||h.addNpc(et)}}),h=Fn({playerVM:d(),npcs:k,tileMapVM:b,events:E,npcTaskController:r,turnVM:g}),y=os({turnVM:g,playerVM:d(),enemyVMs:k,npcController:h,handleEndUpTurnUpdates:async()=>{await(m==null?void 0:m.handleEndOfTurnUpdates())}});const tt=()=>{d().inventory().getItemByCode("torch")?p==null||p.setToFullLight():p==null||p.setToLowLight()};a=ss({attackVM:X,tileMapViewModel:b,playerViewModel:d(),userInterfaceView:u,playerUiVM:()=>f,onPlayerTurnCompleted:()=>{y==null||y.handlePlayerTurnEnded(),tt()},gameView:()=>m}),m=nn({tileSize:64,playerVM:d(),tileMapVM:b,npcVMs:k,eventVMs:E,settlementVMs:P,attackVM:X}),v=Fi({gameViews:{gameView:m.view,nonSkewedView:m.nonSkewedContainer},userInterfaceView:u.view,fogOfWarVM:p}),S=qn({playerVM:d(),tileMapVM:b})},W=()=>{console.debug("Unloading level..."),x==null||x.destroy(),v==null||v.destroy(),c=null,a=null,h=null,r=null,f=null,p=null,s.detachAll(),u==null||u.destroy(),u=null,g=null,y=null,v=null,b=null,k=[],E=[],S==null||S.destroy(),S=null,P=[],T=null,m==null||m.destroy()},A=()=>{const V=k.filter(tt=>tt.isAlive()),$=k.length-V.length,X=d().position();X&&(_>=as($)||(_++,V.forEach(tt=>{tt.position().distanceTo(X)<5||tt.setMaxHealth(tt.maxHealth()+2)})))},M=()=>{const V=d().position(),$=5;V&&(b==null||b.tiles().forEach(X=>{X.forEach(tt=>{tt.setVisible(Math.abs(tt.position().x-V.x)<=$&&Math.abs(tt.position().y-V.y)<=$)})}),E.forEach(X=>{X.setVisible(Math.abs(X.position().x-V.x)<=$&&Math.abs(X.position().y-V.y)<=$)}),k.forEach(X=>{X.setVisible(Math.abs(X.position().x-V.x)<=$&&Math.abs(X.position().y-V.y)<=$)}),P.forEach(X=>{X.setIsVisible(Math.abs(X.positions()[0].x-V.x)<=$&&Math.abs(X.positions()[0].y-V.y)<=$)}))},N=async()=>{if(!w&&!C){w=!0,a==null||a.handleTradeRequest({action:"autoTrade",trader:{canTrade:()=>!0,inventory:()=>kt({model:Qt([]),ownerName:"Bulk Trader"})}});return}if(w=!1,!C){C=!0,u==null||u.showEndOfLevelLog();return}i(T),await D()},D=async()=>{!v||!u||(J.disableCategory("gameplay"),u.view.visible=!1,await j.to(v.view,{duration:5,alpha:0}),v.view.visible=!1,z(),W())},O=()=>{x=Ni({handleLevelCompleted:N,handleTileInteraction:V=>{a==null||a.handleTileInteraction(V)},handleItemInteraction:(V,$)=>{a==null||a.handleItemInteraction(V,$)},handleEventInteraction:V=>{a==null||a.handleEventInteraction(V,d())},handleCharacterInteraction:V=>{a==null||a.handleCharacterInteraction({character:V,action:"interact"})},onCloseInventoryRequested:()=>{a==null||a.handleCloseInventoryRequest(),w&&N()},handleInventoryRequest:(V,$)=>{a==null||a.handleInventoryRequest(V,$)},handleTradeRequest:V=>{a==null||a.handleTradeRequest({action:V})},handleCharacterInteractionRequest:({character:V,action:$})=>{a==null||a.handleCharacterInteraction({action:$,character:V})},handleSettlementInteractionRequest:({settlement:V,action:$})=>{a==null||a.handleSettlementInteraction({settlement:V,action:$})},handleInGameMenuRequest:V=>{a==null||a.handleInGameMenuRequest(V)},onDebugActionRequested:V=>{S==null||S.handleDebugActionRequest(V)},handleSaveRequest:z,handleLoadRequest:q})},z=()=>{console.debug("Saving game state...");const V=B(),$={...V,tileModels:V.tileMapModel.tiles().map(X=>X.map(tt=>tt))};t.save($),f==null||f.setIsSaveCompleted(!0)},q=()=>{console.debug("Loading game state..."),e();const V=t.load();if(!V){console.warn("No saved game state found.");return}R.emit("ON_PAUSE_INPUT"),W(),Y(V)},Y=V=>{console.debug("Loading level..."),L(V??Fe()),O(),u==null||u.showPlayerMenu(),u==null||u.showPlayerUi(),!(!v||!u)&&(v.view.visible=!1,u.view.visible=!1,s.attachCamera(v),s.attachUi(u),s.resize(innerWidth,innerHeight))},rt=()=>{!v||!u||(J.enableCategory("gameplay"),J.stopMusic({fadeOut:!0}),M(),v.view.visible=!0,u.view.visible=!0,s.resize(innerWidth,innerHeight),v&&v.moveTo(d().position().x*64,d().position().y*64))},nt=V=>{u==null||u.update()};return lt(()=>{ct(()=>{(d().position().x!==I.x||d().position().y!==I.y)&&(M(),A(),I={x:d().position().x,y:d().position().y},v&&v.moveTo(d().position().x*64,d().position().y*64)),d().isAlive()||(console.debug("Player is dead, handling game over..."),j.delayedCall(1,()=>{n(),W()}))})}),{loadLevel:Y,showGameView:rt,update:nt,getState:B}},bs=s=>{const{mainMenuVM:t,view:e,loadingScreenVM:i,saveController:n}=s,o=()=>{i.showLevelLoadScreen(),i.setVisible(!0),setTimeout(()=>{i.setVisible(!1),u.showGameView(),R.emit("ON_RESUME_INPUT")},2e3)},d=()=>{console.debug("Resetting game progress..."),n.clear(),mt().reset()},l=g=>{console.debug("Preparing next level...");const y=Fe();g.playerModel.moveTo(y.playerModel.position().x,y.playerModel.position().y),y.playerModel=g.playerModel;const v=y.playerModel.inventory().items().filter(E=>E.code()==="torch").length,b=Math.max(0,30-v);ee("torch",b).forEach(E=>y.playerModel.inventory().addItem(E));const k=Math.abs(Math.max(-5,y.playerModel.health()-y.playerModel.maxHealth()));return y.playerModel.setHealth(y.playerModel.health()+k),y},c=async g=>{i.showRestScreen(),i.setVisible(!0),await j.delayedCall(8,()=>{u.loadLevel(l(g))}),await j.delayedCall(2,()=>{i.setVisible(!1),u.showGameView()})},a=(g=!1)=>{const y=n.load();g?i.showDebugScreen():y&&i.showLevelLoadScreen(),i.setVisible(!0),t.hide(),u.loadLevel(g?void 0:y);const v=lt(()=>{ct(()=>{i.isVisible()||(u.showGameView(),R.emit("ON_RESUME_INPUT"),v())})})},h=()=>{console.debug("Starting game..."),t.setIsContinueButtonVisible(n.saveExists()),t.show()},r=()=>{console.debug("Exiting game...")},f=g=>{u.update(g)},u=ls({view:e,saveController:n,onGameLoadRequest:o,onLevelCompleted:c,onGameOver:()=>{console.debug("Game Over"),R.emit("ON_PAUSE_INPUT"),i.showGameOverScreen(),i.setVisible(!0);const g=lt(()=>{ct(()=>{i.isVisible()||(t.show(),g())})})}});return{loadLevel:a,initGame:h,exitGame:r,update:f,resetProgress:d}};export{bs as createGameController};
