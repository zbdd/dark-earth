import{g as K}from"./index-CH_iu5NA.js";import{g as zt,h as rt,d as wt,i as oe,j as ze,k as $e,e as si,f as oi,m as ue,A as ri,n as jt}from"./npc-model-DzCMmKA0.js";import{R as Zt,E as ai,a as pt,G as J,j as fe,C as $,P as qe,S as G,T as Mt,d as li,k as ci,l as Et,m as hi}from"./index-DP1GvXT9.js";import{c as ht,S as it}from"./sound-manager-1882LxyM.js";import{c as Q,a as lt}from"./solid-lwVvZ318.js";import{c as Kt,b as xt,a as Fe}from"./modal-view-COh7ggBM.js";const di=(n,t,e)=>{if(n<=0)return;const i=[...t];i.sort((r,d)=>{const a=r.position().distanceTo(e.position()),h=d.position().distanceTo(e.position());return a-h});const s=Math.min(4,Math.floor(i.length/n));for(let r=0;r<n;r++){const d=zt("city-key"),a=Math.floor(Math.random()*100)<=33?0:Math.floor(Math.random()*100)<=66?1:2,h=Math.min(i.length-1,a+Math.floor((r+1)*s)),l=i[h];i.splice(a,1),l.inventory().addItem(d)}},ui=({map:n,rooms:t,pathEnemyChance:e=.2,paths:i})=>{const r=(l,c)=>l>0&&c>0&&l<n.length-1&&c<n[0].length-1,d=(l,c,o,f)=>Math.sqrt((l-o)**2+(c-f)**2),a=(l,c,o)=>o.every(f=>d(f[0],f[1],l,c)>=10),h=[];return t.forEach((l,c)=>{if(c===0)return;const o=Math.floor(Math.random()*2);for(let f=0;f<o;f++){const[p,u]=l[Math.floor(Math.random()*l.length)];r(p,u)&&a(p,u,h)&&h.push([p,u])}}),i.forEach((l,c)=>{c!==0&&l.forEach(([o,f])=>{Math.random()<e&&r(o,f)&&a(o,f,h)&&h.push([o,f])})}),h},fi=({map:n,rooms:t,pathEventChance:e=.1,paths:i})=>{const r=[],d=(h,l)=>h>0&&l>0&&h<n.length-1&&l<n[0].length-1,a=(h,l,c,o)=>Math.sqrt((h-c)**2+(l-o)**2);return t.forEach(h=>{const l=h.length/2,c=Math.floor(Math.random()*l)+2;for(let o=0;o<c;o++){const[f,p]=h[Math.floor(Math.random()*h.length)];if(d(f,p)&&r.every(u=>a(u.position().x,u.position().y,f,p)>=3)){const u=n[f][p];!r.includes(u)&&u.traversable()&&u.type()!=="settlement"&&r.push(u)}}}),i.forEach(h=>{h.forEach(([l,c])=>{if(Math.random()<e&&d(l,c)){const o=n[l][c];!r.includes(o)&&o.type()!=="settlement"&&o.traversable()&&r.every(f=>a(f.position().x,f.position().y,l,c)>=3)&&r.push(o)}})}),r},pe=[rt({id:"ancient-bunker",name:"Ancient Bunker",startPosition:{x:0,y:0},startingItems:[],level:3}),rt({id:"bandit-camp",name:"Bandit Camp",startPosition:{x:0,y:0},startingItems:[],level:4}),rt({id:"beacon",name:"Beacon",startPosition:{x:0,y:0},startingItems:[],level:2}),rt({id:"bear-cage",name:"Bear Cage",startPosition:{x:0,y:0},startingItems:[],level:4}),rt({id:"bunker",name:"Bunker",startPosition:{x:0,y:0},startingItems:[],level:2}),rt({id:"campfire",name:"Campfire",startPosition:{x:0,y:0},startingItems:[],level:2}),rt({id:"cave",name:"Cave",startPosition:{x:0,y:0},startingItems:[],level:3}),rt({id:"chest",name:"Chest",startPosition:{x:0,y:0},startingItems:[],level:1}),rt({id:"church",name:"Church",startPosition:{x:0,y:0},startingItems:[],level:2}),rt({id:"crashed-plane",name:"Crashed Plane",startPosition:{x:0,y:0},startingItems:[],level:3}),rt({id:"fungi",name:"Fungi",startPosition:{x:0,y:0},startingItems:[],level:1}),rt({id:"tent",name:"Tent",startPosition:{x:0,y:0},startingItems:[],level:2}),rt({id:"lean-to",name:"Lean-To",startPosition:{x:0,y:0},startingItems:[],level:2}),rt({id:"ruin",name:"Ruin",startPosition:{x:0,y:0},startingItems:[],level:4}),rt({id:"scary-tree",name:"Scary Tree",startPosition:{x:0,y:0},startingItems:[],level:1}),rt({id:"silo",name:"Silo",startPosition:{x:0,y:0},startingItems:[],level:3}),rt({id:"sword-in-stone",name:"Monument",startPosition:{x:0,y:0},startingItems:[],level:5}),rt({id:"wagon",name:"Wagon",startPosition:{x:0,y:0},startingItems:[],level:1}),rt({id:"wreck",name:"Wreck",startPosition:{x:0,y:0},startingItems:[],level:1})],pi=()=>{const n=Math.floor(Math.random()*pe.length);return pe[n]},mi=n=>n.map(t=>{const e=pi();return rt({id:e.id(),name:e.name(),startPosition:{x:t.position().x,y:t.position().y},level:e.level(),startingItems:[]})}),gi=(n,t)=>{const e=(h,l)=>{const c=[],o=Math.abs(l.position.x-h.position.x),f=Math.abs(l.position.y-h.position.y),p=h.position.x<l.position.x?1:-1,u=h.position.y<l.position.y?1:-1;let g=o-f,v=h.position.x,m=h.position.y;for(;v!==l.position.x||m!==l.position.y;){c.push([v,m]);const b=g*2;b>-f&&(g-=f,v+=p),b<o&&(g+=o,m+=u)}return c},i=(h,l,c,o)=>{const f=h[h.length-1],[p,u]=f;for(const g of o){if(c.has(g.id))continue;if(Math.hypot(g.position.x-p,g.position.y-u)>3){const m=e({position:{x:p,y:u}},g);l.push(m),c.add(g.id);break}}},s=(h,l)=>{let c=null,o=1/0;for(const f of n){if(l.has(f.id))continue;const p=Math.hypot(f.position.x-h.position.x,f.position.y-h.position.y);p<o&&p<t&&(c=f,o=p)}return c},r=[],d=new Set;let a=n[0];for(d.add(a.id);d.size<n.length;){let h=s(a,d);if(!h){const l=Array.from(d).map(c=>n.find(o=>o.id===c));for(;l.length>0;){const c=l.pop();if(h=s(c,d),h){a=c;break}}h||(h=n.find(c=>!d.has(c.id))||null)}if(h){const l=e(a,h);r.push(l),d.add(h.id),a=h,l.length>7&&i(l,r,d,n)}else break}return r},yi=(n,t,e,i={min:2,max:4})=>{const s=n.length,r=n[0].length,d=[],a=(c,o)=>c>=0&&o>=0&&c<s&&o<r,h=(c,o,f)=>f.every(([p,u])=>{const g=c+p,v=o+u;if(!a(g,v))return!1;for(let m=-1;m<=1;m++)for(let b=-1;b<=1;b++){const x=g+m,A=v+b;if(a(x,A)&&n[x][A].type()!=="void")return!1}return!0}),l=c=>{const o=[];switch(Math.floor(Math.random()*4)){case 0:for(let g=-c;g<=c;g++)for(let v=-c;v<=c;v++)g*g+v*v<=c*c&&o.push([g,v]);break;case 1:for(let g=-c;g<=c+2;g++)for(let v=-c;v<=c;v++)(g*g+v*v<=c*c||Math.abs(g)<c&&Math.abs(v)<c)&&o.push([g,v]);break;case 2:for(let g=-c;g<=c;g++)for(let v=-c;v<=c;v++)(g*g+v*v<=c*c&&Math.random()>.5||Math.abs(g)<c&&Math.abs(v)<c&&Math.random()>.5)&&o.push([g,v]);break;case 3:const p=c*2,u=Math.floor(c/2);for(let g=-p;g<=p;g++)for(let v=-u;v<=u;v++)o.push([g,v]);break}return o};return t.forEach(c=>{const o=Math.floor(Math.random()*(i.max-i.min+1)+i.min),f=l(o),p=[];h(c.position.x,c.position.y,f)&&f.forEach(([u,g])=>{const v=c.position.x+u,m=c.position.y+g;a(v,m)&&(n[v][m]=wt({terrain:"wasteland",position:{x:v,y:m}}),p.push([v,m]))}),p.length>0&&d.push(p)}),e.forEach(c=>{c.forEach(([o,f])=>{for(let p=-Math.floor(Math.random()*2);p<=Math.floor(Math.random()*2);p++)for(let u=-Math.floor(Math.random()*2);u<=Math.floor(Math.random()*2);u++){const g=o+p,v=f+u;a(g,v)&&n[g][v].type()!=="wasteland"&&(n[g][v]=wt({terrain:"grass",position:{x:g,y:v}}))}})}),{map:n,rooms:d}},vi=(n,t)=>Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2)),wi=n=>{const{horizontalTiles:t,verticalCells:e,nodeCount:i,minDistanceBetweenNodes:s,maxAttemptsToAssignNode:r}=n,d=[],a=Math.ceil(Math.sqrt(i)),h=Math.floor(t/a),l=Math.floor(e/a),c=(o,f)=>d.every(p=>Math.abs(vi(p.position,{x:o,y:f}))>=s);for(let o=0;o<i;o++){let f=0,p=!1;for(;f<r&&!p;){const u=Math.floor(o%a)*h,g=Math.floor(o/a)*l;let v=u+Math.floor(Math.random()*h),m=g+Math.floor(Math.random()*l);v=Math.max(3,Math.min(t-3,v)),m=Math.max(3,Math.min(e-3,m)),v<t&&m<e&&c(v,m)?(d.push({id:`node-${o}`,position:{x:v,y:m}}),p=!0):f++}p||d.pop()&&o--}return d},bi=n=>{const{startPosition:t}=n,e=[...oe("torch",30),...oe("coin",3)],i=[],s=[...e,...i];return ze({name:"Hero",id:"player",startPosition:t,startingItems:s,team:"player"})},Ge=()=>{const n=wi({horizontalTiles:64,verticalCells:64,nodeCount:80,minDistanceBetweenNodes:7,maxAttemptsToAssignNode:100}),t=gi(n,15),{map:e,rooms:i}=yi(Array.from({length:64},(m,b)=>Array.from({length:64},(x,A)=>wt({terrain:"void",position:{x:b,y:A}}))),n,t,{min:2,max:4});(m=>{const b=m.flat().filter(D=>D.type()==="void"),x=Math.floor(30);let A=0,M=0;for(let D=0;D<x&&(D>0&&b.splice(M,1),!(A>1e4||(A++,b.length===0)));D++){M=Math.floor(Math.random()*b.length);const{x:E,y:I}=b[M].position(),_=new Zt(E,I,Math.floor(Math.random()*3)+1,Math.floor(Math.random()*3)+1);let P=!0;for(let y=-_.width;y<=_.width;y++){for(let T=-_.height;T<=_.height;T++){const V=E+y,N=I+T;if(!(V<0||N<0||V>=m.length||N>=m[0].length)&&m[V][N].type()!=="void"){P=!1;break}}if(!P)break}if(P)for(let y=-_.width;y<=_.width;y++)for(let T=-_.height;T<=_.height;T++){const V=E+y,N=I+T;V<0||N<0||V>=m.length||N>=m[0].length||(m[V][N]=wt({terrain:"water",position:{x:V,y:N}}))}}})(e);const d=ui({map:e,rooms:i,paths:t,pathEnemyChance:.2}).map(m=>$e({id:"bandit",name:"Bandit",team:"hostile-to-all",startPosition:{x:m[0],y:m[1]},startingItems:[],startingHealth:2})),a=m=>{m[0].map(b=>wt({terrain:"mountain",position:b.position()})),m[m.length-1].map(b=>wt({terrain:"mountain",position:b.position()})),m.forEach(b=>{wt({terrain:"mountain",position:b[0].position()}),wt({terrain:"mountain",position:b[b.length-1].position()})})},h=["settlement","large-settlement","sanctuary","citadel"],l=(m,b)=>{const{x,y:A}=m,M=[{x,y:A},{x:x+1,y:A},{x,y:A+1},{x:x+1,y:A+1}];return M.forEach(D=>{b[D.x]&&b[D.x][D.y]&&(b[D.x][D.y]=wt({terrain:"settlement",position:D}))}),ue({id:h.shift()??"settlement",name:`Settlement at (${x}, ${A})`,level:1,positions:M})};function c(m,b){const x=[];return m.forEach((A,M)=>{const{x:D,y:E}=A.position,I=!0;if(M===0){x.push(l({x:D,y:E},b));return}D<b.length-1&&E<b[0].length-1&&I?x.push(l({x:D,y:E},b)):(b[D][E]=wt({terrain:"settlement",position:{x:D,y:E}}),x.push(ue({id:h.shift()??"settlement",name:`Settlement ${M+1}`,level:1,positions:[{x:D,y:E}]})))}),x}const f=((m,b,x)=>{const A=[],M=new Set,D=E=>{const I=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],_=I[Math.floor(Math.random()*I.length)];return{x:E.position.x+_.x,y:E.position.y+_.y}};for(A.push({id:m[0].id,position:D(m[0])});A.length<b&&A.length<m.length&&M.size<m.length;){const E=Math.floor(Math.random()*m.length),I=m[E],_=`${I.position.x},${I.position.y}`;if(M.has(_))continue;let P=!0;for(const y of A)if(Math.sqrt(Math.pow(I.position.x-y.position.x,2)+Math.pow(I.position.y-y.position.y,2))<x){P=!1;break}P&&(A.push(I),M.add(_))}return A})(n,3,5),p=c(f,e);a(e);const u=fi({map:e,rooms:i,paths:t,pathEventChance:.1}),g=mi(u),v=bi({startPosition:n[0].position});return di(p.length,d,v),{playerModel:v,tileMapModel:oi(e),npcModels:d,eventModels:g,settlementModels:p,fogOfWarViewModel:si()}};/*!
 * PixiPlugin 3.13.0
 * https://gsap.com
 *
 * @license Copyright 2008-2025, GreenSock. All rights reserved.
 * Subject to the terms at https://gsap.com/standard-license
 * @author: Jack Doyle, jack@greensock.com
*/var It,Jt,me,yt,Ut,Ye,re,ee,Qe=function(){return typeof window<"u"},Xe=function(){return It||Qe()&&(It=window.gsap)&&It.registerPlugin&&It},ae=function(t){return typeof t=="function"},je=function(t){return console.warn(t)},xi=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],vt=.212671,mt=.71516,gt=.072169,Ze=function(t){return ae(yt[t])?yt[t]:yt.filters[t]},ie=function(t,e){var i=[],s=0,r=0,d,a;for(d=0;d<4;d++){for(a=0;a<5;a++)r=a===4?t[s+4]:0,i[s+a]=t[s]*e[a]+t[s+1]*e[a+5]+t[s+2]*e[a+10]+t[s+3]*e[a+15]+r;s+=5}return i},ge=function(t,e){var i=1-e,s=i*vt,r=i*mt,d=i*gt;return ie([s+e,r,d,0,0,s,r+e,d,0,0,s,r,d+e,0,0,0,0,0,1,0],t)},ye=function(t,e,i){var s=Jt(e),r=s[0]/255,d=s[1]/255,a=s[2]/255,h=1-i;return ie([h+i*r*vt,i*r*mt,i*r*gt,0,0,i*d*vt,h+i*d*mt,i*d*gt,0,0,i*a*vt,i*a*mt,h+i*a*gt,0,0,0,0,0,1,0],t)},ve=function(t,e){e*=Math.PI/180;var i=Math.cos(e),s=Math.sin(e);return ie([vt+i*(1-vt)+s*-vt,mt+i*-mt+s*-mt,gt+i*-gt+s*(1-gt),0,0,vt+i*-vt+s*.143,mt+i*(1-mt)+s*.14,gt+i*-gt+s*-.283,0,0,vt+i*-vt+s*-.787329,mt+i*-mt+s*mt,gt+i*(1-gt)+s*gt,0,0,0,0,0,1,0,0,0,0,0,1],t)},we=function(t,e){return ie([e,0,0,0,.5*(1-e),0,e,0,0,.5*(1-e),0,0,e,0,.5*(1-e),0,0,0,1,0],t)},Ke=function(t,e){var i=Ze(e),s=t.filters||[],r=s.length,d;for(i||je(e+" not found. PixiPlugin.registerPIXI(PIXI)");--r>-1;)if(s[r]instanceof i)return s[r];return d=new i,e==="BlurFilter"&&(ee?d.strength=0:d.blur=0),t.filters=[].concat(s,[d]),d},ct=function(t,e,i,s){e.add(i,t,i[t],s[t]),e._props.push(t)},be=function(t,e){var i=Ze("ColorMatrixFilter"),s=new i;return s.matrix=e,s.brightness(t,!0),s.matrix},Ci=function(t){var e={},i;for(i in t)e[i]=t[i];return e},ft={contrast:1,saturation:1,colorizeAmount:0,colorize:"rgb(255,255,255)",hue:0,brightness:1},Ti=function(t,e,i){var s=Ke(t,"ColorMatrixFilter"),r=t._gsColorMatrixFilter=t._gsColorMatrixFilter||Ci(ft),d=e.combineCMF&&!("colorMatrixFilter"in e&&!e.colorMatrixFilter),a,h,l;for(l=s.matrix,e.resolution&&(s.resolution=e.resolution),e.matrix&&e.matrix.length===l.length?(h=e.matrix,r.contrast!==1&&ct("contrast",i,r,ft),r.hue&&ct("hue",i,r,ft),r.brightness!==1&&ct("brightness",i,r,ft),r.colorizeAmount&&(ct("colorize",i,r,ft),ct("colorizeAmount",i,r,ft)),r.saturation!==1&&ct("saturation",i,r,ft)):(h=xi.slice(),e.contrast!=null?(h=we(h,+e.contrast),ct("contrast",i,r,e)):r.contrast!==1&&(d?h=we(h,r.contrast):ct("contrast",i,r,ft)),e.hue!=null?(h=ve(h,+e.hue),ct("hue",i,r,e)):r.hue&&(d?h=ve(h,r.hue):ct("hue",i,r,ft)),e.brightness!=null?(h=be(+e.brightness,h),ct("brightness",i,r,e)):r.brightness!==1&&(d?h=be(r.brightness,h):ct("brightness",i,r,ft)),e.colorize!=null?(e.colorizeAmount="colorizeAmount"in e?+e.colorizeAmount:1,h=ye(h,e.colorize,e.colorizeAmount),ct("colorize",i,r,e),ct("colorizeAmount",i,r,e)):r.colorizeAmount&&(d?h=ye(h,r.colorize,r.colorizeAmount):(ct("colorize",i,r,ft),ct("colorizeAmount",i,r,ft))),e.saturation!=null?(h=ge(h,+e.saturation),ct("saturation",i,r,e)):r.saturation!==1&&(d?h=ge(h,r.saturation):ct("saturation",i,r,ft))),a=h.length;--a>-1;)h[a]!==l[a]&&i.add(l,a,l[a],h[a],"colorMatrixFilter");i._props.push("colorMatrixFilter")},Ii=function(t,e){var i=e.t,s=e.p,r=e.color,d=e.set;d(i,s,r[0]<<16|r[1]<<8|r[2])},ki=function(t,e){var i=e.g;ee?(i.fill(),i.stroke()):i&&(i.dirty++,i.clearDirty++)},Mi=function(t,e){e.t.visible=!!e.t.alpha},xe=function(t,e,i,s){var r=t[e],d=Jt(ae(r)?t[e.indexOf("set")||!ae(t["get"+e.substr(3)])?e:"get"+e.substr(3)]():r),a=Jt(i);s._pt=new Ut(s._pt,t,e,0,0,Ii,{t,p:e,color:d,set:Ye(t,e)}),s.add(d,0,d[0],a[0]),s.add(d,1,d[1],a[1]),s.add(d,2,d[2],a[2])},_i={tint:1,lineColor:1,fillColor:1,strokeColor:1},Ce="position,scale,skew,pivot,anchor,tilePosition,tileScale".split(","),le={x:"position",y:"position",tileX:"tilePosition",tileY:"tilePosition"},Ei={colorMatrixFilter:1,saturation:1,contrast:1,hue:1,colorize:1,colorizeAmount:1,brightness:1,combineCMF:1},te=Math.PI/180,Je=function(t){return typeof t=="string"},Si=function(t){return Je(t)&&t.charAt(1)==="="?t.substr(0,2)+parseFloat(t.substr(2))*te:t*te},Ai=function(t,e){return e.set(e.t,e.p,t===1?e.e:Math.round((e.s+e.c*t)*1e5)/1e5,e)},Pi=function(t,e,i,s,r,d){var a=360*(d?te:1),h=Je(r),l=h&&r.charAt(1)==="="?+(r.charAt(0)+"1"):0,c=parseFloat(l?r.substr(2):r)*(d?te:1),o=l?c*l:c-s,f=s+o,p,u;return h&&(p=r.split("_")[1],p==="short"&&(o%=a,o!==o%(a/2)&&(o+=o<0?a:-a)),p==="cw"&&o<0?o=(o+a*1e10)%a-~~(o/a)*a:p==="ccw"&&o>0&&(o=(o-a*1e10)%a-~~(o/a)*a)),t._pt=u=new Ut(t._pt,e,i,s,o,Ai),u.e=f,u},Te=function(){if(!me){It=Xe(),yt=me=yt||Qe()&&window.PIXI;var t=yt&&yt.VERSION&&parseFloat(yt.VERSION.split(".")[0])||0;re=t===4,ee=t>=8,Jt=function(i){return It.utils.splitColor((i+"").substr(0,2)==="0x"?"#"+i.substr(2):i)}}},Qt,St;for(Qt=0;Qt<Ce.length;Qt++)St=Ce[Qt],le[St+"X"]=St,le[St+"Y"]=St;var ce={version:"3.13.0",name:"pixi",register:function(t,e,i){It=t,Ut=i,Ye=e.getSetter,Te()},headless:!0,registerPIXI:function(t){yt=t},init:function(t,e,i,s,r){if(yt||Te(),!yt)return je("PIXI was not found. PixiPlugin.registerPIXI(PIXI);"),!1;var d,a,h,l,c,o,f,p,u,g;for(o in e){if(d=le[o],h=e[o],d)a=~o.charAt(o.length-1).toLowerCase().indexOf("x")?"x":"y",this.add(t[d],a,t[d][a],d==="skew"?Si(h):h,0,0,0,0,0,1);else if(o==="scale"||o==="anchor"||o==="pivot"||o==="tileScale")this.add(t[o],"x",t[o].x,h),this.add(t[o],"y",t[o].y,h);else if(o==="rotation"||o==="angle")Pi(this,t,o,t[o],h,o==="rotation");else if(Ei[o])l||(Ti(t,e.colorMatrixFilter||e,this),l=!0);else if(o==="blur"||o==="blurX"||o==="blurY"||o==="blurPadding"){if(c=Ke(t,"BlurFilter"),this.add(c,o,c[o],h),e.blurPadding!==0)for(f=e.blurPadding||Math.max(c[o],h)*2,p=t.filters.length;--p>-1;)t.filters[p].padding=Math.max(t.filters[p].padding,f)}else if(_i[o])if((o==="lineColor"||o==="fillColor"||o==="strokeColor")&&t instanceof yt.Graphics)for(u=("fillStyle"in t)?[t]:(t.geometry||t).graphicsData,g=o.substr(0,o.length-5),ee&&g==="line"&&(g="stroke"),this._pt=new Ut(this._pt,t,o,0,0,ki,{g:t.geometry||t}),p=u.length;--p>-1;)xe(re?u[p]:u[p][g+"Style"],re?o:"color",h,this);else xe(t,o,h,this);else o==="autoAlpha"?(this._pt=new Ut(this._pt,t,"visible",0,0,Mi),this.add(t,"alpha",t.alpha,h),this._props.push("alpha","visible")):o!=="resolution"&&this.add(t,o,"get",h);this._props.push(o)}}};Xe()&&It.registerPlugin(ce);const R=new ai,Ni=n=>{let t=!1;return R.on("ON_INFO_MODAL_OPEN",e=>{t&&(n.handleAnyEvent(),n.handleInfoModalOpenRequest(e))}),R.on("ON_INFO_MODAL_CLOSE",()=>{n.handleInfoModalCloseRequest()}),R.on("ON_PAUSE_INPUT",()=>{t=!1,n.handleAnyEvent()}),R.on("ON_RESUME_INPUT",()=>{t=!0}),R.on("ON_LEVEL_COMPLETED",()=>{n.handleAnyEvent(),n.handleLevelCompleted()}),R.on("ON_TILE_INTERACTION",({tileViewModel:e})=>{t&&(n.handleAnyEvent(),n.handleTileInteraction(e))}),R.on("ON_ITEM_INTERACTION",({itemViewModel:e,action:i})=>{t&&(n.handleAnyEvent(),n.handleItemInteraction(e,i))}),R.on("ON_EVENT_INTERACTION",({eventViewModel:e})=>{t&&(n.handleAnyEvent(),n.handleEventInteraction(e))}),R.on("ON_CHARACTER_INTERACTION",({characterViewModel:e})=>{t&&(n.handleAnyEvent(),n.handleCharacterInteraction(e))}),R.on("ON_INVENTORY_REQUEST",({inventory:e,action:i})=>{t&&(n.handleAnyEvent(),n.handleInventoryRequest(e,i))}),R.on("ON_CLOSE_INVENTORY_REQUESTED",()=>{t&&(n.handleAnyEvent(),n.onCloseInventoryRequested())}),R.on("ON_TRADE_REQUEST",({action:e})=>{t&&(n.handleAnyEvent(),n.handleTradeRequest(e))}),R.on("ON_CHARACTER_INTERACTION_REQUEST",e=>{t&&(n.handleAnyEvent(),n.handleCharacterInteractionRequest(e))}),R.on("ON_SETTLEMENT_INTERACTION_REQUEST",e=>{t&&(n.handleAnyEvent(),n.handleSettlementInteractionRequest(e))}),R.on("ON_SAVE_REQUEST",()=>{n.handleSaveRequest()}),R.on("ON_LOAD_REQUEST",()=>{n.handleLoadRequest()}),R.on("ON_IN_GAME_MENU_REQUEST",({action:e})=>{n.handleAnyEvent(),n.handleInGameMenuRequest(e)}),R.on("ON_DEBUG_ACTION_REQUESTED",({action:e})=>{t&&n.onDebugActionRequested(e)}),{destroy:()=>{R.removeAllListeners()}}},Oi=()=>{const[n,t]=Q(0),[e,i]=Q(480);return{getCurrentTurn:()=>n(),getGameTimeMin:()=>e(),nextTurn:()=>{t(a=>a+1),i(a=>{const h=a+10;return h>=1440?0:h})}}},$t=n=>{const{model:t}=n,[e,i]=Q(t.armour()>0),[s,r]=Q(t.armour()<t.maxArmour()),[d,a]=Q(t.damage()>0),[h,l]=Q(t.health()>0),c={code:()=>t.code(),name:()=>t.name(),description:()=>t.description(),quantity:()=>t.quantity(),value:()=>t.value(),updateQuantity:o=>{t.updateQuantity(o)},level:()=>t.level(),interact:()=>{R.emit("ON_ITEM_INTERACTION",{itemViewModel:c})},health:()=>t.health(),type:()=>t.type(),damage:()=>t.damage(),range:()=>t.range(),armour:()=>t.armour(),setArmour:o=>{t.setArmour(o)},maxArmour:()=>t.maxArmour(),id:()=>t.id(),isArmourIconVisible:()=>e(),isDamagedArmourIconVisible:()=>s(),isHealthIconVisible:()=>h(),setIsArmourIconVisible:o=>{i(o)},setIsDamagedArmourIconVisible:o=>{r(o)},setIsHealthIconVisible:o=>{l(o)},isDamageIconVisible:()=>d(),setIsDamageIconVisible:o=>{a(o)},uses:()=>t.uses(),setUses:o=>{t.setUses(o)},collected:()=>t.collected(),setCollected:o=>{t.setCollected(o)}};return c},kt=n=>{const{model:t,ownerName:e,owner:i}=n,[s,r]=Q([]),[d,a]=Q(!1),h=o=>$t({model:o}),l=(o,f)=>{const p=o.code()===f.code(),u=o.armour()===f.armour(),g=o.damage()===f.damage();return p&&u&&g},c={items:()=>t.items().map(o=>h(o)),stacks:()=>s(),setStacks:()=>{const o=[],f=[];c.items().forEach(p=>{if(i&&i.isEquipped(p)){f.push({item:p,quantity:1});return}const u=o.find(g=>l(g.item,p));u?u.quantity+=p.quantity():o.push({item:p,quantity:p.quantity()})}),o.sort((p,u)=>u.item.type()==="currency"&&p.item.type()!=="currency"?1:u.item.type()!=="currency"&&p.item.type()==="currency"?-1:u.item.type()==="light"&&p.item.type()!=="light"?1:u.item.type()!=="light"&&p.item.type()==="light"?-1:u.item.armour()>0&&p.item.armour()<=0?1:u.item.armour()<=0&&p.item.armour()>0?-1:u.item.damage()>0&&p.item.damage()<=0?1:u.item.damage()<=0&&p.item.damage()>0?-1:u.item.health()>0&&p.item.health()<=0?1:u.item.health()<=0&&p.item.health()>0?-1:u.item.type()==="loot"&&p.item.type()!=="loot"?1:u.item.type()!=="loot"&&p.item.type()==="loot"?-1:p.item.name().localeCompare(u.item.name())),r(f.concat(o))},ownerName:()=>e,getItem:o=>c.items().find(f=>l(f,o)),getItemByCode:o=>c.items().find(f=>f.code()===o),getItemByName:o=>c.items().find(f=>f.name()===o),addItem:o=>{t.addItem(zt(o.code(),{id:()=>o.id()})),c.setStacks()},removeItem:o=>{t.removeItem(o),c.setStacks(),!o.collected()&&(!i||!i.isAlive())&&!["trade-npc","trade","settlement","hero"].includes(e.toLowerCase())&&["trade-npc","trade","settlement","hero"].filter(f=>e.toLowerCase().includes(f)).length===0&&(o.setCollected(!0),pt().log.collectedItemsValue+=o.value())},owner:i,isEmpty:()=>t.isEmpty(),isOnlyLoot:()=>t.isOnlyLoot(),isInfoButtonEnabled:()=>d(),setInfoButtonEnabled:o=>{a(o)}};return c.setStacks(),ht(()=>{lt(()=>{c.setStacks()})}),c},he=n=>{const{model:t}=n,[e,i]=Q(kt({model:t.inventory(),ownerName:t.name()})),s=a=>{if(!a)throw new Error("Item cannot be undefined");const h=t.inventory().getItemById(a.id());if(!h)throw new Error(`Item with code ${a.id()} not found in inventory`);return h},r=a=>{if(!a)throw new Error("Item cannot be undefined");return $t({model:a})},d={id:()=>t.id(),name:()=>t.name(),setInventory:a=>{i(a)},size:()=>t.size(),position:()=>({...t.position(),distanceTo:a=>{const h=t.position().x-a.x,l=t.position().y-a.y;return Math.floor(Math.sqrt(h*h+l*l))}}),health:()=>t.health(),maxHealth:()=>t.maxHealth(),moveTo:(a,h)=>{d.isAlive()&&t.moveTo(a,h)},dialogue:()=>t.dialogue(),isHostile:a=>t.isHostile(a),move:(a,h)=>{const l=t.position(),c=l.x+a,o=l.y+h;t.moveTo(c,o)},team:()=>t.team(),updateTeam:a=>{t.updateTeam(a)},inventory:()=>e(),armour:()=>{var c,o,f;const a=((c=t.bodyArmour())==null?void 0:c.armour())??0,h=((o=t.headArmour())==null?void 0:o.armour())??0,l=((f=t.feetArmour())==null?void 0:f.armour())??0;return a+h+l},takeDamage:a=>{let h=a;new Array(a).fill(0).forEach(()=>{const c=[t.bodyArmour(),t.headArmour(),t.feetArmour()].filter(o=>o&&o.armour()>0);if(c.length!==0){const o=c[Math.floor(Math.random()*c.length)];o.setArmour(o.armour()-1),h--}}),t.id()==="player"&&(pt().log.totalDamageAbsorbed+=a-h,pt().log.totalDamageTaken+=h);const l=t.health()-h;t.setHealth(l)},setHealth:a=>{t.setHealth(a)},setMaxHealth:a=>{t.setMaxHealth(a)},isAlive:()=>t.health()>0,visible:()=>t.visible(),setVisible:a=>{t.setVisible(a)},bodyArmour:()=>r(t.bodyArmour()),setBodyArmour:a=>{a?t.setBodyArmour(s(a)):t.setBodyArmour(void 0)},headArmour:()=>r(t.headArmour()),setHeadArmour:a=>{a?t.setHeadArmour(s(a)):t.setHeadArmour(void 0)},feetArmour:()=>r(t.feetArmour()),setFeetArmour:a=>{a?t.setFeetArmour(s(a)):t.setFeetArmour(void 0)},weapon:()=>{const a=t.weapon();return $t({model:a})},setWeapon:a=>{a?t.setWeapon(s(a)):t.setWeapon(void 0)},isEquipped:a=>{var h,l,c,o;return((h=t.weapon())==null?void 0:h.id())===a.id()||((l=t.bodyArmour())==null?void 0:l.id())===a.id()||((c=t.headArmour())==null?void 0:c.id())===a.id()||((o=t.feetArmour())==null?void 0:o.id())===a.id()}};return i(kt({model:t.inventory(),ownerName:t.name(),owner:d})),d},Ri=n=>{const{eventModel:t}=n;return{...t,inventory:()=>kt({model:t.inventory(),ownerName:t.name()})}},Vi=n=>n.tile,Li=n=>{const{model:t}=n,e=s=>Vi({tile:s});return{isValidMove:(s,r)=>t.isValidMove(s,r),entryPoints:()=>t.entryPoints().map(s=>e(s)),tiles:()=>t.tiles().map(s=>s.map(r=>e(r))),updateTile:(s,r,d)=>{t.tiles()[s][r]=d},getNeighbors:s=>{var l;const r=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],d=[],a=s.position().x,h=s.position().y;for(const{dx:c,dy:o}of r){const f=a+c,p=h+o,u=(l=t.tiles()[f])==null?void 0:l[p];u&&d.push(e(u))}return d}}},ti=n=>{const[t,e]=Q([]),[i,s]=Q(null),[r,d]=Q([]),[a,h]=Q(null),[l,c]=Q(null),[o,f]=Q(!1);return{...he({model:n}),setLastSpawned:u=>n.setLastTurnSpawned(u),lastSpawned:()=>n.lastTurnSpawned(),spawnLing:()=>n.spawnling(),getPatrolArea:()=>t(),setPatrolArea:u=>e(u),getTask:()=>i(),setTask:u=>s(u),getTaskList:()=>r(),setTaskList:u=>d(u),getBedLocation:()=>a(),setBedLocation:u=>h(u),getTarget:()=>l(),setTarget:u=>c(u),canTrade:()=>o(),setCanTrade:u=>f(u)}},Bi=n=>{const{model:t}=n,[e,i]=Q(!0);return{id:()=>t.id(),name:()=>t.name(),level:()=>t.level(),positions:()=>t.positions(),isVisible:()=>e(),setIsVisible:s=>i(s),isUnlocked:()=>t.isUnlocked(),setIsUnlocked:s=>t.setIsUnlocked(s),inventory:()=>kt({model:t.inventory(),ownerName:t.name()}),getMiddleTopPosition:()=>{const s=t.positions();if(s.length===0)return{x:0,y:0};const r=Math.max(...s.map(a=>a.x)),d=Math.min(...s.map(a=>a.y));return{x:(r-s[0].x)/2+s[0].x,y:d}}}},Di=n=>{const{playerModel:t,tileMapModel:e,npcModels:i,eventModels:s,settlementModels:r,fogOfWarViewModel:d}=n,a=he({model:t}),h=Li({model:e}),l=i.map(f=>ti(f)),c=s.map(f=>Ri({eventModel:f})),o=r.map(f=>Bi({model:f}));return{playerVM:a,tileMapVM:h,npcVMs:l,eventVMs:c,settlementVMs:o,fogOfWarViewModel:d}},Wi=n=>{const{model:t}=n;return{getCurrentTurn:()=>t.getCurrentTurn(),nextTurn:()=>{t.nextTurn()},getCurrentClocktime:()=>{const e=t.getGameTimeMin(),i=Math.floor(e/60),s=e%60;return`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},getCurrentTimeMin:()=>t.getGameTimeMin()}},bt=(n,t)=>Math.floor(Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))),Hi=(n,t)=>{let e=[];for(const i of t){const s=i.position(),r=bt(n,s);e.length===0||r<e[0].distance?e=[{npc:i,distance:r}]:r===e[0].distance&&e.push({npc:i,distance:r})}return e},Ui=(n,t)=>{let e=null,i=1/0;for(const s of t)s.positions().forEach(r=>{const d=bt(n,r);d<i&&(i=d,e=s)});return e},zi=(n,t)=>{let e=null,i=1/0;for(const s of t){const r=s.position(),d=bt(n,r);d<i&&(i=d,e=s)}return e},$i=({playerVM:n,npcVMs:t,settlementVMs:e,eventViewModels:i})=>{const[s,r]=Q(!0),[d,a]=Q(null),[h,l]=Q(null),[c,o]=Q(null),[f,p]=Q(null),[u,g]=Q(null),[v,m]=Q(null),[b,x]=Q(null),[A,M]=Q(null),[D,E]=Q(null),[I,_]=Q(null),P=1;let y=null,T=null,V=null,N=null,B=null,C,k=null,w=null,L=null,U=null;const O=(z,X)=>{if(X){const nt=X.position();if(bt(z,nt)<=P)return y=X,!0}return!1},W=(z,X)=>{if(!X)return x(null),!1;const nt=X.position();return bt(z,nt)<=P&&(!X.discovered()||!X.inventory().isEmpty())?(V=X,!0):!1},q=z=>z.isUnlocked()||!n.inventory().items().some(X=>X.code()==="city-key")?!1:(w=z,!0),et=z=>z.isUnlocked()&&!z.inventory().isEmpty()?(L=z,!0):!1,Z=z=>z.isUnlocked()?(U=z,!0):!1,at=z=>{const X=Ui(z,e);return X&&X.positions().forEach(nt=>{if(bt(z,nt)<=P)return q(X),et(X),Z(X),L||(N=X),!0}),!1},ot=(z,X)=>{if(X){const nt=X.position(),st=bt(z,nt);if(st<=n.weapon().range()&&st<=2&&!Y(z,X))return B=X,!0}return!1},Y=(z,X)=>{if(X){const nt=X.position(),st=bt(z,nt);if(st<=n.weapon().range()&&n.weapon().range()>2&&st>1)return k=X,!0}return!1},S=z=>{const X=n.position();return bt(X,z.position)<=P&&z.inventory.isEmpty()===!1?(C=z.inventory,!0):!1},F=z=>{if(z){const X=n.position(),nt=z.position();if(bt(X,nt)<=P&&z.canTrade())return T=z,!0}return!1},H=z=>{if(z.isHostile(n.team())){if(z.isAlive()){const X=ot(n.position(),z),nt=Y(n.position(),z);return X||nt}else if(z.inventory().isEmpty()===!1)return S({position:z.position(),inventory:z.inventory()})}else return z.isAlive()?(O(n.position(),z),F(z)):S({position:z.position(),inventory:z.inventory()});return!1},j=()=>{y=null,T=null,V=null,N=null,B=null,C=null,k=null,w=null,L=null,U=null},dt=()=>{d()!==y&&a(y),h()!==T&&l(T),b()!==V&&x(V),c()!==N&&o(N),f()!==B&&p(B),v()!==C&&m(C),h()!==T&&l(T),u()!==k&&g(k),A()!==w&&M(w),D()!==L&&E(L),I()!==U&&_(U)},Ct=()=>{const z=n.position(),X=Hi(z,t),nt=zi(z,i);if(j(),X.length>0)for(let st=0;st<X.length;st++){const ni=X[st].npc;if(H(ni))break}W(z,nt),at(z),dt()};return Ct(),ht(()=>{lt(()=>{Ct()})}),{isVisible:s,setVisibility:z=>r(z),canUnlockSettlement:A,canInteractWithCharacter:d,canAttackCharacter:f,canTradeWithCharacter:h,canVisitSettlement:c,canSearch:b,canLoot:v,canRangedAttackCharacter:u,canTradeWithSettlement:D,canRestAtSettlement:I}},qi=n=>{const{playerVM:t}=n,[e,i]=Q(!1),[s,r]=Q(!1),[d,a]=Q(!1),[h,l]=Q(0),c={torchLeft:()=>h(),health:()=>t.health(),maxHealth:()=>t.maxHealth(),armour:()=>c.bodyArmour().armour()+c.headArmour().armour()+c.feetArmour().armour(),maxArmour:()=>c.bodyArmour().maxArmour()+c.headArmour().maxArmour()+c.feetArmour().maxArmour(),inventoryValue:()=>Math.floor(t.inventory().items().reduce((o,f)=>o+f.value()*f.quantity(),0)),isInventoryValueVisible:o=>(o!==void 0&&i(o),e()),inventory:()=>t.inventory(),weapon:()=>t.weapon(),bodyArmour:()=>t.bodyArmour(),headArmour:()=>t.headArmour(),feetArmour:()=>t.feetArmour(),isInGameMenuVisible:()=>s(),showInGameMenu:o=>{a(!1),r(o)},isSaveCompleted:()=>d(),setIsSaveCompleted:o=>{setTimeout(()=>{a(!1)},2e3),a(o)}};return ht(()=>{lt(()=>{const o=t.inventory().stacks().find(f=>f.item.code()==="torch");l(o?o.quantity:0)})}),c},Fi=n=>{const{gameView:t,viewModel:e}=n,i=new J,s=new J;s.label="sensing-fog-of-war",s.alpha=.5,i.label="fog-of-war",i.zIndex=1e4,s.zIndex=10001;const r=()=>{i.destroy({children:!0}),s.destroy({children:!0})};t.addChild(i,s);const d=h=>{const o=h[0]-innerWidth*.5,f=h[1]-innerHeight*.5,p=innerWidth,u=innerHeight,g=Math.floor(o/64)-2,v=Math.floor(f/64)-2,m=Math.ceil((o+p)/64)+2,b=Math.ceil((f+u)/64)+2,x=[];for(let A=g;A<=m;A++)for(let M=v;M<=b;M++)x.push([A,M]);return x};return{applyFogOfWarExceptAround:h=>{e.setFogOfWarPoints(d([h.x,h.y]));const l=64;i.clear(),s.clear();const c=new fe;c.x=h.x,c.y=h.y,c.radius=e.lightRadius()*1.8;const o=new fe;o.x=h.x,o.y=h.y,o.radius=e.lightRadius();for(const f of e.fogOfWarPoints()){const p=new Zt;if(p.x=Math.floor(f[0]*l),p.y=Math.floor(f[1]*l),p.width=l,p.height=l,o.contains(p.x,p.y)){e.addRevealedPoint([f[0],f[1]]);continue}if(c.contains(p.x,p.y)){s.rect(p.x,p.y,l,l),s.fill("black"),e.revealedPoints().some(u=>u[0]===f[0]&&u[1]===f[1])||e.addRevealedPoint([f[0],f[1]]);continue}if(e.revealedPoints().some(u=>u[0]===f[0]&&u[1]===f[1])){s.rect(p.x,p.y,l,l),s.fill("black");continue}i.rect(p.x,p.y,l,l),i.fill(0)}},destroy:r}},Gi=({gameViews:n,userInterfaceView:t,fogOfWarVM:e})=>{const i=new $,s=new $,r=new J,d=.2,{gameView:a,nonSkewedView:h}=n;let l=!1,c=!1,o={x:0,y:0},f=null,p=Fi({gameView:a,viewModel:e}),u={x:0,y:0},g;i.label="camera-view",s.label="viewport",s.addChild(r,a,h),a.scale.set(.6),a.width=Math.floor(a.width),a.height=Math.floor(a.height);const v=()=>{f==null||f.kill(),document.removeEventListener("mousedown",b),document.removeEventListener("mouseup",x),document.removeEventListener("mousemove",A),document.removeEventListener("wheel",M),s.destroy({children:!0}),r.destroy(),p==null||p.destroy(),p=null,i.removeChildren(),i.destroy({children:!0})},m=(I,_)=>{r.clear(),r.rect(0,0,I,_),r.fill("black")};i.addChild(s,t);const b=I=>{I.button===0&&(l=!0)},x=I=>{I.button===0&&(l=!1,c=!1)},A=I=>{const _={x:I.clientX,y:I.clientY},P=_.x-o.x,y=_.y-o.y;if(c&&P!==0&&y!==0&&(l=!0),o={x:I.clientX,y:I.clientY},c){const{movementX:T,movementY:V}=I;a.position.x+=T,a.position.y+=V}},M=I=>{const{deltaY:_}=I;a.scale.x+_*.001>1||a.scale.x+_*.001<.5||(a.scale.x+=_*.001,a.scale.y+=_*.001)};document.addEventListener("mousedown",b),document.addEventListener("mouseup",x),document.addEventListener("mousemove",A),document.addEventListener("wheel",M);const D=(I,_)=>{const P=new qe(I,_),y=a.toGlobal(P),T=innerWidth*.5,V=innerHeight*.5,N=a.position.x-(y.x-T),B=a.position.y-(y.y-V),C={x:Math.floor(N),y:Math.floor(B)},k={x:Math.floor(a.position.x),y:Math.floor(a.position.y)},L=Math.sqrt(Math.pow(C.x-k.x,2)+Math.pow(C.y-k.y,2))>98;f&&f.progress(1),f=K.fromTo(k,{x:k.x,y:k.y},{x:C.x,y:C.y,duration:L?0:1,onUpdate:()=>{a.position.set(k.x,k.y),h.position.set(0,0),!g&&(g=K.delayedCall(d,()=>{g=void 0}),p==null||p.applyFogOfWarExceptAround(P))},onComplete:()=>{p==null||p.applyFogOfWarExceptAround(P),u={x:I,y:_}}})};return{view:i,moveTo:D,resize:(I,_)=>{m(I,_),D(u.x,u.y)},destroy:v,isDragging:()=>l}},Yi=n=>{const{viewModel:t}=n,e=new $,i=t.isAlive()?G.from(`${t.id()}.png`):G.from("corpse.png");let s={x:0,y:0};e.label=`${t.id()}-view`,e.eventMode="static";const r=()=>{i.width=50,i.height=50,i.anchor.set(.5,.5),i.skew.set(.5,0),i.position.set(32,32),e.addChild(i),e.position.set(t.position().x*64,t.position().y*64)};return e.on("pointertap",()=>{R.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})}),r(),{view:e,update:()=>{e.visible=t.visible(),!t.isAlive()&&!i.label.includes("corpse")&&(it.play("audio/sfx/death.mp3",{category:"gameplay"}),i.label=`${t.id()}-corpse`,i.texture=G.from("corpse.png").texture);const a=t.position();if(s.x!==a.x||s.y!==a.y){const h=s.x>a.x,l=s.x!==a.x;if(s={x:a.x,y:a.y},it.play("audio/sfx/step.mp3",{category:"gameplay"}),!l)return;h?(e.scale.x=1,e.pivot.x=0,i.skew.set(-.5,0),i.position.set(32,16)):(e.scale.x=-1,i.position.set(-32,16),i.skew.set(.5,0))}}}},Qi=n=>{const{viewModel:t}=n,e=new $;e.label=`${t.name()}-${t.id()}`;const i=G.from(`${t.id()}.png`);i.label=`${t.name()}-${t.id()}`,i.width=64,i.height=64;const s=G.from("cleared.png");s.width=64,s.height=64,s.label="discovered",s.visible=t.discovered(),s.position.set(-16,0);const r=G.from("loot-icon.png");return r.width=32,r.height=32,r.label="loot-available",r.tint="yellow",r.visible=t.discovered()&&!t.inventory().isEmpty(),r.position.set(i.width-r.width,i.height-r.height),e.addChild(i,s,r),e.skew.set(-.5,0),e.eventMode="static",e.on("pointertap",()=>{R.emit("ON_EVENT_INTERACTION",{eventViewModel:t})}),ht(()=>lt(()=>{e.visible=t.visible(),t.visible()&&t.discovered()&&(i.label.includes("visited")||(s.visible=!0,r.visible=!t.inventory().isEmpty()))}),e),{view:e}},Ie={"bed-time":"task-bed-time",patrol:"magnifying-glass-icon",follow:"walking-icon",work:"coins-icon",idle:"task-idle",attack:"attack-icon"},Xi=n=>{const{cellSize:t,npcVMs:e}=n,i=new $,s=new Map;i.label="npc-task-view";const r=c=>{var g;const o=new $,f=new J,p=((g=c.getTask())==null?void 0:g.name())??"idle",u=G.from(`${Ie[p]||"task-idle"}.png`);o.label=`task-icon-container-${c.id()}`,o.addChild(f,u),u.label=`task-${p}.png`,u.width=t/2,u.height=t/2,s.set(c,{icon:u,container:o,background:f}),f.circle(u.width/2,u.height/2,u.width/1.3),f.fill("khaki"),f.alpha=.75,i.addChild(o)},d=c=>{s.has(c)||r(c)},a=()=>{i.visible=!0},h=()=>{i.visible=!1},l=()=>{s.forEach((c,o)=>{var u;if(c.container.visible=o.visible()&&o.isAlive(),!o.isAlive()){i.removeChild(c.container),c.icon.destroy(),c.background.destroy(),c.container.destroy(),s.delete(o);return}const f=((u=o.getTask())==null?void 0:u.name())??"idle",p=Ie[f]||"task-idle";c.icon.label!==`${p}.png`&&(c.icon.label=`${p}.png`,c.icon.texture=G.from(`${p}.png`).texture),c.container.position.set((o.position().x+.5)*n.cellSize-c.icon.width/2,o.position().y*n.cellSize-t*.6)})};return e.forEach(c=>{d(c)}),{view:i,show:a,hide:h,update:l,addNpc:d}},ke=new Array(5).fill(0),Me=n=>{const{viewModel:t,onStep:e}=n,i=new $;let s=t.id();if(s==="bandit"){const l=Math.floor(Math.random()*5),c=ke.reduce((o,f,p,u)=>f<u[o]?p:o,l);s=`bandit-${c}`,ke[c]++,s=`bandit-${c}`}const r=t.isAlive()?G.from(`${s}.png`):G.from("corpse.png");r.label=t.isAlive()?`${t.id()}-sprite`:`${t.id()}-corpse-sprite`,i.label=`${t.name()}-view`,i.eventMode="static";const d=()=>{const l=t.size()*50;r.width=l,r.height=l,r.anchor.set(.5,.5),r.skew.set(-.5,0),r.position.set(32,32),i.addChild(r),i.position.set(t.position().x,t.position().y)};i.on("pointertap",()=>{R.emit("ON_CHARACTER_INTERACTION_REQUEST",{action:"open",character:t})}),d();let a={x:t.position().x,y:t.position().y};const h=()=>{if(!t.isAlive()&&!r.label.includes("corpse")){it.play("audio/sfx/death.mp3",{category:"gameplay"}),r.label=`${t.id()}-corpse-sprite`,r.texture=G.from("corpse.png").texture;return}};return ht(()=>{lt(()=>{i.visible=t.visible();const l=t.position();if(a.x!==l.x||a.y!==l.y){const c=a.x>l.x,o=a.x!==l.x;if(a={x:l.x,y:l.y},e(),!o)return;c?(i.scale.x=1,i.pivot.x=0,r.skew.set(-.5,0),r.position.set(32,16)):(i.scale.x=-1,r.position.set(-32,16),r.skew.set(.5,0))}})}),{view:i,update:h}},ji=({viewModel:n,onUnlocked:t})=>{const e=new $;e.label="settlement-view";const i=G.from(`${n.id()}.png`);let s=0,r=0;n.positions().forEach(a=>{a.x>=s&&(s=a.x),a.y>=r&&(r=a.y)}),i.width=Math.floor((s-n.positions()[0].x+1)*64),i.height=Math.floor((r-n.positions()[0].y+1)*64);const d=G.from("blocked.png");return d.width=i.width,d.height=i.height,d.visible=!n.isUnlocked(),e.addChild(i,d),e.eventMode="none",e.skew.set(-.46,0),ht(()=>{lt(()=>{e.visible=n.isVisible(),d.visible&&n.isUnlocked()&&t(),d.visible=!n.isUnlocked()})},e),{view:e}},Zi=(n,t,e)=>{n.alpha=0,K.to(n,{alpha:1,duration:t/1e3,onComplete:e})},Ki=(n,t,e)=>{K.to(n,{alpha:0,duration:t/1e3,onComplete:()=>{e()}})},ei=n=>{const{tileSize:t,viewModel:e}=n,{isMiniMapTile:i=!1}=n,s=new $;let r=new G,d=new G;s.label="tile-view",s.eventMode=i?"none":"static";const a=e.type();let h=a;h==="wasteland"?h+=`-${Math.floor(Math.random()*2)}`:h==="forest"?h+=`-${Math.floor(Math.random()*2)}`:h==="settlement"&&(h="wasteland");const l=G.from(`${h}.png`);if(l.width=t,l.height=t,l.anchor.set(.5,.5),l.position.set(t/2,t/2),h==="settlement"&&(l.visible=!1),s.addChild(l),e.hasMud()){const c=G.from("mud.png");c.width=t*.6,c.height=t*.6,c.position.set(t*.2,t*.2),c.alpha=.6,s.addChild(c)}if(!e.traversable()&&a==="void"){const c=Math.floor(Math.random()*6),o=["dead-trees-0","dead-trees-1","dead-trees-2","dead-trees-3","dead-trees-4","dead-trees-1"][c];r=G.from(`${o}.png`),r.width=t*1.2,r.height=t*1.2,r.skew.set(-.5,0)}if(e.hasGrass()){const c=G.from("dead-grass.png");c.width=t*.6,c.height=t*.6,c.alpha=1,c.skew.set(-.4,0),c.position.set(20,0),s.addChild(c)}if(e.hasEyes()){d=G.from("eyes.png"),d.width=t*.8,d.height=t*.8,d.skew.set(-.5,0),d.zIndex=d.position.y+32,d.alpha=0;const c=async()=>{await new Promise(o=>{setTimeout(()=>o(),(d.alpha===1?Math.random()*2e3:Math.random()*5e3)+2e3)}),d.alpha===0?Zi(d,1e3,c):Ki(d,1e3,c)};c()}return s.on("pointertap",()=>{R.emit("ON_TILE_INTERACTION",{tileViewModel:e})}),ht(()=>{lt(()=>{s.visible=i?e.discovered():e.visible(),d.visible=e.visible(),r.visible=e.visible()}),lt(()=>{s.tint=e.isSelected()?65280:16777215})},s),{view:s,trees:r,eyes:d}},Ji=n=>{const{viewModel:t,tileSize:e}=n,i=new $;i.label="tile-map-view",i.sortableChildren=!0;const s=t.tiles(),r=[],d=[];return s.forEach((a,h)=>{a.forEach((l,c)=>{const o=ei({tileSize:e,viewModel:l});o.view.label=`tile-${h}-${c}`,o.view.position.set(h*e,c*e),o.trees.position.set(o.view.position.x+20,o.view.position.y-20),o.eyes.position.set(o.view.x+32,o.view.y-20),r.push(o.trees),d.push(o.eyes),i.addChild(o.view)})}),{view:i,trees:r,eyes:d}},tn=n=>{const{viewModel:t}=n,e=new $,i=[],s=64,r=new Map,d=f=>{const p=f.health(),u=f.maxHealth(),g=p/u,v=s*g,{x:m,y:b}=f.position();let x=r.get(f);x?x.clear():x=new J,x.clear(),x.rect(m*s,b*s-10,s,5),x.fill(0),x.rect(m*s,b*s-10,v,5),x.fill(65280),x.label=`${f.name()}-health-bar`,e.addChild(x),r.set(f,x),K.to(x,{alpha:0,duration:1,delay:1,onComplete:()=>{e.removeChild(x),x.destroy(),r.delete(f)}})},a=(f,p)=>({x:(f.x+p.x)/2,y:(f.y+p.y)/2}),h=f=>{if(e.destroyed)return;const p=f.position(),u=G.from("blood.png");u.width=s,u.height=s,u.position.set(p.x*s,p.y*s),e.addChild(u),f.armour()>0?(u.tint="blue",it.play("audio/sfx/collect.wav",{category:"gameplay"})):(it.play("audio/sfx/fists.mp3",{category:"gameplay"}),d(f)),K.to(u,{alpha:0,duration:.333,ease:"power2.inOut",onComplete:()=>{e.removeChild(u),u.destroy()}})},l=async({source:f,target:p})=>{const u=G.from("slash.png");u.scale.set(.15),u.anchor.set(.5),u.position.set(a(f.position(),p.position()).x*64+32,a(f.position(),p.position()).y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),u.alpha=0,await K.to(u,{alpha:1,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),h(p)},c=async({source:f,target:p})=>{const u=G.from("arrow.png");u.scale.set(.1),u.anchor.set(.5),u.position.set(f.position().x*64+32,f.position().y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),await K.to(u.position,{x:p.position().x*64+32,y:p.position().y*64+32,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),h(p)},o=async()=>{for(;i.length>0;){const f=i.shift();f&&await f()}};return ht(()=>{lt(()=>{const f=t.isAttacking();f&&(f.type==="ranged"?i.push(()=>c(f)):i.push(()=>l(f)))})}),{view:e,process:o}},en=n=>{const{attackVM:t,tileMapVM:e,playerVM:i,tileSize:s,npcVMs:r,eventVMs:d,settlementVMs:a}=n,h=new $,l=new $,c=new $,o=new $,f=tn({viewModel:t});let p=null,u=null;l.label="game-view-container",c.label="tile-container",o.label="talk-overlay",l.sortableChildren=!0,c.zIndex=-1e3;const g=new Map,v=Xi({cellSize:s,npcVMs:r}),m=new Map;let b=null,x=null,A=[],M=[],D=[];const E=[];let I=!1;const _=O=>{const W=Me({viewModel:O,onStep:()=>{O.position().distanceTo(i.position())<6&&it.play("audio/sfx/step.mp3",{category:"gameplay"})}});r.push(O),l.addChild(W.view),A.push(W)},P=()=>{x=Ji({viewModel:e,tileSize:s}),x.view.label="tile-map-view",b=Yi({viewModel:i}),c.addChild(x.view),x.trees.forEach(O=>{l.addChild(O)}),x.eyes.forEach(O=>{l.addChild(O)}),d.map(O=>{const W=Qi({viewModel:O});M.push(W),l.addChild(W.view)}),A=r.map(O=>{const W=Me({viewModel:O,onStep:()=>{O.position().distanceTo(i.position())<6&&it.play("audio/sfx/step.mp3",{category:"gameplay"})}});return l.addChild(W.view),W}),a.map(O=>{const W=ji({viewModel:O,onUnlocked:()=>{L("city-key",O.getMiddleTopPosition())}});D.push(W),l.addChild(W.view),W.view.label=`settlement-${O.id()}`,W.view.position.set(O.positions()[0].x*s+52,O.positions()[0].y*s-30),W.view.zIndex=W.view.y+32}),l.addChild(c,b.view,o,f.view)},y=O=>{T(),p=G.from("walking-icon.png"),p.tint="green",p.width=s*.5,p.height=s*.5,p.skew.x=-.5,p.position.set(O.x*s+s*.5,O.y*s),p.zIndex=2e4,u=K.to(p,{y:p.position.y-s*.5,x:p.position.x+s*.25,duration:.5,repeat:-1,yoyo:!0}),l.addChild(p)},T=()=>{p&&(u&&(u.totalProgress(1),u=null),l.removeChild(p),p.destroy(),p=null)},V=()=>{I=!0,E.forEach(O=>O.kill()),x==null||x.view.destroy({children:!0}),b==null||b.view.destroy({children:!0}),o.removeChildren(),x=null,b=null,A.forEach(O=>O.view.destroy({children:!0})),A=[],M.forEach(O=>O.view.destroy({children:!0})),M=[],D.forEach(O=>O.view.destroy({children:!0})),D=[],g.clear(),l.destroy({children:!0})},N=["snow","lightskyblue","lime","yellow","fuchsia","orange"],B=()=>{const O=["snow","lightskyblue","lime","yellow","fuchsia","orange"];return N.length===0&&N.push(...O),N.splice(Math.floor(Math.random()*N.length),1)[0]},C=O=>{const{x:q,y:et}=O.position(),Z=new Mt;if(g.get(O.id()))return;Z.style={fontFamily:"alagard",fontSize:32,fill:B(),align:"center",dropShadow:!0,stroke:"black",wordWrap:!0,wordWrapWidth:innerWidth*1.5},Z.text=O.dialogue(),Z.anchor.set(.5);let ot=0;const Y=q*s+s/2,S=et*s-s;Z.position.set(Y,S),g.forEach(H=>{Z.getBounds().containsPoint(H.position.x,H.position.y)&&(ot+=H.height),Z.position.set(Y,S-ot)}),Z.label="text-box",Z.zIndex=11e3;const F=l.toGlobal(Z.position);return Z.position.set(F.x,F.y),Z.scale.set(.6),h.addChild(Z),setTimeout(()=>{const H=g.get(O.id());H&&(l.removeChild(H),g.delete(O.id()),H.destroy())},2e3),g.set(O.id(),Z),Z},k=(O,W)=>{const{x:q,y:et}=W,Z=q*s,at=et*s;E.push(K.to(O.view.position,{x:Z,y:at,duration:.2,ease:"power2.inOut",onUpdate:()=>{O.view.zIndex=O.view.position.y},onComplete:()=>{O.view.position.set(Z,at)}}))},w=async()=>{if(I)return;const{x:O,y:W}=i.position();b&&(b.update(),b.view.zIndex=b.view.position.y,(b.view.position.x!==O*s||b.view.position.y!==W*s)&&k(b,{x:O,y:W})),await f.process();for(const q of A){const et=A.indexOf(q),{x:Z,y:at}=r[et].position();q.update(),(q.view.position.x!==Z*s||q.view.position.y!==at*s)&&k(q,{x:Z,y:at})}M.forEach((q,et)=>{const{x:Z,y:at}=d[et].position();q.view.position.set(Z*s+20,at*s-50),q.view.scale.set(1.5,1.5),q.view.zIndex=q.view.y+32}),v.update()},L=async(O,W)=>{const q=new $;q.label="looted-icon-container";const et=G.from(`${O}.png`);et.width=s/2,et.height=s/2;const Z=new J;Z.circle(s*.25,s*.25,s/2),Z.fill("khaki"),q.addChild(Z,et),q.zIndex=11e3,q.position.set((W.x+1)*s,W.y*s-s);const at=l.toGlobal(q.position);h.addChild(q),q.position.set(at.x,at.y),q.scale.set(.6);const ot=m.get(`${{x:W.x,y:W.y}}`)??0;m.set(`${{x:W.x,y:W.y}}`,ot+1),await K.delayedCall(.2*ot,()=>{}),K.to(q.position,{y:q.position.y-s*4,duration:1,delay:ot*.1,ease:"power2.inOut",onComplete:()=>{h.removeChild(q),q.destroy({children:!0});const Y=m.get(`${{x:W.x,y:W.y}}`)??0;Y>1?m.set(`${{x:W.x,y:W.y}}`,Y-1):m.delete(`${{x:W.x,y:W.y}}`)}})};P(),w(),l.skew.set(Math.PI/6,0),f.view.zIndex=11e3;const U=new J;return h.addChild(U),h.label="non-skewed-container",U.rect(0,0,innerWidth,innerHeight),U.fill("black"),U.alpha=0,{view:l,nonSkewedContainer:h,addNpc:_,animateIconFloat:L,handleEndOfTurnUpdates:w,createTextBox:C,destroy:V,showPathTrigger:y,hidePathTrigger:T}};var ne={},At={},_e;function Gt(){if(_e)return At;_e=1,Object.defineProperty(At,"__esModule",{value:!0}),At.Collector=void 0;let n=class{constructor(e){this.emit=(...i)=>{e.emitCollecting(this,i)}}};return At.Collector=n,At}var Pt={},Ee;function nn(){if(Ee)return Pt;Ee=1,Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.CollectorArray=void 0;const n=Gt();let t=class extends n.Collector{constructor(){super(...arguments),this.result=[]}handleResult(i){return this.result.push(i),!0}getResult(){return this.result}reset(){this.result.length=0}};return Pt.CollectorArray=t,Pt}var Nt={},Se;function sn(){if(Se)return Nt;Se=1,Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.CollectorLast=void 0;const n=Gt();let t=class extends n.Collector{handleResult(i){return this.result=i,!0}getResult(){return this.result}reset(){delete this.result}};return Nt.CollectorLast=t,Nt}var Ot={},Ae;function on(){if(Ae)return Ot;Ae=1,Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.CollectorUntil0=void 0;const n=Gt();let t=class extends n.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,this.result}getResult(){return this.result}reset(){this.result=!1}};return Ot.CollectorUntil0=t,Ot}var Rt={},Pe;function rn(){if(Pe)return Rt;Pe=1,Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.CollectorWhile0=void 0;const n=Gt();let t=class extends n.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,!this.result}getResult(){return this.result}reset(){this.result=!1}};return Rt.CollectorWhile0=t,Rt}var Vt={},Lt={},Ne;function an(){if(Ne)return Lt;Ne=1,Object.defineProperty(Lt,"__esModule",{value:!0}),Lt.SignalConnectionImpl=void 0;class n{constructor(e,i){this.link=e,this.parentCleanup=i}disconnect(){return this.link!==null?(this.link.unlink(),this.link=null,this.parentCleanup(),this.parentCleanup=null,!0):!1}set enabled(e){this.link&&this.link.setEnabled(e)}get enabled(){return this.link!==null&&this.link.isEnabled()}}return Lt.SignalConnectionImpl=n,Lt}var Bt={},Oe;function ln(){if(Oe)return Bt;Oe=1,Object.defineProperty(Bt,"__esModule",{value:!0}),Bt.SignalLink=void 0;let n=class ii{constructor(e=null,i=null,s=0){this.enabled=!0,this.newLink=!1,this.callback=null,this.prev=e??this,this.next=i??this,this.order=s}isEnabled(){return this.enabled&&!this.newLink}setEnabled(e){this.enabled=e}unlink(){this.callback=null,this.next.prev=this.prev,this.prev.next=this.next}insert(e,i){let s=this.prev;for(;s!==this&&!(s.order<=i);)s=s.prev;const r=new ii(s,s.next,i);return r.callback=e,s.next=r,r.next.prev=r,r}};return Bt.SignalLink=n,Bt}var Re;function cn(){if(Re)return Vt;Re=1,Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.Signal=void 0;const n=an(),t=ln();let e=class{constructor(){this.head=new t.SignalLink,this.hasNewLinks=!1,this.emitDepth=0,this.connectionsCount=0}getConnectionsCount(){return this.connectionsCount}hasConnections(){return this.connectionsCount>0}connect(s,r=0){this.connectionsCount++;const d=this.head.insert(s,r);return this.emitDepth>0&&(this.hasNewLinks=!0,d.newLink=!0),new n.SignalConnectionImpl(d,()=>this.decrementConnectionCount())}decrementConnectionCount(){this.connectionsCount--}disconnect(s){for(let r=this.head.next;r!==this.head;r=r.next)if(r.callback===s)return this.decrementConnectionCount(),r.unlink(),!0;return!1}disconnectAll(){for(;this.head.next!==this.head;)this.head.next.unlink();this.connectionsCount=0}emit(...s){this.emitDepth++;for(let r=this.head.next;r!==this.head;r=r.next)r.isEnabled()&&r.callback&&r.callback.apply(null,s);this.emitDepth--,this.unsetNewLink()}emitCollecting(s,r){this.emitDepth++;for(let d=this.head.next;d!==this.head;d=d.next)if(d.isEnabled()&&d.callback){const a=d.callback.apply(null,r);if(!s.handleResult(a))break}this.emitDepth--,this.unsetNewLink()}unsetNewLink(){if(this.hasNewLinks&&this.emitDepth===0){for(let s=this.head.next;s!==this.head;s=s.next)s.newLink=!1;this.hasNewLinks=!1}}};return Vt.Signal=e,Vt}var Dt={},Ve;function hn(){if(Ve)return Dt;Ve=1,Object.defineProperty(Dt,"__esModule",{value:!0}),Dt.SignalConnections=void 0;let n=class{constructor(){this.list=[]}add(e){this.list.push(e)}disconnectAll(){for(const e of this.list)e.disconnect();this.list=[]}getCount(){return this.list.length}isEmpty(){return this.list.length===0}};return Dt.SignalConnections=n,Dt}var Le;function dn(){return Le||(Le=1,function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.SignalConnections=n.Signal=n.CollectorWhile0=n.CollectorUntil0=n.CollectorLast=n.CollectorArray=n.Collector=void 0;var t=Gt();Object.defineProperty(n,"Collector",{enumerable:!0,get:function(){return t.Collector}});var e=nn();Object.defineProperty(n,"CollectorArray",{enumerable:!0,get:function(){return e.CollectorArray}});var i=sn();Object.defineProperty(n,"CollectorLast",{enumerable:!0,get:function(){return i.CollectorLast}});var s=on();Object.defineProperty(n,"CollectorUntil0",{enumerable:!0,get:function(){return s.CollectorUntil0}});var r=rn();Object.defineProperty(n,"CollectorWhile0",{enumerable:!0,get:function(){return r.CollectorWhile0}});var d=cn();Object.defineProperty(n,"Signal",{enumerable:!0,get:function(){return d.Signal}});var a=hn();Object.defineProperty(n,"SignalConnections",{enumerable:!0,get:function(){return a.SignalConnections}})}(ne)),ne}var Be=dn(),un=Object.defineProperty,fn=(n,t,e)=>t in n?un(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Wt=(n,t,e)=>fn(n,typeof t!="symbol"?t+"":t,e);class pn extends ${constructor(t){var e;super(),Wt(this,"options"),Wt(this,"view"),Wt(this,"_type"),Wt(this,"_maxWidth"),Wt(this,"children",[]),t&&(t.maxWidth&&(this._maxWidth=t.maxWidth),this.init(t)),(e=t==null?void 0:t.items)==null||e.forEach(i=>this.addChild(i)),this.on("added",()=>this.arrangeChildren()),this.on("childAdded",()=>this.arrangeChildren())}init(t){this.options=t,t!=null&&t.type&&(this.type=t.type),t!=null&&t.children&&t.children.forEach(e=>this.addChild(e))}set type(t){this._type=t,this.arrangeChildren()}get type(){return this._type}set elementsMargin(t){if(!this.options)throw new Error("List has not been initiated!");this.options.elementsMargin=t,this.arrangeChildren()}get elementsMargin(){var t;return((t=this.options)==null?void 0:t.elementsMargin)??0}set padding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.padding=t,this.options.vertPadding=t,this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get padding(){var t;return((t=this.options)==null?void 0:t.padding)??0}set vertPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.vertPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get vertPadding(){var t;return((t=this.options)==null?void 0:t.vertPadding)??this.padding??0}set horPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.arrangeChildren()}get horPadding(){var t;return((t=this.options)==null?void 0:t.horPadding)??this.padding??0}set leftPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.leftPadding=t,this.arrangeChildren()}get leftPadding(){var t;return((t=this.options)==null?void 0:t.leftPadding)??this.horPadding}set rightPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.rightPadding=t,this.arrangeChildren()}get rightPadding(){var t;return((t=this.options)==null?void 0:t.rightPadding)??this.horPadding}set topPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.topPadding=t,this.arrangeChildren()}get topPadding(){var t;return((t=this.options)==null?void 0:t.topPadding)??this.vertPadding}set bottomPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.bottomPadding=t,this.arrangeChildren()}get bottomPadding(){var t;return((t=this.options)==null?void 0:t.bottomPadding)??this.vertPadding}arrangeChildren(){var d,a;let t=0,e=this.leftPadding,i=this.topPadding;const s=((d=this.options)==null?void 0:d.elementsMargin)??0;let r=this.maxWidth??((a=this.parent)==null?void 0:a.width);this.rightPadding&&(r-=this.rightPadding),this.children.forEach((h,l)=>{switch(this.type){case"vertical":h.y=i,h.x=e,i+=s+h.height;break;case"horizontal":h.x=e,h.y=i,e+=s+h.width;break;case"bidirectional":default:h.x=e,h.y=i,h.x+h.width>r&&l>0&&(i+=s+t,e=this.leftPadding,h.x=e,h.y=i,t=0),t=Math.max(t,h.height),e+=s+h.width;break}})}removeItem(t){const e=this.children[t];e&&(this.removeChild(e),this.arrangeChildren())}set maxWidth(t){this._maxWidth=t,this.arrangeChildren()}get maxWidth(){return this._maxWidth}}var mn=Object.defineProperty,gn=(n,t,e)=>t in n?mn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Ht=(n,t,e)=>gn(n,typeof t!="symbol"?t+"":t,e);class yn{constructor(t={}){Ht(this,"x"),Ht(this,"ax"),Ht(this,"dx"),Ht(this,"tx"),Ht(this,"_options"),this.x=0,this.ax=0,this.dx=0,this.tx=0,this._options=t,this._options.max=t.max||160,this._options.damp=t.damp||.8,this._options.springiness=t.springiness||.1}update(){this.ax=(this.tx-this.x)*this._options.springiness,this.dx+=this.ax,this.dx*=this._options.damp,this.dx<-this._options.max?this.dx=-this._options.max:this.dx>this._options.max&&(this.dx=this._options.max),this.x+=this.dx}reset(){this.x=0,this.ax=0,this.dx=0,this.tx=0}get max(){return this._options.max}set max(t){this._options.max=t}get damp(){return this._options.damp}set damp(t){this._options.damp=t}get springiness(){return this._options.springiness}set springiness(t){this._options.springiness=t}}var vn=Object.defineProperty,wn=(n,t,e)=>t in n?vn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,_t=(n,t,e)=>wn(n,typeof t!="symbol"?t+"":t,e);class bn{constructor(){_t(this,"done"),_t(this,"to"),_t(this,"_spring"),_t(this,"_pos"),_t(this,"_speed"),_t(this,"_correctSpeed"),this._spring=new yn,this._pos=0,this.to=0}start(t,e,i){this._speed=t,this._pos=e,this.to=i,this.done=!1,this._spring.x=this._pos,this._spring.tx=this.to;const s=this.to-this._pos,r=Math.abs(s)/s,d=Math.abs(this._speed)/this._speed;r!==d?this._correctSpeed=!0:this._correctSpeed=!1}update(){if(this._correctSpeed)this._speed*=.6,Math.abs(this._speed)<2&&(this._correctSpeed=!1),this._pos+=this._speed,this._spring.x=this._pos;else{const t=this.to-this._pos;Math.abs(t)<.05?(this._pos=this.to,this.done=!0):(this._spring.tx=this.to,this._spring.update(),this._pos=this._spring.x)}return this._pos}cancel(){}}var xn=Object.defineProperty,Cn=(n,t,e)=>t in n?xn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,ut=(n,t,e)=>Cn(n,typeof t!="symbol"?t+"":t,e);class De{constructor(t={}){ut(this,"position",0),ut(this,"constrain",!0),ut(this,"min",0),ut(this,"max",0),ut(this,"maxSpeed",400),ut(this,"_ease"),ut(this,"_offset",0),ut(this,"_prev",0),ut(this,"_speed",0),ut(this,"_hasStopped"),ut(this,"_targetSpeed",0),ut(this,"_speedChecker",0),ut(this,"_grab",0),ut(this,"_activeEase"),this.constrain=t.constrain??!0,this.maxSpeed=t.maxSpeed??400,this._ease=t.ease??new bn}set value(t){this._speed=0,this.position=t}get value(){return this.position}grab(t){this._grab=t,this._offset=this.position-t,this._speedChecker=0,this._targetSpeed=this._speed=0,this._hasStopped=!1}hold(t){this._speedChecker++,this.position=t+this._offset,this._speedChecker>1&&(this._targetSpeed=this.position-this._prev),this._speed+=(this._targetSpeed-this._speed)/2,this._speed>this.maxSpeed?this._speed=this.maxSpeed:this._speed<-this.maxSpeed&&(this._speed=-this.maxSpeed),this._prev=this.position,this.constrain&&(this._activeEase=null,this.position>this.min?this.position-=(this.position-this.min)/1.5:this.position<this.max&&(this.position+=(this.max-this.position)/1.5))}slide(t=!1){this._hasStopped||(this.constrain?this._updateConstrain(t):this._updateDefault())}get moveAmount(){return-(this.position-this._offset-this._grab)}_updateDefault(){this._speed*=.9,this.position+=this._speed,(this._speed<0?this._speed*-1:this._speed)<.01&&(this._hasStopped=!0)}_updateConstrain(t=!1){const e=this.max;t?(this.value>0&&(this.value=0),this.value>0&&(this.value=0),this.value<this.max&&(this.value=this.max),this.value<this.max&&(this.value=this.max)):this.position>this.min||this.position<e||this._activeEase?(this._activeEase||(this._activeEase=this._ease,this.position>this.min?this._activeEase.start(this._speed,this.position,this.min):this._activeEase.start(this._speed,this.position,e)),this.position=this._activeEase.update(),this._activeEase.done&&(this.position=this._activeEase.to,this._speed=0,this._activeEase=null)):this._updateDefault()}}var Tn=Object.defineProperty,In=(n,t,e)=>t in n?Tn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Tt=(n,t,e)=>In(n,typeof t!="symbol"?t+"":t,e);class kn{constructor(t){Tt(this,"xAxis"),Tt(this,"yAxis"),Tt(this,"_isDown"),Tt(this,"_globalPosition"),Tt(this,"_frame"),Tt(this,"_bounds"),Tt(this,"_dirty"),Tt(this,"disableEasing",!1),this.xAxis=new De({ease:t.xEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.yAxis=new De({ease:t.yEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.disableEasing=t.disableEasing??!1,this._frame=new Zt,this._bounds=new Zt,this._globalPosition=new qe}pointerDown(t){this._globalPosition=t,this.xAxis.grab(t.x),this.yAxis.grab(t.y),this._isDown=!0}pointerUp(){this._isDown=!1}pointerMove(t){this._globalPosition=t}update(){this._dirty&&(this._dirty=!1,this.xAxis.min=this._bounds.left,this.xAxis.min=this._bounds.right-this._frame.width,this.xAxis.min=this._bounds.top,this.xAxis.min=this._bounds.bottom-this._frame.height),this._isDown?(this.xAxis.hold(this._globalPosition.x),this.yAxis.hold(this._globalPosition.y)):(this.xAxis.slide(this.disableEasing),this.yAxis.slide(this.disableEasing))}resize(t,e){this._frame.x=0,this._frame.width=t,this._frame.y=0,this._frame.height=e,this._dirty=!0}setBounds(t,e,i,s){this._bounds.x=t,this._bounds.width=e-t,this._bounds.y=i,this._bounds.height=s-i,this._dirty=!0}get x(){return this.xAxis.value}get y(){return this.yAxis.value}}var Mn=Object.defineProperty,_n=(n,t,e)=>t in n?Mn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,tt=(n,t,e)=>_n(n,typeof t!="symbol"?t+"":t,e);class de extends ${constructor(t){super(),tt(this,"background"),tt(this,"borderMask"),tt(this,"lastWidth"),tt(this,"lastHeight"),tt(this,"_width",0),tt(this,"_height",0),tt(this,"_dimensionChanged",!1),tt(this,"list"),tt(this,"_trackpad"),tt(this,"isDragging",0),tt(this,"interactiveStorage",[]),tt(this,"visibleItems",[]),tt(this,"pressedChild"),tt(this,"ticker",li.shared),tt(this,"options"),tt(this,"stopRenderHiddenItemsTimeout"),tt(this,"onMouseScrollBinding",this.onMouseScroll.bind(this)),tt(this,"dragStarTouchPoint"),tt(this,"isOver",!1),tt(this,"proximityRange"),tt(this,"proximityStatusCache",[]),tt(this,"lastScrollX"),tt(this,"lastScrollY"),tt(this,"proximityCheckFrameCounter",0),tt(this,"onProximityChange",new Be.Signal),tt(this,"onScroll",new Be.Signal),t&&this.init(t),this.ticker.add(this.update,this)}init(t){this.options=t,this.setBackground(t.background),this._width=t.width|this.background.width,this._height=t.height|this.background.height,this.proximityRange=t.proximityRange??0,this.list||(this.list=new pn,super.addChild(this.list)),this.list.init({type:t.type,elementsMargin:t.elementsMargin,padding:t.padding,vertPadding:t.vertPadding,horPadding:t.horPadding,topPadding:t.topPadding,bottomPadding:t.bottomPadding,leftPadding:t.leftPadding,rightPadding:t.rightPadding}),this.addItems(t.items),this.hasBounds&&(this.addMask(),this.makeScrollable()),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.options.globalScroll=t.globalScroll??!0,this.options.shiftScroll=t.shiftScroll??!1,this.resize()}get hasBounds(){return!!this._width||!!this._height}addItems(t){t!=null&&t.length&&t.forEach(e=>this.addItem(e))}removeItems(){this.proximityStatusCache.length=0,this.list.removeChildren()}addItem(...t){if(t.length>1)t.forEach(e=>this.addItem(e));else{const e=t[0];(!e.width||!e.height)&&console.error("ScrollBox item should have size"),e.eventMode="static",this.list.addChild(e),this.proximityStatusCache.push(!1),this.options.disableDynamicRendering||(e.renderable=this.isItemVisible(e))}return this.resize(),t[0]}removeItem(t){this.list.removeItem(t),this.proximityStatusCache.splice(t,1),this.resize()}isItemVisible(t,e=0){let i=!1;const s=this.list;if(this.isVertical||this.isBidirectional){const r=t.y+s.y;r+t.height>=-e&&r<=this.options.height+e&&(i=!0)}if(this.isHorizontal||this.isBidirectional){const r=t.x+s.x;r+t.width>=-e&&r<=this.options.width+e&&(i=!0)}return i}get items(){var t;return((t=this.list)==null?void 0:t.children)??[]}setBackground(t){this.background&&this.removeChild(this.background),this.options.background=t,this.background=new J,this.addChildAt(this.background,0),this.resize()}addMask(){this.borderMask||(this.borderMask=new J,super.addChild(this.borderMask),this.mask=this.borderMask),this.resize()}makeScrollable(){this._trackpad||(this._trackpad=new kn({disableEasing:this.options.disableEasing})),this.on("pointerdown",t=>{this.renderAllItems(),this.isDragging=1,this.dragStarTouchPoint=this.worldTransform.applyInverse(t.global),this._trackpad.pointerDown(this.dragStarTouchPoint);const e=this.list.worldTransform.applyInverse(t.global);this.visibleItems.forEach(i=>{i.x<e.x&&i.x+i.width>e.x&&i.y<e.y&&i.y+i.height>e.y&&(this.pressedChild=i)})}),this.on("pointerup",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("pointerover",()=>{this.isOver=!0}),this.on("pointerout",()=>{this.isOver=!1}),this.on("pointerupoutside",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("globalpointermove",t=>{var i,s;if(!this.isDragging)return;const e=this.worldTransform.applyInverse(t.global);if(this.dragStarTouchPoint){const r=this.options.dragTrashHold??10;if(this.isHorizontal||this.isBidirectional){const d=e.x-this.dragStarTouchPoint.x;Math.abs(d)>r&&(this.isDragging=2)}if(this.isVertical||this.isBidirectional){const d=e.y-this.dragStarTouchPoint.y;Math.abs(d)>r&&(this.isDragging=2)}}this.dragStarTouchPoint&&this.isDragging!==2||(this._trackpad.pointerMove(e),this.pressedChild&&(this.revertClick(this.pressedChild),this.pressedChild=null),this.isBidirectional?(i=this.onScroll)==null||i.emit({x:this.scrollX,y:this.scrollY}):(s=this.onScroll)==null||s.emit(this.isVertical?this.scrollY:this.scrollX))}),document.addEventListener("wheel",this.onMouseScrollBinding,!0)}setInteractive(t){this.eventMode=t?"static":"auto"}get listHeight(){return this.list.height+this.list.topPadding+this.list.bottomPadding}get listWidth(){return this.list.width+this.list.leftPadding+this.list.rightPadding}resize(t=!1){if(this.hasBounds){if(this.renderAllItems(),this.borderMask&&(t||this._dimensionChanged||this.lastWidth!==this.listWidth||this.lastHeight!==this.listHeight)){this.options.width||(this._width+=this.listWidth),this.options.height||(this._height+=this.listHeight),this.borderMask.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill(16711935).stroke(0),this.borderMask.eventMode="none";const e=this.options.background;this.background.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill({color:e??0,alpha:e?1:1e-7}),this.isBidirectional?this.setInteractive(this.listWidth>this._width||this.listHeight>this._height):this.isHorizontal?this.setInteractive(this.listWidth>this._width):this.setInteractive(this.listHeight>this._height),this.lastWidth=this.listWidth,this.lastHeight=this.listHeight}if(this._trackpad){const e=this.borderMask.width-this.list.width-this.list.leftPadding-this.list.rightPadding,i=this.borderMask.height-this.list.height-this.list.topPadding-this.list.bottomPadding;this.isBidirectional?(this._trackpad.yAxis.max=-Math.abs(i),this._trackpad.xAxis.max=-Math.abs(e)):this.isVertical?this._trackpad.yAxis.max=-Math.abs(i):this.isHorizontal&&(this._trackpad.xAxis.max=-Math.abs(e))}this._dimensionChanged?(this.list.arrangeChildren(),this.stopRenderHiddenItems(),this._dimensionChanged=!1):(t&&this.list.arrangeChildren(),this.updateVisibleItems()),this.lastScrollX=null,this.lastScrollY=null}}onMouseScroll(t){var r,d,a;if(!this.isOver&&!this.options.globalScroll)return;this.renderAllItems();const e=!!this.options.shiftScroll,i=e?typeof t.deltaX<"u"||typeof t.deltaY<"u":typeof t.deltaX<"u",s=typeof t.deltaY<"u";if((this.isHorizontal||this.isBidirectional)&&i){const h=e||this.isBidirectional?t.deltaX:t.deltaY,l=this.list.x-h;if(this.listWidth<this._width)this._trackpad.xAxis.value=0;else{const c=this._width-this.listWidth,o=0;this._trackpad.xAxis.value=Math.min(o,Math.max(c,l))}}if((this.isVertical||this.isBidirectional)&&s){const h=this.list.y-t.deltaY;if(this.listHeight<this._height)this._trackpad.yAxis.value=0;else{const l=this._height-this.listHeight,c=0;this._trackpad.yAxis.value=Math.min(c,Math.max(l,h))}}this.isBidirectional&&(i||s)?(r=this.onScroll)==null||r.emit({x:this._trackpad.xAxis.value,y:this._trackpad.yAxis.value}):this.isHorizontal&&i?(d=this.onScroll)==null||d.emit(this._trackpad.xAxis.value):this.isVertical&&s&&((a=this.onScroll)==null||a.emit(this._trackpad.yAxis.value)),this.stopRenderHiddenItems()}scrollBottom(){this.interactive?this.scrollTo(this.list.children.length-1):this.scrollTop()}scrollTop(){this.renderAllItems(),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.stopRenderHiddenItems()}renderAllItems(){clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null,!this.options.disableDynamicRendering&&this.items.forEach(t=>{t.renderable=!0})}stopRenderHiddenItems(){this.options.disableDynamicRendering||(this.stopRenderHiddenItemsTimeout&&(clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null),this.stopRenderHiddenItemsTimeout=setTimeout(()=>this.updateVisibleItems(),2e3))}updateVisibleItems(){this.visibleItems.length=0,this.items.forEach(t=>{t.renderable=this.isItemVisible(t),this.visibleItems.push(t)})}scrollTo(t){if(!this.interactive)return;const e=this.list.children[t];e&&(this.renderAllItems(),this._trackpad.xAxis.value=this.isHorizontal||this.isBidirectional?this._width-e.x-e.width-this.list.rightPadding:0,this._trackpad.yAxis.value=this.isVertical||this.isBidirectional?this._height-e.y-e.height-this.list.bottomPadding:0,this.stopRenderHiddenItems())}scrollToPosition({x:t,y:e}){t===void 0&&e===void 0||(this.renderAllItems(),t!==void 0&&(this.scrollX=-t),e!==void 0&&(this.scrollY=-e),this.stopRenderHiddenItems())}get height(){return this._height}set height(t){this._height=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}get width(){return this._width}set width(t){this._width=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}setSize(t,e){typeof t=="object"?(e=t.height??t.width,t=t.width):e=e??t,this._width=t,this._height=e,this._dimensionChanged=!0,this.resize(),this.scrollTop()}getSize(t){return t=t||{width:0,height:0},t.width=this._width,t.height=this._height,t}get scrollX(){return this._trackpad.xAxis.value}set scrollX(t){this._trackpad.xAxis.value=t}get scrollY(){return this._trackpad.yAxis.value}set scrollY(t){this._trackpad.yAxis.value=t}update(){this.list&&(this._trackpad.update(),(this.isHorizontal||this.isBidirectional)&&this.list.x!==this._trackpad.x&&(this.list.x=this._trackpad.x),(this.isVertical||this.isBidirectional)&&this.list.y!==this._trackpad.y&&(this.list.y=this._trackpad.y),!this.options.disableProximityCheck&&(this._trackpad.x!==this.lastScrollX||this._trackpad.y!==this.lastScrollY)&&(this.proximityCheckFrameCounter++,this.proximityCheckFrameCounter>=(this.options.proximityDebounce??10)&&(this.items.forEach((t,e)=>{const i=this.isItemVisible(t,this.proximityRange),s=this.proximityStatusCache[e];i!==s&&(this.proximityStatusCache[e]=i,this.onProximityChange.emit({item:t,index:e,inRange:i}))}),this.lastScrollX=this._trackpad.x,this.lastScrollY=this._trackpad.y,this.proximityCheckFrameCounter=0)))}destroy(t){this.ticker.remove(this.update,this),document.removeEventListener("wheel",this.onMouseScrollBinding,!0),this.background.destroy(),this.list.destroy(),super.destroy(t)}restoreItemsInteractivity(){this.interactiveStorage.forEach(t=>{t.item.eventMode=t.eventMode}),this.interactiveStorage.length=0}revertClick(t){t.eventMode!=="auto"&&(ci.any?t.emit("pointerupoutside",null):t.emit("mouseupoutside",null),this.interactiveStorage.push({item:t,eventMode:t.eventMode}),t.eventMode="auto"),t instanceof $&&t.children&&t.children.forEach(e=>this.revertClick(e))}get scrollHeight(){return this.list.height}get scrollWidth(){return this.list.width}get isVertical(){return(this.options.type??"vertical")==="vertical"}get isHorizontal(){return this.options.type==="horizontal"}get isBidirectional(){return this.options.type==="bidirectional"}}const En=()=>{const n=document.createElement("canvas");n.width=256,n.height=1;const t=n.getContext("2d"),e=t.createLinearGradient(0,0,n.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,n.width,1),Et.from(n)},We=(n,t)=>{const e=new $,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},s=new Mt,r=new J;s.text=n,s.style=i;const d=()=>{r.clear(),r.roundRect(s.x-10,s.y,s.width+20,s.height,10),r.fill("black"),r.alpha=.5};e.addChild(r,s);const a=h=>{s.text=h,d()};return d(),{view:e,updateText:a}},Sn=n=>{const t=En(),e=new G(t);return e.label="gradient-background",e.position.set(n.x,n.y-2.5),e.width=n.width+16,e.height=n.height+5,n.addChildAt(e,0),e},qt=n=>{const{viewModel:t,includeItemValue:e,quantity:i}=n,s=n.itemValue,r=new $;let d=!1;r.label=`${t.name()}-view`,r.eventMode="static";const a=G.from(`${t.code()}.png`);a.width=50,a.height=50,r.addChild(a);const h=We(`${(i==null?void 0:i.toString())??t.quantity().toString()}`);h.view.position.set(a.width-h.view.width*.5,a.height);let l=null;e&&(l=We(`$ ${(s||t.value()).toString()}`,{fill:"gold"}),l.view.position.set(a.width-l.view.width*.5,0),r.addChild(l.view),a.position.set(0,l.view.height+5),h.view.position.set(a.width-h.view.width*.5,l.view.height+a.height));const c=a.y+a.height,o=(v,m)=>{const b=new $;return m()<=0||(d=!0,Array(m()).fill(0).forEach((x,A)=>{const M=G.from(`${v}-icon.png`);M.width=20,M.height=20,M.position.set(2.5+A*M.width*.5,0),b.addChildAt(M,0)}),Sn(b),b.position.set(0,c-b.height+14),r.addChild(b)),b};t.isArmourIconVisible()&&o("armour",t.armour);const f=new $;if(t.isHealthIconVisible()&&o("health",t.health),t.isDamageIconVisible()&&t.damage()>0&&t.range()>0){const v=o("damage",t.damage),m=o("range",t.range);m.position.set(v.x,v.y-m.height)}const p=G.from("armour-broken-icon.png");p.width=20,p.height=20,p.position.set(0,a.height-p.height),r.addChild(h.view,p,f),r.on("pointertap",()=>{u()}),d&&a.position.set(16,a.y);const u=()=>{t.interact(),it.play("audio/sfx/collect.wav",{category:"gameplay"})},g=ht(()=>{lt(()=>{h.updateText((i==null?void 0:i.toString())??t.quantity().toString()),p.visible=t.maxArmour()>0&&t.armour()<=0})});return r.on("destroy",()=>{g()}),{view:r,interact:u}},An=(n,t)=>{const i=new J;return i.roundRect(-2.5,-2.5,n.view.width+2.5*2,n.view.height+2.5,10),i.fill(t??"gray"),i.alpha=.8,i.eventMode="static",i},Ft=(n,t)=>{const e=new $;e.addChild(n.view),e.label=`${n.view.label}-container`,e.eventMode="static";const i=An(n,t);return e.addChild(i,n.view),{container:e,background:i}},se=({content:n,onClick:t})=>{const e=new $,i=new J,s=new Mt,r=3,d=10;return s.text=n,s.style={fontSize:30,fill:"black",align:"center",fontFamily:"alagard"},i.roundRect(-r,-r,s.width+r*2,s.height+r*2,d),i.fill("khaki"),e.addChild(i,s),e.eventMode="static",e.on("pointertap",t),e},Pn=n=>{const t=new $,e=10;t.label="global-inventory-view",t.eventMode="static";const i=Kt({text:n.ownerName(),fontSize:26,disableBackground:!0}),s=G.from("text-background.png"),r=G.from("text-background.png"),d=new J;t.addChild(s,i,d);const a=()=>{s.width=l.width,s.height=i.height,r.width=l.width,r.height=g.height*2,r.position.set(0,l.height+g.height*2),d.clear(),d.label="title-background-stroke",d.rect(s.x,s.y,s.width,s.height),d.rect(r.x,r.y,r.width,r.height),d.stroke({color:"khaki",width:2})},h=innerWidth<innerHeight,l=new de({width:h?innerWidth:innerWidth*.8,height:h?innerHeight*.6:innerHeight*.8,padding:e,radius:10,elementsMargin:e}),c=se({content:"Inspect",onClick:()=>{n.setInfoButtonEnabled(!n.isInfoButtonEnabled()),c.tint=n.isInfoButtonEnabled()?"lightgreen":"white"}});l.label="global-inventory-scroll-box",l.position.set(0,i.height+e),t.addChild(l,r,c),t.visible=!1;const o=(m,b)=>b.weapon().id()===m.id()||b.bodyArmour().id()===m.id()||b.headArmour().id()===m.id()||b.feetArmour().id()===m.id(),f=m=>{m=m??!1,l.removeItems();const b=1.5;n.stacks().forEach(x=>{const A=qt({viewModel:x.item,includeItemValue:m,quantity:x.quantity}),M=new $,D=n.owner?o(x.item,n.owner):!1,E=Ft(A,D?"lightgreen":"gray");M.on("pointertap",()=>{_()}),M.addChild(E.background,E.container),M.label=`${A.view.label}-container`,l.addItem(M);const I=Math.min(b,Math.min((l.width-e*2)/M.width,(l.height-e*2)/M.height));M.scale.set(I),A.view.off("pointertap");const _=()=>{if(n.isInfoButtonEnabled()){R.emit("ON_INFO_MODAL_OPEN",{title:x.item.name(),content:x.item.description(),type:x.item.type()});return}A.interact();const P=M.tint;M.tint="green",setTimeout(()=>{M.tint=P},200)}})},p=(m=!1)=>{f(m),n.setInfoButtonEnabled(!1),it.play("audio/sfx/inventory-open.wav",{category:"gameplay"}),t.visible=!0},u=()=>{n.setInfoButtonEnabled(!1),R.emit("ON_CLOSE_INVENTORY_REQUESTED")},g=se({content:"Close",onClick:()=>{n.setInfoButtonEnabled(!1),R.emit("ON_CLOSE_INVENTORY_REQUESTED")}});if(i.position.set(t.width*.5,i.height*.5),g.position.set(l.width-g.width,l.height+g.height*2.5),c.position.set(g.position.x-c.width-5,g.position.y),t.addChild(g),n.ownerName()!=="Hero"){const m=se({content:"Collect All",onClick:()=>{n.items().forEach(b=>{b.interact()}),it.play("audio/sfx/inventory-open.wav",{category:"gameplay"})}});m.position.set(m.width*.2,g.y),t.addChild(m)}const v=Math.max(.6,Math.min(innerWidth/t.width,innerHeight/t.height));return t.scale.set(Math.min(.6,v)),ht(()=>{lt(()=>{n.isEmpty()&&u(),n.isInfoButtonEnabled()||R.emit("ON_INFO_MODAL_CLOSE"),f(),i.position.set(l.width*.5,i.height*.5),g.position.set(l.width-g.width,l.height+g.height*2.5),c.position.set(g.position.x-c.width-5,g.position.y),a()})},t),{view:t,show:p,hide:u}},Nn=n=>{const{viewModel:t}=n,e=new $;e.label="new-trade-view",e.alpha=0;const i=new J;i.label="new-trade-view-background",e.addChild(i);const s=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let r=!1;const d=({title:I,stacks:_,width:P,height:y,playerStacks:T,npcInv:V=!1,includeItemValue:N=!1,isTradeInv:B=!1})=>{const C=new $;C.label=`${I}-screen-view`;const k=G.from("text-background.png");k.label=`${I}-title-background`;const w=new J;w.label=`${I}-title-background-outline`;const L=Kt({text:I,disableBackground:!0,onClick:()=>{}});L.label=`${I}-title-button`;const U=new de({width:P,height:y,padding:4,elementsMargin:2});U.label=`${I}-inventory-view`;const O=new J;O.label=`${I}-background`,C.addChild(O,k,L,U,w);const W=(q,et,Z)=>{const at=innerHeight>innerWidth;q.forEach(ot=>{const Y=qt({viewModel:ot.item,includeItemValue:N,itemValue:t.getItemPrice(ot.item,Z),quantity:ot.quantity}),F=Ft(Y,et==="buy"||et==="buy-return"?"pink":"lightblue"),H=new $;Y.view.off("pointertap"),H.on("pointertap",()=>{dt(),R.emit("ON_ITEM_INTERACTION",{itemViewModel:ot.item,action:et}),r=!0}),H.addChild(F.container,Y.view),H.label=`${Y.view.label}-container`,U.addItem(H);const j=at?.6:.7;H.scale.set(Math.min(j,P/(Y.view.width+10)),Math.min(j,y/(Y.view.height+10)));const dt=()=>{H.tint=65280,setTimeout(()=>{H.tint=16777215},200)}})};return V?W(_,"buy",!0):B?(W(T||[],"sell-return",!1),W(_,"buy-return",!0)):W(_,"sell",!1),L.scale.set(.4),L.position.set(P*.5,L.height*.5),U.position.set(P*.5-U.width*.5,L.height+10),k.x=U.width*.025,k.width=U.width*.95,k.height=L.height,w.rect(k.x,0,k.width,k.height),w.stroke({color:"khaki",width:2}),O.rect(0,0,C.width,C.height),O.label=`${I}-background-rect`,O.fill("black"),O.stroke("black"),C};let a=null,h=null,l=null,c=null,o=null,f=null,p=null,u=null,g=null,v=null;const m=G.from("text-background.png");m.label="trade-buttons-container-background";const b=new J;b.label="trade-buttons-container-background-outline";const x=()=>{a||h?M():it.play("audio/sfx/door.mp3");const{innerWidth:I,innerHeight:_}=window,P=_>I,y=P?I:I*.9*.3,T=P?_*.7*.3:_*.9;s(),o=xt({spriteName:"trade-icon",onClick:()=>{R.emit("ON_TRADE_REQUEST",{action:"autoTrade"}),r=!0},alpha:.8}),c=xt({spriteName:"exit-icon",onClick:()=>{R.emit("ON_CLOSE_INVENTORY_REQUESTED"),r=!0},alpha:.8});const V=()=>{v&&(e.removeChild(v),v.destroy(),v=null)},N=()=>{const k=Math.abs(t.value().quantity()),w=t.value().quantity()<0?{type:"Insufficient Funds",content:"You do not have enough funds to complete this trade."}:{type:"Trade Imbalance",content:`Trader has insufficient funds, you will lose ${k} ${k>1?"coins":"coin"}.`};v=Fe({title:"Confirm Trade",type:w.type,content:w.content,onConfirm:t.value().quantity()>0?()=>{R.emit("ON_TRADE_REQUEST",{action:"submit"}),r=!0,V()}:void 0,onCancel:()=>{R.emit("ON_TRADE_REQUEST",{action:"clear"}),V(),r=!0}}),e.addChild(v),v.position.set(e.width*.5-v.width*.25,e.height*.5-v.height*.5)};f=xt({spriteName:"confirm-icon",onClick:()=>{R.emit("ON_TRADE_REQUEST",{action:"submit"}),r=!0},alpha:.8}),p=xt({spriteName:"cancel-icon",onClick:()=>{if(t.npcTradeItems().isEmpty()&&t.playerTradeItems().isEmpty()){R.emit("ON_CLOSE_INVENTORY_REQUESTED"),r=!0;return}R.emit("ON_TRADE_REQUEST",{action:"clear"}),r=!0},alpha:.8});let B="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?B="green":t.value().quantity()>0?B="yellow":B="red");const C=qt({viewModel:t.value()});g=Ft(C,B).container,u=new $,u.label="trade-buttons-container",u.addChild(c,f,p,o),e.addChild(m,u,b),a=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:y,height:T,includeItemValue:!0,isTradeInv:!1}),e.addChild(a),a.label="player-trade-screen",h=d({title:"Trader",stacks:t.npcInventory().stacks(),width:y,height:T,npcInv:!0,includeItemValue:!0,isTradeInv:!1}),e.addChild(h),h.label="npc-trade-screen",l=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:y,height:T,includeItemValue:!0,isTradeInv:!0}),e.addChild(l),e.alpha=1,l.label="trade-screen",t.isConfirmationModalVisible()&&N()},A=(I=!1)=>{!u||!c||(b.clear(),I?(m.angle=90,m.height=c.height*1.4,m.width=u.height,m.position.set(u.x+m.height,u.y-c.height*.2-5),b.rect(m.x-m.height,m.y,m.height,m.width)):(m.angle=0,m.width=u.width,m.height=c.height*1.4,m.position.set(u.x-17,u.y+5),b.rect(m.x,m.y,m.width,m.height)),b.stroke({color:"khaki",width:2}))},M=()=>{a&&(e.removeChild(a),a.destroy(),a=null),h&&(e.removeChild(h),h.destroy(),h=null),l&&(e.removeChild(l),l.destroy(),l=null),c&&(e.removeChild(c),c.destroy(),c=null),f&&(e.removeChild(f),f.destroy(),f=null),p&&(e.removeChild(p),p.destroy(),p=null),o&&(e.removeChild(o),o.destroy(),o=null),u&&(e.removeChild(u),u.destroy(),u=null),g&&(e.removeChild(g),g.destroy(),g=null),v&&(e.removeChild(v),v.destroy(),v=null),e.alpha=0},D=(I,_)=>{if(e.alpha===0||!a||!h||!l)return;if(_>I){if(a.position.set(0,0),l.position.set(0,a.y+a.height+2),h.position.set(0,l.position.y+l.height+2),u){const y=I-20,T=u.children,V=T.reduce((C,k)=>C+k.width,0)+((g==null?void 0:g.width)??0),N=Math.min(30,T.length>1?(y-V)/T.length:0);let B=0;T.forEach(C=>{C.position.set(B,C.height*.5),B+=C.width+N}),g&&(u.addChild(g),g.position.set(u.width,g.height*.2)),u.position.set(I*.5-u.width*.5+15,h.position.y+h.height),A()}}else if(a.position.set(0,0),l.position.set(2+a.position.x+a.width,0),h.position.set(2+l.position.x+l.width,0),u){const y=_-20,T=u.children,V=T.reduce((C,k)=>C+k.height,0)+((g==null?void 0:g.height)??0),N=Math.min(30,T.length>1?(y-V)/T.length:0);let B=0;T.forEach(C=>{C.position.set(C.width*.5,B),B+=C.height+N}),g&&(u.addChild(g),g.position.set(g.width*.35,u.height-10)),u.position.set(h.position.x+h.width,_*.5-u.height*.5+20),A(!0)}};return{view:e,show:x,hide:M,resize:D,update:()=>{!r&&!t.isAutoTrading()||(r=!1,e.alpha!==0&&(x(),D(innerWidth,innerHeight)))}}},On=n=>{const{viewModel:t}=n,e=new $,i=[],s=new $;e.addChild(s),s.label="icons-container",e.visible=t.isVisible();const r=new J;r.rect(0,0,innerWidth,64),r.fill("black"),r.alpha=0,e.addChild(r);const d=[],a=()=>{s.removeChildren(),s.destroy({children:!0}),r.destroy(),e.removeChildren(),e.destroy({children:!0}),d.forEach(E=>E.kill())},h=E=>{const I=new $;I.label=`${E}-icon`,I.eventMode="static";const _=new J;_.circle(0,0,32),_.stroke({color:"khaki",width:4}),_.fill("khaki"),_.alpha=.5,I.addChild(_);const P=G.from(`${E}-icon.png`);return P.anchor.set(.5),P.width=32,P.height=32,i.push(I),I.addChild(P),s.addChild(I),I},l=h("city-key");l.on("pointertap",()=>{const E=t.canUnlockSettlement();E&&(it.play("audio/sfx/sfx-unlock.wav"),R.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:E,action:"unlock"}))});const c=h("talk");c.on("pointertap",()=>{it.play("audio/sfx/click.wav"),R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:t.canInteractWithCharacter()??void 0,action:"talk"})}),c.visible=t.canInteractWithCharacter()!==null;const o=h("trade");o.on("pointertap",()=>{const E=t.canTradeWithCharacter();if(E){R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:E,action:"trade"});return}const I=t.canTradeWithSettlement();I&&(it.play("audio/sfx/click.wav"),R.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:I,action:"trade"}))}),o.visible=t.canTradeWithCharacter()!==null||t.canTradeWithSettlement()!==null;const f=h("settlement");f.on("pointertap",()=>{const E=t.canVisitSettlement();E&&(it.play("audio/sfx/click.wav"),R.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:E,action:"trade"}))});const p=h("attack");p.on("pointertap",()=>{const E=t.canAttackCharacter();E&&R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:E,action:"attack"})});const u=h("ranged-attack");u.on("pointertap",()=>{const E=t.canRangedAttackCharacter();E&&R.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:E,action:"attack"})});const g=h("loot");g.on("pointertap",()=>{const E=t.canLoot();E&&R.emit("ON_INVENTORY_REQUEST",{inventory:E,action:"open"})});const v=h("search");v.on("pointertap",()=>{const E=t.canSearch();E&&R.emit("ON_EVENT_INTERACTION",{eventViewModel:E})});const m=h("rest");m.on("pointertap",()=>{t.canRestAtSettlement()&&(it.play("audio/sfx/click.wav"),R.emit("ON_LEVEL_COMPLETED"))});const b=()=>{let I=0;i.filter(_=>_.visible).forEach((_,P)=>{_.x=P*(_.width+16),_.y=(e.height-_.height)/2,I=P}),s.x=32+(innerWidth-(I+1)*(i[0].width+16))/2},x=async E=>{E.scale.set(0),E.alpha=0,E.visible=!0;const I=1,_=1.15,P=500,y=P*.7,T=P*.3;d.push(K.to(E,{alpha:1,duration:P/1e3,ease:"power1.inOut",onUpdate:()=>{b()}}));const V=K.to(E.scale,{x:_,y:_,duration:y/1e3,ease:"power1.inOut"});d.push(V),await V,d.push(K.to(E.scale,{x:I,y:I,duration:T/1e3,ease:"power1.inOut"}))},A=(E,I)=>{r.clear(),r.rect(0,0,E,64),r.fill("black"),r.alpha=0,b()},M=(E,I)=>{!E.visible&&I()?(E.visible=!0,x(E)):E.visible=I()!==null},D=()=>{e.visible=t.isVisible(),M(c,()=>t.canInteractWithCharacter()),M(o,()=>t.canTradeWithCharacter()||t.canTradeWithSettlement()),M(f,()=>t.canVisitSettlement()),M(p,()=>t.canAttackCharacter()),M(u,()=>t.canRangedAttackCharacter()),M(g,()=>t.canLoot()),M(v,()=>t.canSearch()),M(l,()=>t.canUnlockSettlement()),M(m,()=>t.canRestAtSettlement()),b()};return ht(()=>{lt(()=>{D()})},e),{view:e,resize:A,destroy:a}},Rn=n=>{let t=[];const e=new $;e.label="grid-container";const i=()=>{const a=innerWidth<innerHeight,h=30,l=a?(innerWidth-40)/2:innerWidth-15,c=12,o=h+10;t.forEach((f,p)=>{const u=Math.floor(p/(a?2:1)),g=p%(a?2:1);f.icon.position.set(g*l,u*(f.icon.height+c)),f.stats.position.set(f.icon.x+h*.5+o,f.icon.y+(f.icon.height-f.stats.height)/2),f.stats.scale.set(1);const v=l-o-10;f.stats.width>v&&(f.stats.width=v)}),d()},s=a=>{const{icon:h,stats:l}=a,c=Math.floor(t.length/(innerWidth<innerHeight?2:1)),o=t.length%(innerWidth<innerHeight?2:1);t.push({icon:h,stats:l,row:c,column:o}),i()},r=()=>{t=[],e.removeChildren()},d=()=>{e.removeChildren(),t.forEach(a=>{const h=new J;h.roundRect(a.icon.x-5,a.icon.y-5,a.icon.width+10,a.icon.height+10,5),h.fill("khaki"),h.stroke(16777215),h.alpha=.5,h.label="icon-background",e.addChild(h,a.icon,a.stats)})};return i(),{gridContainer:e,addDataToGrid:s,resize:i,renderGrid:d,clearDataFromGrid:r}},He=(n,t)=>{const e=new $,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},s=new Mt,r=new J;s.text=n,s.style=i;const d=()=>{r.clear(),r.roundRect(s.x-10,s.y,s.width+20,s.height,10),r.fill("black"),r.alpha=.5};e.addChild(r,s);const a=h=>{s.text=h,d()};return d(),{view:e,updateText:a}},Vn=()=>{const n=document.createElement("canvas");n.width=256,n.height=1;const t=n.getContext("2d"),e=t.createLinearGradient(0,0,n.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,n.width,1),Et.from(n)},Ln=n=>{const{playerUiVM:t,miniMapVM:e}=n,i=40,s=10,r=new $;r.label="player-ui-view";const d=Rn(),a=(Y,S,F,H,j)=>{const dt=new $,Ct=new J,z=1;Ct.rect(0,0,200,20),Ct.fill(0),Ct.stroke(16777215);const X=190/S,nt=new J;for(let st=Y>S?S-1:Y-1;st>=0;st--)nt.rect(5+st*X,5,X-z,10),st>=Y-4?nt.fill(F):st>=Y-7&&j?nt.fill(j):nt.fill(H);return dt.addChild(Ct,nt),dt},h=()=>{e.isVisible()||(y&&(y.visible=!0),P&&(P.visible=!0),T&&(T.visible=!0),c.visible=!0,o.visible=!0,g.visible=!0,u.visible=t.armour()>0&&t.maxArmour()>0,m.visible=!0,v.visible=!0,r.visible=!0)},l=()=>{r.visible=!1},c=G.from("health-icon.png");c.label="health-icon",c.anchor.set(.5),c.width=i,c.height=i;const o=G.from("torch-icon.png");o.label="torch-icon",o.anchor.set(.5),o.scale.set(.1);const f=He(`$ ${t.inventoryValue().toString()}`,{fill:"gold",fontSize:20}),p=G.from("coin.png");p.label="inventory-value-icon",p.anchor.set(.5),p.width=i,p.height=i,p.eventMode="static",f.view.eventMode="static",p.onpointertap=f.view.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Inventory Value",content:"The total value of all your inventory items.",type:`${t.inventoryValue()}`})};const u=G.from("armour-icon.png");u.label="armour-icon",u.anchor.set(.5),u.width=i,u.height=i;const g=xt({spriteName:"map-icon",onClick:()=>{e.setVisible(!e.isVisible())},onClickAudio:""}),v=xt({spriteName:"base-portrait",onClick:()=>{R.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})},onClickAudio:""}),m=xt({spriteName:"menu-icon",onClick:()=>{E(),R.emit("ON_IN_GAME_MENU_REQUEST",{action:"open"})}}),b=xt({spriteName:"min-icon",onClick:()=>{h(),R.emit("ON_IN_GAME_MENU_REQUEST",{action:"close"})},onClickAudio:"deselect"}),x=xt({spriteName:"save-icon",onClick:()=>{M.updateText("Saving..."),R.emit("ON_SAVE_REQUEST")}}),A=xt({spriteName:"load-icon",onClick:()=>{M.updateText("Loading..."),R.emit("ON_LOAD_REQUEST")}}),M=He("Game Paused"),D=()=>{m.visible=!1,M.view.visible=!0,b.visible=!0,x.visible=!0,A.visible=!0},E=()=>{m.visible=!1,g.visible=!1,v.visible=!1,c.visible=!1,o.visible=!1,u.visible=!1,P&&(P.visible=!1),T&&(T.visible=!1),y&&(y.visible=!1)},I=()=>{E(),g.visible=!0},_=()=>{e.isVisible()||(m.visible=!0,M.updateText("Game Paused"),M.view.visible=!1,b.visible=!1,x.visible=!1,A.visible=!1)};r.addChild(o,c,p,f.view,v,d.gridContainer,u,m,b,x,M.view,A,g);let P=null,y=null,T=null,V=null,N=null,B=null,C=null;const k=()=>{if(T&&r.removeChild(T),t.maxArmour()<=0||t.armour()<=0){T=null;return}T=a(t.armour(),t.maxArmour(),"blue","blue"),T.position.set(c.width+s,c.y-T.height*.5),T.label="armour-bar",r.addChild(T)},w=()=>{P&&r.removeChild(P),P=a(t.health(),t.maxHealth(),"red","red"),P.label="health-bar",P.position.set(c.width+s,c.y-P.height*.5),r.addChild(P),c.eventMode="static",P.eventMode="static",c.onpointertap=P.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Health",content:`You have ${t.health()} health points.`,type:`Max Health: ${t.maxHealth()}`})}},L=Y=>{const S=new $,F=20;S.label="stat-container";let H=0;if(Object.entries(Y).forEach(([dt,Ct],z)=>{z!==0&&(H+=S.width),Array(Ct()).fill(0).forEach((X,nt)=>{const st=G.from(dt+".png");st.width=F,st.height=F,st.position.set(H+nt*F*.5,0),S.addChildAt(st,0)})}),S.width===0)return S;const j=new G(Vn());return j.x=S.x-5,j.y=S.y-5,j.width=S.width+64,j.height=S.height+10,j.label="row-gradient-background",S.addChildAt(j,0),S},U=()=>{const Y=t.weapon();V?V.removeChildren():(V=new $,V.label="weapon-icon",r.addChild(V));const S=G.from(Y.code()+".png");S.width=i,S.height=i;const F=L({"damage-icon":()=>Y.damage(),"range-icon":()=>Y.range()});return S.eventMode="static",F.eventMode="static",S.onpointertap=V.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Weapon",content:`${Y.name()!=="Fists"?Y.name():"Nothing"} equipped.`,type:`Damage: ${Y.damage()}, Range: ${Y.range()}`})},{icon:S,stats:F}},O=()=>{const Y=t.bodyArmour();N?N.removeChildren():(N=new $,N.label="armour-icon",r.addChild(N));const S=G.from(Y.code()+".png");S.width=i,S.height=i;const F=L({"armour-icon":()=>Y.armour()});return S.eventMode="static",F.eventMode="static",S.onpointertap=u.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Body",content:`${Y.armour()===0?"Not protected":`Wearing ${Y.name()}`}`,type:`Armour: ${Y.armour()}`})},{icon:S,stats:F}},W=()=>{const Y=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Head",content:`${t.headArmour().armour()===0?"Not protected":`Wearing ${t.headArmour().name()}`}`,type:`Armour: ${t.headArmour().armour()}`})},S=t.headArmour();B?B.removeChildren():(B=new $,B.label="head-armour-icon",r.addChild(B));const F=S.code()==="head"?"base-portrait":S.code(),H=G.from(F+".png");H.width=i,H.height=i;const j=L({"armour-icon":()=>S.armour()});return H.eventMode="static",j.eventMode="static",H.onpointertap=u.onpointertap=()=>{Y()},{icon:H,stats:j}},q=()=>{const Y=t.feetArmour();C?C.removeChildren():(C=new $,C.label="feet-armour-icon",r.addChild(C));const S=G.from(Y.code()+".png");S.width=i,S.height=i;const F=L({"armour-icon":()=>Y.armour()});return S.eventMode="static",F.eventMode="static",S.onpointertap=u.onpointertap=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Feet",content:`${Y.armour()===0?"Not protected":`Wearing ${Y.name()}`}`,type:`Armour: ${Y.armour()}`})},{icon:S,stats:F}},et=()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"Torch",content:`You have ${t.torchLeft()} torches left.`,type:"Light"})},Z=()=>{y&&r.removeChild(y),y=a(t.torchLeft(),30,"red","brown","khaki"),y.label="torch-bar",P&&y.position.set(P.x,o.y-7),r.addChild(y),o.eventMode="static",y.eventMode="static",o.onpointertap=y.onpointertap=()=>{et()}},at=()=>{E(),P&&(P.visible=!0),y&&(y.visible=!0),c.visible=!0,o.visible=!0,u.visible=t.armour()>0&&t.maxArmour()>0,T&&(T.visible=!0),v.visible=!0},ot=()=>{c.position.set(10,10),u.position.set(10,10),P&&(P.position.set(c.width+s,c.y-P.height*.5),f.view.position.set(P.x,p.y-f.view.height*.5),T&&T.position.set(P.x,P.y)),y&&P&&y.position.set(P.x,o.y-7),o.position.set(10,c.height+15),p.position.set(10,o.y+o.height),d.resize(),d.gridContainer.position.set(0,p.y+p.height*.5+10),v.position.set(innerWidth-(v.width+16),10),g.position.set(innerWidth-(g.width+16),v.y+v.height+10),m.position.set(innerWidth-(m.width+16),g.y+g.height+10),b.position.set(m.x,m.y),x.position.set(m.x,m.y+m.height+10),A.position.set(m.x,x.y+x.height+10),M.view.position.set(innerWidth/2-M.view.width/2,innerHeight/2-20),r.position.set(20,20)};return _(),ot(),ht(()=>{lt(()=>{u.visible=!e.isVisible()&&t.maxArmour()>0&&t.armour()>0,c.visible&&w(),u.visible&&k(),t.torchLeft()>=0&&o.visible&&Z(),t.isSaveCompleted()?M.updateText("Save completed"):M.updateText("Game Paused"),t.isInGameMenuVisible()?D():_(),t.isInventoryValueVisible()?(p.visible=!0,m.visible=!1,f.view.visible=!0,d.gridContainer.visible=!0,d.clearDataFromGrid(),d.addDataToGrid(W()),d.addDataToGrid(U()),d.addDataToGrid(O()),d.addDataToGrid(q())):(p.visible=!1,e.isVisible()||(m.visible=!0),f.view.visible=!1,d.gridContainer.visible=!1),f.updateText(`$ ${t.inventoryValue().toString()}`),ot()})},r),{view:r,show:h,hide:l,resize:ot,showOnlyMapIcon:I,showOnlyInventoryIcon:at}},Bn=n=>{const{viewModel:t}=n,e=new $;e.label="new-trade-view";const i=new J;i.label="new-trade-view-background",e.addChild(i);const s=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let r=!1;const d=({title:v,stacks:m,width:b,height:x,playerStacks:A,npcInv:M=!1,includeItemValue:D=!1,isTradeInv:E=!1})=>{const I=new $;I.label=`${v}-screen-view`;const _=Kt({text:v,onClick:()=>{}});_.label=`${v}-title-button`;const P=new de({width:b,height:x,padding:4,elementsMargin:2});P.label=`${v}-inventory-view`;const y=new J;y.label=`${v}-background`,I.addChild(y,_,P);const T=(V,N,B)=>{V.forEach(C=>{const k=qt({viewModel:C.item,includeItemValue:D,itemValue:t.getItemPrice(C.item,B),quantity:C.quantity}),L=Ft(k,N==="buy"||N==="buy-return"?"pink":"lightblue"),U=new $;k.view.off("pointertap"),U.on("pointertap",()=>{O(),R.emit("ON_ITEM_INTERACTION",{itemViewModel:C.item,action:N}),r=!0}),U.addChild(L.container,k.view),U.label=`${k.view.label}-container`,P.addItem(U);const O=()=>{U.tint=65280,setTimeout(()=>{U.tint=16777215},200)}})};return M?T(m,"buy",!0):E?(T(A||[],"sell-return",!1),T(m,"buy-return",!0)):T(m,"sell",!1),_.scale.set(.4),_.position.set(b*.5,_.height*.5),P.position.set(b*.5-P.width*.5,_.height+10),y.rect(0,0,I.width,I.height),y.fill("black"),y.stroke("black"),I};let a=null,h=null,l=null,c=null,o=null;const f=()=>{a?p():it.play("audio/sfx/door.mp3");const{innerWidth:v,innerHeight:m}=window,b=m>v,x=b?v:v*.35,A=b?m*.35:m;s(),l=Kt({text:"Continue",onClick:()=>{l.eventMode="none",R.emit("ON_TRADE_REQUEST",{action:"confirm-bulk-trade"}),K.delayedCall(.5,()=>{R.emit("ON_CLOSE_INVENTORY_REQUESTED")}),r=!0}}),l.alpha=0,l.label="continue-button";let M="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?M="green":t.value().quantity()>0?M="yellow":M="red");const D=qt({viewModel:t.value()});o=Ft(D,M).container,c=new $,c.label="trade-buttons-container",c.addChild(l,o),l.scale.set(.4),e.addChild(c),a=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:x,height:A,includeItemValue:!0,isTradeInv:!1}),e.addChild(a),a.label="player-trade-screen",h=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:x,height:A,includeItemValue:!0,isTradeInv:!0}),e.addChild(h),h.label="trade-screen",l&&(l.alpha=t.isContinueButtonVisible()?1:0),e.visible=!0},p=()=>{a&&(e.removeChild(a),a.destroy(),a=null),h&&(e.removeChild(h),h.destroy(),h=null),l&&(e.removeChild(l),l.destroy(),l=null),c&&(e.removeChild(c),c.destroy(),c=null),o&&(e.removeChild(o),o.destroy(),o=null),e.visible=!1},u=(v,m)=>{if(!e.visible||!a||!h)return;m>v?(a.position.set(0,0),h.position.set(0,a.y+a.height+2),o&&l&&(o.position.set(-o.width*.5,-o.height*.5),l.position.set(o.x+o.width+l.width*.5,0)),c&&c.position.set(v*.5-c.width*.5,h.position.y+h.height+c.height*.5+10)):(a.position.set(0,0),h.position.set(2+a.position.x+a.width,0),o&&l&&(o.position.set(0,0),l.position.set(20,o.y+o.height+30)),c&&c.position.set(h.position.x+h.width+c.width*.5,m*.5-c.height*.5))};return{view:e,show:f,hide:p,resize:u,update:()=>{l&&(l&&(l.alpha=t.isContinueButtonVisible()?1:0),l.alpha===1&&!r)||!r&&!t.isAutoTrading()||(r=!1,e.visible&&(f(),u(innerWidth,innerHeight)))}}},Dn=n=>{const t=n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2");return t.charAt(0).toUpperCase()+t.slice(1)},Wn=n=>{const t=pt().endOfLevelSummary();let e=[],i=!0;const s=new $;s.label="log-view",s.alpha=0;const r=new $;r.label="log-grid-layout",s.addChild(r);const d=new J;r.addChild(d);const a=()=>{if(e.length>0){e.forEach(g=>g()),e=[];return}u()},h=async g=>{var E;const v=r.children.length,m=innerWidth/2-20,b=new Mt,x=g.name.toLowerCase().includes("value");b.style={fontFamily:"alagard",fontSize:20,fill:"black"},b.text=Dn(g.name),b.position.set(10,v*15);const A=new $;A.label="log-value-container",A.position.set(m+(innerWidth<innerHeight?100:0),b.y);const M=new Mt;M.style={fontFamily:"alagard",fontSize:18,fill:"black"},M.text=x?"$":"",M.text+=g.value??((E=g.to)==null?void 0:E.toString())??"",A.addChild(M),r.addChild(b),r.addChild(A),b.alpha=0,A.alpha=0,!await new Promise(I=>{K.delayedCall(g.index*.5,()=>{i||I(!0),e.shift(),I(!1)}),e.push(()=>I(!0))})&&i&&it.play("audio/sfx/sfx-thud.mp3"),b.alpha=1,A.alpha=1};Object.entries(t).sort((g,v)=>g.toLocaleString().localeCompare(v.toLocaleString())).forEach(([g,v],m)=>{h(typeof v=="string"?{name:g,value:v,index:m}:{name:g,to:v,index:m})});const l=5;d.roundRect(-l,-5,r.width+30+l*2,r.height+30+l*2,30),d.fill("khaki"),s.eventMode="static",s.on("pointertap",()=>{a()});const c=new Mt;c.text="Tap to continue",c.style={fontFamily:"alagard",fontSize:20,fill:"white"};const o=innerHeight>innerWidth;c.position.set(o?(s.width-c.width)*.5:s.width+40,o?s.height+20:s.height*.5),s.addChild(c);const f=()=>{i=!0,s.visible=!0,s.alpha=0,K.to(s,{alpha:1,duration:.5,ease:"power2.out"})},p=()=>{i=!1},u=()=>{i=!1,K.to(s,{alpha:0,duration:.5,ease:"power2.in",onComplete:()=>{s.visible=!1,n()}})};return{view:s,destroy:p,show:f,hide:u,handleAnyPress:a}},Hn={title:"Settlement",type:"Location",content:"This is a settlement where you can rest and trade."},Un={title:"Place of Interest",type:"Event",content:"It looks like there is something interesting here. Investigate?"},zn={title:"Warning!",type:"Hostiles",content:"Hostiles detected in the area. Proceed with caution."},$n=n=>{const{miniMapVM:t}=n,e=new $,i=8;e.label="minimap-view",e.visible=t.isVisible();const s=new $;s.label="minimap-tile-map";const r=new $;r.label="minimap-tiles";let d=[],a=[];const h=[],l=G.from(Et.WHITE);l.width=i,l.height=i,l.tint="blue",l.eventMode="static",l.on("pointertap",()=>{R.emit("ON_INFO_MODAL_OPEN",{title:"The Hero",type:"It's you!",content:"This is your character."})}),setInterval(()=>{l.visible=!l.visible},500),setInterval(()=>{d.forEach(u=>{u.visible=!u.visible})},222),l.position.set(t.playerPosition().x*i,t.playerPosition().y*i),t.tiles().forEach((u,g)=>{u.forEach((v,m)=>{const b=ei({viewModel:v,tileSize:i,isMiniMapTile:!0});if(v.type()==="settlement"){const x=G.from(Et.WHITE);x.width=i,x.height=i,x.tint="green",x.position.set(g*i,m*i),h.push({tileVM:v,indicator:x}),x.eventMode="static",x.on("pointertap",()=>{R.emit("ON_INFO_MODAL_OPEN",Hn)}),r.addChild(x),x.visible=v.visible()}b.view.position.set(g*i,m*i),b.view.alpha=1,b.view.visible=v.discovered(),r.addChild(b.view)})});const c=new J;c.rect(0,0,t.tiles().length*i,t.tiles()[0].length*i),c.fill("black"),c.alpha=0,r.addChild(...h.map(u=>u.indicator),...d,l),s.addChild(r),e.addChild(c,s);const o=()=>{d.forEach(u=>{e.removeChild(u),u.destroy()}),d=[],t.npcPositions().forEach(u=>{const g=G.from(Et.WHITE);g.width=i,g.height=i,g.tint="red",g.position.set(u.x*i,u.y*i),g.eventMode="static",g.on("pointertap",()=>{R.emit("ON_INFO_MODAL_OPEN",zn)}),d.push(g),r.addChild(g)})},f=()=>{a.forEach(u=>{e.removeChild(u),u.destroy()}),a=[],t.eventPositions().forEach(u=>{const g=G.from(Et.WHITE);g.width=i,g.height=i,g.tint="yellow",g.position.set(u.x*i,u.y*i),g.eventMode="static",g.on("pointertap",()=>{R.emit("ON_INFO_MODAL_OPEN",Un)}),a.push(g),r.addChild(g)})},p=()=>{h.forEach(u=>{const g=u.tileVM;u.indicator.visible=g.discovered()&&t.isVisible(),g.visible()&&u.indicator.position.set(g.position().x*i,g.position().y*i)})};return ht(()=>{lt(()=>{l.position.set(t.playerPosition().x*i,t.playerPosition().y*i),p(),o(),f()}),lt(()=>{e.visible=t.isVisible()})},e),{view:e}},qn=n=>{const t=new $,{playerMenuVM:e,miniMapVM:i}=n;let s=null,r=null,d=null,a=null,h=null,l=null,c=0,o;const f=$n({miniMapVM:i}),p=()=>{o&&(t.removeChild(o),o.destroy(),o=void 0,R.emit("ON_RESUME_INPUT"))},u=w=>{p(),R.emit("ON_PAUSE_INPUT"),o=Fe({title:w.title,content:w.content,type:w.type,contentStyle:w.contentStyle??g,onClose:()=>{w.onClose&&w.onClose(),p()},onConfirm:w.onConfirm}),t.addChild(o),o.position.set(t.width*.5-o.width*.25,t.height*.5-o.height*.5)},g={fontSize:20,fill:"white",fontFamily:"alagard",align:"center"},v=new J;v.label="background",v.alpha=0,v.on("pointertap",()=>{l==null||l.handleAnyPress()}),t.addChild(v);const m=()=>{v.clear(),v.rect(0,0,innerWidth,innerHeight),v.fill("black")},b=()=>{p(),V(),y(),v.alpha=0},x=()=>{a&&(a.view.visible=!1),v.alpha=0},A=()=>{x(),I(),M(),v.alpha=1,l=Wn(()=>{M(),R.emit("ON_LEVEL_COMPLETED")});const w=Math.min(1,Math.min(innerWidth/l.view.width,innerHeight/l.view.height));l.view.scale.set(w),l.view.position.set(innerWidth*.5-l.view.width*.5,innerHeight*.5-l.view.height*.5),t.addChild(l.view),l.show(),v.eventMode="static"},M=()=>{v.eventMode="none",l&&(l.destroy(),t.removeChild(l.view),l.view.destroy({children:!0}),l=null)},D=()=>{const w=n.playerUiVM();if(!w)return;if(a){a.view.position.set(30,30),a.view.visible=!0;return}a=Ln({playerUiVM:w,miniMapVM:i});const L=Math.min(1,Math.min(innerWidth/a.view.width,innerHeight/a.view.height));a.view.scale.set(L),a.view.position.set(30,30),c=t.children.length,t.addChild(a.view),a.view.visible=!0,a.view.label="player-ui-view"},E=()=>{const w=e();if(!w)return;w.setVisibility(!i.isVisible()),r||(r=On({viewModel:w}),t.addChild(r.view));const L=Math.min(1,Math.min(innerWidth/r.view.width,innerHeight/r.view.height));r.view.scale.set(L),r.view.position.set(innerWidth*.5-r.view.width*.5,innerHeight*.9-r.view.height*.5),r.view.visible=!0},I=()=>{r&&(r.view.visible=!1),v.alpha=0},_=w=>{y(),I(),x(),v.alpha=1,d=Bn({viewModel:w}),t.addChild(d.view),d.show()},P=w=>{y(),I(),x(),v.alpha=1,d=Nn({viewModel:w}),t.addChild(d.view),d.show(),N(innerWidth,innerHeight)},y=()=>{E(),D(),d&&(t.removeChild(d.view),d.view.destroy(),d=null),v.alpha=0,N(innerWidth,innerHeight)},T=w=>{if(I(),a==null||a.showOnlyInventoryIcon(),(w==null?void 0:w.ownerName())!=="Hero"&&(a==null||a.showOnlyInventoryIcon()),v.alpha=1,h&&!w)w=h;else if(!w)throw new Error("No inventory provided to showInventory");h=w,setTimeout(()=>{s=Pn(w),s.show(),t.addChildAt(s.view,c),N(innerWidth,innerHeight)},10)},V=(w=!0)=>{E(),a==null||a.show(),s&&(t.removeChild(s.view),s.view.destroy(),s=null),w&&(h=null),v.alpha=0},N=(w,L,U=!1)=>{m();const O=L>w;if(C(),d){d.show(),d.resize(w,L);const W=O?Math.min(1,L/d.view.height):Math.min(1,w/d.view.width);d.view.scale.set(W);const q=O?(t.width-d.view.width)*.5:0,et=O?0:(t.height-d.view.height)*.5;d.view.position.set(q,et)}if(r&&(r.resize(w,L),r.view.position.set(w*.5-r.view.width*.5,L*.9-r.view.height*.5)),a&&a.resize(),l&&A(),s&&a){if(U){V(!1),T();return}const W=O?(w-s.view.width)*.5:a.view.width*.5,q=O?a.view.y+a.view.height+10:(L-s.view.height)*.5;s.view.position.set(W,q)}o&&o.position.set(t.width*.5-o.width*.25,t.height*.5-o.height*.5)},B=()=>{d==null||d.update()};t.label="user-interface-view";const C=()=>{const w=Math.min(.7,Math.min(t.width/f.view.width,t.height/f.view.height));f.view.scale.set(w),f.view.position.set((innerWidth-f.view.width)*.5,(innerHeight-f.view.height)*.5),t.addChild(f.view)};m();const k=()=>{t.removeChildren(),v.destroy(),s=null,r==null||r.destroy(),r=null,d=null,a=null};return ht(()=>{lt(()=>{i.isVisible()?(v.alpha=1,a&&a.showOnlyMapIcon(),r&&(r.view.visible=!1)):s?v.alpha=1:(v.alpha=0,a&&a.show(),r&&(r.view.visible=!0))})},t),{showInventory:T,hideInventory:V,showTrade:P,hideTrade:y,showBulkTrade:_,view:t,closeAll:b,showPlayerMenu:E,hidePlayerMenu:I,showPlayerUi:D,resize:N,destroy:k,update:B,showEndOfLevelLog:A,hideEndOfLevelLog:M,showInfoModal:u,hideInfoModal:p}},Fn=()=>{const n=ri.map(e=>(e.code()==="torch"&&e.updateQuantity(11),zt(e.code()))),t=jt(n);return kt({model:t,ownerName:"Global Inventory"})},Gn=n=>{const{playerVM:t,tileMapVM:e}=n,i=(a,h)=>{const l=t.position().x+a,c=t.position().y+h;if(l<=0&&l>=e.tiles().length-1&&c<=0&&c>=e.tiles()[0].length-1)return;const o=e.tiles()[l][c];o&&R.emit("ON_TILE_INTERACTION",{tileViewModel:o})},s=a=>{switch(a){case"endLevel":R.emit("ON_LEVEL_COMPLETED");break;case"showInventory":R.emit("ON_INVENTORY_REQUEST",{inventory:Fn(),action:"open"});break;case"showCharacterDetails":console.debug("Showing character details");break;case"moveLeft":i(-1,0);break;case"moveRight":i(1,0);break;case"moveUp":i(0,-1);break;case"moveDown":i(0,1);break;default:console.warn(`Unknown action: ${a}`)}},r=a=>{switch(a.key){case"r":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"endLevel"});break;case"i":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"showInventory"});break;case"w":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveUp"});break;case"s":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveDown"});break;case"a":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveLeft"});break;case"d":R.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveRight"});break;case"6":R.emit("ON_SAVE_REQUEST");break;case"8":R.emit("ON_LOAD_REQUEST");break}};return document.addEventListener("keypress",r),{handleDebugActionRequest:s,destroy:()=>{document.removeEventListener("keypress",r)}}};function Yn(n){const t=[];let e=n;for(;e;)t.unshift(e.tile),e=e.previous;return t}function Yt({start:n,end:t,map:e,maxDistance:i=7}){const s=e.tiles().flat().find(o=>o.position().x===n.x&&o.position().y===n.y),r=e.tiles().flat().find(o=>o.position().x===t.x&&o.position().y===t.y);if(!s||!r)return null;const d=Math.sqrt(Math.pow(r.position().x-s.position().x,2)+Math.pow(r.position().y-s.position().y,2)),a={previous:null,tile:s,g:0},h=o=>{let f=!1,p=o.previous;for(;p;){if(p.tile.position().x===o.tile.position().x&&p.tile.position().y===o.tile.position().y){f=!0;break}p=p.previous}return f},l=[],c=o=>{if(o.tile.position().x===r.position().x&&o.tile.position().y===r.position().y){l.push(o);return}if(o.g>i||o.g>d)return;const f=e.getNeighbors(o.tile),p=o.tile.position();for(const u of f){if(!u.traversable()&&r.traversable())continue;const g=u.position(),v=Math.abs(g.x-p.x),m=Math.abs(g.y-p.y),b=v===1&&m===1?2:1,x=o.g+b;if(x>i)continue;const A={previous:o,tile:u,g:x};h(A)||c(A)}};if(c(a),l.length>0){const o=l.reduce((p,u)=>p.g<u.g?p:u),f=Yn(o);if(f.length>0)return f.shift(),f}return[]}const Qn={"bed-time":["follow"],patrol:["bed-time","follow","work"],follow:["attack"],work:["bed-time","patrol","follow"],idle:["bed-time","patrol","follow","work"],attack:["bed-time","patrol","follow","work"],spawn:["bed-time","patrol","follow","work","attack"]},Xn=n=>{const{events:t,playerVM:e,tileMapVM:i,npcTaskController:s,npcs:r,turnVM:d}=n,a=5,h=[],l=(y,T)=>{var N;const V=[];for(let B=y.x-T;B<=y.x+T;B++)for(let C=y.y-T;C<=y.y+T;C++){const k=(N=i.tiles()[B])==null?void 0:N[C];!k||Math.floor(Math.sqrt(Math.pow(k.position().x-y.x,2)+Math.pow(k.position().y-y.y,2)))>T||k.traversable()&&V.push(k.position())}return V},c=()=>e.position()||{x:0,y:0},o=()=>h.map(y=>y.position()),f=(y,T)=>{let N=5,B=null;for(;B===null||B.length===0;)if(B=Yt({start:y,end:T,map:i,maxDistance:N}),N++,N>9)return null;return B},p=y=>{const T=y.position();let V=null;const N=[];for(const B of t){const C=B.position(),k=Math.floor(Math.sqrt(Math.pow(C.x-T.x,2)+Math.pow(C.y-T.y,2)));N.push({event:B,distance:k})}N.sort((B,C)=>B.distance-C.distance);for(let B=0;B<Math.min(3,N.length);B++){const C=N[B].event,k=f(T,C.position());if(k&&k.length>0){V=C;break}}return V||null},u=y=>{y.isAlive()&&(y.setTaskList([s.createSpawnTask(y)]),y.setCanTrade(!1),h.push(y),y.getPatrolArea().length===0&&(y.setPatrolArea(l(y.position(),a)),y.setTaskList([...y.getTaskList(),s.createPatrolTask(y)])))},g=y=>{y.isAlive()&&!y.isHostile(e.team())&&(y.setTaskList([s.createWorkTask(y)]),y.setCanTrade(!0),h.push(y))},v=y=>{if(!y.isAlive()){y.setTask(null);return}if(y.isHostile(e.team())&&y.getPatrolArea().length===0&&(y.setPatrolArea(l(y.position(),a)),y.setTaskList([...y.getTaskList(),s.createPatrolTask(y)])),y.getBedLocation()===null){const T=p(y);T&&y.setBedLocation(T.position())}h.push(y)},m=(y,T)=>{const V=y.getTask();if(!V)return!0;const N=V.name();return(Qn[N]||[]).includes(T)},b=y=>{if(!y.spawnLing())return!1;const T=4;if(y.lastSpawned()===0)return y.setLastSpawned(d.getCurrentTurn()),!1;const V=d.getCurrentTurn()-y.lastSpawned()>=T;if(!V)return!1;if(V){const N=s.createSpawnTask(y);if(N)return y.setTask(N),y.setLastSpawned(d.getCurrentTurn()),!0}return!1},x=y=>{if(!y.isHostile(e.team()))return!1;if(e.isAlive()&&e.position()){const N=Math.floor(Math.sqrt(Math.pow(e.position().x-y.position().x,2)+Math.pow(e.position().y-y.position().y,2)));if(N<=1)return!1;if(N<=4&&m(y,"follow")){const B=y.getTaskList().find(C=>C.name()==="follow")||s.createFollowPlayerTask(y);if(B)return y.setTarget(e),y.setTask(B),!0}}return!1},A=y=>{const T=y.getTask(),V=n.turnVM.getCurrentTimeMin();if(V>=1200||V<480){if(T&&T.name()==="bed-time")return!0;if(m(y,"bed-time")){const N=y.getTaskList().find(B=>B.name()==="bed-time")||s.createBedTimeTask(y);if(N)return y.setTask(N),!0}}return!1},M=y=>{const T=y.getTask();if(n.turnVM.getCurrentTimeMin()>=480){if(T&&T.name()==="patrol")return!0;if(m(y,"patrol")){const N=y.getTaskList().find(B=>B.name()==="patrol");if(N)return y.setTask(N),!0}}return!1},D=y=>{var B;const T=y.getTarget(),V=1;if(!T||!T.isAlive())return y.setTarget(null),!1;if(Math.floor(Math.sqrt(Math.pow(T.position().x-y.position().x,2)+Math.pow(T.position().y-y.position().y,2)))>V)return!1;if(((B=y.getTask())==null?void 0:B.name())==="attack")return!0;if(m(y,"attack")){const C=y.getTaskList().find(k=>k.name()==="attack")||s.createAttackTask(y);if(C)return y.setTask(C),!0}return!1},E=y=>{var T;if(((T=y.getTask())==null?void 0:T.name())==="work")return!0;if(m(y,"work")){const V=y.getTaskList().find(N=>N.name()==="work");if(V)return y.setTask(V),!0}return!1},I=y=>{if(!y.isAlive()){y.setTask(null);return}b(y)||D(y)||x(y)||A(y)||M(y)||E(y)},_=()=>{h.forEach(y=>{if(!y.isAlive())return;I(y);const T=y.getTask();T&&T.name(),T&&T.execute()})};return(()=>{r.forEach(y=>{v(y)})})(),{addNpc:v,addTrader:g,addNestmother:u,playNpcTurn:_,getNpcPositions:o,getPlayerPosition:c}},jn=({npc:n,attackVM:t})=>({execute:()=>{if(!n.isAlive())return!1;const e=n.getTarget();return!e||!e.isAlive()?(n.setTask(null),!0):Math.floor(Math.sqrt(Math.pow(n.position().x-e.position().x,2)+Math.pow(n.position().y-e.position().y,2)))<=1?(t.attack(n,e),!0):!1},name:()=>"attack"}),Zn=({npc:n,tileMapVM:t,turnVM:e})=>{let i=n.getBedLocation(),s=null;return{execute:()=>{if(n.isAlive()===!1)return!1;if(e.getCurrentTimeMin()>=480&&e.getCurrentTimeMin()<1200)return n.setTask(null),!0;if(!i&&(i=n.getBedLocation(),!i))return!1;if(n.position().x===i.x&&n.position().y===i.y)return!0;if(!s){let d=5;for(;s===null||s.length===0;)if(s=Yt({start:n.position(),end:i,map:t,maxDistance:d}),d++,d>8)return!1}if(s&&s.length>0){const r=s.shift();return r&&(n.moveTo(r.position().x,r.position().y),r.position().x===i.x&&r.position().y===i.y),!0}return!1},name:()=>"bed-time"}},Kn=({npc:n,tileMapVM:t,playerVM:e})=>({execute:()=>{if(n.isAlive()===!1)return!1;const i=e.position(),s=Yt({start:n.position(),end:i,map:t});if(s&&s.length>0){const r=s.shift();if(r)return r.position().x===i.x&&r.position().y===i.y||n.moveTo(r.position().x,r.position().y),!0}return!1},name:()=>"follow"}),Jn=({npc:n,tileMapVM:t})=>{let e=n.getPatrolArea(),i=null;return{execute:()=>{if(n.isAlive()===!1||e.length===0||((!i||i.length===0)&&(i=Yt({start:n.position(),end:e[Math.floor(Math.random()*e.length)],map:t})),!i||i.length===0))return!1;const s=i.shift();return s&&n.moveTo(s.position().x,s.position().y),!0},name:()=>"patrol"}},ts=({npc:n})=>({execute:()=>n.isAlive()===!1?!1:(n.setCanTrade(!0),!0),name:()=>"work"}),es=({npc:n,addNpc:t,spawnType:e="worm"})=>({execute:()=>{if(!n.isAlive())return!1;const i=n.position(),s=$e({id:e,team:"hostile-to-player",name:"Spawned "+e.charAt(0).toUpperCase()+e.slice(1),startingSize:1,startPosition:i,startingHealth:1,startingMaxHealth:1,startingItems:[]}),r=ti(s);return t(r),!0},name:()=>"spawn"}),is=n=>{const{attackVM:t,tileMapVM:e,turnVM:i,playerVM:s}=n;return{createBedTimeTask:o=>Zn({npc:o,tileMapVM:e,turnVM:i}),createPatrolTask:o=>Jn({npc:o,tileMapVM:e}),createFollowPlayerTask:o=>Kn({npc:o,tileMapVM:e,playerVM:s}),createAttackTask:o=>jn({npc:o,attackVM:t}),createWorkTask:o=>ts({npc:o}),createSpawnTask:o=>es({npc:o,spawnType:"worm",addNpc:n.addNpc})}},Xt=(n,t)=>n.id()===t.id(),ns=()=>({use:(n,t)=>{if(n.health()!==0){if(t.health()>=t.maxHealth())return;if(t.id()==="player"){const e=Math.min(n.health(),t.maxHealth()-t.health());pt().log.totalHealing+=e}t.setHealth(t.health()+n.health()),t.inventory().removeItem(n),n.updateQuantity(0);return}n.type()==="weapon"&&(Xt(t.weapon(),n)?t.setWeapon(void 0):t.setWeapon(n)),n.type()==="armour"&&(Xt(t.bodyArmour(),n)?t.setBodyArmour(void 0):t.setBodyArmour(n)),n.type()==="helmet"&&(Xt(t.headArmour(),n)?t.setHeadArmour(void 0):t.setHeadArmour(n)),n.type()==="shoes"&&(Xt(t.feetArmour(),n)?t.setFeetArmour(void 0):t.setFeetArmour(n))}}),ss=()=>{let n=null,t=null;const e=222,[i,s]=Q(!1),[r,d]=Q(!0),[a,h]=Q(!1),[l,c]=Q(!1),[o]=Q($t({model:zt("coin")})),f=kt({model:jt([]),ownerName:"trade"}),p=kt({model:jt([]),ownerName:"trade-npc"}),u=(w,L)=>{n=w,t=L,m(I()),m(E())},g=w=>{y().addItem(w,1),f.removeItem(w,1)},v=w=>{T().addItem(w,1),p.removeItem(w,1)},m=w=>{let L;w===f?L=g:L=v,w.items().forEach(U=>{L(U,!0),w.removeItem(U,1)})},b=w=>{const L=y().getItem(w);L&&(f.addItem(L,1),y().removeItem(L,1))},x=w=>{const L=T().getItem(w);L&&(p.addItem(L,1),T().removeItem(L,1))},A=()=>{m(I()),m(E()),o().updateQuantity(0)},M=(w=!1)=>{if(!n||!t)throw new Error("Player or NPC inventory is not set");return!a()&&!l()&&_()!==0?(h(!0),!1):o().quantity()<0?!1:((a()&&!l()||l()&&!a()||_()===0)&&w&&D(),a()&&h(!1),!0)},D=()=>{if(i()){const w=Math.floor(o().quantity());Array(w).fill(0).forEach(()=>{const L=$t({model:zt("coin")});E().addItem(L)}),w>0&&it.play("audio/sfx/sfx-sell.mp3")}f.items().forEach(w=>{T().addItem(w,w.quantity()),f.removeItem(w,w.quantity())}),p.items().forEach(w=>{pt().log.tradedItemsValue+=P(w,!0),y().addItem(w,w.quantity()),p.removeItem(w,w.quantity())}),m(I()),m(E()),i()&&s(!1)},E=()=>(o().updateQuantity(_()),p),I=()=>(o().updateQuantity(_()),f),_=()=>{const w=f.stacks().reduce((U,O)=>U+P(O.item,!1)*O.quantity,0),L=p.stacks().reduce((U,O)=>U+Math.max(1,P(O.item,!0)*O.quantity),0);return Math.floor(w)-Math.ceil(L)},P=(w,L)=>{const U=w.value()*w.quantity(),W=L&&!["coin","torch"].includes(w.code())?2:1;return U*W},y=()=>{if(n)return n;throw new Error("Player inventory is not set")},T=()=>{if(t)return t;throw new Error("NPC inventory is not set")},V=async()=>{await N(!1),await K.delayedCall(.2,()=>{}),s(!1)},N=async(w=!0)=>{if(!n||!t)throw new Error("Invalid inventories to auto trade");s(!0);const L=n.stacks().reduce((U,O)=>(O.quantity>0&&O.item.type()==="loot"&&U.push(O),U),[]);for(const U of L){await K.delayedCall(e/1e3,()=>{});for(let O=0;O<U.quantity;O++)w?it.play("audio/sfx/sfx-sell.mp3",{category:"gameplay"}):it.play("audio/sfx/collect.wav",{category:"gameplay"}),b(U.item)}};return{isConfirmationModalVisible:a,startTrade:u,cancelTrade:A,acceptTrade:M,playerTradeItems:I,acceptBulkTrade:()=>{l()&&(M(!0),c(!1))},value:o,npcTradeItems:E,playerInventory:y,npcInventory:T,selectItemToBuy:x,selectItemToSell:b,returnItemToPlayer:g,returnItemToNpc:v,clearTrade:()=>{if(a()){h(!1);return}m(I()),m(E()),h(!1),o().updateQuantity(0)},getItemPrice:P,bulkTrade:async()=>{c(!0),await K.delayedCall(.5,()=>{}),d(!1),await N(),await K.delayedCall(.5,()=>{}),d(!0)},autoTrade:V,isAutoTrading:i,isContinueButtonVisible:r}},os=n=>{if(n.length===0)return{x:0,y:0};const t=n.reduce((r,d)=>r+d.x,0),e=n.reduce((r,d)=>r+d.y,0),i=t/n.length,s=e/n.length;return{x:i,y:s}},Ue=(n,t)=>Math.abs(n.x-t.x)<=1&&Math.abs(n.y-t.y)<=1,rs=n=>{let t="idle",e="idle";return{get:()=>t,set:d=>{t!==d&&(e=t,d==="end-turn"?(n(),t="idle"):t=d)},getPrevState:()=>e}},as=n=>{const{tileMapViewModel:t,playerViewModel:e,userInterfaceView:i,gameView:s,playerUiVM:r,attackVM:d}=n,a=rs(n.onPlayerTurnCompleted),h=ns(),l=1;let c=null,o=null,f=null,p=!1;const u=()=>e.isAlive()&&a.get()!=="busy",g=C=>{const{action:k,trader:w}=C;if(!(w&&!w.canTrade())&&u()){if(a.set("trading"),w&&!o)if(o=ss(),o.startTrade(e.inventory(),w.inventory()),k==="autoTrade"){o.bulkTrade(),i.showBulkTrade(o);return}else{i.showTrade(o);return}if(o){if(k==="autoTrade"&&o.autoTrade(),k==="clear"){o.clearTrade();return}if(k==="confirm-bulk-trade"){o.acceptBulkTrade();return}k==="submit"&&o.acceptTrade(!0)}}},v=C=>{var k;if(c){c.ownerName()===e.name()&&y();return}if(!o&&u()){if(C.isEmpty()){a.set("idle"),c=null;return}if(C.isOnlyLoot()&&C.ownerName()!==e.name()){i.update(),D(C);return}a.set("inventory-handling"),c=C,i.showInventory(C),(k=r())==null||k.isInventoryValueVisible(!0)}},m=()=>{if(p){x();return}},b=()=>{var w;if(!f||!p)return;const C=f.shift(),k=e.position();if(t.tiles()[k.x][k.y].setIsSelected(!1),!C){p=!1,(w=s())==null||w.hidePathTrigger();return}T({x:C.position().x,y:C.position().y})},x=()=>{var C;p=!1,(C=s())==null||C.hidePathTrigger(),f&&(f.forEach(k=>k.setIsSelected(!1)),f=null),t.tiles()[e.position().x][e.position().y].setIsSelected(!1)},A=C=>{var k;a.set("busy"),(k=r())==null||k.showInGameMenu(C==="open"),C!=="open"&&a.set(a.getPrevState()||"idle")},M=(C,k)=>{u()&&(a.set("inventory-handling"),k==="open"?v(C):y())},D=C=>{C.items().forEach(k=>{var w;e.inventory().addItem(k),C.removeItem(k),(w=s())==null||w.animateIconFloat(k.code(),e.position())}),it.play("audio/sfx/inventory-open.wav",{category:"gameplay",volume:1}),c=null,a.set("end-turn")},E=C=>{var O,W;const{settlement:k,action:w}=C,L=k.positions(),U=os(L);if(u()){if(w==="unlock"){const q=e.inventory().getItemByCode("city-key");if(!q)throw new Error("City key is required to unlock the settlement");k.setIsUnlocked(!0),e.inventory().removeItem(q),(O=s())==null||O.createTextBox({id:()=>"settlement",dialogue:()=>"Welcome!",position:()=>({x:U.x,y:U.y})});return}if(w==="trade"&&k.isUnlocked()){g({action:"trade",trader:{canTrade:()=>!k.inventory().isEmpty(),inventory:()=>k.inventory()}});return}(W=s())==null||W.createTextBox({id:()=>"settlement",dialogue:()=>"City key required",position:()=>({x:U.x,y:U.y})})}},I=()=>{o&&(o.cancelTrade(),i.closeAll(),o=null),a.set("idle")},_=C=>{const{action:k,character:w}=C;if(!u()||!w)return;if(k==="talk"){const W=s();if(!W)return;W.createTextBox(w),a.set("idle");return}const L=Math.floor(Math.sqrt(Math.pow(w.position().x-e.position().x,2)+Math.pow(w.position().y-e.position().y,2))),U=L<=l,O=L<=e.weapon().range();if(w.isHostile(e.team())&&O&&w.health()>0){d.attack(e,w),a.set("end-turn");return}if(!U){T(w.position());return}if(!w.inventory().isEmpty()){if(w.canTrade()){g({action:"change-to-buy",trader:w});return}v(w.inventory());return}if(w.inventory().isEmpty()){T(w.position());return}v(w.inventory())},P=(C,k)=>{if(a.get()==="idle"&&u()){if(Ue(C.position(),e.position())&&(!C.discovered()||!C.inventory().isEmpty())){C.interact(k),v(C.inventory());return}T(C.position())}},y=()=>{var C,k;if(c){if(c.ownerName()===e.name()){c=null,a.set("idle"),(C=r())==null||C.isInventoryValueVisible(!1),i.hideInventory();return}c=null,a.set("end-turn"),(k=r())==null||k.isInventoryValueVisible(!1),i.hideInventory();return}o&&I(),a.set("idle")},T=({x:C,y:k})=>{var U,O,W;if(a.get()!=="idle"||!u())return;const w=e.position();if(Ue({x:C,y:k},w)&&t.isValidMove(C,k)){if(f&&!p)(U=s())==null||U.hidePathTrigger(),t.tiles()[w.x][w.y].setIsSelected(!1),f.forEach(q=>q.setIsSelected(!1)),f=null;else if(p){let q=222;C-w.x===0&&k-w.y===0&&(q=10),K.delayedCall(q/1e3,()=>b())}V(C-w.x,k-w.y);return}f&&f.length>1&&f[f.length-1].position().x===C&&f[f.length-1].position().y===k&&(t.tiles()[w.x][w.y].setIsSelected(!1),p=!0,b()),f&&((O=s())==null||O.hidePathTrigger(),t.tiles()[w.x][w.y].setIsSelected(!1),f.forEach(q=>q.setIsSelected(!1)),f=null);const L=f=Yt({start:w,end:{x:C,y:k},map:t,maxDistance:22});if(L&&L.length>1){L.forEach(et=>et.setIsSelected(!0));const q=L[L.length-1];(W=s())==null||W.showPathTrigger(q.position())}},V=(C,k)=>{if(a.set("moving"),!u())return;const w=e.position().x+C,L=e.position().y+k;t.isValidMove(w,L)&&e.moveTo(w,L),a.set("end-turn")};return{handlePlayerMoveRequest:T,handleTileInteraction:C=>{a.get()==="idle"&&u()&&T(C.position())},handleCharacterInteraction:_,handleEventInteraction:P,handleItemInteraction:(C,k)=>{var w;if(u()){if(a.get()==="trading"){if(k==="sell"){o==null||o.selectItemToSell(C);return}if(k==="buy-return"){o==null||o.returnItemToNpc(C);return}if(k==="sell-return"){o==null||o.returnItemToPlayer(C);return}if(k==="buy"){o==null||o.selectItemToBuy(C);return}}if(c&&c.ownerName()!==e.name()){e.inventory().addItem(C),c.removeItem(C),(w=s())==null||w.animateIconFloat(C.code(),e.position());return}h.use(C,e)}},handleCloseInventoryRequest:y,handleTradeRequest:g,handleTradeCancel:I,handleSettlementInteraction:E,handleInventoryRequest:M,handleInGameMenuRequest:A,autoMove:b,stopAutoMove:x,handleAnyAction:m}},ls=n=>{const{turnVM:t,handleEndUpTurnUpdates:e,playerVM:i,enemyVMs:s,npcController:r}=n;let d=0;const a=()=>{var f;const o=pt().log;o.turns+=1,o.npcsKilled=s.filter(p=>!p.isAlive()).length,o.npcsAlive=s.filter(p=>p.isAlive()).length,o.mostUsedWeapon=((f=i.inventory().items().filter(p=>p.type()==="weapon").sort((p,u)=>u.uses()-p.uses())[0])==null?void 0:f.name())||"fists"},h=async()=>{c(),await e(),t.nextTurn(),l(),a()},l=async()=>{if(d+=1,d%10===0){const o=i.inventory().getItemByCode("torch");o&&i.inventory().removeItem(o)}},c=()=>{r.playNpcTurn()};return{handlePlayerTurnEnded:h,playNpcTurn:c}},cs=()=>{const[n,t]=Q(void 0);return{attack:async(e,i)=>{const s=e.weapon().range()>2,r=e.weapon().range()<=2,a=e.position().distanceTo(i.position())>1,l=e.weapon().damage();r||a&&s?i.takeDamage(l):!a&&s&&i.takeDamage(Math.min(1,Math.floor(l/2))),t({source:e,target:i,type:s&&a?"ranged":"melee"});const c=pt().log;e.id()==="player"&&(c.totalDamageDealt+=l,e.weapon().setUses(e.weapon().uses()+1),r||a&&s?r?pt().log.meleeAttacks+=1:pt().log.rangedAttacks+=1:!a&&s&&(pt().log.meleeAttacks+=1))},isAttacking:()=>n(),clearAttack:()=>{t(void 0)}}},hs=n=>{const{tileMapVM:t}=n,[e,i]=Q(!1),[s,r]=Q({x:0,y:0}),[d,a]=Q([]),[h,l]=Q([]);return{isVisible:e,setVisible:i,updateDiscoveredTiles:o=>{const f=t.tiles(),p=5,u=Math.max(0,o.x-p),g=Math.max(0,o.y-p),v=Math.min(f.length-1,o.x+p),m=Math.min(f[0].length-1,o.y+p);for(let b=u;b<=v;b++)for(let x=g;x<=m;x++){const A=f[b][x];A&&A.handleTileDiscovered()}},tiles:()=>t.tiles(),npcPositions:d,setNpcPositions:a,playerPosition:s,setPlayerPosition:r,eventPositions:h,setEventPositions:l}};K.registerPlugin(ce);ce.registerPIXI(hi);const ds=n=>n<=3?1:n<=6?2:n<=10?3:n<=15?4:5,us=({view:n,saveController:t,onGameLoadRequest:e,onLevelCompleted:i,onGameOver:s})=>{const[d,a]=Q(he({model:ze({id:"dontUse",team:"player",name:"Player",startPosition:{x:0,y:0},startingHealth:10,startingMaxHealth:10,startingItems:[]})}));let h=null,l=null,c=null,o=null,f=null,p=null,u=null,g=null,v=null,m=null,b=null,x=[],A=[],M=null,D=[],E=1,I=null,_=null,P=null,y=!1,T=!1,V={x:0,y:0},N=null;const B=()=>{if(!I)throw new Error("Level models are not initialized");return I},C=S=>{I=S;const F=Di(S);b=F.tileMapVM,a(F.playerVM),x=F.npcVMs,A=F.eventVMs,D=F.settlementVMs;const H=cs();f=qi({playerVM:d()}),p=S.fogOfWarViewModel,h=$i({playerVM:d(),npcVMs:x,settlementVMs:D,eventViewModels:A}),N=hs({tileMapVM:b}),u=qn({playerMenuVM:()=>h,playerUiVM:()=>f,miniMapVM:N}),g=Wi({model:Oi()}),o=is({tileMapVM:b,playerVM:d(),turnVM:g,attackVM:H,addNpc:dt=>{_==null||_.addNpc(dt),c==null||c.addNpc(dt)}}),c=Xn({playerVM:d(),npcs:x,tileMapVM:b,events:A,npcTaskController:o,turnVM:g}),v=ls({turnVM:g,playerVM:d(),enemyVMs:x,npcController:c,handleEndUpTurnUpdates:async()=>{await(_==null?void 0:_.handleEndOfTurnUpdates()),ot(),d().isAlive()&&((g==null?void 0:g.getCurrentTurn())??0)%30===0&&q(!0)}});const j=()=>{d().inventory().getItemByCode("torch")?p==null||p.setToFullLight():p==null||p.setToLowLight()};l=as({attackVM:H,tileMapViewModel:b,playerViewModel:d(),userInterfaceView:u,playerUiVM:()=>f,onPlayerTurnCompleted:()=>{v==null||v.handlePlayerTurnEnded(),j()},gameView:()=>_}),_=en({tileSize:64,playerVM:d(),tileMapVM:b,npcVMs:x,eventVMs:A,settlementVMs:D,attackVM:H}),m=Gi({gameViews:{gameView:_.view,nonSkewedView:_.nonSkewedContainer},userInterfaceView:u.view,fogOfWarVM:p}),M=Gn({playerVM:d(),tileMapVM:b})},k=()=>{console.debug("Unloading level..."),P==null||P.destroy(),m==null||m.destroy(),h=null,l=null,c=null,o=null,f=null,p=null,n.detachAll(),u==null||u.destroy(),u=null,g=null,v=null,m=null,b=null,x=[],A=[],M==null||M.destroy(),M=null,D=[],I=null,_==null||_.destroy()},w=()=>{const S=x.filter(j=>j.isAlive()),F=x.length-S.length,H=d().position();H&&(E>=ds(F)||(E++,S.forEach(j=>{j.position().distanceTo(H)<5||j.setMaxHealth(j.maxHealth()+2)})))},L=()=>{const S=d().position(),F=5;S&&(b==null||b.tiles().forEach(H=>{H.forEach(j=>{j.setVisible(Math.abs(j.position().x-S.x)<=F&&Math.abs(j.position().y-S.y)<=F)})}),A.forEach(H=>{H.setVisible(Math.abs(H.position().x-S.x)<=F&&Math.abs(H.position().y-S.y)<=F)}),x.forEach(H=>{H.setVisible(Math.abs(H.position().x-S.x)<=F&&Math.abs(H.position().y-S.y)<=F)}),D.forEach(H=>{H.setIsVisible(Math.abs(H.positions()[0].x-S.x)<=F&&Math.abs(H.positions()[0].y-S.y)<=F)}))},U=async()=>{if(!y&&!T){y=!0,l==null||l.handleTradeRequest({action:"autoTrade",trader:{canTrade:()=>!0,inventory:()=>kt({model:jt([]),ownerName:"Bulk Trader"})}});return}if(y=!1,!T){T=!0,u==null||u.showEndOfLevelLog();return}i(I),await O()},O=async()=>{!m||!u||(it.disableCategory("gameplay"),u.view.visible=!1,await K.to(m.view,{duration:5,alpha:0}),m.view.visible=!1,q(),k())},W=()=>{P=Ni({handleAnyEvent:()=>{l==null||l.handleAnyAction()},handleInfoModalOpenRequest:S=>{u==null||u.showInfoModal(S)},handleInfoModalCloseRequest:()=>{u==null||u.hideInfoModal()},handleLevelCompleted:U,handleTileInteraction:S=>{l==null||l.handleTileInteraction(S)},handleItemInteraction:(S,F)=>{l==null||l.handleItemInteraction(S,F)},handleEventInteraction:S=>{l==null||l.handleEventInteraction(S,d())},handleCharacterInteraction:S=>{l==null||l.handleCharacterInteraction({character:S,action:"interact"})},onCloseInventoryRequested:()=>{l==null||l.handleCloseInventoryRequest(),y&&U()},handleInventoryRequest:(S,F)=>{l==null||l.handleInventoryRequest(S,F)},handleTradeRequest:S=>{l==null||l.handleTradeRequest({action:S})},handleCharacterInteractionRequest:({character:S,action:F})=>{l==null||l.handleCharacterInteraction({action:F,character:S})},handleSettlementInteractionRequest:({settlement:S,action:F})=>{l==null||l.handleSettlementInteraction({settlement:S,action:F})},handleInGameMenuRequest:S=>{l==null||l.handleInGameMenuRequest(S)},onDebugActionRequested:S=>{M==null||M.handleDebugActionRequest(S)},handleSaveRequest:q,handleLoadRequest:et})},q=(S=!1)=>{console.debug(S?"Autosaving...":"Saving game state...");const F=B(),H={...F,tileModels:F.tileMapModel.tiles().map(j=>j.map(dt=>dt))};t.save(H,S),f==null||f.setIsSaveCompleted(!0)},et=()=>{console.debug("Loading game state..."),e();const S=t.load();if(!S){console.warn("No saved game state found.");return}R.emit("ON_PAUSE_INPUT"),k(),Z(S)},Z=S=>{console.debug("Loading level..."),C(S??Ge()),W(),u==null||u.showPlayerMenu(),u==null||u.showPlayerUi(),!(!m||!u)&&(m.view.visible=!1,u.view.visible=!1,n.attachCamera(m),n.attachUi(u),n.resize(innerWidth,innerHeight))},at=()=>{!m||!u||(it.enableCategory("gameplay"),it.stopMusic({fadeOut:!0}),L(),m.view.visible=!0,u.view.visible=!0,n.resize(innerWidth,innerHeight),ot(),m&&m.moveTo(d().position().x*64,d().position().y*64))},ot=()=>{N==null||N.setPlayerPosition(d().position()),N==null||N.updateDiscoveredTiles(d().position());const S=x.reduce((H,j)=>(j.isAlive()&&j.visible()&&H.push(j.position()),H),[]);N==null||N.setNpcPositions(S);const F=A.reduce((H,j)=>(j.visible()&&!j.inventory().isEmpty()&&H.push(j.position()),H),[]);N==null||N.setEventPositions(F)},Y=S=>{u==null||u.update()};return ht(()=>{lt(()=>{(d().position().x!==V.x||d().position().y!==V.y)&&(L(),w(),V={x:d().position().x,y:d().position().y},m&&m.moveTo(d().position().x*64,d().position().y*64)),d().isAlive()||(console.debug("Player is dead, handling game over..."),K.delayedCall(1,()=>{s(),k()}))})}),{loadLevel:Z,showGameView:at,update:Y,getState:B}},Ms=n=>{const{mainMenuVM:t,view:e,loadingScreenVM:i,saveController:s}=n,r=()=>{i.showLevelLoadScreen(),i.setVisible(!0),setTimeout(()=>{i.setVisible(!1),g.showGameView(),R.emit("ON_RESUME_INPUT")},2e3)},d=()=>{console.debug("Resetting game progress..."),s.clear(),pt().reset()},a=v=>{console.debug("Preparing next level...");const m=Ge();v.playerModel.moveTo(m.playerModel.position().x,m.playerModel.position().y),m.playerModel=v.playerModel;const b=m.playerModel.inventory().items().filter(M=>M.code()==="torch").length,x=Math.max(0,30-b);oe("torch",x).forEach(M=>m.playerModel.inventory().addItem(M));const A=Math.abs(Math.max(-5,m.playerModel.health()-m.playerModel.maxHealth()));return m.playerModel.setHealth(m.playerModel.health()+A),m},h=async v=>{i.showRestScreen(),i.setVisible(!0),await K.delayedCall(8,()=>{g.loadLevel(a(v))}),await K.delayedCall(2,()=>{i.setVisible(!1),g.showGameView(),R.emit("ON_RESUME_INPUT")})},l=(v=!1,m=!1)=>{const b=s.load(m);v?i.showDebugScreen():b&&i.showLevelLoadScreen(),i.setVisible(!0),t.hide(),g.loadLevel(v?void 0:b);const x=ht(()=>{lt(()=>{i.isVisible()||(g.showGameView(),R.emit("ON_RESUME_INPUT"),x())})})},c=()=>{const v=pt().log.lastVersion.split("."),m="1.1.3".split(".");(v[0]!==m[0]||v[1]!==m[1])&&t.setIsZakathUpdateVisible(!0)},o=()=>{console.debug("Starting game..."),t.setIsContinueButtonVisible(s.saveExists()),t.setIsAutoSaveAvailable(s.autoSaveExists()),s.loadLog(),c(),t.show()},f=()=>{console.debug("Exiting game...")},p=v=>{g.update(v)},g=us({view:e,saveController:s,onGameLoadRequest:r,onLevelCompleted:h,onGameOver:()=>{console.debug("Game Over"),R.emit("ON_PAUSE_INPUT"),i.showGameOverScreen(),i.setVisible(!0);const v=ht(()=>{lt(()=>{i.isVisible()||(t.show(),v())})})}});return{loadLevel:l,initGame:o,exitGame:f,update:p,resetProgress:d}};export{Ms as createGameController};
