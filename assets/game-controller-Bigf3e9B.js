import{c as rt,g as X,S as J}from"./sound-manager-ClQMP4j_.js";import{g as Tt,h as tt,A as ae,d as gt,i as ne,j as $e,k as ze,e as ni,f as oi,m as ue,G as pt,n as Xt}from"./npc-model-DgI3975p.js";import{R as jt,E as si,G as Z,i as fe,C as $,P as qe,S as G,T as Et,f as ri,j as ai,k as Ge,l as li}from"./index-9HwvRxxJ.js";import{c as F,a as at}from"./solid-lwVvZ318.js";import{c as Zt,b as ut,a as le}from"./modal-view-BQH7WTwB.js";const ci=(o,t,e)=>{if(o<=0)return;const i=[...t];i.sort((s,d)=>{const r=s.position().distanceTo(e.position()),l=d.position().distanceTo(e.position());return r-l});const n=Math.min(4,Math.floor(i.length/o));for(let s=0;s<o;s++){const d=Tt("city-key"),r=Math.floor(Math.random()*100)<=33?0:Math.floor(Math.random()*100)<=66?1:2,l=Math.min(i.length-1,r+Math.floor((s+1)*n)),c=i[l];i.splice(r,1),c.inventory().addItem(d)}},hi=({map:o,rooms:t,pathEnemyChance:e=.2,paths:i})=>{const s=(c,h)=>c>0&&h>0&&c<o.length-1&&h<o[0].length-1,d=(c,h,a,f)=>Math.sqrt((c-a)**2+(h-f)**2),r=(c,h,a)=>a.every(f=>d(f.position().x,f.position().y,c,h)>=10),l=[];return t.forEach((c,h)=>{if(h===0)return;const a=Math.floor(Math.random()*2);for(let f=0;f<a;f++){const[p,u]=c[Math.floor(Math.random()*c.length)];if(s(p,u)&&r(p,u,l)){const y=o[p][u];y.hasEnemy()||(y.hasEnemy=()=>!0,l.push(y))}}}),i.forEach((c,h)=>{h!==0&&c.forEach(([a,f])=>{if(Math.random()<e&&s(a,f)&&r(a,f,l)){const p=o[a][f];p.hasEnemy()||(p.hasEnemy=()=>!0,l.push(p))}})}),l},di=({map:o,rooms:t,pathEventChance:e=.1,paths:i})=>{const s=[],d=(l,c)=>l>0&&c>0&&l<o.length-1&&c<o[0].length-1,r=(l,c,h,a)=>Math.sqrt((l-h)**2+(c-a)**2);return t.forEach(l=>{const c=l.length/2,h=Math.floor(Math.random()*c)+2;for(let a=0;a<h;a++){const[f,p]=l[Math.floor(Math.random()*l.length)];if(d(f,p)&&s.every(u=>r(u.position().x,u.position().y,f,p)>=3)){const u=o[f][p];!u.hasEvent()&&u.traversable()&&u.type()!=="settlement"&&(u.hasEvent=()=>!0,s.push(u))}}}),i.forEach(l=>{l.forEach(([c,h])=>{if(Math.random()<e&&d(c,h)){const a=o[c][h];!a.hasEvent()&&a.type()!=="settlement"&&a.traversable()&&s.every(f=>r(f.position().x,f.position().y,c,h)>=3)&&(a.hasEvent=()=>!0,s.push(a))}})}),s},pe=[tt({id:"ancient-bunker",name:"Ancient Bunker",startPosition:{x:0,y:0},startingItems:[],level:3}),tt({id:"bandit-camp",name:"Bandit Camp",startPosition:{x:0,y:0},startingItems:[],level:4}),tt({id:"beacon",name:"Beacon",startPosition:{x:0,y:0},startingItems:[],level:2}),tt({id:"bear-cage",name:"Bear Cage",startPosition:{x:0,y:0},startingItems:[],level:4}),tt({id:"bunker",name:"Bunker",startPosition:{x:0,y:0},startingItems:[],level:2}),tt({id:"campfire",name:"Campfire",startPosition:{x:0,y:0},startingItems:[],level:2}),tt({id:"cave",name:"Cave",startPosition:{x:0,y:0},startingItems:[],level:3}),tt({id:"chest",name:"Chest",startPosition:{x:0,y:0},startingItems:[],level:1}),tt({id:"church",name:"Church",startPosition:{x:0,y:0},startingItems:[],level:2}),tt({id:"crashed-plane",name:"Crashed Plane",startPosition:{x:0,y:0},startingItems:[],level:3}),tt({id:"fungi",name:"Fungi",startPosition:{x:0,y:0},startingItems:[],level:1}),tt({id:"tent",name:"Tent",startPosition:{x:0,y:0},startingItems:[],level:2}),tt({id:"lean-to",name:"Lean-To",startPosition:{x:0,y:0},startingItems:[],level:2}),tt({id:"ruin",name:"Ruin",startPosition:{x:0,y:0},startingItems:[],level:4}),tt({id:"scary-tree",name:"Scary Tree",startPosition:{x:0,y:0},startingItems:[],level:1}),tt({id:"silo",name:"Silo",startPosition:{x:0,y:0},startingItems:[],level:3}),tt({id:"sword-in-stone",name:"Monument",startPosition:{x:0,y:0},startingItems:[],level:5}),tt({id:"wagon",name:"Wagon",startPosition:{x:0,y:0},startingItems:[],level:1}),tt({id:"wreck",name:"Wreck",startPosition:{x:0,y:0},startingItems:[],level:1})],ui=()=>{const o=Math.floor(Math.random()*pe.length);return pe[o]},fi=o=>{const t=Math.floor(Math.random()*o)+1,e=[];for(let i=0;i<t;i++){if(Math.random()<.5)continue;const n=pi();e.push(n)}if(e.length===0){const i=Tt("coin");e.push(i)}return e},pi=()=>{let o=0;const t=[];return ae.map(i=>{const n=new Array(i.randomDropWeight()).fill(i);t.push(...n),o+=i.randomDropWeight()}),Tt(t[Math.floor(Math.random()*o)].code())},mi=o=>o.map(t=>{const e=ui();return tt({id:e.id(),name:e.name(),startPosition:{x:t.position().x,y:t.position().y},level:e.level(),startingItems:fi(e.level())})}),gi=(o,t)=>{const e=(l,c)=>{const h=[],a=Math.abs(c.position.x-l.position.x),f=Math.abs(c.position.y-l.position.y),p=l.position.x<c.position.x?1:-1,u=l.position.y<c.position.y?1:-1;let y=a-f,g=l.position.x,x=l.position.y;for(;g!==c.position.x||x!==c.position.y;){h.push([g,x]);const T=y*2;T>-f&&(y-=f,g+=p),T<a&&(y+=a,x+=u)}return h},i=(l,c,h,a)=>{const f=l[l.length-1],[p,u]=f;for(const y of a){if(h.has(y.id))continue;if(Math.hypot(y.position.x-p,y.position.y-u)>3){const x=e({position:{x:p,y:u}},y);c.push(x),h.add(y.id);break}}},n=(l,c)=>{let h=null,a=1/0;for(const f of o){if(c.has(f.id))continue;const p=Math.hypot(f.position.x-l.position.x,f.position.y-l.position.y);p<a&&p<t&&(h=f,a=p)}return h},s=[],d=new Set;let r=o[0];for(d.add(r.id);d.size<o.length;){let l=n(r,d);if(!l){const c=Array.from(d).map(h=>o.find(a=>a.id===h));for(;c.length>0;){const h=c.pop();if(l=n(h,d),l){r=h;break}}l||(l=o.find(h=>!d.has(h.id))||null)}if(l){const c=e(r,l);s.push(c),d.add(l.id),r=l,c.length>7&&i(c,s,d,o)}else break}return s},yi=(o,t,e,i={min:2,max:4})=>{const n=o.length,s=o[0].length,d=[],r=(h,a)=>h>=0&&a>=0&&h<n&&a<s,l=(h,a,f)=>f.every(([p,u])=>{const y=h+p,g=a+u;if(!r(y,g))return!1;for(let x=-1;x<=1;x++)for(let T=-1;T<=1;T++){const I=y+x,M=g+T;if(r(I,M)&&o[I][M].type()!=="void")return!1}return!0}),c=h=>{const a=[];switch(Math.floor(Math.random()*4)){case 0:for(let y=-h;y<=h;y++)for(let g=-h;g<=h;g++)y*y+g*g<=h*h&&a.push([y,g]);break;case 1:for(let y=-h;y<=h+2;y++)for(let g=-h;g<=h;g++)(y*y+g*g<=h*h||Math.abs(y)<h&&Math.abs(g)<h)&&a.push([y,g]);break;case 2:for(let y=-h;y<=h;y++)for(let g=-h;g<=h;g++)(y*y+g*g<=h*h&&Math.random()>.5||Math.abs(y)<h&&Math.abs(g)<h&&Math.random()>.5)&&a.push([y,g]);break;case 3:const p=h*2,u=Math.floor(h/2);for(let y=-p;y<=p;y++)for(let g=-u;g<=u;g++)a.push([y,g]);break}return a};return t.forEach(h=>{const a=Math.floor(Math.random()*(i.max-i.min+1)+i.min),f=c(a),p=[];l(h.position.x,h.position.y,f)&&f.forEach(([u,y])=>{const g=h.position.x+u,x=h.position.y+y;r(g,x)&&(o[g][x]=gt({terrain:"wasteland",position:{x:g,y:x}}),p.push([g,x]))}),p.length>0&&d.push(p)}),e.forEach(h=>{h.forEach(([a,f])=>{for(let p=-Math.floor(Math.random()*2);p<=Math.floor(Math.random()*2);p++)for(let u=-Math.floor(Math.random()*2);u<=Math.floor(Math.random()*2);u++){const y=a+p,g=f+u;r(y,g)&&o[y][g].type()!=="wasteland"&&(o[y][g]=gt({terrain:"grass",position:{x:y,y:g}}))}})}),{map:o,rooms:d}},vi=(o,t)=>Math.sqrt(Math.pow(o.x-t.x,2)+Math.pow(o.y-t.y,2)),wi=o=>{const{horizontalTiles:t,verticalCells:e,nodeCount:i,minDistanceBetweenNodes:n,maxAttemptsToAssignNode:s}=o,d=[],r=Math.ceil(Math.sqrt(i)),l=Math.floor(t/r),c=Math.floor(e/r),h=(a,f)=>d.every(p=>Math.abs(vi(p.position,{x:a,y:f}))>=n);for(let a=0;a<i;a++){let f=0,p=!1;for(;f<s&&!p;){const u=Math.floor(a%r)*l,y=Math.floor(a/r)*c;let g=u+Math.floor(Math.random()*l),x=y+Math.floor(Math.random()*c);g=Math.max(3,Math.min(t-3,g)),x=Math.max(3,Math.min(e-3,x)),g<t&&x<e&&h(g,x)?(d.push({id:`node-${a}`,position:{x:g,y:x}}),p=!0):f++}p||d.pop()&&a--}return d},xi=o=>{const{startPosition:t}=o,e=[...ne("torch",30),...ne("coin",3)],i=[],n=[...e,...i];return $e({name:"Hero",id:"player",startPosition:t,startingItems:n,team:"player"})},Fe=()=>{const o=wi({horizontalTiles:64,verticalCells:64,nodeCount:80,minDistanceBetweenNodes:7,maxAttemptsToAssignNode:100}),t=gi(o,15),e=I=>{const M=Math.floor(Math.random()*I)+1,E=[];for(let N=0;N<M;N++){if(Math.random()<.5)continue;const A=i(),b=E.find(m=>m.code()===A.code());if(b){b.code()==="coin"&&b.updateQuantity(b.quantity()+1);continue}E.push(A)}if(E.length===0){const N=Tt("coin");E.push(N)}return E},i=()=>{let I=0;const M=[];return ae.map(E=>{const N=new Array(E.randomDropWeight()).fill(E);M.push(...N),I+=E.randomDropWeight()}),M[Math.floor(Math.random()*I)]},{map:n,rooms:s}=yi(Array.from({length:64},(I,M)=>Array.from({length:64},(E,N)=>gt({terrain:"void",position:{x:M,y:N}}))),o,t,{min:2,max:4});(I=>{const M=I.flat().filter(b=>b.type()==="void"),E=Math.floor(30);let N=0,A=0;for(let b=0;b<E&&(b>0&&M.splice(A,1),!(N>1e4||(N++,M.length===0)));b++){A=Math.floor(Math.random()*M.length);const{x:m,y:C}=M[A].position(),v=new jt(m,C,Math.floor(Math.random()*3)+1,Math.floor(Math.random()*3)+1);let w=!0;for(let k=-v.width;k<=v.width;k++){for(let R=-v.height;R<=v.height;R++){const B=m+k,O=C+R;if(!(B<0||O<0||B>=I.length||O>=I[0].length)&&I[B][O].type()!=="void"){w=!1;break}}if(!w)break}if(w)for(let k=-v.width;k<=v.width;k++)for(let R=-v.height;R<=v.height;R++){const B=m+k,O=C+R;B<0||O<0||B>=I.length||O>=I[0].length||(I[B][O]=gt({terrain:"water",position:{x:B,y:O}}))}}})(n);const l=hi({map:n,rooms:s,paths:t,pathEnemyChance:.2}).map(I=>ze({id:"bandit",name:"Bandit",team:"hostile-to-all",startPosition:{x:I.position().x,y:I.position().y},startingItems:e(Math.floor(Math.random()*3)+1),startingHealth:2})),c=I=>{I[0].map(M=>gt({terrain:"mountain",position:M.position()})),I[I.length-1].map(M=>gt({terrain:"mountain",position:M.position()})),I.forEach(M=>{gt({terrain:"mountain",position:M[0].position()}),gt({terrain:"mountain",position:M[M.length-1].position()})})},h=["settlement","large-settlement","sanctuary","citadel"],a=(I,M)=>{const{x:E,y:N}=I,A=[{x:E,y:N},{x:E+1,y:N},{x:E,y:N+1},{x:E+1,y:N+1}];return A.forEach(b=>{M[b.x]&&M[b.x][b.y]&&(M[b.x][b.y]=gt({terrain:"settlement",position:b}))}),ue({id:h.shift()??"settlement",name:`Settlement at (${E}, ${N})`,level:1,positions:A})};function f(I,M){const E=[];return I.forEach((N,A)=>{const{x:b,y:m}=N.position,C=!0;if(A===0){E.push(a({x:b,y:m},M));return}b<M.length-1&&m<M[0].length-1&&C?E.push(a({x:b,y:m},M)):(M[b][m]=gt({terrain:"settlement",position:{x:b,y:m}}),E.push(ue({id:h.shift()??"settlement",name:`Settlement ${A+1}`,level:1,positions:[{x:b,y:m}]})))}),E}const u=((I,M,E)=>{const N=[],A=new Set,b=m=>{const C=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],v=C[Math.floor(Math.random()*C.length)];return{x:m.position.x+v.x,y:m.position.y+v.y}};for(N.push({id:I[0].id,position:b(I[0])});N.length<M&&N.length<I.length&&A.size<I.length;){const m=Math.floor(Math.random()*I.length),C=I[m],v=`${C.position.x},${C.position.y}`;if(A.has(v))continue;let w=!0;for(const k of N)if(Math.sqrt(Math.pow(C.position.x-k.position.x,2)+Math.pow(C.position.y-k.position.y,2))<E){w=!1;break}w&&(N.push(C),A.add(v))}return N})(o,3,5),y=f(u,n);c(n);const g=di({map:n,rooms:s,paths:t,pathEventChance:.1}),x=mi(g),T=xi({startPosition:o[0].position});return ci(y.length,l,T),{playerModel:T,tileMapModel:oi(n),npcModels:l,eventModels:x,settlementModels:y,fogOfWarViewModel:ni()}};/*!
 * PixiPlugin 3.13.0
 * https://gsap.com
 *
 * @license Copyright 2008-2025, GreenSock. All rights reserved.
 * Subject to the terms at https://gsap.com/standard-license
 * @author: Jack Doyle, jack@greensock.com
*/var bt,Kt,me,ft,Ut,Ye,oe,te,Qe=function(){return typeof window<"u"},Xe=function(){return bt||Qe()&&(bt=window.gsap)&&bt.registerPlugin&&bt},se=function(t){return typeof t=="function"},je=function(t){return console.warn(t)},bi=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],Ct=.212671,wt=.71516,vt=.072169,Ze=function(t){return se(ft[t])?ft[t]:ft.filters[t]},ee=function(t,e){var i=[],n=0,s=0,d,r;for(d=0;d<4;d++){for(r=0;r<5;r++)s=r===4?t[n+4]:0,i[n+r]=t[n]*e[r]+t[n+1]*e[r+5]+t[n+2]*e[r+10]+t[n+3]*e[r+15]+s;n+=5}return i},ge=function(t,e){var i=1-e,n=i*Ct,s=i*wt,d=i*vt;return ee([n+e,s,d,0,0,n,s+e,d,0,0,n,s,d+e,0,0,0,0,0,1,0],t)},ye=function(t,e,i){var n=Kt(e),s=n[0]/255,d=n[1]/255,r=n[2]/255,l=1-i;return ee([l+i*s*Ct,i*s*wt,i*s*vt,0,0,i*d*Ct,l+i*d*wt,i*d*vt,0,0,i*r*Ct,i*r*wt,l+i*r*vt,0,0,0,0,0,1,0],t)},ve=function(t,e){e*=Math.PI/180;var i=Math.cos(e),n=Math.sin(e);return ee([Ct+i*(1-Ct)+n*-.212671,wt+i*-.71516+n*-.71516,vt+i*-.072169+n*(1-vt),0,0,Ct+i*-.212671+n*.143,wt+i*(1-wt)+n*.14,vt+i*-.072169+n*-.283,0,0,Ct+i*-.212671+n*-.787329,wt+i*-.71516+n*wt,vt+i*(1-vt)+n*vt,0,0,0,0,0,1,0,0,0,0,0,1],t)},we=function(t,e){return ee([e,0,0,0,.5*(1-e),0,e,0,0,.5*(1-e),0,0,e,0,.5*(1-e),0,0,0,1,0],t)},Ke=function(t,e){var i=Ze(e),n=t.filters||[],s=n.length,d;for(i||je(e+" not found. PixiPlugin.registerPIXI(PIXI)");--s>-1;)if(n[s]instanceof i)return n[s];return d=new i,e==="BlurFilter"&&(te?d.strength=0:d.blur=0),t.filters=[].concat(n,[d]),d},it=function(t,e,i,n){e.add(i,t,i[t],n[t]),e._props.push(t)},xe=function(t,e){var i=Ze("ColorMatrixFilter"),n=new i;return n.matrix=e,n.brightness(t,!0),n.matrix},Ci=function(t){var e={},i;for(i in t)e[i]=t[i];return e},ht={contrast:1,saturation:1,colorizeAmount:0,colorize:"rgb(255,255,255)",hue:0,brightness:1},Ti=function(t,e,i){var n=Ke(t,"ColorMatrixFilter"),s=t._gsColorMatrixFilter=t._gsColorMatrixFilter||Ci(ht),d=e.combineCMF&&!("colorMatrixFilter"in e&&!e.colorMatrixFilter),r,l,c;for(c=n.matrix,e.resolution&&(n.resolution=e.resolution),e.matrix&&e.matrix.length===c.length?(l=e.matrix,s.contrast!==1&&it("contrast",i,s,ht),s.hue&&it("hue",i,s,ht),s.brightness!==1&&it("brightness",i,s,ht),s.colorizeAmount&&(it("colorize",i,s,ht),it("colorizeAmount",i,s,ht)),s.saturation!==1&&it("saturation",i,s,ht)):(l=bi.slice(),e.contrast!=null?(l=we(l,+e.contrast),it("contrast",i,s,e)):s.contrast!==1&&(d?l=we(l,s.contrast):it("contrast",i,s,ht)),e.hue!=null?(l=ve(l,+e.hue),it("hue",i,s,e)):s.hue&&(d?l=ve(l,s.hue):it("hue",i,s,ht)),e.brightness!=null?(l=xe(+e.brightness,l),it("brightness",i,s,e)):s.brightness!==1&&(d?l=xe(s.brightness,l):it("brightness",i,s,ht)),e.colorize!=null?(e.colorizeAmount="colorizeAmount"in e?+e.colorizeAmount:1,l=ye(l,e.colorize,e.colorizeAmount),it("colorize",i,s,e),it("colorizeAmount",i,s,e)):s.colorizeAmount&&(d?l=ye(l,s.colorize,s.colorizeAmount):(it("colorize",i,s,ht),it("colorizeAmount",i,s,ht))),e.saturation!=null?(l=ge(l,+e.saturation),it("saturation",i,s,e)):s.saturation!==1&&(d?l=ge(l,s.saturation):it("saturation",i,s,ht))),r=l.length;--r>-1;)l[r]!==c[r]&&i.add(c,r,c[r],l[r],"colorMatrixFilter");i._props.push("colorMatrixFilter")},ki=function(t,e){var i=e.t,n=e.p,s=e.color,d=e.set;d(i,n,s[0]<<16|s[1]<<8|s[2])},Ii=function(t,e){var i=e.g;te?(i.fill(),i.stroke()):i&&(i.dirty++,i.clearDirty++)},Mi=function(t,e){e.t.visible=!!e.t.alpha},be=function(t,e,i,n){var s=t[e],d=Kt(se(s)?t[e.indexOf("set")||!se(t["get"+e.substr(3)])?e:"get"+e.substr(3)]():s),r=Kt(i);n._pt=new Ut(n._pt,t,e,0,0,ki,{t,p:e,color:d,set:Ye(t,e)}),n.add(d,0,d[0],r[0]),n.add(d,1,d[1],r[1]),n.add(d,2,d[2],r[2])},_i={tint:1,lineColor:1,fillColor:1,strokeColor:1},Ce="position,scale,skew,pivot,anchor,tilePosition,tileScale".split(","),re={x:"position",y:"position",tileX:"tilePosition",tileY:"tilePosition"},Ei={colorMatrixFilter:1,saturation:1,contrast:1,hue:1,colorize:1,colorizeAmount:1,brightness:1,combineCMF:1},Jt=Math.PI/180,Je=function(t){return typeof t=="string"},Si=function(t){return Je(t)&&t.charAt(1)==="="?t.substr(0,2)+parseFloat(t.substr(2))*Jt:t*Jt},Ai=function(t,e){return e.set(e.t,e.p,t===1?e.e:Math.round((e.s+e.c*t)*1e5)/1e5,e)},Pi=function(t,e,i,n,s,d){var r=360*(d?Jt:1),l=Je(s),c=l&&s.charAt(1)==="="?+(s.charAt(0)+"1"):0,h=parseFloat(c?s.substr(2):s)*(d?Jt:1),a=c?h*c:h-n,f=n+a,p,u;return l&&(p=s.split("_")[1],p==="short"&&(a%=r,a!==a%(r/2)&&(a+=a<0?r:-r)),p==="cw"&&a<0?a=(a+r*1e10)%r-~~(a/r)*r:p==="ccw"&&a>0&&(a=(a-r*1e10)%r-~~(a/r)*r)),t._pt=u=new Ut(t._pt,e,i,n,a,Ai),u.e=f,u},Te=function(){if(!me){bt=Xe(),ft=me=ft||Qe()&&window.PIXI;var t=ft&&ft.VERSION&&parseFloat(ft.VERSION.split(".")[0])||0;oe=t===4,te=t>=8,Kt=function(i){return bt.utils.splitColor((i+"").substr(0,2)==="0x"?"#"+i.substr(2):i)}}},Yt,St;for(Yt=0;Yt<Ce.length;Yt++)St=Ce[Yt],re[St+"X"]=St,re[St+"Y"]=St;var ce={version:"3.13.0",name:"pixi",register:function(t,e,i){bt=t,Ut=i,Ye=e.getSetter,Te()},headless:!0,registerPIXI:function(t){ft=t},init:function(t,e,i,n,s){if(ft||Te(),!ft)return je("PIXI was not found. PixiPlugin.registerPIXI(PIXI);"),!1;var d,r,l,c,h,a,f,p,u,y;for(a in e){if(d=re[a],l=e[a],d)r=~a.charAt(a.length-1).toLowerCase().indexOf("x")?"x":"y",this.add(t[d],r,t[d][r],d==="skew"?Si(l):l,0,0,0,0,0,1);else if(a==="scale"||a==="anchor"||a==="pivot"||a==="tileScale")this.add(t[a],"x",t[a].x,l),this.add(t[a],"y",t[a].y,l);else if(a==="rotation"||a==="angle")Pi(this,t,a,t[a],l,a==="rotation");else if(Ei[a])c||(Ti(t,e.colorMatrixFilter||e,this),c=!0);else if(a==="blur"||a==="blurX"||a==="blurY"||a==="blurPadding"){if(h=Ke(t,"BlurFilter"),this.add(h,a,h[a],l),e.blurPadding!==0)for(f=e.blurPadding||Math.max(h[a],l)*2,p=t.filters.length;--p>-1;)t.filters[p].padding=Math.max(t.filters[p].padding,f)}else if(_i[a])if((a==="lineColor"||a==="fillColor"||a==="strokeColor")&&t instanceof ft.Graphics)for(u=("fillStyle"in t)?[t]:(t.geometry||t).graphicsData,y=a.substr(0,a.length-5),te&&y==="line"&&(y="stroke"),this._pt=new Ut(this._pt,t,a,0,0,Ii,{g:t.geometry||t}),p=u.length;--p>-1;)be(oe?u[p]:u[p][y+"Style"],oe?a:"color",l,this);else be(t,a,l,this);else a==="autoAlpha"?(this._pt=new Ut(this._pt,t,"visible",0,0,Mi),this.add(t,"alpha",t.alpha,l),this._props.push("alpha","visible")):a!=="resolution"&&this.add(t,a,"get",l);this._props.push(a)}}};Xe()&&bt.registerPlugin(ce);const L=new si,Ni=o=>{let t=!1;return L.on("ON_PAUSE_INPUT",()=>{t=!1}),L.on("ON_RESUME_INPUT",()=>{t=!0}),L.on("ON_LEVEL_COMPLETED",()=>{o.handleLevelCompleted()}),L.on("ON_TILE_INTERACTION",({tileViewModel:e})=>{t&&o.handleTileInteraction(e)}),L.on("ON_ITEM_INTERACTION",({itemViewModel:e,action:i})=>{t&&o.handleItemInteraction(e,i)}),L.on("ON_EVENT_INTERACTION",({eventViewModel:e})=>{t&&o.handleEventInteraction(e)}),L.on("ON_CHARACTER_INTERACTION",({characterViewModel:e})=>{t&&o.handleCharacterInteraction(e)}),L.on("ON_INVENTORY_REQUEST",({inventory:e,action:i})=>{t&&o.handleInventoryRequest(e,i)}),L.on("ON_CLOSE_INVENTORY_REQUESTED",()=>{t&&o.onCloseInventoryRequested()}),L.on("ON_TRADE_REQUEST",({action:e})=>{t&&o.handleTradeRequest(e)}),L.on("ON_CHARACTER_INTERACTION_REQUEST",e=>{t&&o.handleCharacterInteractionRequest(e)}),L.on("ON_SETTLEMENT_INTERACTION_REQUEST",e=>{t&&o.handleSettlementInteractionRequest(e)}),L.on("ON_SAVE_REQUEST",()=>{o.handleSaveRequest()}),L.on("ON_LOAD_REQUEST",()=>{o.handleLoadRequest()}),L.on("ON_IN_GAME_MENU_REQUEST",({action:e})=>{o.handleInGameMenuRequest(e)}),L.on("ON_DEBUG_ACTION_REQUESTED",({action:e})=>{t&&o.onDebugActionRequested(e)}),{destroy:()=>{L.removeAllListeners()}}},Ri=()=>{const[o,t]=F(0),[e,i]=F(480);return{getCurrentTurn:()=>o(),getGameTimeMin:()=>e(),nextTurn:()=>{t(r=>r+1),i(r=>{const l=r+10;return l>=1440?0:l})}}},$t=o=>{const{model:t}=o,[e,i]=F(t.armour()>0),[n,s]=F(t.armour()<t.maxArmour()),[d,r]=F(t.damage()>0),[l,c]=F(t.health()>0),h={code:()=>t.code(),name:()=>t.name(),description:()=>t.description(),quantity:()=>t.quantity(),value:()=>t.value(),updateQuantity:a=>{t.updateQuantity(a)},level:()=>t.level(),interact:()=>{L.emit("ON_ITEM_INTERACTION",{itemViewModel:h})},health:()=>t.health(),type:()=>t.type(),damage:()=>t.damage(),range:()=>t.range(),armour:()=>t.armour(),setArmour:a=>{t.setArmour(a)},maxArmour:()=>t.maxArmour(),id:()=>t.id(),isArmourIconVisible:()=>e(),isDamagedArmourIconVisible:()=>n(),isHealthIconVisible:()=>l(),setIsArmourIconVisible:a=>{i(a)},setIsDamagedArmourIconVisible:a=>{s(a)},setIsHealthIconVisible:a=>{c(a)},isDamageIconVisible:()=>d(),setIsDamageIconVisible:a=>{r(a)},uses:()=>t.uses(),setUses:a=>{t.setUses(a)},collected:()=>t.collected(),setCollected:a=>{t.setCollected(a)}};return h},kt=o=>{const{model:t,ownerName:e,owner:i}=o,[n,s]=F([]),[d,r]=F(!1),l=a=>$t({model:a}),c=(a,f)=>{const p=a.code()===f.code(),u=a.armour()===f.armour(),y=a.damage()===f.damage();return p&&u&&y},h={items:()=>t.items().map(a=>l(a)),stacks:()=>n(),setStacks:()=>{const a=[],f=[];h.items().forEach(p=>{if(i&&i.isEquipped(p)){f.push({item:p,quantity:1});return}const u=a.find(y=>c(y.item,p));u?u.quantity+=p.quantity():a.push({item:p,quantity:p.quantity()})}),a.sort((p,u)=>u.item.type()==="currency"&&p.item.type()!=="currency"?1:u.item.type()!=="currency"&&p.item.type()==="currency"?-1:u.item.type()==="light"&&p.item.type()!=="light"?1:u.item.type()!=="light"&&p.item.type()==="light"?-1:u.item.armour()>0&&p.item.armour()<=0?1:u.item.armour()<=0&&p.item.armour()>0?-1:u.item.damage()>0&&p.item.damage()<=0?1:u.item.damage()<=0&&p.item.damage()>0?-1:u.item.health()>0&&p.item.health()<=0?1:u.item.health()<=0&&p.item.health()>0?-1:u.item.type()==="loot"&&p.item.type()!=="loot"?1:u.item.type()!=="loot"&&p.item.type()==="loot"?-1:p.item.name().localeCompare(u.item.name())),s(f.concat(a))},ownerName:()=>e,getItem:a=>h.items().find(f=>c(f,a)),getItemByCode:a=>h.items().find(f=>f.code()===a),getItemByName:a=>h.items().find(f=>f.name()===a),addItem:a=>{t.addItem(Tt(a.code(),{id:()=>a.id()})),h.setStacks()},removeItem:a=>{t.removeItem(a),h.setStacks(),!a.collected()&&(!i||!i.isAlive())&&!["trade-npc","trade","settlement","hero"].includes(e.toLowerCase())&&["trade-npc","trade","settlement","hero"].filter(f=>e.toLowerCase().includes(f)).length===0&&(a.setCollected(!0),pt().log.collectedItemsValue+=a.value())},owner:i,isEmpty:()=>t.isEmpty(),isOnlyLoot:()=>t.isOnlyLoot(),isInfoButtonEnabled:()=>d(),setInfoButtonEnabled:a=>{r(a)}};return h.setStacks(),rt(()=>{at(()=>{h.setStacks()})}),h},he=o=>{const{model:t}=o,[e,i]=F(kt({model:t.inventory(),ownerName:t.name()})),n=r=>{if(!r)throw new Error("Item cannot be undefined");const l=t.inventory().getItemById(r.id());if(!l)throw new Error(`Item with code ${r.id()} not found in inventory`);return l},s=r=>{if(!r)throw new Error("Item cannot be undefined");return $t({model:r})},d={id:()=>t.id(),name:()=>t.name(),setInventory:r=>{i(r)},size:()=>t.size(),position:()=>({...t.position(),distanceTo:r=>{const l=t.position().x-r.x,c=t.position().y-r.y;return Math.floor(Math.sqrt(l*l+c*c))}}),health:()=>t.health(),maxHealth:()=>t.maxHealth(),moveTo:(r,l)=>{d.isAlive()&&t.moveTo(r,l)},dialogue:()=>t.dialogue(),isHostile:r=>t.isHostile(r),move:(r,l)=>{const c=t.position(),h=c.x+r,a=c.y+l;t.moveTo(h,a)},team:()=>t.team(),updateTeam:r=>{t.updateTeam(r)},inventory:()=>e(),armour:()=>{var h,a,f;const r=((h=t.bodyArmour())==null?void 0:h.armour())??0,l=((a=t.headArmour())==null?void 0:a.armour())??0,c=((f=t.feetArmour())==null?void 0:f.armour())??0;return r+l+c},takeDamage:r=>{let l=r;new Array(r).fill(0).forEach(()=>{const h=[t.bodyArmour(),t.headArmour(),t.feetArmour()].filter(a=>a&&a.armour()>0);if(h.length!==0){const a=h[Math.floor(Math.random()*h.length)];a.setArmour(a.armour()-1),l--}}),t.id()==="player"&&(pt().log.totalDamageAbsorbed+=r-l,pt().log.totalDamageTaken+=l);const c=t.health()-l;t.setHealth(c)},setHealth:r=>{t.setHealth(r)},setMaxHealth:r=>{t.setMaxHealth(r)},isAlive:()=>t.health()>0,visible:()=>t.visible(),setVisible:r=>{t.setVisible(r)},bodyArmour:()=>s(t.bodyArmour()),setBodyArmour:r=>{r?t.setBodyArmour(n(r)):t.setBodyArmour(void 0)},headArmour:()=>s(t.headArmour()),setHeadArmour:r=>{r?t.setHeadArmour(n(r)):t.setHeadArmour(void 0)},feetArmour:()=>s(t.feetArmour()),setFeetArmour:r=>{r?t.setFeetArmour(n(r)):t.setFeetArmour(void 0)},weapon:()=>{const r=t.weapon();return $t({model:r})},setWeapon:r=>{r?t.setWeapon(n(r)):t.setWeapon(void 0)},isEquipped:r=>{var l,c,h,a;return((l=t.weapon())==null?void 0:l.id())===r.id()||((c=t.bodyArmour())==null?void 0:c.id())===r.id()||((h=t.headArmour())==null?void 0:h.id())===r.id()||((a=t.feetArmour())==null?void 0:a.id())===r.id()}};return i(kt({model:t.inventory(),ownerName:t.name(),owner:d})),d},Vi=o=>{const{eventModel:t}=o;return{...t,inventory:()=>kt({model:t.inventory(),ownerName:t.name()})}},Bi=o=>o.tile,Li=o=>{const{model:t}=o,e=n=>Bi({tile:n});return{isValidMove:(n,s)=>t.isValidMove(n,s),entryPoints:()=>t.entryPoints().map(n=>e(n)),tiles:()=>t.tiles().map(n=>n.map(s=>e(s))),updateTile:(n,s,d)=>{t.tiles()[n][s]=d},getNeighbors:n=>{var c;const s=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],d=[],r=n.position().x,l=n.position().y;for(const{dx:h,dy:a}of s){const f=r+h,p=l+a,u=(c=t.tiles()[f])==null?void 0:c[p];u&&d.push(e(u))}return d}}},ti=o=>{const[t,e]=F([]),[i,n]=F(null),[s,d]=F([]),[r,l]=F(null),[c,h]=F(null),[a,f]=F(!1);return{...he({model:o}),setLastSpawned:u=>o.setLastTurnSpawned(u),lastSpawned:()=>o.lastTurnSpawned(),spawnLing:()=>o.spawnling(),getPatrolArea:()=>t(),setPatrolArea:u=>e(u),getTask:()=>i(),setTask:u=>n(u),getTaskList:()=>s(),setTaskList:u=>d(u),getBedLocation:()=>r(),setBedLocation:u=>l(u),getTarget:()=>c(),setTarget:u=>h(u),canTrade:()=>a(),setCanTrade:u=>f(u)}},Oi=o=>{const{model:t}=o,[e,i]=F(!0);return{id:()=>t.id(),name:()=>t.name(),level:()=>t.level(),positions:()=>t.positions(),isVisible:()=>e(),setIsVisible:n=>i(n),isUnlocked:()=>t.isUnlocked(),setIsUnlocked:n=>t.setIsUnlocked(n),inventory:()=>kt({model:t.inventory(),ownerName:t.name()}),getMiddleTopPosition:()=>{const n=t.positions();if(n.length===0)return{x:0,y:0};const s=Math.max(...n.map(r=>r.x)),d=Math.min(...n.map(r=>r.y));return{x:(s-n[0].x)/2+n[0].x,y:d}}}},Wi=o=>{const{playerModel:t,tileMapModel:e,npcModels:i,eventModels:n,settlementModels:s,fogOfWarViewModel:d}=o,r=he({model:t}),l=Li({model:e}),c=i.map(f=>ti(f)),h=n.map(f=>Vi({eventModel:f})),a=s.map(f=>Oi({model:f}));return{playerVM:r,tileMapVM:l,npcVMs:c,eventVMs:h,settlementVMs:a,fogOfWarViewModel:d}},Di=o=>{const{model:t}=o;return{getCurrentTurn:()=>t.getCurrentTurn(),nextTurn:()=>{t.nextTurn()},getCurrentClocktime:()=>{const e=t.getGameTimeMin(),i=Math.floor(e/60),n=e%60;return`${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},getCurrentTimeMin:()=>t.getGameTimeMin()}},yt=(o,t)=>Math.floor(Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2))),Hi=(o,t)=>{let e=[];for(const i of t){const n=i.position(),s=yt(o,n);e.length===0||s<e[0].distance?e=[{npc:i,distance:s}]:s===e[0].distance&&e.push({npc:i,distance:s})}return e},Ui=(o,t)=>{let e=null,i=1/0;for(const n of t)n.positions().forEach(s=>{const d=yt(o,s);d<i&&(i=d,e=n)});return e},$i=(o,t)=>{let e=null,i=1/0;for(const n of t){const s=n.position(),d=yt(o,s);d<i&&(i=d,e=n)}return e},zi=({playerVM:o,npcVMs:t,settlementVMs:e,eventViewModels:i})=>{const[n,s]=F(!0),[d,r]=F(null),[l,c]=F(null),[h,a]=F(null),[f,p]=F(null),[u,y]=F(null),[g,x]=F(null),[T,I]=F(null),[M,E]=F(null),[N,A]=F(null),[b,m]=F(null),C=1;let v=null,w=null,k=null,R=null,B=null,O,P=null,_=null,V=null,U=null;const D=(W,z)=>{if(z){const ot=z.position();if(yt(W,ot)<=C)return v=z,!0}return!1},K=(W,z)=>{if(!z)return I(null),!1;const ot=z.position();return yt(W,ot)<=C&&z.inventory().isEmpty()===!1?(k=z,!0):!1},st=W=>W.isUnlocked()||!o.inventory().items().some(z=>z.code()==="city-key")?!1:(_=W,!0),nt=W=>W.isUnlocked()&&!W.inventory().isEmpty()?(V=W,!0):!1,dt=W=>W.isUnlocked()?(U=W,!0):!1,q=W=>{const z=Ui(W,e);return z&&z.positions().forEach(ot=>{if(yt(W,ot)<=C)return st(z),nt(z),dt(z),V||(R=z),!0}),!1},S=(W,z)=>{if(z){const ot=z.position(),ct=yt(W,ot);if(ct<=o.weapon().range()&&ct<=2&&!H(W,z))return B=z,!0}return!1},H=(W,z)=>{if(z){const ot=z.position(),ct=yt(W,ot);if(ct<=o.weapon().range()&&o.weapon().range()>2&&ct>1)return P=z,!0}return!1},Y=W=>{const z=o.position();return yt(z,W.position)<=C&&W.inventory.isEmpty()===!1?(O=W.inventory,!0):!1},Q=W=>{if(W){const z=o.position(),ot=W.position();if(yt(z,ot)<=C&&W.canTrade())return w=W,!0}return!1},et=W=>{if(W.isHostile(o.team())){if(W.isAlive()){const z=S(o.position(),W),ot=H(o.position(),W);return z||ot}else if(W.inventory().isEmpty()===!1)return Y({position:W.position(),inventory:W.inventory()})}else return W.isAlive()?(D(o.position(),W),Q(W)):Y({position:W.position(),inventory:W.inventory()});return!1},mt=()=>{v=null,w=null,k=null,R=null,B=null,O=null,P=null,_=null,V=null,U=null},It=()=>{d()!==v&&r(v),l()!==w&&c(w),T()!==k&&I(k),h()!==R&&a(R),f()!==B&&p(B),g()!==O&&x(O),l()!==w&&c(w),u()!==P&&y(P),M()!==_&&E(_),N()!==V&&A(V),b()!==U&&m(U)},Mt=()=>{const W=o.position(),z=Hi(W,t),ot=$i(W,i);if(mt(),z.length>0)for(let ct=0;ct<z.length;ct++){const ii=z[ct].npc;if(et(ii))break}K(W,ot),q(W),It()};return Mt(),rt(()=>{at(()=>{Mt()})}),{isVisible:n,setVisibility:W=>s(W),canUnlockSettlement:M,canInteractWithCharacter:d,canAttackCharacter:f,canTradeWithCharacter:l,canVisitSettlement:h,canSearch:T,canLoot:g,canRangedAttackCharacter:u,canTradeWithSettlement:N,canRestAtSettlement:b}},qi=o=>{const{playerVM:t}=o,[e,i]=F(!1),[n,s]=F(!1),[d,r]=F(!1),[l,c]=F(0),h={torchLeft:()=>l(),health:()=>t.health(),maxHealth:()=>t.maxHealth(),armour:()=>h.bodyArmour().armour()+h.headArmour().armour()+h.feetArmour().armour(),maxArmour:()=>h.bodyArmour().maxArmour()+h.headArmour().maxArmour()+h.feetArmour().maxArmour(),inventoryValue:()=>Math.floor(t.inventory().items().reduce((a,f)=>a+f.value()*f.quantity(),0)),isInventoryValueVisible:a=>(a!==void 0&&i(a),e()),inventory:()=>t.inventory(),weapon:()=>t.weapon(),bodyArmour:()=>t.bodyArmour(),headArmour:()=>t.headArmour(),feetArmour:()=>t.feetArmour(),isInGameMenuVisible:()=>n(),showInGameMenu:a=>{r(!1),s(a)},isSaveCompleted:()=>d(),setIsSaveCompleted:a=>{setTimeout(()=>{r(!1)},2e3),r(a)}};return rt(()=>{at(()=>{const a=t.inventory().stacks().find(f=>f.item.code()==="torch");c(a?a.quantity:0)})}),h},Gi=o=>{const{gameView:t,viewModel:e}=o,i=new Z,n=new Z;n.label="sensing-fog-of-war",n.alpha=.5,i.label="fog-of-war",i.zIndex=1e4,n.zIndex=10001;const s=()=>{i.destroy({children:!0}),n.destroy({children:!0})};t.addChild(i,n);const d=l=>{const a=l.x-innerWidth*.5,f=l.y-innerHeight*.5,p=innerWidth,u=innerHeight,y=Math.floor(a/64)-2,g=Math.floor(f/64)-2,x=Math.ceil((a+p)/64)+2,T=Math.ceil((f+u)/64)+2,I=[];for(let M=y;M<=x;M++)for(let E=g;E<=T;E++)I.push({x:M,y:E});return I};return{applyFogOfWarExceptAround:l=>{e.setFogOfWarPoints(d(l));const c=64;i.clear(),n.clear();const h=new fe;h.x=l.x,h.y=l.y,h.radius=e.lightRadius()*1.8;const a=new fe;a.x=l.x,a.y=l.y,a.radius=e.lightRadius();for(const f of e.fogOfWarPoints()){const p=new jt;if(p.x=Math.floor(f.x*c),p.y=Math.floor(f.y*c),p.width=c,p.height=c,a.contains(p.x,p.y)){e.addRevealedPoint({x:f.x,y:f.y});continue}if(h.contains(p.x,p.y)){n.rect(p.x,p.y,c,c),n.fill("black"),e.revealedPoints().some(u=>u.x===f.x&&u.y===f.y)||e.addRevealedPoint({x:f.x,y:f.y});continue}if(e.revealedPoints().some(u=>u.x===f.x&&u.y===f.y)){n.rect(p.x,p.y,c,c),n.fill("black");continue}i.rect(p.x,p.y,c,c),i.fill(0)}},destroy:s}},Fi=({gameViews:o,userInterfaceView:t,fogOfWarVM:e})=>{const i=new $,n=new $,s=new Z,d=.2,{gameView:r,nonSkewedView:l}=o;let c=!1,h=!1,a={x:0,y:0},f=null,p=Gi({gameView:r,viewModel:e}),u={x:0,y:0},y;i.label="camera-view",n.label="viewport",n.addChild(s,r,l),r.scale.set(.6),r.width=Math.floor(r.width),r.height=Math.floor(r.height);const g=()=>{f==null||f.kill(),document.removeEventListener("mousedown",T),document.removeEventListener("mouseup",I),document.removeEventListener("mousemove",M),document.removeEventListener("wheel",E),n.destroy({children:!0}),s.destroy(),p==null||p.destroy(),p=null,i.removeChildren(),i.destroy({children:!0})},x=(b,m)=>{s.clear(),s.rect(0,0,b,m),s.fill("black")};i.addChild(n,t);const T=b=>{b.button===0&&(c=!0)},I=b=>{b.button===0&&(c=!1,h=!1)},M=b=>{const m={x:b.clientX,y:b.clientY},C=m.x-a.x,v=m.y-a.y;if(h&&C!==0&&v!==0&&(c=!0),a={x:b.clientX,y:b.clientY},h){const{movementX:w,movementY:k}=b;r.position.x+=w,r.position.y+=k}},E=b=>{const{deltaY:m}=b;r.scale.x+m*.001>1||r.scale.x+m*.001<.5||(r.scale.x+=m*.001,r.scale.y+=m*.001)};document.addEventListener("mousedown",T),document.addEventListener("mouseup",I),document.addEventListener("mousemove",M),document.addEventListener("wheel",E);const N=(b,m)=>{const C=new qe(b,m),v=r.toGlobal(C),w=innerWidth*.5,k=innerHeight*.5,R=r.position.x-(v.x-w),B=r.position.y-(v.y-k),O={x:Math.floor(R),y:Math.floor(B)},P={x:Math.floor(r.position.x),y:Math.floor(r.position.y)},V=Math.sqrt(Math.pow(O.x-P.x,2)+Math.pow(O.y-P.y,2))>98;f&&f.progress(1),f=X.fromTo(P,{x:P.x,y:P.y},{x:O.x,y:O.y,duration:V?0:1,onUpdate:()=>{r.position.set(P.x,P.y),l.position.set(0,0),!y&&(y=X.delayedCall(d,()=>{y=void 0}),p==null||p.applyFogOfWarExceptAround(C))},onComplete:()=>{p==null||p.applyFogOfWarExceptAround(C),u={x:b,y:m}}})};return{view:i,moveTo:N,resize:(b,m)=>{x(b,m),N(u.x,u.y)},destroy:g,isDragging:()=>c}},Yi=o=>{const{viewModel:t}=o,e=new $,i=t.isAlive()?G.from(`${t.id()}.png`):G.from("corpse.png");let n={x:0,y:0};e.label=`${t.id()}-view`,e.eventMode="static";const s=()=>{i.width=50,i.height=50,i.anchor.set(.5,.5),i.skew.set(.5,0),i.position.set(32,32),e.addChild(i),e.position.set(t.position().x*64,t.position().y*64)};return e.on("pointertap",()=>{L.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})}),s(),{view:e,update:()=>{e.visible=t.visible(),!t.isAlive()&&!i.label.includes("corpse")&&(J.play("audio/sfx/death.mp3",{category:"gameplay"}),i.label=`${t.id()}-corpse`,i.texture=G.from("corpse.png").texture);const r=t.position();if(n.x!==r.x||n.y!==r.y){const l=n.x>r.x,c=n.x!==r.x;if(n={x:r.x,y:r.y},J.play("audio/sfx/step.mp3",{category:"gameplay"}),!c)return;l?(e.scale.x=1,e.pivot.x=0,i.skew.set(-.5,0),i.position.set(32,16)):(e.scale.x=-1,i.position.set(-32,16),i.skew.set(.5,0))}}}},Qi=o=>{const{viewModel:t}=o,e=new $;e.label=`${t.name()}-${t.id()}`;const i=G.from(`${t.id()}.png`);i.label=`${t.name()}-${t.id()}`,i.width=64,i.height=64;const n=G.from("cleared.png");n.width=64,n.height=64,n.label="discovered",n.visible=t.discovered(),n.position.set(-16,0);const s=G.from("loot-icon.png");return s.width=32,s.height=32,s.label="loot-available",s.tint="yellow",s.visible=t.discovered()&&!t.inventory().isEmpty(),s.position.set(i.width-s.width,i.height-s.height),e.addChild(i,n,s),e.skew.set(-.5,0),e.eventMode="static",e.on("pointertap",()=>{L.emit("ON_EVENT_INTERACTION",{eventViewModel:t})}),rt(()=>at(()=>{e.visible=t.visible(),t.visible()&&t.discovered()&&(i.label.includes("visited")||(n.visible=!0,s.visible=!t.inventory().isEmpty()))}),e),{view:e}},ke={"bed-time":"task-bed-time",patrol:"magnifying-glass-icon",follow:"walking-icon",work:"coins-icon",idle:"task-idle",attack:"attack-icon"},Xi=o=>{const{cellSize:t,npcVMs:e}=o,i=new $,n=new Map;i.label="npc-task-view";const s=h=>{var y;const a=new $,f=new Z,p=((y=h.getTask())==null?void 0:y.name())??"idle",u=G.from(`${ke[p]||"task-idle"}.png`);a.label=`task-icon-container-${h.id()}`,a.addChild(f,u),u.label=`task-${p}.png`,u.width=t/2,u.height=t/2,n.set(h,{icon:u,container:a,background:f}),f.circle(u.width/2,u.height/2,u.width/1.3),f.fill("khaki"),f.alpha=.75,i.addChild(a)},d=h=>{n.has(h)||s(h)},r=()=>{i.visible=!0},l=()=>{i.visible=!1},c=()=>{n.forEach((h,a)=>{var u;if(h.container.visible=a.visible()&&a.isAlive(),!a.isAlive()){i.removeChild(h.container),h.icon.destroy(),h.background.destroy(),h.container.destroy(),n.delete(a);return}const f=((u=a.getTask())==null?void 0:u.name())??"idle",p=ke[f]||"task-idle";h.icon.label!==`${p}.png`&&(h.icon.label=`${p}.png`,h.icon.texture=G.from(`${p}.png`).texture),h.container.position.set((a.position().x+.5)*o.cellSize-h.icon.width/2,a.position().y*o.cellSize-t*.6)})};return e.forEach(h=>{d(h)}),{view:i,show:r,hide:l,update:c,addNpc:d}},Ie=new Array(5).fill(0),Me=o=>{const{viewModel:t,onStep:e}=o,i=new $;let n=t.id();if(n==="bandit"){const c=Math.floor(Math.random()*5),h=Ie.reduce((a,f,p,u)=>f<u[a]?p:a,c);n=`bandit-${h}`,Ie[h]++,n=`bandit-${h}`}const s=t.isAlive()?G.from(`${n}.png`):G.from("corpse.png");s.label=t.isAlive()?`${t.id()}-sprite`:`${t.id()}-corpse-sprite`,i.label=`${t.name()}-view`,i.eventMode="static";const d=()=>{const c=t.size()*50;s.width=c,s.height=c,s.anchor.set(.5,.5),s.skew.set(-.5,0),s.position.set(32,32),i.addChild(s),i.position.set(t.position().x,t.position().y)};i.on("pointertap",()=>{L.emit("ON_CHARACTER_INTERACTION_REQUEST",{action:"open",character:t})}),d();let r={x:t.position().x,y:t.position().y};const l=()=>{if(!t.isAlive()&&!s.label.includes("corpse")){J.play("audio/sfx/death.mp3",{category:"gameplay"}),s.label=`${t.id()}-corpse-sprite`,s.texture=G.from("corpse.png").texture;return}};return rt(()=>{at(()=>{i.visible=t.visible();const c=t.position();if(r.x!==c.x||r.y!==c.y){const h=r.x>c.x,a=r.x!==c.x;if(r={x:c.x,y:c.y},e(),!a)return;h?(i.scale.x=1,i.pivot.x=0,s.skew.set(-.5,0),s.position.set(32,16)):(i.scale.x=-1,s.position.set(-32,16),s.skew.set(.5,0))}})}),{view:i,update:l}},ji=({viewModel:o,onUnlocked:t})=>{const e=new $;e.label="settlement-view";const i=G.from(`${o.id()}.png`);let n=0,s=0;o.positions().forEach(r=>{r.x>=n&&(n=r.x),r.y>=s&&(s=r.y)}),i.width=Math.floor((n-o.positions()[0].x+1)*64),i.height=Math.floor((s-o.positions()[0].y+1)*64);const d=G.from("blocked.png");return d.width=i.width,d.height=i.height,d.visible=!o.isUnlocked(),e.addChild(i,d),e.eventMode="none",e.skew.set(-.46,0),rt(()=>{at(()=>{e.visible=o.isVisible(),d.visible&&o.isUnlocked()&&t(),d.visible=!o.isUnlocked()})},e),{view:e}},Zi=(o,t,e)=>{o.alpha=0,X.to(o,{alpha:1,duration:t/1e3,onComplete:e})},Ki=(o,t,e)=>{X.to(o,{alpha:0,duration:t/1e3,onComplete:()=>{e()}})},Ji=o=>{const{tileSize:t,viewModel:e}=o,i=new $;let n=new G,s=new G;i.label="tile-view",i.eventMode="static";const d=e.type();let r=d;r==="wasteland"?r+=`-${Math.floor(Math.random()*2)}`:r==="forest"?r+=`-${Math.floor(Math.random()*2)}`:r==="settlement"&&(r="wasteland");const l=G.from(`${r}.png`);if(l.width=t,l.height=t,l.anchor.set(.5,.5),l.position.set(t/2,t/2),r==="settlement"&&(l.visible=!1),i.addChild(l),e.hasMud()){const c=G.from("mud.png");c.width=t*.6,c.height=t*.6,c.position.set(t*.2,t*.2),c.alpha=.6,i.addChild(c)}if(!e.traversable()&&d==="void"){const c=Math.floor(Math.random()*6),h=["dead-trees-0","dead-trees-1","dead-trees-2","dead-trees-3","dead-trees-4","dead-trees-1"][c];n=G.from(`${h}.png`),n.width=t*1.2,n.height=t*1.2,n.skew.set(-.5,0)}if(e.hasGrass()){const c=G.from("dead-grass.png");c.width=t*.6,c.height=t*.6,c.alpha=1,c.skew.set(-.4,0),c.position.set(20,0),i.addChild(c)}if(e.hasEyes()){s=G.from("eyes.png"),s.width=t*.8,s.height=t*.8,s.skew.set(-.5,0),s.zIndex=s.position.y+32,s.alpha=0;const c=async()=>{await new Promise(h=>{setTimeout(()=>h(),(s.alpha===1?Math.random()*2e3:Math.random()*5e3)+2e3)}),s.alpha===0?Zi(s,1e3,c):Ki(s,1e3,c)};c()}return i.on("pointertap",()=>{L.emit("ON_TILE_INTERACTION",{tileViewModel:e})}),rt(()=>{at(()=>{i.visible=e.visible(),s.visible=e.visible(),n.visible=e.visible()})},i),{view:i,trees:n,eyes:s}},tn=o=>{const{viewModel:t,tileSize:e}=o,i=new $;i.label="tile-map-view",i.sortableChildren=!0;const n=t.tiles(),s=[],d=[];return n.forEach((r,l)=>{r.forEach((c,h)=>{const a=Ji({tileSize:e,viewModel:c});a.view.label=`tile-${l}-${h}`,a.view.position.set(l*e,h*e),a.trees.position.set(a.view.position.x+20,a.view.position.y-20),a.eyes.position.set(a.view.x+32,a.view.y-20),s.push(a.trees),d.push(a.eyes),i.addChild(a.view)})}),{view:i,trees:s,eyes:d}},en=o=>{const{viewModel:t}=o,e=new $,i=[],n=64,s=new Map,d=f=>{const p=f.health(),u=f.maxHealth(),y=p/u,g=n*y,{x,y:T}=f.position();let I=s.get(f);I?I.clear():I=new Z,I.clear(),I.rect(x*n,T*n-10,n,5),I.fill(0),I.rect(x*n,T*n-10,g,5),I.fill(65280),I.label=`${f.name()}-health-bar`,e.addChild(I),s.set(f,I),X.to(I,{alpha:0,duration:1,delay:1,onComplete:()=>{e.removeChild(I),I.destroy(),s.delete(f)}})},r=(f,p)=>({x:(f.x+p.x)/2,y:(f.y+p.y)/2}),l=f=>{if(e.destroyed)return;const p=f.position(),u=G.from("blood.png");u.width=n,u.height=n,u.position.set(p.x*n,p.y*n),e.addChild(u),f.armour()>0?(u.tint="blue",J.play("audio/sfx/collect.wav",{category:"gameplay"})):(J.play("audio/sfx/fists.mp3",{category:"gameplay"}),d(f)),X.to(u,{alpha:0,duration:.333,ease:"power2.inOut",onComplete:()=>{e.removeChild(u),u.destroy()}})},c=async({source:f,target:p})=>{const u=G.from("slash.png");u.scale.set(.15),u.anchor.set(.5),u.position.set(r(f.position(),p.position()).x*64+32,r(f.position(),p.position()).y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),u.alpha=0,await X.to(u,{alpha:1,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),l(p)},h=async({source:f,target:p})=>{const u=G.from("arrow.png");u.scale.set(.1),u.anchor.set(.5),u.position.set(f.position().x*64+32,f.position().y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),await X.to(u.position,{x:p.position().x*64+32,y:p.position().y*64+32,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),l(p)},a=async()=>{for(;i.length>0;){const f=i.shift();f&&await f()}};return rt(()=>{at(()=>{const f=t.isAttacking();f&&(f.type==="ranged"?i.push(()=>h(f)):i.push(()=>c(f)))})}),{view:e,process:a}},nn=o=>{const{attackVM:t,tileMapVM:e,playerVM:i,tileSize:n,npcVMs:s,eventVMs:d,settlementVMs:r}=o,l=new $,c=new $,h=new $,a=new $,f=en({viewModel:t});c.label="game-view-container",h.label="tile-container",a.label="talk-overlay",c.sortableChildren=!0,h.zIndex=-1e3;const p=new Map,u=Xi({cellSize:n,npcVMs:s}),y=new Map;let g=null,x=null,T=[],I=[],M=[];const E=[];let N=!1;const A=P=>{const _=Me({viewModel:P,onStep:()=>{P.position().distanceTo(i.position())<6&&J.play("audio/sfx/step.mp3",{category:"gameplay"})}});s.push(P),c.addChild(_.view),T.push(_)},b=()=>{x=tn({viewModel:e,tileSize:n}),x.view.label="tile-map-view",g=Yi({viewModel:i}),h.addChild(x.view),x.trees.forEach(P=>{c.addChild(P)}),x.eyes.forEach(P=>{c.addChild(P)}),d.map(P=>{const _=Qi({viewModel:P});I.push(_),c.addChild(_.view)}),T=s.map(P=>{const _=Me({viewModel:P,onStep:()=>{P.position().distanceTo(i.position())<6&&J.play("audio/sfx/step.mp3",{category:"gameplay"})}});return c.addChild(_.view),_}),r.map(P=>{const _=ji({viewModel:P,onUnlocked:()=>{B("city-key",P.getMiddleTopPosition())}});M.push(_),c.addChild(_.view),_.view.label=`settlement-${P.id()}`,_.view.position.set(P.positions()[0].x*n+52,P.positions()[0].y*n-30),_.view.zIndex=_.view.y+32}),c.addChild(h,g.view,a,f.view)},m=()=>{N=!0,E.forEach(P=>P.kill()),x==null||x.view.destroy({children:!0}),g==null||g.view.destroy({children:!0}),a.removeChildren(),x=null,g=null,T.forEach(P=>P.view.destroy({children:!0})),T=[],I.forEach(P=>P.view.destroy({children:!0})),I=[],M.forEach(P=>P.view.destroy({children:!0})),M=[],p.clear(),c.destroy({children:!0})},C=["snow","lightskyblue","lime","yellow","fuchsia","orange"],v=()=>{const P=["snow","lightskyblue","lime","yellow","fuchsia","orange"];return C.length===0&&C.push(...P),C.splice(Math.floor(Math.random()*C.length),1)[0]},w=P=>{const{x:V,y:U}=P.position(),D=new Et;if(p.get(P.id()))return;D.style={fontFamily:"alagard",fontSize:32,fill:v(),align:"center",dropShadow:!0,stroke:"black",wordWrap:!0,wordWrapWidth:innerWidth*1.5},D.text=P.dialogue(),D.anchor.set(.5);let st=0;const nt=V*n+n/2,dt=U*n-n;D.position.set(nt,dt),p.forEach(S=>{D.getBounds().containsPoint(S.position.x,S.position.y)&&(st+=S.height),D.position.set(nt,dt-st)}),D.label="text-box",D.zIndex=11e3;const q=c.toGlobal(D.position);return D.position.set(q.x,q.y),D.scale.set(.6),l.addChild(D),setTimeout(()=>{const S=p.get(P.id());S&&(c.removeChild(S),p.delete(P.id()),S.destroy())},2e3),p.set(P.id(),D),D},k=(P,_)=>{const{x:V,y:U}=_,D=V*n,K=U*n;E.push(X.to(P.view.position,{x:D,y:K,duration:.2,ease:"power2.inOut",onUpdate:()=>{P.view.zIndex=P.view.position.y},onComplete:()=>{P.view.position.set(D,K)}}))},R=async()=>{if(N)return;const{x:P,y:_}=i.position();g&&(g.update(),g.view.zIndex=g.view.position.y,(g.view.position.x!==P*n||g.view.position.y!==_*n)&&k(g,{x:P,y:_})),await f.process();for(const V of T){const U=T.indexOf(V),{x:D,y:K}=s[U].position();V.update(),(V.view.position.x!==D*n||V.view.position.y!==K*n)&&k(V,{x:D,y:K})}I.forEach((V,U)=>{const{x:D,y:K}=d[U].position();V.view.position.set(D*n+20,K*n-50),V.view.scale.set(1.5,1.5),V.view.zIndex=V.view.y+32}),u.update()},B=async(P,_)=>{const V=new $;V.label="looted-icon-container";const U=G.from(`${P}.png`);U.width=n/2,U.height=n/2;const D=new Z;D.circle(n*.25,n*.25,n/2),D.fill("khaki"),V.addChild(D,U),V.zIndex=11e3,V.position.set((_.x+1)*n,_.y*n-n);const K=c.toGlobal(V.position);l.addChild(V),V.position.set(K.x,K.y),V.scale.set(.6);const st=y.get(`${{x:_.x,y:_.y}}`)??0;y.set(`${{x:_.x,y:_.y}}`,st+1),await X.delayedCall(.2*st,()=>{}),X.to(V.position,{y:V.position.y-n*4,duration:1,delay:st*.1,ease:"power2.inOut",onComplete:()=>{l.removeChild(V),V.destroy({children:!0});const nt=y.get(`${{x:_.x,y:_.y}}`)??0;nt>1?y.set(`${{x:_.x,y:_.y}}`,nt-1):y.delete(`${{x:_.x,y:_.y}}`)}})};b(),R(),c.skew.set(Math.PI/6,0),f.view.zIndex=11e3;const O=new Z;return l.addChild(O),l.label="non-skewed-container",O.rect(0,0,innerWidth,innerHeight),O.fill("black"),O.alpha=0,{view:c,nonSkewedContainer:l,addNpc:A,animateIconFloat:B,handleEndOfTurnUpdates:R,createTextBox:w,destroy:m}};var ie={},At={},_e;function Gt(){if(_e)return At;_e=1,Object.defineProperty(At,"__esModule",{value:!0}),At.Collector=void 0;let o=class{constructor(e){this.emit=(...i)=>{e.emitCollecting(this,i)}}};return At.Collector=o,At}var Pt={},Ee;function on(){if(Ee)return Pt;Ee=1,Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.CollectorArray=void 0;const o=Gt();let t=class extends o.Collector{constructor(){super(...arguments),this.result=[]}handleResult(i){return this.result.push(i),!0}getResult(){return this.result}reset(){this.result.length=0}};return Pt.CollectorArray=t,Pt}var Nt={},Se;function sn(){if(Se)return Nt;Se=1,Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.CollectorLast=void 0;const o=Gt();let t=class extends o.Collector{handleResult(i){return this.result=i,!0}getResult(){return this.result}reset(){delete this.result}};return Nt.CollectorLast=t,Nt}var Rt={},Ae;function rn(){if(Ae)return Rt;Ae=1,Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.CollectorUntil0=void 0;const o=Gt();let t=class extends o.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,this.result}getResult(){return this.result}reset(){this.result=!1}};return Rt.CollectorUntil0=t,Rt}var Vt={},Pe;function an(){if(Pe)return Vt;Pe=1,Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.CollectorWhile0=void 0;const o=Gt();let t=class extends o.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,!this.result}getResult(){return this.result}reset(){this.result=!1}};return Vt.CollectorWhile0=t,Vt}var Bt={},Lt={},Ne;function ln(){if(Ne)return Lt;Ne=1,Object.defineProperty(Lt,"__esModule",{value:!0}),Lt.SignalConnectionImpl=void 0;class o{constructor(e,i){this.link=e,this.parentCleanup=i}disconnect(){return this.link!==null?(this.link.unlink(),this.link=null,this.parentCleanup(),this.parentCleanup=null,!0):!1}set enabled(e){this.link&&this.link.setEnabled(e)}get enabled(){return this.link!==null&&this.link.isEnabled()}}return Lt.SignalConnectionImpl=o,Lt}var Ot={},Re;function cn(){if(Re)return Ot;Re=1,Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.SignalLink=void 0;let o=class ei{constructor(e=null,i=null,n=0){this.enabled=!0,this.newLink=!1,this.callback=null,this.prev=e??this,this.next=i??this,this.order=n}isEnabled(){return this.enabled&&!this.newLink}setEnabled(e){this.enabled=e}unlink(){this.callback=null,this.next.prev=this.prev,this.prev.next=this.next}insert(e,i){let n=this.prev;for(;n!==this&&!(n.order<=i);)n=n.prev;const s=new ei(n,n.next,i);return s.callback=e,n.next=s,s.next.prev=s,s}};return Ot.SignalLink=o,Ot}var Ve;function hn(){if(Ve)return Bt;Ve=1,Object.defineProperty(Bt,"__esModule",{value:!0}),Bt.Signal=void 0;const o=ln(),t=cn();let e=class{constructor(){this.head=new t.SignalLink,this.hasNewLinks=!1,this.emitDepth=0,this.connectionsCount=0}getConnectionsCount(){return this.connectionsCount}hasConnections(){return this.connectionsCount>0}connect(n,s=0){this.connectionsCount++;const d=this.head.insert(n,s);return this.emitDepth>0&&(this.hasNewLinks=!0,d.newLink=!0),new o.SignalConnectionImpl(d,()=>this.decrementConnectionCount())}decrementConnectionCount(){this.connectionsCount--}disconnect(n){for(let s=this.head.next;s!==this.head;s=s.next)if(s.callback===n)return this.decrementConnectionCount(),s.unlink(),!0;return!1}disconnectAll(){for(;this.head.next!==this.head;)this.head.next.unlink();this.connectionsCount=0}emit(...n){this.emitDepth++;for(let s=this.head.next;s!==this.head;s=s.next)s.isEnabled()&&s.callback&&s.callback.apply(null,n);this.emitDepth--,this.unsetNewLink()}emitCollecting(n,s){this.emitDepth++;for(let d=this.head.next;d!==this.head;d=d.next)if(d.isEnabled()&&d.callback){const r=d.callback.apply(null,s);if(!n.handleResult(r))break}this.emitDepth--,this.unsetNewLink()}unsetNewLink(){if(this.hasNewLinks&&this.emitDepth===0){for(let n=this.head.next;n!==this.head;n=n.next)n.newLink=!1;this.hasNewLinks=!1}}};return Bt.Signal=e,Bt}var Wt={},Be;function dn(){if(Be)return Wt;Be=1,Object.defineProperty(Wt,"__esModule",{value:!0}),Wt.SignalConnections=void 0;let o=class{constructor(){this.list=[]}add(e){this.list.push(e)}disconnectAll(){for(const e of this.list)e.disconnect();this.list=[]}getCount(){return this.list.length}isEmpty(){return this.list.length===0}};return Wt.SignalConnections=o,Wt}var Le;function un(){return Le||(Le=1,function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.SignalConnections=o.Signal=o.CollectorWhile0=o.CollectorUntil0=o.CollectorLast=o.CollectorArray=o.Collector=void 0;var t=Gt();Object.defineProperty(o,"Collector",{enumerable:!0,get:function(){return t.Collector}});var e=on();Object.defineProperty(o,"CollectorArray",{enumerable:!0,get:function(){return e.CollectorArray}});var i=sn();Object.defineProperty(o,"CollectorLast",{enumerable:!0,get:function(){return i.CollectorLast}});var n=rn();Object.defineProperty(o,"CollectorUntil0",{enumerable:!0,get:function(){return n.CollectorUntil0}});var s=an();Object.defineProperty(o,"CollectorWhile0",{enumerable:!0,get:function(){return s.CollectorWhile0}});var d=hn();Object.defineProperty(o,"Signal",{enumerable:!0,get:function(){return d.Signal}});var r=dn();Object.defineProperty(o,"SignalConnections",{enumerable:!0,get:function(){return r.SignalConnections}})}(ie)),ie}var Oe=un(),fn=Object.defineProperty,pn=(o,t,e)=>t in o?fn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,Dt=(o,t,e)=>pn(o,typeof t!="symbol"?t+"":t,e);class mn extends ${constructor(t){var e;super(),Dt(this,"options"),Dt(this,"view"),Dt(this,"_type"),Dt(this,"_maxWidth"),Dt(this,"children",[]),t&&(t.maxWidth&&(this._maxWidth=t.maxWidth),this.init(t)),(e=t==null?void 0:t.items)==null||e.forEach(i=>this.addChild(i)),this.on("added",()=>this.arrangeChildren()),this.on("childAdded",()=>this.arrangeChildren())}init(t){this.options=t,t!=null&&t.type&&(this.type=t.type),t!=null&&t.children&&t.children.forEach(e=>this.addChild(e))}set type(t){this._type=t,this.arrangeChildren()}get type(){return this._type}set elementsMargin(t){if(!this.options)throw new Error("List has not been initiated!");this.options.elementsMargin=t,this.arrangeChildren()}get elementsMargin(){var t;return((t=this.options)==null?void 0:t.elementsMargin)??0}set padding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.padding=t,this.options.vertPadding=t,this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get padding(){var t;return((t=this.options)==null?void 0:t.padding)??0}set vertPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.vertPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get vertPadding(){var t;return((t=this.options)==null?void 0:t.vertPadding)??this.padding??0}set horPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.arrangeChildren()}get horPadding(){var t;return((t=this.options)==null?void 0:t.horPadding)??this.padding??0}set leftPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.leftPadding=t,this.arrangeChildren()}get leftPadding(){var t;return((t=this.options)==null?void 0:t.leftPadding)??this.horPadding}set rightPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.rightPadding=t,this.arrangeChildren()}get rightPadding(){var t;return((t=this.options)==null?void 0:t.rightPadding)??this.horPadding}set topPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.topPadding=t,this.arrangeChildren()}get topPadding(){var t;return((t=this.options)==null?void 0:t.topPadding)??this.vertPadding}set bottomPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.bottomPadding=t,this.arrangeChildren()}get bottomPadding(){var t;return((t=this.options)==null?void 0:t.bottomPadding)??this.vertPadding}arrangeChildren(){var d,r;let t=0,e=this.leftPadding,i=this.topPadding;const n=((d=this.options)==null?void 0:d.elementsMargin)??0;let s=this.maxWidth??((r=this.parent)==null?void 0:r.width);this.rightPadding&&(s-=this.rightPadding),this.children.forEach((l,c)=>{switch(this.type){case"vertical":l.y=i,l.x=e,i+=n+l.height;break;case"horizontal":l.x=e,l.y=i,e+=n+l.width;break;case"bidirectional":default:l.x=e,l.y=i,l.x+l.width>s&&c>0&&(i+=n+t,e=this.leftPadding,l.x=e,l.y=i,t=0),t=Math.max(t,l.height),e+=n+l.width;break}})}removeItem(t){const e=this.children[t];e&&(this.removeChild(e),this.arrangeChildren())}set maxWidth(t){this._maxWidth=t,this.arrangeChildren()}get maxWidth(){return this._maxWidth}}var gn=Object.defineProperty,yn=(o,t,e)=>t in o?gn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,Ht=(o,t,e)=>yn(o,typeof t!="symbol"?t+"":t,e);class vn{constructor(t={}){Ht(this,"x"),Ht(this,"ax"),Ht(this,"dx"),Ht(this,"tx"),Ht(this,"_options"),this.x=0,this.ax=0,this.dx=0,this.tx=0,this._options=t,this._options.max=t.max||160,this._options.damp=t.damp||.8,this._options.springiness=t.springiness||.1}update(){this.ax=(this.tx-this.x)*this._options.springiness,this.dx+=this.ax,this.dx*=this._options.damp,this.dx<-this._options.max?this.dx=-this._options.max:this.dx>this._options.max&&(this.dx=this._options.max),this.x+=this.dx}reset(){this.x=0,this.ax=0,this.dx=0,this.tx=0}get max(){return this._options.max}set max(t){this._options.max=t}get damp(){return this._options.damp}set damp(t){this._options.damp=t}get springiness(){return this._options.springiness}set springiness(t){this._options.springiness=t}}var wn=Object.defineProperty,xn=(o,t,e)=>t in o?wn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,_t=(o,t,e)=>xn(o,typeof t!="symbol"?t+"":t,e);class bn{constructor(){_t(this,"done"),_t(this,"to"),_t(this,"_spring"),_t(this,"_pos"),_t(this,"_speed"),_t(this,"_correctSpeed"),this._spring=new vn,this._pos=0,this.to=0}start(t,e,i){this._speed=t,this._pos=e,this.to=i,this.done=!1,this._spring.x=this._pos,this._spring.tx=this.to;const n=this.to-this._pos,s=Math.abs(n)/n,d=Math.abs(this._speed)/this._speed;s!==d?this._correctSpeed=!0:this._correctSpeed=!1}update(){if(this._correctSpeed)this._speed*=.6,Math.abs(this._speed)<2&&(this._correctSpeed=!1),this._pos+=this._speed,this._spring.x=this._pos;else{const t=this.to-this._pos;Math.abs(t)<.05?(this._pos=this.to,this.done=!0):(this._spring.tx=this.to,this._spring.update(),this._pos=this._spring.x)}return this._pos}cancel(){}}var Cn=Object.defineProperty,Tn=(o,t,e)=>t in o?Cn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,lt=(o,t,e)=>Tn(o,typeof t!="symbol"?t+"":t,e);class We{constructor(t={}){lt(this,"position",0),lt(this,"constrain",!0),lt(this,"min",0),lt(this,"max",0),lt(this,"maxSpeed",400),lt(this,"_ease"),lt(this,"_offset",0),lt(this,"_prev",0),lt(this,"_speed",0),lt(this,"_hasStopped"),lt(this,"_targetSpeed",0),lt(this,"_speedChecker",0),lt(this,"_grab",0),lt(this,"_activeEase"),this.constrain=t.constrain??!0,this.maxSpeed=t.maxSpeed??400,this._ease=t.ease??new bn}set value(t){this._speed=0,this.position=t}get value(){return this.position}grab(t){this._grab=t,this._offset=this.position-t,this._speedChecker=0,this._targetSpeed=this._speed=0,this._hasStopped=!1}hold(t){this._speedChecker++,this.position=t+this._offset,this._speedChecker>1&&(this._targetSpeed=this.position-this._prev),this._speed+=(this._targetSpeed-this._speed)/2,this._speed>this.maxSpeed?this._speed=this.maxSpeed:this._speed<-this.maxSpeed&&(this._speed=-this.maxSpeed),this._prev=this.position,this.constrain&&(this._activeEase=null,this.position>this.min?this.position-=(this.position-this.min)/1.5:this.position<this.max&&(this.position+=(this.max-this.position)/1.5))}slide(t=!1){this._hasStopped||(this.constrain?this._updateConstrain(t):this._updateDefault())}get moveAmount(){return-(this.position-this._offset-this._grab)}_updateDefault(){this._speed*=.9,this.position+=this._speed,(this._speed<0?this._speed*-1:this._speed)<.01&&(this._hasStopped=!0)}_updateConstrain(t=!1){const e=this.max;t?(this.value>0&&(this.value=0),this.value>0&&(this.value=0),this.value<this.max&&(this.value=this.max),this.value<this.max&&(this.value=this.max)):this.position>this.min||this.position<e||this._activeEase?(this._activeEase||(this._activeEase=this._ease,this.position>this.min?this._activeEase.start(this._speed,this.position,this.min):this._activeEase.start(this._speed,this.position,e)),this.position=this._activeEase.update(),this._activeEase.done&&(this.position=this._activeEase.to,this._speed=0,this._activeEase=null)):this._updateDefault()}}var kn=Object.defineProperty,In=(o,t,e)=>t in o?kn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,xt=(o,t,e)=>In(o,typeof t!="symbol"?t+"":t,e);class Mn{constructor(t){xt(this,"xAxis"),xt(this,"yAxis"),xt(this,"_isDown"),xt(this,"_globalPosition"),xt(this,"_frame"),xt(this,"_bounds"),xt(this,"_dirty"),xt(this,"disableEasing",!1),this.xAxis=new We({ease:t.xEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.yAxis=new We({ease:t.yEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.disableEasing=t.disableEasing??!1,this._frame=new jt,this._bounds=new jt,this._globalPosition=new qe}pointerDown(t){this._globalPosition=t,this.xAxis.grab(t.x),this.yAxis.grab(t.y),this._isDown=!0}pointerUp(){this._isDown=!1}pointerMove(t){this._globalPosition=t}update(){this._dirty&&(this._dirty=!1,this.xAxis.min=this._bounds.left,this.xAxis.min=this._bounds.right-this._frame.width,this.xAxis.min=this._bounds.top,this.xAxis.min=this._bounds.bottom-this._frame.height),this._isDown?(this.xAxis.hold(this._globalPosition.x),this.yAxis.hold(this._globalPosition.y)):(this.xAxis.slide(this.disableEasing),this.yAxis.slide(this.disableEasing))}resize(t,e){this._frame.x=0,this._frame.width=t,this._frame.y=0,this._frame.height=e,this._dirty=!0}setBounds(t,e,i,n){this._bounds.x=t,this._bounds.width=e-t,this._bounds.y=i,this._bounds.height=n-i,this._dirty=!0}get x(){return this.xAxis.value}get y(){return this.yAxis.value}}var _n=Object.defineProperty,En=(o,t,e)=>t in o?_n(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,j=(o,t,e)=>En(o,typeof t!="symbol"?t+"":t,e);class de extends ${constructor(t){super(),j(this,"background"),j(this,"borderMask"),j(this,"lastWidth"),j(this,"lastHeight"),j(this,"_width",0),j(this,"_height",0),j(this,"_dimensionChanged",!1),j(this,"list"),j(this,"_trackpad"),j(this,"isDragging",0),j(this,"interactiveStorage",[]),j(this,"visibleItems",[]),j(this,"pressedChild"),j(this,"ticker",ri.shared),j(this,"options"),j(this,"stopRenderHiddenItemsTimeout"),j(this,"onMouseScrollBinding",this.onMouseScroll.bind(this)),j(this,"dragStarTouchPoint"),j(this,"isOver",!1),j(this,"proximityRange"),j(this,"proximityStatusCache",[]),j(this,"lastScrollX"),j(this,"lastScrollY"),j(this,"proximityCheckFrameCounter",0),j(this,"onProximityChange",new Oe.Signal),j(this,"onScroll",new Oe.Signal),t&&this.init(t),this.ticker.add(this.update,this)}init(t){this.options=t,this.setBackground(t.background),this._width=t.width|this.background.width,this._height=t.height|this.background.height,this.proximityRange=t.proximityRange??0,this.list||(this.list=new mn,super.addChild(this.list)),this.list.init({type:t.type,elementsMargin:t.elementsMargin,padding:t.padding,vertPadding:t.vertPadding,horPadding:t.horPadding,topPadding:t.topPadding,bottomPadding:t.bottomPadding,leftPadding:t.leftPadding,rightPadding:t.rightPadding}),this.addItems(t.items),this.hasBounds&&(this.addMask(),this.makeScrollable()),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.options.globalScroll=t.globalScroll??!0,this.options.shiftScroll=t.shiftScroll??!1,this.resize()}get hasBounds(){return!!this._width||!!this._height}addItems(t){t!=null&&t.length&&t.forEach(e=>this.addItem(e))}removeItems(){this.proximityStatusCache.length=0,this.list.removeChildren()}addItem(...t){if(t.length>1)t.forEach(e=>this.addItem(e));else{const e=t[0];(!e.width||!e.height)&&console.error("ScrollBox item should have size"),e.eventMode="static",this.list.addChild(e),this.proximityStatusCache.push(!1),this.options.disableDynamicRendering||(e.renderable=this.isItemVisible(e))}return this.resize(),t[0]}removeItem(t){this.list.removeItem(t),this.proximityStatusCache.splice(t,1),this.resize()}isItemVisible(t,e=0){let i=!1;const n=this.list;if(this.isVertical||this.isBidirectional){const s=t.y+n.y;s+t.height>=-e&&s<=this.options.height+e&&(i=!0)}if(this.isHorizontal||this.isBidirectional){const s=t.x+n.x;s+t.width>=-e&&s<=this.options.width+e&&(i=!0)}return i}get items(){var t;return((t=this.list)==null?void 0:t.children)??[]}setBackground(t){this.background&&this.removeChild(this.background),this.options.background=t,this.background=new Z,this.addChildAt(this.background,0),this.resize()}addMask(){this.borderMask||(this.borderMask=new Z,super.addChild(this.borderMask),this.mask=this.borderMask),this.resize()}makeScrollable(){this._trackpad||(this._trackpad=new Mn({disableEasing:this.options.disableEasing})),this.on("pointerdown",t=>{this.renderAllItems(),this.isDragging=1,this.dragStarTouchPoint=this.worldTransform.applyInverse(t.global),this._trackpad.pointerDown(this.dragStarTouchPoint);const e=this.list.worldTransform.applyInverse(t.global);this.visibleItems.forEach(i=>{i.x<e.x&&i.x+i.width>e.x&&i.y<e.y&&i.y+i.height>e.y&&(this.pressedChild=i)})}),this.on("pointerup",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("pointerover",()=>{this.isOver=!0}),this.on("pointerout",()=>{this.isOver=!1}),this.on("pointerupoutside",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("globalpointermove",t=>{var i,n;if(!this.isDragging)return;const e=this.worldTransform.applyInverse(t.global);if(this.dragStarTouchPoint){const s=this.options.dragTrashHold??10;if(this.isHorizontal||this.isBidirectional){const d=e.x-this.dragStarTouchPoint.x;Math.abs(d)>s&&(this.isDragging=2)}if(this.isVertical||this.isBidirectional){const d=e.y-this.dragStarTouchPoint.y;Math.abs(d)>s&&(this.isDragging=2)}}this.dragStarTouchPoint&&this.isDragging!==2||(this._trackpad.pointerMove(e),this.pressedChild&&(this.revertClick(this.pressedChild),this.pressedChild=null),this.isBidirectional?(i=this.onScroll)==null||i.emit({x:this.scrollX,y:this.scrollY}):(n=this.onScroll)==null||n.emit(this.isVertical?this.scrollY:this.scrollX))}),document.addEventListener("wheel",this.onMouseScrollBinding,!0)}setInteractive(t){this.eventMode=t?"static":"auto"}get listHeight(){return this.list.height+this.list.topPadding+this.list.bottomPadding}get listWidth(){return this.list.width+this.list.leftPadding+this.list.rightPadding}resize(t=!1){if(this.hasBounds){if(this.renderAllItems(),this.borderMask&&(t||this._dimensionChanged||this.lastWidth!==this.listWidth||this.lastHeight!==this.listHeight)){this.options.width||(this._width+=this.listWidth),this.options.height||(this._height+=this.listHeight),this.borderMask.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill(16711935).stroke(0),this.borderMask.eventMode="none";const e=this.options.background;this.background.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill({color:e??0,alpha:e?1:1e-7}),this.isBidirectional?this.setInteractive(this.listWidth>this._width||this.listHeight>this._height):this.isHorizontal?this.setInteractive(this.listWidth>this._width):this.setInteractive(this.listHeight>this._height),this.lastWidth=this.listWidth,this.lastHeight=this.listHeight}if(this._trackpad){const e=this.borderMask.width-this.list.width-this.list.leftPadding-this.list.rightPadding,i=this.borderMask.height-this.list.height-this.list.topPadding-this.list.bottomPadding;this.isBidirectional?(this._trackpad.yAxis.max=-Math.abs(i),this._trackpad.xAxis.max=-Math.abs(e)):this.isVertical?this._trackpad.yAxis.max=-Math.abs(i):this.isHorizontal&&(this._trackpad.xAxis.max=-Math.abs(e))}this._dimensionChanged?(this.list.arrangeChildren(),this.stopRenderHiddenItems(),this._dimensionChanged=!1):(t&&this.list.arrangeChildren(),this.updateVisibleItems()),this.lastScrollX=null,this.lastScrollY=null}}onMouseScroll(t){var s,d,r;if(!this.isOver&&!this.options.globalScroll)return;this.renderAllItems();const e=!!this.options.shiftScroll,i=e?typeof t.deltaX<"u"||typeof t.deltaY<"u":typeof t.deltaX<"u",n=typeof t.deltaY<"u";if((this.isHorizontal||this.isBidirectional)&&i){const l=e||this.isBidirectional?t.deltaX:t.deltaY,c=this.list.x-l;if(this.listWidth<this._width)this._trackpad.xAxis.value=0;else{const h=this._width-this.listWidth,a=0;this._trackpad.xAxis.value=Math.min(a,Math.max(h,c))}}if((this.isVertical||this.isBidirectional)&&n){const l=this.list.y-t.deltaY;if(this.listHeight<this._height)this._trackpad.yAxis.value=0;else{const c=this._height-this.listHeight,h=0;this._trackpad.yAxis.value=Math.min(h,Math.max(c,l))}}this.isBidirectional&&(i||n)?(s=this.onScroll)==null||s.emit({x:this._trackpad.xAxis.value,y:this._trackpad.yAxis.value}):this.isHorizontal&&i?(d=this.onScroll)==null||d.emit(this._trackpad.xAxis.value):this.isVertical&&n&&((r=this.onScroll)==null||r.emit(this._trackpad.yAxis.value)),this.stopRenderHiddenItems()}scrollBottom(){this.interactive?this.scrollTo(this.list.children.length-1):this.scrollTop()}scrollTop(){this.renderAllItems(),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.stopRenderHiddenItems()}renderAllItems(){clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null,!this.options.disableDynamicRendering&&this.items.forEach(t=>{t.renderable=!0})}stopRenderHiddenItems(){this.options.disableDynamicRendering||(this.stopRenderHiddenItemsTimeout&&(clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null),this.stopRenderHiddenItemsTimeout=setTimeout(()=>this.updateVisibleItems(),2e3))}updateVisibleItems(){this.visibleItems.length=0,this.items.forEach(t=>{t.renderable=this.isItemVisible(t),this.visibleItems.push(t)})}scrollTo(t){if(!this.interactive)return;const e=this.list.children[t];e&&(this.renderAllItems(),this._trackpad.xAxis.value=this.isHorizontal||this.isBidirectional?this._width-e.x-e.width-this.list.rightPadding:0,this._trackpad.yAxis.value=this.isVertical||this.isBidirectional?this._height-e.y-e.height-this.list.bottomPadding:0,this.stopRenderHiddenItems())}scrollToPosition({x:t,y:e}){t===void 0&&e===void 0||(this.renderAllItems(),t!==void 0&&(this.scrollX=-t),e!==void 0&&(this.scrollY=-e),this.stopRenderHiddenItems())}get height(){return this._height}set height(t){this._height=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}get width(){return this._width}set width(t){this._width=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}setSize(t,e){typeof t=="object"?(e=t.height??t.width,t=t.width):e=e??t,this._width=t,this._height=e,this._dimensionChanged=!0,this.resize(),this.scrollTop()}getSize(t){return t=t||{width:0,height:0},t.width=this._width,t.height=this._height,t}get scrollX(){return this._trackpad.xAxis.value}set scrollX(t){this._trackpad.xAxis.value=t}get scrollY(){return this._trackpad.yAxis.value}set scrollY(t){this._trackpad.yAxis.value=t}update(){this.list&&(this._trackpad.update(),(this.isHorizontal||this.isBidirectional)&&this.list.x!==this._trackpad.x&&(this.list.x=this._trackpad.x),(this.isVertical||this.isBidirectional)&&this.list.y!==this._trackpad.y&&(this.list.y=this._trackpad.y),!this.options.disableProximityCheck&&(this._trackpad.x!==this.lastScrollX||this._trackpad.y!==this.lastScrollY)&&(this.proximityCheckFrameCounter++,this.proximityCheckFrameCounter>=(this.options.proximityDebounce??10)&&(this.items.forEach((t,e)=>{const i=this.isItemVisible(t,this.proximityRange),n=this.proximityStatusCache[e];i!==n&&(this.proximityStatusCache[e]=i,this.onProximityChange.emit({item:t,index:e,inRange:i}))}),this.lastScrollX=this._trackpad.x,this.lastScrollY=this._trackpad.y,this.proximityCheckFrameCounter=0)))}destroy(t){this.ticker.remove(this.update,this),document.removeEventListener("wheel",this.onMouseScrollBinding,!0),this.background.destroy(),this.list.destroy(),super.destroy(t)}restoreItemsInteractivity(){this.interactiveStorage.forEach(t=>{t.item.eventMode=t.eventMode}),this.interactiveStorage.length=0}revertClick(t){t.eventMode!=="auto"&&(ai.any?t.emit("pointerupoutside",null):t.emit("mouseupoutside",null),this.interactiveStorage.push({item:t,eventMode:t.eventMode}),t.eventMode="auto"),t instanceof $&&t.children&&t.children.forEach(e=>this.revertClick(e))}get scrollHeight(){return this.list.height}get scrollWidth(){return this.list.width}get isVertical(){return(this.options.type??"vertical")==="vertical"}get isHorizontal(){return this.options.type==="horizontal"}get isBidirectional(){return this.options.type==="bidirectional"}}const Sn=()=>{const o=document.createElement("canvas");o.width=256,o.height=1;const t=o.getContext("2d"),e=t.createLinearGradient(0,0,o.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,o.width,1),Ge.from(o)},De=(o,t)=>{const e=new $,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},n=new Et,s=new Z;n.text=o,n.style=i;const d=()=>{s.clear(),s.roundRect(n.x-10,n.y,n.width+20,n.height,10),s.fill("black"),s.alpha=.5};e.addChild(s,n);const r=l=>{n.text=l,d()};return d(),{view:e,updateText:r}},An=o=>{const t=Sn(),e=new G(t);return e.label="gradient-background",e.position.set(o.x,o.y-2.5),e.width=o.width+16,e.height=o.height+5,o.addChildAt(e,0),e},zt=o=>{const{viewModel:t,includeItemValue:e,quantity:i}=o,n=o.itemValue,s=new $;let d=!1;s.label=`${t.name()}-view`,s.eventMode="static";const r=G.from(`${t.code()}.png`);r.width=50,r.height=50,s.addChild(r);const l=De(`${(i==null?void 0:i.toString())??t.quantity().toString()}`);l.view.position.set(r.width-l.view.width*.5,r.height);let c=null;e&&(c=De(`$ ${(n||t.value()).toString()}`,{fill:"gold"}),c.view.position.set(r.width-c.view.width*.5,0),s.addChild(c.view),r.position.set(0,c.view.height+5),l.view.position.set(r.width-l.view.width*.5,c.view.height+r.height));const h=r.y+r.height,a=(g,x)=>{const T=new $;return x()<=0||(d=!0,Array(x()).fill(0).forEach((I,M)=>{const E=G.from(`${g}-icon.png`);E.width=20,E.height=20,E.position.set(2.5+M*E.width*.5,0),T.addChildAt(E,0)}),An(T),T.position.set(0,h-T.height+14),s.addChild(T)),T};t.isArmourIconVisible()&&a("armour",t.armour);const f=new $;if(t.isHealthIconVisible()&&a("health",t.health),t.isDamageIconVisible()&&t.damage()>0&&t.range()>0){const g=a("damage",t.damage),x=a("range",t.range);x.position.set(g.x,g.y-x.height)}const p=G.from("armour-broken-icon.png");p.width=20,p.height=20,p.position.set(0,r.height-p.height),s.addChild(l.view,p,f),s.on("pointertap",()=>{u()}),d&&r.position.set(16,r.y);const u=()=>{t.interact(),J.play("audio/sfx/collect.wav",{category:"gameplay"})},y=rt(()=>{at(()=>{l.updateText((i==null?void 0:i.toString())??t.quantity().toString()),p.visible=t.maxArmour()>0&&t.armour()<=0})});return s.on("destroy",()=>{y()}),{view:s,interact:u}},Pn=(o,t)=>{const i=new Z;return i.roundRect(-2.5,-2.5,o.view.width+2.5*2,o.view.height+2.5,10),i.fill(t??"gray"),i.alpha=.8,i.eventMode="static",i},qt=(o,t)=>{const e=new $;e.addChild(o.view),e.label=`${o.view.label}-container`,e.eventMode="static";const i=Pn(o,t);return e.addChild(i,o.view),{container:e,background:i}},Nn=o=>{const t=new $,e=10;let i;t.label="global-inventory-view",t.eventMode="static";const n=Zt({text:o.ownerName(),fontSize:26,disableBackground:!0}),s=G.from("text-background.png"),d=G.from("text-background.png"),r=new Z;t.addChild(s,d,n,r);const l=()=>{s.width=h.width,s.height=n.height,d.width=h.width,d.height=g.height*1.3,d.position.set(0,h.height+g.height*1.6),r.clear(),r.label="title-background-stroke",r.rect(s.x,s.y,s.width,s.height),r.rect(d.x,d.y,d.width,d.height),r.stroke({color:"khaki",width:2})},c=innerWidth<innerHeight,h=new de({width:c?innerWidth:innerWidth*.8,height:c?innerHeight*.6:innerHeight*.8,padding:e,radius:10,elementsMargin:e}),a=ut({spriteName:"eye-icon",onClick:()=>{o.setInfoButtonEnabled(!o.isInfoButtonEnabled()),a.tint=o.isInfoButtonEnabled()?"lightgreen":"white"},disableFlicker:!0});t.addChild(a),h.label="global-inventory-scroll-box",h.position.set(0,n.height+e),t.addChild(h),t.visible=!1;const f=(T,I)=>I.weapon().id()===T.id()||I.bodyArmour().id()===T.id()||I.headArmour().id()===T.id()||I.feetArmour().id()===T.id(),p=T=>{T=T??!1,h.removeItems();const I=1.5;o.stacks().forEach(M=>{const E=zt({viewModel:M.item,includeItemValue:T,quantity:M.quantity}),N=new $,A=o.owner?f(M.item,o.owner):!1,b=qt(E,A?"lightgreen":"gray");N.on("pointertap",()=>{C()}),N.addChild(b.background,b.container),N.label=`${E.view.label}-container`,h.addItem(N);const m=Math.min(I,Math.min((h.width-e*2)/N.width,(h.height-e*2)/N.height));N.scale.set(m),E.view.off("pointertap");const C=()=>{if(o.isInfoButtonEnabled()){i&&(t.removeChild(i),i=void 0),i=le({title:M.item.name(),content:M.item.description(),type:M.item.type(),onClose:()=>{t.removeChild(i),i=void 0}}),i.position.set(t.width*.5,t.height*.5),t.addChild(i);return}E.interact();const v=N.tint;N.tint="green",setTimeout(()=>{N.tint=v},200)}})},u=(T=!1)=>{p(T),o.setInfoButtonEnabled(!1),J.play("audio/sfx/inventory-open.wav",{category:"gameplay"}),t.visible=!0},y=()=>{o.setInfoButtonEnabled(!1),L.emit("ON_CLOSE_INVENTORY_REQUESTED")},g=ut({spriteName:"exit-icon",onClick:()=>{o.setInfoButtonEnabled(!1),L.emit("ON_CLOSE_INVENTORY_REQUESTED")}});if(n.position.set(t.width*.5,n.height*.5),g.position.set(h.width-g.width,h.height+g.height*2),a.position.set(g.position.x-a.width-5,g.position.y),t.addChild(g),o.ownerName()!=="Hero"){const T=ut({spriteName:"take-all-icon",onClick:()=>{o.items().forEach(I=>{I.interact()}),J.play("audio/sfx/inventory-open.wav",{category:"gameplay"})},onClickAudio:""});T.position.set(T.width*.4,g.y),t.addChild(T)}const x=Math.max(.6,Math.min(innerWidth/t.width,innerHeight/t.height));return t.scale.set(Math.min(.6,x)),rt(()=>{at(()=>{o.isEmpty()&&y(),o.isInfoButtonEnabled()||i&&(t.removeChild(i),i=void 0),p(),n.position.set(h.width*.5,n.height*.5),g.position.set(h.width-g.width,h.height+g.height*2),a.position.set(g.position.x-a.width-5,g.position.y),l()})},t),{view:t,show:u,hide:y}},Rn=o=>{const{viewModel:t}=o,e=new $;e.label="new-trade-view",e.alpha=0;const i=new Z;i.label="new-trade-view-background",e.addChild(i);const n=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let s=!1;const d=({title:b,stacks:m,width:C,height:v,playerStacks:w,npcInv:k=!1,includeItemValue:R=!1,isTradeInv:B=!1})=>{const O=new $;O.label=`${b}-screen-view`;const P=G.from("text-background.png");P.label=`${b}-title-background`;const _=new Z;_.label=`${b}-title-background-outline`;const V=Zt({text:b,disableBackground:!0,onClick:()=>{}});V.label=`${b}-title-button`;const U=new de({width:C,height:v,padding:4,elementsMargin:2});U.label=`${b}-inventory-view`;const D=new Z;D.label=`${b}-background`,O.addChild(D,P,V,U,_);const K=(st,nt,dt)=>{const q=innerHeight>innerWidth;st.forEach(S=>{const H=zt({viewModel:S.item,includeItemValue:R,itemValue:t.getItemPrice(S.item,dt),quantity:S.quantity}),Q=qt(H,nt==="buy"||nt==="buy-return"?"pink":"lightblue"),et=new $;H.view.off("pointertap"),et.on("pointertap",()=>{It(),L.emit("ON_ITEM_INTERACTION",{itemViewModel:S.item,action:nt}),s=!0}),et.addChild(Q.container,H.view),et.label=`${H.view.label}-container`,U.addItem(et);const mt=q?.6:.7;et.scale.set(Math.min(mt,C/(H.view.width+10)),Math.min(mt,v/(H.view.height+10)));const It=()=>{et.tint=65280,setTimeout(()=>{et.tint=16777215},200)}})};return k?K(m,"buy",!0):B?(K(w||[],"sell-return",!1),K(m,"buy-return",!0)):K(m,"sell",!1),V.scale.set(.4),V.position.set(C*.5,V.height*.5),U.position.set(C*.5-U.width*.5,V.height+10),P.x=U.width*.025,P.width=U.width*.95,P.height=V.height,_.rect(P.x,0,P.width,P.height),_.stroke({color:"khaki",width:2}),D.rect(0,0,O.width,O.height),D.label=`${b}-background-rect`,D.fill("black"),D.stroke("black"),O};let r=null,l=null,c=null,h=null,a=null,f=null,p=null,u=null,y=null,g=null;const x=G.from("text-background.png");x.label="trade-buttons-container-background";const T=new Z;T.label="trade-buttons-container-background-outline";const I=()=>{r||l?E():J.play("audio/sfx/door.mp3");const{innerWidth:b,innerHeight:m}=window,C=m>b,v=C?b:b*.9*.3,w=C?m*.7*.3:m*.9;n(),a=ut({spriteName:"trade-icon",onClick:()=>{L.emit("ON_TRADE_REQUEST",{action:"autoTrade"}),s=!0},alpha:.8}),h=ut({spriteName:"exit-icon",onClick:()=>{L.emit("ON_CLOSE_INVENTORY_REQUESTED"),s=!0},alpha:.8});const k=()=>{g&&(e.removeChild(g),g.destroy(),g=null)},R=()=>{const P=Math.abs(t.value().quantity()),_=t.value().quantity()<0?{type:"Insufficient Funds",content:"You do not have enough funds to complete this trade."}:{type:"Trade Imbalance",content:`Trader has insufficient funds, you will lose ${P} ${P>1?"coins":"coin"}.`};g=le({title:"Confirm Trade",type:_.type,content:_.content,onConfirm:t.value().quantity()>0?()=>{L.emit("ON_TRADE_REQUEST",{action:"submit"}),s=!0,k()}:void 0,onCancel:()=>{L.emit("ON_TRADE_REQUEST",{action:"clear"}),k(),s=!0}}),e.addChild(g),g.position.set(e.width*.5-g.width*.25,e.height*.5-g.height*.5)};f=ut({spriteName:"confirm-icon",onClick:()=>{L.emit("ON_TRADE_REQUEST",{action:"submit"}),s=!0},alpha:.8}),p=ut({spriteName:"cancel-icon",onClick:()=>{if(t.npcTradeItems().isEmpty()&&t.playerTradeItems().isEmpty()){L.emit("ON_CLOSE_INVENTORY_REQUESTED"),s=!0;return}L.emit("ON_TRADE_REQUEST",{action:"clear"}),s=!0},alpha:.8});let B="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?B="green":t.value().quantity()>0?B="yellow":B="red");const O=zt({viewModel:t.value()});y=qt(O,B).container,u=new $,u.label="trade-buttons-container",u.addChild(h,f,p,a),e.addChild(x,u,T),r=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:v,height:w,includeItemValue:!0,isTradeInv:!1}),e.addChild(r),r.label="player-trade-screen",l=d({title:"Trader",stacks:t.npcInventory().stacks(),width:v,height:w,npcInv:!0,includeItemValue:!0,isTradeInv:!1}),e.addChild(l),l.label="npc-trade-screen",c=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:v,height:w,includeItemValue:!0,isTradeInv:!0}),e.addChild(c),e.alpha=1,c.label="trade-screen",t.isConfirmationModalVisible()&&R()},M=(b=!1)=>{!u||!h||(T.clear(),b?(x.angle=90,x.height=h.height*1.4,x.width=u.height,x.position.set(u.x+x.height,u.y-h.height*.2-5),T.rect(x.x-x.height,x.y,x.height,x.width)):(x.angle=0,x.width=u.width,x.height=h.height*1.4,x.position.set(u.x-17,u.y+5),T.rect(x.x,x.y,x.width,x.height)),T.stroke({color:"khaki",width:2}))},E=()=>{r&&(e.removeChild(r),r.destroy(),r=null),l&&(e.removeChild(l),l.destroy(),l=null),c&&(e.removeChild(c),c.destroy(),c=null),h&&(e.removeChild(h),h.destroy(),h=null),f&&(e.removeChild(f),f.destroy(),f=null),p&&(e.removeChild(p),p.destroy(),p=null),a&&(e.removeChild(a),a.destroy(),a=null),u&&(e.removeChild(u),u.destroy(),u=null),y&&(e.removeChild(y),y.destroy(),y=null),g&&(e.removeChild(g),g.destroy(),g=null),e.alpha=0},N=(b,m)=>{if(e.alpha===0||!r||!l||!c)return;if(m>b){if(r.position.set(0,0),c.position.set(0,r.y+r.height+2),l.position.set(0,c.position.y+c.height+2),u){const v=b-20,w=u.children,k=w.reduce((O,P)=>O+P.width,0)+((y==null?void 0:y.width)??0),R=Math.min(30,w.length>1?(v-k)/w.length:0);let B=0;w.forEach(O=>{O.position.set(B,O.height*.5),B+=O.width+R}),y&&(u.addChild(y),y.position.set(u.width,y.height*.2)),u.position.set(b*.5-u.width*.5+15,l.position.y+l.height),M()}}else if(r.position.set(0,0),c.position.set(2+r.position.x+r.width,0),l.position.set(2+c.position.x+c.width,0),u){const v=m-20,w=u.children,k=w.reduce((O,P)=>O+P.height,0)+((y==null?void 0:y.height)??0),R=Math.min(30,w.length>1?(v-k)/w.length:0);let B=0;w.forEach(O=>{O.position.set(O.width*.5,B),B+=O.height+R}),y&&(u.addChild(y),y.position.set(y.width*.35,u.height-10)),u.position.set(l.position.x+l.width,m*.5-u.height*.5+20),M(!0)}};return{view:e,show:I,hide:E,resize:N,update:()=>{!s&&!t.isAutoTrading()||(s=!1,e.alpha!==0&&(I(),N(innerWidth,innerHeight)))}}},Vn=o=>{const{viewModel:t}=o,e=new $,i=[],n=new $;e.addChild(n),n.label="icons-container",e.visible=t.isVisible();const s=new Z;s.rect(0,0,innerWidth,64),s.fill("black"),s.alpha=0,e.addChild(s);const d=[],r=()=>{n.removeChildren(),n.destroy({children:!0}),s.destroy(),e.removeChildren(),e.destroy({children:!0}),d.forEach(A=>A.kill())},l=A=>{const b=new $;b.label=`${A}-icon`,b.eventMode="static";const m=new Z;m.circle(0,0,32),m.stroke({color:"khaki",width:4}),m.fill("khaki"),m.alpha=.5,b.addChild(m);const C=G.from(`${A}-icon.png`);return C.anchor.set(.5),C.width=32,C.height=32,i.push(b),b.addChild(C),n.addChild(b),b},c=l("city-key");c.on("pointertap",()=>{const A=t.canUnlockSettlement();A&&(J.play("audio/sfx/sfx-unlock.wav"),L.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:A,action:"unlock"}))});const h=l("talk");h.on("pointertap",()=>{J.play("audio/sfx/click.wav"),L.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:t.canInteractWithCharacter()??void 0,action:"talk"})}),h.visible=t.canInteractWithCharacter()!==null;const a=l("trade");a.on("pointertap",()=>{const A=t.canTradeWithCharacter();if(A){L.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:A,action:"trade"});return}const b=t.canTradeWithSettlement();b&&(J.play("audio/sfx/click.wav"),L.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:b,action:"trade"}))}),a.visible=t.canTradeWithCharacter()!==null||t.canTradeWithSettlement()!==null;const f=l("settlement");f.on("pointertap",()=>{const A=t.canVisitSettlement();A&&(J.play("audio/sfx/click.wav"),L.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:A,action:"trade"}))});const p=l("attack");p.on("pointertap",()=>{const A=t.canAttackCharacter();A&&L.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:A,action:"attack"})});const u=l("ranged-attack");u.on("pointertap",()=>{const A=t.canRangedAttackCharacter();A&&L.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:A,action:"attack"})});const y=l("loot");y.on("pointertap",()=>{const A=t.canLoot();A&&L.emit("ON_INVENTORY_REQUEST",{inventory:A,action:"open"})});const g=l("search");g.on("pointertap",()=>{const A=t.canSearch();A&&L.emit("ON_EVENT_INTERACTION",{eventViewModel:A})});const x=l("rest");x.on("pointertap",()=>{t.canRestAtSettlement()&&(J.play("audio/sfx/click.wav"),L.emit("ON_LEVEL_COMPLETED"))});const T=()=>{let b=0;i.filter(m=>m.visible).forEach((m,C)=>{m.x=C*(m.width+16),m.y=(e.height-m.height)/2,b=C}),n.x=32+(innerWidth-(b+1)*(i[0].width+16))/2},I=async A=>{A.scale.set(0),A.alpha=0,A.visible=!0;const b=1,m=1.15,C=500,v=C*.7,w=C*.3;d.push(X.to(A,{alpha:1,duration:C/1e3,ease:"power1.inOut",onUpdate:()=>{T()}}));const k=X.to(A.scale,{x:m,y:m,duration:v/1e3,ease:"power1.inOut"});d.push(k),await k,d.push(X.to(A.scale,{x:b,y:b,duration:w/1e3,ease:"power1.inOut"}))},M=(A,b)=>{s.clear(),s.rect(0,0,A,64),s.fill("black"),s.alpha=0,T()},E=(A,b)=>{!A.visible&&b()?(A.visible=!0,I(A)):A.visible=b()!==null},N=()=>{e.visible=t.isVisible(),E(h,()=>t.canInteractWithCharacter()),E(a,()=>t.canTradeWithCharacter()||t.canTradeWithSettlement()),E(f,()=>t.canVisitSettlement()),E(p,()=>t.canAttackCharacter()),E(u,()=>t.canRangedAttackCharacter()),E(y,()=>t.canLoot()),E(g,()=>t.canSearch()),E(c,()=>t.canUnlockSettlement()),E(x,()=>t.canRestAtSettlement()),T()};return rt(()=>{at(()=>{N()})},e),{view:e,resize:M,destroy:r}},Bn=o=>{let t=[];const e=new $;e.label="grid-container";const i=()=>{const r=innerWidth<innerHeight,l=30,c=r?(innerWidth-40)/2:innerWidth-15,h=12,a=l+10;t.forEach((f,p)=>{const u=Math.floor(p/(r?2:1)),y=p%(r?2:1);f.icon.position.set(y*c,u*(f.icon.height+h)),f.stats.position.set(f.icon.x+l*.5+a,f.icon.y+(f.icon.height-f.stats.height)/2),f.stats.scale.set(1);const g=c-a-10;f.stats.width>g&&(f.stats.width=g)}),d()},n=r=>{const{icon:l,stats:c}=r,h=Math.floor(t.length/(innerWidth<innerHeight?2:1)),a=t.length%(innerWidth<innerHeight?2:1);t.push({icon:l,stats:c,row:h,column:a}),i()},s=()=>{t=[],e.removeChildren()},d=()=>{e.removeChildren(),t.forEach(r=>{const l=new Z;l.roundRect(r.icon.x-5,r.icon.y-5,r.icon.width+10,r.icon.height+10,5),l.fill("khaki"),l.stroke(16777215),l.alpha=.5,l.label="icon-background",e.addChild(l,r.icon,r.stats)})};return i(),{gridContainer:e,addDataToGrid:n,resize:i,renderGrid:d,clearDataFromGrid:s}},He=(o,t)=>{const e=new $,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},n=new Et,s=new Z;n.text=o,n.style=i;const d=()=>{s.clear(),s.roundRect(n.x-10,n.y,n.width+20,n.height,10),s.fill("black"),s.alpha=.5};e.addChild(s,n);const r=l=>{n.text=l,d()};return d(),{view:e,updateText:r}},Ln=()=>{const o=document.createElement("canvas");o.width=256,o.height=1;const t=o.getContext("2d"),e=t.createLinearGradient(0,0,o.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,o.width,1),Ge.from(o)},On=o=>{const{playerUiVM:t}=o,e=40,i=10;let n;const s=q=>{n&&(r.removeChild(n),n.destroy(),n=void 0),L.emit("ON_PAUSE_INPUT"),n=le({title:q.title,content:q.content,type:q.type,contentStyle:q.contentStyle??d,onClose:()=>{q.onClose&&q.onClose(),n&&(r.removeChild(n),n.destroy(),n=void 0)},onConfirm:q.onConfirm,onCancel:()=>{L.emit("ON_RESUME_INPUT")}}),r.addChild(n),n.position.set(r.width*.5-n.width*.25,r.height/2)},d={fontSize:20,fill:"white",fontFamily:"alagard",align:"center"},r=new $;r.label="player-ui-view";const l=Bn(),c=(q,S,H,Y,Q)=>{const et=new $,mt=new Z,It=1;mt.rect(0,0,200,20),mt.fill(0),mt.stroke(16777215);const Mt=190/S,W=new Z;for(let z=q>S?S-1:q-1;z>=0;z--)W.rect(5+z*Mt,5,Mt-It,10),z>=q-4?W.fill(H):z>=q-7&&Q?W.fill(Q):W.fill(Y);return et.addChild(mt,W),et},h=()=>{r.visible=!0},a=()=>{r.visible=!1},f=G.from("health-icon.png");f.label="health-icon",f.anchor.set(.5),f.width=e,f.height=e;const p=G.from("torch-icon.png");p.label="torch-icon",p.anchor.set(.5),p.scale.set(.1);const u=He(`$ ${t.inventoryValue().toString()}`,{fill:"gold",fontSize:20}),y=G.from("coin.png");y.label="inventory-value-icon",y.anchor.set(.5),y.width=e,y.height=e,y.eventMode="static",u.view.eventMode="static",y.onpointertap=u.view.onpointertap=()=>{s({title:"Inventory Value",content:"The total value of all your inventory items.",type:`${t.inventoryValue()}`,contentStyle:d})};const g=G.from("armour-icon.png");g.label="armour-icon",g.anchor.set(.5),g.width=e,g.height=e;const x=ut({spriteName:"base-portrait",onClick:()=>{L.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})},onClickAudio:""}),T=ut({spriteName:"menu-icon",onClick:()=>{L.emit("ON_IN_GAME_MENU_REQUEST",{action:"open"})}}),I=ut({spriteName:"min-icon",onClick:()=>{L.emit("ON_IN_GAME_MENU_REQUEST",{action:"close"})},onClickAudio:"deselect"}),M=ut({spriteName:"save-icon",onClick:()=>{N.updateText("Saving..."),L.emit("ON_SAVE_REQUEST")}}),E=ut({spriteName:"load-icon",onClick:()=>{N.updateText("Loading..."),L.emit("ON_LOAD_REQUEST")}}),N=He("Game Paused"),A=()=>{T.visible=!1,N.view.visible=!0,I.visible=!0,M.visible=!0,E.visible=!0},b=()=>{T.visible=!0,N.updateText("Game Paused"),N.view.visible=!1,I.visible=!1,M.visible=!1,E.visible=!1};r.addChild(p,f,y,u.view,x,l.gridContainer,g,T,I,M,N.view,E);let m=null,C=null,v=null,w=null,k=null,R=null,B=null;const O=()=>{if(v&&r.removeChild(v),t.maxArmour()<=0||t.armour()<=0){v=null;return}v=c(t.armour(),t.maxArmour(),"blue","blue"),v.position.set(f.width+i,f.y-v.height*.5),v.label="armour-bar",r.addChild(v)},P=()=>{m&&r.removeChild(m),m=c(t.health(),t.maxHealth(),"red","red"),m.label="health-bar",m.position.set(f.width+i,f.y-m.height*.5),r.addChild(m),f.eventMode="static",m.eventMode="static",f.onpointertap=m.onpointertap=()=>{s({title:"Health",content:`You have ${t.health()} health points.`,type:`Max Health: ${t.maxHealth()}`})}},_=q=>{const S=new $,H=20;S.label="stat-container";let Y=0;if(Object.entries(q).forEach(([et,mt],It)=>{It!==0&&(Y+=S.width),Array(mt()).fill(0).forEach((Mt,W)=>{const z=G.from(et+".png");z.width=H,z.height=H,z.position.set(Y+W*H*.5,0),S.addChildAt(z,0)})}),S.width===0)return S;const Q=new G(Ln());return Q.x=S.x-5,Q.y=S.y-5,Q.width=S.width+64,Q.height=S.height+10,Q.label="row-gradient-background",S.addChildAt(Q,0),S},V=()=>{const q=t.weapon();w?w.removeChildren():(w=new $,w.label="weapon-icon",r.addChild(w));const S=G.from(q.code()+".png");S.width=e,S.height=e;const H=_({"damage-icon":()=>q.damage(),"range-icon":()=>q.range()});return S.eventMode="static",H.eventMode="static",S.onpointertap=w.onpointertap=()=>{s({title:"Weapon",content:`You have ${q.name()} equipped.`,type:`Damage: ${q.damage()}, Range: ${q.range()}`})},{icon:S,stats:H}},U=()=>{const q=t.bodyArmour();k?k.removeChildren():(k=new $,k.label="armour-icon",r.addChild(k));const S=G.from(q.code()+".png");S.width=e,S.height=e;const H=_({"armour-icon":()=>q.armour()});return S.eventMode="static",H.eventMode="static",S.onpointertap=g.onpointertap=()=>{s({title:"Body",content:`${q.armour()===0?"Not protected":`Wearing ${q.name()}`}`,type:`Armour: ${q.armour()}`})},{icon:S,stats:H}},D=()=>{const q=()=>{s({title:"Head",content:`${t.headArmour().armour()===0?"Not protected":`Wearing ${t.headArmour().name()}`}`,type:`Armour: ${t.headArmour().armour()}`})},S=t.headArmour();R?R.removeChildren():(R=new $,R.label="head-armour-icon",r.addChild(R));const H=S.code()==="head"?"base-portrait":S.code(),Y=G.from(H+".png");Y.width=e,Y.height=e;const Q=_({"armour-icon":()=>S.armour()});return Y.eventMode="static",Q.eventMode="static",Y.onpointertap=g.onpointertap=()=>{q()},{icon:Y,stats:Q}},K=()=>{const q=t.feetArmour();B?B.removeChildren():(B=new $,B.label="feet-armour-icon",r.addChild(B));const S=G.from(q.code()+".png");S.width=e,S.height=e;const H=_({"armour-icon":()=>q.armour()});return S.eventMode="static",H.eventMode="static",S.onpointertap=g.onpointertap=()=>{s({title:"Feet",content:`${q.armour()===0?"Not protected":`Wearing ${q.name()}`}`,type:`Armour: ${q.armour()}`})},{icon:S,stats:H}},st=()=>{s({title:"Torch",content:`You have ${t.torchLeft()} torches left.`,type:"Light",contentStyle:d})},nt=()=>{C&&r.removeChild(C),C=c(t.torchLeft(),30,"red","brown","khaki"),C.label="torch-bar",m&&C.position.set(m.x,p.y-7),r.addChild(C),p.eventMode="static",C.eventMode="static",p.onpointertap=C.onpointertap=()=>{st()}},dt=()=>{f.position.set(10,10),g.position.set(10,10),m&&(m.position.set(f.width+i,f.y-m.height*.5),u.view.position.set(m.x,y.y-u.view.height*.5),v&&v.position.set(m.x,m.y)),C&&m&&C.position.set(m.x,p.y-7),p.position.set(10,f.height+15),y.position.set(10,p.y+p.height),l.resize(),l.gridContainer.position.set(0,y.y+y.height*.5+10),x.position.set(innerWidth-(x.width+32),20),T.position.set(innerWidth-(T.width+32),x.y+x.height+10),I.position.set(T.x,T.y),M.position.set(T.x,T.y+T.height+10),E.position.set(T.x,M.y+M.height+10),N.view.position.set(innerWidth/2-N.view.width/2,innerHeight/2-20),n&&n.position.set(innerWidth/2-n.width/2,innerHeight/2-n.height/2),r.position.set(20,20)};return b(),dt(),rt(()=>{at(()=>{P(),O(),t.torchLeft()>=0&&nt(),t.isSaveCompleted()?N.updateText("Save completed"):N.updateText("Game Paused"),g.visible=t.maxArmour()>0&&t.armour()>0,t.isInGameMenuVisible()?A():b(),t.isInventoryValueVisible()?(y.visible=!0,T.visible=!1,u.view.visible=!0,l.gridContainer.visible=!0,l.clearDataFromGrid(),l.addDataToGrid(D()),l.addDataToGrid(V()),l.addDataToGrid(U()),l.addDataToGrid(K())):(y.visible=!1,I.visible||(T.visible=!0),u.view.visible=!1,l.gridContainer.visible=!1),u.updateText(`$ ${t.inventoryValue().toString()}`),dt()})},r),{view:r,show:h,hide:a,resize:dt}},Wn=o=>{const{viewModel:t}=o,e=new $;e.label="new-trade-view";const i=new Z;i.label="new-trade-view-background",e.addChild(i);const n=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let s=!1;const d=({title:g,stacks:x,width:T,height:I,playerStacks:M,npcInv:E=!1,includeItemValue:N=!1,isTradeInv:A=!1})=>{const b=new $;b.label=`${g}-screen-view`;const m=Zt({text:g,onClick:()=>{}});m.label=`${g}-title-button`;const C=new de({width:T,height:I,padding:4,elementsMargin:2});C.label=`${g}-inventory-view`;const v=new Z;v.label=`${g}-background`,b.addChild(v,m,C);const w=(k,R,B)=>{k.forEach(O=>{const P=zt({viewModel:O.item,includeItemValue:N,itemValue:t.getItemPrice(O.item,B),quantity:O.quantity}),V=qt(P,R==="buy"||R==="buy-return"?"pink":"lightblue"),U=new $;P.view.off("pointertap"),U.on("pointertap",()=>{D(),L.emit("ON_ITEM_INTERACTION",{itemViewModel:O.item,action:R}),s=!0}),U.addChild(V.container,P.view),U.label=`${P.view.label}-container`,C.addItem(U);const D=()=>{U.tint=65280,setTimeout(()=>{U.tint=16777215},200)}})};return E?w(x,"buy",!0):A?(w(M||[],"sell-return",!1),w(x,"buy-return",!0)):w(x,"sell",!1),m.scale.set(.4),m.position.set(T*.5,m.height*.5),C.position.set(T*.5-C.width*.5,m.height+10),v.rect(0,0,b.width,b.height),v.fill("black"),v.stroke("black"),b};let r=null,l=null,c=null,h=null,a=null;const f=()=>{r?p():J.play("audio/sfx/door.mp3");const{innerWidth:g,innerHeight:x}=window,T=x>g,I=T?g:g*.35,M=T?x*.35:x;n(),c=Zt({text:"Continue",onClick:()=>{c.eventMode="none",L.emit("ON_TRADE_REQUEST",{action:"confirm-bulk-trade"}),X.delayedCall(.5,()=>{L.emit("ON_CLOSE_INVENTORY_REQUESTED")}),s=!0}}),c.alpha=0,c.label="continue-button";let E="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?E="green":t.value().quantity()>0?E="yellow":E="red");const N=zt({viewModel:t.value()});a=qt(N,E).container,h=new $,h.label="trade-buttons-container",h.addChild(c,a),c.scale.set(.4),e.addChild(h),r=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:I,height:M,includeItemValue:!0,isTradeInv:!1}),e.addChild(r),r.label="player-trade-screen",l=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:I,height:M,includeItemValue:!0,isTradeInv:!0}),e.addChild(l),l.label="trade-screen",c&&(c.alpha=t.isContinueButtonVisible()?1:0),e.visible=!0},p=()=>{r&&(e.removeChild(r),r.destroy(),r=null),l&&(e.removeChild(l),l.destroy(),l=null),c&&(e.removeChild(c),c.destroy(),c=null),h&&(e.removeChild(h),h.destroy(),h=null),a&&(e.removeChild(a),a.destroy(),a=null),e.visible=!1},u=(g,x)=>{if(!e.visible||!r||!l)return;x>g?(r.position.set(0,0),l.position.set(0,r.y+r.height+2),a&&c&&(a.position.set(-a.width*.5,-a.height*.5),c.position.set(a.x+a.width+c.width*.5,0)),h&&h.position.set(g*.5-h.width*.5,l.position.y+l.height+h.height*.5+10)):(r.position.set(0,0),l.position.set(2+r.position.x+r.width,0),a&&c&&(a.position.set(0,0),c.position.set(20,a.y+a.height+30)),h&&h.position.set(l.position.x+l.width+h.width*.5,x*.5-h.height*.5))};return{view:e,show:f,hide:p,resize:u,update:()=>{c&&(c&&(c.alpha=t.isContinueButtonVisible()?1:0),c.alpha===1&&!s)||!s&&!t.isAutoTrading()||(s=!1,e.visible&&(f(),u(innerWidth,innerHeight)))}}},Dn=o=>{const t=o.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2");return t.charAt(0).toUpperCase()+t.slice(1)},Hn=o=>{const t=pt().log;let e=[],i=!0;const n=new $;n.label="log-view",n.alpha=0;const s=new $;s.label="log-grid-layout",n.addChild(s);const d=new Z;s.addChild(d);const r=()=>{if(e.length>0){e.forEach(y=>y()),e=[];return}u()},l=async y=>{var A;const g=s.children.length,x=innerWidth/2-20,T=new Et,I=y.name.toLowerCase().includes("value");T.style={fontFamily:"alagard",fontSize:20,fill:"black"},T.text=Dn(y.name),T.position.set(10,g*15);const M=new $;M.label="log-value-container",M.position.set(x+(innerWidth<innerHeight?100:0),T.y);const E=new Et;E.style={fontFamily:"alagard",fontSize:18,fill:"black"},E.text=I?"$":"",E.text+=y.value??((A=y.to)==null?void 0:A.toString())??"",M.addChild(E),s.addChild(T),s.addChild(M),T.alpha=0,M.alpha=0,!await new Promise(b=>{X.delayedCall(y.index*.5,()=>{i||b(!0),e.shift(),b(!1)}),e.push(()=>b(!0))})&&i&&J.play("audio/sfx/sfx-thud.mp3"),T.alpha=1,M.alpha=1};Object.entries(t).sort((y,g)=>y.toLocaleString().localeCompare(g.toLocaleString())).forEach(([y,g],x)=>{l(typeof g=="string"?{name:y,value:g,index:x}:{name:y,to:g,index:x})});const c=5;d.roundRect(-5,-5,s.width+30+c*2,s.height+30+c*2,30),d.fill("khaki"),n.eventMode="static",n.on("pointertap",()=>{r()});const h=new Et;h.text="Tap to continue",h.style={fontFamily:"alagard",fontSize:20,fill:"white"};const a=innerHeight>innerWidth;h.position.set(a?(n.width-h.width)*.5:n.width+40,a?n.height+20:n.height*.5),n.addChild(h);const f=()=>{i=!0,n.visible=!0,n.alpha=0,X.to(n,{alpha:1,duration:.5,ease:"power2.out"})},p=()=>{i=!1},u=()=>{i=!1,X.to(n,{alpha:0,duration:.5,ease:"power2.in",onComplete:()=>{n.visible=!1,o()}})};return{view:n,destroy:p,show:f,hide:u,handleAnyPress:r}},Un=o=>{const t=new $,{playerMenuVM:e}=o;let i=null,n=null,s=null,d=null,r=null,l=null,c=0;const h=new Z;h.label="background",h.alpha=0,h.on("pointertap",()=>{l==null||l.handleAnyPress()}),t.addChild(h);const a=()=>{h.clear(),h.rect(0,0,innerWidth,innerHeight),h.fill("black")},f=()=>{A(),E(),h.alpha=0},p=()=>{d&&(d.view.visible=!1),h.alpha=0},u=()=>{p(),T(),y(),h.alpha=1,l=Hn(()=>{y(),L.emit("ON_LEVEL_COMPLETED")});const v=Math.min(1,Math.min(innerWidth/l.view.width,innerHeight/l.view.height));l.view.scale.set(v),l.view.position.set(innerWidth*.5-l.view.width*.5,innerHeight*.5-l.view.height*.5),t.addChild(l.view),l.show(),h.eventMode="static"},y=()=>{h.eventMode="none",l&&(l.destroy(),t.removeChild(l.view),l.view.destroy({children:!0}),l=null)},g=()=>{const v=o.playerUiVM();if(!v)return;if(d){d.view.position.set(30,30),d.view.visible=!0;return}d=On({playerUiVM:v});const w=Math.min(1,Math.min(innerWidth/d.view.width,innerHeight/d.view.height));d.view.scale.set(w),d.view.position.set(30,30),c=t.children.length,t.addChild(d.view),d.view.visible=!0,d.view.label="player-ui-view"},x=()=>{const v=e();if(!v)return;n||(n=Vn({viewModel:v}),t.addChild(n.view));const w=Math.min(1,Math.min(innerWidth/n.view.width,innerHeight/n.view.height));n.view.scale.set(w),n.view.position.set(innerWidth*.5-n.view.width*.5,innerHeight*.9-n.view.height*.5),n.view.visible=!0},T=()=>{n&&(n.view.visible=!1),h.alpha=0},I=v=>{E(),T(),p(),h.alpha=1,s=Wn({viewModel:v}),t.addChild(s.view),s.show()},M=v=>{E(),T(),p(),h.alpha=1,s=Rn({viewModel:v}),t.addChild(s.view),s.show(),b(innerWidth,innerHeight)},E=()=>{x(),g(),s&&(t.removeChild(s.view),s.view.destroy(),s=null),h.alpha=0,b(innerWidth,innerHeight)},N=v=>{if(T(),h.alpha=1,r&&!v)v=r;else if(!v)throw new Error("No inventory provided to showInventory");r=v,setTimeout(()=>{i=Nn(v),i.show(),t.addChildAt(i.view,c),b(innerWidth,innerHeight)},10)},A=(v=!0)=>{x(),i&&(t.removeChild(i.view),i.view.destroy(),i=null),v&&(r=null),h.alpha=0},b=(v,w,k=!1)=>{a();const R=w>v;if(s){s.show(),s.resize(v,w);const B=R?Math.min(1,w/s.view.height):Math.min(1,v/s.view.width);s.view.scale.set(B);const O=R?(t.width-s.view.width)*.5:0,P=R?0:(t.height-s.view.height)*.5;s.view.position.set(O,P)}if(n&&(n.resize(v,w),n.view.position.set(v*.5-n.view.width*.5,w*.9-n.view.height*.5)),d&&d.resize(),l&&u(),i&&d){if(k){A(!1),N();return}const B=R?(v-i.view.width)*.5:d.view.width*.5,O=R?d.view.y+d.view.height+10:(w-i.view.height)*.5;i.view.position.set(B,O)}},m=()=>{s==null||s.update()};return t.label="user-interface-view",a(),{showInventory:N,hideInventory:A,showTrade:M,hideTrade:E,showBulkTrade:I,view:t,closeAll:f,showPlayerMenu:x,hidePlayerMenu:T,showPlayerUi:g,resize:b,destroy:()=>{t.removeChildren(),h.destroy(),i=null,n==null||n.destroy(),n=null,s=null,d=null},update:m,showEndOfLevelLog:u,hideEndOfLevelLog:y}},$n=()=>{const o=ae.map(e=>(e.code()==="torch"&&e.updateQuantity(11),Tt(e.code()))),t=Xt(o);return kt({model:t,ownerName:"Global Inventory"})},zn=o=>{const{playerVM:t,tileMapVM:e}=o,i=(r,l)=>{const c=t.position().x+r,h=t.position().y+l;if(c<=0&&c>=e.tiles().length-1&&h<=0&&h>=e.tiles()[0].length-1)return;const a=e.tiles()[c][h];a&&L.emit("ON_TILE_INTERACTION",{tileViewModel:a})},n=r=>{switch(r){case"endLevel":L.emit("ON_LEVEL_COMPLETED");break;case"showInventory":L.emit("ON_INVENTORY_REQUEST",{inventory:$n(),action:"open"});break;case"showCharacterDetails":console.debug("Showing character details");break;case"moveLeft":i(-1,0);break;case"moveRight":i(1,0);break;case"moveUp":i(0,-1);break;case"moveDown":i(0,1);break;default:console.warn(`Unknown action: ${r}`)}},s=r=>{switch(r.key){case"r":L.emit("ON_DEBUG_ACTION_REQUESTED",{action:"endLevel"});break;case"i":L.emit("ON_DEBUG_ACTION_REQUESTED",{action:"showInventory"});break;case"w":L.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveUp"});break;case"s":L.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveDown"});break;case"a":L.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveLeft"});break;case"d":L.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveRight"});break;case"6":L.emit("ON_SAVE_REQUEST");break;case"8":L.emit("ON_LOAD_REQUEST");break}};return document.addEventListener("keypress",s),{handleDebugActionRequest:n,destroy:()=>{document.removeEventListener("keypress",s)}}};function qn(o){const t=[];let e=o;for(;e;)t.unshift(e.tile),e=e.previous;return t}function Ft({start:o,end:t,map:e,maxDistance:i=7}){const n=e.tiles().flat().find(a=>a.position().x===o.x&&a.position().y===o.y),s=e.tiles().flat().find(a=>a.position().x===t.x&&a.position().y===t.y);if(!n||!s)return null;const d=Math.sqrt(Math.pow(s.position().x-n.position().x,2)+Math.pow(s.position().y-n.position().y,2)),r={previous:null,tile:n,g:0},l=a=>{let f=!1,p=a.previous;for(;p;){if(p.tile.position().x===a.tile.position().x&&p.tile.position().y===a.tile.position().y){f=!0;break}p=p.previous}return f},c=[],h=a=>{if(a.tile.position().x===s.position().x&&a.tile.position().y===s.position().y){c.push(a);return}if(a.g>i||a.g>d)return;const f=e.getNeighbors(a.tile),p=a.tile.position();for(const u of f){if(!u.traversable()&&s.traversable())continue;const y=u.position(),g=Math.abs(y.x-p.x),x=Math.abs(y.y-p.y),T=g===1&&x===1?2:1,I=a.g+T;if(I>i)continue;const M={previous:a,tile:u,g:I};l(M)||h(M)}};if(h(r),c.length>0){const a=c.reduce((p,u)=>p.g<u.g?p:u),f=qn(a);if(f.length>0)return f.shift(),f}return[]}const Gn={"bed-time":["follow"],patrol:["bed-time","follow","work"],follow:["attack"],work:["bed-time","patrol","follow"],idle:["bed-time","patrol","follow","work"],attack:["bed-time","patrol","follow","work"],spawn:["bed-time","patrol","follow","work","attack"]},Fn=o=>{const{events:t,playerVM:e,tileMapVM:i,npcTaskController:n,npcs:s,turnVM:d}=o,r=5,l=[],c=(m,C)=>{var w;const v=[];for(let k=m.x-C;k<=m.x+C;k++)for(let R=m.y-C;R<=m.y+C;R++){const B=(w=i.tiles()[k])==null?void 0:w[R];!B||Math.floor(Math.sqrt(Math.pow(B.position().x-m.x,2)+Math.pow(B.position().y-m.y,2)))>C||B.traversable()&&v.push(B.position())}return v},h=(m,C)=>{let w=5,k=null;for(;k===null||k.length===0;)if(k=Ft({start:m,end:C,map:i,maxDistance:w}),w++,w>9)return null;return k},a=m=>{const C=m.position();let v=null;const w=[];for(const k of t){const R=k.position(),B=Math.floor(Math.sqrt(Math.pow(R.x-C.x,2)+Math.pow(R.y-C.y,2)));w.push({event:k,distance:B})}w.sort((k,R)=>k.distance-R.distance);for(let k=0;k<Math.min(3,w.length);k++){const R=w[k].event,B=h(C,R.position());if(B&&B.length>0){v=R;break}}return v||null},f=m=>{m.isAlive()&&(m.setTaskList([n.createSpawnTask(m)]),m.setCanTrade(!1),l.push(m),m.getPatrolArea().length===0&&(m.setPatrolArea(c(m.position(),r)),m.setTaskList([...m.getTaskList(),n.createPatrolTask(m)])))},p=m=>{m.isAlive()&&!m.isHostile(e.team())&&(m.setTaskList([n.createWorkTask(m)]),m.setCanTrade(!0),l.push(m))},u=m=>{if(!m.isAlive()){m.setTask(null);return}if(m.isHostile(e.team())&&m.getPatrolArea().length===0&&(m.setPatrolArea(c(m.position(),r)),m.setTaskList([...m.getTaskList(),n.createPatrolTask(m)])),m.getBedLocation()===null){const C=a(m);C&&m.setBedLocation(C.position())}l.push(m)},y=(m,C)=>{const v=m.getTask();if(!v)return!0;const w=v.name();return(Gn[w]||[]).includes(C)},g=m=>{if(!m.spawnLing())return!1;const C=4;if(m.lastSpawned()===0)return m.setLastSpawned(d.getCurrentTurn()),!1;const v=d.getCurrentTurn()-m.lastSpawned()>=C;if(!v)return!1;if(v){const w=n.createSpawnTask(m);if(w)return m.setTask(w),m.setLastSpawned(d.getCurrentTurn()),!0}return!1},x=m=>{if(!m.isHostile(e.team()))return!1;if(e.isAlive()&&e.position()){const w=Math.floor(Math.sqrt(Math.pow(e.position().x-m.position().x,2)+Math.pow(e.position().y-m.position().y,2)));if(w<=1)return!1;if(w<=4&&y(m,"follow")){const k=m.getTaskList().find(R=>R.name()==="follow")||n.createFollowPlayerTask(m);if(k)return m.setTarget(e),m.setTask(k),!0}}return!1},T=m=>{const C=m.getTask(),v=o.turnVM.getCurrentTimeMin();if(v>=1200||v<480){if(C&&C.name()==="bed-time")return!0;if(y(m,"bed-time")){const w=m.getTaskList().find(k=>k.name()==="bed-time")||n.createBedTimeTask(m);if(w)return m.setTask(w),!0}}return!1},I=m=>{const C=m.getTask();if(o.turnVM.getCurrentTimeMin()>=480){if(C&&C.name()==="patrol")return!0;if(y(m,"patrol")){const w=m.getTaskList().find(k=>k.name()==="patrol");if(w)return m.setTask(w),!0}}return!1},M=m=>{var k;const C=m.getTarget(),v=1;if(!C||!C.isAlive())return m.setTarget(null),!1;if(Math.floor(Math.sqrt(Math.pow(C.position().x-m.position().x,2)+Math.pow(C.position().y-m.position().y,2)))>v)return!1;if(((k=m.getTask())==null?void 0:k.name())==="attack")return!0;if(y(m,"attack")){const R=m.getTaskList().find(B=>B.name()==="attack")||n.createAttackTask(m);if(R)return m.setTask(R),!0}return!1},E=m=>{var C;if(((C=m.getTask())==null?void 0:C.name())==="work")return!0;if(y(m,"work")){const v=m.getTaskList().find(w=>w.name()==="work");if(v)return m.setTask(v),!0}return!1},N=m=>{if(!m.isAlive()){m.setTask(null);return}g(m)||M(m)||x(m)||T(m)||I(m)||E(m)},A=()=>{l.forEach(m=>{if(!m.isAlive())return;N(m);const C=m.getTask();C&&C.name(),C&&C.execute()})};return(()=>{s.forEach(m=>{u(m)})})(),{addNpc:u,addTrader:p,addNestmother:f,playNpcTurn:A}},Yn=({npc:o,attackVM:t})=>({execute:()=>{if(!o.isAlive())return!1;const e=o.getTarget();return!e||!e.isAlive()?(o.setTask(null),!0):Math.floor(Math.sqrt(Math.pow(o.position().x-e.position().x,2)+Math.pow(o.position().y-e.position().y,2)))<=1?(t.attack(o,e),!0):!1},name:()=>"attack"}),Qn=({npc:o,tileMapVM:t,turnVM:e})=>{let i=o.getBedLocation(),n=null;return{execute:()=>{if(o.isAlive()===!1)return!1;if(e.getCurrentTimeMin()>=480&&e.getCurrentTimeMin()<1200)return o.setTask(null),!0;if(!i&&(i=o.getBedLocation(),!i))return!1;if(o.position().x===i.x&&o.position().y===i.y)return!0;if(!n){let d=5;for(;n===null||n.length===0;)if(n=Ft({start:o.position(),end:i,map:t,maxDistance:d}),d++,d>8)return!1}if(n&&n.length>0){const s=n.shift();return s&&(o.moveTo(s.position().x,s.position().y),s.position().x===i.x&&s.position().y===i.y),!0}return!1},name:()=>"bed-time"}},Xn=({npc:o,tileMapVM:t,playerVM:e})=>({execute:()=>{if(o.isAlive()===!1)return!1;const i=e.position(),n=Ft({start:o.position(),end:i,map:t});if(n&&n.length>0){const s=n.shift();if(s)return s.position().x===i.x&&s.position().y===i.y||o.moveTo(s.position().x,s.position().y),!0}return!1},name:()=>"follow"}),jn=({npc:o,tileMapVM:t})=>{let e=o.getPatrolArea(),i=null;return{execute:()=>{if(o.isAlive()===!1||e.length===0||((!i||i.length===0)&&(i=Ft({start:o.position(),end:e[Math.floor(Math.random()*e.length)],map:t})),!i||i.length===0))return!1;const n=i.shift();return n&&o.moveTo(n.position().x,n.position().y),!0},name:()=>"patrol"}},Zn=({npc:o})=>({execute:()=>o.isAlive()===!1?!1:(o.setCanTrade(!0),!0),name:()=>"work"}),Kn=({npc:o,addNpc:t,spawnType:e="worm"})=>({execute:()=>{if(!o.isAlive())return!1;const i=o.position(),n=ze({id:e,team:"hostile-to-player",name:"Spawned "+e.charAt(0).toUpperCase()+e.slice(1),startingSize:1,startPosition:i,startingHealth:1,startingMaxHealth:1,startingItems:[]}),s=ti(n);return t(s),!0},name:()=>"spawn"}),Jn=o=>{const{attackVM:t,tileMapVM:e,turnVM:i,playerVM:n}=o;return{createBedTimeTask:a=>Qn({npc:a,tileMapVM:e,turnVM:i}),createPatrolTask:a=>jn({npc:a,tileMapVM:e}),createFollowPlayerTask:a=>Xn({npc:a,tileMapVM:e,playerVM:n}),createAttackTask:a=>Yn({npc:a,attackVM:t}),createWorkTask:a=>Zn({npc:a}),createSpawnTask:a=>Kn({npc:a,spawnType:"worm",addNpc:o.addNpc})}},Qt=(o,t)=>o.id()===t.id(),to=()=>({use:(o,t)=>{if(o.health()!==0){if(t.health()>=t.maxHealth())return;if(t.id()==="player"){const e=Math.min(o.health(),t.maxHealth()-t.health());pt().log.totalHealing+=e}t.setHealth(t.health()+o.health()),t.inventory().removeItem(o),o.updateQuantity(0);return}o.type()==="weapon"&&(Qt(t.weapon(),o)?t.setWeapon(void 0):t.setWeapon(o)),o.type()==="armour"&&(Qt(t.bodyArmour(),o)?t.setBodyArmour(void 0):t.setBodyArmour(o)),o.type()==="helmet"&&(Qt(t.headArmour(),o)?t.setHeadArmour(void 0):t.setHeadArmour(o)),o.type()==="shoes"&&(Qt(t.feetArmour(),o)?t.setFeetArmour(void 0):t.setFeetArmour(o))}}),eo=()=>{let o=null,t=null;const e=222,[i,n]=F(!1),[s,d]=F(!0),[r,l]=F(!1),[c,h]=F(!1),[a]=F($t({model:Tt("coin")})),f=kt({model:Xt([]),ownerName:"trade"}),p=kt({model:Xt([]),ownerName:"trade-npc"}),u=(_,V)=>{o=_,t=V,x(b()),x(A())},y=_=>{v().addItem(_,1),f.removeItem(_,1)},g=_=>{w().addItem(_,1),p.removeItem(_,1)},x=_=>{let V;_===f?V=y:V=g,_.items().forEach(U=>{V(U,!0),_.removeItem(U,1)})},T=_=>{const V=v().getItem(_);V&&(f.addItem(V,1),v().removeItem(V,1))},I=_=>{const V=w().getItem(_);V&&(p.addItem(V,1),w().removeItem(V,1))},M=()=>{x(b()),x(A()),a().updateQuantity(0)},E=(_=!1)=>{if(!o||!t)throw new Error("Player or NPC inventory is not set");return!r()&&!c()&&m()!==0?(l(!0),!1):a().quantity()<0?!1:((r()&&!c()||c()&&!r()||m()===0)&&_&&N(),r()&&l(!1),!0)},N=()=>{if(i()){const _=Math.floor(a().quantity());Array(_).fill(0).forEach(()=>{const V=$t({model:Tt("coin")});A().addItem(V)}),_>0&&J.play("audio/sfx/sfx-sell.mp3")}f.items().forEach(_=>{w().addItem(_,_.quantity()),f.removeItem(_,_.quantity())}),p.items().forEach(_=>{pt().log.tradedItemsValue+=C(_,!0),v().addItem(_,_.quantity()),p.removeItem(_,_.quantity())}),x(b()),x(A()),i()&&n(!1)},A=()=>(a().updateQuantity(m()),p),b=()=>(a().updateQuantity(m()),f),m=()=>{const _=f.stacks().reduce((U,D)=>U+C(D.item,!1)*D.quantity,0),V=p.stacks().reduce((U,D)=>U+Math.max(1,C(D.item,!0)*D.quantity),0);return Math.floor(_)-Math.ceil(V)},C=(_,V)=>{const U=_.value()*_.quantity(),K=V&&!["coin","torch"].includes(_.code())?2:1;return U*K},v=()=>{if(o)return o;throw new Error("Player inventory is not set")},w=()=>{if(t)return t;throw new Error("NPC inventory is not set")},k=async()=>{await R(!1),await X.delayedCall(.2,()=>{}),n(!1)},R=async(_=!0)=>{if(!o||!t)throw new Error("Invalid inventories to auto trade");n(!0);const V=o.stacks().reduce((U,D)=>(D.quantity>0&&D.item.type()==="loot"&&U.push(D),U),[]);for(const U of V){await X.delayedCall(e/1e3,()=>{});for(let D=0;D<U.quantity;D++)_?J.play("audio/sfx/sfx-sell.mp3",{category:"gameplay"}):J.play("audio/sfx/collect.wav",{category:"gameplay"}),T(U.item)}};return{isConfirmationModalVisible:r,startTrade:u,cancelTrade:M,acceptTrade:E,playerTradeItems:b,acceptBulkTrade:()=>{c()&&(E(!0),h(!1))},value:a,npcTradeItems:A,playerInventory:v,npcInventory:w,selectItemToBuy:I,selectItemToSell:T,returnItemToPlayer:y,returnItemToNpc:g,clearTrade:()=>{if(r()){l(!1);return}x(b()),x(A()),l(!1),a().updateQuantity(0)},getItemPrice:C,bulkTrade:async()=>{h(!0),await X.delayedCall(.5,()=>{}),d(!1),await R(),await X.delayedCall(.5,()=>{}),d(!0)},autoTrade:k,isAutoTrading:i,isContinueButtonVisible:s}},io=o=>{if(o.length===0)return{x:0,y:0};const t=o.reduce((s,d)=>s+d.x,0),e=o.reduce((s,d)=>s+d.y,0),i=t/o.length,n=e/o.length;return{x:i,y:n}},Ue=(o,t)=>Math.abs(o.x-t.x)<=1&&Math.abs(o.y-t.y)<=1,no=o=>{let t="idle",e="idle";return{get:()=>t,set:d=>{t!==d&&(e=t,d==="end-turn"?(o(),t="idle"):t=d)},getPrevState:()=>e}},oo=o=>{const{tileMapViewModel:t,playerViewModel:e,userInterfaceView:i,gameView:n,playerUiVM:s,attackVM:d}=o;let r=null,l=null;const c=no(o.onPlayerTurnCompleted),h=to(),a=1,f=()=>e.isAlive()&&c.get()!=="busy",p=v=>{const{action:w,trader:k}=v;if(!(k&&!k.canTrade())&&f()){if(c.set("trading"),k&&!l)if(l=eo(),l.startTrade(e.inventory(),k.inventory()),w==="autoTrade"){l.bulkTrade(),i.showBulkTrade(l);return}else{i.showTrade(l);return}if(l){if(w==="autoTrade"&&l.autoTrade(),w==="clear"){l.clearTrade();return}if(w==="confirm-bulk-trade"){l.acceptBulkTrade();return}w==="submit"&&l.acceptTrade(!0)}}},u=v=>{var w;if(r){r.ownerName()===e.name()&&N();return}if(!l&&f()){if(v.isEmpty()){c.set("idle"),r=null;return}if(v.isOnlyLoot()&&v.ownerName()!==e.name()){i.update(),x(v);return}c.set("inventory-handling"),r=v,i.showInventory(v),(w=s())==null||w.isInventoryValueVisible(!0)}},y=v=>{var w;c.set("busy"),(w=s())==null||w.showInGameMenu(v==="open"),v!=="open"&&c.set(c.getPrevState()||"idle")},g=(v,w)=>{f()&&(c.set("inventory-handling"),w==="open"?u(v):N())},x=v=>{v.items().forEach(w=>{var k;e.inventory().addItem(w),v.removeItem(w),(k=n())==null||k.animateIconFloat(w.code(),e.position())}),J.play("audio/sfx/inventory-open.wav",{category:"gameplay",volume:1}),r=null,c.set("end-turn")},T=v=>{var O,P;const{settlement:w,action:k}=v,R=w.positions(),B=io(R);if(f()){if(k==="unlock"){const _=e.inventory().getItemByCode("city-key");if(!_)throw new Error("City key is required to unlock the settlement");w.setIsUnlocked(!0),e.inventory().removeItem(_),(O=n())==null||O.createTextBox({id:()=>"settlement",dialogue:()=>"Welcome!",position:()=>({x:B.x,y:B.y})});return}if(k==="trade"&&w.isUnlocked()){p({action:"trade",trader:{canTrade:()=>!w.inventory().isEmpty(),inventory:()=>w.inventory()}});return}(P=n())==null||P.createTextBox({id:()=>"settlement",dialogue:()=>"City key required",position:()=>({x:B.x,y:B.y})})}},I=()=>{l&&(l.cancelTrade(),i.closeAll(),l=null),c.set("idle")},M=v=>{const{action:w,character:k}=v;if(!f()||!k)return;if(w==="talk"){const P=n();if(!P)return;P.createTextBox(k),c.set("idle");return}const R=Math.floor(Math.sqrt(Math.pow(k.position().x-e.position().x,2)+Math.pow(k.position().y-e.position().y,2))),B=R<=a,O=R<=e.weapon().range();if(k.isHostile(e.team())&&O&&k.health()>0){d.attack(e,k),c.set("end-turn");return}if(!B){A(k.position());return}if(!k.inventory().isEmpty()){if(k.canTrade()){p({action:"change-to-buy",trader:k});return}u(k.inventory());return}if(k.inventory().isEmpty()){A(k.position());return}u(k.inventory())},E=(v,w)=>{if(c.get()==="idle"&&f()){if(Ue(v.position(),e.position())&&(!v.discovered()||!v.inventory().isEmpty())){u(v.inventory()),v.interact(w);return}A(v.position())}},N=()=>{var v,w;if(r){if(r.ownerName()===e.name()){r=null,c.set("idle"),(v=s())==null||v.isInventoryValueVisible(!1),i.hideInventory();return}r=null,c.set("end-turn"),(w=s())==null||w.isInventoryValueVisible(!1),i.hideInventory();return}l&&I(),c.set("idle")},A=({x:v,y:w})=>{if(c.get()!=="idle"||!f())return;const k=e.position();if(Ue({x:v,y:w},k)&&t.isValidMove(v,w)){b(v-k.x,w-k.y);return}const R=Ft({start:k,end:{x:v,y:w},map:t});if(R&&R.length>1){const B=R[0];b(B.position().x-k.x,B.position().y-k.y)}},b=(v,w)=>{if(c.set("moving"),!f())return;const k=e.position().x+v,R=e.position().y+w;t.isValidMove(k,R)&&e.moveTo(k,R),c.set("end-turn")};return{handlePlayerMoveRequest:A,handleTileInteraction:v=>{c.get()==="idle"&&f()&&A(v.position())},handleCharacterInteraction:M,handleEventInteraction:E,handleItemInteraction:(v,w)=>{var k;if(f()){if(c.get()==="trading"){if(w==="sell"){l==null||l.selectItemToSell(v);return}if(w==="buy-return"){l==null||l.returnItemToNpc(v);return}if(w==="sell-return"){l==null||l.returnItemToPlayer(v);return}if(w==="buy"){l==null||l.selectItemToBuy(v);return}}if(r&&r.ownerName()!==e.name()){e.inventory().addItem(v),r.removeItem(v),(k=n())==null||k.animateIconFloat(v.code(),e.position());return}h.use(v,e)}},handleCloseInventoryRequest:N,handleTradeRequest:p,handleTradeCancel:I,handleSettlementInteraction:T,handleInventoryRequest:g,handleInGameMenuRequest:y}},so=o=>{const{turnVM:t,handleEndUpTurnUpdates:e,playerVM:i,enemyVMs:n,npcController:s}=o;let d=0;const r=()=>{var f;const a=pt().log;a.turns+=1,a.npcsKilled=n.filter(p=>!p.isAlive()).length,a.npcsAlive=n.filter(p=>p.isAlive()).length,a.mostUsedWeapon=((f=i.inventory().items().filter(p=>p.type()==="weapon").sort((p,u)=>u.uses()-p.uses())[0])==null?void 0:f.name())||"fists"},l=async()=>{h(),await e(),t.nextTurn(),c(),r()},c=async()=>{if(d+=1,d%10===0){const a=i.inventory().getItemByCode("torch");a&&i.inventory().removeItem(a)}},h=()=>{s.playNpcTurn()};return{handlePlayerTurnEnded:l,playNpcTurn:h}},ro=()=>{const[o,t]=F(void 0);return{attack:async(e,i)=>{const n=e.weapon().range()>2,s=e.weapon().range()<=2,r=e.position().distanceTo(i.position())>1,c=e.weapon().damage();s||r&&n?i.takeDamage(c):!r&&n&&i.takeDamage(Math.min(1,Math.floor(c/2))),t({source:e,target:i,type:n&&r?"ranged":"melee"});const h=pt().log;e.id()==="player"&&(h.totalDamageDealt+=c,e.weapon().setUses(e.weapon().uses()+1),s||r&&n?s?pt().log.meleeAttacks+=1:pt().log.rangedAttacks+=1:!r&&n&&(pt().log.meleeAttacks+=1))},isAttacking:()=>o(),clearAttack:()=>{t(void 0)}}};X.registerPlugin(ce);ce.registerPIXI(li);const ao=o=>o<=3?1:o<=6?2:o<=10?3:o<=15?4:5,lo=({view:o,saveController:t,onGameLoadRequest:e,onLevelCompleted:i,onGameOver:n})=>{const[d,r]=F(he({model:$e({id:"dontUse",team:"player",name:"Player",startPosition:{x:0,y:0},startingHealth:10,startingMaxHealth:10,startingItems:[]})}));let l=null,c=null,h=null,a=null,f=null,p=null,u=null,y=null,g=null,x=null,T=null,I=[],M=[],E=null,N=[],A=1,b=null,m=null,C=null,v=!1,w=!1,k={x:0,y:0};const R=()=>{if(!b)throw new Error("Level models are not initialized");return b},B=S=>{b=S;const H=Wi(S);T=H.tileMapVM,r(H.playerVM),I=H.npcVMs,M=H.eventVMs,N=H.settlementVMs;const Y=ro();f=qi({playerVM:d()}),p=S.fogOfWarViewModel,l=zi({playerVM:d(),npcVMs:I,settlementVMs:N,eventViewModels:M}),u=Un({playerMenuVM:()=>l,playerUiVM:()=>f}),y=Di({model:Ri()}),a=Jn({tileMapVM:T,playerVM:d(),turnVM:y,attackVM:Y,addNpc:et=>{m==null||m.addNpc(et),h==null||h.addNpc(et)}}),h=Fn({playerVM:d(),npcs:I,tileMapVM:T,events:M,npcTaskController:a,turnVM:y}),g=so({turnVM:y,playerVM:d(),enemyVMs:I,npcController:h,handleEndUpTurnUpdates:async()=>{await(m==null?void 0:m.handleEndOfTurnUpdates())}});const Q=()=>{d().inventory().getItemByCode("torch")?p==null||p.setToFullLight():p==null||p.setToLowLight()};c=oo({attackVM:Y,tileMapViewModel:T,playerViewModel:d(),userInterfaceView:u,playerUiVM:()=>f,onPlayerTurnCompleted:()=>{g==null||g.handlePlayerTurnEnded(),Q()},gameView:()=>m}),m=nn({tileSize:64,playerVM:d(),tileMapVM:T,npcVMs:I,eventVMs:M,settlementVMs:N,attackVM:Y}),x=Fi({gameViews:{gameView:m.view,nonSkewedView:m.nonSkewedContainer},userInterfaceView:u.view,fogOfWarVM:p}),E=zn({playerVM:d(),tileMapVM:T})},O=()=>{console.debug("Unloading level..."),C==null||C.destroy(),x==null||x.destroy(),l=null,c=null,h=null,a=null,f=null,p=null,o.detachAll(),u==null||u.destroy(),u=null,y=null,g=null,x=null,T=null,I=[],M=[],E==null||E.destroy(),E=null,N=[],b=null,m==null||m.destroy()},P=()=>{const S=I.filter(Q=>Q.isAlive()),H=I.length-S.length,Y=d().position();Y&&(A>=ao(H)||(A++,S.forEach(Q=>{Q.position().distanceTo(Y)<5||Q.setMaxHealth(Q.maxHealth()+2)})))},_=()=>{const S=d().position(),H=5;S&&(T==null||T.tiles().forEach(Y=>{Y.forEach(Q=>{Q.setVisible(Math.abs(Q.position().x-S.x)<=H&&Math.abs(Q.position().y-S.y)<=H)})}),M.forEach(Y=>{Y.setVisible(Math.abs(Y.position().x-S.x)<=H&&Math.abs(Y.position().y-S.y)<=H)}),I.forEach(Y=>{Y.setVisible(Math.abs(Y.position().x-S.x)<=H&&Math.abs(Y.position().y-S.y)<=H)}),N.forEach(Y=>{Y.setIsVisible(Math.abs(Y.positions()[0].x-S.x)<=H&&Math.abs(Y.positions()[0].y-S.y)<=H)}))},V=async()=>{if(!v&&!w){v=!0,c==null||c.handleTradeRequest({action:"autoTrade",trader:{canTrade:()=>!0,inventory:()=>kt({model:Xt([]),ownerName:"Bulk Trader"})}});return}if(v=!1,!w){w=!0,u==null||u.showEndOfLevelLog();return}i(b),await U()},U=async()=>{!x||!u||(J.disableCategory("gameplay"),u.view.visible=!1,await X.to(x.view,{duration:5,alpha:0}),x.view.visible=!1,K(),O())},D=()=>{C=Ni({handleLevelCompleted:V,handleTileInteraction:S=>{c==null||c.handleTileInteraction(S)},handleItemInteraction:(S,H)=>{c==null||c.handleItemInteraction(S,H)},handleEventInteraction:S=>{c==null||c.handleEventInteraction(S,d())},handleCharacterInteraction:S=>{c==null||c.handleCharacterInteraction({character:S,action:"interact"})},onCloseInventoryRequested:()=>{c==null||c.handleCloseInventoryRequest(),v&&V()},handleInventoryRequest:(S,H)=>{c==null||c.handleInventoryRequest(S,H)},handleTradeRequest:S=>{c==null||c.handleTradeRequest({action:S})},handleCharacterInteractionRequest:({character:S,action:H})=>{c==null||c.handleCharacterInteraction({action:H,character:S})},handleSettlementInteractionRequest:({settlement:S,action:H})=>{c==null||c.handleSettlementInteraction({settlement:S,action:H})},handleInGameMenuRequest:S=>{c==null||c.handleInGameMenuRequest(S)},onDebugActionRequested:S=>{E==null||E.handleDebugActionRequest(S)},handleSaveRequest:K,handleLoadRequest:st})},K=()=>{console.debug("Saving game state...");const S=R(),H={...S,tileModels:S.tileMapModel.tiles().map(Y=>Y.map(Q=>Q))};t.save(H),f==null||f.setIsSaveCompleted(!0)},st=()=>{console.debug("Loading game state..."),e();const S=t.load();if(!S){console.warn("No saved game state found.");return}L.emit("ON_PAUSE_INPUT"),O(),nt(S)},nt=S=>{console.debug("Loading level..."),B(S??Fe()),D(),u==null||u.showPlayerMenu(),u==null||u.showPlayerUi(),!(!x||!u)&&(x.view.visible=!1,u.view.visible=!1,o.attachCamera(x),o.attachUi(u),o.resize(innerWidth,innerHeight))},dt=()=>{!x||!u||(J.enableCategory("gameplay"),J.stopMusic({fadeOut:!0}),_(),x.view.visible=!0,u.view.visible=!0,o.resize(innerWidth,innerHeight),x&&x.moveTo(d().position().x*64,d().position().y*64))},q=S=>{u==null||u.update()};return rt(()=>{at(()=>{(d().position().x!==k.x||d().position().y!==k.y)&&(_(),P(),k={x:d().position().x,y:d().position().y},x&&x.moveTo(d().position().x*64,d().position().y*64)),d().isAlive()||(console.debug("Player is dead, handling game over..."),X.delayedCall(1,()=>{n(),O()}))})}),{loadLevel:nt,showGameView:dt,update:q,getState:R}},Co=o=>{const{mainMenuVM:t,view:e,loadingScreenVM:i,saveController:n}=o,s=()=>{i.showLevelLoadScreen(),i.setVisible(!0),setTimeout(()=>{i.setVisible(!1),u.showGameView(),L.emit("ON_RESUME_INPUT")},2e3)},d=()=>{console.debug("Resetting game progress..."),n.clear(),pt().reset()},r=y=>{console.debug("Preparing next level...");const g=Fe();y.playerModel.moveTo(g.playerModel.position().x,g.playerModel.position().y),g.playerModel=y.playerModel;const x=g.playerModel.inventory().items().filter(M=>M.code()==="torch").length,T=Math.max(0,30-x);ne("torch",T).forEach(M=>g.playerModel.inventory().addItem(M));const I=Math.abs(Math.max(-5,g.playerModel.health()-g.playerModel.maxHealth()));return g.playerModel.setHealth(g.playerModel.health()+I),g},l=async y=>{i.showRestScreen(),i.setVisible(!0),await X.delayedCall(8,()=>{u.loadLevel(r(y))}),await X.delayedCall(2,()=>{i.setVisible(!1),u.showGameView()})},c=(y=!1)=>{const g=n.load();y?i.showDebugScreen():g&&i.showLevelLoadScreen(),i.setVisible(!0),t.hide(),u.loadLevel(y?void 0:g);const x=rt(()=>{at(()=>{i.isVisible()||(u.showGameView(),L.emit("ON_RESUME_INPUT"),x())})})},h=()=>{console.debug("Starting game..."),t.setIsContinueButtonVisible(n.saveExists()),t.show()},a=()=>{console.debug("Exiting game...")},f=y=>{u.update(y)},u=lo({view:e,saveController:n,onGameLoadRequest:s,onLevelCompleted:l,onGameOver:()=>{console.debug("Game Over"),L.emit("ON_PAUSE_INPUT"),i.showGameOverScreen(),i.setVisible(!0);const y=rt(()=>{at(()=>{i.isVisible()||(t.show(),y())})})}});return{loadLevel:c,initGame:h,exitGame:a,update:f,resetProgress:d}};export{Co as createGameController};
