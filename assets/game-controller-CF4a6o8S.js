import{c as ut,g as Z}from"./create-reactive-scope-BJRDMZKm.js";import{g as Tt,h as et,A as oe,d as vt,i as te,j as He,c as Ue,e as ii,f as ni,k as he,G as dt,m as Qt}from"./npc-model-BqrqNmcU.js";import{S as X,c as Yt,b as ct,a as qe}from"./modal-view-CJpTWtUq.js";import{E as si,G as J,i as de,R as ee,C as O,S as $,T as _t,P as oi,c as ri,j as ai,k as ze,l as li}from"./index-ByP46Rdr.js";import{c as z,a as ft}from"./solid-lwVvZ318.js";const ci=(n,t,e)=>{if(n<=0)return;const i=[...t];i.sort((o,d)=>{const l=o.position().distanceTo(e.position()),a=d.position().distanceTo(e.position());return l-a});const s=Math.min(4,Math.floor(i.length/n));for(let o=0;o<n;o++){const d=Tt("city-key"),l=Math.floor(Math.random()*100)<=33?0:Math.floor(Math.random()*100)<=66?1:2,a=Math.min(i.length-1,l+Math.floor((o+1)*s)),c=i[a];i.splice(l,1),c.inventory().addItem(d)}},hi=({map:n,rooms:t,pathEnemyChance:e=.2,paths:i})=>{const o=(c,h)=>c>0&&h>0&&c<n.length-1&&h<n[0].length-1,d=(c,h,r,f)=>Math.sqrt((c-r)**2+(h-f)**2),l=(c,h,r)=>r.every(f=>d(f.position().x,f.position().y,c,h)>=10),a=[];return t.forEach((c,h)=>{if(h===0)return;const r=Math.floor(Math.random()*2);for(let f=0;f<r;f++){const[p,u]=c[Math.floor(Math.random()*c.length)];if(o(p,u)&&l(p,u,a)){const g=n[p][u];g.hasEnemy()||(g.hasEnemy=()=>!0,a.push(g))}}}),i.forEach((c,h)=>{h!==0&&c.forEach(([r,f])=>{if(Math.random()<e&&o(r,f)&&l(r,f,a)){const p=n[r][f];p.hasEnemy()||(p.hasEnemy=()=>!0,a.push(p))}})}),a},di=({map:n,rooms:t,pathEventChance:e=.1,paths:i})=>{const o=[],d=(a,c)=>a>0&&c>0&&a<n.length-1&&c<n[0].length-1,l=(a,c,h,r)=>Math.sqrt((a-h)**2+(c-r)**2);return t.forEach(a=>{const c=a.length/2,h=Math.floor(Math.random()*c)+2;for(let r=0;r<h;r++){const[f,p]=a[Math.floor(Math.random()*a.length)];if(d(f,p)&&o.every(u=>l(u.position().x,u.position().y,f,p)>=3)){const u=n[f][p];!u.hasEvent()&&u.traversable()&&u.type()!=="settlement"&&(u.hasEvent=()=>!0,o.push(u))}}}),i.forEach(a=>{a.forEach(([c,h])=>{if(Math.random()<e&&d(c,h)){const r=n[c][h];!r.hasEvent()&&r.type()!=="settlement"&&r.traversable()&&o.every(f=>l(f.position().x,f.position().y,c,h)>=3)&&(r.hasEvent=()=>!0,o.push(r))}})}),o},ue=[et({id:"ancient-bunker",name:"Ancient Bunker",startPosition:{x:0,y:0},startingItems:[],level:3}),et({id:"bandit-camp",name:"Bandit Camp",startPosition:{x:0,y:0},startingItems:[],level:4}),et({id:"beacon",name:"Beacon",startPosition:{x:0,y:0},startingItems:[],level:2}),et({id:"bear-cage",name:"Bear Cage",startPosition:{x:0,y:0},startingItems:[],level:4}),et({id:"bunker",name:"Bunker",startPosition:{x:0,y:0},startingItems:[],level:2}),et({id:"campfire",name:"Campfire",startPosition:{x:0,y:0},startingItems:[],level:2}),et({id:"cave",name:"Cave",startPosition:{x:0,y:0},startingItems:[],level:3}),et({id:"chest",name:"Chest",startPosition:{x:0,y:0},startingItems:[],level:1}),et({id:"church",name:"Church",startPosition:{x:0,y:0},startingItems:[],level:2}),et({id:"crashed-plane",name:"Crashed Plane",startPosition:{x:0,y:0},startingItems:[],level:3}),et({id:"fungi",name:"Fungi",startPosition:{x:0,y:0},startingItems:[],level:1}),et({id:"tent",name:"Tent",startPosition:{x:0,y:0},startingItems:[],level:2}),et({id:"lean-to",name:"Lean-To",startPosition:{x:0,y:0},startingItems:[],level:2}),et({id:"ruin",name:"Ruin",startPosition:{x:0,y:0},startingItems:[],level:4}),et({id:"scary-tree",name:"Scary Tree",startPosition:{x:0,y:0},startingItems:[],level:1}),et({id:"silo",name:"Silo",startPosition:{x:0,y:0},startingItems:[],level:3}),et({id:"sword-in-stone",name:"Monument",startPosition:{x:0,y:0},startingItems:[],level:5}),et({id:"wagon",name:"Wagon",startPosition:{x:0,y:0},startingItems:[],level:1}),et({id:"wreck",name:"Wreck",startPosition:{x:0,y:0},startingItems:[],level:1})],ui=()=>{const n=Math.floor(Math.random()*ue.length);return ue[n]},fi=n=>{const t=Math.floor(Math.random()*n)+1,e=[];for(let i=0;i<t;i++){if(Math.random()<.5)continue;const s=pi();e.push(s)}if(e.length===0){const i=Tt("scrap");e.push(i)}return e},pi=()=>{let n=0;const t=[];return oe.map(i=>{const s=new Array(i.randomDropWeight()).fill(i);t.push(...s),n+=i.randomDropWeight()}),Tt(t[Math.floor(Math.random()*n)].code())},mi=n=>n.map(t=>{const e=ui();return et({id:e.id(),name:e.name(),startPosition:{x:t.position().x,y:t.position().y},level:e.level(),startingItems:fi(e.level())})}),gi=(n,t)=>{const e=(a,c)=>{const h=[],r=Math.abs(c.position.x-a.position.x),f=Math.abs(c.position.y-a.position.y),p=a.position.x<c.position.x?1:-1,u=a.position.y<c.position.y?1:-1;let g=r-f,y=a.position.x,w=a.position.y;for(;y!==c.position.x||w!==c.position.y;){h.push([y,w]);const b=g*2;b>-f&&(g-=f,y+=p),b<r&&(g+=r,w+=u)}return h},i=(a,c,h,r)=>{const f=a[a.length-1],[p,u]=f;for(const g of r){if(h.has(g.id))continue;if(Math.hypot(g.position.x-p,g.position.y-u)>3){const w=e({position:{x:p,y:u}},g);c.push(w),h.add(g.id);break}}},s=(a,c)=>{let h=null,r=1/0;for(const f of n){if(c.has(f.id))continue;const p=Math.hypot(f.position.x-a.position.x,f.position.y-a.position.y);p<r&&p<t&&(h=f,r=p)}return h},o=[],d=new Set;let l=n[0];for(d.add(l.id);d.size<n.length;){let a=s(l,d);if(!a){const c=Array.from(d).map(h=>n.find(r=>r.id===h));for(;c.length>0;){const h=c.pop();if(a=s(h,d),a){l=h;break}}a||(a=n.find(h=>!d.has(h.id))||null)}if(a){const c=e(l,a);o.push(c),d.add(a.id),l=a,c.length>7&&i(c,o,d,n)}else break}return o},yi=(n,t,e,i={min:2,max:4})=>{const s=n.length,o=n[0].length,d=[],l=(h,r)=>h>=0&&r>=0&&h<s&&r<o,a=(h,r,f)=>f.every(([p,u])=>{const g=h+p,y=r+u;if(!l(g,y))return!1;for(let w=-1;w<=1;w++)for(let b=-1;b<=1;b++){const _=g+w,E=y+b;if(l(_,E)&&n[_][E].type()!=="void")return!1}return!0}),c=h=>{const r=[];switch(Math.floor(Math.random()*4)){case 0:for(let g=-h;g<=h;g++)for(let y=-h;y<=h;y++)g*g+y*y<=h*h&&r.push([g,y]);break;case 1:for(let g=-h;g<=h+2;g++)for(let y=-h;y<=h;y++)(g*g+y*y<=h*h||Math.abs(g)<h&&Math.abs(y)<h)&&r.push([g,y]);break;case 2:for(let g=-h;g<=h;g++)for(let y=-h;y<=h;y++)(g*g+y*y<=h*h&&Math.random()>.5||Math.abs(g)<h&&Math.abs(y)<h&&Math.random()>.5)&&r.push([g,y]);break;case 3:const p=h*2,u=Math.floor(h/2);for(let g=-p;g<=p;g++)for(let y=-u;y<=u;y++)r.push([g,y]);break}return r};return t.forEach(h=>{const r=Math.floor(Math.random()*(i.max-i.min+1)+i.min),f=c(r),p=[];a(h.position.x,h.position.y,f)&&f.forEach(([u,g])=>{const y=h.position.x+u,w=h.position.y+g;l(y,w)&&(n[y][w]=vt({terrain:"wasteland",position:{x:y,y:w}}),p.push([y,w]))}),p.length>0&&d.push(p)}),e.forEach(h=>{h.forEach(([r,f])=>{for(let p=-Math.floor(Math.random()*2);p<=Math.floor(Math.random()*2);p++)for(let u=-Math.floor(Math.random()*2);u<=Math.floor(Math.random()*2);u++){const g=r+p,y=f+u;l(g,y)&&n[g][y].type()!=="wasteland"&&(n[g][y]=vt({terrain:"grass",position:{x:g,y}}))}})}),{map:n,rooms:d}},vi=(n,t)=>Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2)),wi=n=>{const{horizontalTiles:t,verticalCells:e,nodeCount:i,minDistanceBetweenNodes:s,maxAttemptsToAssignNode:o}=n,d=[],l=Math.ceil(Math.sqrt(i)),a=Math.floor(t/l),c=Math.floor(e/l),h=(r,f)=>d.every(p=>Math.abs(vi(p.position,{x:r,y:f}))>=s);for(let r=0;r<i;r++){let f=0,p=!1;for(;f<o&&!p;){const u=Math.floor(r%l)*a,g=Math.floor(r/l)*c;let y=u+Math.floor(Math.random()*a),w=g+Math.floor(Math.random()*c);y=Math.max(3,Math.min(t-3,y)),w=Math.max(3,Math.min(e-3,w)),y<t&&w<e&&h(y,w)?(d.push({id:`node-${r}`,position:{x:y,y:w}}),p=!0):f++}p||d.pop()&&r--}return d},xi=n=>{const{startPosition:t}=n,e=[...te("torch",30),...te("scrap",3)],i=[],s=[...e,...i];return He({name:"Hero",id:"player",startPosition:t,startingItems:s,team:"player"})},$e=()=>{const n=wi({horizontalTiles:64,verticalCells:64,nodeCount:80,minDistanceBetweenNodes:7,maxAttemptsToAssignNode:100}),t=gi(n,15),e=w=>{const b=Math.floor(Math.random()*w)+1,_=[];for(let E=0;E<b;E++){if(Math.random()<.5)continue;const M=i(),A=_.find(I=>I.code()===M.code());if(A){A.code()==="scrap"&&A.updateQuantity(A.quantity()+1);continue}_.push(M)}if(_.length===0){const E=Tt("scrap");_.push(E)}return _},i=()=>{let w=0;const b=[];return oe.map(_=>{const E=new Array(_.randomDropWeight()).fill(_);b.push(...E),w+=_.randomDropWeight()}),b[Math.floor(Math.random()*w)]},{map:s,rooms:o}=yi(Array.from({length:64},(w,b)=>Array.from({length:64},(_,E)=>vt({terrain:"void",position:{x:b,y:E}}))),n,t,{min:2,max:4}),l=hi({map:s,rooms:o,paths:t,pathEnemyChance:.2}).map(w=>Ue({id:"bandit",name:"Bandit",team:"hostile-to-all",startPosition:{x:w.position().x,y:w.position().y},startingItems:e(Math.floor(Math.random()*3)+1),startingHealth:2})),a=w=>{w[0].map(b=>vt({terrain:"mountain",position:b.position()})),w[w.length-1].map(b=>vt({terrain:"mountain",position:b.position()})),w.forEach(b=>{vt({terrain:"mountain",position:b[0].position()}),vt({terrain:"mountain",position:b[b.length-1].position()})})},c=(w,b)=>{const{x:_,y:E}=w,M=[{x:_,y:E},{x:_+1,y:E},{x:_,y:E+1},{x:_+1,y:E+1}];return M.forEach(A=>{b[A.x]&&b[A.x][A.y]&&(b[A.x][A.y]=vt({terrain:"settlement",position:A}))}),he({id:`settlement-${_}-${E}`,name:`Settlement at (${_}, ${E})`,level:1,positions:M})};function h(w,b){const _=[];return w.forEach((E,M)=>{const{x:A,y:I}=E.position,T=!0;if(M===0){_.push(c({x:A,y:I},b));return}A<b.length-1&&I<b[0].length-1&&T?_.push(c({x:A,y:I},b)):(b[A][I]=vt({terrain:"settlement",position:{x:A,y:I}}),_.push(he({id:E.id,name:`Settlement ${M+1}`,level:1,positions:[{x:A,y:I}]})))}),_}const f=((w,b,_)=>{const E=[],M=new Set,A=I=>{const T=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],m=T[Math.floor(Math.random()*T.length)];return{x:I.position.x+m.x,y:I.position.y+m.y}};for(E.push({id:w[0].id,position:A(w[0])});E.length<b&&E.length<w.length&&M.size<w.length;){const I=Math.floor(Math.random()*w.length),T=w[I],m=`${T.position.x},${T.position.y}`;if(M.has(m))continue;let x=!0;for(const v of E)if(Math.sqrt(Math.pow(T.position.x-v.position.x,2)+Math.pow(T.position.y-v.position.y,2))<_){x=!1;break}x&&(E.push(T),M.add(m))}return E})(n,3,5),p=h(f,s);a(s);const u=di({map:s,rooms:o,paths:t,pathEventChance:.1}),g=mi(u),y=xi({startPosition:n[0].position});return ci(p.length,l,y),{playerModel:y,tileMapModel:ni(s),npcModels:l,eventModels:g,settlementModels:p,fogOfWarViewModel:ii()}};/*!
 * PixiPlugin 3.13.0
 * https://gsap.com
 *
 * @license Copyright 2008-2025, GreenSock. All rights reserved.
 * Subject to the terms at https://gsap.com/standard-license
 * @author: Jack Doyle, jack@greensock.com
*/var bt,Xt,fe,ht,Dt,Ge,ie,Zt,Fe=function(){return typeof window<"u"},Qe=function(){return bt||Fe()&&(bt=window.gsap)&&bt.registerPlugin&&bt},ne=function(t){return typeof t=="function"},Ye=function(t){return console.warn(t)},bi=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],Ct=.212671,wt=.71516,mt=.072169,Xe=function(t){return ne(ht[t])?ht[t]:ht.filters[t]},Kt=function(t,e){var i=[],s=0,o=0,d,l;for(d=0;d<4;d++){for(l=0;l<5;l++)o=l===4?t[s+4]:0,i[s+l]=t[s]*e[l]+t[s+1]*e[l+5]+t[s+2]*e[l+10]+t[s+3]*e[l+15]+o;s+=5}return i},pe=function(t,e){var i=1-e,s=i*Ct,o=i*wt,d=i*mt;return Kt([s+e,o,d,0,0,s,o+e,d,0,0,s,o,d+e,0,0,0,0,0,1,0],t)},me=function(t,e,i){var s=Xt(e),o=s[0]/255,d=s[1]/255,l=s[2]/255,a=1-i;return Kt([a+i*o*Ct,i*o*wt,i*o*mt,0,0,i*d*Ct,a+i*d*wt,i*d*mt,0,0,i*l*Ct,i*l*wt,a+i*l*mt,0,0,0,0,0,1,0],t)},ge=function(t,e){e*=Math.PI/180;var i=Math.cos(e),s=Math.sin(e);return Kt([Ct+i*(1-Ct)+s*-.212671,wt+i*-.71516+s*-.71516,mt+i*-.072169+s*(1-mt),0,0,Ct+i*-.212671+s*.143,wt+i*(1-wt)+s*.14,mt+i*-.072169+s*-.283,0,0,Ct+i*-.212671+s*-.787329,wt+i*-.71516+s*wt,mt+i*(1-mt)+s*mt,0,0,0,0,0,1,0,0,0,0,0,1],t)},ye=function(t,e){return Kt([e,0,0,0,.5*(1-e),0,e,0,0,.5*(1-e),0,0,e,0,.5*(1-e),0,0,0,1,0],t)},je=function(t,e){var i=Xe(e),s=t.filters||[],o=s.length,d;for(i||Ye(e+" not found. PixiPlugin.registerPIXI(PIXI)");--o>-1;)if(s[o]instanceof i)return s[o];return d=new i,e==="BlurFilter"&&(Zt?d.strength=0:d.blur=0),t.filters=[].concat(s,[d]),d},it=function(t,e,i,s){e.add(i,t,i[t],s[t]),e._props.push(t)},ve=function(t,e){var i=Xe("ColorMatrixFilter"),s=new i;return s.matrix=e,s.brightness(t,!0),s.matrix},Ci=function(t){var e={},i;for(i in t)e[i]=t[i];return e},at={contrast:1,saturation:1,colorizeAmount:0,colorize:"rgb(255,255,255)",hue:0,brightness:1},Ti=function(t,e,i){var s=je(t,"ColorMatrixFilter"),o=t._gsColorMatrixFilter=t._gsColorMatrixFilter||Ci(at),d=e.combineCMF&&!("colorMatrixFilter"in e&&!e.colorMatrixFilter),l,a,c;for(c=s.matrix,e.resolution&&(s.resolution=e.resolution),e.matrix&&e.matrix.length===c.length?(a=e.matrix,o.contrast!==1&&it("contrast",i,o,at),o.hue&&it("hue",i,o,at),o.brightness!==1&&it("brightness",i,o,at),o.colorizeAmount&&(it("colorize",i,o,at),it("colorizeAmount",i,o,at)),o.saturation!==1&&it("saturation",i,o,at)):(a=bi.slice(),e.contrast!=null?(a=ye(a,+e.contrast),it("contrast",i,o,e)):o.contrast!==1&&(d?a=ye(a,o.contrast):it("contrast",i,o,at)),e.hue!=null?(a=ge(a,+e.hue),it("hue",i,o,e)):o.hue&&(d?a=ge(a,o.hue):it("hue",i,o,at)),e.brightness!=null?(a=ve(+e.brightness,a),it("brightness",i,o,e)):o.brightness!==1&&(d?a=ve(o.brightness,a):it("brightness",i,o,at)),e.colorize!=null?(e.colorizeAmount="colorizeAmount"in e?+e.colorizeAmount:1,a=me(a,e.colorize,e.colorizeAmount),it("colorize",i,o,e),it("colorizeAmount",i,o,e)):o.colorizeAmount&&(d?a=me(a,o.colorize,o.colorizeAmount):(it("colorize",i,o,at),it("colorizeAmount",i,o,at))),e.saturation!=null?(a=pe(a,+e.saturation),it("saturation",i,o,e)):o.saturation!==1&&(d?a=pe(a,o.saturation):it("saturation",i,o,at))),l=a.length;--l>-1;)a[l]!==c[l]&&i.add(c,l,c[l],a[l],"colorMatrixFilter");i._props.push("colorMatrixFilter")},ki=function(t,e){var i=e.t,s=e.p,o=e.color,d=e.set;d(i,s,o[0]<<16|o[1]<<8|o[2])},Ii=function(t,e){var i=e.g;Zt?(i.fill(),i.stroke()):i&&(i.dirty++,i.clearDirty++)},_i=function(t,e){e.t.visible=!!e.t.alpha},we=function(t,e,i,s){var o=t[e],d=Xt(ne(o)?t[e.indexOf("set")||!ne(t["get"+e.substr(3)])?e:"get"+e.substr(3)]():o),l=Xt(i);s._pt=new Dt(s._pt,t,e,0,0,ki,{t,p:e,color:d,set:Ge(t,e)}),s.add(d,0,d[0],l[0]),s.add(d,1,d[1],l[1]),s.add(d,2,d[2],l[2])},Mi={tint:1,lineColor:1,fillColor:1,strokeColor:1},xe="position,scale,skew,pivot,anchor,tilePosition,tileScale".split(","),se={x:"position",y:"position",tileX:"tilePosition",tileY:"tilePosition"},Ei={colorMatrixFilter:1,saturation:1,contrast:1,hue:1,colorize:1,colorizeAmount:1,brightness:1,combineCMF:1},jt=Math.PI/180,Ze=function(t){return typeof t=="string"},Si=function(t){return Ze(t)&&t.charAt(1)==="="?t.substr(0,2)+parseFloat(t.substr(2))*jt:t*jt},Ai=function(t,e){return e.set(e.t,e.p,t===1?e.e:Math.round((e.s+e.c*t)*1e5)/1e5,e)},Pi=function(t,e,i,s,o,d){var l=360*(d?jt:1),a=Ze(o),c=a&&o.charAt(1)==="="?+(o.charAt(0)+"1"):0,h=parseFloat(c?o.substr(2):o)*(d?jt:1),r=c?h*c:h-s,f=s+r,p,u;return a&&(p=o.split("_")[1],p==="short"&&(r%=l,r!==r%(l/2)&&(r+=r<0?l:-l)),p==="cw"&&r<0?r=(r+l*1e10)%l-~~(r/l)*l:p==="ccw"&&r>0&&(r=(r-l*1e10)%l-~~(r/l)*l)),t._pt=u=new Dt(t._pt,e,i,s,r,Ai),u.e=f,u},be=function(){if(!fe){bt=Qe(),ht=fe=ht||Fe()&&window.PIXI;var t=ht&&ht.VERSION&&parseFloat(ht.VERSION.split(".")[0])||0;ie=t===4,Zt=t>=8,Xt=function(i){return bt.utils.splitColor((i+"").substr(0,2)==="0x"?"#"+i.substr(2):i)}}},Gt,Mt;for(Gt=0;Gt<xe.length;Gt++)Mt=xe[Gt],se[Mt+"X"]=Mt,se[Mt+"Y"]=Mt;var re={version:"3.13.0",name:"pixi",register:function(t,e,i){bt=t,Dt=i,Ge=e.getSetter,be()},headless:!0,registerPIXI:function(t){ht=t},init:function(t,e,i,s,o){if(ht||be(),!ht)return Ye("PIXI was not found. PixiPlugin.registerPIXI(PIXI);"),!1;var d,l,a,c,h,r,f,p,u,g;for(r in e){if(d=se[r],a=e[r],d)l=~r.charAt(r.length-1).toLowerCase().indexOf("x")?"x":"y",this.add(t[d],l,t[d][l],d==="skew"?Si(a):a,0,0,0,0,0,1);else if(r==="scale"||r==="anchor"||r==="pivot"||r==="tileScale")this.add(t[r],"x",t[r].x,a),this.add(t[r],"y",t[r].y,a);else if(r==="rotation"||r==="angle")Pi(this,t,r,t[r],a,r==="rotation");else if(Ei[r])c||(Ti(t,e.colorMatrixFilter||e,this),c=!0);else if(r==="blur"||r==="blurX"||r==="blurY"||r==="blurPadding"){if(h=je(t,"BlurFilter"),this.add(h,r,h[r],a),e.blurPadding!==0)for(f=e.blurPadding||Math.max(h[r],a)*2,p=t.filters.length;--p>-1;)t.filters[p].padding=Math.max(t.filters[p].padding,f)}else if(Mi[r])if((r==="lineColor"||r==="fillColor"||r==="strokeColor")&&t instanceof ht.Graphics)for(u=("fillStyle"in t)?[t]:(t.geometry||t).graphicsData,g=r.substr(0,r.length-5),Zt&&g==="line"&&(g="stroke"),this._pt=new Dt(this._pt,t,r,0,0,Ii,{g:t.geometry||t}),p=u.length;--p>-1;)we(ie?u[p]:u[p][g+"Style"],ie?r:"color",a,this);else we(t,r,a,this);else r==="autoAlpha"?(this._pt=new Dt(this._pt,t,"visible",0,0,_i),this.add(t,"alpha",t.alpha,a),this._props.push("alpha","visible")):r!=="resolution"&&this.add(t,r,"get",a);this._props.push(r)}}};Qe()&&bt.registerPlugin(re);const V=new si,Ni=n=>(V.on("ON_LEVEL_COMPLETED",()=>{n.handleLevelCompleted()}),V.on("ON_TILE_INTERACTION",({tileViewModel:t})=>{n.handleTileInteraction(t)}),V.on("ON_ITEM_INTERACTION",({itemViewModel:t,action:e})=>{n.handleItemInteraction(t,e)}),V.on("ON_EVENT_INTERACTION",({eventViewModel:t})=>{n.handleEventInteraction(t)}),V.on("ON_CHARACTER_INTERACTION",({characterViewModel:t})=>{n.handleCharacterInteraction(t)}),V.on("ON_INVENTORY_REQUEST",({inventory:t,action:e})=>{n.handleInventoryRequest(t,e)}),V.on("ON_CLOSE_INVENTORY_REQUESTED",()=>{n.onCloseInventoryRequested()}),V.on("ON_TRADE_REQUEST",({action:t})=>{n.handleTradeRequest(t)}),V.on("ON_CHARACTER_INTERACTION_REQUEST",t=>{n.handleCharacterInteractionRequest(t)}),V.on("ON_SETTLEMENT_INTERACTION_REQUEST",t=>{n.handleSettlementInteractionRequest(t)}),V.on("ON_SAVE_REQUEST",()=>{n.handleSaveRequest()}),V.on("ON_LOAD_REQUEST",()=>{n.handleLoadRequest()}),V.on("ON_IN_GAME_MENU_REQUEST",({action:t})=>{n.handleInGameMenuRequest(t)}),V.on("ON_DEBUG_ACTION_REQUESTED",({action:t})=>{n.onDebugActionRequested(t)}),{destroy:()=>{V.removeAllListeners()}}),Ri=()=>{const[n,t]=z(0),[e,i]=z(480);return{getCurrentTurn:()=>n(),getGameTimeMin:()=>e(),nextTurn:()=>{t(l=>l+1),i(l=>{const a=l+10;return a>=1440?0:a})}}},Ht=n=>{const{model:t}=n,[e,i]=z(t.armour()>0),[s,o]=z(t.armour()<t.maxArmour()),[d,l]=z(t.damage()>0),[a,c]=z(t.health()>0),h={code:()=>t.code(),name:()=>t.name(),description:()=>t.description(),quantity:()=>t.quantity(),value:()=>t.value(),updateQuantity:r=>{t.updateQuantity(r)},level:()=>t.level(),interact:()=>{V.emit("ON_ITEM_INTERACTION",{itemViewModel:h})},health:()=>t.health(),type:()=>t.type(),damage:()=>t.damage(),range:()=>t.range(),armour:()=>t.armour(),setArmour:r=>{t.setArmour(r)},maxArmour:()=>t.maxArmour(),id:()=>t.id(),isArmourIconVisible:()=>e(),isDamagedArmourIconVisible:()=>s(),isHealthIconVisible:()=>a(),setIsArmourIconVisible:r=>{i(r)},setIsDamagedArmourIconVisible:r=>{o(r)},setIsHealthIconVisible:r=>{c(r)},isDamageIconVisible:()=>d(),setIsDamageIconVisible:r=>{l(r)},uses:()=>t.uses(),setUses:r=>{t.setUses(r)},collected:()=>t.collected(),setCollected:r=>{t.setCollected(r)}};return h},kt=n=>{const{model:t,ownerName:e,owner:i}=n,[s,o]=z([]),[d,l]=z(!1),a=r=>Ht({model:r}),c=(r,f)=>{const p=r.code()===f.code(),u=r.armour()===f.armour(),g=r.damage()===f.damage();return p&&u&&g},h={items:()=>t.items().map(r=>a(r)),stacks:()=>s(),setStacks:()=>{const r=[],f=[];h.items().forEach(p=>{if(i&&i.isEquipped(p)){f.push({item:p,quantity:1});return}const u=r.find(g=>c(g.item,p));u?u.quantity+=p.quantity():r.push({item:p,quantity:p.quantity()})}),r.sort((p,u)=>u.item.type()==="currency"&&p.item.type()!=="currency"?1:u.item.type()!=="currency"&&p.item.type()==="currency"?-1:u.item.type()==="light"&&p.item.type()!=="light"?1:u.item.type()!=="light"&&p.item.type()==="light"?-1:u.item.armour()>0&&p.item.armour()<=0?1:u.item.armour()<=0&&p.item.armour()>0?-1:u.item.damage()>0&&p.item.damage()<=0?1:u.item.damage()<=0&&p.item.damage()>0?-1:u.item.health()>0&&p.item.health()<=0?1:u.item.health()<=0&&p.item.health()>0?-1:u.item.type()==="loot"&&p.item.type()!=="loot"?1:u.item.type()!=="loot"&&p.item.type()==="loot"?-1:p.item.name().localeCompare(u.item.name())),o(f.concat(r))},ownerName:()=>e,getItem:r=>h.items().find(f=>c(f,r)),getItemByCode:r=>h.items().find(f=>f.code()===r),getItemByName:r=>h.items().find(f=>f.name()===r),addItem:r=>{t.addItem(Tt(r.code(),{id:()=>r.id()})),h.setStacks()},removeItem:r=>{t.removeItem(r),h.setStacks(),!r.collected()&&(!i||!i.isAlive())&&!["trade-npc","trade","settlement","hero"].includes(e.toLowerCase())&&["trade-npc","trade","settlement","hero"].filter(f=>e.toLowerCase().includes(f)).length===0&&(r.setCollected(!0),dt().log.collectedItemsValue+=r.value())},owner:i,isEmpty:()=>t.isEmpty(),isOnlyLoot:()=>t.isOnlyLoot(),isInfoButtonEnabled:()=>d(),setInfoButtonEnabled:r=>{l(r)}};return h.setStacks(),ut(()=>{ft(()=>{h.setStacks()})}),h},ae=n=>{const{model:t}=n,[e,i]=z(kt({model:t.inventory(),ownerName:t.name()})),s=l=>{if(!l)throw new Error("Item cannot be undefined");const a=t.inventory().getItemById(l.id());if(!a)throw new Error(`Item with code ${l.id()} not found in inventory`);return a},o=l=>{if(!l)throw new Error("Item cannot be undefined");return Ht({model:l})},d={id:()=>t.id(),name:()=>t.name(),setInventory:l=>{i(l)},size:()=>t.size(),position:()=>({...t.position(),distanceTo:l=>{const a=t.position().x-l.x,c=t.position().y-l.y;return Math.floor(Math.sqrt(a*a+c*c))}}),health:()=>t.health(),maxHealth:()=>t.maxHealth(),moveTo:(l,a)=>{d.isAlive()&&t.moveTo(l,a)},dialogue:()=>t.dialogue(),isHostile:l=>t.isHostile(l),move:(l,a)=>{const c=t.position(),h=c.x+l,r=c.y+a;t.moveTo(h,r)},team:()=>t.team(),updateTeam:l=>{t.updateTeam(l)},inventory:()=>e(),armour:()=>{var h,r,f;const l=((h=t.bodyArmour())==null?void 0:h.armour())??0,a=((r=t.headArmour())==null?void 0:r.armour())??0,c=((f=t.feetArmour())==null?void 0:f.armour())??0;return l+a+c},takeDamage:l=>{let a=l;new Array(l).fill(0).forEach(()=>{const h=[t.bodyArmour(),t.headArmour(),t.feetArmour()].filter(r=>r&&r.armour()>0);if(h.length!==0){const r=h[Math.floor(Math.random()*h.length)];r.setArmour(r.armour()-1),a--}}),t.id()==="player"&&(dt().log.totalDamageAbsorbed+=l-a,dt().log.totalDamageTaken+=a);const c=t.health()-a;t.setHealth(c)},setHealth:l=>{t.setHealth(l)},setMaxHealth:l=>{t.setMaxHealth(l)},isAlive:()=>t.health()>0,visible:()=>t.visible(),setVisible:l=>{t.setVisible(l)},bodyArmour:()=>o(t.bodyArmour()),setBodyArmour:l=>{l?t.setBodyArmour(s(l)):t.setBodyArmour(void 0)},headArmour:()=>o(t.headArmour()),setHeadArmour:l=>{l?t.setHeadArmour(s(l)):t.setHeadArmour(void 0)},feetArmour:()=>o(t.feetArmour()),setFeetArmour:l=>{l?t.setFeetArmour(s(l)):t.setFeetArmour(void 0)},weapon:()=>{const l=t.weapon();return Ht({model:l})},setWeapon:l=>{l?t.setWeapon(s(l)):t.setWeapon(void 0)},isEquipped:l=>{var a,c,h,r;return((a=t.weapon())==null?void 0:a.id())===l.id()||((c=t.bodyArmour())==null?void 0:c.id())===l.id()||((h=t.headArmour())==null?void 0:h.id())===l.id()||((r=t.feetArmour())==null?void 0:r.id())===l.id()}};return i(kt({model:t.inventory(),ownerName:t.name(),owner:d})),d},Vi=n=>{const{eventModel:t}=n;return{...t,inventory:()=>kt({model:t.inventory(),ownerName:t.name()})}},Li=n=>n.tile,Bi=n=>{const{model:t}=n,e=s=>Li({tile:s});return{isValidMove:(s,o)=>t.isValidMove(s,o),entryPoints:()=>t.entryPoints().map(s=>e(s)),tiles:()=>t.tiles().map(s=>s.map(o=>e(o))),updateTile:(s,o,d)=>{t.tiles()[s][o]=d},getNeighbors:s=>{var c;const o=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}],d=[],l=s.position().x,a=s.position().y;for(const{dx:h,dy:r}of o){const f=l+h,p=a+r,u=(c=t.tiles()[f])==null?void 0:c[p];u&&d.push(e(u))}return d}}},Ke=n=>{const[t,e]=z([]),[i,s]=z(null),[o,d]=z([]),[l,a]=z(null),[c,h]=z(null),[r,f]=z(!1);return{...ae({model:n}),setLastSpawned:u=>n.setLastTurnSpawned(u),lastSpawned:()=>n.lastTurnSpawned(),spawnLing:()=>n.spawnling(),getPatrolArea:()=>t(),setPatrolArea:u=>e(u),getTask:()=>i(),setTask:u=>s(u),getTaskList:()=>o(),setTaskList:u=>d(u),getBedLocation:()=>l(),setBedLocation:u=>a(u),getTarget:()=>c(),setTarget:u=>h(u),canTrade:()=>r(),setCanTrade:u=>f(u)}},Oi=n=>{const{model:t}=n,[e,i]=z(!0);return{id:()=>t.id(),name:()=>t.name(),level:()=>t.level(),positions:()=>t.positions(),isVisible:()=>e(),setIsVisible:s=>i(s),isUnlocked:()=>t.isUnlocked(),setIsUnlocked:s=>t.setIsUnlocked(s),inventory:()=>kt({model:t.inventory(),ownerName:t.name()}),getMiddleTopPosition:()=>{const s=t.positions();if(s.length===0)return{x:0,y:0};const o=Math.max(...s.map(l=>l.x)),d=Math.min(...s.map(l=>l.y));return{x:(o-s[0].x)/2+s[0].x,y:d}}}},Wi=n=>{const{playerModel:t,tileMapModel:e,npcModels:i,eventModels:s,settlementModels:o,fogOfWarViewModel:d}=n,l=ae({model:t}),a=Bi({model:e}),c=i.map(f=>Ke(f)),h=s.map(f=>Vi({eventModel:f})),r=o.map(f=>Oi({model:f}));return{playerVM:l,tileMapVM:a,npcVMs:c,eventVMs:h,settlementVMs:r,fogOfWarViewModel:d}},Di=n=>{const{model:t}=n;return{getCurrentTurn:()=>t.getCurrentTurn(),nextTurn:()=>{t.nextTurn()},getCurrentClocktime:()=>{const e=t.getGameTimeMin(),i=Math.floor(e/60),s=e%60;return`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},getCurrentTimeMin:()=>t.getGameTimeMin()}},pt=(n,t)=>Math.floor(Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))),Hi=(n,t)=>{let e=[];for(const i of t){const s=i.position(),o=pt(n,s);e.length===0||o<e[0].distance?e=[{npc:i,distance:o}]:o===e[0].distance&&e.push({npc:i,distance:o})}return e},Ui=(n,t)=>{let e=null,i=1/0;for(const s of t)s.positions().forEach(o=>{const d=pt(n,o);d<i&&(i=d,e=s)});return e},qi=(n,t)=>{let e=null,i=1/0;for(const s of t){const o=s.position(),d=pt(n,o);d<i&&(i=d,e=s)}return e},zi=({playerVM:n,npcVMs:t,settlementVMs:e,eventViewModels:i})=>{const[s,o]=z(!0),[d,l]=z(null),[a,c]=z(null),[h,r]=z(null),[f,p]=z(null),[u,g]=z(null),[y,w]=z(null),[b,_]=z(null),[E,M]=z(null),[A,I]=z(null),[T,m]=z(null),x=1;let v=null,C=null,k=null,N=null,B=null,Y,R=null,S=null,L=null,U=null;const D=(W,F)=>{if(F){const nt=F.position();if(pt(W,nt)<=x)return v=F,!0}return!1},q=(W,F)=>{if(!F)return _(null),!1;const nt=F.position();return pt(W,nt)<=x&&F.inventory().isEmpty()===!1?(k=F,!0):!1},H=W=>W.isUnlocked()||!n.inventory().items().some(F=>F.code()==="city-key")?!1:(S=W,!0),K=W=>W.isUnlocked()&&!W.inventory().isEmpty()?(L=W,!0):!1,st=W=>W.isUnlocked()?(U=W,!0):!1,P=W=>{const F=Ui(W,e);return F&&F.positions().forEach(nt=>{if(pt(W,nt)<=x)return H(F),K(F),st(F),L||(N=F),!0}),!1},G=(W,F)=>{if(F){const nt=F.position(),rt=pt(W,nt);if(rt<=n.weapon().range()&&rt<=2&&!Q(W,F))return B=F,!0}return!1},Q=(W,F)=>{if(F){const nt=F.position(),rt=pt(W,nt);if(rt<=n.weapon().range()&&n.weapon().range()>2&&rt>1)return R=F,!0}return!1},tt=W=>{const F=n.position();return pt(F,W.position)<=x&&W.inventory.isEmpty()===!1?(Y=W.inventory,!0):!1},gt=W=>{if(W){const F=n.position(),nt=W.position();if(pt(F,nt)<=x&&W.canTrade())return C=W,!0}return!1},yt=W=>{if(W.isHostile(n.team())){if(W.isAlive()){const F=G(n.position(),W),nt=Q(n.position(),W);return F||nt}else if(W.inventory().isEmpty()===!1)return tt({position:W.position(),inventory:W.inventory()})}else return W.isAlive()?(D(n.position(),W),gt(W)):tt({position:W.position(),inventory:W.inventory()});return!1},lt=()=>{v=null,C=null,k=null,N=null,B=null,Y=null,R=null,S=null,L=null,U=null},ti=()=>{d()!==v&&l(v),a()!==C&&c(C),b()!==k&&_(k),h()!==N&&r(N),f()!==B&&p(B),y()!==Y&&w(Y),a()!==C&&c(C),u()!==R&&g(R),E()!==S&&M(S),A()!==L&&I(L),T()!==U&&m(U)},ce=()=>{const W=n.position(),F=Hi(W,t),nt=qi(W,i);if(lt(),F.length>0)for(let rt=0;rt<F.length;rt++){const ei=F[rt].npc;if(yt(ei))break}q(W,nt),P(W),ti()};return ce(),ut(()=>{ft(()=>{ce()})}),{isVisible:s,setVisibility:W=>o(W),canUnlockSettlement:E,canInteractWithCharacter:d,canAttackCharacter:f,canTradeWithCharacter:a,canVisitSettlement:h,canSearch:b,canLoot:y,canRangedAttackCharacter:u,canTradeWithSettlement:A,canRestAtSettlement:T}},$i=n=>{const{playerVM:t}=n,[e,i]=z(!1),[s,o]=z(!1),[d,l]=z(!1),[a,c]=z(0),h={torchLeft:()=>a(),health:()=>t.health(),maxHealth:()=>t.maxHealth(),armour:()=>h.bodyArmour().armour()+h.headArmour().armour()+h.feetArmour().armour(),maxArmour:()=>h.bodyArmour().maxArmour()+h.headArmour().maxArmour()+h.feetArmour().maxArmour(),inventoryValue:()=>Math.floor(t.inventory().items().reduce((r,f)=>r+f.value()*f.quantity(),0)),isInventoryValueVisible:r=>(r!==void 0&&i(r),e()),inventory:()=>t.inventory(),weapon:()=>t.weapon(),bodyArmour:()=>t.bodyArmour(),headArmour:()=>t.headArmour(),feetArmour:()=>t.feetArmour(),isInGameMenuVisible:()=>s(),showInGameMenu:r=>{l(!1),o(r)},isSaveCompleted:()=>d(),setIsSaveCompleted:r=>{setTimeout(()=>{l(!1)},2e3),l(r)}};return ut(()=>{ft(()=>{const r=t.inventory().stacks().find(f=>f.item.code()==="torch");c(r?r.quantity:0)})}),h},Gi=n=>{const{gameView:t,viewport:e,viewModel:i}=n,s=new J,o=new J;o.label="sensing-fog-of-war",o.alpha=.5,s.label="fog-of-war";const d=()=>{s.destroy({children:!0}),o.destroy({children:!0})};t.addChild(s,o);const l=()=>{const r=-t.position.x/t.scale.x,f=-t.position.y/t.scale.y,p=e.width/t.scale.x,u=e.height/t.scale.y,g=Math.floor(r/64)-2,y=Math.floor(f/64)-2,w=Math.ceil((r+p)/64)+2,b=Math.ceil((f+u)/64)+2,_=[];for(let E=g;E<=w;E++)for(let M=y;M<=b;M++)_.push({x:E,y:M});return _};return{applyFogOfWarExceptAround:c=>{i.setFogOfWarPoints(l());const h=64;s.clear(),o.clear();const r=new de;r.x=c.x,r.y=c.y,r.radius=i.lightRadius()*1.8;const f=new de;f.x=c.x,f.y=c.y,f.radius=i.lightRadius();for(const p of i.fogOfWarPoints()){const u=new ee;if(u.x=p.x*h,u.y=p.y*h,u.width=h,u.height=h,f.contains(u.x,u.y)){i.addRevealedPoint({x:p.x,y:p.y});continue}if(r.contains(u.x,u.y)){o.rect(u.x,u.y,h,h),o.fill("black"),i.revealedPoints().some(g=>g.x===p.x&&g.y===p.y)||i.addRevealedPoint({x:p.x,y:p.y});continue}if(i.revealedPoints().some(g=>g.x===p.x&&g.y===p.y)){o.rect(u.x,u.y,h,h),o.fill("black");continue}s.rect(u.x,u.y,h,h),s.fill(0)}},destroy:d}},Fi=({gameView:n,userInterfaceView:t,fogOfWarVM:e})=>{const i=new O,s=new O,o=new J,d=new J,l=.2;let a=!1,c=!1,h={x:0,y:0},r=null,f=Gi({gameView:n,viewport:s,viewModel:e}),p={x:0,y:0},u;i.label="camera-view",s.label="viewport",s.addChild(n,d),s.mask=d,n.scale.set(.6);const g=()=>{r==null||r.kill(),document.removeEventListener("mousedown",b),document.removeEventListener("mouseup",_),document.removeEventListener("mousemove",E),document.removeEventListener("wheel",M),s.destroy({children:!0}),o.destroy(),d.destroy(),f==null||f.destroy(),f=null,i.removeChildren(),i.destroy({children:!0})},y=(T,m)=>{o.clear(),o.rect(0,0,T,m),o.fill("black")},w=(T,m)=>{d.clear(),d.rect(10,10,T-20,m-20),d.fill("black")};i.addChild(o,s,t);const b=T=>{T.button===0&&(a=!0)},_=T=>{T.button===0&&(a=!1,c=!1)},E=T=>{const m={x:T.clientX,y:T.clientY},x=m.x-h.x,v=m.y-h.y;if(c&&x!==0&&v!==0&&(a=!0),h={x:T.clientX,y:T.clientY},c){const{movementX:C,movementY:k}=T;n.position.x+=C,n.position.y+=k}},M=T=>{const{deltaY:m}=T;n.scale.x+m*.001>1||n.scale.x+m*.001<.5||(n.scale.x+=m*.001,n.scale.y+=m*.001)};document.addEventListener("mousedown",b),document.addEventListener("mouseup",_),document.addEventListener("mousemove",E),document.addEventListener("wheel",M);const A=(T,m)=>{const x={x:s.width*.5-T*n.scale.x,y:s.height*.5-m*n.scale.y},v={x:n.position.x,y:n.position.y},k=Math.sqrt(Math.pow(x.x-v.x,2)+Math.pow(x.y-v.y,2))>98;r&&r.progress(1),r=Z.fromTo(v,{x:v.x,y:v.y},{x:x.x,y:x.y,duration:k?0:1,onUpdate:()=>{n.position.set(v.x,v.y),!u&&(u=Z.delayedCall(l,()=>{u=void 0}),f==null||f.applyFogOfWarExceptAround({x:T,y:m}))},onComplete:()=>{f==null||f.applyFogOfWarExceptAround({x:T,y:m}),p={x:T,y:m}}})};return{view:i,moveTo:A,resize:(T,m)=>{w(T,m),y(T,m),A(p.x,p.y)},destroy:g,isDragging:()=>a}},Qi=n=>{const{viewModel:t}=n,e=new O,i=t.isAlive()?$.from(`${t.id()}.png`):$.from("corpse.png");let s={x:0,y:0};e.label=`${t.id()}-view`,e.eventMode="static";const o=()=>{i.width=50,i.height=50,i.anchor.set(0-60/50/10,0-60/50/10),e.addChild(i),e.position.set(t.position().x*64,t.position().y*64)};return e.on("pointertap",()=>{V.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})}),o(),{view:e,update:()=>{e.visible=t.visible(),!t.isAlive()&&!i.label.includes("corpse")&&(X.play("audio/sfx/death.mp3",{category:"gameplay"}),i.label=`${t.id()}-corpse`,i.texture=$.from("corpse.png").texture);const l=t.position();if(s.x!==l.x||s.y!==l.y){const a=s.x>l.x,c=s.x!==l.x;if(s={x:l.x,y:l.y},X.play("audio/sfx/step.mp3",{category:"gameplay"}),!c)return;a?(e.scale.x=1,e.pivot.x=0):(e.scale.x=-1,e.pivot.x=60)}}}},Yi=n=>{const{viewModel:t}=n,e=new O;let i;e.label=`${t.name()}-${t.id()}`,i=$.from(`${t.id()}.png`),i.label=`${t.name()}-${t.id()}`,i.width=64,i.height=64;const s=$.from("cleared.png");s.width=64,s.height=64,s.label="discovered",s.visible=t.discovered(),s.position.set(-16,0);const o=$.from("loot-icon.png");return o.width=32,o.height=32,o.label="loot-available",o.tint="yellow",o.visible=t.discovered()&&!t.inventory().isEmpty(),o.position.set(i.width-o.width,i.height-o.height),e.addChild(i,s,o),e.position.set(t.position().x,t.position().y),e.eventMode="static",e.on("pointertap",()=>{V.emit("ON_EVENT_INTERACTION",{eventViewModel:t})}),ut(()=>ft(()=>{e.visible=t.visible(),t.visible()&&t.discovered()&&(i.label.includes("visited")||(s.visible=!0,o.visible=!t.inventory().isEmpty()))}),e),{view:e}},Ce={"bed-time":"task-bed-time",patrol:"magnifying-glass-icon",follow:"walking-icon",work:"coins-icon",idle:"task-idle",attack:"attack-icon"},Xi=n=>{const{cellSize:t,npcVMs:e}=n,i=new O,s=new Map;i.label="npc-task-view";const o=h=>{var g;const r=new O,f=new J,p=((g=h.getTask())==null?void 0:g.name())??"idle",u=$.from(`${Ce[p]||"task-idle"}.png`);r.label=`task-icon-container-${h.id()}`,r.addChild(f,u),u.label=`task-${p}.png`,u.width=t/2,u.height=t/2,s.set(h,{icon:u,container:r,background:f}),f.circle(u.width/2,u.height/2,u.width/1.3),f.fill("khaki"),f.alpha=.75,i.addChild(r)},d=h=>{s.has(h)||o(h)},l=()=>{i.visible=!0},a=()=>{i.visible=!1},c=()=>{s.forEach((h,r)=>{var u;if(h.container.visible=r.visible()&&r.isAlive(),!r.isAlive()){i.removeChild(h.container),h.icon.destroy(),h.background.destroy(),h.container.destroy(),s.delete(r);return}const f=((u=r.getTask())==null?void 0:u.name())??"idle",p=Ce[f]||"task-idle";h.icon.label!==`${p}.png`&&(h.icon.label=`${p}.png`,h.icon.texture=$.from(`${p}.png`).texture),h.container.position.set((r.position().x+.5)*n.cellSize-h.icon.width/2,r.position().y*n.cellSize-t*.6)})};return e.forEach(h=>{d(h)}),{view:i,show:l,hide:a,update:c,addNpc:d}},Te=new Array(5).fill(0),ke=n=>{const{viewModel:t,onStep:e}=n,i=new O;let s=t.id();if(s==="bandit"){const c=Math.floor(Math.random()*5),h=Te.reduce((r,f,p,u)=>f<u[r]?p:r,c);s=`bandit-${h}`,Te[h]++,s=`bandit-${h}`}const o=t.isAlive()?$.from(`${s}.png`):$.from("corpse.png");o.label=t.isAlive()?`${t.id()}-sprite`:`${t.id()}-corpse-sprite`,i.label=`${t.name()}-view`,i.eventMode="static";const d=()=>{const c=t.size()*50;o.width=c,o.height=c,o.anchor.set(0-60/c/10,0-60/c/10),i.addChild(o),i.position.set(t.position().x,t.position().y)};i.on("pointertap",()=>{V.emit("ON_CHARACTER_INTERACTION_REQUEST",{action:"open",character:t})}),d();let l={x:t.position().x,y:t.position().y};return{view:i,update:()=>{if(i.visible=t.visible(),!t.isAlive()&&!o.label.includes("corpse")){X.play("audio/sfx/death.mp3",{category:"gameplay"}),o.label=`${t.id()}-corpse-sprite`,o.texture=$.from("corpse.png").texture;return}const c=t.position();if(l.x!==c.x||l.y!==c.y){const h=l.x>c.x,r=l.x!==c.x;if(l={x:c.x,y:c.y},e(),!r)return;h?(i.scale.x=1,i.pivot.x=0):(i.scale.x=-1,i.pivot.x=60)}}}},ji=({viewModel:n,onUnlocked:t})=>{const e=new O;e.label="settlement-view";const i=$.from("settlement.png");let s=0,o=0;n.positions().forEach(l=>{l.x>=s&&(s=l.x),l.y>=o&&(o=l.y)}),i.width=(s-n.positions()[0].x+1)*64,i.height=(o-n.positions()[0].y+1)*64;const d=$.from("blocked.png");return d.width=i.width,d.height=i.height,d.visible=!n.isUnlocked(),e.addChild(i,d),e.eventMode="none",ut(()=>{ft(()=>{e.visible=n.isVisible(),d.visible&&n.isUnlocked()&&t(),d.visible=!n.isUnlocked()})},e),{view:e}},Zi=(n,t,e)=>{n.alpha=0,n.visible=!0,Z.to(n,{alpha:1,duration:t/1e3,onComplete:e})},Ki=(n,t,e)=>{Z.to(n,{alpha:0,duration:t/1e3,onComplete:()=>{n.visible=!1,e()}})},Ji=n=>{const{tileSize:t,viewModel:e}=n,i=new O;i.label="tile-view",i.eventMode="static";const s=e.type();let o=s;o==="wasteland"?o+=`-${Math.floor(Math.random()*2)}`:o==="forest"?o+=`-${Math.floor(Math.random()*2)}`:o==="settlement"&&(o="wasteland");const d=$.from(`${o}.png`);d.width=t,d.height=t;const l=Math.floor(Math.random()*100),a=l<=25?0:l<=50?1:l<=75?2:3;if(d.pivot.set(.5,.5),d.anchor.set(.5,.5),d.position.set(t/2,t/2),d.angle=a*90,o==="settlement"&&(d.visible=!1),i.addChild(d),!e.traversable()&&s!=="mountain"){const c=Math.floor(Math.random()*6),h=["dead-trees-0","dead-trees-1","dead-trees-2","dead-trees-3","dead-trees-4","dead-trees-1"][c],r=$.from(`${h}.png`);r.width=t*.8,r.height=t*.8,r.position.set(t*.1,t*.1),i.addChild(r)}if(e.hasMud()){const c=$.from("mud.png");c.width=t*.6,c.height=t*.6,c.position.set(t*.2,t*.2),c.alpha=.6,i.addChild(c)}if(e.hasGrass()){const c=$.from("dead-grass.png");c.width=t*.6,c.height=t*.6,c.alpha=1,c.position.set(t*.2,t*.2),i.addChild(c)}if(e.hasEyes()){const c=$.from("eyes.png");c.width=t*.8,c.height=t*.8,c.position.set(t*.1,t*.1),c.alpha=0,i.addChild(c);const h=async()=>{await new Promise(r=>{setTimeout(()=>r(),(c.alpha===1?Math.random()*2e3:Math.random()*5e3)+2e3)}),c.alpha===0?Zi(c,1e3,h):Ki(c,1e3,h)};h()}return i.on("pointertap",()=>{V.emit("ON_TILE_INTERACTION",{tileViewModel:e})}),ut(()=>{ft(()=>{i.visible=e.visible()})},i),{view:i}},tn=n=>{const{viewModel:t,tileSize:e}=n,i=new O;return i.label="tile-map-view",i.sortableChildren=!0,t.tiles().forEach((o,d)=>{o.forEach((l,a)=>{const c=Ji({tileSize:e,viewModel:l});c.view.label=`tile-${d}-${a}`,c.view.position.set(d*e,a*e),i.addChild(c.view)})}),{view:i}},en=n=>{const{viewModel:t}=n,e=new O,i=[],s=64,o=new Map,d=f=>{const p=f.health(),u=f.maxHealth(),g=p/u,y=s*g,{x:w,y:b}=f.position();let _=o.get(f);_?_.clear():_=new J,_.clear(),_.rect(w*s,b*s-10,s,5),_.fill(0),_.rect(w*s,b*s-10,y,5),_.fill(65280),_.label=`${f.name()}-health-bar`,e.addChild(_),o.set(f,_),Z.to(_,{alpha:0,duration:1,delay:1,onComplete:()=>{e.removeChild(_),_.destroy(),o.delete(f)}})},l=(f,p)=>({x:(f.x+p.x)/2,y:(f.y+p.y)/2}),a=f=>{const p=f.position(),u=$.from("blood.png");u.width=s,u.height=s,u.position.set(p.x*s,p.y*s),e.addChild(u),f.armour()>0?(u.tint="blue",X.play("audio/sfx/collect.wav",{category:"gameplay"})):(X.play("audio/sfx/fists.mp3",{category:"gameplay"}),d(f)),Z.to(u,{alpha:0,duration:.333,ease:"power2.inOut",onComplete:()=>{e.removeChild(u),u.destroy()}})},c=async({source:f,target:p})=>{const u=$.from("slash.png");u.scale.set(.15),u.anchor.set(.5),u.position.set(l(f.position(),p.position()).x*64+32,l(f.position(),p.position()).y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),u.alpha=0,await Z.to(u,{alpha:1,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),a(p)},h=async({source:f,target:p})=>{const u=$.from("arrow.png");u.scale.set(.1),u.anchor.set(.5),u.position.set(f.position().x*64+32,f.position().y*64+32),u.rotation=Math.atan2(p.position().y-f.position().y,p.position().x-f.position().x),e.addChild(u),await Z.to(u.position,{x:p.position().x*64+32,y:p.position().y*64+32,duration:.5,onComplete:()=>{e.removeChild(u),t.clearAttack()}}),a(p)},r=async()=>{for(;i.length>0;){const f=i.shift();f&&await f()}};return ut(()=>{ft(()=>{const f=t.isAttacking();f&&(f.type==="ranged"?i.push(()=>h(f)):i.push(()=>c(f)))})}),{view:e,process:r}},nn=n=>{const{attackVM:t,tileMapVM:e,playerVM:i,tileSize:s,npcVMs:o,eventVMs:d,settlementVMs:l}=n,a=new O,c=new O,h=new O,r=new O,f=new O,p=en({viewModel:t});a.label="game-view-container",c.label="event-container",h.label="npc-container",r.label="tile-container",f.label="talk-overlay";const u=new Map,g=Xi({cellSize:s,npcVMs:o}),y=new Map;let w=null,b=null,_=[],E=[],M=[];const A=[];let I=!1;const T=R=>{const S=ke({viewModel:R,onStep:()=>{R.position().distanceTo(i.position())<6&&X.play("audio/sfx/step.mp3",{category:"gameplay"})}});o.push(R),h.addChild(S.view),_.push(S)},m=()=>{b=tn({viewModel:e,tileSize:s}),b.view.label="tile-map-view",w=Qi({viewModel:i}),r.addChild(b.view),d.map(R=>{const S=Yi({viewModel:R});E.push(S),c.addChild(S.view)}),_=o.map(R=>{const S=ke({viewModel:R,onStep:()=>{R.position().distanceTo(i.position())<6&&X.play("audio/sfx/step.mp3",{category:"gameplay"})}});return h.addChild(S.view),S}),l.map(R=>{const S=ji({viewModel:R,onUnlocked:()=>{Y("city-key",R.getMiddleTopPosition())}});M.push(S),c.addChild(S.view),S.view.position.set(R.positions()[0].x*s,R.positions()[0].y*s)}),a.addChild(r,c,h,w.view,g.view,f,p.view)},x=()=>{I=!0,A.forEach(R=>R.kill()),b==null||b.view.destroy({children:!0}),w==null||w.view.destroy({children:!0}),c.removeChildren(),h.removeChildren(),f.removeChildren(),b=null,w=null,_.forEach(R=>R.view.destroy({children:!0})),_=[],E.forEach(R=>R.view.destroy({children:!0})),E=[],M.forEach(R=>R.view.destroy({children:!0})),M=[],u.clear(),a.destroy({children:!0})},v=["snow","lightskyblue","lime","yellow","fuchsia","orange"],C=()=>{const R=["snow","lightskyblue","lime","yellow","fuchsia","orange"];return v.length===0&&v.push(...R),v.splice(Math.floor(Math.random()*v.length),1)[0]},k=R=>{const{x:L,y:U}=R.position(),D=new _t;if(u.get(R.id()))return;D.style={fontFamily:"alagard",fontSize:32,fill:C(),align:"center",dropShadow:!0,stroke:"black",wordWrap:!0,wordWrapWidth:innerWidth*1.5},D.text=R.dialogue(),D.anchor.set(.5);let H=0;const K=L*s+s/2,st=U*s-s;return D.position.set(K,st),u.forEach(P=>{D.getBounds().containsPoint(P.position.x,P.position.y)&&(H+=P.height),D.position.set(K,st-H)}),D.label="text-box",a.addChild(D),setTimeout(()=>{const P=u.get(R.id());P&&(a.removeChild(P),u.delete(R.id()),P.destroy())},2e3),u.set(R.id(),D),D},N=(R,S)=>{const{x:L,y:U}=S,D=L*s,q=U*s;A.push(Z.to(R.view.position,{x:D,y:q,duration:.2,ease:"power2.inOut",onComplete:()=>{R.view.position.set(D,q)}}))},B=async()=>{if(I)return;const{x:R,y:S}=i.position();w&&(w.update(),(w.view.position.x!==R*s||w.view.position.y!==S*s)&&N(w,{x:R,y:S})),await p.process();for(const L of _){const U=_.indexOf(L),{x:D,y:q}=o[U].position();L.update(),(L.view.position.x!==D*s||L.view.position.y!==q*s)&&N(L,{x:D,y:q})}E.forEach((L,U)=>{const{x:D,y:q}=d[U].position();L.view.position.set(D*s,q*s)}),g.update()},Y=async(R,S)=>{const L=new O;L.label="looted-icon-container",a.addChild(L);const U=$.from(`${R}.png`);U.width=s/2,U.height=s/2;const D=new J;D.circle(s*.25,s*.25,s/2),D.fill("khaki"),L.addChild(D,U),L.position.set(S.x*s+L.width*.25,S.y*s-s);const q=y.get(`${{x:S.x,y:S.y}}`)??0;y.set(`${{x:S.x,y:S.y}}`,q+1),await Z.delayedCall(.2*q,()=>{}),Z.to(L.position,{y:L.position.y-s*4,duration:1,delay:q*.1,ease:"power2.inOut",onComplete:()=>{a.removeChild(L),L.destroy({children:!0});const H=y.get(`${{x:S.x,y:S.y}}`)??0;H>1?y.set(`${{x:S.x,y:S.y}}`,H-1):y.delete(`${{x:S.x,y:S.y}}`)}})};return m(),B(),{view:a,addNpc:T,animateIconFloat:Y,handleEndOfTurnUpdates:B,createTextBox:k,destroy:x}};var Jt={},Et={},Ie;function zt(){if(Ie)return Et;Ie=1,Object.defineProperty(Et,"__esModule",{value:!0}),Et.Collector=void 0;let n=class{constructor(e){this.emit=(...i)=>{e.emitCollecting(this,i)}}};return Et.Collector=n,Et}var St={},_e;function sn(){if(_e)return St;_e=1,Object.defineProperty(St,"__esModule",{value:!0}),St.CollectorArray=void 0;const n=zt();let t=class extends n.Collector{constructor(){super(...arguments),this.result=[]}handleResult(i){return this.result.push(i),!0}getResult(){return this.result}reset(){this.result.length=0}};return St.CollectorArray=t,St}var At={},Me;function on(){if(Me)return At;Me=1,Object.defineProperty(At,"__esModule",{value:!0}),At.CollectorLast=void 0;const n=zt();let t=class extends n.Collector{handleResult(i){return this.result=i,!0}getResult(){return this.result}reset(){delete this.result}};return At.CollectorLast=t,At}var Pt={},Ee;function rn(){if(Ee)return Pt;Ee=1,Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.CollectorUntil0=void 0;const n=zt();let t=class extends n.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,this.result}getResult(){return this.result}reset(){this.result=!1}};return Pt.CollectorUntil0=t,Pt}var Nt={},Se;function an(){if(Se)return Nt;Se=1,Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.CollectorWhile0=void 0;const n=zt();let t=class extends n.Collector{constructor(){super(...arguments),this.result=!1}handleResult(i){return this.result=i,!this.result}getResult(){return this.result}reset(){this.result=!1}};return Nt.CollectorWhile0=t,Nt}var Rt={},Vt={},Ae;function ln(){if(Ae)return Vt;Ae=1,Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.SignalConnectionImpl=void 0;class n{constructor(e,i){this.link=e,this.parentCleanup=i}disconnect(){return this.link!==null?(this.link.unlink(),this.link=null,this.parentCleanup(),this.parentCleanup=null,!0):!1}set enabled(e){this.link&&this.link.setEnabled(e)}get enabled(){return this.link!==null&&this.link.isEnabled()}}return Vt.SignalConnectionImpl=n,Vt}var Lt={},Pe;function cn(){if(Pe)return Lt;Pe=1,Object.defineProperty(Lt,"__esModule",{value:!0}),Lt.SignalLink=void 0;let n=class Je{constructor(e=null,i=null,s=0){this.enabled=!0,this.newLink=!1,this.callback=null,this.prev=e??this,this.next=i??this,this.order=s}isEnabled(){return this.enabled&&!this.newLink}setEnabled(e){this.enabled=e}unlink(){this.callback=null,this.next.prev=this.prev,this.prev.next=this.next}insert(e,i){let s=this.prev;for(;s!==this&&!(s.order<=i);)s=s.prev;const o=new Je(s,s.next,i);return o.callback=e,s.next=o,o.next.prev=o,o}};return Lt.SignalLink=n,Lt}var Ne;function hn(){if(Ne)return Rt;Ne=1,Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.Signal=void 0;const n=ln(),t=cn();let e=class{constructor(){this.head=new t.SignalLink,this.hasNewLinks=!1,this.emitDepth=0,this.connectionsCount=0}getConnectionsCount(){return this.connectionsCount}hasConnections(){return this.connectionsCount>0}connect(s,o=0){this.connectionsCount++;const d=this.head.insert(s,o);return this.emitDepth>0&&(this.hasNewLinks=!0,d.newLink=!0),new n.SignalConnectionImpl(d,()=>this.decrementConnectionCount())}decrementConnectionCount(){this.connectionsCount--}disconnect(s){for(let o=this.head.next;o!==this.head;o=o.next)if(o.callback===s)return this.decrementConnectionCount(),o.unlink(),!0;return!1}disconnectAll(){for(;this.head.next!==this.head;)this.head.next.unlink();this.connectionsCount=0}emit(...s){this.emitDepth++;for(let o=this.head.next;o!==this.head;o=o.next)o.isEnabled()&&o.callback&&o.callback.apply(null,s);this.emitDepth--,this.unsetNewLink()}emitCollecting(s,o){this.emitDepth++;for(let d=this.head.next;d!==this.head;d=d.next)if(d.isEnabled()&&d.callback){const l=d.callback.apply(null,o);if(!s.handleResult(l))break}this.emitDepth--,this.unsetNewLink()}unsetNewLink(){if(this.hasNewLinks&&this.emitDepth===0){for(let s=this.head.next;s!==this.head;s=s.next)s.newLink=!1;this.hasNewLinks=!1}}};return Rt.Signal=e,Rt}var Bt={},Re;function dn(){if(Re)return Bt;Re=1,Object.defineProperty(Bt,"__esModule",{value:!0}),Bt.SignalConnections=void 0;let n=class{constructor(){this.list=[]}add(e){this.list.push(e)}disconnectAll(){for(const e of this.list)e.disconnect();this.list=[]}getCount(){return this.list.length}isEmpty(){return this.list.length===0}};return Bt.SignalConnections=n,Bt}var Ve;function un(){return Ve||(Ve=1,function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.SignalConnections=n.Signal=n.CollectorWhile0=n.CollectorUntil0=n.CollectorLast=n.CollectorArray=n.Collector=void 0;var t=zt();Object.defineProperty(n,"Collector",{enumerable:!0,get:function(){return t.Collector}});var e=sn();Object.defineProperty(n,"CollectorArray",{enumerable:!0,get:function(){return e.CollectorArray}});var i=on();Object.defineProperty(n,"CollectorLast",{enumerable:!0,get:function(){return i.CollectorLast}});var s=rn();Object.defineProperty(n,"CollectorUntil0",{enumerable:!0,get:function(){return s.CollectorUntil0}});var o=an();Object.defineProperty(n,"CollectorWhile0",{enumerable:!0,get:function(){return o.CollectorWhile0}});var d=hn();Object.defineProperty(n,"Signal",{enumerable:!0,get:function(){return d.Signal}});var l=dn();Object.defineProperty(n,"SignalConnections",{enumerable:!0,get:function(){return l.SignalConnections}})}(Jt)),Jt}var Le=un(),fn=Object.defineProperty,pn=(n,t,e)=>t in n?fn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Ot=(n,t,e)=>pn(n,typeof t!="symbol"?t+"":t,e);class mn extends O{constructor(t){var e;super(),Ot(this,"options"),Ot(this,"view"),Ot(this,"_type"),Ot(this,"_maxWidth"),Ot(this,"children",[]),t&&(t.maxWidth&&(this._maxWidth=t.maxWidth),this.init(t)),(e=t==null?void 0:t.items)==null||e.forEach(i=>this.addChild(i)),this.on("added",()=>this.arrangeChildren()),this.on("childAdded",()=>this.arrangeChildren())}init(t){this.options=t,t!=null&&t.type&&(this.type=t.type),t!=null&&t.children&&t.children.forEach(e=>this.addChild(e))}set type(t){this._type=t,this.arrangeChildren()}get type(){return this._type}set elementsMargin(t){if(!this.options)throw new Error("List has not been initiated!");this.options.elementsMargin=t,this.arrangeChildren()}get elementsMargin(){var t;return((t=this.options)==null?void 0:t.elementsMargin)??0}set padding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.padding=t,this.options.vertPadding=t,this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get padding(){var t;return((t=this.options)==null?void 0:t.padding)??0}set vertPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.vertPadding=t,this.options.topPadding=t,this.options.bottomPadding=t,this.arrangeChildren()}get vertPadding(){var t;return((t=this.options)==null?void 0:t.vertPadding)??this.padding??0}set horPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.horPadding=t,this.options.leftPadding=t,this.options.rightPadding=t,this.arrangeChildren()}get horPadding(){var t;return((t=this.options)==null?void 0:t.horPadding)??this.padding??0}set leftPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.leftPadding=t,this.arrangeChildren()}get leftPadding(){var t;return((t=this.options)==null?void 0:t.leftPadding)??this.horPadding}set rightPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.rightPadding=t,this.arrangeChildren()}get rightPadding(){var t;return((t=this.options)==null?void 0:t.rightPadding)??this.horPadding}set topPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.topPadding=t,this.arrangeChildren()}get topPadding(){var t;return((t=this.options)==null?void 0:t.topPadding)??this.vertPadding}set bottomPadding(t){if(!this.options)throw new Error("List has not been initiated!");this.options.bottomPadding=t,this.arrangeChildren()}get bottomPadding(){var t;return((t=this.options)==null?void 0:t.bottomPadding)??this.vertPadding}arrangeChildren(){var d,l;let t=0,e=this.leftPadding,i=this.topPadding;const s=((d=this.options)==null?void 0:d.elementsMargin)??0;let o=this.maxWidth??((l=this.parent)==null?void 0:l.width);this.rightPadding&&(o-=this.rightPadding),this.children.forEach((a,c)=>{switch(this.type){case"vertical":a.y=i,a.x=e,i+=s+a.height;break;case"horizontal":a.x=e,a.y=i,e+=s+a.width;break;case"bidirectional":default:a.x=e,a.y=i,a.x+a.width>o&&c>0&&(i+=s+t,e=this.leftPadding,a.x=e,a.y=i,t=0),t=Math.max(t,a.height),e+=s+a.width;break}})}removeItem(t){const e=this.children[t];e&&(this.removeChild(e),this.arrangeChildren())}set maxWidth(t){this._maxWidth=t,this.arrangeChildren()}get maxWidth(){return this._maxWidth}}var gn=Object.defineProperty,yn=(n,t,e)=>t in n?gn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Wt=(n,t,e)=>yn(n,typeof t!="symbol"?t+"":t,e);class vn{constructor(t={}){Wt(this,"x"),Wt(this,"ax"),Wt(this,"dx"),Wt(this,"tx"),Wt(this,"_options"),this.x=0,this.ax=0,this.dx=0,this.tx=0,this._options=t,this._options.max=t.max||160,this._options.damp=t.damp||.8,this._options.springiness=t.springiness||.1}update(){this.ax=(this.tx-this.x)*this._options.springiness,this.dx+=this.ax,this.dx*=this._options.damp,this.dx<-this._options.max?this.dx=-this._options.max:this.dx>this._options.max&&(this.dx=this._options.max),this.x+=this.dx}reset(){this.x=0,this.ax=0,this.dx=0,this.tx=0}get max(){return this._options.max}set max(t){this._options.max=t}get damp(){return this._options.damp}set damp(t){this._options.damp=t}get springiness(){return this._options.springiness}set springiness(t){this._options.springiness=t}}var wn=Object.defineProperty,xn=(n,t,e)=>t in n?wn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,It=(n,t,e)=>xn(n,typeof t!="symbol"?t+"":t,e);class bn{constructor(){It(this,"done"),It(this,"to"),It(this,"_spring"),It(this,"_pos"),It(this,"_speed"),It(this,"_correctSpeed"),this._spring=new vn,this._pos=0,this.to=0}start(t,e,i){this._speed=t,this._pos=e,this.to=i,this.done=!1,this._spring.x=this._pos,this._spring.tx=this.to;const s=this.to-this._pos,o=Math.abs(s)/s,d=Math.abs(this._speed)/this._speed;o!==d?this._correctSpeed=!0:this._correctSpeed=!1}update(){if(this._correctSpeed)this._speed*=.6,Math.abs(this._speed)<2&&(this._correctSpeed=!1),this._pos+=this._speed,this._spring.x=this._pos;else{const t=this.to-this._pos;Math.abs(t)<.05?(this._pos=this.to,this.done=!0):(this._spring.tx=this.to,this._spring.update(),this._pos=this._spring.x)}return this._pos}cancel(){}}var Cn=Object.defineProperty,Tn=(n,t,e)=>t in n?Cn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,ot=(n,t,e)=>Tn(n,typeof t!="symbol"?t+"":t,e);class Be{constructor(t={}){ot(this,"position",0),ot(this,"constrain",!0),ot(this,"min",0),ot(this,"max",0),ot(this,"maxSpeed",400),ot(this,"_ease"),ot(this,"_offset",0),ot(this,"_prev",0),ot(this,"_speed",0),ot(this,"_hasStopped"),ot(this,"_targetSpeed",0),ot(this,"_speedChecker",0),ot(this,"_grab",0),ot(this,"_activeEase"),this.constrain=t.constrain??!0,this.maxSpeed=t.maxSpeed??400,this._ease=t.ease??new bn}set value(t){this._speed=0,this.position=t}get value(){return this.position}grab(t){this._grab=t,this._offset=this.position-t,this._speedChecker=0,this._targetSpeed=this._speed=0,this._hasStopped=!1}hold(t){this._speedChecker++,this.position=t+this._offset,this._speedChecker>1&&(this._targetSpeed=this.position-this._prev),this._speed+=(this._targetSpeed-this._speed)/2,this._speed>this.maxSpeed?this._speed=this.maxSpeed:this._speed<-this.maxSpeed&&(this._speed=-this.maxSpeed),this._prev=this.position,this.constrain&&(this._activeEase=null,this.position>this.min?this.position-=(this.position-this.min)/1.5:this.position<this.max&&(this.position+=(this.max-this.position)/1.5))}slide(t=!1){this._hasStopped||(this.constrain?this._updateConstrain(t):this._updateDefault())}get moveAmount(){return-(this.position-this._offset-this._grab)}_updateDefault(){this._speed*=.9,this.position+=this._speed,(this._speed<0?this._speed*-1:this._speed)<.01&&(this._hasStopped=!0)}_updateConstrain(t=!1){const e=this.max;t?(this.value>0&&(this.value=0),this.value>0&&(this.value=0),this.value<this.max&&(this.value=this.max),this.value<this.max&&(this.value=this.max)):this.position>this.min||this.position<e||this._activeEase?(this._activeEase||(this._activeEase=this._ease,this.position>this.min?this._activeEase.start(this._speed,this.position,this.min):this._activeEase.start(this._speed,this.position,e)),this.position=this._activeEase.update(),this._activeEase.done&&(this.position=this._activeEase.to,this._speed=0,this._activeEase=null)):this._updateDefault()}}var kn=Object.defineProperty,In=(n,t,e)=>t in n?kn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,xt=(n,t,e)=>In(n,typeof t!="symbol"?t+"":t,e);class _n{constructor(t){xt(this,"xAxis"),xt(this,"yAxis"),xt(this,"_isDown"),xt(this,"_globalPosition"),xt(this,"_frame"),xt(this,"_bounds"),xt(this,"_dirty"),xt(this,"disableEasing",!1),this.xAxis=new Be({ease:t.xEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.yAxis=new Be({ease:t.yEase,maxSpeed:t.maxSpeed,constrain:t.constrain}),this.disableEasing=t.disableEasing??!1,this._frame=new ee,this._bounds=new ee,this._globalPosition=new oi}pointerDown(t){this._globalPosition=t,this.xAxis.grab(t.x),this.yAxis.grab(t.y),this._isDown=!0}pointerUp(){this._isDown=!1}pointerMove(t){this._globalPosition=t}update(){this._dirty&&(this._dirty=!1,this.xAxis.min=this._bounds.left,this.xAxis.min=this._bounds.right-this._frame.width,this.xAxis.min=this._bounds.top,this.xAxis.min=this._bounds.bottom-this._frame.height),this._isDown?(this.xAxis.hold(this._globalPosition.x),this.yAxis.hold(this._globalPosition.y)):(this.xAxis.slide(this.disableEasing),this.yAxis.slide(this.disableEasing))}resize(t,e){this._frame.x=0,this._frame.width=t,this._frame.y=0,this._frame.height=e,this._dirty=!0}setBounds(t,e,i,s){this._bounds.x=t,this._bounds.width=e-t,this._bounds.y=i,this._bounds.height=s-i,this._dirty=!0}get x(){return this.xAxis.value}get y(){return this.yAxis.value}}var Mn=Object.defineProperty,En=(n,t,e)=>t in n?Mn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,j=(n,t,e)=>En(n,typeof t!="symbol"?t+"":t,e);class le extends O{constructor(t){super(),j(this,"background"),j(this,"borderMask"),j(this,"lastWidth"),j(this,"lastHeight"),j(this,"_width",0),j(this,"_height",0),j(this,"_dimensionChanged",!1),j(this,"list"),j(this,"_trackpad"),j(this,"isDragging",0),j(this,"interactiveStorage",[]),j(this,"visibleItems",[]),j(this,"pressedChild"),j(this,"ticker",ri.shared),j(this,"options"),j(this,"stopRenderHiddenItemsTimeout"),j(this,"onMouseScrollBinding",this.onMouseScroll.bind(this)),j(this,"dragStarTouchPoint"),j(this,"isOver",!1),j(this,"proximityRange"),j(this,"proximityStatusCache",[]),j(this,"lastScrollX"),j(this,"lastScrollY"),j(this,"proximityCheckFrameCounter",0),j(this,"onProximityChange",new Le.Signal),j(this,"onScroll",new Le.Signal),t&&this.init(t),this.ticker.add(this.update,this)}init(t){this.options=t,this.setBackground(t.background),this._width=t.width|this.background.width,this._height=t.height|this.background.height,this.proximityRange=t.proximityRange??0,this.list||(this.list=new mn,super.addChild(this.list)),this.list.init({type:t.type,elementsMargin:t.elementsMargin,padding:t.padding,vertPadding:t.vertPadding,horPadding:t.horPadding,topPadding:t.topPadding,bottomPadding:t.bottomPadding,leftPadding:t.leftPadding,rightPadding:t.rightPadding}),this.addItems(t.items),this.hasBounds&&(this.addMask(),this.makeScrollable()),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.options.globalScroll=t.globalScroll??!0,this.options.shiftScroll=t.shiftScroll??!1,this.resize()}get hasBounds(){return!!this._width||!!this._height}addItems(t){t!=null&&t.length&&t.forEach(e=>this.addItem(e))}removeItems(){this.proximityStatusCache.length=0,this.list.removeChildren()}addItem(...t){if(t.length>1)t.forEach(e=>this.addItem(e));else{const e=t[0];(!e.width||!e.height)&&console.error("ScrollBox item should have size"),e.eventMode="static",this.list.addChild(e),this.proximityStatusCache.push(!1),this.options.disableDynamicRendering||(e.renderable=this.isItemVisible(e))}return this.resize(),t[0]}removeItem(t){this.list.removeItem(t),this.proximityStatusCache.splice(t,1),this.resize()}isItemVisible(t,e=0){let i=!1;const s=this.list;if(this.isVertical||this.isBidirectional){const o=t.y+s.y;o+t.height>=-e&&o<=this.options.height+e&&(i=!0)}if(this.isHorizontal||this.isBidirectional){const o=t.x+s.x;o+t.width>=-e&&o<=this.options.width+e&&(i=!0)}return i}get items(){var t;return((t=this.list)==null?void 0:t.children)??[]}setBackground(t){this.background&&this.removeChild(this.background),this.options.background=t,this.background=new J,this.addChildAt(this.background,0),this.resize()}addMask(){this.borderMask||(this.borderMask=new J,super.addChild(this.borderMask),this.mask=this.borderMask),this.resize()}makeScrollable(){this._trackpad||(this._trackpad=new _n({disableEasing:this.options.disableEasing})),this.on("pointerdown",t=>{this.renderAllItems(),this.isDragging=1,this.dragStarTouchPoint=this.worldTransform.applyInverse(t.global),this._trackpad.pointerDown(this.dragStarTouchPoint);const e=this.list.worldTransform.applyInverse(t.global);this.visibleItems.forEach(i=>{i.x<e.x&&i.x+i.width>e.x&&i.y<e.y&&i.y+i.height>e.y&&(this.pressedChild=i)})}),this.on("pointerup",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("pointerover",()=>{this.isOver=!0}),this.on("pointerout",()=>{this.isOver=!1}),this.on("pointerupoutside",()=>{this.isDragging=0,this._trackpad.pointerUp(),this.restoreItemsInteractivity(),this.pressedChild=null,this.stopRenderHiddenItems()}),this.on("globalpointermove",t=>{var i,s;if(!this.isDragging)return;const e=this.worldTransform.applyInverse(t.global);if(this.dragStarTouchPoint){const o=this.options.dragTrashHold??10;if(this.isHorizontal||this.isBidirectional){const d=e.x-this.dragStarTouchPoint.x;Math.abs(d)>o&&(this.isDragging=2)}if(this.isVertical||this.isBidirectional){const d=e.y-this.dragStarTouchPoint.y;Math.abs(d)>o&&(this.isDragging=2)}}this.dragStarTouchPoint&&this.isDragging!==2||(this._trackpad.pointerMove(e),this.pressedChild&&(this.revertClick(this.pressedChild),this.pressedChild=null),this.isBidirectional?(i=this.onScroll)==null||i.emit({x:this.scrollX,y:this.scrollY}):(s=this.onScroll)==null||s.emit(this.isVertical?this.scrollY:this.scrollX))}),document.addEventListener("wheel",this.onMouseScrollBinding,!0)}setInteractive(t){this.eventMode=t?"static":"auto"}get listHeight(){return this.list.height+this.list.topPadding+this.list.bottomPadding}get listWidth(){return this.list.width+this.list.leftPadding+this.list.rightPadding}resize(t=!1){if(this.hasBounds){if(this.renderAllItems(),this.borderMask&&(t||this._dimensionChanged||this.lastWidth!==this.listWidth||this.lastHeight!==this.listHeight)){this.options.width||(this._width+=this.listWidth),this.options.height||(this._height+=this.listHeight),this.borderMask.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill(16711935).stroke(0),this.borderMask.eventMode="none";const e=this.options.background;this.background.clear().roundRect(0,0,this._width,this._height,this.options.radius|0).fill({color:e??0,alpha:e?1:1e-7}),this.isBidirectional?this.setInteractive(this.listWidth>this._width||this.listHeight>this._height):this.isHorizontal?this.setInteractive(this.listWidth>this._width):this.setInteractive(this.listHeight>this._height),this.lastWidth=this.listWidth,this.lastHeight=this.listHeight}if(this._trackpad){const e=this.borderMask.width-this.list.width-this.list.leftPadding-this.list.rightPadding,i=this.borderMask.height-this.list.height-this.list.topPadding-this.list.bottomPadding;this.isBidirectional?(this._trackpad.yAxis.max=-Math.abs(i),this._trackpad.xAxis.max=-Math.abs(e)):this.isVertical?this._trackpad.yAxis.max=-Math.abs(i):this.isHorizontal&&(this._trackpad.xAxis.max=-Math.abs(e))}this._dimensionChanged?(this.list.arrangeChildren(),this.stopRenderHiddenItems(),this._dimensionChanged=!1):(t&&this.list.arrangeChildren(),this.updateVisibleItems()),this.lastScrollX=null,this.lastScrollY=null}}onMouseScroll(t){var o,d,l;if(!this.isOver&&!this.options.globalScroll)return;this.renderAllItems();const e=!!this.options.shiftScroll,i=e?typeof t.deltaX<"u"||typeof t.deltaY<"u":typeof t.deltaX<"u",s=typeof t.deltaY<"u";if((this.isHorizontal||this.isBidirectional)&&i){const a=e||this.isBidirectional?t.deltaX:t.deltaY,c=this.list.x-a;if(this.listWidth<this._width)this._trackpad.xAxis.value=0;else{const h=this._width-this.listWidth,r=0;this._trackpad.xAxis.value=Math.min(r,Math.max(h,c))}}if((this.isVertical||this.isBidirectional)&&s){const a=this.list.y-t.deltaY;if(this.listHeight<this._height)this._trackpad.yAxis.value=0;else{const c=this._height-this.listHeight,h=0;this._trackpad.yAxis.value=Math.min(h,Math.max(c,a))}}this.isBidirectional&&(i||s)?(o=this.onScroll)==null||o.emit({x:this._trackpad.xAxis.value,y:this._trackpad.yAxis.value}):this.isHorizontal&&i?(d=this.onScroll)==null||d.emit(this._trackpad.xAxis.value):this.isVertical&&s&&((l=this.onScroll)==null||l.emit(this._trackpad.yAxis.value)),this.stopRenderHiddenItems()}scrollBottom(){this.interactive?this.scrollTo(this.list.children.length-1):this.scrollTop()}scrollTop(){this.renderAllItems(),this._trackpad.xAxis.value=0,this._trackpad.yAxis.value=0,this.stopRenderHiddenItems()}renderAllItems(){clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null,!this.options.disableDynamicRendering&&this.items.forEach(t=>{t.renderable=!0})}stopRenderHiddenItems(){this.options.disableDynamicRendering||(this.stopRenderHiddenItemsTimeout&&(clearTimeout(this.stopRenderHiddenItemsTimeout),this.stopRenderHiddenItemsTimeout=null),this.stopRenderHiddenItemsTimeout=setTimeout(()=>this.updateVisibleItems(),2e3))}updateVisibleItems(){this.visibleItems.length=0,this.items.forEach(t=>{t.renderable=this.isItemVisible(t),this.visibleItems.push(t)})}scrollTo(t){if(!this.interactive)return;const e=this.list.children[t];e&&(this.renderAllItems(),this._trackpad.xAxis.value=this.isHorizontal||this.isBidirectional?this._width-e.x-e.width-this.list.rightPadding:0,this._trackpad.yAxis.value=this.isVertical||this.isBidirectional?this._height-e.y-e.height-this.list.bottomPadding:0,this.stopRenderHiddenItems())}scrollToPosition({x:t,y:e}){t===void 0&&e===void 0||(this.renderAllItems(),t!==void 0&&(this.scrollX=-t),e!==void 0&&(this.scrollY=-e),this.stopRenderHiddenItems())}get height(){return this._height}set height(t){this._height=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}get width(){return this._width}set width(t){this._width=t,this._dimensionChanged=!0,this.resize(),this.scrollTop()}setSize(t,e){typeof t=="object"?(e=t.height??t.width,t=t.width):e=e??t,this._width=t,this._height=e,this._dimensionChanged=!0,this.resize(),this.scrollTop()}getSize(t){return t=t||{width:0,height:0},t.width=this._width,t.height=this._height,t}get scrollX(){return this._trackpad.xAxis.value}set scrollX(t){this._trackpad.xAxis.value=t}get scrollY(){return this._trackpad.yAxis.value}set scrollY(t){this._trackpad.yAxis.value=t}update(){this.list&&(this._trackpad.update(),(this.isHorizontal||this.isBidirectional)&&this.list.x!==this._trackpad.x&&(this.list.x=this._trackpad.x),(this.isVertical||this.isBidirectional)&&this.list.y!==this._trackpad.y&&(this.list.y=this._trackpad.y),!this.options.disableProximityCheck&&(this._trackpad.x!==this.lastScrollX||this._trackpad.y!==this.lastScrollY)&&(this.proximityCheckFrameCounter++,this.proximityCheckFrameCounter>=(this.options.proximityDebounce??10)&&(this.items.forEach((t,e)=>{const i=this.isItemVisible(t,this.proximityRange),s=this.proximityStatusCache[e];i!==s&&(this.proximityStatusCache[e]=i,this.onProximityChange.emit({item:t,index:e,inRange:i}))}),this.lastScrollX=this._trackpad.x,this.lastScrollY=this._trackpad.y,this.proximityCheckFrameCounter=0)))}destroy(t){this.ticker.remove(this.update,this),document.removeEventListener("wheel",this.onMouseScrollBinding,!0),this.background.destroy(),this.list.destroy(),super.destroy(t)}restoreItemsInteractivity(){this.interactiveStorage.forEach(t=>{t.item.eventMode=t.eventMode}),this.interactiveStorage.length=0}revertClick(t){t.eventMode!=="auto"&&(ai.any?t.emit("pointerupoutside",null):t.emit("mouseupoutside",null),this.interactiveStorage.push({item:t,eventMode:t.eventMode}),t.eventMode="auto"),t instanceof O&&t.children&&t.children.forEach(e=>this.revertClick(e))}get scrollHeight(){return this.list.height}get scrollWidth(){return this.list.width}get isVertical(){return(this.options.type??"vertical")==="vertical"}get isHorizontal(){return this.options.type==="horizontal"}get isBidirectional(){return this.options.type==="bidirectional"}}const Sn=()=>{const n=document.createElement("canvas");n.width=256,n.height=1;const t=n.getContext("2d"),e=t.createLinearGradient(0,0,n.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,n.width,1),ze.from(n)},Oe=(n,t)=>{const e=new O,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},s=new _t,o=new J;s.text=n,s.style=i;const d=()=>{o.clear(),o.roundRect(s.x-10,s.y,s.width+20,s.height,10),o.fill("black"),o.alpha=.5};e.addChild(o,s);const l=a=>{s.text=a,d()};return d(),{view:e,updateText:l}},An=n=>{const t=Sn(),e=new $(t);return e.label="gradient-background",e.position.set(n.x,n.y-2.5),e.width=n.width+16,e.height=n.height+5,n.addChildAt(e,0),e},Ut=n=>{const{viewModel:t,includeItemValue:e,quantity:i}=n,s=n.itemValue,o=new O;let d=!1;o.label=`${t.name()}-view`,o.eventMode="static";const l=$.from(`${t.code()}.png`);l.width=50,l.height=50,o.addChild(l);const a=Oe(`${(i==null?void 0:i.toString())??t.quantity().toString()}`);a.view.position.set(l.width-a.view.width*.5,l.height);let c=null;e&&(c=Oe(`$ ${(s||t.value()).toString()}`,{fill:"gold"}),c.view.position.set(l.width-c.view.width*.5,0),o.addChild(c.view),l.position.set(0,c.view.height+5),a.view.position.set(l.width-a.view.width*.5,c.view.height+l.height));const h=l.y+l.height,r=(y,w)=>{const b=new O;return w()<=0||(d=!0,Array(w()).fill(0).forEach((_,E)=>{const M=$.from(`${y}-icon.png`);M.width=20,M.height=20,M.position.set(2.5+E*M.width*.5,0),b.addChildAt(M,0)}),An(b),b.position.set(0,h-b.height+14),o.addChild(b)),b};t.isArmourIconVisible()&&r("armour",t.armour);const f=new O;if(t.isHealthIconVisible()&&r("health",t.health),t.isDamageIconVisible()&&t.damage()>0&&t.range()>0){const y=r("damage",t.damage),w=r("range",t.range);w.position.set(y.x,y.y-w.height)}const p=$.from("armour-broken-icon.png");p.width=20,p.height=20,p.position.set(0,l.height-p.height),o.addChild(a.view,p,f),o.on("pointertap",()=>{u()}),d&&l.position.set(16,l.y);const u=()=>{t.interact(),X.play("audio/sfx/collect.wav",{category:"gameplay"})},g=ut(()=>{ft(()=>{a.updateText((i==null?void 0:i.toString())??t.quantity().toString()),p.visible=t.maxArmour()>0&&t.armour()<=0})});return o.on("destroy",()=>{g()}),{view:o,interact:u}},Pn=(n,t)=>{const i=new J;return i.roundRect(-2.5,-2.5,n.view.width+2.5*2,n.view.height+2.5,10),i.fill(t??"gray"),i.alpha=.8,i.eventMode="static",i},qt=(n,t)=>{const e=new O;e.addChild(n.view),e.label=`${n.view.label}-container`,e.eventMode="static";const i=Pn(n,t);return e.addChild(i,n.view),{container:e,background:i}},Nn=n=>{const t=new O,e=10;let i;t.label="global-inventory-view",t.eventMode="static";const s=Yt({text:n.ownerName(),fontSize:26}),o=innerWidth<innerHeight,d=new le({width:o?innerWidth:innerWidth*.8,height:o?innerHeight*.6:innerHeight*.8,padding:e,radius:10,elementsMargin:e}),l=ct({spriteName:"eye-icon",onClick:()=>{n.setInfoButtonEnabled(!n.isInfoButtonEnabled()),l.tint=n.isInfoButtonEnabled()?"lightgreen":"white"},disableFlicker:!0});t.addChild(l),d.label="global-inventory-scroll-box",d.position.set(0,s.height+e),t.addChild(d),t.visible=!1;const a=(u,g)=>g.weapon().id()===u.id()||g.bodyArmour().id()===u.id()||g.headArmour().id()===u.id()||g.feetArmour().id()===u.id(),c=u=>{u=u??!1,d.removeItems();const g=1;n.stacks().forEach(y=>{const w=Ut({viewModel:y.item,includeItemValue:u,quantity:y.quantity}),b=new O,_=n.owner?a(y.item,n.owner):!1,E=qt(w,_?"lightgreen":"gray");b.on("pointertap",()=>{A()}),b.addChild(E.background,E.container),b.label=`${w.view.label}-container`,d.addItem(b);const M=Math.min(g,Math.min((d.width-e*2)/b.width,(d.height-e*2)/b.height));b.scale.set(M),w.view.off("pointertap");const A=()=>{if(n.isInfoButtonEnabled()){i&&(t.removeChild(i),i=void 0),i=qe({title:y.item.name(),content:y.item.description(),type:y.item.type(),onClose:()=>{t.removeChild(i),i=void 0}}),i.position.set(t.width*.5,t.height*.5),t.addChild(i);return}w.interact();const I=b.tint;b.tint="green",setTimeout(()=>{b.tint=I},200)}})},h=(u=!1)=>{c(u),n.setInfoButtonEnabled(!1),X.play("audio/sfx/inventory-open.wav",{category:"gameplay"}),t.visible=!0},r=()=>{n.setInfoButtonEnabled(!1),V.emit("ON_CLOSE_INVENTORY_REQUESTED")},f=ct({spriteName:"exit-icon",onClick:()=>{n.setInfoButtonEnabled(!1),V.emit("ON_CLOSE_INVENTORY_REQUESTED")}});if(s.position.set(t.width*.5,s.height*.5),f.position.set(d.width-f.width,d.height+f.height*2),l.position.set(f.position.x-l.width-5,f.position.y),t.addChild(f,s),n.ownerName()!=="Hero"){const u=ct({spriteName:"take-all-icon",onClick:()=>{n.items().forEach(g=>{g.interact()}),X.play("audio/sfx/inventory-open.wav",{category:"gameplay"})},onClickAudio:""});u.position.set(0,f.y),t.addChild(u)}const p=Math.min(innerWidth/t.width,innerHeight/t.height);return t.scale.set(Math.min(.7,p)),ut(()=>{ft(()=>{n.isEmpty()&&r(),n.isInfoButtonEnabled()||i&&(t.removeChild(i),i=void 0),c()})},t),{view:t,show:h,hide:r}},Rn=n=>{const{viewModel:t}=n,e=new O;e.label="new-trade-view",e.alpha=0;const i=new J;i.label="new-trade-view-background",e.addChild(i);const s=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let o=!1;const d=({title:M,stacks:A,width:I,height:T,playerStacks:m,npcInv:x=!1,includeItemValue:v=!1,isTradeInv:C=!1})=>{const k=new O;k.label=`${M}-screen-view`;const N=Yt({text:M,onClick:()=>{}});N.label=`${M}-title-button`;const B=new le({width:I,height:T,padding:4,elementsMargin:2});B.label=`${M}-inventory-view`;const Y=new J;Y.label=`${M}-background`,k.addChild(Y,N,B);const R=(S,L,U)=>{const D=innerHeight>innerWidth;S.forEach(q=>{const H=Ut({viewModel:q.item,includeItemValue:v,itemValue:t.getItemPrice(q.item,U),quantity:q.quantity}),st=qt(H,L==="buy"||L==="buy-return"?"pink":"lightblue"),P=new O;H.view.off("pointertap"),P.on("pointertap",()=>{Q(),V.emit("ON_ITEM_INTERACTION",{itemViewModel:q.item,action:L}),o=!0}),P.addChild(st.container,H.view),P.label=`${H.view.label}-container`,B.addItem(P);const G=D?.6:.7;P.scale.set(Math.min(G,I/(H.view.width+10)),Math.min(G,T/(H.view.height+10)));const Q=()=>{P.tint=65280,setTimeout(()=>{P.tint=16777215},200)}})};return x?R(A,"buy",!0):C?(R(m||[],"sell-return",!1),R(A,"buy-return",!0)):R(A,"sell",!1),N.scale.set(.4),N.position.set(I*.5,N.height*.5),B.position.set(I*.5-B.width*.5,N.height+10),Y.rect(0,0,k.width,k.height),Y.label=`${M}-background-rect`,Y.fill("black"),Y.stroke("black"),k};let l=null,a=null,c=null,h=null,r=null,f=null,p=null,u=null,g=null,y=null;const w=()=>{l||a?b():X.play("audio/sfx/door.mp3");const{innerWidth:M,innerHeight:A}=window,I=A>M,T=I?M:M*.9*.3,m=I?A*.7*.3:A*.9;s(),r=ct({spriteName:"trade-icon",onClick:()=>{V.emit("ON_TRADE_REQUEST",{action:"autoTrade"}),o=!0},alpha:.8}),h=ct({spriteName:"exit-icon",onClick:()=>{V.emit("ON_CLOSE_INVENTORY_REQUESTED"),o=!0},alpha:.8});const x=()=>{y&&(e.removeChild(y),y.destroy(),y=null)},v=()=>{const N=t.value().quantity()<0?{type:"Insufficient Funds",content:"You do not have enough funds to complete this trade."}:{type:"Trade Imbalance",content:`Trader has insufficient funds, you will lose ${Math.abs(t.value().quantity())} scrap.`};y=qe({title:"Confirm Trade",type:N.type,content:N.content,onConfirm:t.value().quantity()>0?()=>{V.emit("ON_TRADE_REQUEST",{action:"submit"}),o=!0,x()}:void 0,onCancel:()=>{V.emit("ON_TRADE_REQUEST",{action:"clear"}),x(),o=!0}}),e.addChild(y),y.position.set(e.width*.5-y.width*.25,e.height*.5-y.height*.5)};f=ct({spriteName:"confirm-icon",onClick:()=>{V.emit("ON_TRADE_REQUEST",{action:"submit"}),o=!0},alpha:.8}),p=ct({spriteName:"cancel-icon",onClick:()=>{t.npcTradeItems().isEmpty()&&t.playerTradeItems().isEmpty()&&(V.emit("ON_CLOSE_INVENTORY_REQUESTED"),o=!0),V.emit("ON_TRADE_REQUEST",{action:"clear"}),o=!0},alpha:.8});let C="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?C="green":t.value().quantity()>0?C="yellow":C="red");const k=Ut({viewModel:t.value()});g=qt(k,C).container,u=new O,u.label="trade-buttons-container",u.addChild(h,f,p,r),e.addChild(u),l=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:T,height:m,includeItemValue:!0,isTradeInv:!1}),e.addChild(l),l.label="player-trade-screen",a=d({title:"Trader",stacks:t.npcInventory().stacks(),width:T,height:m,npcInv:!0,includeItemValue:!0,isTradeInv:!1}),e.addChild(a),a.label="npc-trade-screen",c=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:T,height:m,includeItemValue:!0,isTradeInv:!0}),e.addChild(c),e.alpha=1,c.label="trade-screen",t.isConfirmationModalVisible()&&v()},b=()=>{l&&(e.removeChild(l),l.destroy(),l=null),a&&(e.removeChild(a),a.destroy(),a=null),c&&(e.removeChild(c),c.destroy(),c=null),h&&(e.removeChild(h),h.destroy(),h=null),f&&(e.removeChild(f),f.destroy(),f=null),p&&(e.removeChild(p),p.destroy(),p=null),r&&(e.removeChild(r),r.destroy(),r=null),u&&(e.removeChild(u),u.destroy(),u=null),g&&(e.removeChild(g),g.destroy(),g=null),y&&(e.removeChild(y),y.destroy(),y=null),e.alpha=0},_=(M,A)=>{if(e.alpha===0||!l||!a||!c)return;if(A>M){if(l.position.set(0,0),c.position.set(0,l.y+l.height+2),a.position.set(0,c.position.y+c.height+2),u){const T=M-20,m=u.children,x=m.reduce((k,N)=>k+N.width,0)+((g==null?void 0:g.width)??0),v=Math.min(30,m.length>1?(T-x)/m.length:0);let C=0;m.forEach(k=>{k.position.set(C,k.height*.5),C+=k.width+v}),g&&(u.addChild(g),g.position.set(u.width,g.height*.2)),u.position.set(M*.5-u.width*.5+v,a.position.y+a.height)}}else if(l.position.set(0,0),c.position.set(2+l.position.x+l.width,0),a.position.set(2+c.position.x+c.width,0),u){const T=A-20,m=u.children,x=m.reduce((k,N)=>k+N.height,0)+((g==null?void 0:g.height)??0),v=Math.min(30,m.length>1?(T-x)/m.length:0);let C=0;m.forEach(k=>{k.position.set(k.width*.5,C),C+=k.height+v}),g&&(u.addChild(g),g.position.set(g.width*.35,u.height-10)),u.position.set(a.position.x+a.width,A*.5-u.height*.5+v)}};return{view:e,show:w,hide:b,resize:_,update:()=>{!o&&!t.isAutoTrading()||(o=!1,e.alpha!==0&&(w(),_(innerWidth,innerHeight)))}}},Vn=n=>{const{viewModel:t}=n,e=new O,i=[],s=new O;e.addChild(s),s.label="icons-container",e.visible=t.isVisible();const o=new J;o.rect(0,0,innerWidth,64),o.fill("black"),o.alpha=0,e.addChild(o);const d=[],l=()=>{s.removeChildren(),s.destroy({children:!0}),o.destroy(),e.removeChildren(),e.destroy({children:!0}),d.forEach(I=>I.kill())},a=I=>{const T=new O;T.label=`${I}-icon`,T.eventMode="static";const m=new J;m.circle(0,0,32),m.stroke({color:"khaki",width:4}),m.fill("khaki"),m.alpha=.5,T.addChild(m);const x=$.from(`${I}-icon.png`);return x.anchor.set(.5),x.width=32,x.height=32,i.push(T),T.addChild(x),s.addChild(T),T},c=a("city-key");c.on("pointertap",()=>{const I=t.canUnlockSettlement();I&&(X.play("audio/sfx/sfx-unlock.wav"),V.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:I,action:"unlock"}))});const h=a("talk");h.on("pointertap",()=>{X.play("audio/sfx/click.wav"),V.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:t.canInteractWithCharacter()??void 0,action:"talk"})}),h.visible=t.canInteractWithCharacter()!==null;const r=a("trade");r.on("pointertap",()=>{const I=t.canTradeWithCharacter();if(I){V.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:I,action:"trade"});return}const T=t.canTradeWithSettlement();T&&(X.play("audio/sfx/click.wav"),V.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:T,action:"trade"}))}),r.visible=t.canTradeWithCharacter()!==null||t.canTradeWithSettlement()!==null;const f=a("settlement");f.on("pointertap",()=>{const I=t.canVisitSettlement();I&&(X.play("audio/sfx/click.wav"),V.emit("ON_SETTLEMENT_INTERACTION_REQUEST",{settlement:I,action:"trade"}))});const p=a("attack");p.on("pointertap",()=>{const I=t.canAttackCharacter();I&&V.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:I,action:"attack"})});const u=a("ranged-attack");u.on("pointertap",()=>{const I=t.canRangedAttackCharacter();I&&V.emit("ON_CHARACTER_INTERACTION_REQUEST",{character:I,action:"attack"})});const g=a("loot");g.on("pointertap",()=>{const I=t.canLoot();I&&V.emit("ON_INVENTORY_REQUEST",{inventory:I,action:"open"})});const y=a("search");y.on("pointertap",()=>{const I=t.canSearch();I&&V.emit("ON_EVENT_INTERACTION",{eventViewModel:I})});const w=a("rest");w.on("pointertap",()=>{t.canRestAtSettlement()&&(X.play("audio/sfx/click.wav"),V.emit("ON_LEVEL_COMPLETED"))});const b=()=>{let T=0;i.filter(m=>m.visible).forEach((m,x)=>{m.x=x*(m.width+16),m.y=(e.height-m.height)/2,T=x}),s.x=32+(innerWidth-(T+1)*(i[0].width+16))/2},_=async I=>{I.scale.set(0),I.alpha=0,I.visible=!0;const T=1,m=1.15,x=500,v=x*.7,C=x*.3;d.push(Z.to(I,{alpha:1,duration:x/1e3,ease:"power1.inOut",onUpdate:()=>{b()}}));const k=Z.to(I.scale,{x:m,y:m,duration:v/1e3,ease:"power1.inOut"});d.push(k),await k,d.push(Z.to(I.scale,{x:T,y:T,duration:C/1e3,ease:"power1.inOut"}))},E=(I,T)=>{o.clear(),o.rect(0,0,I,64),o.fill("black"),o.alpha=0,b()},M=(I,T)=>{!I.visible&&T()?(I.visible=!0,_(I)):I.visible=T()!==null},A=()=>{e.visible=t.isVisible(),M(h,()=>t.canInteractWithCharacter()),M(r,()=>t.canTradeWithCharacter()||t.canTradeWithSettlement()),M(f,()=>t.canVisitSettlement()),M(p,()=>t.canAttackCharacter()),M(u,()=>t.canRangedAttackCharacter()),M(g,()=>t.canLoot()),M(y,()=>t.canSearch()),M(c,()=>t.canUnlockSettlement()),M(w,()=>t.canRestAtSettlement()),b()};return ut(()=>{ft(()=>{A()})},e),{view:e,resize:E,destroy:l}},Ln=n=>{let t=[];const e=new O;e.label="grid-container";const i=()=>{const l=innerWidth<innerHeight,a=30,c=l?(innerWidth-40)/2:innerWidth-15,h=12,r=a+10;t.forEach((f,p)=>{const u=Math.floor(p/(l?2:1)),g=p%(l?2:1);f.icon.position.set(g*c,u*(f.icon.height+h)),f.stats.position.set(f.icon.x+a*.5+r,f.icon.y+(f.icon.height-f.stats.height)/2),f.stats.scale.set(1);const y=c-r-10;f.stats.width>y&&(f.stats.width=y)}),d()},s=l=>{const{icon:a,stats:c}=l,h=Math.floor(t.length/(innerWidth<innerHeight?2:1)),r=t.length%(innerWidth<innerHeight?2:1);t.push({icon:a,stats:c,row:h,column:r}),i()},o=()=>{t=[],e.removeChildren()},d=()=>{e.removeChildren(),t.forEach(l=>{const a=new J;a.roundRect(l.icon.x-5,l.icon.y-5,l.icon.width+10,l.icon.height+10,5),a.fill("khaki"),a.stroke(16777215),a.alpha=.5,a.label="icon-background",e.addChild(a,l.icon,l.stats)})};return i(),{gridContainer:e,addDataToGrid:s,resize:i,renderGrid:d,clearDataFromGrid:o}},We=(n,t)=>{const e=new O,i={fontFamily:"alagard",fontSize:20,fill:"white",align:"center",...t},s=new _t,o=new J;s.text=n,s.style=i;const d=()=>{o.clear(),o.roundRect(s.x-10,s.y,s.width+20,s.height,10),o.fill("black"),o.alpha=.5};e.addChild(o,s);const l=a=>{s.text=a,d()};return d(),{view:e,updateText:l}},Bn=()=>{const n=document.createElement("canvas");n.width=256,n.height=1;const t=n.getContext("2d"),e=t.createLinearGradient(0,0,n.width,0);return e.addColorStop(0,"rgba(240, 230, 140, 1)"),e.addColorStop(1,"rgba(240, 230, 140, 0)"),t.fillStyle=e,t.fillRect(0,0,n.width,1),ze.from(n)},On=n=>{const{playerUiVM:t}=n,e=40,i=10,s=new O;s.label="player-ui-view";const o=Ln(),d=(q,H,K,st,P)=>{const G=new O,Q=new J,tt=1;Q.rect(0,0,200,20),Q.fill(0),Q.stroke(16777215);const gt=190/H,yt=new J;for(let lt=q>H?H-1:q-1;lt>=0;lt--)yt.rect(5+lt*gt,5,gt-tt,10),lt>=q-4?yt.fill(K):lt>=q-7&&P?yt.fill(P):yt.fill(st);return G.addChild(Q,yt),G},l=()=>{s.visible=!0},a=()=>{s.visible=!1},c=$.from("health-icon.png");c.label="health-icon",c.anchor.set(.5),c.width=e,c.height=e;const h=$.from("torch-icon.png");h.label="torch-icon",h.anchor.set(.5),h.scale.set(.1);const r=$.from("scrap.png");r.label="inventory-value-icon",r.anchor.set(.5),r.width=e,r.height=e;const f=$.from("armour-icon.png");f.label="armour-icon",f.anchor.set(.5),f.width=e,f.height=e;const p=We(`$ ${t.inventoryValue().toString()}`,{fill:"gold",fontSize:20}),u=ct({spriteName:"base-portrait",onClick:()=>{V.emit("ON_INVENTORY_REQUEST",{action:"open",inventory:t.inventory()})},onClickAudio:""}),g=ct({spriteName:"menu-icon",onClick:()=>{V.emit("ON_IN_GAME_MENU_REQUEST",{action:"open"})}}),y=ct({spriteName:"min-icon",onClick:()=>{V.emit("ON_IN_GAME_MENU_REQUEST",{action:"close"})},onClickAudio:"deselect"}),w=ct({spriteName:"save-icon",onClick:()=>{_.updateText("Saving..."),V.emit("ON_SAVE_REQUEST")}}),b=ct({spriteName:"load-icon",onClick:()=>{_.updateText("Loading..."),V.emit("ON_LOAD_REQUEST")}}),_=We("Game Paused"),E=()=>{g.visible=!1,_.view.visible=!0,y.visible=!0,w.visible=!0,b.visible=!0},M=()=>{g.visible=!0,_.updateText("Game Paused"),_.view.visible=!1,y.visible=!1,w.visible=!1,b.visible=!1};s.addChild(h,c,r,p.view,u,o.gridContainer,f,g,y,w,_.view,b);let A=null,I=null,T=null,m=null,x=null,v=null,C=null;const k=()=>{if(T&&s.removeChild(T),t.maxArmour()<=0||t.armour()<=0){T=null;return}T=d(t.armour(),t.maxArmour(),"blue","blue"),T.position.set(c.width+i,c.y-T.height*.5),T.label="armour-bar",s.addChild(T)},N=()=>{A&&s.removeChild(A),A=d(t.health(),t.maxHealth(),"red","red"),A.label="health-bar",A.position.set(c.width+i,c.y-A.height*.5),s.addChild(A)},B=q=>{const H=new O,K=20;H.label="stat-container";let st=0;if(Object.entries(q).forEach(([G,Q],tt)=>{tt!==0&&(st+=H.width),Array(Q()).fill(0).forEach((gt,yt)=>{const lt=$.from(G+".png");lt.width=K,lt.height=K,lt.position.set(st+yt*K*.5,0),H.addChildAt(lt,0)})}),H.width===0)return H;const P=new $(Bn());return P.x=H.x-5,P.y=H.y-5,P.width=H.width+64,P.height=H.height+10,P.label="row-gradient-background",H.addChildAt(P,0),H},Y=()=>{const q=t.weapon();m?m.removeChildren():(m=new O,m.label="weapon-icon",s.addChild(m));const H=$.from(q.code()+".png");H.width=e,H.height=e;const K=B({"damage-icon":()=>q.damage(),"range-icon":()=>q.range()});return{icon:H,stats:K}},R=()=>{const q=t.bodyArmour();x?x.removeChildren():(x=new O,x.label="armour-icon",s.addChild(x));const H=$.from(q.code()+".png");H.width=e,H.height=e;const K=B({"armour-icon":()=>q.armour()});return{icon:H,stats:K}},S=()=>{const q=t.headArmour();v?v.removeChildren():(v=new O,v.label="head-armour-icon",s.addChild(v));const H=q.code()==="head"?"base-portrait":q.code(),K=$.from(H+".png");K.width=e,K.height=e;const st=B({"armour-icon":()=>q.armour()});return{icon:K,stats:st}},L=()=>{const q=t.feetArmour();C?C.removeChildren():(C=new O,C.label="feet-armour-icon",s.addChild(C));const H=$.from(q.code()+".png");H.width=e,H.height=e;const K=B({"armour-icon":()=>q.armour()});return{icon:H,stats:K}},U=()=>{I&&s.removeChild(I),I=d(t.torchLeft(),30,"red","brown","khaki"),I.label="torch-bar",A&&I.position.set(A.x,h.y-7),s.addChild(I)},D=()=>{c.position.set(10,10),f.position.set(10,10),A&&(A.position.set(c.width+i,c.y-A.height*.5),p.view.position.set(A.x,r.y-p.view.height*.5),T&&T.position.set(A.x,A.y)),I&&A&&I.position.set(A.x,h.y-7),h.position.set(10,c.height+15),r.position.set(10,h.y+h.height),o.resize(),o.gridContainer.position.set(0,r.y+r.height*.5+10),u.position.set(innerWidth-(u.width+32),20),g.position.set(innerWidth-(g.width+32),u.y+u.height+10),y.position.set(g.x,g.y),w.position.set(g.x,g.y+g.height+10),b.position.set(g.x,w.y+w.height+10),_.view.position.set(innerWidth/2-_.view.width/2,innerHeight/2-20),s.position.set(20,20)};return M(),D(),ut(()=>{ft(()=>{N(),k(),t.torchLeft()>=0&&U(),t.isSaveCompleted()?_.updateText("Save completed"):_.updateText("Game Paused"),f.visible=t.maxArmour()>0&&t.armour()>0,t.isInGameMenuVisible()?E():M(),t.isInventoryValueVisible()?(r.visible=!0,g.visible=!1,p.view.visible=!0,o.gridContainer.visible=!0,o.clearDataFromGrid(),o.addDataToGrid(S()),o.addDataToGrid(Y()),o.addDataToGrid(R()),o.addDataToGrid(L())):(r.visible=!1,y.visible||(g.visible=!0),p.view.visible=!1,o.gridContainer.visible=!1),p.updateText(`$ ${t.inventoryValue().toString()}`),D()})},s),{view:s,show:l,hide:a,resize:D}},Wn=n=>{const{viewModel:t}=n,e=new O;e.label="new-trade-view";const i=new J;i.label="new-trade-view-background",e.addChild(i);const s=()=>{i.clear(),i.rect(0,0,innerWidth,innerHeight),i.fill("black")};let o=!1;const d=({title:y,stacks:w,width:b,height:_,playerStacks:E,npcInv:M=!1,includeItemValue:A=!1,isTradeInv:I=!1})=>{const T=new O;T.label=`${y}-screen-view`;const m=Yt({text:y,onClick:()=>{}});m.label=`${y}-title-button`;const x=new le({width:b,height:_,padding:4,elementsMargin:2});x.label=`${y}-inventory-view`;const v=new J;v.label=`${y}-background`,T.addChild(v,m,x);const C=(k,N,B)=>{k.forEach(Y=>{const R=Ut({viewModel:Y.item,includeItemValue:A,itemValue:t.getItemPrice(Y.item,B),quantity:Y.quantity}),L=qt(R,N==="buy"||N==="buy-return"?"pink":"lightblue"),U=new O;R.view.off("pointertap"),U.on("pointertap",()=>{D(),V.emit("ON_ITEM_INTERACTION",{itemViewModel:Y.item,action:N}),o=!0}),U.addChild(L.container,R.view),U.label=`${R.view.label}-container`,x.addItem(U);const D=()=>{U.tint=65280,setTimeout(()=>{U.tint=16777215},200)}})};return M?C(w,"buy",!0):I?(C(E||[],"sell-return",!1),C(w,"buy-return",!0)):C(w,"sell",!1),m.scale.set(.4),m.position.set(b*.5,m.height*.5),x.position.set(b*.5-x.width*.5,m.height+10),v.rect(0,0,T.width,T.height),v.fill("black"),v.stroke("black"),T};let l=null,a=null,c=null,h=null,r=null;const f=()=>{l?p():X.play("audio/sfx/door.mp3");const{innerWidth:y,innerHeight:w}=window,b=w>y,_=b?y:y*.35,E=b?w*.35:w;s(),c=Yt({text:"Continue",onClick:()=>{c.eventMode="none",V.emit("ON_TRADE_REQUEST",{action:"confirm-bulk-trade"}),Z.delayedCall(.5,()=>{V.emit("ON_CLOSE_INVENTORY_REQUESTED")}),o=!0}}),c.alpha=0,c.label="continue-button";let M="khaki";(t.npcTradeItems().stacks().length!==0||t.playerTradeItems().stacks().length!==0)&&(t.value().quantity()===0?M="green":t.value().quantity()>0?M="yellow":M="red");const A=Ut({viewModel:t.value()});r=qt(A,M).container,h=new O,h.label="trade-buttons-container",h.addChild(c,r),c.scale.set(.4),e.addChild(h),l=d({title:t.playerInventory().ownerName(),stacks:t.playerInventory().stacks(),width:_,height:E,includeItemValue:!0,isTradeInv:!1}),e.addChild(l),l.label="player-trade-screen",a=d({title:"Trade",stacks:t.npcTradeItems().stacks(),playerStacks:t.playerTradeItems().stacks(),width:_,height:E,includeItemValue:!0,isTradeInv:!0}),e.addChild(a),a.label="trade-screen",c&&(c.alpha=t.isContinueButtonVisible()?1:0),e.visible=!0},p=()=>{l&&(e.removeChild(l),l.destroy(),l=null),a&&(e.removeChild(a),a.destroy(),a=null),c&&(e.removeChild(c),c.destroy(),c=null),h&&(e.removeChild(h),h.destroy(),h=null),r&&(e.removeChild(r),r.destroy(),r=null),e.visible=!1},u=(y,w)=>{if(!e.visible||!l||!a)return;w>y?(l.position.set(0,0),a.position.set(0,l.y+l.height+2),r&&c&&(r.position.set(-r.width*.5,-r.height*.5),c.position.set(r.x+r.width+c.width*.5,0)),h&&h.position.set(y*.5-h.width*.5,a.position.y+a.height+h.height*.5+10)):(l.position.set(0,0),a.position.set(2+l.position.x+l.width,0),r&&c&&(r.position.set(0,0),c.position.set(20,r.y+r.height+30)),h&&h.position.set(a.position.x+a.width+h.width*.5,w*.5-h.height*.5))};return{view:e,show:f,hide:p,resize:u,update:()=>{c&&(c&&(c.alpha=t.isContinueButtonVisible()?1:0),c.alpha===1&&!o)||!o&&!t.isAutoTrading()||(o=!1,e.visible&&(f(),u(innerWidth,innerHeight)))}}},Dn=n=>{const t=n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2");return t.charAt(0).toUpperCase()+t.slice(1)},Hn=n=>{const t=dt().log;let e=[],i=!0;const s=new O;s.label="log-view",s.alpha=0;const o=new O;o.label="log-grid-layout",s.addChild(o);const d=new J;o.addChild(d);const l=()=>{if(e.length>0){e.forEach(g=>g()),e=[];return}u()},a=async g=>{var I;const y=o.children.length,w=innerWidth/2-20,b=new _t,_=g.name.toLowerCase().includes("value");b.style={fontFamily:"alagard",fontSize:20,fill:"black"},b.text=Dn(g.name),b.position.set(10,y*15);const E=new O;E.label="log-value-container",E.position.set(w+(innerWidth<innerHeight?100:0),b.y);const M=new _t;M.style={fontFamily:"alagard",fontSize:18,fill:"black"},M.text=_?"$":"",M.text+=g.value??((I=g.to)==null?void 0:I.toString())??"",E.addChild(M),o.addChild(b),o.addChild(E),b.alpha=0,E.alpha=0,!await new Promise(T=>{Z.delayedCall(g.index*.5,()=>{i||T(!0),e.shift(),T(!1)}),e.push(()=>T(!0))})&&i&&X.play("audio/sfx/sfx-thud.mp3"),b.alpha=1,E.alpha=1};Object.entries(t).sort((g,y)=>g.toLocaleString().localeCompare(y.toLocaleString())).forEach(([g,y],w)=>{a(typeof y=="string"?{name:g,value:y,index:w}:{name:g,to:y,index:w})});const c=5;d.roundRect(-5,-5,o.width+30+c*2,o.height+30+c*2,30),d.fill("khaki"),s.eventMode="static",s.on("pointertap",()=>{l()});const h=new _t;h.text="Tap to continue",h.style={fontFamily:"alagard",fontSize:20,fill:"white"};const r=innerHeight>innerWidth;h.position.set(r?(s.width-h.width)*.5:s.width+40,r?s.height+20:s.height*.5),s.addChild(h);const f=()=>{i=!0,s.visible=!0,s.alpha=0,Z.to(s,{alpha:1,duration:.5,ease:"power2.out"})},p=()=>{i=!1},u=()=>{i=!1,Z.to(s,{alpha:0,duration:.5,ease:"power2.in",onComplete:()=>{s.visible=!1,n()}})};return{view:s,destroy:p,show:f,hide:u,handleAnyPress:l}},Un=n=>{const t=new O,{playerMenuVM:e}=n;let i=null,s=null,o=null,d=null,l=null,a=null;const c=new J;c.label="background",c.alpha=0,c.on("pointertap",()=>{a==null||a.handleAnyPress()}),t.addChild(c);const h=()=>{c.clear(),c.rect(0,0,innerWidth,innerHeight),c.fill("black")},r=()=>{A(),E(),c.alpha=0},f=()=>{d&&(d.view.visible=!1),c.alpha=0},p=()=>{f(),w(),u(),c.alpha=1,a=Hn(()=>{u(),V.emit("ON_LEVEL_COMPLETED")});const x=Math.min(1,Math.min(innerWidth/a.view.width,innerHeight/a.view.height));a.view.scale.set(x),a.view.position.set(innerWidth*.5-a.view.width*.5,innerHeight*.5-a.view.height*.5),t.addChild(a.view),a.show(),c.eventMode="static"},u=()=>{c.eventMode="none",a&&(a.destroy(),t.removeChild(a.view),a.view.destroy({children:!0}),a=null)},g=()=>{const x=n.playerUiVM();if(!x)return;if(d){d.view.position.set(30,30),d.view.visible=!0;return}d=On({playerUiVM:x});const v=Math.min(1,Math.min(innerWidth/d.view.width,innerHeight/d.view.height));d.view.scale.set(v),d.view.position.set(30,30),t.addChild(d.view),d.view.visible=!0,d.view.label="player-ui-view"},y=()=>{const x=e();if(!x)return;s||(s=Vn({viewModel:x}),t.addChild(s.view));const v=Math.min(1,Math.min(innerWidth/s.view.width,innerHeight/s.view.height));s.view.scale.set(v),s.view.position.set(innerWidth*.5-s.view.width*.5,innerHeight*.9-s.view.height*.5),s.view.visible=!0},w=()=>{s&&(s.view.visible=!1),c.alpha=0},b=x=>{E(),w(),f(),c.alpha=1,o=Wn({viewModel:x}),t.addChild(o.view),o.show()},_=x=>{E(),w(),f(),c.alpha=1,o=Rn({viewModel:x}),t.addChild(o.view),o.show(),I(innerWidth,innerHeight)},E=()=>{y(),g(),o&&(t.removeChild(o.view),o.view.destroy(),o=null),c.alpha=0,I(innerWidth,innerHeight)},M=x=>{if(w(),c.alpha=1,l&&!x)x=l;else if(!x)throw new Error("No inventory provided to showInventory");l=x,setTimeout(()=>{i=Nn(x),i.show(),t.addChild(i.view),I(innerWidth,innerHeight)},10)},A=(x=!0)=>{y(),i&&(t.removeChild(i.view),i.view.destroy(),i=null),x&&(l=null),c.alpha=0},I=(x,v,C=!1)=>{h();const k=v>x;if(o){o.show(),o.resize(x,v);const N=k?Math.min(1,v/o.view.height):Math.min(1,x/o.view.width);o.view.scale.set(N);const B=k?(t.width-o.view.width)*.5:0,Y=k?0:(t.height-o.view.height)*.5;o.view.position.set(B,Y)}if(s&&(s.resize(x,v),s.view.position.set(x*.5-s.view.width*.5,v*.9-s.view.height*.5)),d&&d.resize(),a&&p(),i&&d){if(C){A(!1),M();return}const N=k?(x-i.view.width)*.5:d.view.width*.4,B=k?d.view.y+d.view.height+10:(v-i.view.height)*.5;i.view.position.set(N,B)}},T=()=>{o==null||o.update()};return t.label="user-interface-view",h(),{showInventory:M,hideInventory:A,showTrade:_,hideTrade:E,showBulkTrade:b,view:t,closeAll:r,showPlayerMenu:y,hidePlayerMenu:w,showPlayerUi:g,resize:I,destroy:()=>{t.removeChildren(),c.destroy(),i=null,s==null||s.destroy(),s=null,o=null,d=null},update:T,showEndOfLevelLog:p,hideEndOfLevelLog:u}},qn=()=>{const n=oe.map(e=>(e.code()==="torch"&&e.updateQuantity(11),Tt(e.code()))),t=Qt(n);return kt({model:t,ownerName:"Global Inventory"})},zn=n=>{const{playerVM:t,tileMapVM:e}=n,i=(l,a)=>{const c=t.position().x+l,h=t.position().y+a;if(c<=0&&c>=e.tiles().length-1&&h<=0&&h>=e.tiles()[0].length-1)return;const r=e.tiles()[c][h];r&&V.emit("ON_TILE_INTERACTION",{tileViewModel:r})},s=l=>{switch(l){case"endLevel":V.emit("ON_LEVEL_COMPLETED");break;case"showInventory":V.emit("ON_INVENTORY_REQUEST",{inventory:qn(),action:"open"});break;case"showCharacterDetails":console.debug("Showing character details");break;case"moveLeft":i(-1,0);break;case"moveRight":i(1,0);break;case"moveUp":i(0,-1);break;case"moveDown":i(0,1);break;default:console.warn(`Unknown action: ${l}`)}},o=l=>{switch(l.key){case"r":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"endLevel"});break;case"i":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"showInventory"});break;case"w":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveUp"});break;case"s":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveDown"});break;case"a":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveLeft"});break;case"d":V.emit("ON_DEBUG_ACTION_REQUESTED",{action:"moveRight"});break;case"6":V.emit("ON_SAVE_REQUEST");break;case"8":V.emit("ON_LOAD_REQUEST");break}};return document.addEventListener("keypress",o),{handleDebugActionRequest:s,destroy:()=>{document.removeEventListener("keypress",o)}}};function $n(n){const t=[];let e=n;for(;e;)t.unshift(e.tile),e=e.previous;return t}function $t({start:n,end:t,map:e,maxDistance:i=7}){const s=e.tiles().flat().find(r=>r.position().x===n.x&&r.position().y===n.y),o=e.tiles().flat().find(r=>r.position().x===t.x&&r.position().y===t.y);if(!s||!o)return null;const d=Math.sqrt(Math.pow(o.position().x-s.position().x,2)+Math.pow(o.position().y-s.position().y,2)),l={previous:null,tile:s,g:0},a=r=>{let f=!1,p=r.previous;for(;p;){if(p.tile.position().x===r.tile.position().x&&p.tile.position().y===r.tile.position().y){f=!0;break}p=p.previous}return f},c=[],h=r=>{if(r.tile.position().x===o.position().x&&r.tile.position().y===o.position().y){c.push(r);return}if(r.g>i||r.g>d)return;const f=e.getNeighbors(r.tile),p=r.tile.position();for(const u of f){if(!u.traversable()&&o.traversable())continue;const g=u.position(),y=Math.abs(g.x-p.x),w=Math.abs(g.y-p.y),b=y===1&&w===1?2:1,_=r.g+b;if(_>i)continue;const E={previous:r,tile:u,g:_};a(E)||h(E)}};if(h(l),c.length>0){const r=c.reduce((p,u)=>p.g<u.g?p:u),f=$n(r);if(f.length>0)return f.shift(),f}return[]}const Gn={"bed-time":["follow"],patrol:["bed-time","follow","work"],follow:["attack"],work:["bed-time","patrol","follow"],idle:["bed-time","patrol","follow","work"],attack:["bed-time","patrol","follow","work"],spawn:["bed-time","patrol","follow","work","attack"]},Fn=n=>{const{events:t,playerVM:e,tileMapVM:i,npcTaskController:s,npcs:o,turnVM:d}=n,l=5,a=[],c=(m,x)=>{var C;const v=[];for(let k=m.x-x;k<=m.x+x;k++)for(let N=m.y-x;N<=m.y+x;N++){const B=(C=i.tiles()[k])==null?void 0:C[N];!B||Math.floor(Math.sqrt(Math.pow(B.position().x-m.x,2)+Math.pow(B.position().y-m.y,2)))>x||B.traversable()&&v.push(B.position())}return v},h=(m,x)=>{let C=5,k=null;for(;k===null||k.length===0;)if(k=$t({start:m,end:x,map:i,maxDistance:C}),C++,C>9)return null;return k},r=m=>{const x=m.position();let v=null;const C=[];for(const k of t){const N=k.position(),B=Math.floor(Math.sqrt(Math.pow(N.x-x.x,2)+Math.pow(N.y-x.y,2)));C.push({event:k,distance:B})}C.sort((k,N)=>k.distance-N.distance);for(let k=0;k<Math.min(3,C.length);k++){const N=C[k].event,B=h(x,N.position());if(B&&B.length>0){v=N;break}}return v||null},f=m=>{m.isAlive()&&(m.setTaskList([s.createSpawnTask(m)]),m.setCanTrade(!1),a.push(m),m.getPatrolArea().length===0&&(m.setPatrolArea(c(m.position(),l)),m.setTaskList([...m.getTaskList(),s.createPatrolTask(m)])))},p=m=>{m.isAlive()&&!m.isHostile(e.team())&&(m.setTaskList([s.createWorkTask(m)]),m.setCanTrade(!0),a.push(m))},u=m=>{if(!m.isAlive()){m.setTask(null);return}if(m.isHostile(e.team())&&m.getPatrolArea().length===0&&(m.setPatrolArea(c(m.position(),l)),m.setTaskList([...m.getTaskList(),s.createPatrolTask(m)])),m.getBedLocation()===null){const x=r(m);x&&m.setBedLocation(x.position())}a.push(m)},g=(m,x)=>{const v=m.getTask();if(!v)return!0;const C=v.name();return(Gn[C]||[]).includes(x)},y=m=>{if(!m.spawnLing())return!1;const x=4;if(m.lastSpawned()===0)return m.setLastSpawned(d.getCurrentTurn()),!1;const v=d.getCurrentTurn()-m.lastSpawned()>=x;if(!v)return!1;if(v){const C=s.createSpawnTask(m);if(C)return m.setTask(C),m.setLastSpawned(d.getCurrentTurn()),!0}return!1},w=m=>{if(!m.isHostile(e.team()))return!1;if(e.isAlive()&&e.position()){const C=Math.floor(Math.sqrt(Math.pow(e.position().x-m.position().x,2)+Math.pow(e.position().y-m.position().y,2)));if(C<=1)return!1;if(C<=4&&g(m,"follow")){const k=m.getTaskList().find(N=>N.name()==="follow")||s.createFollowPlayerTask(m);if(k)return m.setTarget(e),m.setTask(k),!0}}return!1},b=m=>{const x=m.getTask(),v=n.turnVM.getCurrentTimeMin();if(v>=1200||v<480){if(x&&x.name()==="bed-time")return!0;if(g(m,"bed-time")){const C=m.getTaskList().find(k=>k.name()==="bed-time")||s.createBedTimeTask(m);if(C)return m.setTask(C),!0}}return!1},_=m=>{const x=m.getTask();if(n.turnVM.getCurrentTimeMin()>=480){if(x&&x.name()==="patrol")return!0;if(g(m,"patrol")){const C=m.getTaskList().find(k=>k.name()==="patrol");if(C)return m.setTask(C),!0}}return!1},E=m=>{var k;const x=m.getTarget(),v=1;if(!x||!x.isAlive())return m.setTarget(null),!1;if(Math.floor(Math.sqrt(Math.pow(x.position().x-m.position().x,2)+Math.pow(x.position().y-m.position().y,2)))>v)return!1;if(((k=m.getTask())==null?void 0:k.name())==="attack")return!0;if(g(m,"attack")){const N=m.getTaskList().find(B=>B.name()==="attack")||s.createAttackTask(m);if(N)return m.setTask(N),!0}return!1},M=m=>{var x;if(((x=m.getTask())==null?void 0:x.name())==="work")return!0;if(g(m,"work")){const v=m.getTaskList().find(C=>C.name()==="work");if(v)return m.setTask(v),!0}return!1},A=m=>{if(!m.isAlive()){m.setTask(null);return}y(m)||E(m)||w(m)||b(m)||_(m)||M(m)},I=()=>{a.forEach(m=>{if(!m.isAlive())return;A(m);const x=m.getTask();x&&x.name(),x&&x.execute()})};return(()=>{o.forEach(m=>{u(m)})})(),{addNpc:u,addTrader:p,addNestmother:f,playNpcTurn:I}},Qn=({npc:n,attackVM:t})=>({execute:()=>{if(!n.isAlive())return!1;const e=n.getTarget();return!e||!e.isAlive()?(n.setTask(null),!0):Math.floor(Math.sqrt(Math.pow(n.position().x-e.position().x,2)+Math.pow(n.position().y-e.position().y,2)))<=1?(t.attack(n,e),!0):!1},name:()=>"attack"}),Yn=({npc:n,tileMapVM:t,turnVM:e})=>{let i=n.getBedLocation(),s=null;return{execute:()=>{if(n.isAlive()===!1)return!1;if(e.getCurrentTimeMin()>=480&&e.getCurrentTimeMin()<1200)return n.setTask(null),!0;if(!i&&(i=n.getBedLocation(),!i))return!1;if(n.position().x===i.x&&n.position().y===i.y)return!0;if(!s){let d=5;for(;s===null||s.length===0;)if(s=$t({start:n.position(),end:i,map:t,maxDistance:d}),d++,d>8)return!1}if(s&&s.length>0){const o=s.shift();return o&&(n.moveTo(o.position().x,o.position().y),o.position().x===i.x&&o.position().y===i.y),!0}return!1},name:()=>"bed-time"}},Xn=({npc:n,tileMapVM:t,playerVM:e})=>({execute:()=>{if(n.isAlive()===!1)return!1;const i=e.position(),s=$t({start:n.position(),end:i,map:t});if(s&&s.length>0){const o=s.shift();if(o)return o.position().x===i.x&&o.position().y===i.y||n.moveTo(o.position().x,o.position().y),!0}return!1},name:()=>"follow"}),jn=({npc:n,tileMapVM:t})=>{let e=n.getPatrolArea(),i=null;return{execute:()=>{if(n.isAlive()===!1||e.length===0||((!i||i.length===0)&&(i=$t({start:n.position(),end:e[Math.floor(Math.random()*e.length)],map:t})),!i||i.length===0))return!1;const s=i.shift();return s&&n.moveTo(s.position().x,s.position().y),!0},name:()=>"patrol"}},Zn=({npc:n})=>({execute:()=>n.isAlive()===!1?!1:(n.setCanTrade(!0),!0),name:()=>"work"}),Kn=({npc:n,addNpc:t,spawnType:e="worm"})=>({execute:()=>{if(!n.isAlive())return!1;const i=n.position(),s=Ue({id:e,team:"hostile-to-player",name:"Spawned "+e.charAt(0).toUpperCase()+e.slice(1),startingSize:1,startPosition:i,startingHealth:1,startingMaxHealth:1,startingItems:[]}),o=Ke(s);return t(o),!0},name:()=>"spawn"}),Jn=n=>{const{attackVM:t,tileMapVM:e,turnVM:i,playerVM:s}=n;return{createBedTimeTask:r=>Yn({npc:r,tileMapVM:e,turnVM:i}),createPatrolTask:r=>jn({npc:r,tileMapVM:e}),createFollowPlayerTask:r=>Xn({npc:r,tileMapVM:e,playerVM:s}),createAttackTask:r=>Qn({npc:r,attackVM:t}),createWorkTask:r=>Zn({npc:r}),createSpawnTask:r=>Kn({npc:r,spawnType:"worm",addNpc:n.addNpc})}},Ft=(n,t)=>n.id()===t.id(),ts=()=>({use:(n,t)=>{if(n.health()!==0){if(t.health()>=t.maxHealth())return;if(t.id()==="player"){const e=Math.min(n.health(),t.maxHealth()-t.health());dt().log.totalHealing+=e}t.setHealth(t.health()+n.health()),t.inventory().removeItem(n),n.updateQuantity(0);return}n.type()==="weapon"&&(Ft(t.weapon(),n)?t.setWeapon(void 0):t.setWeapon(n)),n.type()==="armour"&&(Ft(t.bodyArmour(),n)?t.setBodyArmour(void 0):t.setBodyArmour(n)),n.type()==="helmet"&&(Ft(t.headArmour(),n)?t.setHeadArmour(void 0):t.setHeadArmour(n)),n.type()==="shoes"&&(Ft(t.feetArmour(),n)?t.setFeetArmour(void 0):t.setFeetArmour(n))}}),es=()=>{let n=null,t=null;const e=222,[i,s]=z(!1),[o,d]=z(!0),[l,a]=z(!1),[c,h]=z(!1),[r]=z(Ht({model:Tt("scrap")})),f=kt({model:Qt([]),ownerName:"trade"}),p=kt({model:Qt([]),ownerName:"trade-npc"}),u=(S,L)=>{n=S,t=L,w(T()),w(I())},g=S=>{v().addItem(S,1),f.removeItem(S,1)},y=S=>{C().addItem(S,1),p.removeItem(S,1)},w=S=>{let L;S===f?L=g:L=y,S.items().forEach(U=>{L(U,!0),S.removeItem(U,1)})},b=S=>{const L=v().getItem(S);L&&(f.addItem(L,1),v().removeItem(L,1))},_=S=>{const L=C().getItem(S);L&&(p.addItem(L,1),C().removeItem(L,1))},E=()=>{w(T()),w(I()),r().updateQuantity(0)},M=(S=!1)=>{if(!n||!t)throw new Error("Player or NPC inventory is not set");return!l()&&!c()&&m()!==0?(a(!0),!1):r().quantity()<0?!1:((l()&&!c()||c()&&!l()||m()===0)&&S&&A(),l()&&a(!1),!0)},A=()=>{if(i()){const S=Math.floor(r().quantity());Array(S).fill(0).forEach(()=>{const L=Ht({model:Tt("scrap")});I().addItem(L)}),S>0&&X.play("audio/sfx/sfx-sell.mp3")}f.items().forEach(S=>{C().addItem(S,S.quantity()),f.removeItem(S,S.quantity())}),p.items().forEach(S=>{dt().log.tradedItemsValue+=x(S,!0),v().addItem(S,S.quantity()),p.removeItem(S,S.quantity())}),w(T()),w(I()),i()&&s(!1)},I=()=>(r().updateQuantity(m()),p),T=()=>(r().updateQuantity(m()),f),m=()=>{const S=f.stacks().reduce((U,D)=>U+x(D.item,!1)*D.quantity,0),L=p.stacks().reduce((U,D)=>U+Math.max(1,x(D.item,!0)*D.quantity),0);return Math.floor(S)-Math.ceil(L)},x=(S,L)=>{const U=S.value()*S.quantity(),q=L&&!["scrap","torch"].includes(S.code())?2:1;return U*q},v=()=>{if(n)return n;throw new Error("Player inventory is not set")},C=()=>{if(t)return t;throw new Error("NPC inventory is not set")},k=async()=>{await N(!1),await Z.delayedCall(.2,()=>{}),s(!1)},N=async(S=!0)=>{if(!n||!t)throw new Error("Invalid inventories to auto trade");s(!0);const L=n.stacks().reduce((U,D)=>(D.quantity>0&&D.item.type()==="loot"&&U.push(D),U),[]);for(const U of L){await Z.delayedCall(e/1e3,()=>{});for(let D=0;D<U.quantity;D++)S?X.play("audio/sfx/sfx-sell.mp3",{category:"gameplay"}):X.play("audio/sfx/collect.wav",{category:"gameplay"}),b(U.item)}};return{isConfirmationModalVisible:l,startTrade:u,cancelTrade:E,acceptTrade:M,playerTradeItems:T,acceptBulkTrade:()=>{c()&&(M(!0),h(!1))},value:r,npcTradeItems:I,playerInventory:v,npcInventory:C,selectItemToBuy:_,selectItemToSell:b,returnItemToPlayer:g,returnItemToNpc:y,clearTrade:()=>{if(l()){a(!1);return}w(T()),w(I()),a(!1),r().updateQuantity(0)},getItemPrice:x,bulkTrade:async()=>{h(!0),await Z.delayedCall(.5,()=>{}),d(!1),await N(),await Z.delayedCall(.5,()=>{}),d(!0)},autoTrade:k,isAutoTrading:i,isContinueButtonVisible:o}},is=n=>{if(n.length===0)return{x:0,y:0};const t=n.reduce((o,d)=>o+d.x,0),e=n.reduce((o,d)=>o+d.y,0),i=t/n.length,s=e/n.length;return{x:i,y:s}},De=(n,t)=>Math.abs(n.x-t.x)<=1&&Math.abs(n.y-t.y)<=1,ns=n=>{let t="idle",e="idle";return{get:()=>t,set:d=>{t!==d&&(e=t,d==="end-turn"?(n(),t="idle"):t=d)},getPrevState:()=>e}},ss=n=>{const{tileMapViewModel:t,playerViewModel:e,userInterfaceView:i,gameView:s,playerUiVM:o,attackVM:d}=n;let l=null,a=null;const c=ns(n.onPlayerTurnCompleted),h=ts(),r=1,f=()=>e.isAlive()&&c.get()!=="busy",p=v=>{const{action:C,trader:k}=v;if(!(k&&!k.canTrade())&&f()){if(c.set("trading"),k&&!a)if(a=es(),a.startTrade(e.inventory(),k.inventory()),C==="autoTrade"){a.bulkTrade(),i.showBulkTrade(a);return}else{i.showTrade(a);return}if(a){if(C==="autoTrade"&&a.autoTrade(),C==="clear"){a.clearTrade();return}if(C==="confirm-bulk-trade"){a.acceptBulkTrade();return}C==="submit"&&a.acceptTrade(!0)}}},u=v=>{var C;if(l){l.ownerName()===e.name()&&A();return}if(!a&&f()){if(v.isEmpty()){c.set("idle"),l=null;return}if(v.isOnlyLoot()&&v.ownerName()!==e.name()){i.update(),w(v);return}c.set("inventory-handling"),l=v,i.showInventory(v),(C=o())==null||C.isInventoryValueVisible(!0)}},g=v=>{var C;c.set("busy"),(C=o())==null||C.showInGameMenu(v==="open"),v!=="open"&&c.set(c.getPrevState()||"idle")},y=(v,C)=>{f()&&(c.set("inventory-handling"),C==="open"?u(v):A())},w=v=>{v.items().forEach(C=>{var k;e.inventory().addItem(C),v.removeItem(C),(k=s())==null||k.animateIconFloat(C.code(),e.position())}),X.play("audio/sfx/inventory-open.wav",{category:"gameplay",volume:1}),l=null,c.set("end-turn")},b=v=>{var Y,R;const{settlement:C,action:k}=v,N=C.positions(),B=is(N);if(f()){if(k==="unlock"){const S=e.inventory().getItemByCode("city-key");if(!S)throw new Error("City key is required to unlock the settlement");C.setIsUnlocked(!0),e.inventory().removeItem(S),(Y=s())==null||Y.createTextBox({id:()=>"settlement",dialogue:()=>"Welcome!",position:()=>({x:B.x,y:B.y})});return}if(k==="trade"&&C.isUnlocked()){p({action:"trade",trader:{canTrade:()=>!C.inventory().isEmpty(),inventory:()=>C.inventory()}});return}(R=s())==null||R.createTextBox({id:()=>"settlement",dialogue:()=>"City key required",position:()=>({x:B.x,y:B.y})})}},_=()=>{a&&(a.cancelTrade(),i.closeAll(),a=null),c.set("idle")},E=v=>{const{action:C,character:k}=v;if(!f()||!k)return;if(C==="talk"){const R=s();if(!R)return;R.createTextBox(k),c.set("idle");return}const N=Math.floor(Math.sqrt(Math.pow(k.position().x-e.position().x,2)+Math.pow(k.position().y-e.position().y,2))),B=N<=r,Y=N<=e.weapon().range();if(k.isHostile(e.team())&&Y&&k.health()>0){d.attack(e,k),c.set("end-turn");return}if(!B){I(k.position());return}if(!k.inventory().isEmpty()){if(k.canTrade()){p({action:"change-to-buy",trader:k});return}u(k.inventory());return}if(k.inventory().isEmpty()){I(k.position());return}u(k.inventory())},M=(v,C)=>{if(c.get()==="idle"&&f()){if(De(v.position(),e.position())&&(!v.discovered()||!v.inventory().isEmpty())){u(v.inventory()),v.interact(C);return}I(v.position())}},A=()=>{var v,C;if(l){if(l.ownerName()===e.name()){l=null,c.set("idle"),(v=o())==null||v.isInventoryValueVisible(!1),i.hideInventory();return}l=null,c.set("end-turn"),(C=o())==null||C.isInventoryValueVisible(!1),i.hideInventory();return}a&&_(),c.set("idle")},I=({x:v,y:C})=>{if(c.get()!=="idle"||!f())return;const k=e.position();if(De({x:v,y:C},k)&&t.isValidMove(v,C)){T(v-k.x,C-k.y);return}const N=$t({start:k,end:{x:v,y:C},map:t});if(N&&N.length>1){const B=N[0];T(B.position().x-k.x,B.position().y-k.y)}},T=(v,C)=>{if(c.set("moving"),!f())return;const k=e.position().x+v,N=e.position().y+C;t.isValidMove(k,N)&&e.moveTo(k,N),c.set("end-turn")};return{handlePlayerMoveRequest:I,handleTileInteraction:v=>{c.get()==="idle"&&f()&&I(v.position())},handleCharacterInteraction:E,handleEventInteraction:M,handleItemInteraction:(v,C)=>{var k;if(f()){if(c.get()==="trading"){if(C==="sell"){a==null||a.selectItemToSell(v);return}if(C==="buy-return"){a==null||a.returnItemToNpc(v);return}if(C==="sell-return"){a==null||a.returnItemToPlayer(v);return}if(C==="buy"){a==null||a.selectItemToBuy(v);return}}if(l&&l.ownerName()!==e.name()){e.inventory().addItem(v),l.removeItem(v),(k=s())==null||k.animateIconFloat(v.code(),e.position());return}h.use(v,e)}},handleCloseInventoryRequest:A,handleTradeRequest:p,handleTradeCancel:_,handleSettlementInteraction:b,handleInventoryRequest:y,handleInGameMenuRequest:g}},os=n=>{const{turnVM:t,handleEndUpTurnUpdates:e,playerVM:i,enemyVMs:s,npcController:o}=n;let d=0;const l=()=>{var f;const r=dt().log;r.turns+=1,r.npcsKilled=s.filter(p=>!p.isAlive()).length,r.npcsAlive=s.filter(p=>p.isAlive()).length,r.mostUsedWeapon=((f=i.inventory().items().filter(p=>p.type()==="weapon").sort((p,u)=>u.uses()-p.uses())[0])==null?void 0:f.name())||"fists"},a=async()=>{h(),await e(),t.nextTurn(),c(),l()},c=async()=>{if(d+=1,d%10===0){const r=i.inventory().getItemByCode("torch");r&&i.inventory().removeItem(r)}},h=()=>{o.playNpcTurn()};return{handlePlayerTurnEnded:a,playNpcTurn:h}},rs=()=>{const[n,t]=z(void 0);return{attack:async(e,i)=>{const s=e.weapon().range()>2,o=e.weapon().range()<=2,l=e.position().distanceTo(i.position())>1,c=e.weapon().damage();o||l&&s?i.takeDamage(c):!l&&s&&i.takeDamage(Math.min(1,Math.floor(c/2))),t({source:e,target:i,type:s&&l?"ranged":"melee"});const h=dt().log;e.id()==="player"&&(h.totalDamageDealt+=c,e.weapon().setUses(e.weapon().uses()+1),o||l&&s?o?dt().log.meleeAttacks+=1:dt().log.rangedAttacks+=1:!l&&s&&(dt().log.meleeAttacks+=1))},isAttacking:()=>n(),clearAttack:()=>{t(void 0)}}};Z.registerPlugin(re);re.registerPIXI(li);const as=n=>n<=3?1:n<=6?2:n<=10?3:n<=15?4:5,ls=({view:n,saveController:t,onGameLoadRequest:e,onLevelCompleted:i})=>{const[o,d]=z(ae({model:He({id:"dontUse",team:"player",name:"Player",startPosition:{x:0,y:0},startingHealth:10,startingMaxHealth:10,startingItems:[]})}));let l=null,a=null,c=null,h=null,r=null,f=null,p=null,u=null,g=null,y=null,w=null,b=[],_=[],E=null,M=[],A=1,I=null,T=null,m=null,x=!1,v=!1,C={x:0,y:0};const k=()=>{if(!I)throw new Error("Level models are not initialized");return I},N=P=>{I=P;const G=Wi(P);w=G.tileMapVM,d(G.playerVM),b=G.npcVMs,_=G.eventVMs,M=G.settlementVMs;const Q=rs();r=$i({playerVM:o()}),f=P.fogOfWarViewModel,l=zi({playerVM:o(),npcVMs:b,settlementVMs:M,eventViewModels:_}),p=Un({playerMenuVM:()=>l,playerUiVM:()=>r}),u=Di({model:Ri()}),h=Jn({tileMapVM:w,playerVM:o(),turnVM:u,attackVM:Q,addNpc:gt=>{T==null||T.addNpc(gt),c==null||c.addNpc(gt)}}),c=Fn({playerVM:o(),npcs:b,tileMapVM:w,events:_,npcTaskController:h,turnVM:u}),g=os({turnVM:u,playerVM:o(),enemyVMs:b,npcController:c,handleEndUpTurnUpdates:async()=>{await(T==null?void 0:T.handleEndOfTurnUpdates())}});const tt=()=>{o().inventory().getItemByCode("torch")?f==null||f.setToFullLight():f==null||f.setToLowLight()};a=ss({attackVM:Q,tileMapViewModel:w,playerViewModel:o(),userInterfaceView:p,playerUiVM:()=>r,onPlayerTurnCompleted:()=>{g==null||g.handlePlayerTurnEnded(),tt()},gameView:()=>T}),T=nn({tileSize:64,playerVM:o(),tileMapVM:w,npcVMs:b,eventVMs:_,settlementVMs:M,attackVM:Q}),y=Fi({gameView:T.view,userInterfaceView:p.view,fogOfWarVM:f}),E=zn({playerVM:o(),tileMapVM:w})},B=()=>{console.debug("Unloading level..."),m==null||m.destroy(),y==null||y.destroy(),l=null,a=null,c=null,h=null,r=null,f=null,n.detachAll(),p==null||p.destroy(),p=null,u=null,g=null,y=null,w=null,b=[],_=[],E==null||E.destroy(),E=null,M=[],I=null,T==null||T.destroy()},Y=()=>{const P=b.filter(tt=>tt.isAlive()),G=b.length-P.length,Q=o().position();Q&&(A>=as(G)||(A++,P.forEach(tt=>{tt.position().distanceTo(Q)<5||tt.setMaxHealth(tt.maxHealth()+2)})))},R=()=>{const P=o().position(),G=10;P&&(w==null||w.tiles().forEach(Q=>{Q.forEach(tt=>{tt.setVisible(Math.abs(tt.position().x-P.x)<=G&&Math.abs(tt.position().y-P.y)<=G)})}),_.forEach(Q=>{Q.setVisible(Math.abs(Q.position().x-P.x)<=G&&Math.abs(Q.position().y-P.y)<=G)}),b.forEach(Q=>{Q.setVisible(Math.abs(Q.position().x-P.x)<=G&&Math.abs(Q.position().y-P.y)<=G)}),M.forEach(Q=>{Q.setIsVisible(Math.abs(Q.positions()[0].x-P.x)<=G&&Math.abs(Q.positions()[0].y-P.y)<=G)}))},S=async()=>{if(!x&&!v){x=!0,a==null||a.handleTradeRequest({action:"autoTrade",trader:{canTrade:()=>!0,inventory:()=>kt({model:Qt([]),ownerName:"Bulk Trader"})}});return}if(x=!1,!v){v=!0,p==null||p.showEndOfLevelLog();return}i(I),await L()},L=async()=>{!y||!p||(X.disableCategory("gameplay"),X.playMusic("mx-level-end.wav",{fadeIn:!0,fadeOut:!0}),p.view.visible=!1,await Z.to(y.view,{duration:5,alpha:0}),y.view.visible=!1,D(),B())},U=()=>{m=Ni({handleLevelCompleted:S,handleTileInteraction:P=>{a==null||a.handleTileInteraction(P)},handleItemInteraction:(P,G)=>{a==null||a.handleItemInteraction(P,G)},handleEventInteraction:P=>{a==null||a.handleEventInteraction(P,o())},handleCharacterInteraction:P=>{a==null||a.handleCharacterInteraction({character:P,action:"interact"})},onCloseInventoryRequested:()=>{a==null||a.handleCloseInventoryRequest(),x&&S()},handleInventoryRequest:(P,G)=>{a==null||a.handleInventoryRequest(P,G)},handleTradeRequest:P=>{a==null||a.handleTradeRequest({action:P})},handleCharacterInteractionRequest:({character:P,action:G})=>{a==null||a.handleCharacterInteraction({action:G,character:P})},handleSettlementInteractionRequest:({settlement:P,action:G})=>{a==null||a.handleSettlementInteraction({settlement:P,action:G})},handleInGameMenuRequest:P=>{a==null||a.handleInGameMenuRequest(P)},onDebugActionRequested:P=>{E==null||E.handleDebugActionRequest(P)},handleSaveRequest:D,handleLoadRequest:q})},D=()=>{console.debug("Saving game state...");const P=k(),G={...P,tileModels:P.tileMapModel.tiles().map(Q=>Q.map(tt=>tt))};t.save(G),r==null||r.setIsSaveCompleted(!0)},q=()=>{console.debug("Loading game state..."),e();const P=t.load();if(!P){console.warn("No saved game state found.");return}B(),H(P)},H=P=>{console.debug("Loading level..."),N(P??$e()),U(),p==null||p.showPlayerMenu(),p==null||p.showPlayerUi(),!(!y||!p)&&(y.view.visible=!1,p.view.visible=!1,c==null||c.playNpcTurn(),n.attachCamera(y),n.attachUi(p),n.resize(innerWidth,innerHeight),o&&(y==null||y.moveTo(o().position().x*64,o().position().y*64)))},K=()=>{!y||!p||(X.enableCategory("gameplay"),X.stopMusic({fadeOut:!0}),R(),y.view.visible=!0,p.view.visible=!0,n.resize(innerWidth,innerHeight),y&&y.moveTo(o().position().x*64,o().position().y*64))},st=P=>{p==null||p.update()};return ut(()=>{ft(()=>{R(),Y(),(o().position().x!==C.x||o().position().y!==C.y)&&(C={x:o().position().x,y:o().position().y},y&&y.moveTo(o().position().x*64,o().position().y*64))})}),{loadLevel:H,showGameView:K,update:st,getState:k}},bs=n=>{const{mainMenuVM:t,view:e,loadingScreenVM:i,saveController:s}=n,o=()=>{i.setVisible(!0),X.playMusic("dark drop off trim.wav",{volume:1}),setTimeout(()=>{i.setVisible(!1),p.showGameView()},2e3)},d=()=>{console.debug("Resetting game progress..."),s.clear(),dt().reset()},l=u=>{console.debug("Preparing next level...");const g=$e();u.playerModel.moveTo(g.playerModel.position().x,g.playerModel.position().y),g.playerModel=u.playerModel;const y=g.playerModel.inventory().items().filter(_=>_.code()==="torch").length,w=Math.max(0,30-y);te("torch",w).forEach(_=>g.playerModel.inventory().addItem(_));const b=Math.abs(Math.max(-5,g.playerModel.health()-g.playerModel.maxHealth()));return g.playerModel.setHealth(g.playerModel.health()+b),g},a=async u=>{i.setText(""),i.setRestScreenVisible(!0),i.setVisible(!0),await Z.delayedCall(8,()=>{p.loadLevel(l(u))}),await Z.delayedCall(2,()=>{i.setVisible(!1),p.showGameView()})},c=(u=!1)=>{const g=s.load();X.playMusic("dark drop off trim.wav",{volume:1}),i.setVisible(!0),t.hide(),p.loadLevel(g),setTimeout(()=>{i.setVisible(!1),p.showGameView()},u?10:2e3)},h=()=>{console.debug("Starting game..."),t.setIsContinueButtonVisible(s.load()!==void 0),t.show()},r=()=>{console.debug("Exiting game...")},f=u=>{p.update(u)},p=ls({view:e,saveController:s,onGameLoadRequest:o,onLevelCompleted:a});return{loadLevel:c,initGame:h,exitGame:r,update:f,resetProgress:d}};export{bs as createGameController};
