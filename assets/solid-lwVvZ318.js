const N=(t,e)=>t===e,A={equals:N};let m=U;const a=1,w=2,x={owned:null,cleanups:null,context:null,owner:null};var i=null;let S=null,T=null,u=null,o=null,f=null,v=0;function j(t,e){const s=u,r=i,n=t.length===0,l=r,c=n?x:{owned:null,cleanups:null,context:l?l.context:null,owner:l},D=n?t:()=>t(()=>y(()=>p(c)));i=c,u=null;try{return h(D,!0)}finally{u=s,i=r}}function G(t,e){e=e?Object.assign({},A,e):A;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},r=n=>(typeof n=="function"&&(n=n(s.value)),O(s,n));return[F.bind(s),r]}function P(t,e,s){m=R;const r=L(t,e,!1,a);r.user=!0,f?f.push(r):E(r)}function y(t){if(u===null)return t();const e=u;u=null;try{return t()}finally{u=e}}function F(){if(this.sources&&this.state)if(this.state===a)E(this);else{const t=o;o=null,h(()=>b(this),!1),o=t}if(u){const t=this.observers?this.observers.length:0;u.sources?(u.sources.push(this),u.sourceSlots.push(t)):(u.sources=[this],u.sourceSlots=[t]),this.observers?(this.observers.push(u),this.observerSlots.push(u.sources.length-1)):(this.observers=[u],this.observerSlots=[u.sources.length-1])}return this.value}function O(t,e,s){let r=t.value;return(!t.comparator||!t.comparator(r,e))&&(t.value=e,t.observers&&t.observers.length&&h(()=>{for(let n=0;n<t.observers.length;n+=1){const l=t.observers[n],c=S&&S.running;c&&S.disposed.has(l),(c?!l.tState:!l.state)&&(l.pure?o.push(l):f.push(l),l.observers&&C(l)),c||(l.state=a)}if(o.length>1e6)throw o=[],new Error},!1)),e}function E(t){if(!t.fn)return;p(t);const e=v;I(t,t.value,e)}function I(t,e,s){let r;const n=i,l=u;u=i=t;try{r=t.fn(e)}catch(c){return t.pure&&(t.state=a,t.owned&&t.owned.forEach(p),t.owned=null),t.updatedAt=s+1,k(c)}finally{u=l,i=n}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?O(t,r):t.value=r,t.updatedAt=s)}function L(t,e,s,r=a,n){const l={fn:t,state:r,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:i,context:i?i.context:null,pure:s};return i===null||i!==x&&(i.owned?i.owned.push(l):i.owned=[l]),l}function g(t){if(t.state===0)return;if(t.state===w)return b(t);if(t.suspense&&y(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<v);)t.state&&e.push(t);for(let s=e.length-1;s>=0;s--)if(t=e[s],t.state===a)E(t);else if(t.state===w){const r=o;o=null,h(()=>b(t,e[0]),!1),o=r}}function h(t,e){if(o)return t();let s=!1;e||(o=[]),f?s=!0:f=[],v++;try{const r=t();return V(s),r}catch(r){s||(f=null),o=null,k(r)}}function V(t){if(o&&(U(o),o=null),t)return;const e=f;f=null,e.length&&h(()=>m(e),!1)}function U(t){for(let e=0;e<t.length;e++)g(t[e])}function R(t){let e,s=0;for(e=0;e<t.length;e++){const r=t[e];r.user?t[s++]=r:g(r)}for(e=0;e<s;e++)g(t[e])}function b(t,e){t.state=0;for(let s=0;s<t.sources.length;s+=1){const r=t.sources[s];if(r.sources){const n=r.state;n===a?r!==e&&(!r.updatedAt||r.updatedAt<v)&&g(r):n===w&&b(r,e)}}}function C(t){for(let e=0;e<t.observers.length;e+=1){const s=t.observers[e];s.state||(s.state=w,s.pure?o.push(s):f.push(s),s.observers&&C(s))}}function p(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),r=t.sourceSlots.pop(),n=s.observers;if(n&&n.length){const l=n.pop(),c=s.observerSlots.pop();r<n.length&&(l.sourceSlots[c]=r,n[r]=l,s.observerSlots[r]=c)}}if(t.tOwned){for(e=t.tOwned.length-1;e>=0;e--)p(t.tOwned[e]);delete t.tOwned}if(t.owned){for(e=t.owned.length-1;e>=0;e--)p(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function _(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function k(t,e=i){throw _(t)}export{P as a,j as b,G as c};
